<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/favicon.ico?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/favicon.ico?v=6.6.0">


  <link rel="mask-icon" href="/images/favicon.ico?v=6.6.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="关键字 super关键字super,在调用[super init]的时候，super会转化成结构体__rw_objc_super 12345struct __rw_objc_super &amp;#123; 	struct objc_object *object; //消息接受者	struct objc_object *superClass; //父类	__rw_objc_super(struct obj">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS底层原理 runtime - super、hook、以及简单应用--(8)">
<meta property="og:url" content="http://fgyong.cn/2019/12/01/iOS底层原理 runtime - super、hook、以及简单应用--(8)/index.html">
<meta property="og:site_name" content="fgyong的技术博客">
<meta property="og:description" content="关键字 super关键字super,在调用[super init]的时候，super会转化成结构体__rw_objc_super 12345struct __rw_objc_super &amp;#123; 	struct objc_object *object; //消息接受者	struct objc_object *superClass; //父类	__rw_objc_super(struct obj">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://fgyong.cn/images/0.png">
<meta property="og:updated_time" content="2020-09-03T08:24:13.610Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS底层原理 runtime - super、hook、以及简单应用--(8)">
<meta name="twitter:description" content="关键字 super关键字super,在调用[super init]的时候，super会转化成结构体__rw_objc_super 12345struct __rw_objc_super &amp;#123; 	struct objc_object *object; //消息接受者	struct objc_object *superClass; //父类	__rw_objc_super(struct obj">
<meta name="twitter:image" content="http://fgyong.cn/images/0.png">



  <link rel="alternate" href="/atom.xml" title="fgyong的技术博客" type="application/atom+xml">




  <link rel="canonical" href="http://fgyong.cn/2019/12/01/iOS底层原理 runtime - super、hook、以及简单应用--(8)/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>iOS底层原理 runtime - super、hook、以及简单应用--(8) | fgyong的技术博客</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fgyong的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">不忘初心 方得始终</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">44</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">8</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">24</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOS底层原理 runtime - super、hook、以及简单应用--(8)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyong的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">iOS底层原理 runtime - super、hook、以及简单应用--(8)
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-12-01 11:18:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:18:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-03 16:24:13" itemprop="dateModified" datetime="2020-09-03T16:24:13+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="关键字-super"><a href="#关键字-super" class="headerlink" title="关键字 super"></a>关键字 super</h3><p>关键字<code>super</code>,在调用<code>[super init]</code>的时候，<code>super</code>会转化成结构体<code>__rw_objc_super</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct __rw_objc_super &#123; </span><br><span class="line">	struct objc_object *object; //消息接受者</span><br><span class="line">	struct objc_object *superClass; //父类</span><br><span class="line">	__rw_objc_super(struct objc_object *o, struct objc_object *s) : object(o), superClass(s) &#123;&#125; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>[super init]</code>使用命令<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime=ios-8.0.0 Student.m</code>转化成<code>cpp</code><br>打开<code>cpp</code>大概在底部的位置找到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Student *(*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super)&#123;(id)self, (id)class_getSuperclass(objc_getClass(&quot;Student&quot;))&#125;, sel_registerName(&quot;init&quot;))</span><br></pre></td></tr></table></figure>
<p>简化之后是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(void *)objc_msgSendSuper((__rw_objc_super)&#123;self, class_getSuperclass(objc_getClass(&quot;Student&quot;))&#125;, sel_registerName(&quot;init&quot;))</span><br></pre></td></tr></table></figure>
<p><code>void
objc_msgSendSuper(void /* struct objc_super *super, SEL op, ... */ )</code><br>    其实是向父类发送消息，参数是<code>struct objc_super *super, SEL op, ...</code>，我们源码中找到了该函数的实现在<code>objc-msg-arm64.s</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ENTRY _objc_msgSendSuper</span><br><span class="line">UNWIND _objc_msgSendSuper, NoFrame</span><br><span class="line">//根据结构体struct __rw_objc_super </span><br><span class="line">&#123; </span><br><span class="line">	//struct objc_object *object; //消息接受者</span><br><span class="line">	//struct objc_object *superClass; //父类</span><br><span class="line">&#125;占用空间16字节，objc_msgSendSuper参数是__rw_objc_super，</span><br><span class="line">//使x0偏移16字节，就是两个指针的空间，赋值给p0 和p16</span><br><span class="line">ldp	p0, p16, [x0]		// p0 = self , p16 = superclass</span><br><span class="line"></span><br><span class="line">CacheLookup NORMAL		// calls imp or objc_msgSend_uncached</span><br><span class="line"></span><br><span class="line">END_ENTRY _objc_msgSendSuper</span><br></pre></td></tr></table></figure>
<p>将<code>self</code>和<code>superclass</code>赋值给 <code>p0, p16</code>调用<code>CacheLookup NORMAL</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">.macro CacheLookup //.macro 是一个宏 使用 _cmd&amp;mask 查找缓存中的方法</span><br><span class="line">	// p1 = SEL, p16 = isa</span><br><span class="line">	ldp	p10, p11, [x16, #CACHE]	// p10 = buckets, p11 = occupied|mask</span><br><span class="line">#if !__LP64__</span><br><span class="line">	and	w11, w11, 0xffff	// p11 = mask</span><br><span class="line">#endif</span><br><span class="line">	and	w12, w1, w11		// x12 = _cmd &amp; mask</span><br><span class="line">	add	p12, p10, p12, LSL #(1+PTRSHIFT)</span><br><span class="line">		             // p12 = buckets + ((_cmd &amp; mask) &lt;&lt; (1+PTRSHIFT))</span><br><span class="line"></span><br><span class="line">	ldp	p17, p9, [x12]		// &#123;imp, sel&#125; = *bucket</span><br><span class="line">1:	cmp	p9, p1			// if (bucket-&gt;sel != _cmd)</span><br><span class="line">	b.ne	2f			//     scan more</span><br><span class="line">	CacheHit $0			// call or return imp 命中 调用或者返回imp</span><br><span class="line">	</span><br><span class="line">2:	// not hit: p12 = not-hit bucket 没有命中</span><br><span class="line">	CheckMiss $0			// miss if bucket-&gt;sel == 0</span><br><span class="line">	cmp	p12, p10		// wrap if bucket == buckets</span><br><span class="line">	b.eq	3f</span><br><span class="line">	ldp	p17, p9, [x12, #-BUCKET_SIZE]!	// &#123;imp, sel&#125; = *--bucket</span><br><span class="line">	b	1b			// loop</span><br><span class="line"></span><br><span class="line">3:	// wrap: p12 = first bucket, w11 = mask</span><br><span class="line">	add	p12, p12, w11, UXTW #(1+PTRSHIFT)</span><br><span class="line">		                        // p12 = buckets + (mask &lt;&lt; 1+PTRSHIFT)</span><br><span class="line"></span><br><span class="line">	// Clone scanning loop to miss instead of hang when cache is corrupt.</span><br><span class="line">	// The slow path may detect any corruption and halt later.</span><br><span class="line"></span><br><span class="line">	ldp	p17, p9, [x12]		// &#123;imp, sel&#125; = *bucket</span><br><span class="line">1:	cmp	p9, p1			// if (bucket-&gt;sel != _cmd)</span><br><span class="line">	b.ne	2f			//     scan more</span><br><span class="line">	CacheHit $0			// call or return imp</span><br><span class="line">	</span><br><span class="line">2:	// not hit: p12 = not-hit bucket</span><br><span class="line">	CheckMiss $0			// miss if bucket-&gt;sel == 0</span><br><span class="line">	cmp	p12, p10		// wrap if bucket == buckets</span><br><span class="line">	b.eq	3f</span><br><span class="line">	ldp	p17, p9, [x12, #-BUCKET_SIZE]!	// &#123;imp, sel&#125; = *--bucket</span><br><span class="line">	b	1b			// loop</span><br><span class="line"></span><br><span class="line">3:	// double wrap</span><br><span class="line">	JumpMiss $0</span><br><span class="line">	</span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure>
<p>汇编比较多，只看到第二行<code>p1 = SEL, p16 = isa</code>，查找缓存是从<code>p16</code>,也就是<code>superclass</code>开始查找，后边的都和<code>objc_msgSend</code>一样。<br>大致上比较清楚了，<code>super</code>本质上调用了<code>objc_msgSendSuper</code>，<code>objc_msgSendSuper</code>是查找从父类开始查找方法。</p>
<p><code>[super init]</code>就是<code>self</code>直接调用父类<code>init</code>的方法，但是<code>objc_msgSend</code>接受者是<code>self</code>，假如是<code>[self init]</code>则会产生死循环。<code>[super test]</code>则是执行父类的<code>test</code>。<br>使用<code>Debug Workflow-&gt;Always Show Disassemdly</code>发现<code>super</code>其实调用了汇编的<code>objc_msgSendSuper2</code>，进入<code>objc_msgSendSuper2 objc-msg-arm64.s 422 行</code>发现和<code>objc_msgSendSuper</code>其实基本一致的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//_objc_msgSendSuper 开始</span><br><span class="line">	ENTRY _objc_msgSendSuper</span><br><span class="line">	UNWIND _objc_msgSendSuper, NoFrame</span><br><span class="line">//x0偏移16字节，就是两个指针的空间，赋值给p0 和p16</span><br><span class="line">	ldp	p0, p16, [x0]		// p0 = self , p16 = superclass</span><br><span class="line">	CacheLookup NORMAL		// calls imp or objc_msgSend_uncached</span><br><span class="line">	END_ENTRY _objc_msgSendSuper  //_objc_msgSendSuper 结束</span><br><span class="line">	</span><br><span class="line">//objc_msgLookupSuper2 开始</span><br><span class="line">	ENTRY _objc_msgSendSuper2 </span><br><span class="line">	UNWIND _objc_msgSendSuper2, NoFrame</span><br><span class="line"></span><br><span class="line">	ldp	p0, p16, [x0]		// p0 = real receiver, p16 = class</span><br><span class="line">	//将存储器地址为x16+8的字数据读入寄存器p16。</span><br><span class="line">	ldr	p16, [x16, #SUPERCLASS]	// p16 = class-&gt;superclass</span><br><span class="line">	CacheLookup NORMAL</span><br><span class="line">	END_ENTRY _objc_msgSendSuper2</span><br></pre></td></tr></table></figure>
<p>也可以使用<code>LLVM</code>转化成中间代码来查看，<code>clang -emit-llvm -S FYCat.m</code>查看关键函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define internal void @&quot;\01-[FYCat forwardInvocation:]&quot;(%1*, i8*, %2*) #1 &#123;</span><br><span class="line">    call void bitcast (i8* (%struct._objc_super*, i8*, ...)* @objc_msgSendSuper2 to void (%struct._objc_super*, i8*, %2*)*)(%struct._objc_super* %7, i8* %18, %2* %12)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是<code>forwardInvocation</code>函数的调用代码，简化之后是<code>objc_msgSendSuper2(self,struct._objc_super i8*,%2*)</code>，就是<code>objc_msgSendSuper2(self,superclass,@selector(forwardInvocation),anInvocation)</code>。</p>
<p>验证</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">- (int)age;</span><br><span class="line">-(void)test;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYPerson</span><br><span class="line">- (void)test&#123;</span><br><span class="line">    ;    NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">- (int)age&#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">    return 10;</span><br><span class="line">&#125;</span><br><span class="line">- (NSString *)name&#123;</span><br><span class="line">    return [_name stringByAppendingString:@&quot; eat apple&quot;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@interface FYStudent : FYPerson</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line">@implementation FYStudent</span><br><span class="line">- (void)test&#123;</span><br><span class="line">    [super test]; //执行父类的test</span><br><span class="line">    int age = [super age]; //获取父类的方法 返回值</span><br><span class="line">    NSLog(@&quot;age is %d&quot;,age);</span><br><span class="line">    NSString * name = [self name]; //从父类开始寻找name的值，但返回的是self.name的值</span><br><span class="line">    NSLog(@&quot;%@&quot;,name);</span><br><span class="line">&#125;</span><br><span class="line">-(int)age&#123;</span><br><span class="line">    return 12;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">//输出</span><br><span class="line">-[FYPerson test]</span><br><span class="line">-[FYPerson age]</span><br><span class="line">age is 10</span><br><span class="line">小李子 eat apple</span><br></pre></td></tr></table></figure>
<p><code>test</code>是执行父类的方法，<code>[super age]</code>获取父类中固定的<code>age</code>,<br><code>[self name]</code>从父类开始寻找<code>name</code>的值，但返回的是<code>self.name</code>的值。</p>
<h3 id="isMemberOfClass-amp-isKindOfClass"><a href="#isMemberOfClass-amp-isKindOfClass" class="headerlink" title="isMemberOfClass &amp;  isKindOfClass"></a>isMemberOfClass &amp;  isKindOfClass</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">+ (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    return object_getClass((id)self) == cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    return [self class] == cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls = object_getClass((id)self); tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        printf(&quot;%s %s\n&quot;,class_getName(tcls),class_getName(cls));</span><br><span class="line">        if (tcls == cls)</span><br><span class="line">        &#123;return YES;&#125;else&#123;</span><br><span class="line">            printf(&quot;%s&quot;,class_getName(tcls));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls = [self class]; tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        </span><br><span class="line">        printf(&quot; %s %s\n&quot;,class_getName(tcls),class_getName(cls));</span><br><span class="line">        if (tcls == cls) return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (BOOL)isSubclassOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls = self; tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        if (tcls == cls) return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>- (BOOL)isMemberOfClass</code>和<code>- (BOOL)isKindOfClass:(Class)cls</code>比较简单，都是判断<code>self.class</code> 和<code>cls</code>，<code>+ (BOOL)isMemberOfClass:(Class)cls</code>是判断<code>self.class-&gt;isa</code>是否和<code>cls</code>相等，<code>+ (BOOL)isKindOfClass:(Class)cls</code>判断<code>cls-&gt;isa</code>和<code>cls-&gt;isa-&gt;isa</code>有没有可能和<code>cls</code>相等？只有基类是，其他的都不是。</p>
<h4 id="验证-实例方法"><a href="#验证-实例方法" class="headerlink" title="验证 实例方法"></a>验证 实例方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Class cls = NSObject.class;</span><br><span class="line">Class pcls = FYPerson.class;</span><br><span class="line">FYPerson *p=[FYPerson new];</span><br><span class="line">NSObject *obj=[NSObject new];</span><br><span class="line">BOOL res11 =[p isKindOfClass:pcls];</span><br><span class="line">BOOL res12 =[p isMemberOfClass:pcls];</span><br><span class="line">BOOL res13 =[obj isKindOfClass:cls];</span><br><span class="line">BOOL res14 =[obj isMemberOfClass:cls];</span><br><span class="line">NSLog(@&quot;instance:%d %d %d %d&quot;,res11,res12,res13,res14);</span><br><span class="line">//log</span><br><span class="line">//instance:1 1 1 1</span><br></pre></td></tr></table></figure>
<p><code>p</code>是<code>pcls</code>的子类，<code>obj</code> 是<code>cls</code>的子类，在明显不过了。</p>
<h4 id="验证-类方法"><a href="#验证-类方法" class="headerlink" title="验证 类方法"></a>验证 类方法</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//isKindOfClass cls-&gt;isa 和cls/cls-&gt;superclass相等吗?</span><br><span class="line">//元类对象和类对象不相等，但是最后一个元类的isa-&gt;superclass是指向NSObject的class 所以res1 = YES;</span><br><span class="line">//cls-&gt;isa:元类对象 cls-&gt;isa-&gt;superclass: NSObject类对象</span><br><span class="line">//cls:类对象</span><br><span class="line">BOOL res1 =[cls isKindOfClass:cls];</span><br><span class="line">//cls-&gt;isa 和cls相等吗？ 不相等 cls-&gt;isa是元类对象,cls是类对象，不可能相等。</span><br><span class="line">BOOL res2 =[cls isMemberOfClass:cls];</span><br><span class="line">//pcls-&gt;isa:person的元类对象 cls-&gt;isa-&gt;superclass: NSObject元类类对象 -&gt;superclass:NSObject类对象 -&gt;superclass:nil</span><br><span class="line">//pcls:person类对象</span><br><span class="line">BOOL res3 =[pcls isKindOfClass:pcls];</span><br><span class="line">//pcls-&gt;isa:person的元类对象</span><br><span class="line">//pcls:person类对象</span><br><span class="line">BOOL res4 =[pcls isMemberOfClass:pcls];</span><br><span class="line">NSLog(@&quot;%d %d %d %d&quot;,res1,res2,res3,res4);</span><br><span class="line">结果：</span><br><span class="line">1 0 0 0</span><br></pre></td></tr></table></figure>
<h3 id="堆栈-对象本质-class本质实战"><a href="#堆栈-对象本质-class本质实战" class="headerlink" title="堆栈 对象本质 class本质实战"></a>堆栈 对象本质 class本质实战</h3><p>网上看到了一个比较有意思的面试题，今天我们就借此机会分析一下,虽然网上很多博文已经讲了，但是好像都不很对，或者没有讲到根本的东西，所以今天再来探讨一下究竟。<br>其实这道题考察了对象在内存中的布局，类和对象的关系，和堆上的内存布局。基础知识不很牢固的同学可以看一下我历史的博文<a href="https://juejin.im/post/5d2d200be51d4510a7328161" target="_blank" rel="noopener">obj_msgsend基础</a>、<a href="https://juejin.im/post/5d19c59e6fb9a07f04205f95" target="_blank" rel="noopener">类的本质</a>、<a href="https://juejin.im/post/5d15887ee51d45108126d28d" target="_blank" rel="noopener">对象的本质</a>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">- (void)print;</span><br><span class="line">@end</span><br><span class="line">@implementation FYPerson</span><br><span class="line">- (void)print&#123;</span><br><span class="line">    NSLog(@&quot;my name is %@&quot;,self.name);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    NSObject *fix =[NSObject new]; // 16字节 0x60000219b030</span><br><span class="line">    id cls  = [FYPerson class];针</span><br><span class="line">    void * obj = &amp;cls; </span><br><span class="line">    [(__bridge id)obj print];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="问题一-能否编译成功？"><a href="#问题一-能否编译成功？" class="headerlink" title="问题一 能否编译成功？"></a>问题一 能否编译成功？</h4><p>当大家看到第二个问题的时候，不傻的话都会回答能编译成功，否则还问结果干嘛。我们从之前学的只是来分析一下，调用方法成功需要有<code>id self</code>和<code>SEL sel</code>，现在<code>cls</code>和<code>obj</code>都在栈区，<code>obj</code> 指针指向<code>cls</code>的内存地址，访问<code>obj</code>相当于直接访问<code>cls</code>内存存储的值，<code>cls</code>存储的是<code>Person.class</code>,<code>[obj print]</code> 相当于<code>objc_msgSend(cls,@selector(print))</code>,<code>cls</code>是有<code>print</code>方法的，所以会编译成功。</p>
<h4 id="输出什么？"><a href="#输出什么？" class="headerlink" title="输出什么？"></a>输出什么？</h4><p><code>fix/cls/obj</code>这三个对象都是存储在栈上，<code>fix/cls/obj</code>地址是连续从高到低的，而且他们地址相差都是<code>8</code>字节，一个指针大小是<code>8</code>字节。他们三个地址如下所示：</p>
<p>使用图来表示<code>fix</code>和<code>obj</code>：</p>
<table>
<thead>
<tr>
<th style="text-align:center">对象</th>
<th style="text-align:center">地址</th>
<th style="text-align:center">地址高低</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">fix</td>
<td style="text-align:center">0x7ffeec3df920</td>
<td style="text-align:center">高</td>
</tr>
<tr>
<td style="text-align:center">cls</td>
<td style="text-align:center">0x7ffeec3df918</td>
<td style="text-align:center">中</td>
</tr>
<tr>
<td style="text-align:center">obj</td>
<td style="text-align:center">0x7ffeec3df910</td>
<td style="text-align:center">低</td>
</tr>
</tbody>
</table>
<p>寻找属性先是寻找<code>isa</code>，然后再在<code>isa</code>地址上+<code>8</code>则是属性的值，所以根据<code>obj</code>寻找<code>cls</code>地址是<code>0x7ffeec3df918</code>,然后<code>cls</code>地址+8字节则是<code>_name</code>的地址，<code>cls</code>地址是<code>0x7ffeec3df918</code>，加上<code>8</code>字节正好是<code>fix</code>的地址<code>0x7ffeec3df920</code>，因为都是指针，所以都是<code>8</code>字节,所以最后输出是结果是<code>fix</code>对象的地址的数据。</p>
<p>情况再复杂一点，<code>FYPerson</code>结构改动一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@property (nonatomic,copy) NSString *name2;</span><br><span class="line">@property (nonatomic,copy) NSString *name3;</span><br><span class="line">- (void)print;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<p>则他们的<code>_name</code>、<code>_name2</code>、<code>_name3</code>则在<code>cls</code>的地址基础上再向上寻找<code>8*1=8/8*2=16/8*3=24</code>字节，就是向上寻找第1个，第2个，第3个指向对象的指针。</p>
<p>测试代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@property (nonatomic,copy) NSString *name2;</span><br><span class="line">@property (nonatomic,copy) NSString *name3;</span><br><span class="line">- (void)print;</span><br><span class="line">@end</span><br><span class="line">@implementation FYPerson</span><br><span class="line">- (void)print&#123;</span><br><span class="line">    NSLog(@&quot;name1:%@ name2:%@ name3:%@&quot;,self.name1,self.name2,self.name3);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//主函数</span><br><span class="line"></span><br><span class="line">NSObject *fix =[NSObject new];</span><br><span class="line">FYPerson *fix2 =[FYPerson new];</span><br><span class="line"></span><br><span class="line">id cls  = [FYPerson class];</span><br><span class="line">void * obj = &amp;cls; </span><br><span class="line">[(__bridge id)obj print];//objc_msgSend(self,sel);</span><br><span class="line">NSLog(@&quot;fix:%p fix2:%p cls:%p obj:%p&quot;,&amp;fix,&amp;fix2,&amp;cls,&amp;obj);</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line">name1:&lt;FYPerson: 0x6000033a38a0&gt; </span><br><span class="line">name2:&lt;NSObject: 0x6000031f5380&gt; </span><br><span class="line">name3:&lt;ViewController: 0x7f8307505580&gt;</span><br><span class="line"></span><br><span class="line">fix: 0x7ffeec3d f9 28 </span><br><span class="line">fix2:0x7ffeec3d f9 20 </span><br><span class="line">cls: 0x7ffeec3d f9 18 </span><br><span class="line">obj: 0x7ffeec3d f9 10</span><br></pre></td></tr></table></figure>
<p>再变形：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">	/*</span><br><span class="line">	 objc_msgSuperSend(self,ViewController,sel)</span><br><span class="line">	 */</span><br><span class="line">NSLog(@&quot;self:%p ViewController.class:%p SEL:%p&quot;,self,ViewController.class,@selector(viewDidLoad));</span><br><span class="line">    id cls  = [FYPerson class];//cls 是类指针</span><br><span class="line">    void * obj = &amp;cls; //obj </span><br><span class="line">    [(__bridge id)obj print];//objc_msgSend(self,sel);</span><br><span class="line">    </span><br><span class="line"> NSLog(@&quot;cls:%p obj:%p&quot;,&amp;cls,&amp;obj);</span><br><span class="line"> //log</span><br><span class="line"> </span><br><span class="line"> name1:&lt;ViewController: 0x7fad03e04ea0&gt; </span><br><span class="line"> name2:ViewController</span><br><span class="line"> </span><br><span class="line"> self:                  0x7fad03e04ea0 </span><br><span class="line"> ViewController.class:  0x10d0edf00 </span><br><span class="line"> SEL:                   0x1117d5687</span><br><span class="line"> </span><br><span class="line"> cls:0x7ffee2b11908 </span><br><span class="line"> obj:0x7ffee2b11900</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_name1</code>是<code>cls</code>地址向上+8字节，<code>_name2</code>是向上移动16字节，<code>[super viewDidLoad]</code>本质上是<code>objc_msgSuperSend(self,ViewController.class,sel)</code>，<code>self</code>、<code>ViewController.class</code>、<code>SEL</code>是同一块连续内存，布局由低到高，看了下图的内存布局就会顿悟，<br>结构体如下图所示：</p>
<table>
<thead>
<tr>
<th style="text-align:center">对象</th>
<th style="text-align:center">地址高低</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">self</td>
<td style="text-align:center">低</td>
</tr>
<tr>
<td style="text-align:center">ViewController.class</td>
<td style="text-align:center">中</td>
</tr>
<tr>
<td style="text-align:center">SEL</td>
<td style="text-align:center">高</td>
</tr>
</tbody>
</table>
<h3 id="常用的runtimeAPI"><a href="#常用的runtimeAPI" class="headerlink" title="常用的runtimeAPI"></a>常用的runtimeAPI</h3><table>
<thead>
<tr>
<th style="text-align:center">method</th>
<th style="text-align:center">desc</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Class objc_allocateClassPair(Class superclass, const char *name, size_t extraBytes)</td>
<td style="text-align:center">动态创建一个类（参数：父类，类名，额外的内存空间</td>
</tr>
<tr>
<td style="text-align:center">void objc_registerClassPair(Class cls))</td>
<td style="text-align:center">注册一个类</td>
</tr>
<tr>
<td style="text-align:center">void objc_disposeClassPair(Class cls)</td>
<td style="text-align:center">销毁一个类</td>
</tr>
<tr>
<td style="text-align:center">Class objcect_getClass(id obj)</td>
<td style="text-align:center">获取isa指向的class</td>
</tr>
<tr>
<td style="text-align:center">Class object_setClass (id obj,Class cls)</td>
<td style="text-align:center">设置isa指向的class</td>
</tr>
<tr>
<td style="text-align:center">BOOL object_isClass(id class)</td>
<td style="text-align:center">判断oc对象是否为Class</td>
</tr>
<tr>
<td style="text-align:center">BOOL class_isMetaClass(Class cls)</td>
<td style="text-align:center">是否是元类</td>
</tr>
<tr>
<td style="text-align:center">Class class_getSuperclass(Class cls)</td>
<td style="text-align:center">获取父类</td>
</tr>
<tr>
<td style="text-align:center">Ivar class_getInstanceVariable(Class cls ,const char * name</td>
<td style="text-align:center">获取一个实例变量信息</td>
</tr>
<tr>
<td style="text-align:center">Ivar <em> class_copyIvarList(Class cls,unsigned int </em> outCount)</td>
<td style="text-align:center">拷贝实例变量列表，需要free</td>
</tr>
<tr>
<td style="text-align:center">void object_setIvar(id obj,Ivar ivar,id value</td>
<td style="text-align:center">设置获取实例变量的值</td>
</tr>
<tr>
<td style="text-align:center">id object_getIvar(id obj,Ivar ivar)</td>
<td style="text-align:center">获取实例变量的值</td>
</tr>
<tr>
<td style="text-align:center">BOOL class_addIvar(Class cls,const cahr <em> name ,size_t size,uint_t alignment,const char </em> types)</td>
<td style="text-align:center">动态添加成员变量（已注册的类不能动态添加成员变量）</td>
</tr>
<tr>
<td style="text-align:center">const char * ivar_getName（Ivar v)</td>
<td style="text-align:center">获取变量名字</td>
</tr>
<tr>
<td style="text-align:center">const char * ivar_getTypeEncoding(Ivar v)</td>
<td style="text-align:center">变量的encode</td>
</tr>
<tr>
<td style="text-align:center">objc_property_t class_getProperty(Class cls,const char* name)</td>
<td style="text-align:center">获取一个属性</td>
</tr>
<tr>
<td style="text-align:center">objc_property_t _Nonnull <em> _Nullable class_copyPropertyList(Class _Nullable cls, unsigned int </em> _Nullable outCount)</td>
<td style="text-align:center">拷贝属性列表</td>
</tr>
<tr>
<td style="text-align:center">objc_property_t _Nullable class_getProperty(Class _Nullable cls, const char * _Nonnull name)</td>
<td style="text-align:center">获取属性列表</td>
</tr>
<tr>
<td style="text-align:center">BOOL class_addProperty(Class _Nullable cls, const char <em> _Nonnull name,const objc_property_attribute_t </em> _Nullable attributes,unsigned int attributeCount)</td>
<td style="text-align:center">添加属性</td>
</tr>
<tr>
<td style="text-align:center">void class_replaceProperty(Class _Nullable cls, const char <em> _Nonnull name,const objc_property_attribute_t </em> _Nullable attributes, unsigned int attributeCount)</td>
<td style="text-align:center">替换属性</td>
</tr>
<tr>
<td style="text-align:center">void class_replaceProperty(Class cls, const char <em>name, const objc_property_attribute_t </em>attributes,unsigned int attributeCount)</td>
<td style="text-align:center">动态替换属性</td>
</tr>
<tr>
<td style="text-align:center">const char * _Nonnull property_getName(objc_property_t _Nonnull property)</td>
<td style="text-align:center">获取name</td>
</tr>
<tr>
<td style="text-align:center">const char * _Nullable property_getAttributes(objc_property_t _Nonnull property)</td>
<td style="text-align:center">获取属性的属性</td>
</tr>
<tr>
<td style="text-align:center">IMP imp_implementationWithBlock(id block)</td>
<td style="text-align:center">获取block的IMP</td>
</tr>
<tr>
<td style="text-align:center">id imp_getBlock(IMP anIMP)</td>
<td style="text-align:center">通过imp 获取block</td>
</tr>
<tr>
<td style="text-align:center">BOOL imp_removeBlock(IMP anIMP)</td>
<td style="text-align:center">IMP是否被删除</td>
</tr>
<tr>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
</tr>
</tbody>
</table>
<p>在业务上有些时候需要给系统控件的某个属性赋值，但是系统没有提供方法，只能靠自己了，那么我们<br>获取<code>class</code>的所有成员变量,可以获取<code>Ivar</code>查看是否有该变量，然后可以通过<code>KVC</code>来赋值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@interface FYCat : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString * name;</span><br><span class="line">@property (nonatomic,assign) int  age;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">FYCat *cat=[FYCat new];</span><br><span class="line">unsigned int count = 0;</span><br><span class="line">Ivar *vars= class_copyIvarList(cat.class, &amp;count);</span><br><span class="line">for (int i = 0; i &lt; count; i ++) &#123;</span><br><span class="line">	Ivar item = vars[i];</span><br><span class="line">	const char *name = ivar_getName(item);</span><br><span class="line">	NSLog(@&quot;%s&quot;,name);</span><br><span class="line">&#125;</span><br><span class="line">free(vars);</span><br><span class="line"></span><br><span class="line">Method *m1= class_copyMethodList(cat.class, &amp;count);</span><br><span class="line">for (int i = 0; i &lt; count; i ++) &#123;</span><br><span class="line">	Method item = m1[i];</span><br><span class="line">	SEL name = method_getName(item);</span><br><span class="line">	printf(&quot;method:%s \n&quot;,NSStringFromSelector(name).UTF8String);</span><br><span class="line">&#125;</span><br><span class="line">free(m1);</span><br><span class="line">		</span><br><span class="line">//log</span><br><span class="line">_age</span><br><span class="line">_name</span><br><span class="line"></span><br><span class="line">method:.cxx_destruct </span><br><span class="line">method:name </span><br><span class="line">method:setName: </span><br><span class="line">method:methodSignatureForSelector: </span><br><span class="line">method:forwardInvocation: </span><br><span class="line">method:age </span><br><span class="line">method:setAge:</span><br></pre></td></tr></table></figure>
<p>大家常用的一个功能是<code>JsonToModel</code>，那么我们已经了解到了<code>runtime</code>的基础知识，现在可以自己撸一个<code>JsonToModel</code>了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@interface NSObject (Json)</span><br><span class="line">+ (instancetype)fy_objectWithJson:(NSDictionary *)json;</span><br><span class="line">@end</span><br><span class="line">@implementation NSObject (Json)</span><br><span class="line">+ (instancetype)fy_objectWithJson:(NSDictionary *)json&#123;</span><br><span class="line">	id obj = [[self alloc]init];</span><br><span class="line">	unsigned int count = 0;</span><br><span class="line">	Ivar *vars= class_copyIvarList(self, &amp;count);</span><br><span class="line">	for (int i = 0; i &lt; count; i ++) &#123;</span><br><span class="line">		Ivar item = vars[i];</span><br><span class="line">		const char *name = ivar_getName(item);</span><br><span class="line">		NSString * nameOC= [NSString stringWithUTF8String:name];</span><br><span class="line">		if (nameOC.length&gt;1) &#123;</span><br><span class="line">			nameOC = [nameOC substringFromIndex:1];</span><br><span class="line">			NSString * value = json[nameOC];</span><br><span class="line">			if ([value isKindOfClass:NSString.class] &amp;&amp; value.length) &#123;</span><br><span class="line">				[obj setValue:value forKey:nameOC];</span><br><span class="line">			&#125;else if ([value isKindOfClass:NSArray.class])&#123;</span><br><span class="line">				[obj setValue:value forKey:nameOC];</span><br><span class="line">			&#125;else if ([value isKindOfClass:NSDictionary.class])&#123;</span><br><span class="line">				[obj setValue:value forKey:nameOC];</span><br><span class="line">			&#125;else if ([value isKindOfClass:[NSNull class]] || [value isEqual:nil])</span><br><span class="line">			&#123;</span><br><span class="line">				printf(&quot;%s value is nil or null \n&quot;,name);</span><br><span class="line">			&#125;else if ([value integerValue] &gt; 0)&#123;</span><br><span class="line">				[obj setValue:value forKey:nameOC];</span><br><span class="line">			&#125;else&#123;</span><br><span class="line">				printf(&quot;未知错误 \n&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	free(vars);</span><br><span class="line">	return obj;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>然后自己定义一个字典，来测试一下这段代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@interface FYCat : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString * name;</span><br><span class="line">@property (nonatomic,assign) int  age;</span><br><span class="line"></span><br><span class="line">- (void)run;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">NSDictionary * info = @&#123;@&quot;age&quot;:@&quot;10&quot;,@&quot;value&quot;:@10,@&quot;name&quot;:@&quot;小明&quot;&#125;;</span><br><span class="line">		FYCat *cat=[FYCat fy_objectWithJson:info];</span><br><span class="line">//log</span><br><span class="line">age:10 name:小明</span><br></pre></td></tr></table></figure>
<h4 id="hook钩子-method-exchangeImplementations"><a href="#hook钩子-method-exchangeImplementations" class="headerlink" title="hook钩子(method_exchangeImplementations)"></a>hook钩子(method_exchangeImplementations)</h4><p>由于业务需求需要在某些按钮点击事件进行记录日志，那么我们可以利用钩子来实现拦截所有button的点击事件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@implementation UIButton (add)</span><br><span class="line">+ (void)load&#123;</span><br><span class="line">	Method m1= class_getInstanceMethod(self.class, @selector(sendAction:to:forEvent:));</span><br><span class="line">	Method m2= class_getInstanceMethod(self.class, @selector(fy_sendAction:to:forEvent:));</span><br><span class="line">	static dispatch_once_t onceToken;</span><br><span class="line">	dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">		method_exchangeImplementations(m1, m2);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)fy_sendAction:(SEL)action to:(id)target forEvent:(UIEvent *)event&#123;</span><br><span class="line">	NSLog(@&quot;%@ &quot;,NSStringFromSelector(action));</span><br><span class="line">	/*</span><br><span class="line">	 code here</span><br><span class="line">	 */</span><br><span class="line">	 //sel IMP 已经交换过了，所以不会死循环</span><br><span class="line">	[self fy_sendAction:action to:target forEvent:event];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>可以在<code>code here</code>添加需要处理的代码，一般记录日志和延迟触发都可以处理。<code>[self fy_sendAction:action to:target forEvent:event];</code>不会产生死循环，原因是在<code>+load</code>中已经将<code>m1</code>和<code>m2</code>已经交换过了<code>IMP</code>。我们进入到<code>method_exchangeImplementations</code>内部：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">void method_exchangeImplementations(Method m1, Method m2)</span><br><span class="line">&#123;</span><br><span class="line">    if (!m1  ||  !m2) return;</span><br><span class="line"></span><br><span class="line">    mutex_locker_t lock(runtimeLock);</span><br><span class="line"></span><br><span class="line">//交换IMP</span><br><span class="line">    IMP m1_imp = m1-&gt;imp;</span><br><span class="line">    m1-&gt;imp = m2-&gt;imp;</span><br><span class="line">    m2-&gt;imp = m1_imp;</span><br><span class="line"></span><br><span class="line">//刷新缓存</span><br><span class="line">    flushCaches(nil);</span><br><span class="line"></span><br><span class="line">    updateCustomRR_AWZ(nil, m1);</span><br><span class="line">    updateCustomRR_AWZ(nil, m2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct method_t &#123;</span><br><span class="line">    SEL name;</span><br><span class="line">    const char *types;</span><br><span class="line">    MethodListIMP imp;</span><br><span class="line">&#125;;</span><br><span class="line">using MethodListIMP = IMP;</span><br></pre></td></tr></table></figure>
<p><code>m1</code>和<code>m2</code>交换了<code>IMP</code>，交换的是<code>method_t-&gt;imp</code>，然后刷新缓存(清空缓存)，等下次调用<code>IMP</code>则需要在<code>cls-&gt;rw-&gt;data-&gt;method</code>中去寻找。</p>
<h4 id="数组越界和nil处理"><a href="#数组越界和nil处理" class="headerlink" title="数组越界和nil处理"></a>数组越界和nil处理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@implementation NSMutableArray (add)</span><br><span class="line">+ (void)load&#123;</span><br><span class="line">	Class cls= NSClassFromString(@&quot;__NSArrayM&quot;);</span><br><span class="line">	Method m1= class_getInstanceMethod(cls, @selector(insertObject:atIndex:));</span><br><span class="line">	SEL sel = @selector(fy_insertObject:atIndex:);</span><br><span class="line">	Method m2= class_getInstanceMethod(cls, sel);</span><br><span class="line">	</span><br><span class="line">	Method m3= class_getInstanceMethod(cls, @selector(objectAtIndexedSubscript:));</span><br><span class="line">	Method m4= class_getInstanceMethod(cls, @selector(fy_objectAtIndexedSubscript:));</span><br><span class="line"></span><br><span class="line">	static dispatch_once_t onceToken;</span><br><span class="line">	dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">		method_exchangeImplementations(m1, m2);</span><br><span class="line">		method_exchangeImplementations(m3, m4);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)fy_insertObject:(id)anObject atIndex:(NSUInteger)index&#123;</span><br><span class="line">	if (anObject != nil) &#123;</span><br><span class="line">		[self fy_insertObject:anObject atIndex:index];</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		printf(&quot; anObject is nil \n&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (id)fy_objectAtIndexedSubscript:(NSUInteger)idx&#123;</span><br><span class="line">	if (self.count &gt; idx) &#123;</span><br><span class="line">		return [self fy_objectAtIndexedSubscript:idx];</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		printf(&quot; %ld is outof rang \n&quot;,(long)idx);</span><br><span class="line">		return nil;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NSMutableArray *array=[NSMutableArray array];</span><br><span class="line">id obj = nil;</span><br><span class="line">[array addObject:obj];</span><br><span class="line">array[1];</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line"> anObject is nil </span><br><span class="line"> 1 is outof rang</span><br></pre></td></tr></table></figure>
<p><code>NSMutableArray</code>是类簇，使用工厂模式，<code>NSMutableArray</code>不是数组实例，而是生产数组对象的工厂。<br>真实的数组对象是<code>__NSArrayM</code>,然后给<code>__NSArrayM</code>钩子，交换<code>objectAtIndexedSubscript:(NSUInteger)idx</code>和<code>insertObject:(id)anObject atIndex:(NSUInteger)index</code>方法，实现崩溃避免。</p>
<h4 id="字典nil处理"><a href="#字典nil处理" class="headerlink" title="字典nil处理"></a>字典nil处理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@interface NSMutableDictionary (add)</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation NSMutableDictionary (add)</span><br><span class="line">+ (void)load&#123;</span><br><span class="line">    Class cls= NSClassFromString(@&quot;__NSDictionaryM&quot;);</span><br><span class="line">    Method m1= class_getInstanceMethod(cls, @selector(setObject:forKey:));</span><br><span class="line">//    __NSDictionaryM</span><br><span class="line">    SEL sel = @selector(fy_setObject:forKey:);</span><br><span class="line">    Method m2= class_getInstanceMethod(cls, sel);</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        method_exchangeImplementations(m1, m2);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)fy_setObject:(id)anObject forKey:(id&lt;NSCopying&gt;)aKey&#123;</span><br><span class="line">    if (anObject) &#123;</span><br><span class="line">        [self fy_setObject:anObject forKey:aKey];</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        NSString * key = (NSString *)aKey;</span><br><span class="line">        printf(&quot;key:%s anobj is nil \n&quot;,key.UTF8String);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>利用类别<code>+load</code>给<code>__NSDictionaryM</code>添加方法，然后交换<code>IMP</code>，实现给<code>NSMutableDictionary setObject:Key:</code>的时候进行<code>nil</code>校验,<code>+load</code>虽然系统启动的自动调用一次的，但是为防止开发者再次调用造成<code>IMP</code>和<code>SEL</code>混乱，使用<code>dispatch_once</code>进行单次运行。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ol>
<li><code>super</code>本质上是<code>self</code>调用函数，不过查找函数是从<code>sueprclass</code>开始查找的</li>
<li><code>+isKandOfClass</code>是判断<code>self</code>是否是<code>cls</code>的子类，<code>+isMemberOfClass:</code>是判断<code>self</code>是否和<code>cls</code>相同。</li>
<li>了解<code>+load</code>在<code>Category</code>是启动的时候使用运行时编译的，而且只会加载一次,然后利用<code>objc/runtime.h</code>中<code>method_exchangeImplementations</code>实现交换两个函数的<code>IMP</code>，可以实现拦截<code>nil</code>，降低崩溃率。</li>
<li><code>NSMutableDictionary</code>、<code>NSMutableArray</code>是类簇，先找到他们的类然后再交换该类的函数的<code>IMP</code>。</li>
</ol>
<h3 id="资料参考"><a href="#资料参考" class="headerlink" title="资料参考"></a>资料参考</h3><ul>
<li><a href="http://www.520it.com/zt/ios_mj/" target="_blank" rel="noopener">小码哥视频</a></li>
</ul>
<h4 id="资料下载"><a href="#资料下载" class="headerlink" title="资料下载"></a>资料下载</h4><ul>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="noopener">学习资料下载</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="noopener">demo code</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC/objc4-750" target="_blank" rel="noopener">runtime可运行的源码</a></li>
</ul>
<hr>
<p>最怕一生碌碌无为，还安慰自己平凡可贵。</p>
<p>广告时间</p>
<p><img src="/images/0.png" alt></p>

      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/01/iOS底层原理 runtime- objc_msgSend拾遗基础篇--(7)/" rel="next" title="iOS底层原理 runtime- objc_msgSend拾遗基础篇--(7)">
                <i class="fa fa-chevron-left"></i> iOS底层原理 runtime- objc_msgSend拾遗基础篇--(7)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/01/iOS底层原理 RunLoop基础总结和随心所欲掌握子线程RunLoop生命周期 --(9)/" rel="prev" title="iOS底层原理  RunLoop基础总结和随心所欲掌握子线程RunLoop生命周期 --(9)">
                iOS底层原理  RunLoop基础总结和随心所欲掌握子线程RunLoop生命周期 --(9) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div id="gitalk-container">
    </div>
    
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">fgyong</p>
              <p class="site-description motion-element" itemprop="description">在学习的路上，不忘初心 方得始终</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">44</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/ifgyong" title="GitHub &rarr; https://github.com/ifgyong" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://juejin.im/user/1750078239290909" title="掘金 &rarr; https://juejin.im/user/1750078239290909" rel="noopener" target="_blank"><i class="fa fa-fw fa-掘金"></i>掘金</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#关键字-super"><span class="nav-number">1.</span> <span class="nav-text">关键字 super</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#isMemberOfClass-amp-isKindOfClass"><span class="nav-number">2.</span> <span class="nav-text">isMemberOfClass &amp;  isKindOfClass</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#验证-实例方法"><span class="nav-number">2.1.</span> <span class="nav-text">验证 实例方法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#验证-类方法"><span class="nav-number">2.2.</span> <span class="nav-text">验证 类方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#堆栈-对象本质-class本质实战"><span class="nav-number">3.</span> <span class="nav-text">堆栈 对象本质 class本质实战</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#问题一-能否编译成功？"><span class="nav-number">3.1.</span> <span class="nav-text">问题一 能否编译成功？</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#输出什么？"><span class="nav-number">3.2.</span> <span class="nav-text">输出什么？</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常用的runtimeAPI"><span class="nav-number">4.</span> <span class="nav-text">常用的runtimeAPI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#hook钩子-method-exchangeImplementations"><span class="nav-number">4.1.</span> <span class="nav-text">hook钩子(method_exchangeImplementations)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数组越界和nil处理"><span class="nav-number">4.2.</span> <span class="nav-text">数组越界和nil处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#字典nil处理"><span class="nav-number">4.3.</span> <span class="nav-text">字典nil处理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">5.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#资料参考"><span class="nav-number">6.</span> <span class="nav-text">资料参考</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#资料下载"><span class="nav-number">6.1.</span> <span class="nav-text">资料下载</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2015 – <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fgyong</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v6.6.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.6.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  











  
  
  <script type="text/javascript" src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script>

  
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.css">

  
  
  <script type="text/javascript" src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>
    
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'a7800c37057fc3ce83df',
          clientSecret: '0de240e28197f071e10fcb67d4337fd8afe8a9c3',
          repo: 'ifgyong.github.io',
          owner: 'ifgyong',
          admin: ['ifgyong'],
          id: md5(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>

  





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
