<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222"/>
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"/>

<link rel="stylesheet" href="/css/main.css?v=7.1.0"/>


  <link rel="apple-touch-icon" sizes="180x180" href="/0.jpeg?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/0.jpeg?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/0.jpeg?v=7.1.0">


  <link rel="mask-icon" href="/0.jpeg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="runtime 基础知识runtime是运行时，在运行的时候做一些事请，可以动态添加类和交换函数，那么有一个基础知识需要了解，arm64架构前，isa指针是普通指针，存储class和meta-class对象的内存地址，从arm64架构开始，对isa进行了优化，变成了一个union共用体，还是用位域来存储更多的信息，我们首先看一下isa指针的结构： 1234567891011121314151617">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS底层原理 runtime-object_class拾遗基础篇--(6)">
<meta property="og:url" content="http://fgyong.cn/2019/12/01/iOS底层原理 runtime-object_class拾遗基础篇--(6)/index.html">
<meta property="og:site_name" content="fgyong的技术博客">
<meta property="og:description" content="runtime 基础知识runtime是运行时，在运行的时候做一些事请，可以动态添加类和交换函数，那么有一个基础知识需要了解，arm64架构前，isa指针是普通指针，存储class和meta-class对象的内存地址，从arm64架构开始，对isa进行了优化，变成了一个union共用体，还是用位域来存储更多的信息，我们首先看一下isa指针的结构： 1234567891011121314151617">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://fgyong.cn/2019/12/01/images/0.png">
<meta property="og:updated_time" content="2019-12-03T05:02:33.456Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS底层原理 runtime-object_class拾遗基础篇--(6)">
<meta name="twitter:description" content="runtime 基础知识runtime是运行时，在运行的时候做一些事请，可以动态添加类和交换函数，那么有一个基础知识需要了解，arm64架构前，isa指针是普通指针，存储class和meta-class对象的内存地址，从arm64架构开始，对isa进行了优化，变成了一个union共用体，还是用位域来存储更多的信息，我们首先看一下isa指针的结构： 1234567891011121314151617">
<meta name="twitter:image" content="http://fgyong.cn/2019/12/01/images/0.png">



  <link rel="alternate" href="/atom.xml" title="fgyong的技术博客" type="application/atom+xml"/>



  
  
  <link rel="canonical" href="http://fgyong.cn/2019/12/01/iOS底层原理 runtime-object_class拾遗基础篇--(6)/"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>iOS底层原理 runtime-object_class拾遗基础篇--(6) | fgyong的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fgyong的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">不忘初心 方得始终</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    

    
      
    

    <a href="/" rel="section">首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    

    
      
    

    <a href="/archives/" rel="section">归档<span class="badge">42</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    

    
      
    

    <a href="/tags/" rel="section">标签<span class="badge">22</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    

    
      
    

    <a href="/categories/" rel="section">分类<span class="badge">7</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    

    
      
    

    <a href="/about/" rel="section">关于</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/ifgyong" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOS底层原理 runtime-object_class拾遗基础篇--(6)/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyong的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">iOS底层原理 runtime-object_class拾遗基础篇--(6)

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-12-01 11:16:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:16:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-12-03 13:02:33" itemprop="dateModified" datetime="2019-12-03T13:02:33+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="runtime-基础知识"><a href="#runtime-基础知识" class="headerlink" title="runtime 基础知识"></a>runtime 基础知识</h3><p><code>runtime</code>是运行时，在运行的时候做一些事请，可以动态添加类和交换函数，那么有一个基础知识需要了解，arm64架构前，isa指针是普通指针，存储class和meta-class对象的内存地址，从arm64架构开始，对isa进行了优化，变成了一个<code>union</code>共用体，还是用位域来存储更多的信息，我们首先看一下isa指针的结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">struct objc_object &#123;</div><div class="line">private:</div><div class="line">    isa_t isa;</div><div class="line">public:</div><div class="line">    // ISA() assumes this is NOT a tagged pointer object</div><div class="line">    Class ISA();</div><div class="line">    // getIsa() allows this to be a tagged pointer object</div><div class="line">    Class getIsa();</div><div class="line">    //****</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">#include &quot;isa.h&quot;</div><div class="line">union isa_t &#123;</div><div class="line">    isa_t() &#123; &#125;</div><div class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</div><div class="line"></div><div class="line">    Class cls;</div><div class="line">    uintptr_t bits;</div><div class="line">#if defined(ISA_BITFIELD)</div><div class="line">    struct &#123;</div><div class="line">        ISA_BITFIELD;  // defined in isa.h</div><div class="line">    &#125;;</div><div class="line">#endif</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>objc_object</code>是结构体，包含了私有属性<code>isa_t</code>,<code>isa_t isa</code>是一个共用体，包含了<code>ISA_BITFIELD</code>是一个宏(结构体)，<code>bits</code>是<code>uintptr_t</code>类型，<code>uintptr_t</code>其实是<code>unsign long</code>类型占用8字节，就是64位，我们进入到<code>ISA_BITFIELD</code>内部：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"># if __arm64__</div><div class="line">#   define ISA_MASK        0x0000000ffffffff8ULL</div><div class="line">#   define ISA_MAGIC_MASK  0x000003f000000001ULL</div><div class="line">#   define ISA_MAGIC_VALUE 0x000001a000000001ULL</div><div class="line">#   define ISA_BITFIELD                                         </div><div class="line">      uintptr_t nonpointer        : 1;                              </div><div class="line">      uintptr_t has_assoc         : 1;                                  </div><div class="line">      uintptr_t has_cxx_dtor      : 1;                                  </div><div class="line">      uintptr_t shiftcls          : 33; /*MACH_VM_MAX_ADDRESS 0x1000000000*/ \</div><div class="line">      uintptr_t magic             : 6;                                  </div><div class="line">      uintptr_t weakly_referenced : 1;                                  </div><div class="line">      uintptr_t deallocating      : 1;                                  </div><div class="line">      uintptr_t has_sidetable_rc  : 1;                                  </div><div class="line">      uintptr_t extra_rc          : 19</div><div class="line">#   define RC_ONE   (1ULL&lt;&lt;45)</div><div class="line">#   define RC_HALF  (1ULL&lt;&lt;18)</div><div class="line"></div><div class="line"># elif __x86_64__</div><div class="line">#   define ISA_MASK        0x00007ffffffffff8ULL</div><div class="line">#   define ISA_MAGIC_MASK  0x001f800000000001ULL</div><div class="line">#   define ISA_MAGIC_VALUE 0x001d800000000001ULL</div><div class="line">#   define ISA_BITFIELD                                                 </div><div class="line">      uintptr_t nonpointer        : 1;                                  </div><div class="line">      uintptr_t has_assoc         : 1;                                  </div><div class="line">      uintptr_t has_cxx_dtor      : 1;                                  </div><div class="line">      uintptr_t shiftcls          : 44; /*MACH_VM_MAX_ADDRESS 0x7fffffe00000*/ \</div><div class="line">      uintptr_t magic             : 6;                                  </div><div class="line">      uintptr_t weakly_referenced : 1;                                  </div><div class="line">      uintptr_t deallocating      : 1;                                  </div><div class="line">      uintptr_t has_sidetable_rc  : 1;                                  </div><div class="line">      uintptr_t extra_rc          : 8</div><div class="line">#   define RC_ONE   (1ULL&lt;&lt;56)</div><div class="line">#   define RC_HALF  (1ULL&lt;&lt;7)</div><div class="line"># else</div><div class="line">#   error unknown architecture for packed isa</div><div class="line"># endif</div></pre></td></tr></table></figure>
<p><code>ISA_BITFIELD</code>在<code>arm64</code>和<code>x86</code>是两种结构，存储了<code>nonpointer</code>,<code>has_assoc</code>,<code>has_cxx_dtor</code>,<code>shiftcls</code>,<code>magic</code>,<code>weakly_referenced</code>,<code>deallocating</code>,<code>has_sidetable_rc</code>,<code>extra_rc</code>这些信息，<code>:1</code>就占用了一位，<code>:44</code>就是占用了44位，<code>:6</code>就是占用了6位，<code>:8</code>就是占用了8位，那么共用体<code>isa_t</code>简化之后</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">union isa_t &#123;</div><div class="line">    isa_t() &#123; &#125;</div><div class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</div><div class="line"></div><div class="line">    Class cls;</div><div class="line">    uintptr_t bits;</div><div class="line">    struct &#123;</div><div class="line">      uintptr_t nonpointer        : 1;                                </div><div class="line">      uintptr_t has_assoc         : 1;                                  </div><div class="line">      uintptr_t has_cxx_dtor      : 1;                                  </div><div class="line">      uintptr_t shiftcls          : 44; /*MACH_VM_MAX_ADDRESS 0x7fffffe00000*/ \</div><div class="line">      uintptr_t magic             : 6;                                  </div><div class="line">      uintptr_t weakly_referenced : 1;                                  </div><div class="line">      uintptr_t deallocating      : 1;                                  </div><div class="line">      uintptr_t has_sidetable_rc  : 1;                                  </div><div class="line">      uintptr_t extra_rc          : 8</div><div class="line">    &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>isa_t</code>是使用共用体结构，使用<code>bits</code>存储了结构体的数据，那么共用体是如何使用的？我们来探究一下</p>
<h4 id="共用体基础知识"><a href="#共用体基础知识" class="headerlink" title="共用体基础知识"></a>共用体基础知识</h4><p>首先我们定义一个<code>FYPerson</code>，添加2个属性</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@interface FYPerson : NSObject</div><div class="line">@property (nonatomic,assign) BOOL rich;</div><div class="line">@property (nonatomic,assign) BOOL tell;</div><div class="line">@property (nonatomic,assign) BOOL handsome;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>然后查看该类的实例占用空间大小</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">FYPerson *p=[[FYPerson alloc]init];</div><div class="line">		p.handsome = YES;</div><div class="line">		p.rich = NO;</div><div class="line">		NSLog(@&quot;大小：%zu&quot;,class_getInstanceSize(FYPerson.class));</div><div class="line">		//16</div></pre></td></tr></table></figure>
<p><code>FYPerson</code>定义了三个属性，占用空间是16字节，那么我们换一种方法实现这个三个属性的功能。<br>我们定义6个方法，3个set方法，3个get方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">- (void)setTall:(BOOL)tall;</div><div class="line">- (void)setRich:(BOOL)rich;</div><div class="line">- (void)setHandsome:(BOOL)handsome;</div><div class="line"></div><div class="line">- (BOOL)isTall;</div><div class="line">- (BOOL)isRich;</div><div class="line">- (BOOL)isHandsome;</div><div class="line"></div><div class="line">//实现：</div><div class="line">//使用0b00000000不是很易读，我们换成下边的写法1&lt;&lt;0</div><div class="line">//#define FYHandsomeMask 0b00000001</div><div class="line">//#define FYTallMask 0b00000010</div><div class="line">//#define FYRichMask 0b00000001</div><div class="line"></div><div class="line"></div><div class="line">#define FYHandsomeMask (1&lt;&lt;0)</div><div class="line">#define FYTallMask (1&lt;&lt;1)</div><div class="line">#define FYRichMask (1&lt;&lt;2)</div><div class="line"></div><div class="line">@interface FYPerson()</div><div class="line">&#123;</div><div class="line">	char _richTellHandsome;//0000 0000 rich tall handsome</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line">@implementation FYPerson</div><div class="line"></div><div class="line">- (void)setRich:(BOOL)tall&#123;</div><div class="line">	if (tall) &#123;</div><div class="line">		_richTellHandsome = _richTellHandsome|FYRichMask;</div><div class="line">	&#125;else&#123;</div><div class="line">		_richTellHandsome = _richTellHandsome&amp;~FYRichMask;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div><div class="line">- (void)setTall:(BOOL)tall&#123;</div><div class="line">	if (tall) &#123;</div><div class="line">		_richTellHandsome = _richTellHandsome|FYTallMask;</div><div class="line">	&#125;else&#123;</div><div class="line">		_richTellHandsome = _richTellHandsome&amp;~FYTallMask;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">&#125;</div><div class="line">- (void)setHandsome:(BOOL)tall&#123;</div><div class="line">	if (tall) &#123;</div><div class="line">		_richTellHandsome = _richTellHandsome|FYHandsomeMask;</div><div class="line">	&#125;else&#123;</div><div class="line">		_richTellHandsome = _richTellHandsome&amp;~FYHandsomeMask;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">- (BOOL)isRich&#123;</div><div class="line">	return !!(_richTellHandsome&amp;FYRichMask);</div><div class="line">&#125;</div><div class="line">- (BOOL)isTall&#123;</div><div class="line">	return !!(_richTellHandsome&amp;FYTallMask);</div><div class="line">&#125;</div><div class="line">- (BOOL)isHandsome&#123;</div><div class="line">	return !!(_richTellHandsome&amp;FYHandsomeMask);</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>我们定义了一个char类型的变量<code>_richTellHandsome</code>,4字节，32位，可以存储32个bool类型的变量。赋值是使用<code>_richTellHandsome = _richTellHandsome|FYRichMask</code>,或<code>_richTellHandsome = _richTellHandsome&amp;~FYRichMask</code>,取值是<code>!!(_richTellHandsome&amp;FYRichMask)</code>，前边加<code>!!</code>是转化成<code>bool</code>类型的，否则取值出来是<code>1 or  2 or 4</code>。我们再换一种思路将三个变量定义成一个结构体，取值和赋值都是可以直接操作的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">@interface FYPerson()</div><div class="line">&#123;</div><div class="line">//	char _richTellHandsome;//0000 0000 rich tall handsome</div><div class="line">	//位域</div><div class="line">	struct&#123;</div><div class="line">		char tall : 1;//高度</div><div class="line">		char rich : 1;//富有</div><div class="line">		char handsome : 1; //帅</div><div class="line">	&#125; _richTellHandsome; // 0b0000 0000</div><div class="line">	//使用2位 yes就是0b01 转化成1字节8位就是:0o0101 0101 结果是1</div><div class="line">	//使用1位 yes就是0b1 转化成1字节8位就是:0o1111 1111 所以结果是-1</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line">@implementation FYPerson</div><div class="line"></div><div class="line">- (void)setRich:(BOOL)tall&#123;</div><div class="line">	_richTellHandsome.rich = tall;</div><div class="line">&#125;</div><div class="line">- (void)setTall:(BOOL)tall&#123;</div><div class="line">	_richTellHandsome.tall = tall;</div><div class="line">&#125;</div><div class="line">- (void)setHandsome:(BOOL)tall&#123;</div><div class="line">	_richTellHandsome.handsome = tall;</div><div class="line">&#125;</div><div class="line">- (BOOL)isRich&#123;</div><div class="line">	return !!_richTellHandsome.rich;</div><div class="line">&#125;</div><div class="line">- (BOOL)isTall&#123;</div><div class="line">	return !!_richTellHandsome.tall;</div><div class="line">&#125;</div><div class="line">- (BOOL)isHandsome&#123;</div><div class="line">	return !!_richTellHandsome.handsome;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>结构体<code>_richTellHandsome</code>包含三个变量<code>char tall : 1;</code>,<code>char rich : 1;</code>,<code>char handsome : 1</code>。每一个变量占用空间为1位，3个变量占用3位。取值的时候使用<code>!!(_richTellHandsome&amp;FYHandsomeMask)</code>，赋值使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">if (tall) &#123;</div><div class="line">		_richTellHandsome = _richTellHandsome|FYHandsomeMask;</div><div class="line">	&#125;else&#123;</div><div class="line">		_richTellHandsome = _richTellHandsome&amp;~FYHandsomeMask</div><div class="line">	&#125;</div></pre></td></tr></table></figure>
<p>我们采用位域来存储信息，<br>位域是指信息在存储时，并不需要占用一个完整的字节， 而只需占几个或一个二进制位。例如在存放一个开关量时，只有0和1 两种状态， 用一位二进位即可。为了节省存储空间，并使处理简便，C语言又提供了一种数据结构，称为“位域”或“位段”。所谓“位域”是把一个字节中的二进位划分为几 个不同的区域， 并说明每个区域的位数。每个域有一个域名，允许在程序中按域名进行操作。 这样就可以把几个不同的对象用一个字节的二进制位域来表示。</p>
<p>另外一个省空间的思路是使用<code>联合</code>,<br>使用<code>union</code>，可以更省空间，“联合”是一种特殊的类，也是一种构造类型的数据结构。在一个“联合”内可以定义多种不同的数据类型， 一个被说明为该“联合”类型的变量中，允许装入该“联合”所定义的任何一种数据，这些数据共享同一段内存，以达到节省空间的目的（还有一个节省空间的类型：位域）。 这是一个非常特殊的地方，也是联合的特征。另外，同struct一样，联合默认访问权限也是公有的，并且，也具有成员函数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">@interface FYPerson()</div><div class="line">&#123;</div><div class="line">	union &#123;</div><div class="line">		char bits; //一个字节8位 ricH /tall/handsome都是占用的bits的内存空间</div><div class="line">		struct&#123;</div><div class="line">			char tall : 1;//高度</div><div class="line">			char rich : 1;//富有</div><div class="line">			char handsome : 1; //帅</div><div class="line">		&#125;; // 0b0000 0000</div><div class="line">	&#125;_richTellHandsome;</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line">@implementation FYPerson</div><div class="line"></div><div class="line">- (void)setRich:(BOOL)tall&#123;</div><div class="line">	if (tall) &#123;</div><div class="line">		_richTellHandsome.bits |= FYRichMask;</div><div class="line">	&#125;else&#123;</div><div class="line">		_richTellHandsome.bits &amp;= ~FYRichMask;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">- (void)setTall:(BOOL)tall&#123;</div><div class="line">	if (tall) &#123;</div><div class="line">		_richTellHandsome.bits |= FYTallMask;</div><div class="line">	&#125;else&#123;</div><div class="line">		_richTellHandsome.bits &amp;= ~FYTallMask;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">- (void)setHandsome:(BOOL)tall&#123;</div><div class="line">	if (tall) &#123;</div><div class="line">		_richTellHandsome.bits |= FYHandsomeMask;</div><div class="line">	&#125;else&#123;</div><div class="line">		_richTellHandsome.bits &amp;= ~FYHandsomeMask;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">- (BOOL)isRich&#123;</div><div class="line">	return !!(_richTellHandsome.bits &amp; FYRichMask);</div><div class="line">&#125;</div><div class="line">- (BOOL)isTall&#123;</div><div class="line">	return !!(_richTellHandsome.bits &amp; FYTallMask);</div><div class="line">&#125;</div><div class="line">- (BOOL)isHandsome&#123;</div><div class="line">	return (_richTellHandsome.bits &amp; FYHandsomeMask);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用<code>联合</code>共用体，达到省空间的目的，<code>runtime</code>源码中是用来很多<code>union</code>和位运算。<br>例如KVO 的NSKeyValueObservingOptions<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">typedef NS_OPTIONS(NSUInteger, NSKeyValueObservingOptions)&#123;</div><div class="line">        NSKeyValueObservingOptionNew = 0x01,</div><div class="line">    NSKeyValueObservingOptionOld = 0x02,</div><div class="line">    NSKeyValueObservingOptionInitial = 0x04,</div><div class="line">    NSKeyValueObservingOptionPrior = 0x08</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个<code>NSKeyValueObservingOptions</code>使用位域，当传进去的时候<code>NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld</code>,则传进去的值为<code>0x3</code>,转化成二进制就是<code>0b11</code>，则两位都是<code>1</code>可以包含2个值。<br>那么我们来设计一个简单的可以使用或来传值的枚举</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">typedef enum &#123;</div><div class="line">	FYOne = 1,//  0b 0001</div><div class="line">	FYTwo = 2,//  0b 0010</div><div class="line">	FYTHree = 4,//0b 0100</div><div class="line">	FYFour = 8,// 0b 1000</div><div class="line">&#125;FYOptions;</div><div class="line"></div><div class="line">- (void)setOptions:(FYOptions )ops&#123;</div><div class="line">	if (ops &amp;FYOne) &#123;</div><div class="line">		NSLog(@&quot;FYOne is show&quot;);</div><div class="line">	&#125;</div><div class="line">	if (ops &amp;FYTwo) &#123;</div><div class="line">		NSLog(@&quot;FYTwo is show&quot;);</div><div class="line">	&#125;</div><div class="line">	if (ops &amp;FYTHree) &#123;</div><div class="line">		NSLog(@&quot;FYTHree is show&quot;);</div><div class="line">	&#125;</div><div class="line">	if (ops &amp;FYFour) &#123;</div><div class="line">		NSLog(@&quot;FYFour is show&quot;);</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">[self setOptions:FYOne|FYTwo|FYTHree];</div><div class="line"></div><div class="line">//输出是：</div><div class="line">FYOne is show</div><div class="line">FYTwo is show</div><div class="line">FYTHree is show</div></pre></td></tr></table></figure>
<p>这是一个名字为<code>FYOptions</code>的枚举，第一个是十进制是1，二进制是<code>0b 0001</code>,第二个十进制是2，二进制是<code>0b 0010</code>,第三个十进制是4，二进制是<code>0b 0100</code>,第四个十进制是8，二进制是<code>0b 1000</code>。<br>那么我们使用的时候可以<code>FYOne|FYTwo|FYTHree</code>，打包成一个值，相当于<code>1|2|4 = 7</code>,二进制表示是<code>0b0111</code>，后三位都是1，可以通过&amp;mask取出对应的每一位的数值。</p>
<h4 id="Class的结构"><a href="#Class的结构" class="headerlink" title="Class的结构"></a>Class的结构</h4><p>isa详解 – 位域存储的数据及其含义</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>nonpointer</td>
<td>0-&gt;代表普通的指针，存储着Class、Meta-Class对象的内存地址。1-&gt;代表优化过，使用位域存储更多的信息</td>
</tr>
<tr>
<td>has_assoc</td>
<td>是否有设置过关联对象，如果没有，释放时会更快</td>
</tr>
<tr>
<td>has_cxx_dtor</td>
<td>是否有C++的析构函数（.cxx_destruct），如果没有，释放时会更快</td>
</tr>
<tr>
<td>shiftcls</td>
<td>存储着Class、Meta-Class对象的内存地址信息</td>
</tr>
<tr>
<td>magic</td>
<td>用于在调试时分辨对象是否未完成初始化</td>
</tr>
<tr>
<td>weakly_referenced</td>
<td>是否有被弱引用指向过，如果没有，释放时会更快</td>
</tr>
<tr>
<td>deallocating</td>
<td>对象是否正在释放</td>
</tr>
<tr>
<td>extra_rc</td>
<td>里面存储的值是引用计数器减1</td>
</tr>
<tr>
<td>has_sidetable_rc</td>
<td>引用计数器是否过大无法存储在isa中</td>
</tr>
</tbody>
</table>
<p>如果为1，那么引用计数会存储在一个叫SideTable的类的属性中|</p>
<p>class结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">struct fy_objc_class : xx_objc_object &#123;</div><div class="line">	Class superclass;</div><div class="line">	cache_t cache;</div><div class="line">	class_data_bits_t bits;</div><div class="line">public:</div><div class="line">	class_rw_t* data() &#123;</div><div class="line">		return bits.data();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	fy_objc_class* metaClass() &#123; // 提供metaClass函数，获取元类对象</div><div class="line">		// 上一篇我们讲解过，isa指针需要经过一次 &amp; ISA_MASK操作之后才得到真正的地址</div><div class="line">		return (fy_objc_class *)((long long)isa &amp; ISA_MASK);</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line">struct class_rw_t &#123;</div><div class="line">	uint32_t flags;</div><div class="line">	uint32_t version;</div><div class="line">	const class_ro_t *ro;//只读 数据</div><div class="line">	method_list_t * methods;    // 方法列表</div><div class="line">	property_list_t *properties;    // 属性列表</div><div class="line">	const protocol_list_t * protocols;  // 协议列表</div><div class="line">	Class firstSubclass;</div><div class="line">	Class nextSiblingClass;</div><div class="line">	char *demangledName;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line">struct class_ro_t &#123;</div><div class="line">	uint32_t flags;</div><div class="line">	uint32_t instanceStart;</div><div class="line">	uint32_t instanceSize;  // instance对象占用的内存空间</div><div class="line">#ifdef __LP64__</div><div class="line">	uint32_t reserved;</div><div class="line">#endif</div><div class="line">	const uint8_t * ivarLayout;</div><div class="line">	const char * name;  // 类名</div><div class="line">	method_list_t * baseMethodList;</div><div class="line">	protocol_list_t * baseProtocols;</div><div class="line">	const ivar_list_t * ivars;  // 成员变量列表</div><div class="line">	const uint8_t * weakIvarLayout;</div><div class="line">	property_list_t *baseProperties;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>class_ro_t</code>是只读的，<code>class_rw_t</code>是读写的，在源码中<code>runtime</code>-&gt;<code>Source</code>-&gt;<code>objc-runtime-new.mm</code>-&gt;<code>static Class realizeClass(Class cls) 1869行</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    const class_ro_t *ro;</div><div class="line">    class_rw_t *rw;</div><div class="line">    Class supercls;</div><div class="line">    Class metacls;</div><div class="line">    bool isMeta;</div><div class="line"></div><div class="line">    if (!cls) return nil;</div><div class="line">    //如果已注册 就返回</div><div class="line">    if (cls-&gt;isRealized()) return cls;</div><div class="line">    assert(cls == remapClass(cls));</div><div class="line"></div><div class="line">    // fixme verify class is not in an un-dlopened part of the shared cache?</div><div class="line">//只读ro</div><div class="line">    ro = (const class_ro_t *)cls-&gt;data();</div><div class="line">    if (ro-&gt;flags &amp; RO_FUTURE) &#123;</div><div class="line">        // This was a future class. rw data is already allocated.</div><div class="line">        rw = cls-&gt;data();//初始化ro</div><div class="line">        ro = cls-&gt;data()-&gt;ro;</div><div class="line">        cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);</div><div class="line">    &#125; else &#123;</div><div class="line">        // Normal class. Allocate writeable class data.</div><div class="line">        //初始化 rw </div><div class="line">        rw = (class_rw_t *)calloc(sizeof(class_rw_t), 1);</div><div class="line">        rw-&gt;ro = ro;</div><div class="line">        rw-&gt;flags = RW_REALIZED|RW_REALIZING;</div><div class="line">        //指针指向rw 一开始是指向ro的</div><div class="line">        cls-&gt;setData(rw);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    isMeta = ro-&gt;flags &amp; RO_META;</div><div class="line"></div><div class="line">    rw-&gt;version = isMeta ? 7 : 0;  // old runtime went up to 6</div><div class="line">`</div></pre></td></tr></table></figure>
<p>开始<code>cls-&gt;data</code>指向的是<code>ro</code>，初始化之后，指向的<code>rw</code>,<code>rw-&gt;ro</code>指向的是原来的<code>ro</code>。<br><code>class_rw_t</code>中的<code>method_array_t</code>是存储的方法列表，我们进入到<code>method_array_t</code>看下它的数据结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">class method_array_t : </div><div class="line">    public list_array_tt&lt;method_t, method_list_t&gt; </div><div class="line">&#123;</div><div class="line">    typedef list_array_tt&lt;method_t, method_list_t&gt; Super;</div><div class="line"></div><div class="line"> public:</div><div class="line">    method_list_t **beginCategoryMethodLists() &#123;</div><div class="line">        return beginLists();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    method_list_t **endCategoryMethodLists(Class cls);</div><div class="line"></div><div class="line">    method_array_t duplicate() &#123;</div><div class="line">        return Super::duplicate&lt;method_array_t&gt;();</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>method_array_t</code>是一个类，存储了<code>method_t</code>二维数组，那么我们看下<code>method_t</code>的结构</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">struct method_t &#123;</div><div class="line">    SEL name;</div><div class="line">    const char *types;</div><div class="line">    MethodListIMP imp;</div><div class="line"></div><div class="line">    struct SortBySELAddress :</div><div class="line">        public std::binary_function&lt;const method_t&amp;,const method_t&amp;, bool&gt;</div><div class="line">    &#123;</div><div class="line">        bool operator() (const method_t&amp; lhs,</div><div class="line">                         const method_t&amp; rhs)</div><div class="line">        &#123; return lhs.name &lt; rhs.name; &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>method_t</code>是存储了3个变量的结构体，<code>SEL</code>是方法名，<code>types</code>是编码(方法返回类型，参数类型)， <code>imp</code>函数指针(函数地址)。</p>
<h5 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h5><ul>
<li>SEL代表方法\函数名，一般叫做选择器，底层结构跟char *类似</li>
<li>可以通过@selector()和sel_registerName()获得</li>
<li>可以通过sel_getName()和NSStringFromSelector()转成字符串</li>
<li>不同类中相同名字的方法，所对应的方法选择器是相同的</li>
</ul>
<h5 id="Type-Encoding"><a href="#Type-Encoding" class="headerlink" title="Type Encoding"></a>Type Encoding</h5><p>iOS中提供了一个叫做@encode的指令，可以将具体的类型转成字符编码，<a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html" target="_blank" rel="external">官方网站插件encodeing</a></p>
<table>
<thead>
<tr>
<th>code</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>c</td>
<td>A char</td>
</tr>
<tr>
<td>i</td>
<td>An int</td>
</tr>
<tr>
<td>s</td>
<td>A short</td>
</tr>
<tr>
<td>l</td>
<td>A long</td>
</tr>
<tr>
<td>l</td>
<td>is treated as a 32-bit quantity on 64-bit programs.</td>
</tr>
<tr>
<td>q</td>
<td>A long long</td>
</tr>
<tr>
<td>C</td>
<td>An unsigned char</td>
</tr>
<tr>
<td>I</td>
<td>An unsigned int</td>
</tr>
<tr>
<td>S</td>
<td>An unsigned short</td>
</tr>
<tr>
<td>L</td>
<td>An unsigned long</td>
</tr>
<tr>
<td>Q</td>
<td>An unsigned long long</td>
</tr>
<tr>
<td>f</td>
<td>A float</td>
</tr>
<tr>
<td>d</td>
<td>A double</td>
</tr>
<tr>
<td>B</td>
<td>A C++ bool or a C99 _Bool</td>
</tr>
<tr>
<td>v</td>
<td>A void</td>
</tr>
<tr>
<td>*</td>
<td>A character string (char *)</td>
</tr>
<tr>
<td>@</td>
<td>An object (whether statically typed or typed id)</td>
</tr>
<tr>
<td>#</td>
<td>A class object (Class)</td>
</tr>
<tr>
<td>:</td>
<td>A method selector (SEL)</td>
</tr>
<tr>
<td>[array type]</td>
<td>An array</td>
</tr>
<tr>
<td>{name=type…}</td>
<td>A structure</td>
</tr>
<tr>
<td>(name=type…)</td>
<td>A union</td>
</tr>
<tr>
<td>bnum</td>
<td>A bit field of num bits</td>
</tr>
<tr>
<td>^type</td>
<td>A pointer to type</td>
</tr>
<tr>
<td>?</td>
<td>An unknown type (among other things, this code is used for function pointers)</td>
</tr>
</tbody>
</table>
<p>我们通过一个例子来了解encode</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">-(void)test:(int)age heiht:(float)height&#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">FYPerson *p=[[FYPerson alloc]init];</div><div class="line">	SEL sel = @selector(test:heiht:);</div><div class="line">	Method m1= class_getInstanceMethod(p.class, sel);</div><div class="line">	const char *type = method_getTypeEncoding(m1);</div><div class="line">	NSLog(@&quot;%s&quot;,type);</div><div class="line">	</div><div class="line">	//输出</div><div class="line">	v24@0:8i16f20</div><div class="line">	//0id 8 SEL 16 int 20 float = 24</div></pre></td></tr></table></figure>
<p><code>v24@0:8i16f20</code>是encoding的值，我们来分解一下，前边是<code>v24</code>是函数返回值是<code>void</code>，所有参数占用了<code>24</code>字节,<code>@0:8</code>是从第0开始，长度是8字节的位置，<code>i16</code>是从16字节开始的<code>int</code>类型，<code>f20</code>是从20字节开始，类型是<code>float</code>。</p>
<h4 id="方法缓存"><a href="#方法缓存" class="headerlink" title="方法缓存"></a>方法缓存</h4><p>Class内部结构中有个方法缓存（cache_t），用散列表（哈希表）来缓存曾经调用过的方法，可以提高方法的查找速度。<br>我们来到<code>cache_t</code>内部</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">struct cache_t &#123;</div><div class="line">    struct bucket_t *_buckets;//散列表</div><div class="line">    mask_t _mask;//散列表长度-1</div><div class="line">    mask_t _occupied;//已经存储的方法数量</div><div class="line">&#125;</div><div class="line"></div><div class="line">struct bucket_t &#123;</div><div class="line">#if __arm64__</div><div class="line">    MethodCacheIMP _imp;</div><div class="line">    cache_key_t _key;</div><div class="line">#else</div><div class="line">    cache_key_t _key;//SEL作为key </div><div class="line">    MethodCacheIMP _imp; //函数地址</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>散列表的数据结构表格所示</p>
<table>
<thead>
<tr>
<th>索引</th>
<th>bucket_t</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>bucket_t(_key,_imp)</td>
</tr>
<tr>
<td>1</td>
<td>bucket_t(_key,_imp)</td>
</tr>
<tr>
<td>2</td>
<td>bucket_t(_key,_imp)</td>
</tr>
<tr>
<td>3</td>
<td>bucket_t(_key,_imp)</td>
</tr>
<tr>
<td>4</td>
<td>bucket_t(_key,_imp)</td>
</tr>
<tr>
<td>…</td>
<td>…</td>
</tr>
</tbody>
</table>
<p>通过<code>cache_getImp(cls, sel)</code>获取<code>IMP</code>。具体在<code>cache_t::find</code>函数中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">bucket_t * cache_t::find(cache_key_t k, id receiver)</div><div class="line">&#123;</div><div class="line">    assert(k != 0);</div><div class="line"></div><div class="line">    bucket_t *b = buckets();</div><div class="line">    mask_t m = mask();</div><div class="line">	//key&amp;mask 得到索引</div><div class="line">    mask_t begin = cache_hash(k, m);</div><div class="line">    mask_t i = begin;</div><div class="line">    do &#123;</div><div class="line">        if (b[i].key() == 0  ||  b[i].key() == k) &#123;</div><div class="line">            return &amp;b[i];</div><div class="line">        &#125;</div><div class="line">    &#125; while ((i = cache_next(i, m)) != begin);</div><div class="line"></div><div class="line">    // hack</div><div class="line">    Class cls = (Class)((uintptr_t)this - offsetof(objc_class, cache));</div><div class="line">    cache_t::bad_cache(receiver, (SEL)k, cls);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// Class points to cache. SEL is key. Cache buckets store SEL+IMP.</div><div class="line">// Caches are never built in the dyld shared cache.</div><div class="line"></div><div class="line">static inline mask_t cache_hash(cache_key_t key, mask_t mask) </div><div class="line">&#123;</div><div class="line">    return (mask_t)(key &amp; mask);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先获取<code>buckets()</code>获取<code>butket_t</code>,然后获取<code>_mask</code>，通过<br><code>cache_hash(k, m)</code>获取第一次访问的索引<code>i</code>，<code>cache_hash</code>通过<code>(mask_t)(key &amp; mask)</code>得出具体的<code>索引</code>,当第一次成功获取到<code>butket_t</code>则直接返回,否则执行<code>cache_next(i, m)</code>获取下一个索引，直到获取到或者循环一遍结束。<br>那么我们来验证一下已经执行的函数的确是存在cache中的，我们自定义了<code>class_rw_t</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div></pre></td><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line"></div><div class="line">#ifndef MJClassInfo_h</div><div class="line">#define MJClassInfo_h</div><div class="line"></div><div class="line"># if __arm64__</div><div class="line">#   define ISA_MASK        0x0000000ffffffff8ULL</div><div class="line"># elif __x86_64__</div><div class="line">#   define ISA_MASK        0x00007ffffffffff8ULL</div><div class="line"># endif</div><div class="line"></div><div class="line">#if __LP64__</div><div class="line">typedef uint32_t mask_t;</div><div class="line">#else</div><div class="line">typedef uint16_t mask_t;</div><div class="line">#endif</div><div class="line">typedef uintptr_t cache_key_t;</div><div class="line"></div><div class="line">#if __arm__  ||  __x86_64__  ||  __i386__</div><div class="line">// objc_msgSend has few registers available.</div><div class="line">// Cache scan increments and wraps at special end-marking bucket.</div><div class="line">#define CACHE_END_MARKER 1</div><div class="line">static inline mask_t cache_next(mask_t i, mask_t mask) &#123;</div><div class="line">    return (i+1) &amp; mask;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#elif __arm64__</div><div class="line">// objc_msgSend has lots of registers available.</div><div class="line">// Cache scan decrements. No end marker needed.</div><div class="line">#define CACHE_END_MARKER 0</div><div class="line">static inline mask_t cache_next(mask_t i, mask_t mask) &#123;</div><div class="line">    return i ? i-1 : mask;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#else</div><div class="line">#error unknown architecture</div><div class="line">#endif</div><div class="line"></div><div class="line">struct bucket_t &#123;</div><div class="line">    cache_key_t _key;</div><div class="line">    IMP _imp;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct cache_t &#123;</div><div class="line">    bucket_t *_buckets;</div><div class="line">    mask_t _mask;</div><div class="line">    mask_t _occupied;</div><div class="line">    </div><div class="line">    IMP imp(SEL selector)</div><div class="line">    &#123;</div><div class="line">        mask_t begin = _mask &amp; (long long)selector;</div><div class="line">        mask_t i = begin;</div><div class="line">        do &#123;</div><div class="line">            if (_buckets[i]._key == 0  ||  _buckets[i]._key == (long long)selector) &#123;</div><div class="line">                return _buckets[i]._imp;</div><div class="line">            &#125;</div><div class="line">        &#125; while ((i = cache_next(i, _mask)) != begin);</div><div class="line">        return NULL;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct entsize_list_tt &#123;</div><div class="line">    uint32_t entsizeAndFlags;</div><div class="line">    uint32_t count;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct method_t &#123;</div><div class="line">    SEL name;</div><div class="line">    const char *types;</div><div class="line">    IMP imp;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct method_list_t : entsize_list_tt &#123;</div><div class="line">    method_t first;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct ivar_t &#123;</div><div class="line">    int32_t *offset;</div><div class="line">    const char *name;</div><div class="line">    const char *type;</div><div class="line">    uint32_t alignment_raw;</div><div class="line">    uint32_t size;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct ivar_list_t : entsize_list_tt &#123;</div><div class="line">    ivar_t first;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct property_t &#123;</div><div class="line">    const char *name;</div><div class="line">    const char *attributes;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct property_list_t : entsize_list_tt &#123;</div><div class="line">    property_t first;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct chained_property_list &#123;</div><div class="line">    chained_property_list *next;</div><div class="line">    uint32_t count;</div><div class="line">    property_t list[0];</div><div class="line">&#125;;</div><div class="line"></div><div class="line">typedef uintptr_t protocol_ref_t;</div><div class="line">struct protocol_list_t &#123;</div><div class="line">    uintptr_t count;</div><div class="line">    protocol_ref_t list[0];</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct class_ro_t &#123;</div><div class="line">    uint32_t flags;</div><div class="line">    uint32_t instanceStart;</div><div class="line">    uint32_t instanceSize;  // instance对象占用的内存空间</div><div class="line">#ifdef __LP64__</div><div class="line">    uint32_t reserved;</div><div class="line">#endif</div><div class="line">    const uint8_t * ivarLayout;</div><div class="line">    const char * name;  // 类名</div><div class="line">    method_list_t * baseMethodList;</div><div class="line">    protocol_list_t * baseProtocols;</div><div class="line">    const ivar_list_t * ivars;  // 成员变量列表</div><div class="line">    const uint8_t * weakIvarLayout;</div><div class="line">    property_list_t *baseProperties;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct class_rw_t &#123;</div><div class="line">    uint32_t flags;</div><div class="line">    uint32_t version;</div><div class="line">    const class_ro_t *ro;</div><div class="line">    method_list_t * methods;    // 方法列表</div><div class="line">    property_list_t *properties;    // 属性列表</div><div class="line">    const protocol_list_t * protocols;  // 协议列表</div><div class="line">    Class firstSubclass;</div><div class="line">    Class nextSiblingClass;</div><div class="line">    char *demangledName;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">#define FAST_DATA_MASK          0x00007ffffffffff8UL</div><div class="line">struct class_data_bits_t &#123;</div><div class="line">    uintptr_t bits;</div><div class="line">public:</div><div class="line">    class_rw_t* data() &#123;</div><div class="line">        return (class_rw_t *)(bits &amp; FAST_DATA_MASK);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">/* OC对象 */</div><div class="line">struct mj_objc_object &#123;</div><div class="line">    void *isa;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">/* 类对象 */</div><div class="line">struct mj_objc_class : mj_objc_object &#123;</div><div class="line">    Class superclass;</div><div class="line">    cache_t cache;</div><div class="line">    class_data_bits_t bits;</div><div class="line">public:</div><div class="line">    class_rw_t* data() &#123;</div><div class="line">        return bits.data();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    mj_objc_class* metaClass() &#123;</div><div class="line">        return (mj_objc_class *)((long long)isa &amp; ISA_MASK);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>测试代码是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">FYPerson *p = [[FYPerson alloc]init];</div><div class="line">		Method test1Method = class_getInstanceMethod(p.class, @selector(test));</div><div class="line">		Method test2Method = class_getInstanceMethod(p.class, @selector(test2));</div><div class="line">		IMP imp1= method_getImplementation(test1Method);</div><div class="line">		IMP imp2= method_getImplementation(test2Method);</div><div class="line"></div><div class="line">		mj_objc_class *cls = (__bridge mj_objc_class *)p.class;</div><div class="line">		NSLog(@&quot;-----&quot;);</div><div class="line">		[p test];</div><div class="line">		[p test2];</div><div class="line">		cache_t cache = cls-&gt;cache;</div><div class="line">		bucket_t *buck = cache._buckets;</div><div class="line">		</div><div class="line">		</div><div class="line">		for (int i = 0; i &lt;= cache._mask; i ++) &#123;</div><div class="line">			bucket_t item = buck[i];</div><div class="line">			if (item._key != 0) &#123;</div><div class="line">				NSLog(@&quot;key:%lu imp:%p&quot;,item._key,item._imp);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		</div><div class="line">		//输出</div><div class="line">p imp1</div><div class="line">(IMP) $0 = 0x0000000100000df0 (day11-runtime1`-[FYPerson test] at FYPerson.m:12)</div><div class="line">(lldb) p imp2</div><div class="line">(IMP) $1 = 0x0000000100000e20 (day11-runtime1`-[FYPerson test2] at FYPerson.m:15)</div><div class="line">p/d @selector(test)             //输出 test方法的sel地址</div><div class="line">(SEL) $6 = 140734025103231 &quot;test&quot;</div><div class="line">(lldb) p/d @selector(test2)     //输出 test2方法的sel地址</div><div class="line">(SEL) $7 = 4294971267 &quot;test2&quot;</div><div class="line"></div><div class="line">key1:140733954181041 imp1:0x7fff59fc4cd1</div><div class="line">key2:4294971267 imp2:0x100000e20         //对应test2</div><div class="line">key3:140734025103231 imp3:0x100000df0    //对应test1</div></pre></td></tr></table></figure>
<p>可以看出来<code>IMP1</code>和<code>IMP2</code>、<code>key1</code> 和<code>key2</code>分别对应了<code>bucket_t</code>中的<code>key2</code>,<code>key3</code>和<code>imp2</code>和<code>imp3</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">static void cache_fill_nolock(Class cls, SEL sel, IMP imp, id receiver)</div><div class="line">&#123;</div><div class="line">    cacheUpdateLock.assertLocked();</div><div class="line"></div><div class="line">    //当initialized 没有执行完毕的时候不缓存</div><div class="line">    if (!cls-&gt;isInitialized()) return;</div><div class="line"></div><div class="line">    // Make sure the entry wasn&apos;t added to the cache by some other thread </div><div class="line">    // before we grabbed the cacheUpdateLock.</div><div class="line">    if (cache_getImp(cls, sel)) return;</div><div class="line"></div><div class="line">    cache_t *cache = getCache(cls);</div><div class="line">    cache_key_t key = getKey(sel);</div><div class="line"></div><div class="line">    // Use the cache as-is if it is less than 3/4 full</div><div class="line">    mask_t newOccupied = cache-&gt;occupied() + 1;</div><div class="line">    mask_t capacity = cache-&gt;capacity();</div><div class="line">    if (cache-&gt;isConstantEmptyCache()) &#123;</div><div class="line">        // Cache is read-only. Replace it.</div><div class="line">        cache-&gt;reallocate(capacity, capacity ?: INIT_CACHE_SIZE);</div><div class="line">    &#125;</div><div class="line">    else if (newOccupied &lt;= capacity / 4 * 3) &#123;</div><div class="line">        // Cache &lt;= 3/4 </div><div class="line">    &#125;</div><div class="line">    else &#123;</div><div class="line">        扩容 之后，缓存清空</div><div class="line">        cache-&gt;expand();</div><div class="line">    &#125;</div><div class="line">//bucket_t 最小是4，当&gt;3/4时候，扩容，空间扩容之后是之前的2️倍。</div><div class="line">    bucket_t *bucket = cache-&gt;find(key, receiver);</div><div class="line">    if (bucket-&gt;key() == 0) cache-&gt;incrementOccupied();</div><div class="line">    bucket-&gt;set(key, imp);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>cache_t</code>初始化是大小是4，当大于3/4时，进行扩容，扩容之后是之前的2倍，数据被清空，<code>cacha-&gt;_occupied</code>恢复为0。<br>验证代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">FYPerson *p = [[FYPerson alloc]init];</div><div class="line">mj_objc_class *cls = (__bridge mj_objc_class *)p.class;</div><div class="line">NSLog(@&quot;-----&quot;);</div><div class="line">[p test];</div><div class="line">/*</div><div class="line"> key:init imp:0x7fff58807c2d</div><div class="line"> key:class imp:0x7fff588084b7</div><div class="line"> key:(null) imp:0x0</div><div class="line"> key:test imp:0x100000bf0</div><div class="line"> Program ended with exit code: 0</div><div class="line"> */</div><div class="line">[p test2]; //当执行该函数的时候</div><div class="line">/*</div><div class="line"> key:(null) imp:0x0</div><div class="line"> key:(null) imp:0x0</div><div class="line"> key:(null) imp:0x0</div><div class="line"> key:(null) imp:0x0</div><div class="line"> key:(null) imp:0x0</div><div class="line"> key:(null) imp:0x0</div><div class="line"> key:test2 imp:0x100000c20</div><div class="line"> key:(null) imp:0x0</div><div class="line"> */</div><div class="line"></div><div class="line">cache_t cache = cls-&gt;cache;</div><div class="line">bucket_t *buck = cache._buckets;</div><div class="line"></div><div class="line"></div><div class="line">for (int i = 0; i &lt;= cache._mask; i ++) &#123;</div><div class="line">	bucket_t item = buck[i];</div><div class="line">//            if (item._key != 0) &#123;</div><div class="line">////                printf(&quot;key:%s imp:%p \n&quot;,(const char *)item._key,item._imp);</div><div class="line">//            &#125;</div><div class="line">    printf(&quot;key:%s imp:%p \n&quot;,(const char *)item._key,item._imp);</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>arm64之后isa使用联合体用更少的空间存储更多的数据，arm64之前存储class和meta-class指针。</li>
<li>函数执行会先从cache中查找，没有的话，当再次找到该函数会添加到cache中</li>
<li>从<code>class-&gt;cache</code>查找<code>bucket_t</code>的key需要先<code>&amp;_mask</code>之后再判断是否有该<code>key</code></li>
<li>cache扩容在大于3/4进行2倍扩容，扩容之后，旧数据删除，<code>imp</code>个数清空</li>
<li><code>class-&gt;rw</code>在初始化中讲<code>class_ro_t</code>值赋值给<code>rw</code>,然后<code>rw-&gt;ro</code>指向之前的<code>ro</code>。</li>
</ul>
<h4 id="资料下载"><a href="#资料下载" class="headerlink" title="资料下载"></a>资料下载</h4><ul>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="external">学习资料下载</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="external">demo code</a></li>
<li><p><a href="https://github.com/ifgyong/demo/tree/master/OC/objc4-750" target="_blank" rel="external">runtime可运行的源码</a></p>
<hr>
<p>最怕一生碌碌无为，还安慰自己平凡可贵。</p>
</li>
</ul>
<p>广告时间</p>
<p><img src="../images/0.png" alt=""></p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/01/iOS底层原理  block本质 --(5)/" rel="next" title="iOS底层原理  block本质 --(5)">
                <i class="fa fa-chevron-left"></i> iOS底层原理  block本质 --(5)
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/01/iOS底层原理 runtime- objc_msgSend拾遗基础篇--(7)/" rel="prev" title="iOS底层原理 runtime- objc_msgSend拾遗基础篇--(7)">
                iOS底层原理 runtime- objc_msgSend拾遗基础篇--(7) <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/0.jpeg"
                alt="fgyong"/>
            
              <p class="site-author-name" itemprop="name">fgyong</p>
              <div class="site-description motion-element" itemprop="description">在学习的路上，不忘初心 方得始终</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">42</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                  <a href="https://github.com/ifgyong" title="GitHub &rarr; https://github.com/ifgyong" rel="noopener" target="_blank">GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                  <a href="https://juejin.im/user/5693a77b60b2c2974cdd7f7f/posts" title="掘金 &rarr; https://juejin.im/user/5693a77b60b2c2974cdd7f7f/posts" rel="noopener" target="_blank">掘金</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#runtime-基础知识"><span class="nav-number">1.</span> <span class="nav-text">runtime 基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#共用体基础知识"><span class="nav-number">1.1.</span> <span class="nav-text">共用体基础知识</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Class的结构"><span class="nav-number">1.2.</span> <span class="nav-text">Class的结构</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SEL"><span class="nav-number">1.2.1.</span> <span class="nav-text">SEL</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Type-Encoding"><span class="nav-number">1.2.2.</span> <span class="nav-text">Type Encoding</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#方法缓存"><span class="nav-number">1.3.</span> <span class="nav-text">方法缓存</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#总结"><span class="nav-number">2.</span> <span class="nav-text">总结</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#资料下载"><span class="nav-number">2.1.</span> <span class="nav-text">资料下载</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">  <a href="http://www.miitbeian.gov.cn" rel="noopener" target="_blank">豫ICP备17045226号-1 </a>&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fgyong</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.4.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>




  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  
  <script src="/js/js.cookie.js?v=7.1.0"></script>
  <script src="/js/scroll-cookie.js?v=7.1.0"></script>


  

  

  


  
    

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"/>



<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: 'a7800c37057fc3ce83df',
    clientSecret: '0de240e28197f071e10fcb67d4337fd8afe8a9c3',
    repo: 'ifgyong.github.io',
    owner: 'ifgyong',
    admin: ['ifgyong'],
    id: md5(location.pathname),
    
      language: 'zh-CN',
    
    distractionFreeMode: 'false'
  });
  gitalk.render('gitalk-container');
</script>

  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
