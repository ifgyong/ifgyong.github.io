<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222"/>
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"/>

<link rel="stylesheet" href="/css/main.css?v=7.1.0"/>


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="在学习的路上，不忘初心 方得始终">
<meta property="og:type" content="website">
<meta property="og:title" content="兜兜转转的技术博客">
<meta property="og:url" content="http://fgyong.cn/page/2/index.html">
<meta property="og:site_name" content="兜兜转转的技术博客">
<meta property="og:description" content="在学习的路上，不忘初心 方得始终">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="兜兜转转的技术博客">
<meta name="twitter:description" content="在学习的路上，不忘初心 方得始终">





  
  
  <link rel="canonical" href="http://fgyong.cn/page/2/"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>兜兜转转的技术博客 – 不忘初心 方得始终</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">兜兜转转的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">不忘初心 方得始终</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Navigationsleiste an/ausschalten">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-主页"></i> <br/>Startseite</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-列表"></i> <br/>Archiv</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-标签"></i> <br/>Schlagwörter</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-类别"></i> <br/>Kategorien</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-关于"></i> <br/>Über</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/ifgyong" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOS底层原理 Category与关联对象本质--(4)/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="兜兜转转"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兜兜转转的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/01/iOS底层原理 Category与关联对象本质--(4)/" class="post-title-link" itemprop="url">iOS底层原理 Category与关联对象本质--(4)</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-12-01 11:14:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:14:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-12-03 14:30:32" itemprop="dateModified" datetime="2019-12-03T14:30:32+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p> 今天我们再看一下<code>Category</code>的底层原理。<br> 先看一下<code>Category</code>的简单使用，首先新增一个类的<code>Category</code>，然后添加需要的函数，然后在使用的文件中导入就可以直接使用了。代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">@interface FYPerson : NSObject</div><div class="line">- (void)run;</div><div class="line">@end</div><div class="line">@implementation FYPerson</div><div class="line">-(void)run&#123;</div><div class="line">	NSLog(@&quot;run is run&quot;);</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line">//类别</div><div class="line">@interface FYPerson (test)</div><div class="line">- (void)test;</div><div class="line">@end</div><div class="line">@implementation FYPerson (test)</div><div class="line">- (void)test&#123;</div><div class="line">	NSLog(@&quot;test is run&quot;);</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line">//使用</div><div class="line">#import &quot;FYPerson.h&quot;</div><div class="line">#import &quot;FYPerson+test.h&quot;</div><div class="line"></div><div class="line"></div><div class="line">FYPerson *person=[[FYPerson alloc]init];</div><div class="line">[person test];</div><div class="line">[person run];</div></pre></td></tr></table></figure>
<p>  类别使用就是这么简单。<br>  那么类别的本质是什么呢？类的方法是存储在什么地方呢？<br>  第一篇<a href="https://juejin.im/post/5d15887ee51d45108126d28d" target="_blank" rel="external">类的本质</a>已经讲过了，运行时中，类对象是有一份，方法都存储在类对象结构体<code>fy_objc_class</code>中的<code>class_data_bits_t-&gt;data()-&gt;method_list_t</code>中的，那么类别方法也是存储在<code>method_list_t</code>和取元类对象的<code>method_list_t</code>中的。编译的时候类别编译成结构体<code>_category_t</code>,然后<code>runtime</code>在运行时动态将方法添加到<code>method_list_t</code>中。运行<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc FYPerson+test.m -o FYPerson+test.cpp</code>进入到<code>FYPerson+test.cpp</code>内部查看编译之后的代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">  struct _category_t &#123;</div><div class="line">	const char *name; //&quot;FYPerson&quot;</div><div class="line">	struct _class_t *cls;</div><div class="line">	const struct _method_list_t *instance_methods;</div><div class="line">	const struct _method_list_t *class_methods;</div><div class="line">	const struct _protocol_list_t *protocols;</div><div class="line">	const struct _prop_list_t *properties;</div><div class="line">&#125;;</div><div class="line">//存储 test方法</div><div class="line">static struct /*_method_list_t*/ &#123;</div><div class="line">	unsigned int entsize;  // sizeof(struct _objc_method)</div><div class="line">	unsigned int method_count;</div><div class="line">	struct _objc_method method_list[1];</div><div class="line">&#125; _OBJC_$_CATEGORY_INSTANCE_METHODS_FYPerson_$_test __attribute__ ((used, section (&quot;__DATA,__objc_const&quot;))) = &#123;</div><div class="line">	sizeof(_objc_method),</div><div class="line">	1,</div><div class="line">	&#123;&#123;(struct objc_selector *)&quot;test&quot;, &quot;v16@0:8&quot;, (void *)_I_FYPerson_test_test&#125;&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">extern &quot;C&quot; __declspec(dllimport) struct _class_t OBJC_CLASS_$_FYPerson;</div><div class="line"></div><div class="line">//_category_t 存储FYPerson的分类的数据</div><div class="line">static struct _category_t _OBJC_$_CATEGORY_FYPerson_$_test __attribute__ ((used, section (&quot;__DATA,__objc_const&quot;))) = </div><div class="line">&#123;</div><div class="line">	&quot;FYPerson&quot;,</div><div class="line">	0, // &amp;OBJC_CLASS_$_FYPerson,</div><div class="line">	(const struct _method_list_t *)&amp;_OBJC_$_CATEGORY_INSTANCE_METHODS_FYPerson_$_test,//instace方法</div><div class="line">	0,//类方法</div><div class="line">	0,//协议方法</div><div class="line">	0,//属性</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>存储在<code>_category_t</code>中的数据是什么时间加载到<code>FYPerson</code>的<code>class_data_bits_t.data</code>呢？我们探究一下，打开<a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="external">源码</a>下载打开工程阅读源码找到<code>objc-os.mm</code>,通过查找函数运行顺序得到<code>_objec_init-&gt;map_images-&gt;map_images_noljock-&gt;_read_images-&gt;remethodizeClass(cls)-&gt;attachCategories(cls, cats, true /*flush caches*/)</code>，最终进入到<code>attachCategories</code>关键函数内部：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">  // Attach method lists and properties and protocols from categories to a class.</div><div class="line">// Assumes the categories in cats are all loaded and sorted by load order, </div><div class="line">// oldest categories first.</div><div class="line">static void </div><div class="line">attachCategories(Class cls, category_list *cats, bool flush_caches)</div><div class="line">&#123;</div><div class="line">    if (!cats) return;</div><div class="line">    if (PrintReplacedMethods) printReplacements(cls, cats);</div><div class="line"></div><div class="line">    bool isMeta = cls-&gt;isMetaClass();</div><div class="line"></div><div class="line">    // fixme rearrange to remove these intermediate allocations</div><div class="line">	//方法数组[[1,2,3],[4,5,6],[7,8,9]]</div><div class="line">    method_list_t **mlists = (method_list_t **)</div><div class="line">        malloc(cats-&gt;count * sizeof(*mlists));</div><div class="line">	//属性数组</div><div class="line">    property_list_t **proplists = (property_list_t **)</div><div class="line">        malloc(cats-&gt;count * sizeof(*proplists));</div><div class="line">	//协议数组</div><div class="line">    protocol_list_t **protolists = (protocol_list_t **)</div><div class="line">        malloc(cats-&gt;count * sizeof(*protolists));</div><div class="line"></div><div class="line">    // Count backwards through cats to get newest categories first</div><div class="line">    int mcount = 0;</div><div class="line">    int propcount = 0;</div><div class="line">    int protocount = 0;</div><div class="line">    int i = cats-&gt;count;</div><div class="line">    bool fromBundle = NO;</div><div class="line">    //最后的编译文件放到最前边</div><div class="line">    while (i--) &#123;</div><div class="line">		//取出某个分类</div><div class="line">        auto&amp; entry = cats-&gt;list[i];</div><div class="line">//取出分类 的 instance方法或者class方法</div><div class="line">        method_list_t *mlist = entry.cat-&gt;methodsForMeta(isMeta);</div><div class="line">        if (mlist) &#123;</div><div class="line">            mlists[mcount++] = mlist; //mlists 接受所有分类方法</div><div class="line">            fromBundle |= entry.hi-&gt;isBundle();</div><div class="line">        &#125;</div><div class="line">//proplist 接受所有分类属性</div><div class="line">        property_list_t *proplist = </div><div class="line">            entry.cat-&gt;propertiesForMeta(isMeta, entry.hi);</div><div class="line">        if (proplist) &#123;</div><div class="line">            proplists[propcount++] = proplist;</div><div class="line">        &#125;</div><div class="line">//proplist 接受所有协议方法</div><div class="line">        protocol_list_t *protolist = entry.cat-&gt;protocols;</div><div class="line">        if (protolist) &#123;</div><div class="line">            protolists[protocount++] = protolist;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">//收集了所有协议 分类方法</div><div class="line">    auto rw = cls-&gt;data();</div><div class="line"></div><div class="line">    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);</div><div class="line">	//追加所有分类方法</div><div class="line">    rw-&gt;methods.attachLists(mlists, mcount);</div><div class="line">	//释放数组</div><div class="line">    free(mlists);</div><div class="line">	//刷新该类的缓存</div><div class="line">    if (flush_caches  &amp;&amp;  mcount &gt; 0) flushCaches(cls);</div><div class="line">//追加所有分类属性</div><div class="line">    rw-&gt;properties.attachLists(proplists, propcount);</div><div class="line">    free(proplists);//释放数组</div><div class="line">//追加所有分类协议</div><div class="line">    rw-&gt;protocols.attachLists(protolists, protocount);</div><div class="line">    free(protolists);//释放数组</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><code>attachCategories</code>是将所有的分类方法和协议，属性倒序添加到类中，具体添加的优先级是怎么操作的？进入到<code>rw-&gt;protocols.attachLists</code>内部：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">void attachLists(List* const * addedLists, uint32_t addedCount) &#123;</div><div class="line">        if (addedCount == 0) return;</div><div class="line">        if (hasArray()) &#123;</div><div class="line">            // many lists -&gt; many lists</div><div class="line">            uint32_t oldCount = array()-&gt;count;</div><div class="line">			//一共需要的数量</div><div class="line">            uint32_t newCount = oldCount + addedCount;</div><div class="line">			//分配内存 内存不够用了，需要扩容</div><div class="line">            setArray((array_t *)realloc(array(), array_t::byteSize(newCount)));</div><div class="line">			//赋值count</div><div class="line">            array()-&gt;count = newCount;</div><div class="line">			// array()-&gt;lists：原来的方法列表向后移动 oldCount * sizeof(array()-&gt;lists[0]个长度</div><div class="line">            memmove(array()-&gt;lists + addedCount/*指针移动到数组末尾*/, array()-&gt;lists/*数组*/,</div><div class="line">                    oldCount * sizeof(array()-&gt;lists[0])/*移动数据的大小*/);</div><div class="line">			//空出来的 内存使用addedLists拷贝过去 大小是:addedCount * sizeof(array()-&gt;lists[0])</div><div class="line">            memcpy(array()-&gt;lists, addedLists, </div><div class="line">                   addedCount * sizeof(array()-&gt;lists[0]));</div><div class="line">			/*</div><div class="line">			图示讲解：</div><div class="line">			array()-&gt;lists:A-&gt;B-&gt;C-&gt;D-&gt;E</div><div class="line">		addedCount:3</div><div class="line">		addedLists:P-&gt;L-&gt;V</div><div class="line">			memmove之后：nil-&gt;nil-&gt;nil-&gt;A-&gt;B-&gt;C-&gt;D-&gt;E</div><div class="line">			然后再讲addedLists插入到数组前边,最终array()-&gt;lists的值是：</div><div class="line">			P-&gt;L-&gt;V-&gt;A-&gt;B-&gt;C-&gt;D-&gt;E</div><div class="line">			 */</div><div class="line">        &#125;</div><div class="line">        else if (!list  &amp;&amp;  addedCount == 1) &#123;</div><div class="line">            // 0 lists -&gt; 1 list</div><div class="line">            list = addedLists[0];</div><div class="line">        &#125; </div><div class="line">        else &#123;</div><div class="line">            // 1 list -&gt; many lists</div><div class="line">            List* oldList = list;</div><div class="line">            uint32_t oldCount = oldList ? 1 : 0;</div><div class="line">            uint32_t newCount = oldCount + addedCount;</div><div class="line">            setArray((array_t *)malloc(array_t::byteSize(newCount)));</div><div class="line">            array()-&gt;count = newCount;</div><div class="line">            if (oldList) array()-&gt;lists[addedCount] = oldList;</div><div class="line">            memcpy(array()-&gt;lists, addedLists, </div><div class="line">                   addedCount * sizeof(array()-&gt;lists[0]));</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以看出来：</p>
<ol>
<li>首先通过<code>runtime</code>加载某个类的所有Category数据</li>
<li>把所有Category的方法，属性，协议数据合并到一个大数组中，后面参与编译的数组会出现在数组前边</li>
<li>将合并后的分类数组(方法，属性，协议)插入到类原来的数据的前面。</li>
</ol>
<p>具体的编译顺序是project文件中-&gt;Build Phases-&gt;Complile Sources的顺序。</p>
<h3 id="调用顺序"><a href="#调用顺序" class="headerlink" title="调用顺序"></a>调用顺序</h3><h4 id="load加载顺序"><a href="#load加载顺序" class="headerlink" title="+load加载顺序"></a>+load加载顺序</h4><p>每个类和分类都会加载的时候调用<code>+load</code>方法，具体是怎么调用呢？我们查看源码<code>_objc_init-&gt;load_images-&gt;call_load_methods</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">void call_load_methods(void)</div><div class="line">&#123;</div><div class="line">    static bool loading = NO;</div><div class="line">    bool more_categories;</div><div class="line"></div><div class="line">    loadMethodLock.assertLocked();</div><div class="line"></div><div class="line">    // Re-entrant calls do nothing; the outermost call will finish the job.</div><div class="line">    if (loading) return;</div><div class="line">    loading = YES;</div><div class="line"></div><div class="line">    void *pool = objc_autoreleasePoolPush();</div><div class="line"></div><div class="line">    do &#123;</div><div class="line">        // 1. Repeatedly call class +loads until there aren&apos;t any more</div><div class="line">        //执行class+load直到完成</div><div class="line">        while (loadable_classes_used &gt; 0) &#123;</div><div class="line">            call_class_loads();</div><div class="line">        &#125;</div><div class="line">//执行Category +load 一次</div><div class="line">        // 2. Call category +loads ONCE</div><div class="line">        more_categories = call_category_loads();</div><div class="line"></div><div class="line">        // 3. Run more +loads if there are classes OR more untried categories</div><div class="line">    &#125; while (loadable_classes_used &gt; 0  ||  more_categories);</div><div class="line"></div><div class="line">    objc_autoreleasePoolPop(pool);</div><div class="line"></div><div class="line">    loading = NO;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>类<code>+load</code>在<code>Category+load</code>前边执行，当类的<code>+load</code>执行完毕然后再去执行<code>Category+load</code>,而且只有一次。<br>当class有子类的时候加载顺序呢？其实所有类都是基于<code>NSObject</code>，那么我们假设按照编译顺序加载<code>Class+load</code>，就有一个问题是父类+load执行的操作岂不是在子类执行的时候还没有执行吗？这个假设明显不对，基类<code>+load</code>中的操作是第一个执行的，其他子类是按照<code>superclass-&gt;class-&gt;sonclass</code>的顺序执行的。<br>查看源码<code>_objc_init-&gt;load_images-&gt;prepare_load_methods((const headerType *)mh)-&gt;schedule_class_load</code>在<code>objc-runtime-new.mm</code>2856行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">/***********************************************************************</div><div class="line">* Schedule +load for classes in this image, any un-+load-ed </div><div class="line">* superclasses in other images, and any categories in this image.</div><div class="line">**********************************************************************/</div><div class="line">// Recursively schedule +load for cls and any un-+load-ed superclasses.</div><div class="line">// cls must already be connected.</div><div class="line">static void schedule_class_load(Class cls)</div><div class="line">&#123;</div><div class="line">    if (!cls) return;</div><div class="line">    assert(cls-&gt;isRealized());  // _read_images should realize</div><div class="line"></div><div class="line">    if (cls-&gt;data()-&gt;flags &amp; RW_LOADED) return;</div><div class="line"></div><div class="line">    // Ensure superclass-first ordering</div><div class="line">    //递归调用自己直到调用clas-&gt;self</div><div class="line">    schedule_class_load(cls-&gt;superclass);</div><div class="line">//添加class</div><div class="line">    add_class_to_loadable_list(cls);</div><div class="line">    cls-&gt;setInfo(RW_LOADED); </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以了解到该函数递归调用自己，直到<code>+load</code>方法已经调用过为止，所以不管编译顺序是高低，<code>+load</code>的加载顺序始终是<code>NSObject-&gt;FYPrson-&gt;FYStudent</code>。多个类平行关系的话，按照编译顺序加载。<br>下边是稍微复杂点的类关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">NSObject</div><div class="line">    Person</div><div class="line">        Student</div><div class="line">NSObjet</div><div class="line">    Car</div><div class="line">        BigCar</div><div class="line">            BigOrSmallCar</div></pre></td></tr></table></figure>
<p>编译顺序是</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Person</div><div class="line">Student</div><div class="line">Car</div><div class="line">BigOrSmallCar</div></pre></td></tr></table></figure>
<p>那么他们<code>+load</code>的加载顺序是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">NSobject-&gt;Person-&gt;Student-&gt;Car-&gt;BigCar-&gt;BigOrSmallCar</div></pre></td></tr></table></figure>
<p>看着不是很明白的 可以再看一下刚才的<code>schedule_class_load</code>函数。<br>加载成功之后，是按照<code>objc_msgsend()</code>流程发送的吗？我们进入到<code>call_class_loads</code>内部</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">static void call_class_loads(void)</div><div class="line">&#123;</div><div class="line">    int i;</div><div class="line">    </div><div class="line">    // Detach current loadable list.</div><div class="line">    struct loadable_class *classes = loadable_classes;</div><div class="line">    int used = loadable_classes_used;</div><div class="line">    loadable_classes = nil;</div><div class="line">    loadable_classes_allocated = 0;</div><div class="line">    loadable_classes_used = 0;</div><div class="line">    </div><div class="line">    // Call all +loads for the detached list.</div><div class="line">    for (i = 0; i &lt; used; i++) &#123;</div><div class="line">        Class cls = classes[i].cls;</div><div class="line">        load_method_t load_method = (load_method_t)classes[i].method;</div><div class="line">        if (!cls) continue; </div><div class="line"></div><div class="line">        if (PrintLoading) &#123;</div><div class="line">            _objc_inform(&quot;LOAD: +[%s load]\n&quot;, cls-&gt;nameForLogging());</div><div class="line">        &#125;</div><div class="line">        (*load_method)(cls, SEL_load);</div><div class="line">    &#125;</div><div class="line">    if (classes) free(classes);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以找到<code>(*load_method)(cls, SEL_load);</code>该函数，该函数是直接使用<code>IMP</code>执行的，<code>IMP</code>就是函数地址，可以直接访问函数而不用消息的转发流程。</p>
<h4 id="initialize调用"><a href="#initialize调用" class="headerlink" title="+initialize调用"></a>+initialize调用</h4><ul>
<li>+initialize方法会在类第一次接收到消息时调用</li>
<li>先调用父类的+initialize，再调用子类的+initialize</li>
<li>先初始化父类，再初始化子类，每个类只会初始化1次</li>
</ul>
<p><code>objc</code>源码解读过程<code>objc-msg-arm64.x-&gt;objc_msgSend-&gt;objc-&gt;runtime-new-&gt;class_getinstanceMethod-&gt;lookUpImpOrNil-&gt;lookUpImpOrForward-&gt;_clas_initialize-&gt;callInitialize-&gt;objc_msgSend(cls,SEL_Initialize)</code><br>在<code>runtime-new.h</code>4819行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Method class_getInstanceMethod(Class cls, SEL sel)</div><div class="line">&#123;</div><div class="line">    if (!cls  ||  !sel) return nil;</div><div class="line"></div><div class="line">    lookUpImpOrNil(cls, sel, nil, </div><div class="line">                   NO/*initialize*/, NO/*cache*/, YES/*resolver*/);</div><div class="line"></div><div class="line"></div><div class="line">    return _class_getMethod(cls, sel);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>根据<code>lookUpImpOrNil</code>查看4916行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div></pre></td><td class="code"><pre><div class="line">IMP lookUpImpOrForward(Class cls, SEL sel, id inst, </div><div class="line">                       bool initialize, bool cache, bool resolver)</div><div class="line">&#123;</div><div class="line">    IMP imp = nil;</div><div class="line">    bool triedResolver = NO;</div><div class="line"></div><div class="line">    runtimeLock.assertUnlocked();</div><div class="line"></div><div class="line">    // Optimistic cache lookup</div><div class="line">    if (cache) &#123;</div><div class="line">        imp = cache_getImp(cls, sel);</div><div class="line">        if (imp) return imp;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    runtimeLock.lock();</div><div class="line">    checkIsKnownClass(cls);</div><div class="line"></div><div class="line">    if (!cls-&gt;isRealized()) &#123;</div><div class="line">        realizeClass(cls);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (initialize  &amp;&amp;  !cls-&gt;isInitialized()) &#123;</div><div class="line">        runtimeLock.unlock();</div><div class="line">        _class_initialize (_class_getNonMetaClass(cls, inst));</div><div class="line">        runtimeLock.lock();</div><div class="line">      //当第一次收到消息，cls没有初始化，则调用_class_initialize进行初始化</div><div class="line">      &#125;</div><div class="line"> retry:    </div><div class="line">    runtimeLock.assertLocked();</div><div class="line">    imp = cache_getImp(cls, sel);</div><div class="line">    if (imp) goto done;</div><div class="line">   // Try this class&apos;s method lists.</div><div class="line">    //在本类中查找method</div><div class="line">    &#123;</div><div class="line">        Method meth = getMethodNoSuper_nolock(cls, sel);</div><div class="line">        if (meth) &#123;</div><div class="line">            log_and_fill_cache(cls, meth-&gt;imp, sel, inst, cls);</div><div class="line">            imp = meth-&gt;imp;</div><div class="line">            goto done;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Try superclass caches and method lists.</div><div class="line">    &#123;</div><div class="line">        unsigned attempts = unreasonableClassCount();</div><div class="line">        for (Class curClass = cls-&gt;superclass;</div><div class="line">             curClass != nil;</div><div class="line">             curClass = curClass-&gt;superclass)</div><div class="line">        &#123;</div><div class="line">            // Halt if there is a cycle in the superclass chain.</div><div class="line">            if (--attempts == 0) &#123;</div><div class="line">                _objc_fatal(&quot;Memory corruption in class list.&quot;);</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            // Superclass cache.</div><div class="line">            imp = cache_getImp(curClass, sel);</div><div class="line">            if (imp) &#123;</div><div class="line">                if (imp != (IMP)_objc_msgForward_impcache) &#123;</div><div class="line">                    // Found the method in a superclass. Cache it in this class.</div><div class="line">                    log_and_fill_cache(cls, imp, sel, inst, curClass);</div><div class="line">                    goto done;</div><div class="line">                &#125;</div><div class="line">                else &#123;</div><div class="line">                    // Found a forward:: entry in a superclass.</div><div class="line">                    // Stop searching, but don&apos;t cache yet; call method </div><div class="line">                    // resolver for this class first.</div><div class="line">                    break;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            // Superclass method list.</div><div class="line">            Method meth = getMethodNoSuper_nolock(curClass, sel);</div><div class="line">            if (meth) &#123;</div><div class="line">                log_and_fill_cache(cls, meth-&gt;imp, sel, inst, curClass);</div><div class="line">                imp = meth-&gt;imp;</div><div class="line">                goto done;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // No implementation found. Try method resolver once.</div><div class="line"></div><div class="line">    if (resolver  &amp;&amp;  !triedResolver) &#123;</div><div class="line">        runtimeLock.unlock();</div><div class="line">        _class_resolveMethod(cls, sel, inst);</div><div class="line">        runtimeLock.lock();</div><div class="line">        // Don&apos;t cache the result; we don&apos;t hold the lock so it may have </div><div class="line">        // changed already. Re-do the search from scratch instead.</div><div class="line">        triedResolver = YES;</div><div class="line">        goto retry;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // No implementation found, and method resolver didn&apos;t help. </div><div class="line">    // Use forwarding.</div><div class="line"></div><div class="line">    imp = (IMP)_objc_msgForward_impcache;</div><div class="line">    cache_fill(cls, sel, imp, inst);</div><div class="line"></div><div class="line"> done:</div><div class="line">    runtimeLock.unlock();</div><div class="line"></div><div class="line">    return imp;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当第一次收到消息，cls没有初始化，则调用<code>_class_initialize</code>进行初始化<br>我们进入到<code>_class_initialize</code>内部<code>objc-initialize.mm</code>484行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line">void _class_initialize(Class cls)</div><div class="line">&#123;</div><div class="line">    assert(!cls-&gt;isMetaClass());</div><div class="line"></div><div class="line">    Class supercls;</div><div class="line">    bool reallyInitialize = NO;</div><div class="line"></div><div class="line">    // Make sure super is done initializing BEFORE beginning to initialize cls.</div><div class="line">    // See note about deadlock above.</div><div class="line">    //递归调用父类是否有初始化和是否有父类</div><div class="line">    supercls = cls-&gt;superclass;</div><div class="line">    if (supercls  &amp;&amp;  !supercls-&gt;isInitialized()) &#123;</div><div class="line">        _class_initialize(supercls);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // Try to atomically set CLS_INITIALIZING.</div><div class="line">    &#123;</div><div class="line">        monitor_locker_t lock(classInitLock);</div><div class="line">        if (!cls-&gt;isInitialized() &amp;&amp; !cls-&gt;isInitializing()) &#123;</div><div class="line">            cls-&gt;setInitializing();</div><div class="line">            reallyInitialize = YES;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (reallyInitialize) &#123;</div><div class="line">        // We successfully set the CLS_INITIALIZING bit. Initialize the class.</div><div class="line">        </div><div class="line">        // Record that we&apos;re initializing this class so we can message it.</div><div class="line">        _setThisThreadIsInitializingClass(cls);</div><div class="line"></div><div class="line">        if (MultithreadedForkChild) &#123;</div><div class="line">            // LOL JK we don&apos;t really call +initialize methods after fork().</div><div class="line">            performForkChildInitialize(cls, supercls);</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        // Send the +initialize message.</div><div class="line">        // Note that +initialize is sent to the superclass (again) if </div><div class="line">        // this class doesn&apos;t implement +initialize. 2157218</div><div class="line">        if (PrintInitializing) &#123;</div><div class="line">            _objc_inform(&quot;INITIALIZE: thread %p: calling +[%s initialize]&quot;,</div><div class="line">                         pthread_self(), cls-&gt;nameForLogging());</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // Exceptions: A +initialize call that throws an exception </div><div class="line">        // is deemed to be a complete and successful +initialize.</div><div class="line">        //</div><div class="line">        // Only __OBJC2__ adds these handlers. !__OBJC2__ has a</div><div class="line">        // bootstrapping problem of this versus CF&apos;s call to</div><div class="line">        // objc_exception_set_functions().</div><div class="line">#if __OBJC2__</div><div class="line">        @try</div><div class="line">#endif</div><div class="line">        &#123;</div><div class="line">            callInitialize(cls);</div><div class="line"></div><div class="line">            if (PrintInitializing) &#123;</div><div class="line">                _objc_inform(&quot;INITIALIZE: thread %p: finished +[%s initialize]&quot;,</div><div class="line">                             pthread_self(), cls-&gt;nameForLogging());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">#if __OBJC2__</div><div class="line">        @catch (...) &#123;</div><div class="line">            if (PrintInitializing) &#123;</div><div class="line">                _objc_inform(&quot;INITIALIZE: thread %p: +[%s initialize] &quot;</div><div class="line">                             &quot;threw an exception&quot;,</div><div class="line">                             pthread_self(), cls-&gt;nameForLogging());</div><div class="line">            &#125;</div><div class="line">            @throw;</div><div class="line">        &#125;</div><div class="line">        @finally</div><div class="line">#endif</div><div class="line">        &#123;</div><div class="line">            // Done initializing.</div><div class="line">            lockAndFinishInitializing(cls, supercls);</div><div class="line">        &#125;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    else if (cls-&gt;isInitializing()) &#123;</div><div class="line">        // We couldn&apos;t set INITIALIZING because INITIALIZING was already set.</div><div class="line">        // If this thread set it earlier, continue normally.</div><div class="line">        // If some other thread set it, block until initialize is done.</div><div class="line">        // It&apos;s ok if INITIALIZING changes to INITIALIZED while we&apos;re here, </div><div class="line">        //   because we safely check for INITIALIZED inside the lock </div><div class="line">        //   before blocking.</div><div class="line">        if (_thisThreadIsInitializingClass(cls)) &#123;</div><div class="line">            return;</div><div class="line">        &#125; else if (!MultithreadedForkChild) &#123;</div><div class="line">            waitForInitializeToComplete(cls);</div><div class="line">            return;</div><div class="line">        &#125; else &#123;</div><div class="line">            // We&apos;re on the child side of fork(), facing a class that</div><div class="line">            // was initializing by some other thread when fork() was called.</div><div class="line">            _setThisThreadIsInitializingClass(cls);</div><div class="line">            performForkChildInitialize(cls, supercls);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    else if (cls-&gt;isInitialized()) &#123;</div><div class="line">        // Set CLS_INITIALIZING failed because someone else already </div><div class="line">        //   initialized the class. Continue normally.</div><div class="line">        // NOTE this check must come AFTER the ISINITIALIZING case.</div><div class="line">        // Otherwise: Another thread is initializing this class. ISINITIALIZED </div><div class="line">        //   is false. Skip this clause. Then the other thread finishes </div><div class="line">        //   initialization and sets INITIALIZING=no and INITIALIZED=yes. </div><div class="line">        //   Skip the ISINITIALIZING clause. Die horribly.</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    else &#123;</div><div class="line">        // We shouldn&apos;t be here. </div><div class="line">        _objc_fatal(&quot;thread-safe class init in objc runtime is buggy!&quot;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看出来，和<code>+load</code>方法一样，先父类后子类。然后赋值<code>reallyInitialize = YES;</code>，后边使用<code>try</code>主动调用<code>callInitialize(cls);</code>，来到<code>callInitialize(cls);</code>内部：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">void callInitialize(Class cls)</div><div class="line">&#123;</div><div class="line">    ((void(*)(Class, SEL))objc_msgSend)(cls, SEL_initialize);</div><div class="line">    asm(&quot;&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到最终还是使用<code>((void(*)(Class, SEL))objc_msgSend)(cls, SEL_initialize)</code>主动调用了该函数。</p>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><p><code>+initialize</code>和<code>+load</code>的很大区别是，<code>+initialize</code>是通过<code>objc_msgSend</code>进行调用的，所以有以下特点<br>如果子类没有实现<code>+initialize</code>，会调用父类的<code>+initialize</code>（所以父类的<code>+initialize</code>可能会被调用多次）<br>如果分类实现了<code>+initialize</code>，就覆盖类本身的<code>+initialize</code>调用</p>
<p>用伪代码实现以下思路：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">if(class 没有初始化)&#123;</div><div class="line">    父类初始化</div><div class="line">    子类初始化</div><div class="line">    调用initialize</div><div class="line">&#125;</div><div class="line">如果子类没有实现initialize，则去调用父类initialize。</div></pre></td></tr></table></figure>
<p>至于子类没有实现的话是直接调用父类的<code>initialize</code>，是使用<code>objc-msgsend</code>的原因。</p>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">@interface FYPerson : NSObject</div><div class="line"></div><div class="line">@end</div><div class="line">+(void)initialize&#123;</div><div class="line">	printf(&quot;\n%s&quot;,__func__);</div><div class="line"></div><div class="line">&#125;</div><div class="line">+(void)load&#123;</div><div class="line">	printf(&quot;\n%s&quot;,__func__);</div><div class="line"></div><div class="line">&#125;</div><div class="line">@interface FYPerson (test1)</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">+(void)initialize&#123;</div><div class="line">	printf(&quot;\n%s&quot;,__func__);</div><div class="line"></div><div class="line">&#125;</div><div class="line">+(void)load&#123;</div><div class="line">	printf(&quot;\n%s&quot;,__func__);</div><div class="line"></div><div class="line">&#125;</div><div class="line">//输出</div><div class="line">+[FYPerson load]</div><div class="line">+[FYPerson(test2) load]</div><div class="line">+[FYPerson(test1) load]</div></pre></td></tr></table></figure>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li><code>+load</code>是根据函数地址直接调用，<code>initialize</code>是通过<code>objc_msgSend</code>调用</li>
<li><code>+load</code>是runtime加载类、分类时候调用（只会调用一次）</li>
<li><code>initialize</code>是第一次接受消息的时候调用，每个类只会调用一次（子类没实现，父类可能被调用多次）</li>
<li><code>+load</code>调用优先于<code>initialize</code>,子类调用<code>+load</code>之前会调用父类的<code>+load</code>，再调用分类的<code>+load</code>,分类之间先编译，先调用。</li>
<li><code>initialize</code>先初始化父类，再初始化子类（可能最终调用父类的<code>initialize</code>）</li>
</ul>
<h3 id="关联对象本质"><a href="#关联对象本质" class="headerlink" title="关联对象本质"></a>关联对象本质</h3><h4 id="关联对象的本质-结构体"><a href="#关联对象的本质-结构体" class="headerlink" title="关联对象的本质-结构体"></a>关联对象的本质-结构体</h4><p>继承<code>NSObject</code>是可以可以直接使用<code>@property (nonatomic,assign) int age;</code>，但是在<code>Category</code>中会报错，那么怎么实现和继承基类一样的效果呢？<br>我们查看<code>Category</code>结构体</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">  struct _category_t &#123;</div><div class="line">	const char *name; //&quot;FYPerson&quot;</div><div class="line">	struct _class_t *cls;</div><div class="line">	const struct _method_list_t *instance_methods;</div><div class="line">	const struct _method_list_t *class_methods;</div><div class="line">	const struct _protocol_list_t *protocols;</div><div class="line">	const struct _prop_list_t *properties;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>其中<code>const struct _prop_list_t *properties;</code>是存储属性的，但是缺少成员变量，而我们也不能主动在<code>_category_t</code>插入<code>ivar</code>，那么我们可以使用<code>objc_setAssociatedObject</code>将属性的值存储全局的<code>AssociationsHashMap</code>中，使用的时候<code>objc_getAssociatedObject(id object, const void *key)</code>,不使用的时候删除使用<code>objc_removeAssociatedObjects</code>删除。</p>
<p>我们进入到<code>objc_setAssociatedObject</code>内部,<code>objc-references.mm</code>275行</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">void _object_set_associative_reference(id object, void *key, id value, uintptr_t policy) &#123;</div><div class="line">    // retain the new value (if any) outside the lock.</div><div class="line">    ObjcAssociation old_association(0, nil);</div><div class="line">	//根据key value 处理</div><div class="line">    id new_value = value ? acquireValue(value, policy) : nil;</div><div class="line">    &#123;</div><div class="line">        AssociationsManager manager;</div><div class="line">		//生成一个全局的 HashMap</div><div class="line">        AssociationsHashMap &amp;associations(manager.associations());</div><div class="line">        disguised_ptr_t disguised_object = DISGUISE(object);</div><div class="line">		//有value 就处理</div><div class="line">        if (new_value) &#123;</div><div class="line">            // break any existing association.</div><div class="line">//			遍历 hashMap是否有该obj</div><div class="line">            AssociationsHashMap::iterator i = associations.find(disguised_object);</div><div class="line">            if (i != associations.end()) &#123;</div><div class="line">                // secondary table exists</div><div class="line">				//有的话 更新其 value</div><div class="line">                ObjectAssociationMap *refs = i-&gt;second;</div><div class="line">                ObjectAssociationMap::iterator j = refs-&gt;find(key);</div><div class="line">                if (j != refs-&gt;end()) &#123;</div><div class="line">                    old_association = j-&gt;second;</div><div class="line">                    j-&gt;second = ObjcAssociation(policy, new_value);</div><div class="line">                &#125; else &#123;</div><div class="line">                    (*refs)[key] = ObjcAssociation(policy, new_value);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                // create the new association (first time).</div><div class="line">				//没有的话 赋值给 refs</div><div class="line">                ObjectAssociationMap *refs = new ObjectAssociationMap;</div><div class="line">                associations[disguised_object] = refs;</div><div class="line">                (*refs)[key] = ObjcAssociation(policy, new_value);</div><div class="line">                object-&gt;setHasAssociatedObjects();</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            // setting the association to nil breaks the association.</div><div class="line">            AssociationsHashMap::iterator i = associations.find(disguised_object);</div><div class="line">            if (i !=  associations.end()) &#123;</div><div class="line">                ObjectAssociationMap *refs = i-&gt;second;</div><div class="line">                ObjectAssociationMap::iterator j = refs-&gt;find(key);</div><div class="line">                if (j != refs-&gt;end()) &#123;</div><div class="line">                    old_association = j-&gt;second;</div><div class="line">                    //删除refs </div><div class="line">                    refs-&gt;erase(j);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    // release the old value (outside of the lock).</div><div class="line">    if (old_association.hasValue()) ReleaseValue()(old_association);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过该函数我们了解到</p>
<ul>
<li>关联对象并不是存储在关联对象的本身内存中</li>
<li>关联对象是存储在全局统一的<code>AssociationsManager</code>管理的<code>AssociationsHashMap</code>中</li>
<li>传入value =nil，会移除该关联对线<br><code>AssociationsManager</code>其实是管理了已<code>key为id object</code>对应的<code>AssociationsHashMap</code>，<code>AssociationsHashMap</code>存储了<code>key</code>对应的<code>ObjcAssociation</code>，<code>ObjcAssociation</code>是存储了<code>value</code> 和<code>policy</code>，<code>ObjcAssociation</code>的数据结构如下：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">class ObjcAssociation &#123;</div><div class="line">        uintptr_t _policy;</div><div class="line">        id _value;</div><div class="line">        *****</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<p>具体抽象关系见下图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">AssociationsManager --&gt; AssociationsHashMap --&gt; ObjectAssociationMap</div><div class="line">--&gt;void * ObjectAssociation --&gt;uintprt_t _policy ,id _value;</div></pre></td></tr></table></figure>
<p>简单来讲就是一个全局变量保存了以<code>class</code>为<code>key</code>对应的<code>AssociationsHashMap</code>，这个<code>AssociationsHashMap</code>存储了一个<code>key</code>对应的<code>ObjectAssociation</code>，<code>ObjectAssociation</code>包含了<code>value</code>和<code>_policy</code>。通过2层map保存了数据。</p>
<h4 id="关联对象的使用"><a href="#关联对象的使用" class="headerlink" title="关联对象的使用"></a>关联对象的使用</h4><table>
<thead>
<tr>
<th>objc_setAssociatedObject</th>
<th>obj,key,value,policy</th>
</tr>
</thead>
<tbody>
<tr>
<td>objc_getAssociatedObject</td>
<td>根据 obj 和 key获取值</td>
</tr>
<tr>
<td>void objc_removeAssociatedObjects(id object)</td>
<td>根据obj 删除关联函数</td>
</tr>
</tbody>
</table>
<p><code>objc_AssociationPolicy</code>的类型：</p>
<table>
<thead>
<tr>
<th>OBJC_ASSOCIATION_ASSIGN</th>
<th>weak 引用</th>
</tr>
</thead>
<tbody>
<tr>
<td>OBJC_ASSOCIATION_RETAIN_NONATOMIC</td>
<td>非原子强引用</td>
</tr>
<tr>
<td>OBJC_ASSOCIATION_COPY_NONATOMIC</td>
<td>非原子相当于copy</td>
</tr>
<tr>
<td>OBJC_ASSOCIATION_RETAIN</td>
<td>强引用</td>
</tr>
<tr>
<td>OBJC_ASSOCIATION_COPY</td>
<td>原子操作，相当于copy</td>
</tr>
</tbody>
</table>
<h4 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">@interface NSObject (test)</div><div class="line">@property (nonatomic,assign) NSString * name;</div><div class="line">@end</div><div class="line"></div><div class="line">#import &quot;NSObject+test.h&quot;</div><div class="line">#import &quot;objc/runtime.h&quot;</div><div class="line">@implementation NSObject (test)</div><div class="line">-(void)setName:(NSString *)name&#123;</div><div class="line">	objc_setAssociatedObject(self, @selector(name), name, OBJC_ASSOCIATION_COPY);</div><div class="line">&#125;</div><div class="line">- (NSString *)name&#123;</div><div class="line">	return  objc_getAssociatedObject(self, @selector(name));</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">NSObject *obj =[[NSObject alloc]init];</div><div class="line">obj.name = @&quot;老弟来了&quot;;</div><div class="line">printf(&quot;%s&quot;,obj.name.UTF8String);</div><div class="line">//老弟来了</div></pre></td></tr></table></figure>
<p>这段代码我们实现了给基类添加一个成员变量<code>name</code>，然后又成功取出了值，标示我们做新增的保存成员变量的值是对的。</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><ul>
<li>Category <code>+load</code>在冷启动时候执行，执行顺序和编译顺序成弱相关，先父类，后子类，而且每个类执行一次，执行是直接调用函数地址。</li>
<li>Category <code>+initialize</code>在第一次接受消息执行，先父类，后子类，子类没实现，会调用父类，利用<code>objc-msgsend</code>机制调用。</li>
<li>Category 可以利用<code>Associative</code>添加和读取属性的值</li>
</ul>
<h4 id="资料下载"><a href="#资料下载" class="headerlink" title="资料下载"></a>资料下载</h4><ul>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="external">学习资料下载</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="external">demo code</a></li>
<li><p><a href="https://github.com/ifgyong/demo/tree/master/OC/objc4-750" target="_blank" rel="external">runtime可运行的源码</a></p>
<p>本文章之所以图片比较少，我觉得还是跟着代码敲一遍，印象比较深刻。</p>
<hr>
<p>最怕一生碌碌无为，还安慰自己平凡可贵。</p>
<p>广告时间</p>
</li>
</ul>
<p><img src="../images/0.png" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOS底层原理 KVO和KVC本质与联系 --(3)/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="兜兜转转"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兜兜转转的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/01/iOS底层原理 KVO和KVC本质与联系 --(3)/" class="post-title-link" itemprop="url">iOS底层原理  KVO和KVC本质与联系 --(3)</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-12-01 11:13:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:13:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-12-03 13:01:39" itemprop="dateModified" datetime="2019-12-03T13:01:39+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我们知道实例实际是存储了成员变量的值和指向类的<code>isa</code>指针，<code>class</code>对象和<code>meta-class</code>对象包含 <code>isa</code>、<code>superclass</code>和<code>class_rw_t</code>这几种结构体，只是数据不一样，<code>isa</code>需要<code>ISA_MASK</code>&amp;之后才是真正的值。那么今天我们在看一下Key-Value Observing的本质。</p>
<h3 id="KVO本质"><a href="#KVO本质" class="headerlink" title="KVO本质"></a>KVO本质</h3><p> 首先需要了解KVO基本使用，KVO的全称 Key-Value Observing，俗称“键值监听”，可以用于监听某个对象属性值的改变。下面我们展示一下KVO的基本使用。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"> </div><div class="line"> #import &lt;Foundation/Foundation.h&gt;</div><div class="line"></div><div class="line">NS_ASSUME_NONNULL_BEGIN</div><div class="line"></div><div class="line">@interface FYPerson : NSObject</div><div class="line"></div><div class="line">@property (nonatomic,assign) NSInteger age;</div><div class="line">@end</div><div class="line"></div><div class="line">NS_ASSUME_NONNULL_END</div><div class="line"></div><div class="line">#import &quot;ViewController.h&quot;</div><div class="line">#import &quot;FYPerson.h&quot;</div><div class="line"></div><div class="line">@interface ViewController ()</div><div class="line">@property (nonatomic,strong)FYPerson *person;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation ViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">	[super viewDidLoad];</div><div class="line">	// Do any additional setup after loading the view.</div><div class="line">	self.person=[FYPerson new];</div><div class="line">	self.person.age = 10;</div><div class="line">	[self.person addObserver:self</div><div class="line">    			  forKeyPath:@&quot;age&quot;</div><div class="line">    				 options:NSKeyValueObservingOptionNew</div><div class="line">    				 context:nil];</div><div class="line">&#125;</div><div class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</div><div class="line">	self.person.age += 1;</div><div class="line">&#125;</div><div class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context&#123;</div><div class="line">	NSLog(@&quot;监听到了age变化： %@&quot;,change);</div><div class="line">&#125;</div><div class="line">-(void)dealloc&#123;</div><div class="line">	[self.person removeObserver:self forKeyPath:@&quot;age&quot;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">//下边是输出结果</div><div class="line">监听到了age变化： &#123;</div><div class="line">    kind = 1;</div><div class="line">    new = 12;</div><div class="line">    old = 11;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 从上述代码可以看出，添加监听之后，当值改变时，会触发函数<code>observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context</code>。</p>
<h4 id="触发条件"><a href="#触发条件" class="headerlink" title="触发条件"></a>触发条件</h4> <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"> - (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</div><div class="line">//	self.person.age += 1;</div><div class="line">	[self.person willChangeValueForKey:@&quot;age&quot;];</div><div class="line">	[self.person didChangeValueForKey:@&quot;age&quot;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> 当把<code>age</code>具体值的改变，变成手动调用<code>willChangeValueForKey</code>和<code>didChangeValueForKey</code>的时候，结果如下：</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">  监听到了age变化： &#123;</div><div class="line">    kind = 1;</div><div class="line">    new = 10;</div><div class="line">    old = 10;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p> <code>new</code>和<code>old</code>的值竟然一样，经测试只有同时先后调用<code>willChangeValueForKey</code>和<code>didChangeValueForKey</code>，会触发回调函数<code>observeValueForKeyPath</code>，由此可知触发条件是<code>willChangeValueForKey</code>和<code>didChangeValueForKey</code>配合使用。</p>
<h4 id="探寻KVO底层实现原理"><a href="#探寻KVO底层实现原理" class="headerlink" title="探寻KVO底层实现原理"></a>探寻KVO底层实现原理</h4><p>通过上述代码我们发现，一旦age属性的值发生改变时，就会通知到监听者，并且我们知道赋值操作都是调用 set方法，我们可以来到Person类中重写age的set方法，观察是否是KVO在set方法内部做了一些操作来通知监听者。<br>我们发现即使重写了set方法，p1对象和p2对象调用同样的set方法，但是我们发现p1除了调用set方法之外还会另外执行监听器的observeValueForKeyPath方法。<br>说明KVO在运行时获取对p1对象做了一些改变。相当于在程序运行过程中，对p1对象做了一些变化，使得p1对象在调用setage方法的时候可能做了一些额外的操作，所以问题出在对象身上，两个对象在内存中肯定不一样，两个对象可能本质上并不一样。接下来来探索KVO内部是怎么实现的。<br>KVO底层实现分析<br>首先我们对上述代码中添加监听的地方打断点，看观察一下，addObserver方法对p1对象做了什么处理？也就是说p1对象在经过addObserver方法之后发生了什么改变，我们通过打印isa指针：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">@interface ViewController ()</div><div class="line">@property (nonatomic,strong)FYPerson *person;</div><div class="line">@property (nonatomic,strong)FYPerson *person2;</div><div class="line">@end</div><div class="line"></div><div class="line">@implementation ViewController</div><div class="line"></div><div class="line">- (void)viewDidLoad &#123;</div><div class="line">	[super viewDidLoad];</div><div class="line">	// Do any additional setup after loading the view.</div><div class="line">	self.person=[FYPerson new];</div><div class="line">	self.person2 =[FYPerson new];</div><div class="line">	self.person.age = 10;</div><div class="line">	[self.person addObserver:self</div><div class="line">					  forKeyPath:@&quot;age&quot;</div><div class="line">						 options:NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld</div><div class="line">						 context:nil];</div><div class="line"> Class superclass = NSStringFromClass( class_getSuperclass(NSClassFromString(@&quot;NSKVONotifying_FYPerson&quot;)));</div><div class="line">Class NSKVONotifying_FYPerson = objc_getClass(&quot;NSKVONotifying_FYPerson&quot;);</div><div class="line">    fy_objc_class* NSKVONotifying_FYPerson_class = (__bridge fy_objc_class *)NSKVONotifying_FYPerson;</div><div class="line">						 //此处打断点</div><div class="line"></div><div class="line">//p 命令输出isa指针 </div><div class="line">(lldb) p self.person2-&gt;isa</div><div class="line">(Class) $0 = FYPerson</div><div class="line">(lldb) p self.person-&gt;isa</div><div class="line">(Class) $1 = NSKVONotifying_FYPerson</div><div class="line"></div><div class="line">(lldb) p superclass</div><div class="line">(Class) $0 = FYPerson</div><div class="line"></div><div class="line">(lldb) p NSKVONotifying_FYPerson_class-&gt;superclass</div><div class="line">(Class) $4 = FYPerson</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从输出的isa指针看来，经过<code>【person addObserver】</code>之后，<code>person</code>的<code>isa</code>指针指向了<code>NSKVONotifying_FYPerson</code>,而<code>person2</code>的<code>isa</code>是<code>FYPerson</code>，可以看出系统是对<code>instance</code>对象的<code>isa</code>进行了赋值操作。通过<code>p NSKVONotifying_FYPerson_class-&gt;superclass==FYPerson</code>可以看出isa是指向了子类，那么子类<code>NSKVONotifying_FYPerson</code>到底做了那些事情呢？</p>
<p>看下边代码查看函数isa改变过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">	self.person=[FYPerson new];</div><div class="line">	self.person2 =[FYPerson new];</div><div class="line">	self.person.age = 10;</div><div class="line">//打断点 输出 po [_person methodForSelector:@selector(setAge:)]</div><div class="line">	[self.person addObserver:self</div><div class="line">					  forKeyPath:@&quot;age&quot;</div><div class="line">						 options:NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld</div><div class="line">						 context:nil];</div><div class="line">//打断点 输出 po [_person methodForSelector:@selector(setAge:)]</div><div class="line"></div><div class="line">(lldb) po [_person methodForSelector:@selector(setAge:)]</div><div class="line">0x000000010666b720</div><div class="line"></div><div class="line">(lldb) po [_person methodForSelector:@selector(setAge:)]</div><div class="line">0x00000001069c63d2</div><div class="line"></div><div class="line">//查看IMP指针对应地址和内容</div><div class="line">(lldb) p (IMP)0x000000010666b720</div><div class="line">(IMP) $2 = 0x000000010666b720 (day03-KVO本质`::-[FYPerson setAge:](int) at FYPerson.h:14)</div><div class="line">(lldb) p (IMP)0x00000001069c63d2</div><div class="line">(IMP) $3 = 0x00000001069c63d2 (Foundation`_NSSetIntValueAndNotify)</div></pre></td></tr></table></figure>
<p>可以看出来两次的函数地址不一致，添加KVO之前是<code>[FYPerson setAge:]</code>,添加之后是<code>(Foundation_NSSetIntValueAndNotify)</code>。我们将<code>age</code>的类型改成<code>double</code>，再看一下结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">(lldb) po [_person methodForSelector:@selector(setAge:)]</div><div class="line">0x00000001080c4710</div><div class="line"></div><div class="line">(lldb) po [_person methodForSelector:@selector(setAge:)]</div><div class="line">0x000000010841f18c</div><div class="line"></div><div class="line">(lldb) p (IMP)0x00000001080c4710</div><div class="line">(IMP) $2 = 0x00000001080c4710 (day03-KVO本质`::-[FYPerson setAge:](double) at FYPerson.h:14)</div><div class="line">(lldb) p (IMP)0x000000010841f18c</div><div class="line">(IMP) $3 = 0x000000010841f18c (Foundation`_NSSetDoubleValueAndNotify)</div></pre></td></tr></table></figure>
<p><code>age</code>是<code>int</code>的时候添加之后是<code>Foundation _NSSetIntValueAndNotify</code>,改成<code>double</code>之后，是<code>Foundation _NSSetDoubleValueAndNotify</code>。那么我们可以推测<code>Foundation</code>框架中还有很多例如<code>_NSSetBoolValueAndNotify、_NSSetCharValueAndNotify、_NSSetFloatValueAndNotify、_NSSetLongValueAndNotify</code>等等函数。<br>运行<code>nm Foundation | grep ValueAndNotify</code>结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">nm Foundation  | grep ValueAndNotify</div><div class="line">__NSSetBoolValueAndNotify</div><div class="line">__NSSetCharValueAndNotify</div><div class="line">__NSSetDoubleValueAndNotify</div><div class="line">__NSSetFloatValueAndNotify</div><div class="line">__NSSetIntValueAndNotify</div><div class="line">__NSSetLongLongValueAndNotify</div><div class="line">__NSSetLongValueAndNotify</div><div class="line">__NSSetObjectValueAndNotify</div><div class="line">__NSSetPointValueAndNotify</div><div class="line">__NSSetRangeValueAndNotify</div><div class="line">__NSSetRectValueAndNotify</div><div class="line">__NSSetShortValueAndNotify</div><div class="line">__NSSetSizeValueAndNotify</div></pre></td></tr></table></figure>
<h4 id="另外一种验证方法"><a href="#另外一种验证方法" class="headerlink" title="另外一种验证方法"></a>另外一种验证方法</h4><p>在macOS中可以使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//开始记录日志</div><div class="line">instrumentObjcMessageSends(YES);</div><div class="line">    // Do stuff...</div><div class="line">instrumentObjcMessageSends(NO);//结束记录日志</div></pre></td></tr></table></figure>
<p>如果将<code>NSObjCMessageLoggingEnabled</code>环境变量设置为<code>YES</code>，则<code>Objective-C</code>运行时会将所有已分派的<code>Objective-C</code>消息记录到名为<code>/tmp/msgSends-&lt;pid&gt;</code>的文件中。每一次运行会生成一个文件，我们进入到该文件内部：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div></pre></td><td class="code"><pre><div class="line">//初始化</div><div class="line">+ FYPerson NSObject initialize</div><div class="line">+ FYPerson NSObject new</div><div class="line">- FYPerson NSObject init</div><div class="line">- FYPerson NSObject addObserver:forKeyPath:options:context:</div><div class="line">- FYPerson NSObject _isKVOA</div><div class="line"></div><div class="line">****</div><div class="line"></div><div class="line"></div><div class="line">//子类设置age [NSKVONotifying_FYPerson setAge:]</div><div class="line"></div><div class="line">- NSKVONotifying_FYPerson NSKVONotifying_FYPerson setAge:</div><div class="line">- NSKVONotifying_FYPerson NSObject _changeValueForKey:key:key:usingBlock:</div><div class="line">- NSKVONotifying_FYPerson NSObject _changeValueForKeys:count:maybeOldValuesDict:maybeNewValuesDict:usingBlock:</div><div class="line"></div><div class="line">- NSKeyValueUnnestedProperty NSKeyValueUnnestedProperty keyPathIfAffectedByValueForKey:exactMatch:</div><div class="line">- NSKeyValueUnnestedProperty NSKeyValueUnnestedProperty _keyPathIfAffectedByValueForKey:exactMatch:</div><div class="line"></div><div class="line">//will changeValueForKey</div><div class="line">- NSKeyValueUnnestedProperty NSKeyValueUnnestedProperty object:withObservance:willChangeValueForKeyOrKeys:recurse:forwardingValues:</div><div class="line"> </div><div class="line">//FYPerson 设置age</div><div class="line">- FYPerson FYPerson setAge:</div><div class="line"></div><div class="line">// didChangeValueForKeyOrKeys</div><div class="line">- NSKeyValueUnnestedProperty NSKeyValueUnnestedProperty object:withObservance:didChangeValueForKeyOrKeys:recurse:forwardingValues:</div><div class="line">- NSKeyValueUnnestedProperty NSKeyValueProperty keyPath</div><div class="line"></div><div class="line">//找到key 发送 具体的key对应的value 到observe</div><div class="line"></div><div class="line">- NSKVONotifying_FYPerson NSObject valueForKeyPath:</div><div class="line"></div><div class="line">- NSKVONotifying_FYPerson NSObject valueForKey:</div><div class="line">+ NSKVONotifying_FYPerson NSObject _createValueGetterWithContainerClassID:key:</div><div class="line">-</div><div class="line">+ NSKVONotifying_FYPerson NSObject resolveInstanceMethod:</div><div class="line">+ NSKVONotifying_FYPerson NSObject resolveInstanceMethod:</div><div class="line">- NSKVONotifying_FYPerson FYPerson age</div><div class="line">+ NSKeyValueMethodGetter NSObject alloc</div><div class="line">- NSKeyValueMethodGetter NSKeyValueMethodGetter initWithContainerClassID:key:method:</div><div class="line">- NSKeyValueGetter NSKeyValueAccessor initWithContainerClassID:key:implementation:selector:extraArguments:count:</div><div class="line"></div><div class="line"></div><div class="line">- NSKVONotifying_FYPerson NSObject respondsToSelector:</div><div class="line">- NSKVONotifying_FYPerson NSKVONotifying_FYPerson class</div><div class="line">- NSKVONotifying_FYPerson NSKVONotifying_FYPerson _isKVOA</div><div class="line">+ FYPerson NSObject class</div><div class="line">+ FYPerson NSObject resolveInstanceMethod:</div><div class="line">+ FYPerson NSObject resolveInstanceMethod:</div><div class="line"></div><div class="line">//数据字典</div><div class="line">+ NSDictionary NSObject self</div><div class="line">+ NSMutableDictionary NSObject self</div><div class="line">- NSKeyValueChangeDictionary NSKeyValueChangeDictionary initWithDetailsNoCopy:originalObservable:isPriorNotification:</div><div class="line">- NSDictionary NSObject init</div><div class="line"></div><div class="line">// 执行观察者回调函数</div><div class="line">- NSKVONotifying_FYPerson FYPerson observeValueForKeyPath:ofObject:change:context:</div><div class="line"></div><div class="line"></div><div class="line">+ Student NSObject alloc</div><div class="line">- Student NSObject init</div><div class="line">- Student NSObject dealloc</div><div class="line"></div><div class="line"></div><div class="line">***//省略一部分代码</div><div class="line"> NSKVONotifying_FYPerson NSObject release</div><div class="line">- NSKeyValueChangeDictionary NSObject release</div><div class="line">- NSKeyValueChangeDictionary NSKeyValueChangeDictionary dealloc</div><div class="line">- NSDictionary NSObject dealloc</div><div class="line">- NSKeyValueObservationInfo NSObject release</div><div class="line">- NSKVONotifying_FYPerson NSObject release</div></pre></td></tr></table></figure>
<p>经过仔细把重要的函数过滤出来，我们可以了解到<code>person.age = 12</code>的执行过程是<code>NSKVONotifying_FYPerson setAge:</code>-&gt;<code>NSKeyValueUnnestedProperty object:withObservance:willChangeValueForKeyOrKeys:recurse:forwardingValues</code>-&gt;<code>FYPerson FYPerson setAge:</code>-&gt;<code>NSKeyValueUnnestedProperty NSKeyValueUnnestedProperty object:withObservance:didChangeValueForKeyOrKeys:recurse:forwardingValues:</code>-&gt;<code>NSKVONotifying_FYPerson NSObject valueForKeyPath:</code>-&gt;<code>NSMutableDictionary NSObject self</code>-&gt;<code>- NSKVONotifying_FYPerson FYPerson observeValueForKeyPath:ofObject:change:context:</code>，我们来用伪代码实现一遍：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">//person.age = 12</div><div class="line">[NSKVONotifying_FYPerson setAge:12];</div><div class="line">willChangeValueForKey@&quot;age&quot;;</div><div class="line">[FYPerson setAge:12];</div><div class="line">didChangeValueForKey@&quot;age&quot;;</div><div class="line">[[NSMutableDictionary alloc] init];</div><div class="line">[NSKVONotifying_FYPerson observeValueForKeyPath:ofObject:change:context];</div></pre></td></tr></table></figure>
<p>NSKVONotifyin_Person内部结构是怎样的？<br>首先我们知道，NSKVONotifyin_Person作为Person的子类，其superclass指针指向Person类，并且NSKVONotifyin_Person内部一定对setAge方法做了单独的实现，那么NSKVONotifyin_Person同Person类的差别可能就在于其内存储的对象方法及实现不同。<br>我们通过runtime分别打印Person类对象和NSKVONotifyin_Person类对象内存储的对象方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">- (void)viewDidLoad &#123;</div><div class="line">    [super viewDidLoad];</div><div class="line"></div><div class="line">    Person *p1 = [[Person alloc] init];</div><div class="line">    p1.age = 1.0;</div><div class="line">    Person *p2 = [[Person alloc] init];</div><div class="line">    p1.age = 2.0;</div><div class="line">    // self 监听 p1的 age属性</div><div class="line">    NSKeyValueObservingOptions options = NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld;</div><div class="line">    [p1 addObserver:self forKeyPath:@&quot;age&quot; options:options context:nil];</div><div class="line"></div><div class="line">    [self printMethods: object_getClass(p2)];</div><div class="line">    [self printMethods: object_getClass(p1)];</div><div class="line"></div><div class="line">    [p1 removeObserver:self forKeyPath:@&quot;age&quot;];</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void) printMethods:(Class)cls</div><div class="line">&#123;</div><div class="line">    unsigned int count ;</div><div class="line">    Method *methods = class_copyMethodList(cls, &amp;count);</div><div class="line">    NSMutableString *methodNames = [NSMutableString string];</div><div class="line">    [methodNames appendFormat:@&quot;%@ - &quot;, cls];</div><div class="line">    </div><div class="line">    for (int i = 0 ; i &lt; count; i++) &#123;</div><div class="line">        Method method = methods[i];</div><div class="line">        NSString *methodName  = NSStringFromSelector(method_getName(method));</div><div class="line">        </div><div class="line">        [methodNames appendString: methodName];</div><div class="line">        [methodNames appendString:@&quot; &quot;];</div><div class="line">        </div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSLog(@&quot;%@&quot;,methodNames);</div><div class="line">    free(methods);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//结果如下：</div><div class="line">NSKVONotifying_FYPerson - setAge: class dealloc _isKVOA</div><div class="line">FYPerson - setAge: age</div></pre></td></tr></table></figure>
<p> 通过上述代码我们发现NSKVONotifyin_Person中有4个对象方法。分别为setAge: class dealloc _isKVOA，那么至此我们可以画出NSKVONotifyin_Person的内存结构以及方法调用顺序。</p>
<p><img src="../images/3-1.png" alt=""></p>
<p>这里NSKVONotifyin_Person重写class方法是为了隐藏NSKVONotifyin_Person。不被外界所看到。我们在p1添加过KVO监听之后，分别打印p1和p2对象的class可以发现他们都返回Person。</p>
<p>如果NSKVONotifyin_Person不重写class方法，那么当对象要调用class对象方法的时候就会一直向上找来到nsobject，而nsobect的class的实现大致为返回自己isa指向的类，返回p1的isa指向的类那么打印出来的类就是NSKVONotifyin_Person，但是apple不希望将NSKVONotifyin_Person类暴露出来，并且不希望我们知道NSKVONotifyin_Person内部实现，所以在内部重写了class类，直接返回Person类，所以外界在调用p1的class对象方法时，是Person类。这样p1给外界的感觉p1还是Person类，并不知道NSKVONotifyin_Person子类的存在。</p>
<p>那么我们可以猜测NSKVONotifyin_Person内重写的class内部实现大致为</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (Class) class &#123;</div><div class="line">     // 得到类对象，在找到类对象父类</div><div class="line">     return class_getSuperclass(object_getClass(self));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>最后自己写代码验证一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@implementation FYPerson</div><div class="line">-(void)willChangeValueForKey:(NSString *)key&#123;</div><div class="line">	NSLog(@&quot;%s 开始&quot;,__func__);</div><div class="line">	[super didChangeValueForKey:key];</div><div class="line">	NSLog(@&quot;%s 结束&quot;,__func__);</div><div class="line">&#125;</div><div class="line">- (void)didChangeValueForKey:(NSString *)key&#123;</div><div class="line">	NSLog(@&quot;%s 开始&quot;,__func__);</div><div class="line">	[super didChangeValueForKey:key];</div><div class="line">	NSLog(@&quot;%s 结束&quot;,__func__);</div><div class="line">&#125;</div><div class="line">- (void)setAge:(double)age&#123;</div><div class="line">	_age = age;</div><div class="line">	NSLog(@&quot;%s&quot;,__func__);</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>执行之后结果如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">-[FYPerson willChangeValueForKey:] 开始</div><div class="line">-[FYPerson willChangeValueForKey:] 结束</div><div class="line">-[FYPerson setAge:]</div><div class="line">-[FYPerson didChangeValueForKey:] 开始</div><div class="line"> 监听到了age变化： &#123;</div><div class="line">    kind = 1;</div><div class="line">    new = 11;</div><div class="line">    old = 10;</div><div class="line">&#125;</div><div class="line">-[FYPerson didChangeValueForKey:] 结束</div></pre></td></tr></table></figure>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>KVO其实是一个通过runtime注册建立子类，通过修改instance的isa指针，指向新的子类，重写instace的class方法来掩盖，子类拥有自己的set方法，调用顺序是willChangeValueForKey方法、原来的setter方法实现、didChangeValueForKey方法，而didChangeValueForKey方法内部又会调用监听器的observeValueForKeyPath:ofObject:change:context:监听方法。</p>
<h3 id="KVC的本质"><a href="#KVC的本质" class="headerlink" title="KVC的本质"></a>KVC的本质</h3><p>KVC的全称是Key-Value Coding，俗称“键值编码”，可以通过一个key来访问某个属性。<br>常用的API有</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">- (void)setValue:(id)value forKeyPath:(NSString *)keyPath;</div><div class="line">- (void)setValue:(id)value forKey:(NSString *)key;</div><div class="line">- (id)valueForKeyPath:(NSString *)keyPath;</div><div class="line">- (id)valueForKey:(NSString *)key;</div></pre></td></tr></table></figure>
<p>其实当Obj调用<code>(void)setValue:(id)value forKey:(NSString *)key</code>的时候，<code>obj</code>会主动寻找方法<code>setKey</code>和<code>_setKey</code>两个方法，没有找到这两个方法会再去寻找<code>accessInstanceVariablesDirectly</code>，返回值为<code>NO</code>则抛出异常，返回<code>YES</code>则去按照<code>_key</code>、<code>_isKey</code>、<code>key</code>、<code>isKey</code>的查找优先级查找成员变量，找到之后直接复制，否则抛出异常。<br>我们使用这段代码来验证：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">@interface FYPerson()&#123;</div><div class="line">&#125;</div><div class="line">@end</div><div class="line">@implementation FYPerson</div><div class="line">//code1</div><div class="line">- (void)setAge:(NSInteger)age&#123;</div><div class="line">	NSLog(@&quot;%s %ld&quot;,__func__,(long)age);</div><div class="line">&#125;</div><div class="line">//code2</div><div class="line">- (void)_setAge:(NSInteger)age&#123;</div><div class="line">	NSLog(@&quot;%s %ld&quot;,__func__,(long)age);</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line">FYPerson *p=[[FYPerson alloc]init];</div><div class="line">[p setValue:@(2) forKey:@&quot;age&quot;];</div></pre></td></tr></table></figure>
<p>当执行<code>code1</code>和<code>code2</code>都有的时候，输出<code>-[FYPerson setAge:] 2</code>，当<code>code1</code>注释掉，输出<code>-[FYPerson _setAge:] 2</code>，可以看出执行顺序是<code>setAge</code>，没有<code>setAge</code>的时候再去执行<code>_setAge</code>。</p>
<p>现在新增<code>FYPerson</code>4个成员变量，依次注释掉他们来测试寻找成员变量的顺序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">@interface FYPerson : NSObject</div><div class="line">&#123;</div><div class="line">@public</div><div class="line">	NSInteger _age;</div><div class="line">	NSInteger _isAge;</div><div class="line">	NSInteger age;</div><div class="line">	NSInteger isAge;</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">FYPerson *p=[[FYPerson alloc]init];</div><div class="line">[p setValue:@(2) forKey:@&quot;age&quot;];</div><div class="line"></div><div class="line">NSLog(@&quot;age:%d _age:%d isAge:%d _isAge:%d&quot;,(int)p-&gt;age,(int)p-&gt;_age,(int)p-&gt;isAge,(int)p-&gt;_isAge);</div></pre></td></tr></table></figure></p>
<ul>
<li>没注释输出 <code>age:0 _age:2 isAge:0 _isAge:0</code></li>
<li>注释<code>_age</code>输出 <code>age:0 isAge:0 _isAge:2</code></li>
<li>注释<code>_isAge</code>输出 <code>age:2 isAge:0</code></li>
<li>注释<code>age</code>输出 <code>isAge:2</code></li>
</ul>
<h4 id="KVC和KVO联系"><a href="#KVC和KVO联系" class="headerlink" title="KVC和KVO联系"></a>KVC和KVO联系</h4><p>我们知道KVC本质也是调用setter方法，那么会出发KVO吗？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">FYPerson *p=[[FYPerson alloc]init];</div><div class="line">[p addObserver:p</div><div class="line">	forKeyPath:@&quot;age&quot;</div><div class="line">	   options:NSKeyValueChangeNewKey</div><div class="line">	   context:nil];</div><div class="line">[p setValue:@2 forKey:@&quot;age&quot;];</div><div class="line">[p removeObserver:p forKeyPath:@&quot;age&quot;];</div><div class="line"></div><div class="line">@interface FYPerson()&#123;</div><div class="line">	@public</div><div class="line">	NSInteger _age;</div><div class="line">	NSInteger _isAge;</div><div class="line">	NSInteger age;</div><div class="line">	NSInteger isAge;</div><div class="line">&#125;</div><div class="line">@end</div><div class="line">@implementation FYPerson</div><div class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context&#123;</div><div class="line">	NSLog(@&quot;%@&quot;,change);</div><div class="line">&#125;</div><div class="line">@end</div><div class="line"></div><div class="line">//结果</div><div class="line">&#123;</div><div class="line">    kind = 1;</div><div class="line">    new = 2;</div><div class="line">    old = 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>经过测试，可以看出KVC能触发KVO的。那么<code>valueForKey:key</code>底层是怎么运行的呢？其实底层是按照顺序查找四个方法<code>_age</code>-&gt;<code>_isAge</code>-&gt;<code>age</code>-&gt;<code>isAge</code>。我们测试一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">FYPerson *p=[[FYPerson alloc]init];</div><div class="line">p-&gt;_age = 1;</div><div class="line">p-&gt;_isAge = 2;</div><div class="line">p-&gt;age = 3;</div><div class="line">p-&gt;isAge = 4;</div><div class="line">NSLog(@&quot;value:%@&quot;,[p valueForKey:@&quot;age&quot;]);</div><div class="line">//依次注释1,2,3，依次输出是1-&gt;2-&gt;3-&gt;4</div></pre></td></tr></table></figure>
<h4 id="总结：-1"><a href="#总结：-1" class="headerlink" title="总结："></a>总结：</h4><p>KVC其实本质是执行4个set方法和4个get方法，当使用<code>setValue:forKey:key</code>会触发KVO，找不到4个方法的时候会抛出异常。</p>
<h4 id="资料下载"><a href="#资料下载" class="headerlink" title="资料下载"></a>资料下载</h4><ul>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="external">学习资料下载</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="external">demo code</a></li>
</ul>
<p>之前看的没有手动去试验一下，然后再写出来，现在总结一下，参考了很多文章，还有macOS中日志记录是无意搜索出来了一个老外的blog，大家可以了解下，以后会有用，后边会讲如何<code>hook objc_msgsend</code>,感觉这个挺好玩的。</p>
<p>本文章之所以图片比较少，我觉得还是跟着代码敲一遍，印象比较深刻。</p>
<hr>
<p>最怕一生碌碌无为，还安慰自己平凡可贵。</p>
<p> 广告时间</p>
<p><img src="../images/0.png" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOS底层原理 类的本质--(2)/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="兜兜转转"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兜兜转转的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/01/iOS底层原理 类的本质--(2)/" class="post-title-link" itemprop="url">iOS底层原理  类的本质 --(2)</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-12-01 11:12:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:12:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-12-03 13:00:43" itemprop="dateModified" datetime="2019-12-03T13:00:43+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="底层原理-类的本质"><a href="#底层原理-类的本质" class="headerlink" title="底层原理 类的本质"></a>底层原理 类的本质</h3><p>复习一下<a href="">IOS 底层原理 对象的本质–(1)</a>，可以看出来实例对象实际是上结构体，那么这个结构体是有类指针和成员变量组成的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//Person</div><div class="line">@interface Person : NSObject</div><div class="line">&#123;</div><div class="line">	@public</div><div class="line">	int _age;//4bytes</div><div class="line">	int _level;//4bytes</div><div class="line">	int _code;//4bytes</div><div class="line">&#125;</div><div class="line">@end</div><div class="line">@implementation Person</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>经过<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main64.cpp</code>编译之后其实<code>Person</code>对象是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">struct Person_IMPL &#123;</div><div class="line">	struct NSObject_IMPL NSObject_IVARS;</div><div class="line">	int _age;</div><div class="line">	int _level;</div><div class="line">	int _code;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>NSObject_IMPL</code>结构体：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">struct NSObject_IMPL &#123;</div><div class="line">	Class isa;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>那么<code>NSObject</code>在内存中包括</p>
<ul>
<li><code>isa</code>指针</li>
<li>其他成员变量</li>
</ul>
<p><img src="../images/2-1.png" alt=""></p>
<p><code>isa</code>地址就是<code>instance</code>的地址，其他成员变量排在后边，也就是<code>instance</code>的地址就是<code>isa</code>的地址。</p>
<p>那么这个<code>isa</code>指向的到底是什么呢？<br>请往下继续看：<br>先看下这段代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">NSObject *ob1=[[NSObject alloc]init];</div><div class="line">NSObject *ob2=[[NSObject alloc]init];</div><div class="line"></div><div class="line">Class cl1 = object_getClass([ob1 class]);</div><div class="line">Class cl2 = object_getClass([ob2 class]);</div><div class="line"></div><div class="line">Class cl3 = ob1.class;</div><div class="line">Class cl4 = ob2.class;</div><div class="line"></div><div class="line">Class cl5 = NSObject.class;</div><div class="line"></div><div class="line">NSLog(@&quot; %p %p %p %p %p&quot;,cl1,cl2,cl3,cl4,cl5);</div><div class="line">//0x7fff8e3ba0f0 0x7fff8e3ba0f0 </div><div class="line">//0x7fff8e3ba140 0x7fff8e3ba140 0x7fff8e3ba140</div></pre></td></tr></table></figure>
<p>这代码是输出了几个<code>NSObject</code>的对象的类和<code>NSObject</code>的类对象的地址，可以看到<code>cl1==cl2</code>、<code>cl3==cl4==cl5</code>。</p>
<h4 id="Class的本质"><a href="#Class的本质" class="headerlink" title="Class的本质"></a>Class的本质</h4><p>我们知道不管是类对象还是元类对象，类型都是Class，class和mete-class的底层都是objc_class结构体的指针，内存中就是结构体。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Class objectClass = [NSObject class];        </div><div class="line">Class objectMetaClass = object_getClass([NSObject class]);</div></pre></td></tr></table></figure>
<p>点击class来到内部，可以发现</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef struct objc_class *Class;</div></pre></td></tr></table></figure>
<p><code>class</code>对象其实是指向objc_class的结构体，因此我们可以说类对象或元类对象在内存中其实就是objc_class结构体。</p>
<p>来到<code>objc_class</code>内部，在源码中经常看到这段源码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">struct objc_class &#123;</div><div class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;//isa</div><div class="line"></div><div class="line">#if !__OBJC2__</div><div class="line">    Class _Nullable super_class                    //父类          OBJC2_UNAVAILABLE;</div><div class="line">    const char * _Nonnull name                              //obj名字 OBJC2_UNAVAILABLE;</div><div class="line">    long version                                            //版本 OBJC2_UNAVAILABLE;</div><div class="line">    long info                                               //info OBJC2_UNAVAILABLE;</div><div class="line">    long instance_size                                      // OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_ivar_list * _Nullable ivars             //成员变量链表     OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;//方法链表</div><div class="line">    struct objc_cache * _Nonnull cache      //缓存链表                 OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_protocol_list * _Nullable protocols         //协议链表 OBJC2_UNAVAILABLE;</div><div class="line">#endif</div><div class="line"></div><div class="line">&#125; OBJC2_UNAVAILABLE;</div><div class="line">/* Use `Class` instead of `struct objc_class *` */</div></pre></td></tr></table></figure>
<p>这段代码明显是 已经<code>OBJC2_UNAVAILABLE</code>，说明代码已经不在使用了。那么<code>objc_class</code>结构体内部结构到底是什么呢？通过objc搜寻<code>runtime</code>的内容可以看到<code>objc_class</code>内部</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">struct objc_class : objc_object &#123;</div><div class="line">    // Class ISA;</div><div class="line">    Class superclass;</div><div class="line">    cache_t cache;             // formerly cache pointer and vtable</div><div class="line">    class_data_bits_t bits;    // class_rw_t * plus custom rr/alloc flags</div><div class="line"></div><div class="line">    class_rw_t *data() &#123; </div><div class="line">        return bits.data();</div><div class="line">    &#125;</div><div class="line">    void setData(class_rw_t *newData) &#123;</div><div class="line">        bits.setData(newData);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    void setInfo(uint32_t set) &#123;</div><div class="line">        assert(isFuture()  ||  isRealized());</div><div class="line">        data()-&gt;setFlags(set);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    void clearInfo(uint32_t clear) &#123;</div><div class="line">        assert(isFuture()  ||  isRealized());</div><div class="line">        data()-&gt;clearFlags(clear);</div><div class="line">    &#125;</div><div class="line">    //**后边省略</div></pre></td></tr></table></figure>
<p>我们发现这个结构体继承 <code>objc_object</code> 并且结构体内有一些函数，因为这是<code>c++</code>结构体，在c上做了扩展，因此结构体中可以包含函数。我们来到<code>objc_object</code>内，截取部分代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">struct objc_object &#123;</div><div class="line">private:</div><div class="line">    isa_t isa;</div><div class="line"></div><div class="line">public:</div><div class="line"></div><div class="line">    // ISA() assumes this is NOT a tagged pointer object</div><div class="line">    Class ISA();</div><div class="line"></div><div class="line">    // getIsa() allows this to be a tagged pointer object</div><div class="line">    Class getIsa();</div><div class="line"></div><div class="line">    // initIsa() should be used to init the isa of new objects only.</div><div class="line">    // If this object already has an isa, use changeIsa() for correctness.</div><div class="line">    // initInstanceIsa(): objects with no custom RR/AWZ</div><div class="line">    // initClassIsa(): class objects</div><div class="line">    // initProtocolIsa(): protocol objects</div><div class="line">    // initIsa(): other objects</div><div class="line">    void initIsa(Class cls /*nonpointer=false*/);</div><div class="line">    void initClassIsa(Class cls /*nonpointer=maybe*/);</div><div class="line">    void initProtocolIsa(Class cls /*nonpointer=maybe*/);</div><div class="line">    void initInstanceIsa(Class cls, bool hasCxxDtor);</div></pre></td></tr></table></figure>
<p>那么我们之前了解到的，类中存储的类的成员变量信息，方法列表，协议列表，截取<code>class_rw_t</code>内部实现代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">struct class_rw_t &#123;</div><div class="line">    // Be warned that Symbolication knows the layout of this structure.</div><div class="line">    uint32_t flags;</div><div class="line">    uint32_t version;</div><div class="line"></div><div class="line">    const class_ro_t *ro;</div><div class="line"></div><div class="line">    method_array_t methods;//方法列表</div><div class="line">    property_array_t properties;//属性列表</div><div class="line">    protocol_array_t protocols;//协议列表</div><div class="line"></div><div class="line">    Class firstSubclass;</div><div class="line">    Class nextSiblingClass;</div><div class="line">**</div><div class="line">//后边省略</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而<code>class_rw_t</code>是通过<code>bits.data()</code>获取的，截取<code>bits.data()</code>查看内部实现,而仅仅是<code>bits&amp;FAST_DATA_MASK</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">class_rw_t* data() &#123;</div><div class="line">    return (class_rw_t *)(bits &amp; FAST_DATA_MASK);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>而成员变量则是存储在<code>class_ro_t</code>内部中的，我们来到<code>class_ro_t</code>内部查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">struct class_ro_t &#123;</div><div class="line">    uint32_t flags;</div><div class="line">    uint32_t instanceStart;</div><div class="line">    uint32_t instanceSize;</div><div class="line">#ifdef __LP64__</div><div class="line">    uint32_t reserved;</div><div class="line">#endif</div><div class="line"></div><div class="line">    const uint8_t * ivarLayout;</div><div class="line">    </div><div class="line">    const char * name;</div><div class="line">    method_list_t * baseMethodList;//方法列表</div><div class="line">    protocol_list_t * baseProtocols;//协议列表</div><div class="line">    const ivar_list_t * ivars;//成员变量列表</div><div class="line"></div><div class="line">    const uint8_t * weakIvarLayout;</div><div class="line">    property_list_t *baseProperties;//属性列表</div><div class="line"></div><div class="line">    method_list_t *baseMethods() const &#123;</div><div class="line">        return baseMethodList;</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>最后通过一张图总结一下：</p>
<p><img src="../images/2-2.png" alt=""></p>
<p>那么我们来证明一下：<br>我们可以自定义一下一个和系统一样的结构体，那么我们当我们强制转化的时候，他们赋值会一一对应，此时我们就可以拿到结构体的内部的值。<br>下边代码是我们自定义的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div></pre></td><td class="code"><pre><div class="line">//</div><div class="line">//  Header.h</div><div class="line">//  day02-类的本质1</div><div class="line">//</div><div class="line">//  Created by Charlie on 2019/7/2.</div><div class="line">//  Copyright © 2019 www.fgyong.cn. All rights reserved.</div><div class="line">//</div><div class="line"></div><div class="line">#ifndef Header_h</div><div class="line">#define Header_h</div><div class="line"></div><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line">#import &lt;objc/runtime.h&gt;</div><div class="line"></div><div class="line"># if __arm64__</div><div class="line">#   define ISA_MASK        0x0000000ffffffff8ULL</div><div class="line"># elif __x86_64__</div><div class="line">#   define ISA_MASK        0x00007ffffffffff8ULL</div><div class="line"># endif</div><div class="line"></div><div class="line">#if __LP64__</div><div class="line">typedef uint32_t mask_t;</div><div class="line">#else</div><div class="line">typedef uint16_t mask_t;</div><div class="line">#endif</div><div class="line">typedef uintptr_t cache_key_t;</div><div class="line"></div><div class="line">struct bucket_t &#123;</div><div class="line">	cache_key_t _key;</div><div class="line">	IMP _imp;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct cache_t &#123;</div><div class="line">	bucket_t *_buckets;</div><div class="line">	mask_t _mask;</div><div class="line">	mask_t _occupied;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct entsize_list_tt &#123;</div><div class="line">	uint32_t entsizeAndFlags;</div><div class="line">	uint32_t count;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct method_t &#123;</div><div class="line">	SEL name;</div><div class="line">	const char *types;</div><div class="line">	IMP imp;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct method_list_t : entsize_list_tt &#123;</div><div class="line">	method_t first;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct ivar_t &#123;</div><div class="line">	int32_t *offset;</div><div class="line">	const char *name;</div><div class="line">	const char *type;</div><div class="line">	uint32_t alignment_raw;</div><div class="line">	uint32_t size;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct ivar_list_t : entsize_list_tt &#123;</div><div class="line">	ivar_t first;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct property_t &#123;</div><div class="line">	const char *name;</div><div class="line">	const char *attributes;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct property_list_t : entsize_list_tt &#123;</div><div class="line">	property_t first;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct chained_property_list &#123;</div><div class="line">	chained_property_list *next;</div><div class="line">	uint32_t count;</div><div class="line">	property_t list[0];</div><div class="line">&#125;;</div><div class="line"></div><div class="line">typedef uintptr_t protocol_ref_t;</div><div class="line">struct protocol_list_t &#123;</div><div class="line">	uintptr_t count;</div><div class="line">	protocol_ref_t list[0];</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct class_ro_t &#123;</div><div class="line">	uint32_t flags;</div><div class="line">	uint32_t instanceStart;</div><div class="line">	uint32_t instanceSize;  // instance对象占用的内存空间</div><div class="line">#ifdef __LP64__</div><div class="line">	uint32_t reserved;</div><div class="line">#endif</div><div class="line">	const uint8_t * ivarLayout;</div><div class="line">	const char * name;  // 类名</div><div class="line">	method_list_t * baseMethodList;</div><div class="line">	protocol_list_t * baseProtocols;</div><div class="line">	const ivar_list_t * ivars;  // 成员变量列表</div><div class="line">	const uint8_t * weakIvarLayout;</div><div class="line">	property_list_t *baseProperties;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">struct class_rw_t &#123;</div><div class="line">	uint32_t flags;</div><div class="line">	uint32_t version;</div><div class="line">	const class_ro_t *ro;</div><div class="line">	method_list_t * methods;    // 方法列表</div><div class="line">	property_list_t *properties;    // 属性列表</div><div class="line">	const protocol_list_t * protocols;  // 协议列表</div><div class="line">	Class firstSubclass;</div><div class="line">	Class nextSiblingClass;</div><div class="line">	char *demangledName;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">#define FAST_DATA_MASK          0x00007ffffffffff8UL</div><div class="line">struct class_data_bits_t &#123;</div><div class="line">	uintptr_t bits;</div><div class="line">public:</div><div class="line">	class_rw_t* data() &#123; // 提供data()方法进行 &amp; FAST_DATA_MASK 操作</div><div class="line">		return (class_rw_t *)(bits &amp; FAST_DATA_MASK);</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">/* OC对象 */</div><div class="line">struct xx_objc_object &#123;</div><div class="line">	void *isa;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">/* 类对象 */</div><div class="line">struct fy_objc_class : xx_objc_object &#123;</div><div class="line">	Class superclass;</div><div class="line">	cache_t cache;</div><div class="line">	class_data_bits_t bits;</div><div class="line">public:</div><div class="line">	class_rw_t* data() &#123;</div><div class="line">		return bits.data();</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	fy_objc_class* metaClass() &#123; // 提供metaClass函数，获取元类对象</div><div class="line">		// 上一篇我们讲解过，isa指针需要经过一次 &amp; ISA_MASK操作之后才得到真正的地址</div><div class="line">		return (fy_objc_class *)((long long)isa &amp; ISA_MASK);</div><div class="line">	&#125;</div><div class="line">&#125;;</div><div class="line">#endif /* Header_h */</div></pre></td></tr></table></figure>
<p>这段代码亲测可用，直接复制自己新建<code>.h</code>文件导入’main.m’即可，将<code>main.m</code>改成<code>main.mm</code>或者将其他某一个<code>.m</code>改成<code>.mm</code>运行就可以运行了。</p>
<p>那么我们再拿出来经典的那张图挨着分析<code>isa</code> 和<code>superclass</code>的指向</p>
<p><img src="../images/2-2.png" alt=""></p>
<h4 id="instance-对象验证"><a href="#instance-对象验证" class="headerlink" title="instance 对象验证"></a>instance 对象验证</h4><p>使用 <code>p/x</code>输出<code>obj</code>16进制的地址，然后<strong>isa指针需要经过一次 &amp; ISA_MASK操作之后才得到真正的地址</strong>。实施之后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">//object</div><div class="line"></div><div class="line">Printing description of student:</div><div class="line">&lt;Student: 0x1021729c0&gt;</div><div class="line">(lldb) p/x object-&gt;isa //查看isa指针地址</div><div class="line">(Class) $0 = 0x001dffff8e3ba141 NSObject </div><div class="line">(lldb) p/x objectClass//输出 objectClass的地址</div><div class="line">(fy_objc_class *) $1 = 0x00007fff8e3ba140</div><div class="line">(lldb) p/x 0x001dffff8e3ba141&amp;0x00007ffffffffff8//计算得出object-&gt;isa真正的地址</div><div class="line">(long) $2 = 0x00007fff8e3ba140 //0x00007fff8e3ba140是 objectClass地址和object-&gt;isa地址一样</div><div class="line"></div><div class="line"></div><div class="line">//person</div><div class="line"></div><div class="line">Printing description of person: &lt;Person: 0x102175300&gt;</div><div class="line">(lldb) p/x person-&gt;isa</div><div class="line">(Class) $3 = 0x001d800100002469 Person</div><div class="line">(lldb) p/x 0x001d800100002469&amp;0x00007ffffffffff8</div><div class="line">(long) $4 = 0x0000000100002468</div><div class="line">(lldb) p/x personClass</div><div class="line">(fy_objc_class *) $5 = 0x0000000100002468//isa 和personclass地址都是0x0000000100002468</div><div class="line"></div><div class="line">//student</div><div class="line"></div><div class="line">(lldb) p/x student-&gt;isa</div><div class="line">(Class) $6 = 0x001d8001000024b9 Student</div><div class="line">(lldb) p/x 0x001d8001000024b9&amp;0x00007ffffffffff8</div><div class="line">(long) $7 = 0x00000001000024b8</div><div class="line">(lldb) p/x studentClass</div><div class="line">(fy_objc_class *) $8 = 0x00000001000024b8//studentclass 和isa地址都是0x00000001000024b8</div><div class="line">(lldb)</div></pre></td></tr></table></figure>
<p>从面的输出结果中我们可以发现instance对象中确实存储了isa指针和其成员变量，同时将instance对象的isa指针经过&amp;运算之后计算出的地址确实是其相应类对象的内存地址。由此我们证明isa，superclass指向图中的1，2，3号线。</p>
<h4 id="class-对象验证"><a href="#class-对象验证" class="headerlink" title="class 对象验证"></a>class 对象验证</h4><p>接着我们来看<code>class</code>对象，同样通过上一篇文章，我们明确<code>class</code>对象中存储着<code>isa</code>指针，<code>superclass</code>指针，以及类的属性信息，类的成员变量信息，类的对象方法，和类的协议信息，而通过上面对<code>object</code>源码的分析，我们知道这些信息存储在<code>class</code>对象的<code>class_rw_t</code>中，我们通过强制转化来窥探其中的内容</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">//objectClass and objectMetaClass</div><div class="line"></div><div class="line">(lldb) p/x objectClass-&gt;isa</div><div class="line">(__NSAtom *) $6 = 0x001dffff8e3ba0f1</div><div class="line">(lldb) p/x 0x001dffff8e3ba0f1&amp;0x00007ffffffffff8</div><div class="line">(long) $7 = 0x00007fff8e3ba0f0</div><div class="line">(lldb) p/x objectMetaClass</div><div class="line">(fy_objc_class *) $8 = 0x00007fff8e3ba0f0</div><div class="line"></div><div class="line">//personClass and personMetaClass</div><div class="line"></div><div class="line">(lldb) p/x personClass-&gt;isa</div><div class="line">(__NSAtom *) $9 = 0x001d800100002441</div><div class="line">(lldb) p/x personMetaClass</div><div class="line">(fy_objc_class *) $10 = 0x0000000100002440</div><div class="line">(lldb) p/x 0x001d800100002441&amp;0x00007ffffffffff8</div><div class="line">(long) $11 = 0x0000000100002440</div><div class="line"></div><div class="line">//sutdentClass and studentMetaClass</div><div class="line"></div><div class="line">(lldb) p/x studentClass-&gt;isa</div><div class="line">(__NSAtom *) $12 = 0x001d800100002491</div><div class="line">(lldb) p/x 0x001d800100002491&amp;0x00007ffffffffff8</div><div class="line">(long) $13 = 0x0000000100002490</div><div class="line">(lldb) p/x studentMetaClass</div><div class="line">(fy_objc_class *) $14 = 0x0000000100002490</div></pre></td></tr></table></figure>
<p>有此结果得知<code>objectMetaClass==objectClass-&gt;isa==0x00007fff8e3ba0f0</code>,<code>personClass-&gt;isa==personMetaClass==0x0000000100002440</code>,<code>studentClass-&gt;isa==studentMetaClass==0x0000000100002490</code>。<br>由此我们证明isa，superclass指向图中，isa指针的4，5，6号线，以及superclass指针的7,8,9号线。</p>
<h4 id="meta-class对象验证"><a href="#meta-class对象验证" class="headerlink" title="meta-class对象验证"></a>meta-class对象验证</h4><p>最后我们来看<code>meta-class</code>元类对象，上文提到<code>meta-class</code>中存储着<code>isa</code>指针，<code>superclass</code>指针，以及类的类方法信息。同时我们知道<code>meta-class</code>元类对象与<code>class</code>类对象，具有相同的结构，只不过存储的信息不同，并且元类对象的<code>isa</code>指针指向基类的元类对象，基类的元类对象的<code>isa</code>指针指向自己。元类对象的<code>superclass</code>指针指向其父类的元类对象，基类的元类对象的<code>superclass</code>指针指向其类对象。<br>与<code>class</code>对象相同，我们同样通过模拟对<code>person</code>元类对象调用<code>.data</code>函数，即对<code>bits</code>进行<code>&amp;FAST_DATA_MASK(0x00007ffffffffff8UL)</code>运算，并转化为<code>class_rw_t</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">// objectMetaClass-&gt;superclass = 0x00007fff8e3ba140  NSObject</div><div class="line">//objectMetaClass-&gt;isa =   0x00007fff8e3ba0f0</div><div class="line">//objectMetaClass = 0x00007fff8e3ba0f0</div><div class="line"></div><div class="line">(lldb) p/x objectMetaClass-&gt;superclass</div><div class="line">(Class) $20 = 0x00007fff8e3ba140 NSObject</div><div class="line">(lldb) p/x objectMetaClass-&gt;isa</div><div class="line">(__NSAtom *) $21 = 0x001dffff8e3ba0f1</div><div class="line">(lldb) p/x 0x001dffff8e3ba0f1&amp;0x00007ffffffffff8</div><div class="line">(long) $22 = 0x00007fff8e3ba0f0</div><div class="line">(lldb) p/x objectMetaClass</div><div class="line">(fy_objc_class *) $23 = 0x00007fff8e3ba0f0</div><div class="line"></div><div class="line">// personMetaClass-&gt;superclas=0x00007fff8e3ba0f0</div><div class="line">//personMetaClass-&gt;isa=0x00007fff8e3ba0f0</div><div class="line">//personMetaClass = 0x0000000100002440</div><div class="line"></div><div class="line">(lldb) p/x personMetaClass-&gt;superclass</div><div class="line">(Class) $25 = 0x00007fff8e3ba0f0</div><div class="line">(lldb) p/x personMetaClass-&gt;isa</div><div class="line">(__NSAtom *) $26 = 0x001dffff8e3ba0f1</div><div class="line">(lldb) p/x personMetaClass</div><div class="line">(fy_objc_class *) $30 = 0x0000000100002440</div><div class="line"></div><div class="line">// studentMetaClass-&gt;superclas=0x0000000100002440</div><div class="line">//studentMetaClass-&gt;isa=0x00007fff8e3ba0f0</div><div class="line"></div><div class="line"></div><div class="line">(lldb) p/x studentMetaClass-&gt;superclass</div><div class="line">(Class) $27 = 0x0000000100002440</div><div class="line">(lldb) p/x studentMetaClass-&gt;isa</div><div class="line">(__NSAtom *) $28 = 0x001dffff8e3ba0f1</div><div class="line">(lldb) p/x 0x001dffff8e3ba0f1 &amp; 0x00007ffffffffff8</div><div class="line">(long) $29 = 0x00007fff8e3ba0f0</div></pre></td></tr></table></figure>
<p>由上面可以看出，<code>studentMetaClass-&gt;isa</code>,<code>personMetaClass-&gt;isa</code>,<code>objectMetaClass-&gt;isa</code>结果<code>mask</code>之后都是<code>0x00007fff8e3ba0f0</code>，与<code>p/x objectMetaClass</code>结果一致，则验证了13，14，15号线，<code>studentMetaClass-&gt;superclass =0x0000000100002440</code>,<code>personMetaClass = 0x0000000100002440</code>验证12号线，<code>personMetaClass-&gt;isa=0x00007fff8e3ba0f0</code>和<code>objectMetaClass = 0x00007fff8e3ba0f0</code>验证了11号线，<code>objectMetaClass-&gt;superclass = 0x00007fff8e3ba140  NSObject</code>验证10号线。</p>
<h4 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h4><p>对象的isa指向哪里？</p>
<ul>
<li>instance对象的isa指向class对象</li>
<li>class对象的isa指向meta-class对象</li>
<li>meta-class对象的isa指向基类的meta-class对象</li>
<li>class和meta-class的内存结构一样的，只是值不一样</li>
</ul>
<p>OC的类信息存放在哪里？</p>
<ul>
<li>对象方法、属性、成员变量、协议信息存放在class对象中</li>
<li>类方法存放在meta-class对象中</li>
<li>成员变量具体值存放在instance对象中</li>
</ul>
<h4 id="资料下载"><a href="#资料下载" class="headerlink" title="资料下载"></a>资料下载</h4><ul>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="external">学习资料下载</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="external">demo code</a></li>
</ul>
<hr>
<p>最怕一生碌碌无为，还安慰自己平凡可贵。</p>
<p>本文章之所以图片比较少，我觉得还是跟着代码敲一遍，印象比较深刻。</p>
<p><img src="../images/0.png" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/IOS底层原理 对象的本质--(1)/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="兜兜转转"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兜兜转转的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/01/IOS底层原理 对象的本质--(1)/" class="post-title-link" itemprop="url">iOS底层原理  对象的本质 --(1)</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-12-01 11:11:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:11:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-12-03 12:56:17" itemprop="dateModified" datetime="2019-12-03T12:56:17+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="对象的本质"><a href="#对象的本质" class="headerlink" title="对象的本质"></a>对象的本质</h3><p>探寻OC对象的本质，我们平时编写的Objective-C代码，底层实现其实都是C\C++代码。<br>那么一个OC对象占用多少内存呢？看完这篇文章你将了解OC对象的内存布局和内存分配机制。</p>
<p>使用的<a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="external">代码下载</a><br>要用的工具:</p>
<ul>
<li><a href="https://developer.apple.com/cn/support/xcode/" target="_blank" rel="external">Xcode 10.2</a></li>
<li><a href="https://zipzapmac.com/Go2Shell" target="_blank" rel="external">gotoShell</a></li>
<li><a href="http://ftp.gnu.org/gnu/glibc/" target="_blank" rel="external">linux-glibc-2.29源码</a></li>
<li><a href="https://opensource.apple.com/tarballs/libmalloc/" target="_blank" rel="external">libmalloc源码</a></li>
</ul>
<p>首先我们使用最基本的代码验证对象是什么?</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">	@autoreleasepool &#123;</div><div class="line">	    // insert code here...</div><div class="line">		NSObject *obj=[[NSObject alloc]init];</div><div class="line">	    NSLog(@&quot;Hello, World!&quot;);</div><div class="line">	&#125;</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>使用<code>clang</code>编译器编译成<code>cpp</code>，<br>执行<code>clang -rewrite-objc main.m -o main.cpp</code>之后生成的<code>cpp</code>，这个生成的<code>cpp</code>我们不知道是跑在哪个平台的，现在我们指定<code>iphoeos</code>和<code>arm64</code>重新编译一下。<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main64.cpp</code>，将<code>main64.cpp</code>拖拽到Xcode中并打开。<br>|clang|编译器|<br>|————–|——-|<br>|xcrun|命令|<br>|sdk|指定编译的平台|<br>|arch|arm64架构|<br>|-rewrite-objc|重写|<br>|main.m|重写的文件|<br>|main64.cpp|导出的文件|<br>|-o|导出|</p>
<p><code>command + F</code>查找<code>int main</code>,找到关键代码，这就是<code>main</code>函数的转化成<code>c/c++</code>的代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line"> /* @autoreleasepool */ &#123; __AtAutoreleasePool __autoreleasepool; </div><div class="line"></div><div class="line">  NSObject *obj=((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(&quot;NSObject&quot;), sel_registerName(&quot;alloc&quot;)), sel_registerName(&quot;init&quot;));</div><div class="line"></div><div class="line">     NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_c0_7nm4_r7s4xd0mbs67ljb_b8m0000gn_T_main_1b47c1_mi_0);</div><div class="line"> &#125;</div><div class="line"> return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后搜索</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">struct NSObject_IMPL &#123;</div><div class="line">	Class isa;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>那么这个结构体是什么呢？<br>其实我们<code>Object-C</code>编译之后对象会编译成结构体，如图所示：<br><img src="../images/1-1.png" alt=""><br>那么<code>isa</code>是什么吗？通过查看源码得知：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef struct objc_class *Class;</div></pre></td></tr></table></figure>
<p><code>class</code>其实是一个指向结构体的指针，然后<code>com+点击class</code>得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">struct objc_class &#123;</div><div class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</div><div class="line"></div><div class="line">#if !__OBJC2__</div><div class="line">    Class _Nullable super_class                              OBJC2_UNAVAILABLE;</div><div class="line">    const char * _Nonnull name                               OBJC2_UNAVAILABLE;</div><div class="line">    long version                                             OBJC2_UNAVAILABLE;</div><div class="line">    long info                                                OBJC2_UNAVAILABLE;</div><div class="line">    long instance_size                                       OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;</div><div class="line">    struct objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;</div><div class="line">#endif</div><div class="line"></div><div class="line">&#125; OBJC2_UNAVAILABLE;</div></pre></td></tr></table></figure>
<p><code>class</code>是一个指针，那么占用多少内存呢？大家都知道<strong>指针在32位是4字节，在64位是8字节。</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NSObject *obj=[[NSObject alloc]init];</div></pre></td></tr></table></figure>
<p>可以理解成实例对象是一个指针,指针占用8或者4字节，那么暂时假设机器是64位，记为对象占用8字节。<br><code>obj</code>就是指向结构体<code>class</code>的一个指针。<br>那么我们来验证一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">int main(int argc, const char * argv[]) &#123;</div><div class="line">	@autoreleasepool &#123;</div><div class="line">	    // insert code here...</div><div class="line">		NSObject *obj=[[NSObject alloc]init];</div><div class="line">		//获得NSobject对象实例大小</div><div class="line">		size_t size = class_getInstanceSize(obj.class);</div><div class="line">		//获取NSObjet指针的指向的内存大小</div><div class="line">		//需要导入：#import &lt;malloc/malloc.h&gt;</div><div class="line">		size_t size2 = malloc_size((__bridge const void *)(obj));</div><div class="line">		NSLog(@&quot;size:%zu size2:%zu&quot;,size,size2);</div><div class="line">	&#125;</div><div class="line">	return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>得出结果是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">size:8 size2:16</div></pre></td></tr></table></figure>
<p>结论是：<strong>指针是8字节，指针指向的的内存大小为16字节。</strong><br>查看源码得知<code>[[NSObject alloc]init]</code>的函数运行顺序是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">class_createInstance</div><div class="line">    -_class_createInstanceFromZone</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">id</div><div class="line">_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone, </div><div class="line">                              bool cxxConstruct = true, </div><div class="line">                              size_t *outAllocatedSize = nil)</div><div class="line">&#123;</div><div class="line">    if (!cls) return nil;</div><div class="line">    **</div><div class="line">    size_t size = cls-&gt;instanceSize(extraBytes);</div><div class="line">    **</div><div class="line">    return obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个函数前边后边省略，取出关键代码，其实<code>size</code>是<code>cls-&gt;instanceSize(extraBytes)</code>执行的结果。那么我们再看下<code>cls-&gt;instanceSize</code>的源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//成员变量大小 8bytes</div><div class="line">    uint32_t alignedInstanceSize() &#123;</div><div class="line">        return word_align(unalignedInstanceSize());</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    size_t instanceSize(size_t extraBytes) &#123;</div><div class="line">        size_t size = alignedInstanceSize() + extraBytes;</div><div class="line">        // CF requires all objects be at least 16 bytes.</div><div class="line">        if (size &lt; 16) size = 16;</div><div class="line">        return size;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>可以通过源码注释得知：CF要求所有的objects 最小是16bytes。</p>
<p><code>class_getInstanceSize</code>函数的内部执行顺序是<code>class_getInstanceSize-&gt;cls-&gt;alignedInstanceSize()</code><br>查阅源码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//成员变量大小 8bytes</div><div class="line">    uint32_t alignedInstanceSize() &#123;</div><div class="line">        return word_align(unalignedInstanceSize());</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>所以最终结论是：<strong>对象指针实际大小为8bytes，内存分配为16bytes，其实是空出了8bytes</strong>。</p>
<p>验证：<br>在刚才 的代码打断点和设置<code>Debug-&gt;Debug Workflow-&gt;View Memory</code>,然后运行程序，</p>
<p><img src="../images/1-2.png" alt=""></p>
<p><img src="../images/1-3.png" alt=""><br>点击<code>obj-&gt;view *objc</code>得到上图所示的内存布局，从<code>address</code>看出和<code>obj</code>内存一样，左上角是16字节，8个字节有数据，8个字节是空的，默认是0.</p>
<p>使用lldb命令<code>memory read 0x100601f30</code>输出内存布局，如下图：<br><img src="../images/1-4.png" alt=""><br>或者使用<code>x/4xg 0x100601f30</code>输出：</p>
<p><img src="../images/1-5.png" alt=""><br><code>x/4xg 0x100601f30</code>中<code>4</code>是输出<code>4</code>个数据,<code>x</code> 是16进制,后边<code>g</code>是8字节为单位。可以验证刚才的出的结论。</p>
<p>那么我们再使用复杂的一个对象来验证：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">@interface Person : NSObject</div><div class="line">&#123;</div><div class="line">	int _age;</div><div class="line">	int _no;</div><div class="line">&#125;</div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p>使用<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main64.cpp</code>编译之后对应的源码是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">struct NSObject_IMPL &#123;</div><div class="line"> Class isa;</div><div class="line">&#125;;</div><div class="line">struct Person_IMPL &#123;</div><div class="line">	struct NSObject_IMPL NSObject_IVARS;// 8 bytes</div><div class="line">	int _age;//4 bytes</div><div class="line">	int _no;//4 bytes</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p><code>Person——IMPL</code><strong>结构体占用16bytes</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Person *obj=[[Person alloc]init];</div><div class="line">		obj-&gt;_age = 15;</div><div class="line">		obj-&gt;_no = 14;</div></pre></td></tr></table></figure>
<p>使用代码验证：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Person *obj=[[Person alloc]init];</div><div class="line">obj-&gt;_age = 15;</div><div class="line">obj-&gt;_no = 14;</div><div class="line"></div><div class="line">struct Person_IMPL *p =(__bridge struct Person_IMPL*)obj;</div><div class="line">NSLog(@&quot;age:%d no:%d&quot;,p-&gt;_age,p-&gt;_no);</div><div class="line"></div><div class="line">//age:15 no:14</div></pre></td></tr></table></figure>
<p>使用内存布局验证：</p>
<p><img src="../images/1-6.png" alt=""><br>以十进制输出每个4字节<br><img src="../images/1-7.png" alt=""><br>使用内存布局查看数据验证，<code>Person</code>占用16 bytes。</p>
<p>下边是一个直观的内存布局图：</p>
<p><img src="../images/1-8.png" alt=""></p>
<h4 id="再看一下更复杂的继承关系的内存布局："><a href="#再看一下更复杂的继承关系的内存布局：" class="headerlink" title="再看一下更复杂的继承关系的内存布局："></a>再看一下更复杂的继承关系的内存布局：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">@interface Person : NSObject</div><div class="line">&#123;</div><div class="line">	@public</div><div class="line">	int _age;//4bytes </div><div class="line">&#125;</div><div class="line">@end</div><div class="line">@implementation Person</div><div class="line">@end</div><div class="line"></div><div class="line">//Student</div><div class="line">@interface Student : Person</div><div class="line">&#123;</div><div class="line">@public</div><div class="line">	int _no;//4bytes</div><div class="line">&#125;</div><div class="line">@end</div><div class="line">@implementation Student</div><div class="line">@end</div></pre></td></tr></table></figure>
<p>那小伙伴可能要说这一定是32字节，因为<code>Person</code>上边已经证明是16字节，<code>Student</code>又多了个成员变量<code>_no</code>，由于内存对齐，一定是16的整倍数，那就是16+16=32字节。<br>其实不然，<code>Person</code>是内存分配16字节，其实占用了8+4=12字节，剩余4字节位子空着而已，<code>Student</code>是一个对象，不可能在成员变量和指针中间有内存对齐的，参数和指针是对象指针+偏移量得出来的，多个不同的对象才会存在内存对齐。所以<code>Student</code>是占用了16字节。</p>
<p>那么我们来证明一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">Student *obj=[[Student alloc]init];</div><div class="line">		obj-&gt;_age = 6;</div><div class="line">		obj-&gt;_no = 7;</div><div class="line">		</div><div class="line">		//获得NSobject对象实例成员变量占用的大小 -&gt;8</div><div class="line">		size_t size = class_getInstanceSize(obj.class);</div><div class="line">		//获取NSObjet指针的指向的内存大小 -&gt;16</div><div class="line">		size_t size2 = malloc_size((__bridge const void *)(obj));</div><div class="line">		NSLog(@&quot;size:%zu size2:%zu&quot;,size,size2);</div><div class="line">		//size:16 size2:16</div></pre></td></tr></table></figure>
<p>再看一下LLDB查看的内存布局：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">(lldb) x/8xw 0x10071ae30</div><div class="line">0x10071ae30: 0x00001299 0x001d8001 0x00000006 0x00000007</div><div class="line">0x10071ae40: 0xa0090000 0x00000007 0x8735e0b0 0x00007fff</div><div class="line"></div><div class="line">(lldb) memory read 0x10071ae30</div><div class="line">0x10071ae30: 99 12 00 00 01 80 1d 00 06 00 00 00 07 00 00 00  ................</div><div class="line">0x10071ae40: 00 00 09 a0 07 00 00 00 b0 e0 35 87 ff 7f 00 00  ..........5.....</div><div class="line"></div><div class="line">(lldb) x/4xg 0x10071ae30</div><div class="line">0x10071ae30: 0x001d800100001299 0x0000000700000006</div><div class="line">0x10071ae40: 0x00000007a0090000 0x00007fff8735e0b0</div></pre></td></tr></table></figure>
<p>可以看出来<code>0x00000006</code>和<code>0x00000007</code>就是两个成员变量的值，占用内存是16字节。</p>
<p>我们将<code>Student</code>新增一个成员变量：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//Student</div><div class="line">@interface Student : Person</div><div class="line">&#123;</div><div class="line">@public</div><div class="line">	int _no;//4bytes</div><div class="line">	int _no2;//4bytes</div><div class="line">&#125;</div><div class="line">@end</div><div class="line">@implementation Student</div><div class="line">@end</div></pre></td></tr></table></figure></p>
<p>然后查看内存布局：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(lldb) x/8xg 0x102825db0</div><div class="line">0x102825db0: 0x001d8001000012c1 0x0000000700000006</div><div class="line">0x102825dc0: 0x0000000000000000 0x0000000000000000</div><div class="line">0x102825dd0: 0x001dffff8736ae71 0x0000000100001f80</div><div class="line">0x102825de0: 0x0000000102825c60 0x0000000102825890</div></pre></td></tr></table></figure></p>
<p>从<code>LLDB</code>可以看出来，<strong>内存变成了32字节。(0x102825dd0-0x102825db0=0x20)</strong></p>
<p>我们再增加一个属性看下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@interface Person : NSObject</div><div class="line">&#123;</div><div class="line">	@public</div><div class="line">	int _age;//4bytes </div><div class="line">&#125;</div><div class="line">@property (nonatomic,assign) int level; //4字节</div><div class="line">@end</div><div class="line">@implementation Person</div><div class="line">@end</div><div class="line"></div><div class="line">//InstanceSize:16 malloc_size:16</div></pre></td></tr></table></figure></p>
<p>为什么新增了一个属性，内存还是和没有新增的时候一样呢？<br>因为<code>property</code>=<code>setter</code>+<code>getter</code>+<code>ivar</code>,<code>method</code>是存在类对象中的，所以实例<code>Person</code>占用的内存还是<code>_age</code>,<code>_level</code>和一个指向类的指针，最后结果是<code>4+4+8=16bytes</code>。</p>
<p>再看下成员变量是3个的时候是多少呢？看结果之前先猜测一下：三个<code>int</code>成员变量是12，一个指针是8，最后是20，由于内存是8的倍数，所以是24。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">@interface Person : NSObject</div><div class="line">&#123;</div><div class="line">	@public</div><div class="line">	int _age;//4bytes</div><div class="line">	int _level;//4bytes</div><div class="line">	int _code;//4bytes</div><div class="line">&#125;</div><div class="line">@end</div><div class="line">@implementation Person</div><div class="line">@end</div><div class="line"></div><div class="line">Person *obj=[[Person alloc]init];</div><div class="line">		obj-&gt;_age = 6;</div><div class="line">		</div><div class="line">		</div><div class="line">		//获得NSobject对象实例成员变量占用的大小 -&gt;24</div><div class="line">		Class ocl = obj.class;</div><div class="line">		size_t size = class_getInstanceSize(ocl);</div><div class="line">		//获取NSObjet指针的指向的内存大小 -&gt;32</div><div class="line">		size_t size2 = malloc_size((__bridge const void *)(obj));</div><div class="line">		printf(&quot;InstanceSize:%zu malloc_size:%zu \n&quot;,size,size2);</div><div class="line">		</div><div class="line">InstanceSize:24 malloc_size:32</div></pre></td></tr></table></figure>
<p>为什么和我们猜测的不一样呢？<br>那么我们再探究一下：<br>实例对象占用多少内存，当然是在申请内存的时候创建的，则查找源码<code>NSObject.mm 2306行</code>得到创建对象函数调用顺序<code>allocWithZone-&gt;_objc_rootAllocWithZone-&gt;_objc_rootAllocWithZone-&gt;class_createInstance-&gt;_class_createInstanceFromZone-&gt;_class_createInstanceFromZone</code>最后查看下<code>_class_createInstanceFromZone</code>的源码，其他已省略，只留关键代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">id</div><div class="line">_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone, </div><div class="line">                              bool cxxConstruct = true, </div><div class="line">                              size_t *outAllocatedSize = nil)</div><div class="line">&#123;</div><div class="line">    if (!cls) return nil;</div><div class="line">**</div><div class="line">    size_t size = cls-&gt;instanceSize(extraBytes);</div><div class="line">    if (outAllocatedSize) *outAllocatedSize = size;</div><div class="line">    **</div><div class="line">    obj = (id)calloc(1, size);</div><div class="line">   **</div><div class="line">    return obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那么我们在看一下<code>instanceSize</code>中的实现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//对象指针的大小</div><div class="line">   uint32_t alignedInstanceSize() &#123;</div><div class="line">       return word_align(unalignedInstanceSize());</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   size_t instanceSize(size_t extraBytes) &#123;</div><div class="line">       size_t size = alignedInstanceSize() + extraBytes;</div><div class="line">       // CF requires all objects be at least 16 bytes.</div><div class="line">       if (size &lt; 16) size = 16;</div><div class="line">       return size;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>最后调用的<code>obj = (id)calloc(1, size);</code>传进去的值是24，但是结果是申请了32字节的内存，这又是为什么呢？<br>因为这是<code>c</code>函数，我们去<a href="https://opensource.apple.com/tarballs/libmalloc/" target="_blank" rel="external">苹果开源官网下载源码看下</a>,可以找到这句代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">define NANO_MAX_SIZE			256 /* Buckets sized &#123;16, 32, 48, 64, 80, 96, 112, ...&#125; */</div></pre></td></tr></table></figure>
<p>看来<code>NANO_MAX_SIZE</code>在申请空间的时候做完优化就是16的倍数,并且最大是256。所以<code>size = 24 ;obj = (id)calloc(1, size);</code>申请的结果是32字节。<br>然后再看下<code>Linux</code>空间申请的机制是什么？<br><a href="http://ftp.gnu.org/gnu/glibc/" target="_blank" rel="external">下载gnu资料</a>，<br>得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">#ifndef _I386_MALLOC_ALIGNMENT_H</div><div class="line">#define _I386_MALLOC_ALIGNMENT_H</div><div class="line"></div><div class="line">#define MALLOC_ALIGNMENT 16</div><div class="line"></div><div class="line">#endif /* !defined(_I386_MALLOC_ALIGNMENT_H) */</div><div class="line"></div><div class="line"></div><div class="line">/* MALLOC_ALIGNMENT is the minimum alignment for malloc&apos;ed chunks.  It</div><div class="line">   must be a power of two at least 2 * SIZE_SZ, even on machines for</div><div class="line">   which smaller alignments would suffice. It may be defined as larger</div><div class="line">   than this though. Note however that code and data structures are</div><div class="line">   optimized for the case of 8-byte alignment.  */</div><div class="line">   //最少是2倍的SIZE_SZ 或者是__alignof__(long double)</div><div class="line">#define MALLOC_ALIGNMENT (2 * SIZE_SZ &lt; __alignof__ (long double) \</div><div class="line">			  ? __alignof__ (long double) : 2 * SIZE_SZ)</div><div class="line">			  </div><div class="line">			  </div><div class="line">/* The corresponding word size.  */</div><div class="line">#define SIZE_SZ (sizeof (INTERNAL_SIZE_T))</div><div class="line"></div><div class="line">#ifndef INTERNAL_SIZE_T</div><div class="line"># define INTERNAL_SIZE_T size_t</div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>在i386中是16，在其他系统中按照宏定义计算，<br><code>__alignof__ (long double)</code>在iOS中是16,<code>size_t</code>是8，则上面的代码简写为<code>#define MALLOC_ALIGNMENT (2*8 &lt; 16 ? 16:2*8)</code>最终是16字节。</p>
<p>总结：</p>
<blockquote>
<p>实例对象其实是结构体，占用的内存是16的倍数，最少是16，由于内存对齐，实际使用的内存为M,则实际分配内存为(M%16+M/16)*16。实例对象的大小不受方法影响，受实例变量影响。</p>
</blockquote>
<ul>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="external">学习资料下载</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="external">demo 查看</a></li>
</ul>
<hr>
<p>广告时间</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/8/8/16c71b57f7f1624a?w=655&amp;h=268&amp;f=jpeg&amp;s=27083" alt=""></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/06/25/iOS 手动做一个自动打包部署神器/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="兜兜转转"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兜兜转转的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/25/iOS 手动做一个自动打包部署神器/" class="post-title-link" itemprop="url">iOS 手动做一个自动打包部署神器</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-06-25 16:39:24" itemprop="dateCreated datePublished" datetime="2019-06-25T16:39:24+08:00">2019-06-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-12-03 12:48:00" itemprop="dateModified" datetime="2019-12-03T12:48:00+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>之前使用的fastlane添加pgyer自动打包的，最近发现更新总是有问题，所以产生了自己shell做一个的想法。虽然代码比较少，但是很实用。</p>
<ul>
<li>打包</li>
<li>导出ipa</li>
<li>上传pgyer</li>
</ul>
<h4 id="打包自动上传pgyer"><a href="#打包自动上传pgyer" class="headerlink" title="打包自动上传pgyer"></a>打包自动上传pgyer</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"></div><div class="line">#xcodebuild archive -project &apos;test.xcodeproj&apos; -configuration &apos;Debug&apos; -scheme &apos;BLTSZY&apos; -archivePath &apos;./app.xcarchive&apos; LIBRARY_SEARCH_PATHS=&quot;./Pods/../build/**  ./BLTSZY/**&quot;</div><div class="line">proName=&apos;your project name&apos;</div><div class="line">proURL=&quot;your project path&quot;#like /Users/Jerry/Desktop/ios_afu</div><div class="line">api_key=&apos;&apos;#pgyer api_key</div><div class="line">configuration=&apos;Debug&apos; #Release </div><div class="line">autoPlus()&#123;</div><div class="line">path=$&#123;proURL&#125;/$&#123;proName&#125;/$&#123;proName&#125;/Info.plist</div><div class="line">number=$(/usr/libexec/PlistBuddy -c &quot;Print CFBundleVersion&quot; &quot;$&#123;path&#125;&quot;)</div><div class="line">BundleVersion=$(( $number + 1 ))</div><div class="line">/usr/libexec/PlistBuddy -c &quot;Set CFBundleVersion $BundleVersion&quot; &quot;$&#123;path&#125;&quot;</div><div class="line">&#125;</div><div class="line">#打包</div><div class="line">arch()&#123;</div><div class="line">    echo &apos;开始编译Pods&apos;</div><div class="line">    xcodebuild -project Pods/Pods.xcodeproj build</div><div class="line">    echo &apos;开始编译project&apos;</div><div class="line"></div><div class="line">xcodebuild -archivePath &quot;./build/$&#123;proName&#125;.xcarchive&quot; -workspace $proName.xcworkspace -sdk iphoneos -scheme $proName -configuration $configuration archive</div><div class="line">autoPlus</div><div class="line">&#125;</div><div class="line">#导出ipa</div><div class="line">exportIPA()&#123;</div><div class="line">    echo &apos;开始导出ipa&apos;</div><div class="line">    xcodebuild -exportArchive -archivePath &quot;./build/$&#123;proName&#125;.xcarchive&quot; -exportPath &apos;./app&apos; -exportOptionsPlist &apos;./ExportOptions.plist&apos;</div><div class="line">&#125;</div><div class="line">#上传ipa到蒲公英</div><div class="line">upload()&#123;</div><div class="line">if [ -e &quot;$&#123;proURL&#125;/app/$&#123;proName&#125;.ipa&quot; ]</div><div class="line">then</div><div class="line">    echo &apos;开始上传ipa/apk到蒲公英&apos;</div><div class="line">    curl -F &quot;file=@$&#123;proURL&#125;/app/$&#123;proName&#125;.ipa&quot; -F &quot;_api_key=$&#123;api_key&#125;&quot; &apos;http://www.pgyer.com/apiv2/app/upload&apos;</div><div class="line">else</div><div class="line">    echo &quot;在目录：$&#123;proURL&#125;/app/$&#123;proName&#125;.ipa 不存在&quot;</div><div class="line">fi</div><div class="line">&#125;</div><div class="line">startarch()&#123;</div><div class="line">    arch</div><div class="line">    if (($? == 0))</div><div class="line">    then</div><div class="line">        echo &apos;archive success🍺&apos;</div><div class="line">        startExportIPA</div><div class="line">    else</div><div class="line">        echo &apos;archive faild❌&apos;</div><div class="line">    fi</div><div class="line">&#125;</div><div class="line">startExportIPA()&#123;</div><div class="line">    exportIPA</div><div class="line">    if(($? == 0))</div><div class="line">    then</div><div class="line">        echo &apos;exportIPA success🍺🍺&apos;</div><div class="line">        startUPLoadIPA</div><div class="line">    else</div><div class="line">        echo &apos;exportIPA faild ❌&apos;</div><div class="line">    fi</div><div class="line">&#125;</div><div class="line">startUPLoadIPA()&#123;</div><div class="line">    upload</div><div class="line">    if(($? == 0))</div><div class="line">    then</div><div class="line">        echo &apos;uploadIPA success&apos;</div><div class="line">    else</div><div class="line">        echo &apos;uploadIPA faild ❌&apos;</div><div class="line">    fi</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">if (($# == 0))</div><div class="line">#then</div><div class="line">#    startarch</div><div class="line">#elif (($# == 1))</div><div class="line">then</div><div class="line">        while :</div><div class="line">        do</div><div class="line">        echo &apos;🍺🍺🍺***********************🍺🍺🍺&apos;</div><div class="line">        echo  &quot;输入 1 到 4 之间的数字:&quot;</div><div class="line">        echo  &quot;输入 1:从编译打包开始至结束&quot;</div><div class="line">        echo  &quot;输入 2:从导出IPA开始至结束&quot;</div><div class="line">        echo  &quot;输入 3:从上传ipa开始至结束&quot;</div><div class="line">        echo  &quot;输入 4:退出&quot;</div><div class="line">        read a</div><div class="line">        case $a in</div><div class="line">            1)startarch</div><div class="line">            break;;</div><div class="line">            2)startExportIPA</div><div class="line">            break;;</div><div class="line">            3)startUPLoadIPA</div><div class="line">            break;;</div><div class="line">            4) break;;</div><div class="line">        esac</div><div class="line">        done</div><div class="line">fi</div></pre></td></tr></table></figure>
<p>将该文件和plis拖到project目录下，然后配置<br>plis文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</div><div class="line">&lt;plist version=&quot;1.0&quot;&gt;</div><div class="line">&lt;dict&gt;</div><div class="line">	&lt;key&gt;compileBitcode&lt;/key&gt;</div><div class="line">	&lt;false/&gt;</div><div class="line">	&lt;key&gt;method&lt;/key&gt;</div><div class="line">	&lt;string&gt;ad-hoc&lt;/string&gt;</div><div class="line">	&lt;key&gt;provisioningProfiles&lt;/key&gt;</div><div class="line">	&lt;dict&gt;</div><div class="line">		&lt;key&gt;your bundle id&lt;/key&gt;</div><div class="line">		&lt;string&gt;your .mobileprovsion&lt;/string&gt;</div><div class="line">	&lt;/dict&gt;</div><div class="line">	&lt;key&gt;signingCertificate&lt;/key&gt;</div><div class="line">	&lt;string&gt;iPhone Distribution&lt;/string&gt;</div><div class="line">	&lt;key&gt;signingStyle&lt;/key&gt;</div><div class="line">	&lt;string&gt;manual&lt;/string&gt;</div><div class="line">	&lt;key&gt;stripSwiftSymbols&lt;/key&gt;</div><div class="line">	&lt;true/&gt;</div><div class="line">	&lt;key&gt;teamID&lt;/key&gt;</div><div class="line">	&lt;string&gt;your_team_id&lt;/string&gt;</div><div class="line">	&lt;key&gt;thinning&lt;/key&gt;</div><div class="line">	&lt;string&gt;&amp;lt;none&amp;gt;&lt;/string&gt;</div><div class="line">&lt;/dict&gt;</div><div class="line">&lt;/plist&gt;</div></pre></td></tr></table></figure></p>
<p>下载<code>setup.sh</code>拖到项目文件夹内，然后<br>运行<code>./setup.sh</code>，即可完成上传到pgyer网站。<br>具体的配置属性见源码下载页面。<br><a href="https://github.com/ifgyong/autoAEU" target="_blank" rel="external">查看源码</a></p>
<p>```</p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/06/24/iOS 浅析指针、函数、typedef/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="兜兜转转"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兜兜转转的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/06/24/iOS 浅析指针、函数、typedef/" class="post-title-link" itemprop="url">iOS 浅析指针、函数、typedef</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2019-06-24 16:39:24" itemprop="dateCreated datePublished" datetime="2019-06-24T16:39:24+08:00">2019-06-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-12-03 12:48:00" itemprop="dateModified" datetime="2019-12-03T12:48:00+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="指针函数和函数指针"><a href="#指针函数和函数指针" class="headerlink" title="指针函数和函数指针"></a>指针函数和函数指针</h4><p>顾名思义，指针函数即返回指针的函数。其一般定义形式如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">类型名 *函数名(函数参数表列);</div></pre></td></tr></table></figure>
<p>其中，后缀运算符括号<code>“()”</code>表示这是一个函数，其前缀运算符星号<code>“*”</code>表示此函数为指针型函数，其函数值为指针，即它带回来的值的类型为指针，当调用这个函数后，将得到一个“指向返回值为…的指针（地址），“类型名”表示函数返回的指针指向的类型”。</p>
<p><code>“(函数参数表列)”</code>中的括号为函数调用运算符，在调用语句中，即使函数不带参数，其参数表的一对括号也不能省略。其示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int *pfun(int, int);</div></pre></td></tr></table></figure>
<p>由于<code>“*”</code>的优先级低于<code>“()”</code>的优先级，因而pfun首先和后面的<code>“()”</code>结合，也就意味着，pfun是一个函数。即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int *(pfun(int, int));</div></pre></td></tr></table></figure>
<p>接着再和前面的<code>“*”</code>结合，说明这个函数的返回值是一个指针。由于前面还有一个int，也就是说，pfun是一个返回值为整型指针的函数。<br>我们不妨来再看一看，指针函数与函数指针有什么区别？</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int (*pfun)(int, int);</div></pre></td></tr></table></figure>
<p>通过括号强行将pfun首先与<code>“*”</code>结合，也就意味着，pfun是一个指针，接着与后面的<code>“()”</code>结合，说明该指针指向的是一个函数，然后再与前面的int结合，也就是说，该函数的返回值是int。由此可见，pfun是一个指向返回值为int的函数的指针。</p>
<p>虽然它们只有一个括号的差别，但是表示的意义却截然不同。函数指针的本身是一个指针，指针指向的是一个函数。指针函数的本身是一个函数，其函数的返回值是一个指针。</p>
<p>用函数指针作为指针函数的返回值<br>在上面提到的指针函数里面，有这样一类函数，它们也返回指针型数据（地址），但是这个指针不是指向int、char之类的基本类型，而是指向函数。对于初学者，别说写出这样的函数声明，就是看到这样的写法也是一头雾水。比如,下面的语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int (*ff(int))(int *, int);</div></pre></td></tr></table></figure>
<p>我们用上面介绍的方法分析一下，ff首先与后面的<code>“()”</code>结合，即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int (*(ff(int)))(int *, int);</div></pre></td></tr></table></figure>
<p>用括号将<code>ff(int)</code>再括起来也就意味着，<code>ff</code>是一个函数。<br>接着与前面的<code>“*”</code>结合，说明<code>ff</code>函数的返回值是一个指针。然后再与后面的<code>“()”</code>结合，也就是说，该指针指向的是一个函数。</p>
<p>这种写法确实让人非常难懂，以至于一些初学者产生误解，认为写出别人看不懂的代码才能显示自己水平高。而事实上恰好相反，能否写出通俗易懂的代码是衡量程序员是否优秀的标准。一般来说，用typedef关键字会使该声明更简单易懂。在前面我们已经见过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int (*PF)(int *, int);</div></pre></td></tr></table></figure>
<p>也就是说，PF是一个函数指针“变量”。当使用typedef声明后，则PF就成为了一个函数指针<code>“类型”</code>，即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">typedef int (*PF)(int *, int);</div></pre></td></tr></table></figure>
<p>这样就定义了返回值的类型。然后，再用PF作为返回值来声明函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PF ff(int);</div></pre></td></tr></table></figure>
<h4 id="深入理解-typedef"><a href="#深入理解-typedef" class="headerlink" title="深入理解 typedef"></a>深入理解 typedef</h4><p>平时我们在OC中的使用写法，但是对<code>typedef</code>困惑。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">typedef &lt;#returnType#&gt;(^&lt;#name#&gt;)(&lt;#arguments#&gt;);//typedefBlock Code Snippets</div><div class="line"></div><div class="line">typedef void (^RWAlertViewCompletionBlock)(UIAlertView *alertView, NSInteger buttonIndex);</div></pre></td></tr></table></figure></p>
<p>然后可以通过<code>RWAlertViewCompletionBlock</code>当成block类型直接使用了。<br>然后看下<code>libffi</code>的用法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">typedef enum &#123;</div><div class="line">  FFI_OK = 0,</div><div class="line">  FFI_BAD_TYPEDEF,</div><div class="line">  FFI_BAD_ABI</div><div class="line">&#125; ffi_status;</div><div class="line">typedef int INT64;//INT64 其实是int</div></pre></td></tr></table></figure></p>
<p>使用起来的话：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ffi_status status;//声明一个类型是ffi_status的参数</div><div class="line">INT64 age;//声明一个age 类型是INT64</div></pre></td></tr></table></figure></p>
<p>现在block也可以是函数指针了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">int (*PF)(int *, int);</div><div class="line">//也就是说，PF是一个函数指针“变量”。当使用typedef声明后，则PF就成为了一个函数指针“类型”，即：</div><div class="line">typedef int (*PF)(int *, int);</div></pre></td></tr></table></figure></p>
<p><strong>typedef的语法规则其实很简单，一句话来说就是定义对象的语法前加关键字typedef，剩下的不变，原本定义的对象标识符换成类型标识符，对应语义从定义一个对象改成定义一个类型别名。typedef看起来复杂根本原因是对象定义的语法比较复杂，例如分隔符*和[]的用法。</strong><br>针对经典的const来个例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">typedef char * pStr;</div><div class="line">char string[4] = &quot;abc&quot;;</div><div class="line">const char *p1 = string;</div><div class="line">const pStr p2 = string;</div><div class="line">p1++;</div><div class="line">p2++;//error</div></pre></td></tr></table></figure></p>
<p>那么为什么<code>p2++</code>为什么会报错呢？<br>我们来分析一下，<code>const char *p1 = string;</code>是声明了一个<code>const char</code>的指针，不可变的是<code>char</code>,相当于<code>(const char)*p=string</code>,所以<code>p1++</code>不会报错。<code>p2++</code>报错根本原因是<code>p2</code>是不可变的，<code>const pStr p2 = string</code>相当于<code>const (char *) p2 = string</code>,<code>const</code>修饰的是<code>char *</code>，所以<code>p2</code>不可改变。<code>p1</code>是数组，<code>p2</code>是固定的值。</p>
<h4 id="typedef如何使用呢？"><a href="#typedef如何使用呢？" class="headerlink" title="typedef如何使用呢？"></a><code>typedef</code>如何使用呢？</h4><p>我们具体看几个案例分析一下。</p>
<p>案例1：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int (*b) (void (*)());</div></pre></td></tr></table></figure></p>
<p>简化一下是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">typedef  void (*func)()</div><div class="line">typedef  int (*ifunc)(func)</div></pre></td></tr></table></figure></p>
<p>最终简化成<code>ifunc b;</code>。可以理解成<code>(void (*)())</code>是一个<code>func</code>,然后替换<code>func</code>成了最终的形参是<code>func</code>，返回值是<code>int</code>。</p>
<p>案例2分析：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">int (*func)(int *p);</div></pre></td></tr></table></figure></p>
<p>首先找到<code>func</code>，<code>func</code>左边是<code>*</code>，说明<code>func</code>是个指针，然后跳出这个圆括号，先看右边，又遇到圆括号，这说明<code>(*func)</code>是一个函数，所以<br>func是一个指向这类函数的指针，即函数指针，这类函数具有<code>int*</code>类型的形参，返回值类型是<code>int</code>。</p>
<p>综合案例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">SEL didload = @selector(viewDidLoad);</div><div class="line">Method md = class_getInstanceMethod(aclass, didload);</div><div class="line">IMP load = method_getImplementation(md);</div><div class="line">void(*loadFunc)(id,SEL) = (void *)load;</div></pre></td></tr></table></figure></p>
<p>这是将SEL获取了Method之后将IMP转化成<code>void(*loadFunc)(id,SEL)</code>，调用的时候可以直接调用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//执行ViewDidLoad IMP</div><div class="line"> loadFunc(aclass,NULL);</div></pre></td></tr></table></figure></p>
<p>Method可以这样使用，block同样也可以这样使用:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">void (^block)(id _self) = ^(id _self)&#123;</div><div class="line">    //code here</div><div class="line">&#125;;</div><div class="line">void(*func)(id,SEL) = (void*)imp_implementationWithBlock(block);</div><div class="line">class_replaceMethod(aclass, didload, (IMP)func, method_getTypeEncoding(md));</div></pre></td></tr></table></figure></p>
<p>这可以直接使用<code>runtime/message.h</code>函数<code>imp_implementationWithBlock</code>将<code>block</code>转化成<code>IMP</code>,使用<code>class_replaceMethod</code>替换某个函数的<code>IMP</code>。那么再调用该函数的时候，则是调用的<code>block</code>的<code>IMP</code>。获取<code>method</code>和<code>block</code>参数后续再分析。</p>
<p>资料参考：</p>
<p><a href="http://yulingtianxia.com/blog/2014/04/17/han-shu-zhi-zhen-yu-zhi-zhen-han-shu/" target="_blank" rel="external">玉令天下博客地址</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2018/05/28/Python3 Flask bootstrap教程(2)/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="兜兜转转"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兜兜转转的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/05/28/Python3 Flask bootstrap教程(2)/" class="post-title-link" itemprop="url">Python3 Flask bootstrap教程(2)</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2018-05-28 12:02:22" itemprop="dateCreated datePublished" datetime="2018-05-28T12:02:22+08:00">2018-05-28</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-12-03 12:48:00" itemprop="dateModified" datetime="2019-12-03T12:48:00+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python3/" itemprop="url" rel="index"><span itemprop="name">Python3</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1.蓝图<br>2.Nav的使用<br>3.mysql使用<br>4.模板的使用</p>
<h3 id="蓝图使用"><a href="#蓝图使用" class="headerlink" title="蓝图使用"></a>蓝图使用</h3><p>新建user文件夹,在user文件夹下变新建tamplates，还有<strong>init</strong>.py和views.py<br><strong>init.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from flask import Blueprint</div><div class="line">//声明蓝图</div><div class="line">user = Blueprint(&apos;user&apos;, __name__,template_folder=&apos;templates&apos;)</div><div class="line"></div><div class="line">from api.v1.user import views</div></pre></td></tr></table></figure></p>
<p>然后在run.py中注册蓝图<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">先导入</div><div class="line">from api.v1.user import user</div><div class="line"></div><div class="line">app.register_blueprint(user,url_prefix=&apos;/user&apos;) 后边的是路径</div></pre></td></tr></table></figure></p>
<p>然后在user的views中就可以写方法了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">from flask import Flask, request, jsonify,render_template</div><div class="line">from flask.json import tojson_filter</div><div class="line">from api.v1.user import user</div><div class="line">from api.v1 import first</div><div class="line">import pymysql</div><div class="line">import sys</div><div class="line">import json</div><div class="line">from flask_bootstrap import Bootstrap</div><div class="line">//路由</div><div class="line">@user.route(&apos;/&apos;,methods=[&apos;GET&apos;,&apos;POST&apos;])</div><div class="line">//方法</div><div class="line">def my_index():</div><div class="line">    args = request.args;</div><div class="line">    age = &apos;&apos;</div><div class="line">    name = &apos;&apos;</div><div class="line">    if args.__contains__(&apos;name&apos;):</div><div class="line">        name = request.args.getlist(key=&apos;name&apos;)</div><div class="line">    if args.__contains__(&apos;age&apos;):</div><div class="line">        age = request.args.__getitem__(&apos;age&apos;)</div><div class="line">//返回数据是json</div><div class="line">    return jsonify(&#123;&apos;method&apos;:sys._getframe().f_code.co_name,</div><div class="line">                    &apos;name&apos;:str(name),</div><div class="line">                    &apos;age&apos;:age&#125;)</div></pre></td></tr></table></figure></p>
<p>现在我们想返回一个html，那么就在tamplates中新建一个index.html<br>代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html lang=&quot;en&quot;&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</div><div class="line">    &lt;title&gt;结果&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;h1&gt;helloword&lt;/h1&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure></p>
<p>然后在views中增加路由<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">@user.route(&apos;/helloword&apos;)</div><div class="line">def helloword():</div><div class="line">    return render_template(&apos;helloword.html&apos;)</div></pre></td></tr></table></figure></p>
<p>运行程序,输入地址<code>127.0.0.1：5000/helloword</code>，出现helloword，就算我们的程序跑起来了。</p>
<h3 id="Nav的使用"><a href="#Nav的使用" class="headerlink" title="Nav的使用"></a>Nav的使用</h3><p>nav就是html的头部或者banner，我们写一个简单的例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">&lt;ul class=&quot;nav nav-tabs&quot;&gt;</div><div class="line">    &lt;li role=&quot;presentation&quot; class=&quot;dropdown&quot; id=&quot;myDropdown&quot;&gt;</div><div class="line">        &lt;a class=&quot;dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;  data-target=&quot;#&quot; role=&quot;button&quot; aria-haspopup=&quot;true&quot;</div><div class="line">           aria-expanded=&quot;false&quot;&gt;</div><div class="line">            主页 &lt;span class=&quot;caret&quot; id=&quot;page1&quot;&gt;&lt;/span&gt;</div><div class="line">        &lt;/a&gt;</div><div class="line">        &lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot; aria-labelledby=&quot;page1&quot;&gt;</div><div class="line">            &lt;li role=&quot;presentation&quot;&gt;</div><div class="line">                &lt;a role=&quot;menuitem&quot; href=&quot;add&quot;&gt;添加&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li role=&quot;presentation&quot;&gt;</div><div class="line">                &lt;a role=&quot;menuitem&quot; href=&quot;list&quot;&gt;列表&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">        &lt;/ul&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line">    &lt;li class=&quot;dropdown&quot;  &gt;</div><div class="line">        &lt;a class=&quot;dropdown-toggle&quot; id=&quot;group2&quot; data-toggle=&quot;dropdown&quot; href=&quot;#&quot; role=&quot;button&quot;&gt;</div><div class="line">            文章 &lt;span class=&quot;caret&quot;&gt;&lt;/span&gt;</div><div class="line">        &lt;/a&gt;</div><div class="line">        &lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot; aria-labelledby=&quot;group2&quot;&gt;</div><div class="line">            &lt;li role=&quot;presentation&quot;&gt;</div><div class="line">                 &lt;a role=&quot;menuitem&quot; href=&quot;add&quot;&gt;添加&lt;/a&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">            &lt;li role=&quot;presentation&quot;&gt;</div><div class="line">                 &lt;a role=&quot;menuitem&quot; href=&quot;list&quot;&gt;列表&lt;/a&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">            &lt;li role=&quot;presentation&quot;&gt;</div><div class="line">                 &lt;a role=&quot;menuitem&quot; href=&quot;list&quot;&gt;列表&lt;/a&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">        &lt;/ul&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line"></div><div class="line">    &lt;li class=&quot;active&quot; role=&quot;presentation&quot;&gt;</div><div class="line">        &lt;a class=&quot;dropdown-toggle&quot; data-toggle=&quot;&quot; href=&quot;#&quot; role=&quot;button&quot; aria-haspopup=&quot;true&quot; aria-expanded=&quot;false&quot;&gt;</div><div class="line">            关于</div><div class="line">        &lt;/a&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line">&lt;/ul&gt;</div></pre></td></tr></table></figure></p>
<p>这里边有一个ul 套着一个li，一个li套着一个ul，第二个 ul就是二级菜单。</p>
<h3 id="mysql使用"><a href="#mysql使用" class="headerlink" title="mysql使用"></a>mysql使用</h3><p>本地需要装环境mysql，用户是root，密码是123456，数据库是test，格式是utf8。下边是我们一个函数返回查询到的表中所有user的名字和年龄。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">def userList():</div><div class="line">    con = pymysql.connect(&apos;127.0.0.1&apos;, &apos;root&apos;, &apos;123456&apos;, &apos;test&apos;, charset=&apos;utf8&apos;)  # 添加utf8 否则中文乱码</div><div class="line">    cur = con.cursor()</div><div class="line">    cur.execute(&apos;select * from user&apos;)</div><div class="line">    nums = cur.rownumber</div><div class="line">    all = cur.fetchall()</div><div class="line">    data = []</div><div class="line">    for i in range(len(all)):</div><div class="line">        one = all[i]</div><div class="line">        data.append(&#123;&apos;name&apos;: str(one[1]),</div><div class="line">                     &apos;age&apos;: one[2]&#125;)</div><div class="line"></div><div class="line">    con.close()</div><div class="line">    return data</div></pre></td></tr></table></figure></p>
<h3 id="模板的使用"><a href="#模板的使用" class="headerlink" title="模板的使用"></a>模板的使用</h3><p>模板是需要我们在模板中先定义一个空的block，然后在继承这个html，把这个block给添加上，等于把一个html文件分拆成多个文件，也可以理解成组件化。添加一个base.html<br>代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html&gt;</div><div class="line">&lt;html lang=&quot;zh-CN&quot;&gt;</div><div class="line">&lt;head&gt;</div><div class="line">    &lt;meta charset=&quot;utf-8&quot;&gt;</div><div class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</div><div class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no&quot;&gt;</div><div class="line">    &lt;!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ --&gt;</div><div class="line">    &lt;title&gt;Bootstrap 101 Template&lt;/title&gt;</div><div class="line">    &lt;!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) --&gt;</div><div class="line">&lt;script src=&quot;https://cdn.bootcss.com/jquery/1.12.4/jquery.min.js&quot;&gt;&lt;/script&gt;</div><div class="line">&lt;!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 --&gt;</div><div class="line">&lt;script src=&quot;https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;</div><div class="line"></div><div class="line">    &lt;!-- Bootstrap --&gt;</div><div class="line">    &lt;link href=&quot;https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</div><div class="line"></div><div class="line">    &lt;!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 --&gt;</div><div class="line">    &lt;!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 --&gt;</div><div class="line">    &lt;!--[if lt IE 9]&gt;</div><div class="line">      &lt;script src=&quot;https://cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js&quot;&gt;&lt;/script&gt;</div><div class="line">      &lt;script src=&quot;https://cdn.bootcss.com/respond.js/1.4.2/respond.min.js&quot;&gt;&lt;/script&gt;</div><div class="line">    &lt;![endif]--&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;ul class=&quot;nav nav-tabs&quot;&gt;</div><div class="line">    &lt;li role=&quot;presentation&quot; class=&quot;dropdown&quot; id=&quot;myDropdown&quot;&gt;</div><div class="line">        &lt;a class=&quot;dropdown-toggle&quot; data-toggle=&quot;dropdown&quot;  data-target=&quot;#&quot; role=&quot;button&quot; aria-haspopup=&quot;true&quot;</div><div class="line">           aria-expanded=&quot;false&quot;&gt;</div><div class="line">            主页 &lt;span class=&quot;caret&quot; id=&quot;page1&quot;&gt;&lt;/span&gt;</div><div class="line">        &lt;/a&gt;</div><div class="line">        &lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot; aria-labelledby=&quot;page1&quot;&gt;</div><div class="line">            &lt;li role=&quot;presentation&quot;&gt;</div><div class="line">                &lt;a role=&quot;menuitem&quot; href=&quot;add&quot;&gt;添加&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;li role=&quot;presentation&quot;&gt;</div><div class="line">                &lt;a role=&quot;menuitem&quot; href=&quot;list&quot;&gt;列表&lt;/a&gt;&lt;/li&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">        &lt;/ul&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line">    &lt;li class=&quot;dropdown&quot;  &gt;</div><div class="line">        &lt;a class=&quot;dropdown-toggle&quot; id=&quot;group2&quot; data-toggle=&quot;dropdown&quot; href=&quot;#&quot; role=&quot;button&quot;&gt;</div><div class="line">            文章 &lt;span class=&quot;caret&quot;&gt;&lt;/span&gt;</div><div class="line">        &lt;/a&gt;</div><div class="line">        &lt;ul class=&quot;dropdown-menu&quot; role=&quot;menu&quot; aria-labelledby=&quot;group2&quot;&gt;</div><div class="line">            &lt;li role=&quot;presentation&quot;&gt;</div><div class="line">                 &lt;a role=&quot;menuitem&quot; href=&quot;add&quot;&gt;添加&lt;/a&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">            &lt;li role=&quot;presentation&quot;&gt;</div><div class="line">                 &lt;a role=&quot;menuitem&quot; href=&quot;list&quot;&gt;列表&lt;/a&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">            &lt;li role=&quot;presentation&quot;&gt;</div><div class="line">                 &lt;a role=&quot;menuitem&quot; href=&quot;list&quot;&gt;列表&lt;/a&gt;</div><div class="line">            &lt;/li&gt;</div><div class="line">        &lt;/ul&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line"></div><div class="line">    &lt;li class=&quot;active&quot; role=&quot;presentation&quot;&gt;</div><div class="line">        &lt;a class=&quot;dropdown-toggle&quot; data-toggle=&quot;&quot; href=&quot;#&quot; role=&quot;button&quot; aria-haspopup=&quot;true&quot; aria-expanded=&quot;false&quot;&gt;</div><div class="line">            关于</div><div class="line">        &lt;/a&gt;</div><div class="line">    &lt;/li&gt;</div><div class="line">&lt;/ul&gt;</div><div class="line">这下边就是定义的缺少的block</div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>
<p>然后我们在子网页中继承这个模板并且添加上去block<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">//继承刚才的网页</div><div class="line">&#123;% extends &apos;base.html&apos; %&#125;</div><div class="line">//下边的block的对应刚才定义的代码块，对应不上的话，会展现不出来下边的代码</div><div class="line">&#123;% block page_content %&#125;</div><div class="line">&lt;div class=&quot;pager&quot;&gt;</div><div class="line">    &lt;h1 align=&quot;center&quot;&gt;用户列表&lt;/h1&gt;</div><div class="line"></div><div class="line">    &lt;table class=&quot;table nav-tabs&quot;&gt;</div><div class="line">        &#123;% for i in data %&#125;</div><div class="line">            &lt;tr&gt;</div><div class="line">                &lt;td&gt;名字：&#123;&#123; i.name &#125;&#125;&lt;/td&gt;</div><div class="line">                &lt;td&gt;年龄：&#123;&#123; i.age &#125;&#125;&lt;/td&gt;</div><div class="line">            &lt;/tr&gt;</div><div class="line">        &#123;% endfor %&#125;</div><div class="line">        &lt;tr&gt;</div><div class="line">            &lt;td align=&quot;center&quot;&gt;</div><div class="line">                &lt;a href=&quot;add&quot;&gt;</div><div class="line">                    &lt;input type=&quot;button&quot; value=&quot;添加用户&quot;  align=&quot;center&quot; style=&quot;width: 200px&quot;&gt;</div><div class="line">                &lt;/a&gt;</div><div class="line">            &lt;/td&gt;</div><div class="line">            &lt;td align=&quot;center&quot;&gt;</div><div class="line">                &lt;a href=&quot;list&quot; &gt;</div><div class="line">                    &lt;input type=&quot;button&quot;  value=&quot;用户列表&quot; style=&quot;width: 200px&quot;&gt;</div><div class="line">                &lt;/a&gt;</div><div class="line">            &lt;/td&gt;</div><div class="line">        &lt;/tr&gt;</div><div class="line">    &lt;/table&gt;</div><div class="line">&lt;/div&gt;</div><div class="line">&#123;% endblock %&#125;</div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2018/05/27/Python3 Flask bootstrap教程(1)/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="兜兜转转"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兜兜转转的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/05/27/Python3 Flask bootstrap教程(1)/" class="post-title-link" itemprop="url">Python3 Flask bootstrap教程(1)</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2018-05-27 12:02:22" itemprop="dateCreated datePublished" datetime="2018-05-27T12:02:22+08:00">2018-05-27</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-12-03 12:48:00" itemprop="dateModified" datetime="2019-12-03T12:48:00+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python3/" itemprop="url" rel="index"><span itemprop="name">Python3</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>1.安装Flask<br>2.安装bootstrap<br>3.HelloWord</p>
<h3 id="安装Flask"><a href="#安装Flask" class="headerlink" title="安装Flask"></a>安装Flask</h3><p>我用的py3，所以安装命令是：<br><code>pip3 install Flask</code>，安装之后，在Pycharm里边看到是这样子的，<br><img src="https://upload-images.jianshu.io/upload_images/783986-a4a6c6ec9ceee10a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="py3第三方库列表"></p>
<h3 id="安装bootstrap"><a href="#安装bootstrap" class="headerlink" title="安装bootstrap"></a>安装bootstrap</h3><p>安装bootstrap，看这里<a href="https://v2.bootcss.com/index.html" target="_blank" rel="external">官方教程</a>,<br>或者<a href="http://getbootstrap.com/2.3.2/assets/bootstrap.zip" target="_blank" rel="external">下载</a>，然后解压，放到Flask的目录下边。我的目录是这样子的<br><img src="https://upload-images.jianshu.io/upload_images/783986-be66520f42984dda.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="目录"></p>
<h3 id="HelloWord"><a href="#HelloWord" class="headerlink" title="HelloWord"></a>HelloWord</h3><p>初始化Flask，<br>新建app.py<br>代码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">from flask import Flask, request, jsonify</div><div class="line">import os</div><div class="line">from api.v1 import config</div><div class="line">from api.v1.user import user</div><div class="line">from flask_bootstrap import Bootstrap</div><div class="line"></div><div class="line">app = Flask(__name__)</div><div class="line">Bootstrap(app)</div><div class="line">app.config.from_object(config)</div><div class="line">app.register_blueprint(user,url_prefix=&apos;/user&apos;)</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    app.run()</div></pre></td></tr></table></figure></p>
<p>选中文件，右键-&gt;run。这样子就跑起来了，好像现在没接口，那我们添加一个路由.<br>完整代码如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">app = Flask(__name__)</div><div class="line">Bootstrap(app)</div><div class="line">app.config.from_object(config)</div><div class="line">app.register_blueprint(user,url_prefix=&apos;/user&apos;)</div><div class="line">@app.route(&apos;/index&apos;)//添加路由</div><div class="line">def my_index()://路由执行的函数</div><div class="line">    return jsonify(&#123;&quot;key&quot;:&apos;helloWord&apos;&#125;)//返回数据</div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    app.run()//app运行</div></pre></td></tr></table></figure></p>
<p><img src="https://upload-images.jianshu.io/upload_images/783986-435882bd99cf0aa0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="helloword"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2018/05/10/Python3 PyQt5教程(2)/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="兜兜转转"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兜兜转转的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/05/10/Python3 PyQt5教程(2)/" class="post-title-link" itemprop="url">Python3 PyQt5教程(2)</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2018-05-10 16:39:24" itemprop="dateCreated datePublished" datetime="2018-05-10T16:39:24+08:00">2018-05-10</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-12-03 12:48:00" itemprop="dateModified" datetime="2019-12-03T12:48:00+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python/" itemprop="url" rel="index"><span itemprop="name">Python</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>大家关注的教程2来了。<br>第一期是代码布局，现在有更高级的布局方式，那就是Qt5，布局完UI可以用PythonUIC命令转成py文件，添加<code>import</code>和</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    app = QApplication(sys.argv)</div><div class="line">    widget = QMainWindow(None)</div><div class="line">    Ui_MainWindow().setupUi(widget)</div><div class="line"></div><div class="line">    sys.exit(app.exec_())</div><div class="line">    pass</div></pre></td></tr></table></figure>
<p>1.登陆界面<br>2.一个QTproject新建多个视图<br>3.在窗体中打开新窗体<br>4.安装QT</p>
<h3 id="1-登陆"><a href="#1-登陆" class="headerlink" title="1.登陆"></a>1.登陆</h3><p>用QT可视化编程拖出来的界面就是这个样子，用命令<code>pyuic5 -o target.py fromfile.ui</code>转化成py文件，代码如下<br><img src="../1.png" alt="登陆"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line"># -*- coding: utf-8 -*-</div><div class="line"></div><div class="line"># Form implementation generated from reading ui file &apos;mainwindow.ui&apos;</div><div class="line">#</div><div class="line"># Created by: PyQt5 UI code generator 5.10.1</div><div class="line">#</div><div class="line"># WARNING! All changes made in this file will be lost!</div><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line"># @Time    : 2018/5/9 下午1:36</div><div class="line"># @Author  : fgyong 简书:_兜兜转转_  https://www.jianshu.com/u/6d1254c1d145</div><div class="line"># @Site    : http://fgyong.cn 兜兜转转的技术博客</div><div class="line"># @File    : *.py</div><div class="line"># @Software: PyCharm</div><div class="line"></div><div class="line"></div><div class="line">from PyQt5 import QtCore, QtGui, QtWidgets</div><div class="line">import sys</div><div class="line">from PyQt5.QtCore import *</div><div class="line">from PyQt5.QtWidgets import *</div><div class="line"></div><div class="line">class Ui_MainWindow(object):</div><div class="line">    def setupUi(self, MainWindow):</div><div class="line">        MainWindow.setObjectName(&quot;MainWindow&quot;)</div><div class="line">        MainWindow.resize(500, 341)</div><div class="line">        MainWindow.move(1500,300)</div><div class="line">        MainWindow.setWindowOpacity(1.0)</div><div class="line">        MainWindow.setAutoFillBackground(True)</div><div class="line">        self.centralWidget = QtWidgets.QWidget(MainWindow)</div><div class="line">        self.centralWidget.setObjectName(&quot;centralWidget&quot;)</div><div class="line">        self.accountLabel = QtWidgets.QLabel(self.centralWidget)</div><div class="line">        self.accountLabel.setGeometry(QtCore.QRect(80, 110, 60, 21))</div><div class="line">        self.accountLabel.setAlignment(QtCore.Qt.AlignCenter)</div><div class="line">        self.accountLabel.setObjectName(&quot;accountLabel&quot;)</div><div class="line">        self.pwdLabel = QtWidgets.QLabel(self.centralWidget)</div><div class="line">        self.pwdLabel.setGeometry(QtCore.QRect(80, 150, 60, 21))</div><div class="line">        self.pwdLabel.setAlignment(QtCore.Qt.AlignCenter)</div><div class="line">        self.pwdLabel.setObjectName(&quot;pwdLabel&quot;)</div><div class="line">        self.account = QtWidgets.QLineEdit(self.centralWidget)</div><div class="line">        self.account.setGeometry(QtCore.QRect(140, 110, 191, 21))</div><div class="line">        self.account.setObjectName(&quot;account&quot;)</div><div class="line">        self.password = QtWidgets.QLineEdit(self.centralWidget)</div><div class="line">        self.password.setGeometry(QtCore.QRect(140, 150, 191, 21))</div><div class="line">        self.password.setObjectName(&quot;password&quot;)</div><div class="line">        self.pushButton = QtWidgets.QPushButton(self.centralWidget)</div><div class="line">        self.pushButton.setGeometry(QtCore.QRect(140, 191, 201, 41))</div><div class="line">        self.pushButton.setObjectName(&quot;pushButton&quot;)</div><div class="line">        MainWindow.setCentralWidget(self.centralWidget)</div><div class="line">        self.menuBar = QtWidgets.QMenuBar(MainWindow)</div><div class="line">        self.menuBar.setGeometry(QtCore.QRect(0, 0, 500, 22))</div><div class="line">        self.menuBar.setFocusPolicy(QtCore.Qt.ClickFocus)</div><div class="line">        self.menuBar.setContextMenuPolicy(QtCore.Qt.ActionsContextMenu)</div><div class="line">        self.menuBar.setInputMethodHints(QtCore.Qt.ImhNone)</div><div class="line">        self.menuBar.setObjectName(&quot;menuBar&quot;)</div><div class="line">        MainWindow.setMenuBar(self.menuBar)</div><div class="line">        self.statusBar = QtWidgets.QStatusBar(MainWindow)</div><div class="line">        self.statusBar.setObjectName(&quot;statusBar&quot;)</div><div class="line">        MainWindow.setStatusBar(self.statusBar)</div><div class="line"></div><div class="line">        self.retranslateUi(MainWindow)</div><div class="line">        QtCore.QMetaObject.connectSlotsByName(MainWindow)</div><div class="line">        MainWindow.show()</div><div class="line"></div><div class="line">    def retranslateUi(self, MainWindow):</div><div class="line">        _translate = QtCore.QCoreApplication.translate</div><div class="line">        MainWindow.setWindowTitle(_translate(&quot;MainWindow&quot;, &quot;登陆&quot;))</div><div class="line">        self.accountLabel.setText(_translate(&quot;MainWindow&quot;, &quot;账号&quot;))</div><div class="line">        self.pwdLabel.setText(_translate(&quot;MainWindow&quot;, &quot;密码&quot;))</div><div class="line">        self.pushButton.setText(_translate(&quot;MainWindow&quot;, &quot;登陆&quot;))</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    app = QApplication(sys.argv)</div><div class="line">    widget = QMainWindow(None)</div><div class="line">    Ui_MainWindow().setupUi(widget)</div><div class="line"></div><div class="line">    sys.exit(app.exec_())</div><div class="line">    pass</div></pre></td></tr></table></figure>
<h3 id="2-一个QTproject新建多个视图"><a href="#2-一个QTproject新建多个视图" class="headerlink" title="2.一个QTproject新建多个视图"></a>2.一个QTproject新建多个视图</h3><p>如图：<br><img src="https://upload-images.jianshu.io/upload_images/783986-8a352a0f49882a02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="新建UI"></p>
<p>然后在源文件-&gt;main.cpp 导入类，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">#include &quot;mainwindow.h&quot;</div><div class="line">#include &quot;dialog.h&quot;//新建的文件</div><div class="line">#include &lt;QApplication&gt;</div><div class="line"></div><div class="line">int main(int argc, char *argv[])</div><div class="line">&#123;</div><div class="line">    QApplication a(argc, argv);</div><div class="line">    MainWindow w;//默认的文件</div><div class="line">    Dialog d;//新建的文件</div><div class="line"></div><div class="line">//    w.show();//默认的注释掉</div><div class="line">    d.show();//新建的文件show</div><div class="line"></div><div class="line">    return a.exec();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后选择新建的 Dialog.ui文件点击运行按钮，运行的就是Dialog视图</p>
<h3 id="4-在窗体中打开新窗体"><a href="#4-在窗体中打开新窗体" class="headerlink" title="4.在窗体中打开新窗体"></a>4.在窗体中打开新窗体</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">class Example(QMainWindow):</div><div class="line">    def __init__(self):</div><div class="line">        super().__init__()</div><div class="line">        self.initGUI();</div><div class="line">#这一句比较关键，先声明这个窗体2等到需要show的时候在展示出来。</div><div class="line">        self.child = Exaple2()</div><div class="line">def initGUI(self):</div><div class="line">    btn = QPushButton(&apos;打开窗体&apos;, self)</div><div class="line">        btn.setToolTip(&apos;这是个btn&apos;)</div><div class="line">        btn.resize(btn.sizeHint())</div><div class="line">        btn.clicked.connect(self.showSecond)</div><div class="line">   def showSecond(self):</div><div class="line">        self.child.show()</div><div class="line"></div><div class="line">#第二个窗口</div><div class="line">class Exaple2(QWidget):</div><div class="line">    def __init__(self):</div><div class="line">        super().__init__()</div><div class="line">        self.configUI()</div><div class="line">    def configUI(self):</div><div class="line">        self.lable = QLabel(&apos;我是第二个窗体&apos;, self)</div><div class="line">        self.lable.setWordWrap(True)  # 自动换行</div><div class="line">#设置frame</div><div class="line">        self.lable.setGeometry(50, 100, 200, 50)</div><div class="line">#设置新窗体frame</div><div class="line">        self.setGeometry(500,500,300,300);</div></pre></td></tr></table></figure>
<h3 id="4-安装QT"><a href="#4-安装QT" class="headerlink" title="4.安装QT"></a>4.安装QT</h3><p>下载QT5.*<br><a href="http://mirrors.ocf.berkeley.edu/qt/archive/qt/5.8/5.8.0/qt-opensource-mac-x64-clang-5.8.0.dmg" target="_blank" rel="external">下载QT5</a><br>因为下载的dmg直接点下一步下一步安装完成<br><a href="http://doc.qt.io/archives/qt-4.8/demos.html" target="_blank" rel="external">QT的官方Demo</a></p>
<h3 id="5-新建工程"><a href="#5-新建工程" class="headerlink" title="5.新建工程"></a>5.新建工程</h3><p>1.第一步<br><img src="../2.png" alt="第一步"><br>2.第二步<br><img src="../3.png" alt="第二步"><br>3.第三步<br><img src="../4.png" alt="选择Qtwidgets"><br>4.第四步 打开视图<br><img src="../5.png" alt="打开视图"><br>5.拖拽控件<br><img src="../6.png" alt="拖拽控件"><br>6.效果图<br><img src="../7.png" alt="运行的效果图"></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2018/05/09/Python3 PyQt5教程(1)/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="兜兜转转"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="兜兜转转的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">
                
                
                <a href="/2018/05/09/Python3 PyQt5教程(1)/" class="post-title-link" itemprop="url">Python3 PyQt5教程(1)</a>
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Veröffentlicht am</span>
              

              
                
              

              <time title="Erstellt: 2018-05-09 16:39:24" itemprop="dateCreated datePublished" datetime="2018-05-09T16:39:24+08:00">2018-05-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Bearbeitet am</span>
                
                <time title="Geändert am: 2019-12-03 12:48:00" itemprop="dateModified" datetime="2019-12-03T12:48:00+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">in</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Python3/" itemprop="url" rel="index"><span itemprop="name">Python3</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Python的GUI库，新手可以先从PyQt5入手，一周精通。<br>1.HelloWord<br>2.添加button<br>3.菜单栏<br>4.textEdit<br>5.打包</p>
<h3 id="1-helloWord"><a href="#1-helloWord" class="headerlink" title="1.helloWord"></a>1.helloWord</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env python</div><div class="line"># -*- coding: utf-8 -*-</div><div class="line"># @Time    : 2018/5/9 下午1:36</div><div class="line"># @Author  : fgyong 简书:_兜兜转转_  https://www.jianshu.com/u/6d1254c1d145</div><div class="line"># @Site    : http://fgyong.cn 兜兜转转的技术博客</div><div class="line"># @File    : 12.py</div><div class="line"># @Software: PyCharm</div><div class="line">import sys,time,datetime</div><div class="line">from PyQt5.QtWidgets import (QMainWindow,QMessageBox,QWidget, QToolTip, QPushButton, QApplication, QGestureEvent,QLabel,QDesktopWidget)</div><div class="line">from PyQt5.QtGui import QFont,QIcon</div><div class="line"></div><div class="line"></div><div class="line">class Example(QWidget):</div><div class="line">  #构造函数</div><div class="line">    def __init__(self):</div><div class="line">        super().__init__()</div><div class="line">        self.initGUI();</div><div class="line">#初始化函数</div><div class="line">    def initGUI(self):</div><div class="line">#设置窗体frame</div><div class="line">         self.setGeometry(500, 300, 300, 300)</div><div class="line">#窗体title</div><div class="line">        self.setWindowTitle(&apos;我的第一个程序&apos;)</div><div class="line">#添加label</div><div class="line">        self.lable = QLabel(&apos;helloword!&apos;,self)</div><div class="line">#自动换行</div><div class="line">        self.lable.setWordWrap(True)</div><div class="line">#lable的frame</div><div class="line">        self.lable.setGeometry(50,100,200,150)</div><div class="line"></div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    app = QApplication(sys.argv)</div><div class="line">    ex = Example()</div><div class="line">    ex.show()</div><div class="line">    sys.exit(app.exec_())</div></pre></td></tr></table></figure>
<h3 id="2-添加按钮"><a href="#2-添加按钮" class="headerlink" title="2.添加按钮"></a>2.添加按钮</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">class Example(QWidget):</div><div class="line">    lable = &apos;&apos;</div><div class="line">    def __init__(self):</div><div class="line">        super().__init__()</div><div class="line">        self.initGUI();</div><div class="line"></div><div class="line">    def initGUI(self):</div><div class="line">        # QToolTip.setFont(&apos;SanSerif&apos;,10)</div><div class="line">#提示文字</div><div class="line">        self.setToolTip(&apos;&lt;b&gt;这是第一个QWidget&lt;/b&gt;&apos;)</div><div class="line">#更新时间的button</div><div class="line">        btn = QPushButton(&apos;更新时间&apos;, self)</div><div class="line">#button的提示文字</div><div class="line">        btn.setToolTip(&apos;这是个btn&apos;)</div><div class="line">#设置默认大小</div><div class="line">        btn.resize(btn.sizeHint())</div><div class="line"></div><div class="line">        btn2 = QPushButton(&apos;alert&apos;, self)</div><div class="line">        btn2.setToolTip(&apos;这是弹出alert的btn&apos;)</div><div class="line">        btn2.resize(btn.sizeHint())</div><div class="line">        btn2.move(0,60)</div><div class="line">        btn2.clicked.connect(self.showMessage)</div><div class="line"></div><div class="line">        size = self.geometry()</div><div class="line">   #绑定button的点击函数   self.showTime是函数名字后边没有（）</div><div class="line">        btn.clicked.connect(self.showTime)</div><div class="line"></div><div class="line">        self.setGeometry(1500, 300, 300, 300)</div><div class="line">        self.setWindowTitle(&apos;我的第一个程序&apos;)</div><div class="line"></div><div class="line">        self.lable = QLabel(&apos;时间：&apos;,self)</div><div class="line">        self.lable.setWordWrap(True)#自动换行</div><div class="line">        self.lable.setGeometry(50,100,200,150)</div><div class="line">        self.lable.setText(&apos;时间:&apos;+datetime.datetime.now().strftime(&apos;%Y-%m-%d %H:%M:%S&apos;))</div><div class="line">        icon = QIcon(&quot;/Users/Jerry/PycharmProjects/Flask_dmeo_1/App/icons/cry.png&quot;)</div><div class="line">        btn.setIcon(icon)</div><div class="line">        self.setWindowIcon(icon)</div><div class="line">    def showTime(self):</div><div class="line">        nowTime=datetime.datetime.now().strftime(&apos;%Y-%m-%d %H:%M:%S&apos;)</div><div class="line">        self.lable.setText(&quot;时间:&quot;+nowTime)</div><div class="line"></div><div class="line">    def showMessage(self):</div><div class="line">        self.showBox(&quot;alert message&quot;)</div><div class="line">    def showBox(self,message):</div><div class="line">        box=QMessageBox.question(self,&apos;温馨提示&apos;,message,QMessageBox.Yes|QMessageBox.No,QMessageBox.No)</div><div class="line">        if box == QMessageBox.Yes:</div><div class="line">            self.lable.setText(self.lable.text()+&apos;YES&apos;)</div><div class="line">        else:</div><div class="line">            self.lable.setText(self.lable.text() + &apos;NO&apos;)</div><div class="line">if __name__ == &apos;__main__&apos;:</div><div class="line">    app = QApplication(sys.argv)</div><div class="line">    ex = Example()</div><div class="line">    ex.show()</div><div class="line">    sys.exit(app.exec_())</div></pre></td></tr></table></figure>
<h3 id="3-菜单栏"><a href="#3-菜单栏" class="headerlink" title="3.菜单栏"></a>3.菜单栏</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">def showMenu(self):</div><div class="line">    # 生成母菜单栏</div><div class="line">    menubar = self.menuBar()</div><div class="line">    #添加菜单</div><div class="line">    p = menubar.addMenu(&apos;p&apos;)</div><div class="line">    #菜单 p2</div><div class="line">    impMenu = QMenu(&apos;p2&apos;, self)</div><div class="line">    # 子菜单 p2 click</div><div class="line">    impAct = QAction(&apos;p2 click&apos;, self)</div><div class="line">    #绑定 action</div><div class="line">    impAct.triggered.connect(self.p2)</div><div class="line">    # 添加菜单 p2 click</div><div class="line">    impMenu.addAction(impAct)</div><div class="line">    # 添加菜单 p2</div><div class="line">    p.addMenu(impMenu)</div><div class="line"></div><div class="line"></div><div class="line">    newAct = QAction(&apos;p1&apos;, self)</div><div class="line">    newAct.triggered.connect(self.p1)</div><div class="line">    p.addAction(newAct)</div><div class="line"></div><div class="line"></div><div class="line">def p1(self):</div><div class="line">    print(&quot;p1&quot;)</div><div class="line"></div><div class="line">def p2(self):</div><div class="line">    print(&quot;p2&quot;)</div></pre></td></tr></table></figure>
<h3 id="4-文本框-QTextEdit"><a href="#4-文本框-QTextEdit" class="headerlink" title="4.文本框 QTextEdit"></a>4.文本框 QTextEdit</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">def showTextView(self):</div><div class="line">    self.b=QTextEdit(self)</div><div class="line">    self.b.setPlaceholderText(&apos;我是默认文字&apos;)</div><div class="line">    self.b.setGeometry(20,150,200,100)</div><div class="line"></div><div class="line">    btn3 = QPushButton(&apos;提交&apos;, self)</div><div class="line">    btn3.resize(btn3.sizeHint())</div><div class="line">    btn3.clicked.connect(self.print)</div><div class="line">    btn3.move(110,260)</div><div class="line">def print(self):</div><div class="line">    #输出来文本框的汉字</div><div class="line">    print(self.b.toPlainText())</div></pre></td></tr></table></figure>
<h3 id="5-打包成可执行文件"><a href="#5-打包成可执行文件" class="headerlink" title="5.打包成可执行文件"></a>5.打包成可执行文件</h3><p>这里说是打包，不是exe和dmg，而是可执行文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">********************************************************************</div><div class="line">pyinstaller -F path </div><div class="line">编译成可执行文件</div><div class="line">path是想编译文件的路径</div><div class="line"></div><div class="line">会生成 dist文件夹和build文件夹,在dist文件夹下边生成一个可执行文件，</div><div class="line">文件的名字和编译文件的名字一样。双击就可以执行这个程序了。</div><div class="line">********************************************************************</div></pre></td></tr></table></figure></p>
<p>学习的小伙伴可以下载来看哦<a href="git@github.com:ifgyong/PYDemo.git">仓库地址</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Vorherige Seite"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Nächste Seite"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/0.jpeg"
                alt="兜兜转转"/>
            
              <p class="site-author-name" itemprop="name">兜兜转转</p>
              <div class="site-description motion-element" itemprop="description">在学习的路上，不忘初心 方得始终</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">42</span>
                    <span class="site-state-item-name">Artikel</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">Kategorien</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">22</span>
                    <span class="site-state-item-name">schlagwörter</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                  <a href="https://github.com/ifgyong" title="GitHub &rarr; https://github.com/ifgyong" rel="noopener" target="_blank">GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                  <a href="https://juejin.im/user/5693a77b60b2c2974cdd7f7f/posts" title="掘金 &rarr; https://juejin.im/user/5693a77b60b2c2974cdd7f7f/posts" rel="noopener" target="_blank">掘金</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">兜兜转转</span>

  

  
</div>


  <div class="powered-by">Erstellt mit  <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.4.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Design – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>




  

  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
