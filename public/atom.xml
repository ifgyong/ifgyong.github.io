<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>fgyongçš„æŠ€æœ¯åšå®¢</title>
  
  <subtitle>ä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://fgyong.cn/"/>
  <updated>2020-09-04T04:40:21.665Z</updated>
  <id>http://fgyong.cn/</id>
  
  <author>
    <name>fgyong</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>macOS ä¸€æ¬¾è‡ªåŠ¨ä¸Šä¼ å›¾åºŠçš„APP</title>
    <link href="http://fgyong.cn/2019/12/24/macOS%20AUY%E4%B8%80%E6%AC%BE%E4%B8%BA%E5%BC%80%E5%8F%91%E8%80%85%E6%9F%90%E7%A6%8F%E5%88%A9%E7%9A%84APP/"/>
    <id>http://fgyong.cn/2019/12/24/macOS%20AUY%E4%B8%80%E6%AC%BE%E4%B8%BA%E5%BC%80%E5%8F%91%E8%80%85%E6%9F%90%E7%A6%8F%E5%88%A9%E7%9A%84APP/</id>
    <published>2019-12-24T03:15:58.000Z</published>
    <updated>2020-09-04T04:40:21.665Z</updated>
    
    <content type="html"><![CDATA[<p>macOSå¼€å‘å’ŒiOSæœ‰å¾ˆå¤šç›¸å…³ä¹‹å¤„ï¼Œä¹Ÿæœ‰å¾ˆå¤šä¸åŒä¹‹å¤„ï¼Œä»Šå¤©å¸¦ä½ ä½¿ç”¨æœ€ä¼˜é›…çš„<code>APP.dmg</code>,ä¸€æ¬¾åå«<code>AUY</code>çš„è‡ªåŠ¨ä¸Šä¼ å›¾åºŠçš„APPï¼Œæ²¡æœ‰æœåŠ¡å™¨ï¼Œä¸æ‹…å¿ƒæ•°æ®è¢«ç›—ï¼Œå¯ä»¥ä¸Šä¼ å‰ªåˆ‡æ¿ä¸­çš„å›¾ç‰‡ï¼Œå¯ä»¥æ‹–åŠ¨æ–‡ä»¶ä¸Šä¼ ã€æ™ºèƒ½çš„APPã€‚</p><h2 id="AUY-ä¼ é€é—¨"><a href="#AUY-ä¼ é€é—¨" class="headerlink" title="AUY ä¼ é€é—¨"></a><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvQVVZL3JlbGVhc2Vz" title="https://github.com/ifgyong/AUY/releases">AUY ä¼ é€é—¨<i class="fa fa-external-link"></i></span></h2><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul><li>æ›´å°‘çš„æ“ä½œæ­¥éª¤å®Œæˆç›®æ ‡ã€‚</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;macOSå¼€å‘å’ŒiOSæœ‰å¾ˆå¤šç›¸å…³ä¹‹å¤„ï¼Œä¹Ÿæœ‰å¾ˆå¤šä¸åŒä¹‹å¤„ï¼Œä»Šå¤©å¸¦ä½ ä½¿ç”¨æœ€ä¼˜é›…çš„&lt;code&gt;APP.dmg&lt;/code&gt;,ä¸€æ¬¾åå«&lt;code&gt;AUY&lt;/code&gt;çš„è‡ªåŠ¨ä¸Šä¼ å›¾åºŠçš„APPï¼Œæ²¡æœ‰æœåŠ¡å™¨ï¼Œä¸æ‹…å¿ƒæ•°æ®è¢«ç›—ï¼Œå¯ä»¥ä¸Šä¼ å‰ªåˆ‡æ¿ä¸­çš„å›¾ç‰‡ï¼Œå¯ä»¥æ‹–åŠ¨æ–‡ä»¶ä¸Šä¼ ã€æ™ºèƒ½çš„APPã€‚&lt;/p&gt;
      
    
    </summary>
    
    
      <category term="macOS" scheme="http://fgyong.cn/categories/macOS/"/>
    
    
      <category term="macOS" scheme="http://fgyong.cn/tags/macOS/"/>
    
  </entry>
  
  <entry>
    <title>APP èµ„æºç®¡ç†ä¼˜åŒ–</title>
    <link href="http://fgyong.cn/2019/12/05/APP%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96/"/>
    <id>http://fgyong.cn/2019/12/05/APP%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96/</id>
    <published>2019-12-05T03:15:58.000Z</published>
    <updated>2020-09-04T04:40:21.650Z</updated>
    
    <content type="html"><![CDATA[<p>åœ¨APPä¸­ï¼Œä½¿ç”¨ X1ã€X2ã€X3å·²ç»æ˜¯å¸ç©ºè§æƒ¯çš„äº‹æƒ…äº†ï¼Œç½‘ä¸Šå‡ºäº†æ¸…ç©ºä¸å†ä½¿ç”¨çš„å›¾ç‰‡å’Œç±»ï¼Œæ˜¯ä¸æ˜¯åšå®Œè¿™äº›ä¸èƒ½å†è¿›ä¸€æ­¥ä¼˜åŒ–äº†ï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå½“ç„¶å¯ä»¥çš„ï¼Œä»Šå¤©å†æ¢ç©¶ä¸€ä¸‹èµ„æºç®¡ç†ä¼˜åŒ–ã€‚</p><p>èµ„æºå¤§éƒ¨åˆ†æ˜¯å›¾ç‰‡ï¼Œè¯´åˆ°å›¾ç‰‡å¿…é¡»è®²ä¸€ä¸‹ä½å›¾å’ŒçŸ¢é‡å›¾</p><h3 id="ä½å›¾"><a href="#ä½å›¾" class="headerlink" title="ä½å›¾"></a>ä½å›¾</h3><blockquote><p>ä½å›¾å›¾åƒï¼ˆbitmapï¼‰ï¼Œäº¦ç§°ä¸ºç‚¹é˜µå›¾åƒæˆ–æ …æ ¼å›¾åƒï¼Œæ˜¯ç”±ç§°ä½œåƒç´ ï¼ˆå›¾ç‰‡å…ƒç´ ï¼‰çš„å•ä¸ªç‚¹ç»„æˆçš„ã€‚è¿™äº›ç‚¹å¯ä»¥è¿›è¡Œä¸åŒçš„æ’åˆ—å’ŒæŸ“è‰²ä»¥æ„æˆå›¾æ ·ã€‚å½“æ”¾å¤§ä½å›¾æ—¶ï¼Œå¯ä»¥çœ‹è§èµ–ä»¥æ„æˆæ•´ä¸ªå›¾åƒçš„æ— æ•°å•ä¸ªæ–¹å—ã€‚æ‰©å¤§ä½å›¾å°ºå¯¸çš„æ•ˆæœæ˜¯å¢å¤§å•ä¸ªåƒç´ ï¼Œä»è€Œä½¿çº¿æ¡å’Œå½¢çŠ¶æ˜¾å¾—å‚å·®ä¸é½ã€‚</p></blockquote><h3 id="çŸ¢é‡å›¾"><a href="#çŸ¢é‡å›¾" class="headerlink" title="çŸ¢é‡å›¾"></a>çŸ¢é‡å›¾</h3><blockquote><p>çŸ¢é‡å›¾ï¼Œä¹Ÿç§°ä¸ºé¢å‘å¯¹è±¡çš„å›¾åƒæˆ–ç»˜å›¾å›¾åƒï¼Œåœ¨æ•°å­¦ä¸Šå®šä¹‰ä¸ºä¸€ç³»åˆ—ç”±çº¿è¿æ¥çš„ç‚¹ã€‚çŸ¢é‡æ–‡ä»¶ä¸­çš„å›¾å½¢å…ƒç´ ç§°ä¸ºå¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡éƒ½æ˜¯ä¸€ä¸ªè‡ªæˆä¸€ä½“çš„å®ä½“ï¼Œå®ƒå…·æœ‰é¢œè‰²ã€å½¢çŠ¶ã€è½®å»“ã€å¤§å°å’Œå±å¹•ä½ç½®ç­‰å±æ€§ã€‚<br>çŸ¢é‡å›¾æ˜¯æ ¹æ®å‡ ä½•ç‰¹æ€§æ¥ç»˜åˆ¶å›¾å½¢ï¼ŒçŸ¢é‡å¯ä»¥æ˜¯ä¸€ä¸ªç‚¹æˆ–ä¸€æ¡çº¿ï¼ŒçŸ¢é‡å›¾åªèƒ½é è½¯ä»¶ç”Ÿæˆï¼Œæ–‡ä»¶å ç”¨å†…åœ¨ç©ºé—´è¾ƒå°ï¼Œå› ä¸ºè¿™ç§ç±»å‹çš„å›¾åƒæ–‡ä»¶åŒ…å«ç‹¬ç«‹çš„åˆ†ç¦»å›¾åƒï¼Œå¯ä»¥è‡ªç”±æ— é™åˆ¶çš„é‡æ–°ç»„åˆã€‚</p></blockquote><h3 id="è¯´äººè¯"><a href="#è¯´äººè¯" class="headerlink" title="è¯´äººè¯"></a>è¯´äººè¯</h3><blockquote><p>ä½å›¾å°±æ˜¯æ— æ•°ä¸ªç‚¹ç»„æˆçš„å›¾ç‰‡ï¼ŒåŸºæœ¬å…ƒç´ æ˜¯åƒç´ ï¼›çŸ¢é‡å›¾æœ‰å¤šä¸ªå›¾å½¢ç»„æˆçš„ï¼ŒåŸºæœ¬å…ƒç´ æ˜¯å›¾åƒã€‚å½“ç›¸åŒå°ºå¯¸çš„ä½å›¾å’ŒçŸ¢é‡å›¾ç»˜åˆ¶åœ¨å¤§å±å¹•ä¸Šï¼Œä½å›¾çš„å¼Šç«¯å‡ºç°äº†ï¼Œå›¾åƒçœ‹ç€åƒç´ é¢—ç²’å¾ˆå¤§ï¼Œè€ŒçŸ¢é‡å›¾åŸºæœ¬æ•ˆæœè¿˜æ˜¯å¾ˆå¥½çš„ã€‚</p></blockquote><p>çŸ¢é‡å›¾åœ¨ç»˜åˆ¶åˆ°ä¸åŒçš„å±å¹•ä¸Šæœ‰ç€å¤©ç„¶çš„ä¼˜åŠ¿ã€‚</p><h2 id="å¼€å§‹ä½¿ç”¨çŸ¢é‡å›¾"><a href="#å¼€å§‹ä½¿ç”¨çŸ¢é‡å›¾" class="headerlink" title="å¼€å§‹ä½¿ç”¨çŸ¢é‡å›¾"></a>å¼€å§‹ä½¿ç”¨çŸ¢é‡å›¾</h2><p>åœ¨Xcdoe 9ã€iOS11 ä¸­å·²ç»å¼€å§‹æ”¯æŒäº†çŸ¢é‡å›¾ï¼Œåªéœ€è¦è®¾ç½®æ‰“é’©<code>Preserve Cector Dadta</code>ã€‚<br><img src="http://blog.fgyong.cn/FhF6-GTsthDXMlsX9ezQ1PaXalIa.png-a" alt></p><p><strong>å‰æå›¾ç‰‡æ ¼å¼æ˜¯çŸ¢é‡å›¾å“¦</strong></p><p>çŸ¢é‡å›¾åœ¨èµ„æºå¤§å°ä¸­ç›¸æ¯”å’Œä¸€å€ã€ä¸¤å€ã€ä¸‰å€å›¾æ€»å’Œï¼Œå¤§å°ä¸‹é™<strong>60%</strong>ï¼Œè¿™ç®—æ˜¯ä¸é”™çš„æå‡äº†ã€‚</p><h2 id="Stretchable-Images"><a href="#Stretchable-Images" class="headerlink" title="Stretchable Images"></a>Stretchable Images</h2><p>ä»iOS11ã€Xcode 9å°±å¼€å§‹æ”¯æŒäº†è¯¥å·¥å…·ï¼Œè¯¥å·¥å…·å¯å®ç°åœ¨<code>building</code>ä¸­å°†å›¾ç‰‡å…ƒæ•°æ®æ ¼æ …åŒ–ï¼Œå„¿ä¸æ˜¯åœ¨è¿è¡Œæ—¶å¤„ç†ï¼Œé™ä½å›¾ç‰‡åœ¨æ˜¾ç¤ºæ—¶å€™çš„CPUå‹åŠ›ã€‚<br>å½“æ¸²æŸ“çš„å°ºå¯¸å¤§äºå½“å‰çš„å°ºå¯¸çš„æ—¶å€™æ‰ä¼šé‡æ–°æ¸²æŸ“ï¼Œå¦åˆ™ä½¿ç”¨ä¼˜åŒ–è¿‡çš„é¢„æ¸²æŸ“ä½å›¾ã€‚<br>æ•ˆæœæ˜¯è¿™æ ·å­çš„</p><p><img src="http://blog.fgyong.cn/FpZhgVvqS711QZZnYYptKr40Pc9U-a" alt></p><h4 id="Slicing"><a href="#Slicing" class="headerlink" title="Slicing"></a>Slicing</h4><h5 id="Slices"><a href="#Slices" class="headerlink" title="Slices"></a>Slices</h5><ul><li>None æ— </li><li>Horizontal æ°´å¹³</li><li>Vertical ç«–ç›´</li><li>Horizontal and Vertical æ°´å¹³å’Œç«–ç›´ </li></ul><h5 id="Center"><a href="#Center" class="headerlink" title="Center"></a>Center</h5><ul><li>Tiles å¹³é“º</li><li>Streches æ‹‰ä¼¸</li></ul><p>ä½¿ç”¨è¿™ä¸¤ç»„å‚æ•°å¯ä»¥è¾¾åˆ°ç»å¤§éƒ¨åˆ†éœ€æ±‚äº†</p><p><img src="http://blog.fgyong.cn/FrtLZrygVGyJAqlV6Q412foMQgRk-a" alt></p><p>å½“æˆ‘ä»¬ä½¿ç”¨ä¸‹å›¾è¿™ç§å›¾ç‰‡ï¼Œæå‰å’ŒUIè®²æ¸…æ¥šï¼Œä½œå‡ºä¸€ä¸ªå°å›¾ï¼Œåœ¨è®¾å¤‡ä¸Šä½¿ç”¨<code>Stretchable Images</code>åŠŸèƒ½ï¼Œå¯ä»¥è¾¾åˆ°å¤§å›¾çš„æ•ˆæœã€‚</p><p><img src="http://blog.fgyong.cn/FvHCZgiiwONF_5Y01HOVP_-d9d3_-a" alt><br>ç™½è‰²éƒ¨åˆ†è¡¨ç¤ºå¯æ‹‰ä¼¸å’Œèˆå¼ƒçš„<br><img src="http://blog.fgyong.cn/Fh6BK-44VNuB2PDdQUjaA-2iOF_J-a" alt></p><p>æœ€ç»ˆæ•ˆæœæ˜¯è¿™æ ·çš„</p><p><img src="http://blog.fgyong.cn/1.mp4" alt></p><p>ğŸ‘ğŸ‘ğŸ‘ğŸ‘</p><p>æ›´å¤šç”¨æ³•å¯ä»¥å‚è€ƒ<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL3ZpZGVvcy9wbGF5L3d3ZGMyMDE4LzIyNw==" title="https://developer.apple.com/videos/play/wwdc2018/227">WWDC2018/227<i class="fa fa-external-link"></i></span></p><h2 id="Bundle"><a href="#Bundle" class="headerlink" title="Bundle"></a>Bundle</h2><p>å¤§é¡¹ç›®å¯èƒ½ä¼šæœ‰å¾ˆå¤šæ¡†æ¶ï¼Œå½“å¤šä¸ªæ¡†æ¶ä½¿ç”¨çš„å›¾ç‰‡åå­—å‘ç”Ÿé‡å¤æ—¶ï¼Œä½¿ç”¨<code>Bundle</code>æ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œ<code>Bundle</code>ç›¸å½“äºæ–‡ä»¶å¤¹ï¼Œç›¸åŒ<code>Bundle</code>ä¸‹è¾¹æ²¡æœ‰é‡å¤çš„æ–‡ä»¶å³å¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Get the app&#39;s main bundle</span><br><span class="line">let mainBundle &#x3D; Bundle.main</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è·å–æœ¬åœ°Bundle å›¾ç‰‡</span><br><span class="line">let me &#x3D; Bundle.init(identifier: &quot;me&quot;)</span><br><span class="line">let path &#x3D; me?.path(forResource: &quot;fgyong.cn æŠ€æœ¯åšå®¢&quot;, ofType: &quot;png&quot;)</span><br></pre></td></tr></table></figure><h2 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h2><p>å½“APPæœ‰50ä¸ªç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†æ˜¯æ¯ä¸ªåŠŸèƒ½éƒ½ç”¨ç±»ä¼¼çš„å›¾ç‰‡ï¼Œé‚£ä¹ˆä»–ä»¬åå­—ä¹Ÿä¸€è‡´ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>Namespace</code>æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚<br><img src="http://blog.fgyong.cn/FqvcOJHbjHBdE04jl78PlT3pAA4l-a" alt></p><p>ä½¿ç”¨èµ·æ¥ä¹Ÿæ˜¯å¾ˆç®€å•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let image &#x3D; UIImage(named: &quot;me&#x2F;4.png&quot;)</span><br></pre></td></tr></table></figure><h2 id="APP-Thining"><a href="#APP-Thining" class="headerlink" title="APP Thining"></a>APP Thining</h2><h3 id="Memory-Classes-amp-amp-Graphics-Classes"><a href="#Memory-Classes-amp-amp-Graphics-Classes" class="headerlink" title="Memory Classes &amp;&amp; Graphics Classes"></a>Memory Classes &amp;&amp; Graphics Classes</h3><p>ä½¿ç”¨å†…å­˜å’ŒMetalæ¥é€‚é…ä¸åŒæœºå‹ï¼Œè¾¾åˆ°æœ€ä¼˜æ€§èƒ½ã€‚</p><p><img src="http://blog.fgyong.cn/FgJGgpqcA-K_kSKY6e9LDZapOiYT-a" alt></p><p>é¦–å…ˆæœºå‹å…ˆå»æ‰¾4GBçš„èµ„æºï¼Œ4GBæ²¡æ‰¾åˆ°ï¼Œåˆ™å‘ä¸‹å¯»æ‰¾3GBï¼Œä¸€ç›´å¯»æ‰¾åˆ°1GBå¯¹åº”çš„èµ„æºã€‚</p><p>å†…å­˜å’ŒGPUç›¸æ¯”ï¼Œå†…å­˜æœ‰ç€æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬ç¡®å®šå†…å­˜æ˜¯è¡¨ç°è®¾å¤‡æ•´ä½“æ€§èƒ½çš„æ ‡å‡†ã€‚</p><h2 id="NSSData-set"><a href="#NSSData-set" class="headerlink" title="NSSData set"></a>NSSData set</h2><p><code>Data set</code>å®¹å™¨å¯ä»¥æ”¾ä»»ä½•ä¸œè¥¿ã€‚<br>å¯ä»¥æ˜¯<code>plist</code>æ–‡ä»¶ï¼Œå¯ä»¥æ˜¯<code>video</code>ã€å¯ä»¥æ˜¯<code>mp3</code>ï¼Œå¯ä»¥æ˜¯å…¶ä»–ä»»ä½•æ ¼å¼çš„æ–‡ä»¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open class func preloadTextureAtlasesNamed(_ atlasNames: [String], withCompletionHandler completionHandler: @escaping (Error?, [SKTextureAtlas]) -&gt; Void)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è¯¥å‡½æ•°ç«‹åˆ»è°ƒç”¨å¤§é‡I/Oå’Œå†…å­˜æ¥è§£ç æˆ–è¯»å…¥æ•°æ®ï¼Œé¢„å…ˆæ”¾åœ¨å†…å­˜ä¸­ï¼Œä½ éœ€è¦åœ¨ç´§æ€¥éœ€è¦çš„æ—¶å€™è°ƒç”¨è¯¥å‡½æ•°ã€‚ä¸è¦éšæ„è°ƒç”¨è¯¥APIï¼Œä»¥ä¸ºå®ƒä¼šæŒ‰ç…§ä½ è¯´çš„<strong>ç«‹é©¬</strong>å»åšï¼âš ï¸âš ï¸âš ï¸å½“ä½ è°ƒç”¨è¯¥å‡½æ•°ï¼Œè¯·ç¡®ä¿ç«‹å³ä½¿ç”¨èµ„æºï¼Œå¦åˆ™APIä¼šæ¶ˆè€—å¤§é‡çš„I/Oå’Œå†…å­˜æ¥åŠ è½½æ‰€æœ‰è¿™äº›å›¾åƒã€‚</p><p><code>Sprite Atlases</code>å¼ºå¤§ä¹‹å¤„æ˜¯ä¼šæ ¹æ®ä¸åŒè®¾å¤‡å’Œå±å¹•æ¥æ¸²æŸ“ä¸åŒçš„å›¾åƒï¼Œå¹¶ä¼ é€åˆ°æ­£ç¡®çš„è®¾å¤‡ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><img src="http://blog.fgyong.cn/Fld0tbjb_RgbF9QWnzTXUYrZJzhG-a" alt></p><ul><li>åœ¨iOS12ä¸Šé‡‡ç”¨æœ€æ–°çš„ç®—æ³•ï¼Œè¿™äº›å›¾åƒèµ„æºä¼šå‡å°‘10%-20%çš„ç©ºé—´ï¼Œ</li><li>ä½¿ç”¨Xcodeçš„èµ„æºç›®å½•æ˜¯ä¸é”™çš„é€‰æ‹©</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åœ¨APPä¸­ï¼Œä½¿ç”¨ X1ã€X2ã€X3å·²ç»æ˜¯å¸ç©ºè§æƒ¯çš„äº‹æƒ…äº†ï¼Œç½‘ä¸Šå‡ºäº†æ¸…ç©ºä¸å†ä½¿ç”¨çš„å›¾ç‰‡å’Œç±»ï¼Œæ˜¯ä¸æ˜¯åšå®Œè¿™äº›ä¸èƒ½å†è¿›ä¸€æ­¥ä¼˜åŒ–äº†ï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå½“ç„¶å¯ä»¥çš„ï¼Œä»Šå¤©å†æ¢ç©¶ä¸€ä¸‹èµ„æºç®¡ç†ä¼˜åŒ–ã€‚&lt;/p&gt;
&lt;p&gt;èµ„æºå¤§éƒ¨åˆ†æ˜¯å›¾ç‰‡ï¼Œè¯´åˆ°å›¾ç‰‡å¿…é¡»è®²ä¸€ä¸‹ä½å›¾å’ŒçŸ¢é‡å›¾&lt;/p&gt;
&lt;h3 id=&quot;ä½å›¾&quot;
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOSä¼˜åŒ–" scheme="http://fgyong.cn/tags/iOS%E4%BC%98%E5%8C%96/"/>
    
  </entry>
  
  <entry>
    <title>iOSå›¾ç‰‡ä¼˜åŒ–</title>
    <link href="http://fgyong.cn/2019/12/03/iOS%E5%9B%BE%E7%89%87%E4%BC%98%E5%8C%96%20/"/>
    <id>http://fgyong.cn/2019/12/03/iOS%E5%9B%BE%E7%89%87%E4%BC%98%E5%8C%96%20/</id>
    <published>2019-12-03T03:15:58.000Z</published>
    <updated>2020-09-04T04:40:21.656Z</updated>
    
    <content type="html"><![CDATA[<p>åŸºäºç°åœ¨iOS11æ–°ç”Ÿæˆçš„å›¾ç‰‡éƒ½æ˜¯<code>HEIF</code>ï¼Œè¯¥å›¾ç‰‡ä½¿ç”¨<code>[UIImage image:name]</code>å·²ä¸åœ¨é‚£ä¹ˆä¼˜é›…ï¼Œå›¾ç‰‡å¤§å°ä¸º1.8må¤§å°çš„ï¼Œè¯»è¿›æ‰‹æœºå†…å­˜ï¼Œç›´æ¥é£™å‡äº†45Mï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸æƒ³çœ‹åˆ°çš„ç»“æœï¼Œä¸€ä¸ªé¡µé¢æœ‰å¤šä¸ªè¿™æ ·å­çš„å›¾çš„è¯ï¼Œææ€•å°±æ˜¯ç¾éš¾äº†ã€‚</p><p>æ—¢ç„¶åŸå›¾ä¸èƒ½è¯»å…¥ï¼Œé‚£ä¹ˆå¦‚ä½•å¯ä»¥ç”¨æ›´å°‘çš„å†…å­˜å’ŒCPUæ¥è§£å†³å‘¢?</p><p>è¿™å°±è¦å…ˆäº†è§£è¯¥å›¾ç‰‡çš„ç¼–ç äº†ã€‚</p><h2 id="HEIC-HEIF"><a href="#HEIC-HEIF" class="headerlink" title="HEIC HEIF"></a>HEIC HEIF</h2><blockquote><p>å¸¦æœ‰å…ƒæ•°æ®çš„HEIFçš„å¦ä¸€ç§å½¢å¼ã€‚HEICæ–‡ä»¶åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä»¥â€œé«˜æ•ˆå›¾åƒæ ¼å¼â€ï¼ˆHEIFï¼‰ä¿å­˜çš„å›¾åƒï¼Œè¯¥æ ¼å¼é€šå¸¸ç”¨äºåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå­˜å‚¨ç…§ç‰‡ã€‚å®ƒå¯èƒ½åŒ…å«å•ä¸ªå›¾åƒæˆ–å›¾åƒåºåˆ—ä»¥åŠæè¿°æ¯ä¸ªå›¾åƒçš„å…ƒæ•°æ®ã€‚æœ€å¸¸ä½¿ç”¨æ–‡ä»¶æ‰©å±•åâ€œ .heicâ€ï¼Œä½†HEICæ–‡ä»¶ä¹Ÿå¯èƒ½æ˜¾ç¤ºä¸º.HEIFæ–‡ä»¶</p></blockquote><p><code>heic</code>å’Œ<code>heif</code>æ˜¯å¹¿è‰²åŸŸå›¾ç‰‡çš„æ ¼å¼ï¼Œå¹¿è‰²åŸŸæ¯”<code>sRGB</code>è¡¨ç¤ºèŒƒå›´å¤§25%ï¼Œåœ¨å¹¿è‰²åŸŸè®¾å¤‡ä¸­èƒ½æ˜¾ç¤ºæ›´å¹¿çš„è‰²å½©ï¼Œ<code>sRGB 8bit/dept</code>ï¼Œå¹¿è‰²åŸŸè¾¾åˆ°<code>16bit/dept</code>ã€‚å¹¿è‰²åŸŸåªæ˜¯åœ¨ç¡¬ä»¶æ”¯æŒçš„æƒ…å†µä¸‹æ‰èƒ½æ˜¾ç¤ºçš„ã€‚<br>å…¶å®å°±æ˜¯è‹¹æœæçš„ä¸€ä¸ªæ›´é«˜æ•ˆä½“ç§¯æ›´å°æ•ˆç‡æ›´é«˜çš„å‹ç¼©æ–¹å¼ã€‚</p><h2 id="åŠ è½½"><a href="#åŠ è½½" class="headerlink" title="åŠ è½½"></a>åŠ è½½</h2><p>åŠ è½½<code>image</code>ï¼Œåªæ˜¯æŠŠ<strong>æ–‡ä»¶ä¿¡æ¯</strong>åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è§£ç ã€‚åœ¨ä»£ç ä¸­ä½“ç°å°±æ˜¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let image &#x3D; UIImage(contentsOfFile: url.path)</span><br><span class="line">æˆ– åŠ è½½å›¾ç‰‡åˆ°å†…å­˜ ä¼šå¸¸é©»å†…å­˜</span><br><span class="line">let image &#x3D; UIImage(named: name)!</span><br></pre></td></tr></table></figure></p><h2 id="è§£ç "><a href="#è§£ç " class="headerlink" title="è§£ç "></a>è§£ç </h2><p>å…¶å®æ˜¯å‘ç”Ÿåœ¨æ·»åŠ åˆ°è¦æ˜¾ç¤ºçš„viewä¸Šé¢æ‰ä¼šè§£ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let imageV &#x3D; UIImageView.init(image: image)</span><br><span class="line">imageV.frame &#x3D; CGRect(x: 50, y: (250 * i) + 100, width: 200, height: 200)</span><br><span class="line">self.view.addSubview(imageV)</span><br></pre></td></tr></table></figure><br>æœ€åä¸€è¡Œä¸å†™ï¼Œåˆ™ä¸ä¼šè§£ç ã€‚</p><h2 id="æ¸²æŸ“"><a href="#æ¸²æŸ“" class="headerlink" title="æ¸²æŸ“"></a>æ¸²æŸ“</h2><p>å½“<code>view</code>æ˜¾ç¤ºå‡ºæ¥åˆ™æ˜¯æ¸²æŸ“ã€‚è¿‡ç¨‹æ˜¯è§£ç çš„<code>data buffer</code> å¤åˆ¶åˆ°<code>frame buffer</code>,ç¡¬ä»¶ä»å¸§ç¼“å†²åŒºè¯»å–æ•°æ®æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.view.addSubview(imageV)</span><br></pre></td></tr></table></figure></p><h2 id="å†…å­˜æš´æ¶¨åŸå› "><a href="#å†…å­˜æš´æ¶¨åŸå› " class="headerlink" title="å†…å­˜æš´æ¶¨åŸå› "></a>å†…å­˜æš´æ¶¨åŸå› </h2><p>ä¸€éƒ¨åˆ†å›¾ç‰‡åŠ è½½åˆ°å†…å­˜ï¼Œåœ¨è§£ç è¿‡ç¨‹ä¸­å‡ºç°äº†å†…å­˜æš´æ¶¨é—®é¢˜ï¼Œä»Šå¤©æ¢ç©¶ä¸€ä¸‹åŸå› å’Œè§£å†³æ–¹æ¡ˆã€‚</p><p>é¦–å…ˆæœ‰è¯·æˆ‘ä»¬å‡†å¤‡çš„ç´ æå’Œè®¾å¤‡(6s 64gç‰ˆæœ¬)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">A:jpg</span><br><span class="line">20M 12000*12000</span><br><span class="line"></span><br><span class="line">B:jpg</span><br><span class="line">2.8M 3024*4032</span><br><span class="line"></span><br><span class="line">C:HEIC</span><br><span class="line">1.8M 3024*4032</span><br></pre></td></tr></table></figure><br>ç´ æA<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">APPè¿è¡Œå†…å­˜ï¼š13.8M</span><br><span class="line">åŠ è½½Image: 240.3Mä¹‹åç¨³å®šåˆ°220M</span><br><span class="line">CPUï¼šå³°å€¼5%ï¼Œéšåé™ä½åˆ°0%</span><br><span class="line">imageå å†…å­˜ï¼š226.5M</span><br></pre></td></tr></table></figure></p><p>ç´ æB<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">APPè¿è¡Œå†…å­˜ï¼š13.7M</span><br><span class="line">åŠ è½½Image: 31.5</span><br><span class="line">CPUï¼šå³°å€¼5%ï¼Œéšåé™ä½åˆ°0%</span><br><span class="line">imageå å†…å­˜ï¼š17.8M</span><br></pre></td></tr></table></figure></p><p>ç´ æC<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">APPè¿è¡Œå†…å­˜ï¼š13.8M</span><br><span class="line">åŠ è½½Image: 32.3</span><br><span class="line">CPUï¼šå³°å€¼4%ï¼Œéšåé™ä½åˆ°0%</span><br><span class="line">imageå å†…å­˜ï¼š18.5M</span><br></pre></td></tr></table></figure></p><p>æˆ‘ä»¬çŒœæµ‹æ˜¯å¦æ˜¯<code>imageView</code>çš„å¤§å°å½±å“å†…å­˜çš„å‘¢ï¼Ÿ<br><code>size</code>æ”¹ä¸ºåŸæ¥çš„1/10ç»“æœè¿è¡Œå†…å­˜è¿˜æ˜¯å’Œä»¥å‰ä¸€æ ·ã€‚</p><p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p><blockquote><p>å†…å­˜å¤§å°ä¸æ˜¯å–å†³äº<code>view</code>çš„<code>size</code>ï¼Œè€Œæ˜¯åŸå§‹æ–‡ä»¶<strong>image size</strong>ã€‚</p></blockquote><p><img src="/images/14-1.png" alt></p><h3 id="æ¸²æŸ“æ ¼å¼"><a href="#æ¸²æŸ“æ ¼å¼" class="headerlink" title="æ¸²æŸ“æ ¼å¼"></a>æ¸²æŸ“æ ¼å¼</h3><h4 id="SRGB"><a href="#SRGB" class="headerlink" title="SRGB"></a>SRGB</h4><p>æ¯ä¸ªåƒç´ 4å­—èŠ‚ï¼ŒåŒ…å«çº¢é»„è“å’Œé€æ˜åº¦ï¼Œæ¯ä¸ªé€šé“æ˜¯1å­—èŠ‚8ä½ã€‚</p><h4 id="display-p3-å®½è‰²åŸŸ"><a href="#display-p3-å®½è‰²åŸŸ" class="headerlink" title="display p3 å®½è‰²åŸŸ"></a>display p3 å®½è‰²åŸŸ</h4><p>æ¯ä¸ªåƒç´ 8å­—èŠ‚ï¼ŒåŒ…å«çº¢é»„è“å’Œé€æ˜åº¦ï¼Œæ¯ä¸ªé€šé“æ˜¯2å­—èŠ‚16ä½ã€‚ä½¿ç”¨æœºå‹iphone7 ã€iphone8ã€iphone XåŠä»¥åçš„è®¾å¤‡ï¼Œä¸æ”¯æŒè¯¥æ ¼å¼çš„æœºå‹æ— æ³•æ˜¾ç¤ºè¯¥æ•ˆæœã€‚</p><h4 id="äº®åº¦å’Œé€æ˜åº¦"><a href="#äº®åº¦å’Œé€æ˜åº¦" class="headerlink" title="äº®åº¦å’Œé€æ˜åº¦"></a>äº®åº¦å’Œé€æ˜åº¦</h4><p>æ¯ä¸ªåƒç´ 2å­—èŠ‚ï¼Œå•ä¸€çš„è‰²è°ƒå’Œé€æ˜åº¦ï¼Œåªèƒ½æ¥æ˜¾ç¤ºç™½è‰²å’Œé»‘è‰²ä¹‹é—´çš„è‰²å€¼ï¼Œæ²¡æœ‰å…¶ä»–é¢œè‰²ã€‚</p><h4 id="Alpha-8-Format"><a href="#Alpha-8-Format" class="headerlink" title="Alpha 8 Format"></a>Alpha 8 Format</h4><p>æ¯ä¸ªåƒç´ 1å­—èŠ‚ï¼Œç”¨æ¥è¡¨ç¤ºé€æ˜åº¦ï¼Œä¸€èˆ¬ç”¨ä½œè’™ç‰ˆå’Œæ–‡å­—ã€‚<br>ç›¸æ¯”sRGBå®¹é‡å°äº†75%ï¼Œè¯¦ç»† å®½è‰²åŸŸ å®¹é‡å°äº†87.5%</p><h3 id="æ¸²æŸ“å›¾ç‰‡å¤§å°è®¡ç®—"><a href="#æ¸²æŸ“å›¾ç‰‡å¤§å°è®¡ç®—" class="headerlink" title="æ¸²æŸ“å›¾ç‰‡å¤§å°è®¡ç®—"></a>æ¸²æŸ“å›¾ç‰‡å¤§å°è®¡ç®—</h3><p>å›¾ç‰‡å¤§å° = å›¾ç‰‡æ ¼å¼å®¹é‡ <em> åƒç´ ä¸ªæ•°<br>å½“æˆ‘ä»¬æŠŠå¤§å°æ˜¯20\</em>20ä½¿ç”¨<code>Alpha 8 format</code>æ¸²æŸ“åˆ°20*20çš„viewä¸Šé¢ï¼Œå’Œ40*40çš„imageä½¿ç”¨<code>p3</code>æ¸²æŸ“åˆ°20*20çš„viewä¸­ï¼Œåç€å ç”¨å†…å­˜æ˜¯å‰è€…çš„8å€ã€‚</p><p>ä½¿ç”¨sRGBè‰²åŸŸè¿›è¡Œæ¸²æŸ“æ‰€å ç”¨çš„å¤§å°ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imageWidth*imageHeight*4 å­—èŠ‚</span><br></pre></td></tr></table></figure><br>æ¯ä¸ªåƒç´ å ç”¨äº†4å­—èŠ‚ï¼Œæ¯ä¸ªå­—èŠ‚8ä½ï¼Œ</p><p>ä½¿ç”¨<code>display p3</code>åˆ™æ¯ä¸ªé€šé“å ç”¨16ä½ï¼Œé‚£ä¹ˆå ç”¨å†…å­˜å¤§å°æ˜¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imageWidth*imageHeight*8 å­—èŠ‚</span><br></pre></td></tr></table></figure></p><h3 id="å¦‚ä½•é€‰æ‹©æ­£ç¡®çš„å›¾ç‰‡æ ¼å¼"><a href="#å¦‚ä½•é€‰æ‹©æ­£ç¡®çš„å›¾ç‰‡æ ¼å¼" class="headerlink" title="å¦‚ä½•é€‰æ‹©æ­£ç¡®çš„å›¾ç‰‡æ ¼å¼"></a>å¦‚ä½•é€‰æ‹©æ­£ç¡®çš„å›¾ç‰‡æ ¼å¼</h3><blockquote><p>ä¸è¦ä¸»åŠ¨é€‰æ‹©å›¾ç‰‡æ ¼å¼ï¼Œè®©æ ¼å¼é€‰æ‹©ä½ ã€‚</p></blockquote><p>ä¸è¦å†ä½¿ç”¨<code>UIGraphicsBeginImageContextWithOptions</code>,è¯¥æ–¹æ³•æ€»æ˜¯ä½¿ç”¨sRGBæ ¼å¼ï¼Œä½ æƒ³èŠ‚çº¦å†…å­˜æ˜¯ä¸è¡Œçš„ï¼Œåœ¨æ”¯æŒ<code>p3</code>çš„è®¾å¤‡ä¸Šæƒ³ç»˜åˆ¶å‡ºæ¥<code>p3</code>è‰²åŸŸçš„å›¾ç‰‡ä¹Ÿæ˜¯ä¸è¡Œçš„ã€‚é‚£ä¹ˆä½¿ç”¨<code>UIGraphicsImageRenderer</code>ç³»ç»Ÿå¯ä»¥è‡ªåŠ¨ä¸ºä½ é€‰æ‹©æ ¼å¼ï¼Œå¦‚æœç»˜åˆ¶<code>image</code>ï¼Œè‡ªå·±å†æ·»åŠ å•è‰²è’™ç‰ˆï¼Œæ˜¯ä¸éœ€è¦å¦å¤–å•ç‹¬åˆ†é…å†…å­˜çš„ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">if let im &#x3D; imageV &#123;</span><br><span class="line">&#x2F;&#x2F;ç¬¬äºŒæ¬¡æ·»åŠ è’™ç‰ˆ</span><br><span class="line">im.tintColor &#x3D; UIColor.black</span><br><span class="line">&#125;else&#123;</span><br><span class="line">&#x2F;&#x2F;ç»˜åˆ¶ä¸€ä¸ªçº¢è‰²çŸ©å½¢</span><br><span class="line">let bounds &#x3D; CGRect(x: 0, y: 0, width: width, height: height)</span><br><span class="line">let renderer &#x3D; UIGraphicsImageRenderer(bounds: bounds)</span><br><span class="line"> let image &#x3D; renderer.image &#123; (coxt) in</span><br><span class="line">UIColor.red.setFill()</span><br><span class="line">let path &#x3D; UIBezierPath(roundedRect: bounds,</span><br><span class="line">cornerRadius: 20)</span><br><span class="line">path.addClip()</span><br><span class="line">UIRectFill(bounds)</span><br><span class="line">&#125;</span><br><span class="line">imageV &#x3D; UIImageView(image: image)</span><br><span class="line">imageV?.frame &#x3D; bounds</span><br><span class="line">self.view.addSubview(imageV!)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p><code>UIImage</code> ç›´æ¥è¯»å‡ºæ¥éœ€è¦å°†æ‰€æœ‰<code>UIImage</code>çš„<code>data</code>å…¨éƒ¨è§£ç åˆ°å†…å­˜ï¼Œå¾ˆè€—è´¹å†…å­˜å’Œæ€§èƒ½ã€‚ä¸ºäº†èŠ‚çœå†…å­˜å’Œé™ä½CPUä½¿ç”¨ç‡ï¼Œå¯ä»¥é‡‡ç”¨<strong>ä¸‹é‡‡æ ·</strong>ã€‚</p><h3 id="ä¸‹é‡‡æ ·"><a href="#ä¸‹é‡‡æ ·" class="headerlink" title="ä¸‹é‡‡æ ·"></a>ä¸‹é‡‡æ ·</h3><p>å½“<code>image</code>ç´ æå¤§å°æ˜¯<code>1000*1000</code>ï¼Œä½†æ˜¯åœ¨æ‰‹æœºä¸Šæ˜¾ç¤ºå‡ºæ¥åªæœ‰<code>200*200</code>ï¼Œæˆ‘ä»¬å…¶å®æ˜¯æ²¡å¿…è¦å°†<code>1000*1000</code>çš„æ•°æ®éƒ½è§£ç çš„ï¼Œåªéœ€è¦ç¼©å°æˆ<code>200*200</code>çš„å¤§å°å³å¯ï¼Œè¿™æ ·å­èŠ‚çœäº†å†…å­˜å’ŒCPUï¼Œç”¨æˆ·æ„Ÿå®˜ä¹Ÿæ²¡æœ‰ä»»ä½•å½±å“ã€‚<br>åœ¨<code>UIKit</code>ä¸­ä½¿ç”¨<code>UIGraphicsImageRenderer</code>ä¼šæœ‰ç¬é—´å¾ˆé«˜çš„å†…å­˜å’ŒCPUå³°å€¼ï¼Œé‚£ä¹ˆ</p><h4 id="1-UIKit-UIGraphicsImageRenderer"><a href="#1-UIKit-UIGraphicsImageRenderer" class="headerlink" title="1.UIKit  UIGraphicsImageRenderer"></a>1.UIKit  UIGraphicsImageRenderer</h4><p>ä½¿ç”¨ç´ æAä¸‹é‡‡æ ·æŠ€æœ¯ï¼Œä½¿ç”¨<code>UIKit</code>ä¸­çš„<code>UIGraphicsImageRenderer</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Memory </span><br><span class="line">High:16.4M</span><br><span class="line">normal:14.8M</span><br><span class="line">CPU:</span><br><span class="line">Hight:29%</span><br><span class="line">normal:0%</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">func resizedImage(at url: URL, for size: CGSize) -&gt; UIImage? &#123;</span><br><span class="line">guard let image &#x3D; UIImage(contentsOfFile: url.path) else &#123;</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line">if #available(iOS 10.0, *) &#123;</span><br><span class="line">let renderer &#x3D; UIGraphicsImageRenderer(size: size)</span><br><span class="line"></span><br><span class="line">return renderer.image &#123; (context) in</span><br><span class="line">image.draw(in: CGRect(origin: .zero, size: size))</span><br><span class="line">&#125;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">UIGraphicsBeginImageContext(size)</span><br><span class="line">image.draw(in: CGRect(origin: .zero, size: size))</span><br><span class="line">let image &#x3D; UIGraphicsGetImageFromCurrentImageContext()</span><br><span class="line">UIGraphicsEndImageContext()</span><br><span class="line">return image</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨å­çº¿ç¨‹ç»˜åˆ¶ï¼Œä¼šå‡ºç°CPUç•¥å¾®å‡é«˜ï¼Œå½“<code>image size</code>å¤§å¾ˆå¤šçš„æ—¶å€™ä¼šå‡ºç°å†…å­˜é£™å‡ç„¶åæ…¢æ…¢æ¢å¤åˆ°<code>normal</code>ã€‚</p><h4 id="2-CoreGraphics-CGContextä¸Šä¸‹æ–‡ç»˜åˆ¶ç¼©ç•¥å›¾"><a href="#2-CoreGraphics-CGContextä¸Šä¸‹æ–‡ç»˜åˆ¶ç¼©ç•¥å›¾" class="headerlink" title="2.CoreGraphics CGContextä¸Šä¸‹æ–‡ç»˜åˆ¶ç¼©ç•¥å›¾"></a>2.CoreGraphics CGContextä¸Šä¸‹æ–‡ç»˜åˆ¶ç¼©ç•¥å›¾</h4><p>ä½¿ç”¨ä¸Šä¸‹æ–‡ç»˜åˆ¶ <code>cpu</code> å’Œå†…å­˜å˜åŒ–å¦‚ä¸‹,<code>CPU</code>å’Œå†…å­˜æ²¡æœ‰å¤§çš„å˜åŠ¨è§£å†³äº†è¯¥é—®é¢˜ï¼Œä¹Ÿåšåˆ°çœç”µã€é¡ºæ»‘ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Memory </span><br><span class="line">High:42.3M</span><br><span class="line">normal:14.1M</span><br><span class="line">CPU:</span><br><span class="line">Hight:6%</span><br><span class="line">normal:0%</span><br></pre></td></tr></table></figure><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">func resizedImage2(at url: URL, for size: CGSize) -&gt; UIImage?&#123;</span><br><span class="line">guard let imageSource &#x3D; CGImageSourceCreateWithURL(url as NSURL, nil),</span><br><span class="line">let image &#x3D; CGImageSourceCreateImageAtIndex(imageSource, 0, nil)</span><br><span class="line">else&#123;</span><br><span class="line">return nil;</span><br><span class="line">&#125;</span><br><span class="line">let cxt &#x3D; CGContext(data: nil,</span><br><span class="line">width: Int(size.width),</span><br><span class="line">height: Int(size.height),</span><br><span class="line">bitsPerComponent: image.bitsPerComponent,</span><br><span class="line">bytesPerRow: image.bytesPerRow,</span><br><span class="line">space: image.colorSpace ?? CGColorSpace(name: CGColorSpace.sRGB)!</span><br><span class="line">,</span><br><span class="line">bitmapInfo: image.bitmapInfo.rawValue)</span><br><span class="line">cxt?.interpolationQuality &#x3D; .high</span><br><span class="line">cxt?.draw(image, in: CGRect(origin: .zero, size: size))</span><br><span class="line">guard let scaledImage &#x3D; cxt?.makeImage() else &#123;</span><br><span class="line">return nil</span><br><span class="line">&#125;</span><br><span class="line">let ima &#x3D; UIImage(cgImage: scaledImage)</span><br><span class="line">return ima</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="3-ImageIO-åˆ›å»ºç¼©ç•¥å›¾"><a href="#3-ImageIO-åˆ›å»ºç¼©ç•¥å›¾" class="headerlink" title="3.ImageIO åˆ›å»ºç¼©ç•¥å›¾"></a>3.ImageIO åˆ›å»ºç¼©ç•¥å›¾</h4><p>ä½¿ç”¨<code>ImageIO</code> ä¸­åˆ›å»ºå›¾åƒï¼ŒCPUå’Œå†…å­˜è®°å½•åè€Œæ›´é«˜äº†ï¼Œå†…å­˜ä¹Ÿå±…é«˜ä¸ä¸‹ï¼Œæ—¶é—´ä¸ŠåŸºæœ¬2sæ‰å°†å›¾åƒç»˜åˆ¶å‡ºæ¥ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Memory </span><br><span class="line">High:320M</span><br><span class="line">normal:221M</span><br><span class="line">CPU:</span><br><span class="line">Hight:73%</span><br><span class="line">normal:0%</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">func resizedImage3(at url: URL, for size: CGSize) -&gt; UIImage?&#123;</span><br><span class="line"></span><br><span class="line">let ops:[CFString:Any] &#x3D; [kCGImageSourceCreateThumbnailFromImageIfAbsent:true,</span><br><span class="line">  kCGImageSourceCreateThumbnailWithTransform:true,</span><br><span class="line">  kCGImageSourceShouldCacheImmediately:true,</span><br><span class="line">  kCGImageSourceThumbnailMaxPixelSize:max(size.width, size.height)]</span><br><span class="line">guard let imageSource &#x3D; CGImageSourceCreateWithURL(url as NSURL, nil),</span><br><span class="line">let image &#x3D; CGImageSourceCreateImageAtIndex(imageSource, 0, ops as CFDictionary) else &#123;</span><br><span class="line">return nil;</span><br><span class="line">&#125;</span><br><span class="line">let ima &#x3D; UIImage(cgImage: image)</span><br><span class="line">printImageCost(image: ima)</span><br><span class="line">return ima</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="4-CoreImage-æ»¤é•œ"><a href="#4-CoreImage-æ»¤é•œ" class="headerlink" title="4.CoreImage æ»¤é•œ"></a>4.CoreImage æ»¤é•œ</h4><p>ä½¿ç”¨æ»¤é•œå¤„ç†åè€Œæœ‰ç‚¹éº»çƒ¦ï¼Œåœ¨iOSä¸æ˜¯ä¸“ä¸šå¤„ç†å›¾åƒçš„APPä¸­ç•¥å¾®è‡ƒè‚¿ï¼Œè€Œä¸”æ€§èƒ½ä¸æ˜¯å¾ˆå¥½ã€‚åœ¨é‡å¤åˆ é™¤æ·»åŠ æ“ä½œï¼Œç¬¬äºŒæ¬¡å‡ºç°äº†APPé—ªé€€é—®é¢˜ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Memory </span><br><span class="line">High:1.04G</span><br><span class="line">normal:566M</span><br><span class="line">CPU:</span><br><span class="line">Hight:73%</span><br><span class="line">normal:0%</span><br></pre></td></tr></table></figure><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func resizedImage4(at url: URL, for size: CGSize) -&gt; UIImage?&#123;</span><br><span class="line">let shareContext &#x3D; CIContext(options: [.useSoftwareRenderer:false])</span><br><span class="line"></span><br><span class="line"> guard let image &#x3D; CIImage(contentsOf: url) else &#123; return nil &#125;</span><br><span class="line">let fillter &#x3D; CIFilter(name: &quot;CILanczosScaleTransform&quot;)</span><br><span class="line">fillter?.setValue(image, forKey: kCIInputImageKey)</span><br><span class="line">fillter?.setValue(1, forKey: kCIInputScaleKey)</span><br><span class="line">guard let outPutCIImage &#x3D; fillter?.outputImage,let outputCGImage &#x3D; shareContext.createCGImage(outPutCIImage, from: outPutCIImage.extent) else &#123; return nil &#125;</span><br><span class="line"></span><br><span class="line">return UIImage(cgImage: outputCGImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h4 id="5-ä½¿ç”¨-vImage-ä¼˜åŒ–å›¾ç‰‡æ¸²æŸ“"><a href="#5-ä½¿ç”¨-vImage-ä¼˜åŒ–å›¾ç‰‡æ¸²æŸ“" class="headerlink" title="5.ä½¿ç”¨ vImage ä¼˜åŒ–å›¾ç‰‡æ¸²æŸ“"></a>5.ä½¿ç”¨ vImage ä¼˜åŒ–å›¾ç‰‡æ¸²æŸ“</h4><p>ä½¿ç”¨<code>vImage</code>åˆ›å»ºå›¾åƒæ€§èƒ½ç•¥ä½ï¼Œå†…å­˜ä½¿ç”¨è¾ƒå¤šï¼Œæ­¥éª¤éº»çƒ¦ï¼Œæ˜¯æˆ‘ä»¬è¯¥èˆå¼ƒçš„ã€‚åœ¨å†…å­˜åªæœ‰1Gçš„æ‰‹æœºä¸Šææ€•è¦<code>crash</code>äº†ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Memory </span><br><span class="line">High:998.7M</span><br><span class="line">normal:566M</span><br><span class="line">CPU:</span><br><span class="line">Hight:78%</span><br><span class="line">normal:0%</span><br></pre></td></tr></table></figure></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">func resizedImage5(at url: URL, for size: CGSize) -&gt; UIImage? &#123;</span><br><span class="line">    &#x2F;&#x2F; è§£ç æºå›¾åƒ</span><br><span class="line">    guard let imageSource &#x3D; CGImageSourceCreateWithURL(url as NSURL, nil),</span><br><span class="line">        let image &#x3D; CGImageSourceCreateImageAtIndex(imageSource, 0, nil),</span><br><span class="line">        let properties &#x3D; CGImageSourceCopyPropertiesAtIndex(imageSource, 0, nil) as? [CFString: Any],</span><br><span class="line">        let imageWidth &#x3D; properties[kCGImagePropertyPixelWidth] as? vImagePixelCount,</span><br><span class="line">        let imageHeight &#x3D; properties[kCGImagePropertyPixelHeight] as? vImagePixelCount</span><br><span class="line">    else &#123;</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; å®šä¹‰å›¾åƒæ ¼å¼</span><br><span class="line">    var format &#x3D; vImage_CGImageFormat(bitsPerComponent: 8,</span><br><span class="line">                                      bitsPerPixel: 32,</span><br><span class="line">                                      colorSpace: nil,</span><br><span class="line">                                      bitmapInfo: CGBitmapInfo(rawValue: CGImageAlphaInfo.first.rawValue),</span><br><span class="line">                                      version: 0,</span><br><span class="line">                                      decode: nil,</span><br><span class="line">                                      renderingIntent: .defaultIntent)</span><br><span class="line"></span><br><span class="line">    var error: vImage_Error</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; åˆ›å»ºå¹¶åˆå§‹åŒ–æºç¼“å†²åŒº</span><br><span class="line">    var sourceBuffer &#x3D; vImage_Buffer()</span><br><span class="line">    defer &#123; sourceBuffer.data.deallocate() &#125;</span><br><span class="line">    error &#x3D; vImageBuffer_InitWithCGImage(&amp;sourceBuffer,</span><br><span class="line">                                         &amp;format,</span><br><span class="line">                                         nil,</span><br><span class="line">                                         image,</span><br><span class="line">                                         vImage_Flags(kvImageNoFlags))</span><br><span class="line">    guard error &#x3D;&#x3D; kvImageNoError else &#123; return nil &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; åˆ›å»ºå¹¶åˆå§‹åŒ–ç›®æ ‡ç¼“å†²åŒº</span><br><span class="line">    var destinationBuffer &#x3D; vImage_Buffer()</span><br><span class="line">    error &#x3D; vImageBuffer_Init(&amp;destinationBuffer,</span><br><span class="line">                              vImagePixelCount(size.height),</span><br><span class="line">                              vImagePixelCount(size.width),</span><br><span class="line">                              format.bitsPerPixel,</span><br><span class="line">                              vImage_Flags(kvImageNoFlags))</span><br><span class="line">    guard error &#x3D;&#x3D; kvImageNoError else &#123; return nil &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ä¼˜åŒ–ç¼©æ”¾å›¾åƒ</span><br><span class="line">    error &#x3D; vImageScale_ARGB8888(&amp;sourceBuffer,</span><br><span class="line">                                 &amp;destinationBuffer,</span><br><span class="line">                                 nil,</span><br><span class="line">                                 vImage_Flags(kvImageHighQualityResampling))</span><br><span class="line">    guard error &#x3D;&#x3D; kvImageNoError else &#123; return nil &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ä»ç›®æ ‡ç¼“å†²åŒºåˆ›å»ºä¸€ä¸ª CGImage å¯¹è±¡</span><br><span class="line">    guard let resizedImage &#x3D;</span><br><span class="line">        vImageCreateCGImageFromBuffer(&amp;destinationBuffer,</span><br><span class="line">                                      &amp;format,</span><br><span class="line">                                      nil,</span><br><span class="line">                                      nil,</span><br><span class="line">                                      vImage_Flags(kvImageNoAllocate),</span><br><span class="line">                                      &amp;error)?.takeRetainedValue(),</span><br><span class="line">        error &#x3D;&#x3D; kvImageNoError</span><br><span class="line">    else &#123;</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return UIImage(cgImage: resizedImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å†…å­˜ä¼˜åŒ–"><a href="#å†…å­˜ä¼˜åŒ–" class="headerlink" title="å†…å­˜ä¼˜åŒ–"></a>å†…å­˜ä¼˜åŒ–</h3><p>å›¾ç‰‡è§£ç ååŠ è½½åœ¨å†…å­˜ä¸­çš„æ•°æ®éœ€è¦åœ¨æ°å½“çš„æ—¶æœºåˆ é™¤æ‰ï¼Œåœ¨åˆé€‚çš„æ—¶æœºæ·»åŠ ä¸Šï¼Œä¹Ÿæ˜¯ä¿æŒä½å†…å­˜ä½¿ç”¨ç‡çš„æ‰‹æ®µã€‚</p><p>åœ¨ç”¨æˆ·æ‹¨æ‰“ç”µè¯æˆ–è€…è¿›å…¥åˆ°å…¶ä»–APPä¸­å¯ä»¥å…ˆåˆ é™¤æ‰å¤§å›¾ç‰‡ï¼Œç­‰å›æ¥çš„æ—¶å€™å†æ¬¡æ·»åŠ ä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 1</span><br><span class="line">NotificationCenter.default.addObserver(forName: UIApplication.didEnterBackgroundNotification,</span><br><span class="line">   object: nil,</span><br><span class="line">   queue: .main)</span><br><span class="line">&#123;[weak self] (note) in</span><br><span class="line">self?.unloadImage()</span><br><span class="line">&#125;</span><br><span class="line">NotificationCenter.default.addObserver(forName: UIApplication.willEnterForegroundNotification,</span><br><span class="line">   object: nil,</span><br><span class="line">   queue: .main)</span><br><span class="line">&#123;[weak self] (note) in</span><br><span class="line">self?.loadImage()</span><br><span class="line">&#125;</span><br><span class="line"># 2</span><br><span class="line"></span><br><span class="line">override func viewWillAppear(_ animated: Bool) &#123;</span><br><span class="line">super.viewWillAppear(animated)</span><br><span class="line">self.loadImage()</span><br><span class="line">&#125;</span><br><span class="line">override func viewWillDisappear(_ animated: Bool) &#123;</span><br><span class="line">super.viewWillDisappear(animated)</span><br><span class="line">self.unloadImage()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>åŸºäºæ€§èƒ½ç»¼åˆè€ƒè™‘æ–¹æ³•1æ˜¯æœ€ç®€å•æœ€åˆé€‚çš„</li><li>ä½¿ç”¨æ»¤é•œå’Œ<code>vImage</code>ç•¥å¾®å¤æ‚ç‚¹ï¼Œå¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥ä¸ç”¨è€ƒè™‘äº†ã€‚</li><li>å›¾ç‰‡è§£ç ç¼“å­˜å’Œå›¾ç‰‡å¤§å°æœ‰å…³ï¼Œé€‚å½“çš„ä¸‹é‡‡æ ·æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</li></ul><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL3ZpZGVvcy9wbGF5L3d3ZGMyMDE4LzQxNg==" title="https://developer.apple.com/videos/play/wwdc2018/416">session 2018 416 iOS Memory Deep Dive<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL3ZpZGVvcy9wbGF5L3d3ZGMyMDE4LzIxOQ==" title="https://developer.apple.com/videos/play/wwdc2018/219">219_image_and_graphics_best_practices<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">WWDC ä¸­æ–‡å­—å¹•ä¸‹è½½<i class="fa fa-external-link"></i></span></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81ZGFhZjhiM2YyNjVkYTViNmYwNzRjOTgjaGVhZGluZy0x" title="https://juejin.im/post/5daaf8b3f265da5b6f074c98#heading-1">swift gg å›¾åƒä¼˜åŒ–<i class="fa fa-external-link"></i></span></p></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½git<i class="fa fa-external-link"></i></span></p></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlcg==" title="https://github.com/ifgyong/demo/tree/master">demo code git<i class="fa fa-external-link"></i></span></li></ul><h2 id="å”¯æœ‰å®è·µæ‰æ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†"><a href="#å”¯æœ‰å®è·µæ‰æ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†" class="headerlink" title="å”¯æœ‰å®è·µæ‰æ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†"></a><strong>å”¯æœ‰å®è·µæ‰æ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†</strong></h2><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p><p>å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åŸºäºç°åœ¨iOS11æ–°ç”Ÿæˆçš„å›¾ç‰‡éƒ½æ˜¯&lt;code&gt;HEIF&lt;/code&gt;ï¼Œè¯¥å›¾ç‰‡ä½¿ç”¨&lt;code&gt;[UIImage image:name]&lt;/code&gt;å·²ä¸åœ¨é‚£ä¹ˆä¼˜é›…ï¼Œå›¾ç‰‡å¤§å°ä¸º1.8må¤§å°çš„ï¼Œè¯»è¿›æ‰‹æœºå†…å­˜ï¼Œç›´æ¥é£™å‡äº†45Mï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸æƒ³çœ‹åˆ°çš„ç»“æœï¼Œä¸€ä¸ªé¡µé¢æœ‰å¤šä¸ªè¿™æ ·å­çš„å›¾çš„è¯ï¼Œ
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>MVCã€MVPã€MVVMã€åˆ†å±‚è®¾è®¡æµ…è°ˆ â€” (13)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20MVC%E3%80%81MVP%E3%80%81MVVM%E3%80%81%E5%88%86%E5%B1%82%E8%AE%BE%E8%AE%A1%E6%B5%85%E8%B0%88%20%E2%80%94%20(13)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20MVC%E3%80%81MVP%E3%80%81MVVM%E3%80%81%E5%88%86%E5%B1%82%E8%AE%BE%E8%AE%A1%E6%B5%85%E8%B0%88%20%E2%80%94%20(13)/</id>
    <published>2019-12-01T03:23:58.000Z</published>
    <updated>2020-09-04T04:40:21.657Z</updated>
    
    <content type="html"><![CDATA[<p>è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è§£å…³äºæ¶æ„çš„ä¸€äº›æ€è€ƒï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« ä½ å°†äº†è§£åˆ°</p><blockquote><ol><li>MVC</li><li>MVCå˜ç§</li><li>MVP</li><li>MVVM</li><li>åˆ†å±‚è®¾è®¡çš„ä¼˜ç¼ºç‚¹</li></ol></blockquote><p>æ²¡æœ‰æœ€å¥½çš„æ¶æ„ï¼Œåªæœ‰æœ€é€‚åˆä¸šåŠ¡çš„æ¶æ„ã€‚</p><h3 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h3><p>è‹¹æœç‰ˆæœ¬çš„<code>MVC</code>æ˜¯<code>Model</code>å’Œ<code>VC</code>å’Œäº¤äº’ï¼Œ<code>VC</code>å’Œ<code>View</code>äº¤äº’</p><ul><li><p>ä¼˜ç‚¹ï¼š<code>View</code>å’Œ<code>Model</code>å¯ä»¥é‡å¤åˆ©ç”¨ï¼Œå¯ä»¥ç‹¬ç«‹ä½¿ç”¨</p></li><li><p>ç¼ºç‚¹ï¼š<code>Controller</code>çš„ä»£ç è¿‡äºè‡ƒè‚¿</p></li></ul><p><img src="/images/13-1.png" alt></p><p>ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    [self loadData];</span><br><span class="line">&#125;</span><br><span class="line">- (void)loadData&#123;</span><br><span class="line">    self.data&#x3D;[NSMutableArray array];</span><br><span class="line">    for (int i &#x3D; 0; i &lt; 20; i ++) &#123;</span><br><span class="line">        FYNews *item&#x3D;[FYNews new];</span><br><span class="line">        item.title &#x3D;[NSString stringWithFormat:@&quot;title-%d&quot;,i];</span><br><span class="line">        item.name &#x3D;[NSString stringWithFormat:@&quot;name-%d&quot;,i];</span><br><span class="line">        [self.data addObject:item];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section &#123;</span><br><span class="line">    return self.data.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath &#123;</span><br><span class="line">    UITableViewCell *cell &#x3D; [tableView dequeueReusableCellWithIdentifier:@&quot;cell&quot; forIndexPath:indexPath];</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; Configure the cell...</span><br><span class="line">    FYNews *item &#x3D;[self.data objectAtIndex:indexPath.row];</span><br><span class="line">    cell.detailTextLabel.text &#x3D;item.title;</span><br><span class="line">    cell.textLabel.text &#x3D; item.name;</span><br><span class="line">    return cell;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;model</span><br><span class="line"></span><br><span class="line">@interface FYNews : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *title;</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯<code>VC</code>ä¸­ç»„è£…äº†<code>tableview</code>ï¼Œ<code>model</code>çš„æ•°æ®åœ¨<code>VC</code>ä¸­åœ¨<code>view</code>ä¸­æ˜¾ç¤ºå‡ºæ¥ï¼Œå½“éœ€è¦å¦å¤–çš„æ•°æ®çš„æ—¶å€™ï¼Œåªéœ€è¦å°†<code>model</code>æ”¹æˆéœ€è¦çš„<code>model</code>è€Œæ— éœ€æ›´æ”¹<code>tableview</code>çš„ä»£ç å…¼å®¹æ€§è¾ƒå¥½ã€‚</p><h3 id="MVCå˜ç§"><a href="#MVCå˜ç§" class="headerlink" title="MVCå˜ç§"></a>MVCå˜ç§</h3><p><code>MVC</code>å˜ç§ï¼Œå…¶å®å°±æ˜¯å°†<code>model</code>å’Œ<code>view</code>å»ºç«‹äº†è”ç³»ï¼Œ<code>view</code>ä¾æ®<code>Model</code>æ¥å±•ç¤ºæ•°æ®ï¼Œ<code>VC</code>ç»„è£…<code>Model</code>ï¼Œç»„è£…å±•ç¤ºæ˜¯åœ¨<code>view</code>ä¸­å®ç°ã€‚</p><ul><li><p>ä¼˜ç‚¹ï¼šå¯¹Controllerè¿›è¡Œç˜¦èº«ï¼Œå°†Viewçš„å†…éƒ¨ç»†èŠ‚å°è£…èµ·æ¥äº†ï¼Œå¤–ç•Œä¸çŸ¥é“Viewå†…éƒ¨çš„å…·ä½“å®ç°</p></li><li><p>ç¼ºç‚¹ï¼šviewä¾èµ–äºModel</p></li></ul><p><img src="/images/13-2.png" alt></p><p>ä»£ç å®ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;.h</span><br><span class="line">@class FYItemModel;</span><br><span class="line">@interface FYAppleView : UIView</span><br><span class="line">@property (nonatomic,strong) FYItemModel *model;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;.m</span><br><span class="line">@interface FYAppleView()</span><br><span class="line">@property (nonatomic,strong) UILabel *nameLabel;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYAppleView</span><br><span class="line">-(instancetype)initWithFrame:(CGRect)frame&#123;</span><br><span class="line">    if (self &#x3D;[super initWithFrame:frame]) &#123;</span><br><span class="line">        _nameLabel&#x3D;[[UILabel alloc]initWithFrame:CGRectMake(0, 0, 100, 30)];</span><br><span class="line">        [self addSubview:_nameLabel];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;*</span><br><span class="line">  mvcçš„å˜ç§</span><br><span class="line"> *&#x2F;</span><br><span class="line">- (void)setModel:(FYItemModel *)model&#123;</span><br><span class="line">    _model &#x3D; model;</span><br><span class="line">    _nameLabel.textColor &#x3D; model.bgColor;</span><br><span class="line">    _nameLabel.text &#x3D; model.name;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;FYItemModel</span><br><span class="line">@interface FYItemModel : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@property (nonatomic,strong) UIColor *bgColor;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ViewController</span><br><span class="line">@interface ViewController ()</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    [self loadViewOtherMVC];</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;å˜ç§MVC æŠŠViewå’ŒModelå»ºç«‹èµ·è¿æ¥</span><br><span class="line">&#x2F;&#x2F;ç­‰ä»¥åæ›´æ–°viewæ•°æ®åªéœ€è¦ view.model &#x3D; item;Controllrå°‘äº†è®¸å¤šä»£ç </span><br><span class="line">- (void)loadViewOtherMVC&#123;</span><br><span class="line">    FYAppleView * view &#x3D;[[FYAppleView alloc]initWithFrame:CGRectMake(200, 200, 100, 30)];</span><br><span class="line">    FYItemModel *item&#x3D;[[FYItemModel alloc]init];</span><br><span class="line">    item.name &#x3D; @&quot;æ ¡é•¿æ¥äº†&quot;;</span><br><span class="line">    item.bgColor &#x3D; [UIColor redColor];</span><br><span class="line">    view.model &#x3D; item;</span><br><span class="line">    [self.view addSubview:view];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>model</code>ç»„è£…åˆ°<code>view</code>å±•ç¤ºå†…å®¹æ˜¯åœ¨<code>view</code>å®ç°çš„ï¼Œå¤–éƒ¨ä¸çŸ¥é“ç»†èŠ‚ï¼Œåªéœ€è¦å°†<code>model</code>ç»™<code>view</code>å³å¯ï¼Œä½†æ˜¯åªèƒ½ä¼ è¾“è¿‡æ¥<code>model</code>æˆ–è€…ä»–å­ç±»ï¼Œä¸šåŠ¡æ›´æ”¹çš„è¯ï¼Œéœ€è¦ä¿®æ”¹<code>view</code>çš„å†…éƒ¨<code>model</code>æ‰èƒ½å°†å˜æ›´è¿‡çš„æ•°æ®é‡æ–°å±•ç¤ºå‡ºæ¥ã€‚</p><p>æƒ³è¦ç›‘å¬viewçš„ç‚¹å‡»äº‹ä»¶æ¥åšä¸€äº›æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»£ç†å’Œ<code>block</code>,è¿™é‡Œ<code>id</code>æ˜¯å®ç°äº†<code>FYAppleViewProtocol</code>åè®®çš„ï¼Œ<code>weak</code>ä¿®é¥°é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼Œä½¿ç”¨åè®®å®ç°äº†å’Œ<code>VC</code>çš„é€šä¿¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@class FYAppleView;</span><br><span class="line">@protocol FYAppleViewProtocol &lt;NSObject&gt;</span><br><span class="line">- (void)FYAppleViewDidClick:(FYAppleView*)view;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@class FYItemModel;</span><br><span class="line">@interface FYAppleView : UIView</span><br><span class="line">@property (nonatomic,strong,readonly) UILabel *nameLabel;</span><br><span class="line">@property (nonatomic,weak) id&lt;FYAppleViewProtocol&gt; delegate;</span><br><span class="line">@property (nonatomic,strong) FYItemModel *model;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>ç¨ä½œæ›´æ”¹è¿˜æ˜¯<code>apple-MVC</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; .h</span><br><span class="line">@class FYItemModel;</span><br><span class="line">@interface FYAppleView : UIView</span><br><span class="line">@property (nonatomic,strong,readonly) UILabel *nameLabel;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>å°†<code>View</code>å±æ€§<code>nameLabel</code>æš´éœ²å‡ºæ¥ï¼Œä½†æ˜¯ä¸å…è®¸å¤–ç•Œè¿›è¡Œæ›´æ”¹ï¼Œå»æ‰<code>model</code>åˆ™æ˜¯<code>MVC</code>ã€‚</p><h3 id="MVP"><a href="#MVP" class="headerlink" title="MVP"></a>MVP</h3><p><code>MVP</code>å’Œ<code>MVC</code>å¾ˆåƒï¼Œåªæ˜¯å°†<code>VC</code>æ¢æˆäº†<code>Presenter</code>ï¼Œ<code>vc</code>å’Œ<code>Present</code>åšçš„äº‹æƒ…åŸºæœ¬ä¸€è‡´ï¼Œå°†<code>view</code>å’Œ<code>Model</code>é€šä¿¡æ”¹åˆ°äº†éƒ½å’Œ<code>Presenter</code>é€šä¿¡ã€‚</p><p><img src="/images/13-3.png" alt><br>ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;MVP</span><br><span class="line">&#x2F;&#x2F;.h</span><br><span class="line">@interface FYNewsPresenter : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic,weak) UIViewController *vc;</span><br><span class="line">&#x2F;&#x2F;åˆå§‹åŒ–</span><br><span class="line">- (void)setup;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">.m</span><br><span class="line">#import &quot;FYNewsPresenter.h&quot;</span><br><span class="line">@interface FYNewsPresenter()&lt;FYAppleViewProtocol&gt;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYNewsPresenter</span><br><span class="line">- (void)setup&#123;</span><br><span class="line">FYAppleView * view &#x3D;[[FYAppleView alloc]initWithFrame:CGRectMake(200, 200, 100, 30)];</span><br><span class="line">FYItemModel *item&#x3D;[[FYItemModel alloc]init];</span><br><span class="line">item.name &#x3D; @&quot;æ ¡é•¿æ¥äº†&quot;;</span><br><span class="line">item.bgColor &#x3D; [UIColor redColor];</span><br><span class="line">view.model &#x3D; item;</span><br><span class="line">[self.vc.view addSubview:view];</span><br><span class="line">&#125;</span><br><span class="line">- (void)FYAppleViewDidClick:(FYAppleView *)view&#123;</span><br><span class="line">NSLog(@&quot;ç‚¹å‡»äº†æˆ‘&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;VCä¸­</span><br><span class="line">@interface ViewController ()</span><br><span class="line">@property (nonatomic,strong) FYNewsPresenter *presenter;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">_presenter&#x3D;[FYNewsPresenter new];</span><br><span class="line">_presenter.vc &#x3D; self;</span><br><span class="line">[_presenter setup];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>å†æ¬¡å¯¹<code>VC</code>è¿›è¡Œäº†ç˜¦èº«ï¼Œå°†æ›´å¤šçš„ä¸šåŠ¡é€»è¾‘æ¬åˆ°äº†<code>FYNewsPresenter</code>å¤„ç†ï¼Œå…¶å®å…¨éƒ¨æ¬è¿‡å»ï¼Œæ„ä¹‰æ¯”ä¸å¤§ï¼Œ<code>FYNewsPresenter</code>ä¹Ÿä¼šè‡ƒè‚¿ï¼Œä¹Ÿä¼šå‡ºç°å’Œ<code>VC</code>ä¸€æ ·çš„å›°æƒ‘ã€‚</p><h3 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h3><p><code>MVVM</code>æ˜¯å°†<code>FYNewsPresenter</code>éƒ½æ¬åˆ°äº†<code>FYNewsViewModel</code>ä¸­ï¼Œç„¶åå¯¹<code>FYNewsViewModel</code>å’Œ<code>View</code>è¿›è¡Œäº†ä¸€ä¸ªåŒå‘ç»‘å®šï¼ŒåŒå‘ç»‘å®šå¯ä»¥ä½¿ç”¨ä»£ç†ï¼Œ<code>block</code>æˆ–è€…<code>KVO</code>å®ç°ã€‚<br><img src="/images/13-4.png" alt><br>ä»£ç å®ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">@interface FYNewsViewModel : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@property (nonatomic,strong) UIColor *bgColor;</span><br><span class="line"></span><br><span class="line">@property (nonatomic,weak) UIViewController *vc;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithController:(UIViewController *)vc;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#import &quot;FYNewsViewModel.h&quot;</span><br><span class="line">@interface FYNewsViewModel()&lt;FYAppleViewProtocol&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line">@implementation FYNewsViewModel</span><br><span class="line">- (instancetype)initWithController:(UIViewController *)vc&#123;</span><br><span class="line">    if (self &#x3D;[super init]) &#123;</span><br><span class="line">        self.vc &#x3D; vc;</span><br><span class="line">        </span><br><span class="line">        FYAppleView * view &#x3D;[[FYAppleView alloc]initWithFrame:CGRectMake(100, 200, 100, 50)];</span><br><span class="line">        &#x2F;&#x2F;    view.model &#x3D; item;</span><br><span class="line">        view.delegate &#x3D; self;</span><br><span class="line">        view.viewModel &#x3D; self; &#x2F;&#x2F;å»ºç«‹kvo</span><br><span class="line">        </span><br><span class="line">        view.backgroundColor &#x3D; [UIColor lightGrayColor];</span><br><span class="line">        [vc.view addSubview:view];</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        FYItemModel *item&#x3D;[[FYItemModel alloc]init];</span><br><span class="line">        item.name &#x3D; @&quot;æ ¡é•¿æ¥äº†&quot;;</span><br><span class="line">        item.bgColor &#x3D; [UIColor redColor];</span><br><span class="line">        </span><br><span class="line">        self.name &#x3D; item.name;</span><br><span class="line">        self.bgColor &#x3D; item.bgColor;</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)FYAppleViewDidClick:(FYAppleView *)view&#123;</span><br><span class="line">NSLog(@&quot;ç‚¹å‡»äº†æˆ‘&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>åœ¨<code>view</code>å®ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">@class FYAppleView,FYNewsViewModel;</span><br><span class="line">@protocol FYAppleViewProtocol &lt;NSObject&gt;</span><br><span class="line"></span><br><span class="line">- (void)FYAppleViewDidClick:(FYAppleView*)view;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@class FYItemModel;</span><br><span class="line"></span><br><span class="line">@interface FYAppleView : UIView</span><br><span class="line">@property (nonatomic,strong,readonly) UILabel *nameLabel;</span><br><span class="line"></span><br><span class="line">@property (nonatomic,weak) id&lt;FYAppleViewProtocol&gt; delegate;</span><br><span class="line">@property (nonatomic,weak) FYNewsViewModel *viewModel;</span><br><span class="line"></span><br><span class="line">@property (nonatomic,strong) FYItemModel *model;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@interface FYAppleView()</span><br><span class="line">@property (nonatomic,strong) UILabel *nameLabel;</span><br><span class="line">@end</span><br><span class="line">@implementation FYAppleView</span><br><span class="line">-(instancetype)initWithFrame:(CGRect)frame&#123;</span><br><span class="line">    if (self &#x3D;[super initWithFrame:frame]) &#123;</span><br><span class="line">        _nameLabel&#x3D;[[UILabel alloc]initWithFrame:CGRectMake(0, 0, 100, 30)];</span><br><span class="line">        [self addSubview:_nameLabel];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;*</span><br><span class="line">  mvcçš„å˜ç§</span><br><span class="line"> *&#x2F;</span><br><span class="line">- (void)setModel:(FYItemModel *)model&#123;</span><br><span class="line">    _model &#x3D; model;</span><br><span class="line">    _nameLabel.textColor &#x3D; model.bgColor;</span><br><span class="line">    _nameLabel.text &#x3D; model.name;</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setViewModel:(FYNewsViewModel *)viewModel&#123;</span><br><span class="line">    _viewModel &#x3D; viewModel;</span><br><span class="line">   [_viewModel addObserver:self forKeyPath:@&quot;name&quot; options:NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld context:nil];</span><br><span class="line">   &#x2F;&#x2F;ä½¿ç”¨FBKVOå®ç° æˆ–è€…è‡ªå·±ä½¿ç”¨KVOå®ç°</span><br><span class="line">&#x2F;&#x2F;    __weak typeof(self) waekSelf &#x3D; self;</span><br><span class="line">&#x2F;&#x2F;    [self.KVOController observe:viewModel keyPath:@&quot;name&quot;</span><br><span class="line">&#x2F;&#x2F;                        options:NSKeyValueObservingOptionNew</span><br><span class="line">&#x2F;&#x2F;                          block:^(id  _Nullable observer, id  _Nonnull object, NSDictionary&lt;NSKeyValueChangeKey,id&gt; * _Nonnull change) &#123;</span><br><span class="line">&#x2F;&#x2F;        waekSelf.nameLabel.text &#x3D; change[NSKeyValueChangeNewKey];</span><br><span class="line">&#x2F;&#x2F;    &#125;];</span><br><span class="line">&#125;</span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context&#123;</span><br><span class="line">    if ([keyPath isEqualToString:@&quot;name&quot;]) &#123;</span><br><span class="line">        self.nameLabel.text &#x3D; change[NSKeyValueChangeNewKey];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;æ·»åŠ ç‚¹å‡»äº‹ä»¶</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">if ([self.delegate respondsToSelector:@selector(FYAppleViewDidClick:)]) &#123;</span><br><span class="line">[self.delegate FYAppleViewDidClick:self];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)dealloc&#123;</span><br><span class="line">    [_viewModel removeObserver:self</span><br><span class="line">                    forKeyPath:@&quot;name&quot;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>KVO</code>æˆ–è€…<code>FBKVO</code>æˆ–è€…<code>RAC</code>éƒ½æ˜¯å¯ä»¥çš„ï¼Œæœ¬ç« èŠ‚ä¾‹å­ç»™å‡ºäº†<code>FBKVO</code>æˆ–è€…è‡ªå·±ä½¿ç”¨<code>KVO</code>çš„å®ç°ã€‚</p><h3 id="åˆ†å±‚è®¾è®¡"><a href="#åˆ†å±‚è®¾è®¡" class="headerlink" title="åˆ†å±‚è®¾è®¡"></a>åˆ†å±‚è®¾è®¡</h3><p>ä¸‰å±‚æ¶æ„ï¼š</p><blockquote><p>ä¸‰å±‚æ¶æ„(3-tier architecture) é€šå¸¸æ„ä¹‰ä¸Šçš„ä¸‰å±‚æ¶æ„å°±æ˜¯å°†æ•´ä¸ªä¸šåŠ¡åº”ç”¨åˆ’åˆ†ä¸ºï¼šç•Œé¢å±‚ï¼ˆUser Interface layerï¼‰ã€ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆBusiness Logic Layerï¼‰ã€æ•°æ®è®¿é—®å±‚ï¼ˆData access layerï¼‰ã€‚åŒºåˆ†å±‚æ¬¡çš„ç›®çš„å³ä¸ºäº†â€œé«˜å†…èšä½è€¦åˆâ€çš„æ€æƒ³ã€‚åœ¨è½¯ä»¶ä½“ç³»æ¶æ„è®¾è®¡ä¸­ï¼Œåˆ†å±‚å¼ç»“æ„æ˜¯æœ€å¸¸è§ï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ç§ç»“æ„ã€‚å¾®è½¯æ¨èçš„åˆ†å±‚å¼ç»“æ„ä¸€èˆ¬åˆ†ä¸ºä¸‰å±‚ï¼Œä»ä¸‹è‡³ä¸Šåˆ†åˆ«ä¸ºï¼šæ•°æ®è®¿é—®å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆåˆæˆ–ç§°ä¸ºé¢†åŸŸå±‚ï¼‰ã€è¡¨ç¤ºå±‚</p></blockquote><ul><li><p>ç›®çš„: â€œé«˜å†…èšï¼Œä½è€¦åˆâ€çš„æ€æƒ³ </p></li><li><p>ä¼˜ç‚¹: é™ä½å±‚ä¸å±‚ä¹‹é—´çš„ä¾èµ– æ ‡å‡†åŒ– </p></li><li><p>ç¼ºç‚¹: ç³»ç»Ÿæ¶æ„å¤æ‚ï¼Œä¸é€‚åˆå°å‹é¡¹ç›®</p></li></ul><h4 id="ä¸‰å±‚åŸç†"><a href="#ä¸‰å±‚åŸç†" class="headerlink" title="ä¸‰å±‚åŸç†"></a>ä¸‰å±‚åŸç†</h4><blockquote><p>3ä¸ªå±‚æ¬¡ä¸­ï¼Œç³»ç»Ÿä¸»è¦åŠŸèƒ½å’Œä¸šåŠ¡é€»è¾‘éƒ½åœ¨ä¸šåŠ¡é€»è¾‘å±‚è¿›è¡Œå¤„ç†ã€‚<br>æ‰€è°“ä¸‰å±‚ä½“ç³»ç»“æ„ï¼Œæ˜¯åœ¨å®¢æˆ·ç«¯ä¸æ•°æ®åº“ä¹‹é—´åŠ å…¥äº†ä¸€ä¸ª<code>ä¸­é—´å±‚</code>ï¼Œä¹Ÿå«ç»„ä»¶å±‚ã€‚è¿™é‡Œæ‰€è¯´çš„ä¸‰å±‚ä½“ç³»ï¼Œä¸æ˜¯æŒ‡ç‰©ç†ä¸Šçš„ä¸‰å±‚ï¼Œä¸æ˜¯ç®€å•åœ°æ”¾ç½®ä¸‰å°æœºå™¨å°±æ˜¯ä¸‰å±‚ä½“ç³»ç»“æ„ï¼Œä¹Ÿä¸ä»…ä»…æœ‰<code>B/S</code>åº”ç”¨æ‰æ˜¯ä¸‰å±‚ä½“ç³»ç»“æ„ï¼Œä¸‰å±‚æ˜¯æŒ‡é€»è¾‘ä¸Šçš„ä¸‰å±‚ï¼Œå³æŠŠè¿™ä¸‰ä¸ªå±‚æ”¾ç½®åˆ°ä¸€å°æœºå™¨ä¸Šã€‚</p><p>ä¸‰å±‚ä½“ç³»çš„åº”ç”¨ç¨‹åºå°†ä¸šåŠ¡è§„åˆ™ã€æ•°æ®è®¿é—®ã€åˆæ³•æ€§æ ¡éªŒç­‰å·¥ä½œæ”¾åˆ°äº†ä¸­é—´å±‚è¿›è¡Œå¤„ç†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ä¸ç›´æ¥ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ï¼Œè€Œæ˜¯é€šè¿‡<code>COM/DCOM</code>é€šè®¯ä¸ä¸­é—´å±‚å»ºç«‹è¿æ¥ï¼Œå†ç»ç”±ä¸­é—´å±‚ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚</p><p>ä¸‰å±‚æ¶æ„ä¸­ä¸»è¦åŠŸèƒ½ä¸ä¸šåŠ¡é€»è¾‘ä¸€èˆ¬è¦åœ¨ä¸šåŠ¡é€»è¾‘å±‚è¿›è¡Œä¿¡æ¯å¤„ç†å’Œå®ç°ï¼Œå…¶ä¸­ä¸‰å±‚ä½“ç³»æ¶æ„ä¸­çš„å®¢æˆ·ç«¯å’Œæ•°æ®åº“è¦é¢„è®¾ä¸­é—´å±‚ï¼Œæˆä¸ºç»„å»ºå±‚ã€‚ä¸‰å±‚æ¶æ„ä¸­çš„ä¸‰å±‚å…·æœ‰ä¸€å®šçš„é€»è¾‘æ€§ï¼Œå³æ˜¯å°†ä¸‰å±‚è®¾ç½®åˆ°åŒä¸€ä¸ªè®¡ç®—æœºç³»ç»Ÿä¸­ï¼ŒæŠŠä¸šåŠ¡åè®®ã€åˆæ³•æ ¡éªŒä»¥åŠæ•°æ®è®¿é—®ç­‰ç¨‹åºå½’ç½®åˆ°ä¸­é—´å±‚è¿›è¡Œä¿¡æ¯å¤„ç†ï¼Œä¸€èˆ¬å®¢æˆ·ç«¯æ— æ³•å’Œæ•°æ®åº“è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œä¸»è¦æ˜¯åˆ©ç”¨<code>COM/DCOM</code>é€šè®¯å’Œä¸­é—´å±‚æ„å»ºè¡”æ¥é€šé“ï¼Œå®ç°ä¸­é—´å±‚ä¸æ•°æ®åº“çš„æ•°æ®ä¼ è¾“ï¼Œè¿›è€Œå®ç°å®¢æˆ·ç«¯ä¸æ˜¯æ•°æ®åº“çš„äº¤äº’</p></blockquote><p><code>MVC</code>ã€<code>MVVM</code>ã€<code>MVP</code>å±äºç•Œé¢å±‚ï¼Œ<br>å½“ä¸šåŠ¡å¤æ‚ï¼Œç½‘ç»œè¯·æ±‚å’Œdbæ“ä½œè¾¾åˆ°äº†ä¸€ä¸ªæ–°çš„é«˜åº¦ï¼Œç•Œé¢å¤æ‚åˆ°éœ€è¦å¥½å¤šäººæ¥åšï¼Œé‚£ä¹ˆç•Œé¢ã€ä¸šåŠ¡ã€æ•°æ®éœ€è¦åˆ†å±‚äº†</p><p>åˆ†å±‚ä¹‹åï¼Œå¾—åˆ°äº†ä¸€ä¸ªä¸‰å±‚æ¶æ„æˆ–å››å±‚æ¶æ„</p><p><img src="/images/13-5.png" alt="ä¸‰å±‚æ¶æ„"></p><p>æ•°æ®å±‚ä¹Ÿå¯ä»¥åˆ†ä¸ºä¸¤å±‚ï¼Œåˆ†ä¸ºç½‘ç»œè¯·æ±‚å’Œdbå±‚ã€‚</p><p><img src="/images/13-6.png" alt="å››å±‚æ¶æ„"></p><p>å…·ä½“åœ¨å·¥ç¨‹ä¸­æˆ‘ä»¬é€šå¸¸è¿™æ ·ä½“ç°</p><p><img src="/images/13-7.png" alt></p><p>åœ¨<code>vc</code>ä¸­è·å–æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@interface ViewController ()</span><br><span class="line">@property (nonatomic,strong) FYDBPool *db;</span><br><span class="line">@property (nonatomic,strong) FYHttpPool *http;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">[super viewDidLoad];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å½“æœ‰ä¸šåŠ¡å±‚</span><br><span class="line">[[FYNewsService new] loadNewsWithInfo:nil success:^(NSArray * _Nonnull) &#123;</span><br><span class="line"></span><br><span class="line">&#125; fail:^&#123;</span><br><span class="line"></span><br><span class="line">&#125;];</span><br><span class="line">&#x2F;&#x2F;å½“æ²¡æœ‰æœ‰ä¸šåŠ¡å±‚</span><br><span class="line">self.db&#x3D;[FYDBPool new];</span><br><span class="line">self.http&#x3D;[FYHttpPool new];</span><br><span class="line">[self.db loadNewsWithInfo:@&#123;&#125; success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">if ([ret count]) &#123;</span><br><span class="line">NSLog(@&quot;æ•°æ®è·å–æˆåŠŸ&quot;);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">[self.http loadNewsWithInfo:@&#123;&#125; success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">NSLog(@&quot;æ•°æ®è·å–æˆåŠŸ&quot;);</span><br><span class="line">&#125; fail:^&#123;</span><br><span class="line">NSLog(@&quot;æ•°æ®è·å–å¤±è´¥&quot;);</span><br><span class="line">&#125;];</span><br><span class="line">&#125;</span><br><span class="line">&#125; fail:^&#123;</span><br><span class="line">[self.http loadNewsWithInfo:@&#123;&#125; success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">NSLog(@&quot;æ•°æ®è·å–æˆåŠŸ&quot;);</span><br><span class="line">&#125; fail:^&#123;</span><br><span class="line">NSLog(@&quot;æ•°æ®è·å–å¤±è´¥&quot;);</span><br><span class="line">&#125;];</span><br><span class="line">&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸šåŠ¡å±‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@interface FYNewsService ()</span><br><span class="line">@property (nonatomic,strong) FYDBPool *db;</span><br><span class="line">@property (nonatomic,strong) FYHttpPool *http;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line">@implementation FYNewsService</span><br><span class="line">-(instancetype)init&#123;</span><br><span class="line">if (self &#x3D; [super init]) &#123;</span><br><span class="line">self.db&#x3D;[FYDBPool new];</span><br><span class="line">self.http&#x3D;[FYHttpPool new];</span><br><span class="line">&#125;</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)loadNewsWithInfo:(NSDictionary *)info</span><br><span class="line"> success:(succcessCallback )succblock</span><br><span class="line">fail:(dispatch_block_t)failBlock&#123;</span><br><span class="line">[self.db loadNewsWithInfo:info success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">if ([ret count]) &#123;</span><br><span class="line">succblock(ret);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">[self.http loadNewsWithInfo:info success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">succblock(ret);</span><br><span class="line">&#125; fail:failBlock];</span><br><span class="line">&#125;</span><br><span class="line">&#125; fail:^&#123;</span><br><span class="line">[self.http loadNewsWithInfo:info success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">succblock(ret);</span><br><span class="line">&#125; fail:failBlock];</span><br><span class="line">&#125;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>åœ¨dbå±‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef void(^succcessCallback)(NSArray *);</span><br><span class="line">@interface FYDBPool : NSObject</span><br><span class="line">- (void)loadNewsWithInfo:(NSDictionary *)info</span><br><span class="line"> success:(succcessCallback )succblock</span><br><span class="line">fail:(dispatch_block_t)failBlock;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>åœ¨ç½‘ç»œè¯·æ±‚å±‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef void(^succcessCallback)(NSArray *);</span><br><span class="line">@interface FYHttpPool : NSObject</span><br><span class="line">- (void)loadNewsWithInfo:(NSDictionary *)info</span><br><span class="line"> success:(succcessCallback )succblock</span><br><span class="line">fail:(dispatch_block_t)failBlock;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>åˆ†å±‚ç›®çš„æ˜¯ç˜¦èº«ï¼Œé€»è¾‘æ¸…æ™°ï¼Œä¸šåŠ¡æ¸…æ™°ï¼Œé™ä½è€¦åˆï¼Œå½“æŸä¸€å—è¶³å¤Ÿå¤æ‚æ—¶å€™ï¼Œéƒ½å¯ä»¥è¿›è¡Œåˆ†å±‚ï¼Œä¸å±€é™äºç½‘ç»œæˆ–<code>db</code>ï¼Œå½“<code>db</code>è¶³å¤Ÿå¤æ‚ï¼Œä¹Ÿéœ€è¦è¿›è¡Œä¸€ä¸ªåˆ†å±‚æ¥è§£å†³å¤æ‚è°ƒç”¨å’Œå¤„ç†çš„é—®é¢˜ã€‚<br>ä¸åŒçš„äººæ¥å¤„ç†ä¸åŒçš„åˆ†å±‚ï¼Œç›¸äº’å½±å“ä¹Ÿæ¯”è¾ƒå°ï¼Œé™ä½è€¦åˆã€‚</p><p><strong>å½“é€»è¾‘å±‚è¶³å¤Ÿå®Œå–„ï¼Œåˆ™UIå±‚å¦‚ä½•å˜åŠ¨éƒ½ä¸éœ€è¦æ›´æ”¹é€»è¾‘å±‚ã€‚</strong></p><h3 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h3><p>ä¼˜é›…çš„ä»£ç æ€»æ˜¯ä¼´éšç€å„ç§ä¼ ç»Ÿè®¾è®¡æ¨¡å¼çš„æ­é…</p><h4 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h4><blockquote><p>è®¾è®¡æ¨¡å¼ï¼ˆDesign Patternï¼‰<br>æ˜¯ä¸€å¥—è¢«åå¤ä½¿ç”¨ã€ä»£ç è®¾è®¡ç»éªŒçš„æ€»ç»“<br>ä½¿ç”¨è®¾è®¡æ¨¡å¼çš„å¥½å¤„æ˜¯ï¼šå¯é‡ç”¨ä»£ç ã€è®©ä»£ç æ›´å®¹æ˜“è¢«ä»–äººç†è§£ã€ä¿è¯ä»£ç å¯é æ€§<br>ä¸€èˆ¬ä¸ç¼–ç¨‹è¯­è¨€æ— å…³ï¼Œæ˜¯ä¸€å¥—æ¯”è¾ƒæˆç†Ÿçš„ç¼–ç¨‹æ€æƒ³</p></blockquote><p>è®¾è®¡æ¨¡å¼å¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»</p><ol><li><p>åˆ›å»ºå‹æ¨¡å¼ï¼šå¯¹è±¡å®ä¾‹åŒ–çš„æ¨¡å¼ï¼Œç”¨äºè§£è€¦å¯¹è±¡çš„å®ä¾‹åŒ–è¿‡ç¨‹<br>å•ä¾‹æ¨¡å¼ã€å·¥å‚æ–¹æ³•æ¨¡å¼ï¼Œç­‰ç­‰</p></li><li><p>ç»“æ„å‹æ¨¡å¼ï¼šæŠŠç±»æˆ–å¯¹è±¡ç»“åˆåœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ›´å¤§çš„ç»“æ„<br>ä»£ç†æ¨¡å¼ã€é€‚é…å™¨æ¨¡å¼ã€ç»„åˆæ¨¡å¼ã€è£…é¥°æ¨¡å¼ï¼Œç­‰ç­‰</p></li><li><p>è¡Œä¸ºå‹æ¨¡å¼ï¼šç±»æˆ–å¯¹è±¡ä¹‹é—´å¦‚ä½•äº¤äº’ï¼ŒåŠåˆ’åˆ†è´£ä»»å’Œç®—æ³•<br>è§‚å¯Ÿè€…æ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼ï¼Œç­‰ç­‰</p></li></ol><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>é€‚åˆé¡¹ç›®çš„æ‰æ˜¯æœ€å¥½çš„æ¶æ„</li></ul><h3 id="èµ„æ–™å‚è€ƒ"><a href="#èµ„æ–™å‚è€ƒ" class="headerlink" title="èµ„æ–™å‚è€ƒ"></a>èµ„æ–™å‚è€ƒ</h3><ul><li><span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTQlQjglODklRTUlQjElODIlRTYlOUUlQjYlRTYlOUUlODQ=" title="https://baike.baidu.com/item/%E4%B8%89%E5%B1%82%E6%9E%B6%E6%9E%84">ä¸‰å±‚æ¶æ„<i class="fa fa-external-link"></i></span><h3 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h3></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½git<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code git<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9vYmpjNC03NTA=" title="https://github.com/ifgyong/demo/tree/master/OC/objc4-750">runtimeå¯è¿è¡Œçš„æºç git<i class="fa fa-external-link"></i></span></li></ul><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p><p>å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è§£å…³äºæ¶æ„çš„ä¸€äº›æ€è€ƒï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« ä½ å°†äº†è§£åˆ°&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;MVC&lt;/li&gt;
&lt;li&gt;MVCå˜ç§&lt;/li&gt;
&lt;li&gt;MVP&lt;/li&gt;
&lt;li&gt;MVVM&lt;/li&gt;
&lt;li&gt;åˆ†å±‚è®¾è®¡çš„ä¼˜ç¼ºç‚¹&lt;/li&gt;
&lt;/ol&gt;
&lt;/bloc
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç†  å†…å­˜ç®¡ç† é‚£äº›ä½ ä¸çŸ¥é“çš„åŸç†æ±‡æ€» --(12)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%20%E9%82%A3%E4%BA%9B%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84%E5%8E%9F%E7%90%86%E6%B1%87%E6%80%BB%20%E2%80%94%20(12)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86%20%E9%82%A3%E4%BA%9B%E4%BD%A0%E4%B8%8D%E7%9F%A5%E9%81%93%E7%9A%84%E5%8E%9F%E7%90%86%E6%B1%87%E6%80%BB%20%E2%80%94%20(12)/</id>
    <published>2019-12-01T03:22:58.000Z</published>
    <updated>2020-09-04T04:40:21.660Z</updated>
    
    <content type="html"><![CDATA[<p>çœ‹å®Œæœ¬æ–‡ç« ä½ å°†äº†è§£åˆ°</p><blockquote><ol><li>DisplayLinkå’Œtimerçš„ä½¿ç”¨å’ŒåŸç†</li><li>å†…å­˜åˆ†é…å’Œå†…å­˜ç®¡ç†</li><li>è‡ªåŠ¨é‡Šæ”¾æ± åŸç†</li><li>weakæŒ‡é’ˆåŸç†å’Œé‡Šæ”¾æ—¶æœº</li><li>å¼•ç”¨è®¡æ•°åŸç†</li></ol></blockquote><p>/</p><h3 id="DisplayLink"><a href="#DisplayLink" class="headerlink" title="DisplayLink"></a>DisplayLink</h3><p><code>CADisplayLink</code>æ˜¯å°†ä»»åŠ¡æ·»åŠ åˆ°<code>runloop</code>ä¸­ï¼Œ<code>loop</code>æ¯æ¬¡å¾ªç¯ä¾¿ä¼šè°ƒç”¨<code>target</code>çš„<code>selector</code>ï¼Œä½¿ç”¨è¿™ä¸ªä¹Ÿèƒ½ç›‘æµ‹å¡é¡¿é—®é¢˜ã€‚é¦–å…ˆä»‹ç»ä¸‹<code>API</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+ (CADisplayLink *)displayLinkWithTarget:(id)target selector:(SEL)sel;</span><br><span class="line">&#x2F;&#x2F;runloopæ²¡å¾ªç¯ä¸€åœˆéƒ½ä¼šè°ƒç”¨</span><br><span class="line">- (void)addToRunLoop:(NSRunLoop *)runloop forMode:(NSRunLoopMode)mode;</span><br><span class="line">&#x2F;&#x2F;ä»runloopä¸­åˆ é™¤</span><br><span class="line">- (void)removeFromRunLoop:(NSRunLoop *)runloop forMode:(NSRunLoopMode)mode;</span><br><span class="line">&#x2F;&#x2F;å–æ¶ˆ</span><br><span class="line">- (void)invalidate;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬åœ¨ä¸€ä¸ªéœ€è¦<code>push</code>çš„<code>VC</code>ä¸­è¿è¡Œæ¥è§‚å¯Ÿå£°æ˜å‘¨æœŸ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic,strong) CADisplayLink *link;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;åˆå§‹åŒ–</span><br><span class="line">self.link &#x3D; [FYDisplayLink displayLinkWithTarget:self selector:@selector(test)];</span><br><span class="line">[self.link addToRunLoop:[NSRunLoop mainRunLoop] forMode:NSDefaultRunLoopMode];</span><br><span class="line">timer &#x3D; dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, dispatch_get_main_queue());</span><br><span class="line">dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC, 1 * NSEC_PER_SEC);</span><br><span class="line">dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">@synchronized (self) &#123;</span><br><span class="line">NSLog(@&quot;FPS:%d&quot;,fps);</span><br><span class="line">fps &#x3D; 0;</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_resume(timer);</span><br><span class="line">&#x2F;&#x2F;å…¨å±€å˜é‡</span><br><span class="line">dispatch_source_t timer;</span><br><span class="line">static int fps;</span><br><span class="line"></span><br><span class="line">- (void)test&#123;</span><br><span class="line"></span><br><span class="line">@synchronized (self) &#123;</span><br><span class="line">fps +&#x3D; 1;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">[self.link invalidate];</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-30 17:44:37.217781+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:38.212477+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:39.706000+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:89</span><br><span class="line">2019-07-30 17:44:40.706064+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:41.705589+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:42.706268+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:43.705942+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:44.705792+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br></pre></td></tr></table></figure><p>åˆå§‹åŒ–ä¹‹åï¼Œå¯¹<code>fps</code>ä½¿ç”¨äº†ç®€å•ç‰ˆæœ¬çš„è¯»å†™é”ï¼Œå¯ä»¥çœ‹åˆ°<code>fps</code>åŸºæœ¬ç¨³å®šåœ¨60å·¦å³ï¼Œç‚¹å‡»æŒ‰é’®è¿”å›ä¹‹åï¼Œ<code>link</code>å’Œ<code>VC</code>å¹¶æ²¡æœ‰æ­£å¸¸é”€æ¯ã€‚æˆ‘ä»¬åˆ†æä¸€ä¸‹ï¼Œ<code>VCï¼ˆselfï¼‰</code>-&gt;<code>link</code>-&gt;<code>target(self)</code>,å¯¼è‡´äº†æ­»å¾ªç¯ï¼Œé‡Šæ”¾çš„æ—¶å€™ï¼Œæ— æ³•é‡Šæ”¾<code>self</code>å’Œ<code>link</code>,é‚£ä¹ˆæˆ‘ä»¬æ”¹åŠ¨ä¸€ä¸‹<code>link</code>-&gt;<code>target(self)</code>ä¸­çš„å¼ºå¼•ç”¨ï¼Œæ”¹æˆå¼±å¼•ç”¨ï¼Œä»£ç æ”¹æˆä¸‹é¢çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@interface FYTimerTarget : NSObject</span><br><span class="line">@property (nonatomic,weak) id target;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYTimerTarget</span><br><span class="line">-(id)forwardingTargetForSelector:(SEL)aSelector&#123;</span><br><span class="line">return self.target;</span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FYProxy *proxy&#x3D;[FYProxy proxyWithTarget:self];</span><br><span class="line">self.link &#x3D; [FYDisplayLink displayLinkWithTarget:self selector:@selector(test)];</span><br><span class="line">[self.link addToRunLoop:[NSRunLoop mainRunLoop] forMode:NSDefaultRunLoopMode];</span><br><span class="line"></span><br><span class="line">- (void)test&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-30 17:59:04.339934 -[ViewController test]</span><br><span class="line">2019-07-30 17:59:04.356292 -[ViewController test]</span><br><span class="line">2019-07-30 17:59:04.371428 -[FYTimerTarget dealloc]</span><br><span class="line">2019-07-30 17:59:04.371634 -[ViewController dealloc]</span><br></pre></td></tr></table></figure><p><code>FYTimerTarget</code>å¯¹<code>target</code>è¿›è¡Œäº†å¼±å¼•ç”¨ï¼Œ<code>self</code>å¯¹<code>FYTimerTarget</code>è¿›è¡Œå¼ºå¼•ç”¨ï¼Œåœ¨é”€æ¯äº†çš„æ—¶å€™ï¼Œå…ˆé‡Šæ”¾<code>self</code>,ç„¶åæ£€æŸ¥<code>self</code>çš„<code>FYTimerTarget</code>,<code>FYTimerTarget</code>åªæœ‰ä¸€ä¸ªå‚æ•°<code>weak</code>å±æ€§ï¼Œå¯ä»¥ç›´æ¥é‡Šæ”¾ï¼Œé‡Šæ”¾å®Œ<code>FYTimerTarget</code>ï¼Œç„¶åé‡Šæ”¾<code>self(VC)</code>ï¼Œæœ€ç»ˆå¯ä»¥æ­£å¸¸ã€‚</p><h3 id="NSTimer"><a href="#NSTimer" class="headerlink" title="NSTimer"></a>NSTimer</h3><p>ä½¿ç”¨<code>NSTimer</code>çš„æ—¶å€™ï¼Œ<code>timerWithTimeInterval:(NSTimeInterval)ti target:(id)aTarget selector:(SEL)aSelector userInfo:(nullable id)userInfo repeats:(BOOL)yesOrNo</code>ä¼šå¯¹<code>aTarget</code>è¿›è¡Œå¼ºå¼•ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹è¿™ä¸ª<code>aTarget</code>è¿›è¡Œä¸€ä¸ªç®€å•çš„å°è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@interface FYProxy : NSProxy</span><br><span class="line">@property (nonatomic,weak) id target;</span><br><span class="line"></span><br><span class="line">+(instancetype)proxyWithTarget:(id)target;</span><br><span class="line">@end</span><br><span class="line">@implementation FYProxy</span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">+ (instancetype)proxyWithTarget:(id)target&#123;</span><br><span class="line">FYProxy *obj&#x3D;[FYProxy alloc];</span><br><span class="line">obj.target &#x3D; target;</span><br><span class="line">return obj;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;è½¬å‘</span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)invocation&#123;</span><br><span class="line">[invocation invokeWithTarget:self.target];</span><br><span class="line">&#125;</span><br><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel&#123;</span><br><span class="line">return [self.target methodSignatureForSelector:sel];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p><code>FYProxy</code>æ˜¯ç»§æ‰¿<code>NSProxy</code>ï¼Œè€Œ<code>NSProxy</code>ä¸æ˜¯ç»§æ‰¿<code>NSObject</code>çš„,è€Œæ˜¯å¦å¤–ä¸€ç§åŸºç±»ï¼Œä¸ä¼šèµ°<code>objc_msgSend()</code>çš„ä¸‰å¤§æ­¥éª¤ï¼Œå½“æ‰¾ä¸åˆ°å‡½æ•°çš„æ—¶å€™ç›´æ¥æ‰§è¡Œ<code>- (void)forwardInvocation:(NSInvocation *)invocation</code>ï¼Œå’Œ<code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel</code>ç›´æ¥è¿›å…¥æ¶ˆæ¯è½¬å‘é˜¶æ®µã€‚æˆ–è€…å°†ç»§æ‰¿å…³ç³»æ”¹æˆ<code>FYTimerTarget : NSObject</code>,è¿™æ ·å­<code>target</code>æ‰¾ä¸åˆ°çš„å‡½æ•°è¿˜æ˜¯ä¼šèµ°æ¶ˆæ¯è½¬å‘çš„ä¸‰å¤§æ­¥éª¤ï¼Œæˆ‘ä»¬å†<code>FYTimerTarget</code>æ·»åŠ æ¶ˆæ¯åŠ¨æ€è§£æ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-(id)forwardingTargetForSelector:(SEL)aSelector&#123;</span><br><span class="line">return self.target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>è¿™æ ·å­<code>target</code>çš„<code>aSelector</code>è½¬å‘ç»™äº†<code>self.target</code>å¤„ç†ï¼ŒæˆåŠŸå¼±å¼•ç”¨äº†<code>self</code>å’Œå‡½æ•°çš„è½¬å‘å¤„ç†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">FYTimerTarget *obj &#x3D;[FYTimerTarget new];</span><br><span class="line">obj.target &#x3D; self;</span><br><span class="line"></span><br><span class="line">self.timer &#x3D; [NSTimer timerWithTimeInterval:1.0f</span><br><span class="line">target:obj</span><br><span class="line">   selector:@selector(test)</span><br><span class="line">   userInfo:nil</span><br><span class="line">repeats:YES];</span><br><span class="line">[[NSRunLoop mainRunLoop] addTimer:self.timer forMode:NSRunLoopCommonModes];</span><br><span class="line">[self.timer setFireDate:[NSDate distantPast]];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-30 18:03:08.723433+0800 day17-å®šæ—¶å™¨[30877:6556631] -[ViewController test]</span><br><span class="line">2019-07-30 18:03:09.722611+0800 day17-å®šæ—¶å™¨[30877:6556631] -[ViewController test]</span><br><span class="line">2019-07-30 18:03:09.847540+0800 day17-å®šæ—¶å™¨[30877:6556631] -[FYTimerTarget dealloc]</span><br><span class="line">2019-07-30 18:03:09.847677+0800 day17-å®šæ—¶å™¨[30877:6556631] -[ViewController dealloc]</span><br></pre></td></tr></table></figure><p>æˆ–è€…ä½¿ç”¨<code>timerWithTimeInterval:(NSTimeInterval)interval repeats:(BOOL)repeats block:(void (^)(NSTimer *timer))block</code>ï¼Œç„¶åå¤–éƒ¨ä½¿ç”¨<code>__weak self</code>è°ƒç”¨å‡½æ•°ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨ã€‚<br>ä½¿ç”¨<code>block</code>çš„æƒ…å†µï¼Œé‡Šæ”¾æ­£å¸¸ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">self.timer&#x3D;[NSTimer timerWithTimeInterval:1 repeats:YES block:^(NSTimer * _Nonnull timer) &#123;</span><br><span class="line">NSLog(@&quot;123&quot;);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-30 18:08:24.678789+0800 day17-å®šæ—¶å™¨[31126:6566530] 123</span><br><span class="line">2019-07-30 18:08:25.659127+0800 day17-å®šæ—¶å™¨[31126:6566530] 123</span><br><span class="line">2019-07-30 18:08:26.107643+0800 day17-å®šæ—¶å™¨[31126:6566530] -[ViewController dealloc]</span><br></pre></td></tr></table></figure><p>ç”±äº<code>link</code>å’Œ<code>timer</code>æ˜¯æ·»åŠ åˆ°<code>runloop</code>ä¸­ä½¿ç”¨çš„ï¼Œæ¯æ¬¡ä¸€ä¸ªå¾ªç¯åˆ™è®¿é—®<code>timer</code>æˆ–è€…<code>link</code>ï¼Œç„¶åæ‰§è¡Œå¯¹åº”çš„å‡½æ•°ï¼Œåœ¨æ—¶é—´ä¸Šæœ‰ç›¸å¯¹å°‘è®¸è¯¯å·®çš„ï¼Œæ¯æ­¤å¾ªç¯ï¼Œè¦åˆ·æ–°UI(åœ¨ä¸»çº¿ç¨‹)ï¼Œè¦æ‰§è¡Œå…¶ä»–å‡½æ•°ï¼Œè¦å¤„ç†ç³»ç»Ÿç«¯å£äº‹ä»¶ï¼Œè¦å¤„ç†å…¶ä»–çš„è®¡ç®—ã€‚ã€‚ã€‚æ€»çš„æ¥è¯´ï¼Œè¯¯å·®è¿˜æ˜¯æœ‰çš„ã€‚</p><h3 id="GCDä¸­timer"><a href="#GCDä¸­timer" class="headerlink" title="GCDä¸­timer"></a>GCDä¸­timer</h3><p><code>GCD</code>ä¸­çš„<code>dispatch_source_t</code>çš„å®šæ—¶å™¨æ˜¯åŸºäºå†…æ ¸çš„ï¼Œæ—¶é—´è¯¯å·®ç›¸å¯¹è¾ƒå°‘ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;timer éœ€è¦å¼ºå¼•ç”¨ æˆ–è€…è®¾ç½®æˆå…¨å±€å˜é‡</span><br><span class="line">    timer &#x3D; dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, dispatch_get_main_queue());</span><br><span class="line">    dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC, 1 * NSEC_PER_SEC);</span><br><span class="line">    &#x2F;&#x2F;è®¾ç½®</span><br><span class="line">    dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">  &#x2F;&#x2F;code å®šæ—¶å™¨æ‰§è¡Œçš„ä»£ç </span><br><span class="line"> </span><br><span class="line">    &#125;);</span><br><span class="line">    &#x2F;&#x2F;å¼€å§‹å®šæ—¶å™¨</span><br><span class="line">    dispatch_resume(timer);</span><br></pre></td></tr></table></figure><p>æˆ–è€…ä½¿ç”¨å‡½æ•°<code>dispatch_source_set_event_handler_f(timer, function_t);</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_set_event_handler_f(timer, function_t);</span><br><span class="line">void function_t(void * p)&#123;</span><br><span class="line">    &#x2F;&#x2F;code here    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸šåŠ¡ç»å¸¸ä½¿ç”¨å®šæ—¶å™¨çš„è¯ï¼Œè¿˜æ˜¯å°è£…ä¸€ä¸ªç®€å•çš„åŠŸèƒ½æ¯”è¾ƒå¥½ï¼Œå°è£…é¦–å…ˆä»éœ€æ±‚å¼€å§‹åˆ†æï¼Œæˆ‘ä»¬ä½¿ç”¨å®šæ—¶å™¨å¸¸ç”¨çš„å‚æ•°éƒ½å“ªäº›ï¼Ÿéœ€è¦å“ªäº›åŠŸèƒ½ï¼Ÿ</p><p>é¦–å…ˆéœ€è¦å¼€å§‹çš„æ—¶é—´ï¼Œç„¶åæ‰§è¡Œçš„é¢‘ç‡ï¼Œæ‰§è¡Œçš„ä»»åŠ¡(å‡½æ•°æˆ–block)ï¼Œæ˜¯å¦é‡å¤æ‰§è¡Œï¼Œè¿™äº›éƒ½æ˜¯éœ€è¦çš„ã€‚<br>å…ˆå®šä¹‰ä¸€ä¸ªå‡½æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+ (NSString *)exeTask:(dispatch_block_t)block</span><br><span class="line">      start:(NSTimeInterval)time</span><br><span class="line">       interval:(NSTimeInterval)interval</span><br><span class="line">     repeat:(BOOL)repeat</span><br><span class="line">      async:(BOOL)async;</span><br><span class="line">+ (NSString *)exeTask:(id)target</span><br><span class="line">  sel:(SEL)aciton</span><br><span class="line">start:(NSTimeInterval)time</span><br><span class="line"> interval:(NSTimeInterval)interval</span><br><span class="line">   repeat:(BOOL)repeat</span><br><span class="line">async:(BOOL)async;</span><br><span class="line">&#x2F;&#x2F;å–æ¶ˆ</span><br><span class="line">+ (void)exeCancelTask:(NSString *)key;</span><br></pre></td></tr></table></figure><p>ç„¶åå°†åˆšæ‰å†™çš„æ‹¿è¿‡æ¥ï¼Œå¢åŠ äº†ä¸€äº›åˆ¤æ–­ã€‚æœ‰ä»»åŠ¡çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œï¼Œå¦åˆ™ç›´æ¥è¿”å›<code>nil</code>ï¼Œå½“å¾ªç¯çš„æ—¶å€™ï¼Œéœ€è¦é—´éš”å¤§äº0ï¼Œå¦åˆ™è¿”å›ï¼ŒåŒæ­¥æˆ–å¼‚æ­¥ï¼Œå°±æˆ–è€…ä¸»é˜Ÿåˆ—æˆ–è€…å¼‚æ­¥é˜Ÿåˆ—ï¼Œç„¶åç”¨ç”Ÿæˆçš„<code>key</code>,<code>timer</code>ä¸º<code>value</code>å­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­ï¼Œåœ¨å–æ¶ˆçš„æ—¶å€™ç›´æ¥ç”¨<code>key</code>å–å‡º<code>timer</code>å–æ¶ˆï¼Œè¿™é‡Œä½¿ç”¨äº†ä¿¡å·é‡ï¼Œé™åˆ¶å•çº¿ç¨‹æ“ä½œã€‚åœ¨å­˜å‚¨å’Œå–å‡ºï¼ˆå–æ¶ˆtimerï¼‰çš„æ—¶å€™è¿›è¡Œé™åˆ¶ï¼Œæé«˜å…¶ä»–ä»£ç æ‰§è¡Œçš„æ•ˆç‡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">+ (NSString *)exeTask:(dispatch_block_t)block start:(NSTimeInterval)time interval:(NSTimeInterval)interval repeat:(BOOL)repeat async:(BOOL)async&#123;</span><br><span class="line">if (block &#x3D;&#x3D; nil) &#123;</span><br><span class="line">return nil;</span><br><span class="line">&#125;</span><br><span class="line">if (repeat &amp;&amp; interval &lt;&#x3D; 0) &#123;</span><br><span class="line">return nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NSString *name &#x3D;[NSString stringWithFormat:@&quot;%d&quot;,i];</span><br><span class="line">&#x2F;&#x2F;ä¸»é˜Ÿåˆ—</span><br><span class="line">dispatch_queue_t queue &#x3D; dispatch_get_main_queue();</span><br><span class="line">if (async) &#123;</span><br><span class="line">queue &#x3D; dispatch_queue_create(&quot;async.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;åˆ›å»ºå®šæ—¶å™¨</span><br><span class="line">dispatch_source_t _timer &#x3D; dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);</span><br><span class="line">&#x2F;&#x2F;è®¾ç½®å¯åŠ¨æ—¶é—´</span><br><span class="line">dispatch_source_set_timer(_timer,</span><br><span class="line">  dispatch_time(DISPATCH_TIME_NOW, time*NSEC_PER_SEC), interval*NSEC_PER_SEC, 0);</span><br><span class="line">&#x2F;&#x2F;è®¾å®šå›è°ƒ</span><br><span class="line">dispatch_source_set_event_handler(_timer, ^&#123;</span><br><span class="line">block();</span><br><span class="line">if (repeat &#x3D;&#x3D; NO) &#123;</span><br><span class="line">dispatch_source_cancel(_timer);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#x2F;&#x2F;å¯åŠ¨å®šæ—¶å™¨</span><br><span class="line">dispatch_resume(_timer);</span><br><span class="line">&#x2F;&#x2F;å­˜æ”¾åˆ°å­—å…¸</span><br><span class="line">if (name.length &amp;&amp; _timer) &#123;</span><br><span class="line">dispatch_semaphore_wait(samephore, DISPATCH_TIME_FOREVER);</span><br><span class="line">timers[name] &#x3D; _timer;</span><br><span class="line">dispatch_semaphore_signal(samephore);</span><br><span class="line">&#125;</span><br><span class="line">return name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+ (NSString *)exeTask:(id)target</span><br><span class="line">  sel:(SEL)aciton</span><br><span class="line">start:(NSTimeInterval)time</span><br><span class="line"> interval:(NSTimeInterval)interval</span><br><span class="line">   repeat:(BOOL)repeat</span><br><span class="line">async:(BOOL)async&#123;</span><br><span class="line">if (target &#x3D;&#x3D; nil || aciton &#x3D;&#x3D; NULL) &#123;</span><br><span class="line">return nil;</span><br><span class="line">&#125;</span><br><span class="line">if (repeat &amp;&amp; interval &lt;&#x3D; 0) &#123;</span><br><span class="line">return nil;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NSString *name &#x3D;[NSString stringWithFormat:@&quot;%d&quot;,i];</span><br><span class="line">&#x2F;&#x2F;ä¸»é˜Ÿåˆ—</span><br><span class="line">dispatch_queue_t queue &#x3D; dispatch_get_main_queue();</span><br><span class="line">if (async) &#123;</span><br><span class="line">queue &#x3D; dispatch_queue_create(&quot;async.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;åˆ›å»ºå®šæ—¶å™¨</span><br><span class="line">dispatch_source_t _timer &#x3D; dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);</span><br><span class="line">&#x2F;&#x2F;è®¾ç½®å¯åŠ¨æ—¶é—´</span><br><span class="line">dispatch_source_set_timer(_timer,</span><br><span class="line">  dispatch_time(DISPATCH_TIME_NOW, time*NSEC_PER_SEC), interval*NSEC_PER_SEC, 0);</span><br><span class="line">&#x2F;&#x2F;è®¾å®šå›è°ƒ</span><br><span class="line">dispatch_source_set_event_handler(_timer, ^&#123;</span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line">#pragma clang diagnostic ignored&quot;-Warc-performSelector-leaks&quot;</span><br><span class="line">&#x2F;&#x2F;è¿™é‡Œæ˜¯ä¼šæŠ¥è­¦å‘Šçš„ä»£ç </span><br><span class="line">if ([target respondsToSelector:aciton]) &#123;</span><br><span class="line">[target performSelector:aciton];</span><br><span class="line">&#125;</span><br><span class="line">#pragma clang diagnostic pop</span><br><span class="line"></span><br><span class="line">if (repeat &#x3D;&#x3D; NO) &#123;</span><br><span class="line">dispatch_source_cancel(_timer);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#x2F;&#x2F;å¯åŠ¨å®šæ—¶å™¨</span><br><span class="line">dispatch_resume(_timer);</span><br><span class="line">&#x2F;&#x2F;å­˜æ”¾åˆ°å­—å…¸</span><br><span class="line">if (name.length &amp;&amp; _timer) &#123;</span><br><span class="line">dispatch_semaphore_wait(samephore, DISPATCH_TIME_FOREVER);</span><br><span class="line">timers[name] &#x3D; _timer;</span><br><span class="line">dispatch_semaphore_signal(samephore);</span><br><span class="line">&#125;</span><br><span class="line">return name;</span><br><span class="line">&#125;</span><br><span class="line">+ (void)exeCancelTask:(NSString *)key&#123;</span><br><span class="line">if (key.length &#x3D;&#x3D; 0) &#123;</span><br><span class="line">return;</span><br><span class="line">&#125;</span><br><span class="line">dispatch_semaphore_wait(samephore, DISPATCH_TIME_FOREVER);</span><br><span class="line">if ([timers.allKeys containsObject:key]) &#123;</span><br><span class="line">dispatch_source_cancel(timers[key]);</span><br><span class="line">[timers removeObjectForKey:key];</span><br><span class="line">&#125;</span><br><span class="line">dispatch_semaphore_signal(samephore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨çš„æ—¶å€™å¾ˆç®€å•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">key &#x3D; [FYTimer exeTask:^&#123;</span><br><span class="line">        NSLog(@&quot;123&quot;);</span><br><span class="line">    &#125; start:1</span><br><span class="line">    interval:1 </span><br><span class="line">    repeat:YES </span><br><span class="line">    async:NO];</span><br></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key &#x3D; [FYTimer exeTask:self sel:@selector(test) start:0 interval:1 repeat:YES async:YES];</span><br></pre></td></tr></table></figure><p>å–æ¶ˆæ‰§è¡Œçš„æ—¶å€™</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[FYTimer exeCancelTask:key];</span><br></pre></td></tr></table></figure><p>æµ‹è¯•å°è£…çš„å®šæ—¶å™¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">[super viewDidLoad];</span><br><span class="line">key &#x3D; [FYTimer exeTask:self sel:@selector(test) start:0 interval:1 repeat:YES async:YES];</span><br><span class="line">&#125;</span><br><span class="line">-(void)test&#123;</span><br><span class="line">NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">[FYTimer exeCancelTask:key];</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-30 21:16:48.639486+0800 day17-å®šæ—¶å™¨2[48817:1300897] &lt;NSThread: 0x6000010ec000&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-30 21:16:49.640177+0800 day17-å®šæ—¶å™¨2[48817:1300897] &lt;NSThread: 0x6000010ec000&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-30 21:16:50.639668+0800 day17-å®šæ—¶å™¨2[48817:1300897] &lt;NSThread: 0x6000010ec000&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-30 21:16:51.639590+0800 day17-å®šæ—¶å™¨2[48817:1300897] &lt;NSThread: 0x6000010ec000&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-30 21:16:52.156004+0800 day17-å®šæ—¶å™¨2[48817:1300845] -[ViewController touchesBegan:withEvent:]</span><br></pre></td></tr></table></figure><p>åœ¨ç‚¹å‡»<code>VC</code>çš„æ—¶å€™è¿›è¡Œå–æ¶ˆæ“ä½œï¼Œ<code>timer</code>åœæ­¢ã€‚</p><h3 id="NSProxyå®æˆ˜"><a href="#NSProxyå®æˆ˜" class="headerlink" title="NSProxyå®æˆ˜"></a>NSProxyå®æˆ˜</h3><p><code>NSProxy</code>å…¶å®æ˜¯é™¤äº†<code>NSObject</code>çš„å¦å¤–ä¸€ä¸ªåŸºç±»ï¼Œæ–¹æ³•æ¯”è¾ƒå°‘ï¼Œå½“æ‰¾ä¸åˆ°æ–¹æ³•çš„æ—¶å€™æ‰§è¡Œæ¶ˆæ¯è½¬å‘é˜¶æ®µ(å› ä¸ºæ²¡æœ‰çˆ¶ç±»)ï¼Œè°ƒç”¨å‡½æ•°çš„æµç¨‹æ›´çŸ­ï¼Œæ€§èƒ½åˆ™æ›´å¥½ã€‚</p><p>é—®é¢˜ï¼š<code>ret1</code>å’Œ<code>ret2</code>åˆ†åˆ«æ˜¯å¤šå°‘ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ViewController *vc1 &#x3D;[[ViewController alloc]init];</span><br><span class="line">FYProxy *pro1 &#x3D;[FYProxy proxyWithTarget:vc1];</span><br><span class="line"></span><br><span class="line">FYTimerTarget *tar &#x3D;[FYTimerTarget proxyWithTarget:vc1];</span><br><span class="line">BOOL ret1 &#x3D; [pro1 isKindOfClass:ViewController.class];</span><br><span class="line">BOOL ret2 &#x3D; [tar isKindOfClass:ViewController.class];</span><br><span class="line">NSLog(@&quot;%d %d&quot;,ret1,ret2);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼Œ<code>-(bool)isKindOfClass:(cls)</code>å¯¹è±¡å‡½æ•°æ˜¯åˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦çš„<code>cls</code>çš„å­ç±»æˆ–è€…è¯¥ç±»çš„å®ä¾‹ï¼Œè¿™ç‚¹ä¸å®¹ç½®ç–‘ï¼Œé‚£ä¹ˆ<code>ret1</code>åº”è¯¥æ˜¯<code>0</code>,<code>ret2</code>åº”è¯¥ä¹Ÿæ˜¯<code>0</code></p><p>é¦–å…ˆçœ‹<code>FYProxy</code>çš„å®ç°ï¼Œ<code>forwardInvocation</code>å’Œ<code>methodSignatureForSelector</code>ï¼Œåœ¨æ²¡æœ‰è¯¥å‡½æ•°çš„æ—¶å€™è¿›è¡Œæ¶ˆæ¯è½¬å‘ï¼Œè½¬å‘å¯¹è±¡æ˜¯<code>self.target</code>ï¼Œåœ¨è¯¥ä¾‹å­ä¸­<code>isKindOfClass</code>ä¸å­˜åœ¨ä¸<code>FYProxy</code>ï¼Œæ‰€ä»¥è®²è¯¥å‡½æ•°è½¬å‘ç»™äº†<code>VC</code>ï¼Œåˆ™<code>BOOL ret1 = [pro1 isKindOfClass:ViewController.class];</code>ç›¸å½“äº<code>BOOL ret1 = [ViewController.class isKindOfClass:ViewController.class];</code>ï¼Œæ‰€ä»¥ç­”æ¡ˆæ˜¯1</p><p>ç„¶å<code>ret2</code>æ˜¯0ï¼Œ<code>tar</code>æ˜¯ç»§æ‰¿äº<code>NSObject</code>çš„ï¼Œæœ¬èº«æœ‰<code>-(bool)isKindOfClass:(cls)</code>å‡½æ•°ï¼Œæ‰€ä»¥ç­”æ¡ˆæ˜¯0ã€‚</p><p>ç­”æ¡ˆæ˜¯ï¼š<code>ret1</code>æ˜¯<code>1</code>ï¼Œ<code>ret2</code>æ˜¯<code>0</code>ã€‚</p><h3 id="å†…å­˜åˆ†é…"><a href="#å†…å­˜åˆ†é…" class="headerlink" title="å†…å­˜åˆ†é…"></a>å†…å­˜åˆ†é…</h3><p>å†…å­˜åˆ†ä¸ºä¿ç•™æ®µã€æ•°æ®æ®µã€å †(â†“)ã€æ ˆ(â†‘)ã€å†…æ ¸åŒºã€‚</p><p>æ•°æ®æ®µåŒ…æ‹¬</p><ul><li>å­—ç¬¦ä¸²å¸¸é‡ï¼šæ¯”å¦‚NSString * str = @â€11â€</li><li>å·²åˆå§‹åŒ–æ•°æ®ï¼šå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡ç­‰</li><li>æœªåˆå§‹åŒ–æ•°æ®ï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡ç­‰</li></ul><p>æ ˆï¼šå‡½æ•°è°ƒç”¨å¼€é”€ã€æ¯”å¦‚å±€éƒ¨å˜é‡ï¼Œåˆ†é…çš„å†…å­˜ç©ºé—´åœ°å€è¶Šæ¥è¶Šå°ã€‚</p><p>å †ï¼šé€šè¿‡allocã€mallocã€callocç­‰åŠ¨æ€åˆ†é…çš„ç©ºé—´ï¼Œåˆ†é…çš„ç©ºé—´åœ°å€è¶Šæ¥è¶Šå¤§ã€‚</p><p>éªŒè¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">int a &#x3D; 10;</span><br><span class="line">int b ;</span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        static int c &#x3D; 20;</span><br><span class="line">        static int d;</span><br><span class="line">        int e &#x3D; 10;</span><br><span class="line">        int f;</span><br><span class="line">        NSString * str &#x3D; @&quot;123&quot;;</span><br><span class="line">        NSObject *obj &#x3D;[[NSObject alloc]init];</span><br><span class="line">        NSLog(@&quot;\na:%p \nb:%p \nc:%p \nd:%p \ne:%p \nf:%p \nobj:%p\n str:%p&quot;,&amp;a,&amp;b,&amp;c,&amp;d,&amp;e,&amp;f,obj,str);</span><br><span class="line">        return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">a:0x1063e0d98 </span><br><span class="line">b:0x1063e0e64 </span><br><span class="line">c:0x1063e0d9c </span><br><span class="line">d:0x1063e0e60 </span><br><span class="line">e:0x7ffee9820efc </span><br><span class="line">f:0x7ffee9820ef8 </span><br><span class="line">obj:0x6000013541a0</span><br><span class="line">str:0x1063e0068</span><br></pre></td></tr></table></figure><h3 id="Tagged-Pointer"><a href="#Tagged-Pointer" class="headerlink" title="Tagged Pointer"></a>Tagged Pointer</h3><p>ä»64bitå¼€å§‹ï¼ŒiOSå¼•å…¥<code>Tagged Pointer</code>æŠ€æœ¯ï¼Œç”¨äºä¼˜åŒ–<code>NSNumberã€NSDateã€NSString</code>ç­‰å°å¯¹è±¡çš„å­˜å‚¨ï¼Œåœ¨æ²¡æœ‰ä½¿ç”¨ä¹‹å‰ï¼Œä»–ä»¬éœ€è¦åŠ¨æ€åˆ†é…å†…å­˜ï¼Œç»´æŠ¤è®¡æ•°ï¼Œä½¿ç”¨<code>Tagged Pointer</code>ä¹‹åï¼Œ<code>NSNumber</code>æŒ‡é’ˆé‡Œé¢çš„æ•°æ®å˜æˆäº†<code>Tag+Data</code>ï¼Œä¹Ÿå°±æ˜¯å°†æ•°å€¼ç›´æ¥å­˜å‚¨åœ¨äº†æŒ‡é’ˆä¸­ï¼Œåªæœ‰å½“æŒ‡é’ˆä¸å¤Ÿå­˜å‚¨æ•°æ®æ—¶ï¼Œæ‰ä¼šåŠ¨æ€åˆ†é…å†…å­˜çš„æ–¹å¼æ¥å­˜å‚¨æ•°æ®ï¼Œè€Œä¸”<code>objc_msgSend()</code>èƒ½å¤Ÿè¯†åˆ«å‡º<code>Tagged Pointer</code>ï¼Œæ¯”å¦‚<code>NSNumber</code>çš„<code>intValue</code>æ–¹æ³•ï¼Œç›´æ¥ä»æŒ‡é’ˆæå–æ•°æ®ï¼ŒèŠ‚çœäº†ä»¥å‰çš„è°ƒç”¨çš„å¼€é”€ã€‚<br>åœ¨iOSä¸­ï¼Œæœ€é«˜ä½æ˜¯1(ç¬¬64bit)ï¼Œåœ¨Macä¸­ï¼Œæœ€ä½æœ‰æ•ˆä½æ˜¯1ã€‚<br>åœ¨<code>runtime</code>æºç ä¸­<code>objc-internal.h 370è¡Œ</code>åˆ¤æ–­æ˜¯å¦ä½¿ç”¨äº†ä¼˜åŒ–æŠ€æœ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static inline void * _Nonnull</span><br><span class="line">_objc_encodeTaggedPointer(uintptr_t ptr)</span><br><span class="line">&#123;</span><br><span class="line">    return (void *)(objc_debug_taggedpointer_obfuscator ^ ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ‹¿æ¥è¿™ä¸ªå¯ä»¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä½¿ç”¨äº†ä¼˜åŒ–æŠ€æœ¯ã€‚</p><h4 id="NSNumbe-Tagged-Pointer"><a href="#NSNumbe-Tagged-Pointer" class="headerlink" title="NSNumbe Tagged Pointer"></a>NSNumbe Tagged Pointer</h4><p>æˆ‘ä»¬ä½¿ç”¨å‡ ä¸ª<code>NSNumber</code>çš„å¤§å°æ•°å­—æ¥éªŒè¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#if (TARGET_OS_OSX || TARGET_OS_IOSMAC) &amp;&amp; __x86_64__ &#x2F;&#x2F;macå¼€å‘</span><br><span class="line">&#x2F;&#x2F; 64-bit Mac - tag bit is LSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 0</span><br><span class="line">#else</span><br><span class="line">&#x2F;&#x2F; Everything else - tag bit is MSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 1&#x2F;&#x2F;iOSå¼€å‘</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if OBJC_MSB_TAGGED_POINTERS</span><br><span class="line">#   define _OBJC_TAG_MASK (1UL&lt;&lt;63)</span><br><span class="line">#else</span><br><span class="line">#   define _OBJC_TAG_MASK 1UL</span><br><span class="line">#endif</span><br><span class="line">bool objc_isTaggedPointer(const void * _Nullable ptr)</span><br><span class="line">&#123;</span><br><span class="line">    return ((uintptr_t)ptr &amp; _OBJC_TAG_MASK) &#x3D;&#x3D; _OBJC_TAG_MASK;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        NSNumber *n1 &#x3D; @2;</span><br><span class="line">        NSNumber *n2 &#x3D; @3;</span><br><span class="line">        NSNumber *n3 &#x3D; @(4);</span><br><span class="line">        NSNumber *n4 &#x3D; @(0x4fffffffff);</span><br><span class="line">        NSLog(@&quot;\n%p \n%p \n%p \n%p&quot;,n1,n2,n3,n4);</span><br><span class="line">        BOOL n1_tag &#x3D; objc_isTaggedPointer((__bridge const void * _Nullable)(n1));</span><br><span class="line">        BOOL n2_tag &#x3D; objc_isTaggedPointer((__bridge const void * _Nullable)(n2));</span><br><span class="line">        BOOL n3_tag &#x3D; objc_isTaggedPointer((__bridge const void * _Nullable)(n3));</span><br><span class="line">        BOOL n4_tag &#x3D; objc_isTaggedPointer((__bridge const void * _Nullable)(n4));</span><br><span class="line"></span><br><span class="line">        NSLog(@&quot;\nn1:%d \nn2:%d \nn3:%d \nn4:%d &quot;,n1_tag,n2_tag,n3_tag,n4_tag);</span><br><span class="line">        return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">0xbf4071e2657ccb95 </span><br><span class="line">0xbf4071e2657ccb85 </span><br><span class="line">0xbf4071e2657ccbf5 </span><br><span class="line">0xbf40751d9a833444</span><br><span class="line">2019-07-30 21:55:52.626317+0800 day17-TaggedPointer[49770:1328036] </span><br><span class="line">n1:1 </span><br><span class="line">n2:1 </span><br><span class="line">n3:1 </span><br><span class="line">n4:0</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>n1 n2 n3</code>æ˜¯ç»è¿‡ä¼˜åŒ–çš„ï¼Œè€Œ<code>n4</code>æ˜¯å¤§æ•°å­—ï¼ŒæŒ‡é’ˆå®¹ä¸ä¸‹è¯¥æ•°å€¼ï¼Œä¸èƒ½ä¼˜åŒ–ã€‚</p><h4 id="NSString-Tagged-Pointer"><a href="#NSString-Tagged-Pointer" class="headerlink" title="NSString Tagged Pointer"></a>NSString Tagged Pointer</h4><p>çœ‹ä¸‹é¢ä¸€é“é¢˜,è¿è¡Œ<code>test1</code>å’Œ<code>test2</code>ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (void)test1&#123;</span><br><span class="line">dispatch_queue_t queue &#x3D; dispatch_get_global_queue(0, 0);</span><br><span class="line">for (NSInteger i &#x3D; 0; i &lt; 1000; i ++) &#123;</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">self.name &#x3D; [NSString stringWithFormat:@&quot;abc&quot;];</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)test2&#123;</span><br><span class="line">dispatch_queue_t queue &#x3D; dispatch_get_global_queue(0, 0);</span><br><span class="line">for (NSInteger i &#x3D; 0; i &lt; 1000; i ++) &#123;</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">self.name &#x3D; [NSString stringWithFormat:@&quot;abcsefafaefafafaefe&quot;];</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å…ˆä¸è¿è¡Œï¼Œå…ˆåˆ†æä¸€ä¸‹ã€‚</p><p>é¦–å…ˆå…¨å±€é˜Ÿåˆ—å¼‚æ­¥æ·»åŠ ä»»åŠ¡ä¼šå‡ºç°å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜ï¼Œåœ¨å¹¶å‘çš„æ—¶å€™è¿›è¡Œå†™æ“ä½œä¼šå‡ºç°èµ„æºç«äº‰é—®é¢˜ï¼Œå¦å¤–ä¸€ä¸ªå°å­—ç¬¦ä¸²ä¼šå‡ºç°æŒ‡é’ˆä¼˜åŒ–é—®é¢˜ï¼Œå°å­—ç¬¦ä¸²å’Œå¤§å­—ç¬¦ä¸²åˆ‡æ¢å¯¼è‡´<code>_name</code>ç»“æ„å˜åŒ–ï¼Œå¤šçº¿ç¨‹åŒæ—¶å†™å…¥å’Œè¯»ä¼šå¯¼è‡´è®¿é—®åå†…å­˜é—®é¢˜ï¼Œæˆ‘ä»¬æ¥è¿è¡Œä¸€ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread: EXC_BAD_ACCESS(code &#x3D; 1)</span><br></pre></td></tr></table></figure><p>ç›´æ¥åœ¨å­çº¿ç¨‹å´©æºƒäº†ï¼Œå´©æºƒå‡½æ•°æ˜¯<code>objc_release</code>ã€‚ç¬¦åˆæˆ‘ä»¬çš„çŒœæƒ³ã€‚</p><p>éªŒè¯<code>NSString Tagged Pointer</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (void)test&#123;</span><br><span class="line">dispatch_queue_t queue &#x3D; dispatch_get_global_queue(0, 0);</span><br><span class="line">for (NSInteger i &#x3D; 0; i &lt; 1; i ++) &#123;</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">self.name &#x3D; [NSString stringWithFormat:@&quot;abc&quot;];</span><br><span class="line">NSLog(@&quot;test1 class:%@&quot;,self.name.class);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)test2&#123;</span><br><span class="line">dispatch_queue_t queue &#x3D; dispatch_get_global_queue(0, 0);</span><br><span class="line">for (NSInteger i &#x3D; 0; i &lt; 1; i ++) &#123;</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">self.name &#x3D; [NSString stringWithFormat:@&quot;abcsefafaefafafaefe&quot;];</span><br><span class="line">NSLog(@&quot;test2 class:%@&quot;,self.name.class);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">test1 class:NSTaggedPointerString</span><br><span class="line">test2 class:__NSCFString</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>NSString Tagged Pointer</code>åœ¨å°å­—ç¬¦ä¸²çš„æ—¶å€™ç±»æ˜¯<code>NSTaggedPointerString</code>ï¼Œç»è¿‡ä¼˜åŒ–çš„ç±»ï¼Œå¤§å­—ç¬¦ä¸²çš„ç±»æ˜¯<code>__NSCFString</code>ï¼Œ</p><h3 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h3><p>æ‹·è´åˆ†ä¸ºæµ…æ‹·è´å’Œæ·±æ‹·è´ï¼Œæµ…æ‹·è´åªæ˜¯å¼•ç”¨è®¡æ•°+1ï¼Œæ·±æ‹·è´æ˜¯æ‹·è´äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå’Œä¹‹å‰çš„ äº’ä¸å½±å“ï¼Œ å¼•ç”¨è®¡æ•°äº’ä¸å½±å“ã€‚</p><p>æ‹·è´ç›®çš„ï¼šäº§ç”Ÿä¸€ä¸ªå‰¯æœ¬å¯¹è±¡ï¼Œè·Ÿæºå¯¹è±¡äº’ä¸å½±å“<br> ä¿®æ”¹æºå¯¹è±¡ï¼Œä¸ä¼šå½±å“åˆ°å‰¯æœ¬å¯¹è±¡<br> ä¿®æ”¹å‰¯æœ¬å¯¹è±¡ï¼Œä¸ä¼šå½±å“æºå¯¹è±¡</p><p> iOSæä¾›äº†2ä¸­æ‹·è´æ–¹æ³•</p><ol><li>copy æ‹·è´å‡ºæ¥ä¸å¯å˜å¯¹è±¡</li><li>mutableCopy æ‹·è´å‡ºæ¥å¯å˜å¯¹è±¡</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void test1()&#123;</span><br><span class="line">NSString *str &#x3D; @&quot;strstrstrstr&quot;;</span><br><span class="line">NSMutableString *mut1 &#x3D;[str mutableCopy];</span><br><span class="line">[mut1 appendFormat:@&quot;123&quot;];</span><br><span class="line">NSString *str2 &#x3D; [str copy];</span><br><span class="line">NSLog(@&quot;%p %p %p&quot;,str,mut1,str2);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">str:0x100001040 </span><br><span class="line">mut1:0x1007385f0 </span><br><span class="line">str2:0x100001040</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°<code>str</code>å’Œ<code>str2</code>åœ°å€ä¸€æ ·ï¼Œæ²¡æœ‰é‡æ–°å¤åˆ¶å‡ºæ¥ä¸€ä»½ï¼Œ<code>mut1</code>åœ°å€å’Œ<code>str</code>ä¸ä¸€è‡´ï¼Œæ˜¯æ·±æ‹·è´ï¼Œé‡æ–°æ‹·è´äº†ä¸€ä»½ã€‚</p><p>æˆ‘ä»¬æŠŠå­—ç¬¦ä¸²æ¢æˆå…¶ä»–å¸¸ç”¨çš„æ•°ç»„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void test2()&#123;</span><br><span class="line">NSArray *array &#x3D; @[@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;];</span><br><span class="line">NSMutableArray *mut &#x3D;[array mutableCopy];</span><br><span class="line">NSString *array2 &#x3D; [array copy];</span><br><span class="line">NSLog(@&quot;\n%p \n%p\n%p&quot;,array,mut,array2);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">0x102840800 </span><br><span class="line">0x1028408a0</span><br><span class="line">0x102840800</span><br><span class="line"></span><br><span class="line">void test3()&#123;</span><br><span class="line">NSArray *array &#x3D; [@[@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;] mutableCopy];</span><br><span class="line">NSMutableArray *mut &#x3D;[array mutableCopy];</span><br><span class="line">NSString *array2 &#x3D; [array copy];</span><br><span class="line">NSLog(@&quot;\n%p \n%p\n%p&quot;,array,mut,array2);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">0x102808720 </span><br><span class="line">0x1028088a0</span><br><span class="line">0x1028089a0</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥æ€»ç»“çœ‹å‡ºæ¥ï¼Œä¸å˜æ•°ç»„æ‹·è´å‡ºæ¥ä¸å˜æ•°ç»„ï¼Œåœ°å€ä¸æ”¹å˜ï¼Œæ‹·è´å‡ºæ¥å¯å˜æ•°ç»„åœ°å€æ”¹å˜ï¼Œå¯å˜æ•°ç»„æ‹·è´å‡ºæ¥ä¸å¯å˜æ•°ç»„å’Œå¯å˜æ•°ç»„ï¼Œåœ°å€ä¼šæ”¹å˜ã€‚</p><p>æˆ‘ä»¬å†æ¢æˆå…¶ä»–çš„å¸¸ç”¨çš„å­—å…¸</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">void test4()&#123;</span><br><span class="line">NSDictionary *item &#x3D; @&#123;@&quot;key&quot;:@&quot;value&quot;&#125;;</span><br><span class="line">NSMutableDictionary *mut &#x3D;[item mutableCopy];</span><br><span class="line">NSDictionary *item2 &#x3D; [item copy];</span><br><span class="line">NSLog(@&quot;\n%p \n%p\n%p&quot;,item,mut,item2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">0x1007789c0 </span><br><span class="line">0x100779190</span><br><span class="line">0x1007789c0</span><br><span class="line"></span><br><span class="line">void test5()&#123;</span><br><span class="line">NSDictionary *item &#x3D; [@&#123;@&quot;key&quot;:@&quot;value&quot;&#125;mutableCopy];</span><br><span class="line">NSMutableDictionary *mut &#x3D;[item mutableCopy];</span><br><span class="line">NSDictionary *item2 &#x3D; [item copy];</span><br><span class="line">NSLog(@&quot;\n%p \n%p\n%p&quot;,item,mut,item2);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">0x1007041d0 </span><br><span class="line">0x1007042b0</span><br><span class="line">0x1007043a0</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢å¯ä»¥æ€»ç»“çœ‹å‡ºæ¥ï¼Œä¸å˜å­—å…¸æ‹·è´å‡ºæ¥ä¸å˜å­—å…¸ï¼Œåœ°å€ä¸æ”¹å˜ï¼Œæ‹·è´å‡ºæ¥å¯å˜å­—å…¸åœ°å€æ”¹å˜ï¼Œå¯å˜å­—å…¸æ‹·è´å‡ºæ¥ä¸å¯å˜å­—å…¸å’Œå¯å˜å­—å…¸ï¼Œåœ°å€ä¼šæ”¹å˜ã€‚</p><p>ç”±è¿™å‡ ä¸ªçœ‹å‡ºæ¥ï¼Œæ€»ç»“å‡ºæ¥ä¸‹è¡¨</p><table><thead><tr><th style="text-align:center">ç±»å‹</th><th style="text-align:center">copy</th><th style="text-align:center">mutableCopy</th></tr></thead><tbody><tr><td style="text-align:center">NSString</td><td style="text-align:center">æµ…æ‹·è´</td><td style="text-align:center">æ·±æ‹·è´</td></tr><tr><td style="text-align:center">NSMutableString</td><td style="text-align:center">æµ…æ‹·è´</td><td style="text-align:center">æ·±æ‹·è´</td></tr><tr><td style="text-align:center">NSArray</td><td style="text-align:center">æµ…æ‹·è´</td><td style="text-align:center">æ·±æ‹·è´</td></tr><tr><td style="text-align:center">NSMutableArray</td><td style="text-align:center">æ·±æ‹·è´</td><td style="text-align:center">æ·±æ‹·è´</td></tr><tr><td style="text-align:center">NSDictionary</td><td style="text-align:center">æµ…æ‹·è´</td><td style="text-align:center">æ·±æ‹·è´</td></tr><tr><td style="text-align:center">NSMutableDictionary</td><td style="text-align:center">æ·±æ‹·è´</td><td style="text-align:center">æ·±æ‹·è´</td></tr></tbody></table><h4 id="è‡ªå®šä¹‰å¯¹è±¡å®ç°åè®®NSCoping"><a href="#è‡ªå®šä¹‰å¯¹è±¡å®ç°åè®®NSCoping" class="headerlink" title="è‡ªå®šä¹‰å¯¹è±¡å®ç°åè®®NSCoping"></a>è‡ªå®šä¹‰å¯¹è±¡å®ç°åè®®NSCoping</h4><p>è‡ªå®šä¹‰çš„å¯¹è±¡ä½¿ç”¨copyå‘¢ï¼Ÿç³»ç»Ÿçš„å·²ç»å®ç°äº†ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„éœ€è¦è‡ªå·±å»å®ç°ï¼Œè‡ªå®šä¹‰çš„ç±»ç»§æ‰¿<code>NSCopying</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@protocol NSCopying</span><br><span class="line"></span><br><span class="line">- (id)copyWithZone:(nullable NSZone *)zone;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@protocol NSMutableCopying</span><br><span class="line"></span><br><span class="line">- (id)mutableCopyWithZone:(nullable NSZone *)zone;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°<code>NSCopying</code>å’Œ<code>NSMutableCopying</code>è¿™ä¸¤ä¸ªåè®®ï¼Œå¯¹äºè‡ªå®šä¹‰çš„å¯å˜å¯¹è±¡ï¼Œå…¶å®æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œæœ¬æ¥è‡ªå®šä¹‰çš„å¯¹è±¡çš„å±æ€§ï¼ŒåŸºæœ¬éƒ½æ˜¯å¯å˜çš„ï¼Œæ‰€ä»¥åªéœ€è¦å®ç°<code>NSCopying</code>åè®®å°±å¥½äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,assign) int age;</span><br><span class="line">@property (nonatomic,assign) int level;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface FYPerson()&lt;NSCopying&gt;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYPerson</span><br><span class="line">-(instancetype)copyWithZone:(NSZone *)zone&#123;</span><br><span class="line">FYPerson *p&#x3D;[[FYPerson alloc]init];</span><br><span class="line">p.age &#x3D; self.age;</span><br><span class="line">p.level &#x3D; self.level;</span><br><span class="line">return p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FYPerson *p &#x3D;[[FYPerson alloc]init];</span><br><span class="line">p.age &#x3D; 10;</span><br><span class="line">p.level &#x3D; 11;</span><br><span class="line">FYPerson *p2 &#x3D;[p copy];</span><br><span class="line">NSLog(@&quot;%d %d&quot;,p2.age,p2.level);</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">10 11</span><br></pre></td></tr></table></figure><p>è‡ªå·±å®ç°äº†<code>NSCoping</code>åè®®å®Œæˆäº†å¯¹å¯¹è±¡çš„æ·±æ‹·è´ï¼ŒæˆåŠŸå°†å¯¹è±¡çš„å±æ€§å¤åˆ¶è¿‡å»äº†ï¼Œå½“å±æ€§å¤šäº†æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>runtime</code>å®ç°ä¸€ä¸ªä¸€åŠ³æ°¸é€¸çš„æ–¹æ¡ˆã€‚</p><p>ç„¶åå°†<code>copyWithZone</code>åˆ©ç”¨<code>runtime</code>éå†æ‰€æœ‰çš„æˆå‘˜å˜é‡ï¼Œå°†æ‰€æœ‰çš„å˜é‡éƒ½èµ‹å€¼ï¼Œå½“å˜é‡å¤šçš„æ—¶å€™ï¼Œè¿™é‡Œä¹Ÿä¸ç”¨ä¿®æ”¹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@implementation NSObject (add)</span><br><span class="line">-(instancetype)copyWithZone:(NSZone *)zone&#123;</span><br><span class="line">    Class cls &#x3D; [self class];</span><br><span class="line">    NSObject * p&#x3D;[cls new];</span><br><span class="line">    &#x2F;&#x2F;æˆå‘˜å˜é‡ä¸ªæ•°</span><br><span class="line">    unsigned int count;</span><br><span class="line">    &#x2F;&#x2F;èµ‹å€¼æˆå‘˜å˜é‡æ•°ç»„</span><br><span class="line">    Ivar *ivars &#x3D; class_copyIvarList(self.class, &amp;count);</span><br><span class="line">    &#x2F;&#x2F;éå†æ•°ç»„</span><br><span class="line">    for (int i &#x3D; 0; i &lt; count; i ++) &#123;</span><br><span class="line">        Ivar var &#x3D; ivars[i];</span><br><span class="line">        &#x2F;&#x2F;è·å–æˆå‘˜å˜é‡åå­—</span><br><span class="line">        const char * name &#x3D; ivar_getName(var);</span><br><span class="line">        if (name !&#x3D; nil) &#123;</span><br><span class="line">            NSString *v &#x3D; [NSString stringWithUTF8String:name];</span><br><span class="line">            id value &#x3D; [self valueForKey:v];</span><br><span class="line">            &#x2F;&#x2F;ç»™æ–°çš„å¯¹è±¡èµ‹å€¼</span><br><span class="line">            if (value !&#x3D; NULL) &#123;</span><br><span class="line">                [p setValue:value forKey:v];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free(ivars);</span><br><span class="line">    return p;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">FYPerson *p &#x3D;[[FYPerson alloc]init];</span><br><span class="line">p.age &#x3D; 10;</span><br><span class="line">p.level &#x3D; 11;</span><br><span class="line">p.name &#x3D; @&quot;xiaowang&quot;;</span><br><span class="line">FYPerson *p2 &#x3D;[p copy];</span><br><span class="line">NSLog(@&quot;%d %d %@&quot;,p2.age,p2.level,p2.name);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">10 </span><br><span class="line">11 </span><br><span class="line">xiaowang</span><br></pre></td></tr></table></figure><p>æ ¹æ®å¯åŠ¨é¡ºåºï¼Œç±»åˆ«çš„æ–¹æ³•åœ¨ç±»çš„æ–¹æ³•åŠ è½½åè¾¹ï¼Œç±»åˆ«ä¸­çš„æ–¹æ³•ä¼šè¦†ç›–ç±»çš„æ–¹æ³•ï¼Œæ‰€ä»¥<br>åœ¨åŸºç±»<code>NSObject</code>åœ¨ç±»åˆ«ä¸­é‡å†™äº†<code>-(instancetype)copyWithZone:(NSZone *)zone</code>æ–¹æ³•ï¼Œå­ç±»å°±ä¸ç”¨é‡å†™äº†ã€‚è¾¾æˆäº†ä¸€åŠ³æ°¸é€¸çš„æ–¹æ¡ˆã€‚</p><h3 id="å¼•ç”¨è®¡æ•°åŸç†"><a href="#å¼•ç”¨è®¡æ•°åŸç†" class="headerlink" title="å¼•ç”¨è®¡æ•°åŸç†"></a>å¼•ç”¨è®¡æ•°åŸç†</h3><p>æ‘˜è‡ª<span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTUlQkMlOTUlRTclOTQlQTglRTglQUUlQTElRTYlOTUlQjAvMTAyMDU1MDc/ZnI9YWxhZGRpbg==" title="https://baike.baidu.com/item/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/10205507?fr=aladdin">ç™¾åº¦ç™¾ç§‘<i class="fa fa-external-link"></i></span></p><blockquote><p>å¼•ç”¨è®¡æ•°æ˜¯è®¡ç®—æœºç¼–ç¨‹è¯­è¨€ä¸­çš„ä¸€ç§å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œæ˜¯æŒ‡å°†èµ„æºï¼ˆå¯ä»¥æ˜¯å¯¹è±¡ã€å†…å­˜æˆ–ç£ç›˜ç©ºé—´ç­‰ç­‰ï¼‰çš„è¢«å¼•ç”¨æ¬¡æ•°ä¿å­˜èµ·æ¥ï¼Œå½“è¢«å¼•ç”¨æ¬¡æ•°å˜ä¸ºé›¶æ—¶å°±å°†å…¶é‡Šæ”¾çš„è¿‡ç¨‹ã€‚ä½¿ç”¨å¼•ç”¨è®¡æ•°æŠ€æœ¯å¯ä»¥å®ç°è‡ªåŠ¨èµ„æºç®¡ç†çš„ç›®çš„ã€‚åŒæ—¶å¼•ç”¨è®¡æ•°è¿˜å¯ä»¥æŒ‡ä½¿ç”¨å¼•ç”¨è®¡æ•°æŠ€æœ¯å›æ”¶æœªä½¿ç”¨èµ„æºçš„åƒåœ¾å›æ”¶ç®—æ³•</p></blockquote><p>åœ¨iOSä¸­ï¼Œä½¿ç”¨å¼•ç”¨è®¡æ•°æ¥ç®¡ç†<code>OC</code>å¯¹è±¡å†…å­˜ï¼Œä¸€ä¸ªæ–°åˆ›å»ºçš„OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°é»˜è®¤æ˜¯1ï¼Œå½“å¼•ç”¨è®¡æ•°å‡ä¸º0ï¼Œ<code>OC</code>å¯¹è±¡å°±ä¼šé”€æ¯ï¼Œé‡Šæ”¾å…¶ä»–å†…å­˜ç©ºé—´ï¼Œè°ƒç”¨<code>retain</code>ä¼šè®©<code>OC</code>å¯¹è±¡çš„å¼•ç”¨è®¡æ•°+1ï¼Œè°ƒç”¨<code>release</code>ä¼šè®©<code>OC</code>å¯¹è±¡çš„å¼•ç”¨è®¡æ•°-1ã€‚<br>å½“è°ƒç”¨<code>allocã€newã€copyã€mutableCopy</code>æ–¹æ³•è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨ä¸éœ€è¦è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œè¦è°ƒç”¨<code>release</code>æˆ–è€…<code>autorelease</code>æ¥é‡Šæ”¾å®ƒï¼Œæƒ³æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼Œå°±è®©ä»–çš„å¼•ç”¨è®¡æ•°+1ï¼Œä¸å†æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼Œå°±è®©ä»–å¼•ç”¨è®¡æ•°-1.</p><p>åœ¨MRCä¸­æˆ‘ä»¬ç»å¸¸éƒ½æ˜¯è¿™æ ·å­ä½¿ç”¨çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FYPerson *p&#x3D;[[FYPerson alloc]init];</span><br><span class="line">FYPerson *p2 &#x3D;[p retain];</span><br><span class="line">&#x2F;&#x2F;code here</span><br><span class="line">[p release];</span><br><span class="line">[p2 release];</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨ARCä¸­æ˜¯ç³»ç»Ÿå¸®æˆ‘ä»¬åšäº†è‡ªåŠ¨å¼•ç”¨è®¡æ•°ï¼Œä¸ç”¨å¼€å‘è€…åšå¾ˆå¤šç¹ççš„äº‹æƒ…äº†ï¼Œæˆ‘ä»¬å°±æ¢ç©¶ä¸‹å¼•ç”¨è®¡æ•°æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p><p>å¼•ç”¨è®¡æ•°å­˜å‚¨åœ¨<code>isa</code>æŒ‡é’ˆä¸­çš„<code>extra_rc</code>ï¼Œå­˜å‚¨å€¼å¤§äºè¿™ä¸ªèŒƒå›´çš„æ—¶å€™ï¼Œåˆ™<code>bits.has_sidetable_rc=1</code>ç„¶åå°†å‰©ä½™çš„<code>RetainCount</code>å­˜å‚¨åˆ°å…¨å±€çš„<code>table</code>ï¼Œ<code>key</code>æ˜¯<code>self</code>å¯¹åº”çš„å€¼ã€‚</p><p><code>Retain</code>çš„<code>runtime</code>æºç æŸ¥æ‰¾å‡½æ•°è·¯å¾„<code>objc_object::retain()</code>-&gt;<code>objc_object::rootRetain()</code>-&gt;<code>objc_object::rootRetain(bool, bool)</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;å¤§æ¦‚ç‡x&#x3D;&#x3D;1 æé«˜è¯»å–æŒ‡ä»¤çš„æ•ˆç‡</span><br><span class="line">#define fastpath(x) (__builtin_expect(bool(x), 1))</span><br><span class="line">&#x2F;&#x2F;å¤§æ¦‚ç‡x&#x3D;&#x3D;0 æé«˜è¯»å–æŒ‡ä»¤çš„æ•ˆç‡</span><br><span class="line">#define slowpath(x) (__builtin_expect(bool(x), 0))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å¼•ç”¨è®¡æ•°+1</span><br><span class="line">&#x2F;&#x2F;tryRetain å°è¯•+1</span><br><span class="line">&#x2F;&#x2F;handleOverflow æ˜¯å¦è¦†ç›–</span><br><span class="line">ALWAYS_INLINE id  objc_object::rootRetain(bool tryRetain, bool handleOverflow)</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;&#x2F;ä¼˜åŒ–çš„æŒ‡é’ˆ è¿”å›this</span><br><span class="line">    if (isTaggedPointer()) return (id)this;</span><br><span class="line"></span><br><span class="line">    bool sideTableLocked &#x3D; false;</span><br><span class="line">    bool transcribeToSideTable &#x3D; false;</span><br><span class="line"></span><br><span class="line">    isa_t oldisa;</span><br><span class="line">    isa_t newisa;</span><br><span class="line"></span><br><span class="line">    do &#123;</span><br><span class="line">        transcribeToSideTable &#x3D; false;</span><br><span class="line">&#x2F;&#x2F;old bits</span><br><span class="line">        oldisa &#x3D; LoadExclusive(&amp;isa.bits);</span><br><span class="line">        newisa &#x3D; oldisa;</span><br><span class="line">&#x2F;&#x2F;ä½¿ç”¨è”åˆä½“æŠ€æœ¯</span><br><span class="line">        if (slowpath(!newisa.nonpointer)) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);&#x2F;&#x2F;nothing</span><br><span class="line">            if (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock();&#x2F;&#x2F;è§£é”</span><br><span class="line">            if (tryRetain) return sidetable_tryRetain() ? (id)this : nil;</span><br><span class="line">else return sidetable_retain();&#x2F;&#x2F;&#x2F;&#x2F;sidetable å¼•ç”¨è®¡æ•°+1</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; don&#39;t check newisa.fast_rr; we already called any RR overrides</span><br><span class="line">&#x2F;&#x2F;ä¸å°è¯•retain å’Œ æ­£åœ¨é”€æ¯ ä»€ä¹ˆéƒ½ä¸åš è¿”å› nil</span><br><span class="line">        if (slowpath(tryRetain &amp;&amp; newisa.deallocating)) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            if (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock();</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">        uintptr_t carry;</span><br><span class="line">&#x2F;&#x2F;å¼•ç”¨è®¡æ•°+1 (bits.extra_rc++;)</span><br><span class="line">        newisa.bits &#x3D; addc(newisa.bits, RC_ONE, 0, &amp;carry);  &#x2F;&#x2F; extra_rc++</span><br><span class="line"></span><br><span class="line">        if (slowpath(carry)) &#123;</span><br><span class="line">            &#x2F;&#x2F; newisa.extra_rc++ æº¢å‡ºå¤„ç†</span><br><span class="line">            if (!handleOverflow) &#123;</span><br><span class="line">                ClearExclusive(&amp;isa.bits);</span><br><span class="line">                return rootRetain_overflow(tryRetain);</span><br><span class="line">            &#125;</span><br><span class="line">&#x2F;&#x2F;ä¸ºæ‹·è´åˆ°side table åšå‡†å¤‡</span><br><span class="line">            if (!tryRetain &amp;&amp; !sideTableLocked) sidetable_lock();</span><br><span class="line">            sideTableLocked &#x3D; true;</span><br><span class="line">            transcribeToSideTable &#x3D; true;</span><br><span class="line">            newisa.extra_rc &#x3D; RC_HALF;</span><br><span class="line">            newisa.has_sidetable_rc &#x3D; true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; while (slowpath(!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)));</span><br><span class="line"></span><br><span class="line">    if (slowpath(transcribeToSideTable)) &#123;</span><br><span class="line">&#x2F;&#x2F;æ‹·è´ å¹³å¤–ä¸€åŠçš„ å¼•ç”¨è®¡æ•°åˆ° side table</span><br><span class="line">        sidetable_addExtraRC_nolock(RC_HALF);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (slowpath(!tryRetain &amp;&amp; sideTableLocked)) sidetable_unlock();</span><br><span class="line">    return (id)this;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;sidetable å¼•ç”¨è®¡æ•°+1</span><br><span class="line">id objc_object::sidetable_retain()</span><br><span class="line">&#123;</span><br><span class="line">#if SUPPORT_NONPOINTER_ISA</span><br><span class="line">    assert(!isa.nonpointer);</span><br><span class="line">#endif</span><br><span class="line">&#x2F;&#x2F;å–å‡ºtable key&#x3D;this</span><br><span class="line">    SideTable&amp; table &#x3D; SideTables()[this];</span><br><span class="line">    </span><br><span class="line">    table.lock();</span><br><span class="line">    size_t&amp; refcntStorage &#x3D; table.refcnts[this];</span><br><span class="line">    if (! (refcntStorage &amp; SIDE_TABLE_RC_PINNED)) &#123;</span><br><span class="line">        refcntStorage +&#x3D; SIDE_TABLE_RC_ONE;</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line"></span><br><span class="line">    return (id)this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¼•ç”¨è®¡æ•°+1ï¼Œåˆ¤æ–­äº†éœ€è¦æ˜¯æŒ‡é’ˆæ²¡æœ‰ä¼˜åŒ–å’Œ<code>isa</code>æœ‰æ²¡æœ‰ä½¿ç”¨çš„è”åˆä½“æŠ€æœ¯ï¼Œç„¶åå°†åˆ¤æ–­æ˜¯å¦æº¢å‡ºï¼Œæº¢å‡ºçš„è¯ï¼Œå°†<code>extra_rc</code>çš„å€¼å¤åˆ¶åˆ°<code>side table</code>ä¸­ï¼Œè®¾ç½®å‚æ•°<code>isa-&gt;has_sidetable_rc=true</code>ã€‚</p><p>å¼•ç”¨è®¡æ•°-1ï¼Œåœ¨<code>runtime</code>æºç ä¸­æŸ¥æ‰¾è·¯å¾„æ˜¯<code>objc_object::release()</code>-&gt;<code>objc_object::rootRelease()</code>-&gt;<code>objc_object::rootRelease(bool performDealloc, bool handleUnderflow)</code>,æˆ‘ä»¬è¿›å…¥åˆ°å‡½æ•°å†…éƒ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">ALWAYS_INLINE bool  objc_object::rootRelease(bool performDealloc, bool handleUnderflow)</span><br><span class="line">&#123;</span><br><span class="line">    if (isTaggedPointer()) return false;&#x2F;&#x2F;æŒ‡é’ˆä¼˜åŒ–çš„ä¸å­˜åœ¨è®¡æ•°å™¨</span><br><span class="line"></span><br><span class="line">    bool sideTableLocked &#x3D; false;</span><br><span class="line"></span><br><span class="line">    isa_t oldisa;</span><br><span class="line">    isa_t newisa;</span><br><span class="line"></span><br><span class="line"> retry:</span><br><span class="line">    do &#123;&#x2F;&#x2F;isa</span><br><span class="line">        oldisa &#x3D; LoadExclusive(&amp;isa.bits);</span><br><span class="line">        newisa &#x3D; oldisa;</span><br><span class="line">        if (slowpath(!newisa.nonpointer)) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            if (sideTableLocked) sidetable_unlock();</span><br><span class="line">&#x2F;&#x2F;side table -1</span><br><span class="line">            return sidetable_release(performDealloc);</span><br><span class="line">        &#125;</span><br><span class="line">        uintptr_t carry;</span><br><span class="line">        newisa.bits &#x3D; subc(newisa.bits, RC_ONE, 0, &amp;carry);  &#x2F;&#x2F; extra_rc--</span><br><span class="line">        if (slowpath(carry)) &#123;</span><br><span class="line">            &#x2F;&#x2F; don&#39;t ClearExclusive()</span><br><span class="line">            goto underflow;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; while (slowpath(!StoreReleaseExclusive(&amp;isa.bits, </span><br><span class="line">                                             oldisa.bits, newisa.bits)));</span><br><span class="line"></span><br><span class="line">    if (slowpath(sideTableLocked)) sidetable_unlock();</span><br><span class="line">    return false;</span><br><span class="line"></span><br><span class="line"> underflow:</span><br><span class="line">    newisa &#x3D; oldisa;</span><br><span class="line"></span><br><span class="line">    if (slowpath(newisa.has_sidetable_rc)) &#123;</span><br><span class="line">        if (!handleUnderflow) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            return rootRelease_underflow(performDealloc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!sideTableLocked) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            sidetable_lock();</span><br><span class="line">            sideTableLocked &#x3D; true;</span><br><span class="line">            goto retry;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;side table å¼•ç”¨è®¡æ•°-1</span><br><span class="line">        size_t borrowed &#x3D; sidetable_subExtraRC_nolock(RC_HALF);</span><br><span class="line"></span><br><span class="line">        if (borrowed &gt; 0) &#123;</span><br><span class="line">            newisa.extra_rc &#x3D; borrowed - 1;  &#x2F;&#x2F; redo the original decrement too</span><br><span class="line">            bool stored &#x3D; StoreReleaseExclusive(&amp;isa.bits, </span><br><span class="line">                                                oldisa.bits, newisa.bits);</span><br><span class="line">            if (!stored) &#123;</span><br><span class="line">                isa_t oldisa2 &#x3D; LoadExclusive(&amp;isa.bits);</span><br><span class="line">                isa_t newisa2 &#x3D; oldisa2;</span><br><span class="line">                if (newisa2.nonpointer) &#123;</span><br><span class="line">                    uintptr_t overflow;</span><br><span class="line">                    newisa2.bits &#x3D; </span><br><span class="line">                        addc(newisa2.bits, RC_ONE * (borrowed-1), 0, &amp;overflow);</span><br><span class="line">                    if (!overflow) &#123;</span><br><span class="line">                        stored &#x3D; StoreReleaseExclusive(&amp;isa.bits, oldisa2.bits, </span><br><span class="line">                                                       newisa2.bits);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!stored) &#123;</span><br><span class="line">                &#x2F;&#x2F; Inline update failed.</span><br><span class="line">                &#x2F;&#x2F; Put the retains back in the side table.</span><br><span class="line">                sidetable_addExtraRC_nolock(borrowed);</span><br><span class="line">                goto retry;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sidetable_unlock();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            &#x2F;&#x2F; Side table is empty after all. Fall-through to the dealloc path.</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;çœŸæ­£çš„é”€æ¯</span><br><span class="line"></span><br><span class="line">    if (slowpath(newisa.deallocating)) &#123;</span><br><span class="line">        ClearExclusive(&amp;isa.bits);</span><br><span class="line">        if (sideTableLocked) sidetable_unlock();</span><br><span class="line">        return overrelease_error();</span><br><span class="line">        &#x2F;&#x2F; does not actually return</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F;è®¾ç½®æ­£åœ¨é”€æ¯</span><br><span class="line">    newisa.deallocating &#x3D; true;</span><br><span class="line">    if (!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)) goto retry;</span><br><span class="line"></span><br><span class="line">    if (slowpath(sideTableLocked)) sidetable_unlock();</span><br><span class="line"></span><br><span class="line">    __sync_synchronize();</span><br><span class="line">    if (performDealloc) &#123;</span><br><span class="line">&#x2F;&#x2F;é”€æ¯</span><br><span class="line">        ((void(*)(objc_object *, SEL))objc_msgSend)(this, SEL_dealloc);</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹äº†ä¸Šè¾¹äº†è§£åˆ°å¼•ç”¨è®¡æ•°åˆ†ä¸¤éƒ¨åˆ†ï¼Œ<code>extra_rc</code>å’Œ<code>side table</code>ï¼Œæ¢ç©¶ä¸€ä¸‹<br><code>rootRetainCount()</code>çš„å®ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">inline uintptr_t  objc_object::rootRetainCount()</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;&#x2F;ä¼˜åŒ–æŒ‡é’ˆ ç›´æ¥è¿”å›</span><br><span class="line">    if (isTaggedPointer()) return (uintptr_t)this;</span><br><span class="line">&#x2F;&#x2F;æ²¡ä¼˜åŒ–åˆ™ åˆ°SideTable è¯»å–</span><br><span class="line">    sidetable_lock();</span><br><span class="line">&#x2F;&#x2F;isaæŒ‡é’ˆ</span><br><span class="line">    isa_t bits &#x3D; LoadExclusive(&amp;isa.bits);</span><br><span class="line">    ClearExclusive(&amp;isa.bits);&#x2F;&#x2F;å•¥éƒ½æ²¡åš</span><br><span class="line">    if (bits.nonpointer) &#123;&#x2F;&#x2F;ä½¿ç”¨è”åˆä½“å­˜å‚¨æ›´å¤šçš„æ•°æ® </span><br><span class="line">        uintptr_t rc &#x3D; 1 + bits.extra_rc;&#x2F;&#x2F;è®¡æ•°æ•°é‡</span><br><span class="line">        if (bits.has_sidetable_rc) &#123;&#x2F;&#x2F;å½“å¤§è¿‡äº è”åˆä½“å­˜å‚¨çš„å€¼ åˆ™å¦å¤–åœ¨SideTableè¯»å–æ•°æ®</span><br><span class="line">&#x2F;&#x2F;è¯»å–tableçš„å€¼ ç›¸åŠ </span><br><span class="line">            rc +&#x3D; sidetable_getExtraRC_nolock();</span><br><span class="line">        &#125;</span><br><span class="line">        sidetable_unlock();</span><br><span class="line">        return rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sidetable_unlock();</span><br><span class="line">&#x2F;&#x2F;åœ¨sidetable ä¸­å­˜å‚¨çš„count</span><br><span class="line">    return sidetable_retainCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æ˜¯å­˜å‚¨å°æ•°æ®çš„æ—¶å€™ï¼ŒæŒ‡é’ˆä¼˜åŒ–ï¼Œåˆ™ç›´æ¥è¿”å›<code>self</code>,å¤§æ•°æ®çš„è¯ï¼Œåˆ™<code>table</code>åŠ é”ï¼Œ<br><code>class</code>ä¼˜åŒ–çš„ä¹‹å<span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81ZDJiY2YzZGYyNjVkYTFiNjcyMTNkNjk=" title="https://juejin.im/post/5d2bcf3df265da1b67213d69">ä½¿ç”¨è”åˆä½“å­˜å‚¨æ›´å¤šçš„æ•°æ®<i class="fa fa-external-link"></i></span>,<code>class</code>æ²¡æœ‰ä¼˜åŒ–åˆ™ç›´æ¥å»<code>sizedable</code>è¯»å–æ•°æ®ã€‚<br>ä¼˜åŒ–äº†åˆ™åœ¨<code>sidetable_getExtraRC_nolock()</code>è¯»å–æ•°æ®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ä½¿ç”¨è”åˆä½“</span><br><span class="line">size_t  objc_object::sidetable_getExtraRC_nolock()</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;&#x2F;ä¸æ˜¯è”åˆä½“æŠ€æœ¯ åˆ™æŠ¥é”™</span><br><span class="line">    assert(isa.nonpointer);</span><br><span class="line">&#x2F;&#x2F;keyæ˜¯ thisï¼Œå­˜å‚¨äº†æ¯ä¸ªå¯¹è±¡çš„table</span><br><span class="line">    SideTable&amp; table &#x3D; SideTables()[this];</span><br><span class="line">&#x2F;&#x2F;æ‰¾åˆ° it å¦åˆ™è¿”å›0</span><br><span class="line">    RefcountMap::iterator it &#x3D; table.refcnts.find(this);</span><br><span class="line">    if (it &#x3D;&#x3D; table.refcnts.end()) return 0;</span><br><span class="line">    else return it-&gt;second &gt;&gt; SIDE_TABLE_RC_SHIFT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰ä¼˜åŒ–çš„æ˜¯ç›´æ¥è¯»å–</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;æœªä½¿ç”¨è”åˆä½“çš„æƒ…å†µï¼Œ</span><br><span class="line">uintptr_t objc_object::sidetable_retainCount()</span><br><span class="line">&#123;&#x2F;&#x2F;æ²¡æœ‰è”åˆä½“å­˜å‚¨çš„è®¡æ•°å™¨åˆ™ç›´æ¥åœ¨tableä¸­å–å‡ºæ¥</span><br><span class="line">    SideTable&amp; table &#x3D; SideTables()[this];</span><br><span class="line">    size_t refcnt_result &#x3D; 1;</span><br><span class="line">    table.lock();</span><br><span class="line">    RefcountMap::iterator it &#x3D; table.refcnts.find(this);</span><br><span class="line">    if (it !&#x3D; table.refcnts.end()) &#123;</span><br><span class="line">        refcnt_result +&#x3D; it-&gt;second &gt;&gt; SIDE_TABLE_RC_SHIFT;</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">    return refcnt_result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="weakæŒ‡é’ˆåŸç†"><a href="#weakæŒ‡é’ˆåŸç†" class="headerlink" title="weakæŒ‡é’ˆåŸç†"></a>weakæŒ‡é’ˆåŸç†</h3><p>å½“ä¸€ä¸ªå¯¹è±¡è¦é”€æ¯çš„æ—¶å€™ä¼šè°ƒç”¨<code>dealloc</code>,è°ƒç”¨è½¨è¿¹æ˜¯<code>dealloc</code>-&gt;<code>_objc_rootDealloc</code>-&gt;<code>object_dispose</code>-&gt;<code>objc_destructInstance</code>-&gt;<code>free</code><br>æˆ‘ä»¬è¿›å…¥åˆ°<code>objc_destructInstance</code>å†…éƒ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">void *objc_destructInstance(id obj) </span><br><span class="line">&#123;</span><br><span class="line">    if (obj) &#123;</span><br><span class="line">        &#x2F;&#x2F; Read all of the flags at once for performance.</span><br><span class="line">&#x2F;&#x2F;c++ææ„å‡½æ•°</span><br><span class="line">        bool cxx &#x3D; obj-&gt;hasCxxDtor();</span><br><span class="line">&#x2F;&#x2F;å…³è”å‡½æ•°</span><br><span class="line">        bool assoc &#x3D; obj-&gt;hasAssociatedObjects();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; This order is important.</span><br><span class="line">        if (cxx) object_cxxDestruct(obj);</span><br><span class="line">        if (assoc) _object_remove_assocations(obj);</span><br><span class="line">        obj-&gt;clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é”€æ¯äº†c++ææ„å‡½æ•°å’Œå…³è”å‡½æ•°æœ€åè¿›å…¥åˆ°<code>clearDeallocating</code>ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°å‡½æ•°å†…éƒ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;æ­£åœ¨æ¸…é™¤side table å’Œweakly referenced</span><br><span class="line">inline void </span><br><span class="line">objc_object::clearDeallocating()</span><br><span class="line">&#123;</span><br><span class="line">    if (slowpath(!isa.nonpointer)) &#123;</span><br><span class="line">        &#x2F;&#x2F; Slow path for raw pointer isa.</span><br><span class="line">&#x2F;&#x2F;é‡Šæ”¾weak</span><br><span class="line">        sidetable_clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line">    else if (slowpath(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123;</span><br><span class="line">        &#x2F;&#x2F; Slow path for non-pointer isa with weak refs and&#x2F;or side table data.</span><br><span class="line">&#x2F;&#x2F;é‡Šæ”¾weak å’Œå¼•ç”¨è®¡æ•°</span><br><span class="line">        clearDeallocating_slow();</span><br><span class="line">    &#125;</span><br><span class="line">    assert(!sidetable_present());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè°ƒç”¨äº†<code>sidetable_clearDeallocating</code>å’Œ<code>clearDeallocating_slow</code>å®ç°é”€æ¯<code>weak</code>å’Œå¼•ç”¨è®¡æ•°<code>side table</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">NEVER_INLINE void</span><br><span class="line">objc_object::clearDeallocating_slow()</span><br><span class="line">&#123;</span><br><span class="line">    assert(isa.nonpointer  &amp;&amp;  (isa.weakly_referenced || isa.has_sidetable_rc));</span><br><span class="line"></span><br><span class="line">    SideTable&amp; table &#x3D; SideTables()[this];</span><br><span class="line">    table.lock();</span><br><span class="line">&#x2F;&#x2F;æ¸…é™¤weak</span><br><span class="line">    if (isa.weakly_referenced) &#123;</span><br><span class="line">&#x2F;&#x2F;table.weak_table å¼±å¼•ç”¨è¡¨</span><br><span class="line">        weak_clear_no_lock(&amp;table.weak_table, (id)this);</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F;å¼•ç”¨è®¡æ•°</span><br><span class="line">    if (isa.has_sidetable_rc) &#123;</span><br><span class="line">&#x2F;&#x2F;æ“¦é™¤ this</span><br><span class="line">        table.refcnts.erase(this);</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®<code>weak</code>ä¿®é¥°çš„å¯¹è±¡ä¼šå­˜å‚¨åœ¨å…¨å±€çš„<code>SideTable</code>ï¼Œå½“å¯¹è±¡é”€æ¯çš„æ—¶å€™ä¼šåœ¨<code>SideTable</code>è¿›è¡ŒæŸ¥æ‰¾ï¼Œæ—¶å€™æœ‰<code>weak</code>å¯¹è±¡ï¼Œæœ‰çš„è¯åˆ™è¿›è¡Œé”€æ¯ã€‚</p><h3 id="Autoreleasepool-åŸç†"><a href="#Autoreleasepool-åŸç†" class="headerlink" title="Autoreleasepool åŸç†"></a>Autoreleasepool åŸç†</h3><p><code>Autoreleasepool</code>ä¸­æ–‡åè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œé‡Œè¾¹è£…ç€ä¸€äº›å˜é‡ï¼Œå½“æ± å­ä¸éœ€è¦ï¼ˆé”€æ¯ï¼‰çš„æ—¶å€™ï¼Œ<code>release</code>é‡Œè¾¹çš„å¯¹è±¡(å¼•ç”¨è®¡æ•°-1)ã€‚<br>æˆ‘ä»¬å°†ä¸‹è¾¹çš„ä»£ç è½¬åŒ–æˆc++</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@autoreleasepool &#123;</span><br><span class="line">FYPerson *p &#x3D; [[FYPerson alloc]init];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -f  main.m</code><br>è½¬æˆc++</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;* @autoreleasepool *&#x2F; &#123;</span><br><span class="line"> __AtAutoreleasePool __autoreleasepool;</span><br><span class="line"> FYPerson *p &#x3D; ((FYPerson *(*)(id, SEL))(void *)objc_msgSend)((id)((FYPerson *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(&quot;FYPerson&quot;), sel_registerName(&quot;alloc&quot;)), sel_registerName(&quot;init&quot;));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>__AtAutoreleasePool</code>æ˜¯ä¸€ä¸ªç»“æ„ä½“</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct __AtAutoreleasePool &#123;</span><br><span class="line">__AtAutoreleasePool() &#123;&#x2F;&#x2F;æ„é€ å‡½æ•° ç”Ÿæˆç»“æ„ä½“å˜é‡çš„æ—¶å€™è°ƒç”¨</span><br><span class="line">atautoreleasepoolobj &#x3D; objc_autoreleasePoolPush();</span><br><span class="line">&#125;</span><br><span class="line">~__AtAutoreleasePool() &#123;&#x2F;&#x2F;ææ„å‡½æ•° é”€æ¯çš„æ—¶å€™è°ƒç”¨</span><br><span class="line">objc_autoreleasePoolPop(atautoreleasepoolobj);</span><br><span class="line">&#125;</span><br><span class="line">void * atautoreleasepoolobj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç„¶åå°†ä¸Šè¾¹çš„ä»£ç å’Œc++æ•´åˆåˆ°ä¸€èµ·å°±æ˜¯è¿™æ ·å­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    __AtAutoreleasePool pool &#x3D; objc_autoreleasePoolPush();</span><br><span class="line">    FYPerson *p &#x3D; [[FYPerson alloc]init];</span><br><span class="line">    objc_autoreleasePoolPop(pool)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿›å…¥å¤§æ‹¬å·ç”Ÿæˆä¸€ä¸ªé‡Šæ”¾æ± ï¼Œç¦»å¼€å¤§æ‹¬å·åˆ™é‡Šæ”¾é‡Šæ”¾æ± ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹é‡Šæ”¾å‡½æ•°æ˜¯æ€ä¹ˆå·¥ä½œçš„,åœ¨<code>runtime</code>æºç ä¸­<code>NSObject.mm 1848 è¡Œ</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void objc_autoreleasePoolPop(void *ctxt)</span><br><span class="line">&#123;</span><br><span class="line">    AutoreleasePoolPage::pop(ctxt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>pop</code>å®ç°äº†<code>AutoreleasePoolPage</code>ä¸­çš„å¯¹è±¡çš„é‡Šæ”¾ï¼Œæƒ³äº†è§£æ€ä¹ˆé‡Šæ”¾çš„å¯ä»¥ç ”ç©¶ä¸‹æºç <code>runtime NSObject.mm 1063è¡Œ</code>ã€‚</p><p>å…¶å®<code>AutoreleasePool</code>æ˜¯<code>AutoreleasePoolPage</code>æ¥ç®¡ç†çš„ï¼Œ<code>AutoreleasePoolpage</code>ç»“æ„å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class AutoreleasePoolPage &#123;</span><br><span class="line">    magic_t const magic;</span><br><span class="line">    id *next;&#x2F;&#x2F;ä¸‹ä¸€ä¸ªå­˜æ”¾aotoreleasså¯¹è±¡çš„åœ°å€</span><br><span class="line">    pthread_t const thread;&#x2F;&#x2F;çº¿ç¨‹</span><br><span class="line">    AutoreleasePoolPage * const parent; &#x2F;&#x2F;çˆ¶èŠ‚ç‚¹</span><br><span class="line">    AutoreleasePoolPage *child;&#x2F;&#x2F;å­èŠ‚ç‚¹</span><br><span class="line">    uint32_t const depth;&#x2F;&#x2F;æ·±åº¦</span><br><span class="line">    uint32_t hiwat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AutoreleasePoolPage</code>åœ¨åˆå§‹åŒ–åœ¨<code>autoreleaseNewPage</code>ç”³è¯·äº†<code>4096</code>å­—èŠ‚é™¤äº†è‡ªå·±å˜é‡çš„ç©ºé—´ï¼Œ<code>AutoreleasePoolPage</code>æ˜¯ä¸€ä¸ª<code>C++</code>å®ç°çš„ç±»</p><ul><li>å†…éƒ¨ä½¿ç”¨<code>id *next</code>æŒ‡å‘äº†æ ˆé¡¶æœ€æ–°<code>add</code>è¿›æ¥çš„<code>autorelease</code>å¯¹è±¡çš„ä¸‹ä¸€ä¸ªä½ç½®</li><li>ä¸€ä¸ª<code>AutoreleasePoolPage</code>çš„ç©ºé—´è¢«å æ»¡æ—¶ï¼Œä¼šæ–°å»ºä¸€ä¸ª<code>AutoreleasePoolPage</code>å¯¹è±¡ï¼Œè¿æ¥é“¾è¡¨ï¼Œåæ¥çš„<code>autorelease</code>å¯¹è±¡åœ¨æ–°çš„<code>page</code>åŠ å…¥</li><li><code>AutoreleasePoolPage</code>æ¯ä¸ªå¯¹è±¡ä¼šå¼€è¾Ÿ4096å­—èŠ‚å†…å­˜ï¼ˆä¹Ÿå°±æ˜¯è™šæ‹Ÿå†…å­˜ä¸€é¡µçš„å¤§å°ï¼‰ï¼Œé™¤äº†ä¸Šé¢çš„å®ä¾‹å˜é‡æ‰€å ç©ºé—´ï¼Œå‰©ä¸‹çš„ç©ºé—´å…¨éƒ¨ç”¨æ¥å‚¨å­˜<code>autorelease</code>å¯¹è±¡çš„åœ°å€</li><li><code>AutoreleasePool</code>æ˜¯æŒ‰çº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„ï¼ˆç»“æ„ä¸­çš„<code>thread</code>æŒ‡é’ˆæŒ‡å‘å½“å‰çº¿ç¨‹ï¼‰</li><li><code>AutoreleasePool</code>å¹¶æ²¡æœ‰å•ç‹¬çš„ç»“æ„ï¼Œè€Œæ˜¯ç”±è‹¥å¹²ä¸ª<code>AutoreleasePoolPage</code>ä»¥åŒå‘é“¾è¡¨çš„å½¢å¼ç»„åˆè€Œæˆï¼ˆåˆ†åˆ«å¯¹åº”ç»“æ„ä¸­çš„<code>parent</code>æŒ‡é’ˆå’Œ<code>child</code>æŒ‡é’ˆï¼‰</li></ul><p>å…¶ä»–çš„éƒ½æ˜¯è‡ªåŠ¨é‡Šæ”¾æ± çš„å…¶ä»–å¯¹è±¡çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬ä½¿ç”¨<code>_objc_autoreleasePoolPrint()</code>å¯ä»¥æŸ¥çœ‹é‡Šæ”¾æ± çš„å­˜å‚¨å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">extern void _objc_autoreleasePoolPrint(void);</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">@autoreleasepool &#123;&#x2F;&#x2F;r1 &#x3D; push()</span><br><span class="line"></span><br><span class="line">FYPerson *p &#x3D; [[FYPerson alloc]init];</span><br><span class="line">_objc_autoreleasePoolPrint();</span><br><span class="line">printf(&quot;\n--------------\n&quot;);</span><br><span class="line">&#125;&#x2F;&#x2F;pop(r1)</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">objc[23958]: ##############</span><br><span class="line">objc[23958]: AUTORELEASE POOLS for thread 0x1000aa5c0</span><br><span class="line">objc[23958]: 3 releases pending.</span><br><span class="line">objc[23958]: [0x101000000]  ................  PAGE  (hot) (cold)</span><br><span class="line">objc[23958]: [0x101000038]  ################  POOL 0x101000038</span><br><span class="line">objc[23958]: [0x101000040]       0x10050cfa0  FYPerson</span><br><span class="line">objc[23958]: [0x101000048]       0x10050cdb0  FYPerson</span><br><span class="line">objc[23958]: ##############</span><br><span class="line"></span><br><span class="line">--------------</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°å­˜å‚¨äº†<code>3 releases pending</code>ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸”å¤§å°éƒ½8å­—èŠ‚ã€‚å†çœ‹ä¸€ä¸ªå¤æ‚çš„,è‡ªåŠ¨é‡Šæ”¾æ± åµŒå¥—è‡ªåŠ¨é‡Šæ”¾æ± </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">@autoreleasepool &#123;&#x2F;&#x2F;r1 &#x3D; push()</span><br><span class="line"></span><br><span class="line">FYPerson *p &#x3D; [[[FYPerson alloc]init] autorelease];</span><br><span class="line">FYPerson *p2 &#x3D; [[[FYPerson alloc]init] autorelease];</span><br><span class="line">@autoreleasepool &#123;&#x2F;&#x2F;r1 &#x3D; push()</span><br><span class="line"></span><br><span class="line">FYPerson *p3 &#x3D; [[[FYPerson alloc]init] autorelease];</span><br><span class="line">FYPerson *p4 &#x3D; [[[FYPerson alloc]init] autorelease];</span><br><span class="line"></span><br><span class="line">_objc_autoreleasePoolPrint();</span><br><span class="line">printf(&quot;\n--------------\n&quot;);</span><br><span class="line">&#125;&#x2F;&#x2F;pop(r1)</span><br><span class="line">&#125;&#x2F;&#x2F;pop(r1)</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">objc[24025]: ##############</span><br><span class="line">objc[24025]: AUTORELEASE POOLS for thread 0x1000aa5c0</span><br><span class="line">objc[24025]: 6 releases pending.</span><br><span class="line">objc[24025]: [0x100803000]  ................  PAGE  (hot) (cold)</span><br><span class="line">objc[24025]: [0x100803038]  ################  POOL 0x100803038</span><br><span class="line">objc[24025]: [0x100803040]       0x100721580  FYPerson</span><br><span class="line">objc[24025]: [0x100803048]       0x100721b10  FYPerson</span><br><span class="line">objc[24025]: [0x100803050]  ################  POOL 0x100803050</span><br><span class="line">objc[24025]: [0x100803058]       0x100721390  FYPerson</span><br><span class="line">objc[24025]: [0x100803060]       0x100717620  FYPerson</span><br><span class="line">objc[24025]: ##############</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°äº†2ä¸ª<code>POOL</code>å’Œå››ä¸ª<code>FYPerson</code>å¯¹è±¡ï¼Œä¸€å…±æ˜¯6ä¸ªå¯¹è±¡ï¼Œå½“å‡ºäº†é‡Šæ”¾æ± ä¼šæ‰§è¡Œ<code>release</code>ã€‚</p><p>å½“æ— ä¼˜åŒ–çš„æŒ‡é’ˆè°ƒç”¨<code>autorelease</code>å…¶å®æ˜¯è°ƒç”¨äº†<code>AutoreleasePoolPage::autorelease((id)this)</code>-&gt;<code>autoreleaseFast(obj)</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">static inline id *autoreleaseFast(id obj)</span><br><span class="line"> &#123;</span><br><span class="line">     AutoreleasePoolPage *page &#x3D; hotPage();</span><br><span class="line">     &#x2F;&#x2F;å½“æœ‰åˆ†é¡µè€Œä¸”åˆ†é¡µæ²¡æœ‰æ»¡å°±æ·»åŠ </span><br><span class="line">     if (page &amp;&amp; !page-&gt;full()) &#123;</span><br><span class="line">         return page-&gt;add(obj);</span><br><span class="line">     &#125; else if (page) &#123;</span><br><span class="line">         &#x2F;&#x2F;æ»¡åˆ™æ–°å»ºä¸€ä¸ªpageè¿›è¡Œæ·»åŠ objå’Œè®¾ç½®hotpage</span><br><span class="line">         return autoreleaseFullPage(obj, page);</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">         &#x2F;&#x2F;æ²¡æœ‰pageåˆ™æ–°å»ºpageè¿›è¡Œæ·»åŠ </span><br><span class="line">         return autoreleaseNoPage(obj);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>MRC</code>ä¸­<br><code>autorealease</code>ä¿®é¥°çš„æ˜¯çš„å¯¹è±¡åœ¨æ²¡æœ‰å¤–éƒ¨æ·»åŠ åˆ°è‡ªåŠ¨é‡Šæ”¾æ± çš„æ—¶å€™ï¼Œåœ¨<code>runloop</code>å¾ªç¯çš„æ—¶å€™ä¼šé”€æ¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;</span><br><span class="line">    kCFRunLoopEntry &#x3D; (1UL &lt;&lt; 0),</span><br><span class="line">    kCFRunLoopBeforeTimers &#x3D; (1UL &lt;&lt; 1),</span><br><span class="line">    kCFRunLoopBeforeSources &#x3D; (1UL &lt;&lt; 2),</span><br><span class="line">    kCFRunLoopBeforeWaiting &#x3D; (1UL &lt;&lt; 5),</span><br><span class="line">    kCFRunLoopAfterWaiting &#x3D; (1UL &lt;&lt; 6),</span><br><span class="line">    kCFRunLoopExit &#x3D; (1UL &lt;&lt; 7),</span><br><span class="line">    kCFRunLoopAllActivities &#x3D; 0x0FFFFFFFU</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;activities &#x3D; 0xa0è½¬åŒ–æˆäºŒè¿›åˆ¶ 0b101 0000</span><br><span class="line">ç³»ç»Ÿç›‘å¬äº†mainRunloop çš„ kCFRunLoopBeforeWaiting å’ŒkCFRunLoopExitä¸¤ç§çŠ¶æ€æ¥æ›´æ–°autoreleaseçš„æ•°æ®</span><br><span class="line">&#x2F;&#x2F;å›è°ƒå‡½æ•°æ˜¯ _wrapRunLoopWithAutoreleasePoolHandler</span><br><span class="line"></span><br><span class="line">&quot;&lt;CFRunLoopObserver 0x600002538320 [0x10ce45ae8]&gt;&#123;valid &#x3D; Yes, activities &#x3D; 0xa0, </span><br><span class="line">repeats &#x3D; Yes, order &#x3D; 2147483647, </span><br><span class="line">callout &#x3D; _wrapRunLoopWithAutoreleasePoolHandler (0x10f94087d), </span><br><span class="line">context &#x3D; &lt;CFArray 0x600001a373f0 [0x10ce45ae8]&gt;&#123;type &#x3D; mutable-small, count &#x3D; 1, </span><br><span class="line">values &#x3D; (\n\t0 : &lt;0x7fb6dc004058&gt;\n)&#125;&#125;&quot;</span><br></pre></td></tr></table></figure><p><code>activities = 0xa0</code>è½¬åŒ–æˆäºŒè¿›åˆ¶ <code>0b101 0000</code><br>ç³»ç»Ÿç›‘å¬äº†<code>mainRunloop</code> çš„ <code>kCFRunLoopBeforeWaiting</code> å’Œ<code>kCFRunLoopExit</code>ä¸¤ç§çŠ¶æ€æ¥æ›´æ–°<code>autorelease</code>çš„æ•°æ®<br>å›è°ƒå‡½æ•°æ˜¯ <code>_wrapRunLoopWithAutoreleasePoolHandler</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">void test()&#123;</span><br><span class="line">    FYPerson *p &#x3D;[[FYPerson alloc]init];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>p</code>å¯¹è±¡åœ¨æŸæ¬¡å¾ªç¯ä¸­<code>push</code>ï¼Œåœ¨å¾ªç¯åˆ°<code>kCFRunLoopBeforeWaiting</code>è¿›è¡Œä¸€æ¬¡<code>pop</code>ï¼Œåˆ™ä¸Šæ¬¡å¾ªç¯çš„<code>autolease</code>å¯¹è±¡æ²¡æœ‰å…¶ä»–å¯¹è±¡<code>retain</code>çš„è¿›è¡Œé‡Šæ”¾ã€‚å¹¶ä¸æ˜¯å‡ºäº†<code>test()</code>ç«‹é©¬é‡Šæ”¾ã€‚</p><p>åœ¨ARCä¸­åˆ™æ‰§è¡Œå®Œæ¯•<code>test()</code>ä¼šé©¬ä¸Šé‡Šæ”¾ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>å½“é‡å¤åˆ›å»ºå¯¹è±¡æˆ–è€…ä»£ç æ®µä¸å®¹æ˜“ç®¡ç†ç”Ÿå‘½å‘¨æœŸä½¿ç”¨è‡ªåŠ¨é‡Šæ”¾æ± æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</li><li>å­˜åœ¨åœ¨å…¨å±€çš„<code>SideTable</code>ä¸­weakä¿®é¥°çš„å¯¹è±¡ä¼šåœ¨<code>dealloc</code>å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æ£€æµ‹æˆ–é”€æ¯è¯¥å¯¹è±¡ã€‚</li><li>å¯å˜å¯¹è±¡æ‹·è´ä¸€å®šä¼šç”Ÿæˆå·²æ–°å¯¹è±¡ï¼Œä¸å¯å˜å¯¹è±¡æ‹·è´æˆä¸å¯å˜å¯¹è±¡åˆ™æ˜¯å¼•ç”¨è®¡æ•°+1ã€‚</li><li>ä¼˜åŒ–çš„æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆï¼Œä¸ç”¨èµ°<code>objc_msgSend()</code>çš„æ¶ˆæ¯æµç¨‹ä»è€Œæé«˜æ€§èƒ½ã€‚</li><li><code>CADisplayLink</code>å’Œ<code>Timer</code>æœ¬è´¨æ˜¯åŠ åˆ°<code>loop</code>å¾ªç¯å½“ä¸­ï¼Œä¾é™„äºå¾ªç¯ï¼Œæ²¡æœ‰<code>runloop</code>ï¼Œåˆ™ä¸èƒ½æ­£ç¡®æ‰§è¡Œï¼Œä½¿ç”¨<code>runloop</code>éœ€è¦æ³¨æ„å¾ªç¯å¼•ç”¨å’Œ<code>runloop</code>æ‰€åœ¨çš„çº¿ç¨‹çš„é‡Šæ”¾é—®é¢˜ã€‚</li></ul><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ul><li><span class="exturl" data-url="aHR0cDovL2Jsb2cuc3Vubnl4eC5jb20vMjAxNC8xMC8xNS9iZWhpbmQtYXV0b3JlbGVhc2Uv" title="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/">é»‘å¹•èƒŒåçš„Autorelease<i class="fa fa-external-link"></i></span></li><li>å°ç å“¥è§†é¢‘</li><li>iOSå’ŒOSå¤šçº¿ç¨‹ä¸å†…å­˜ç®¡ç†</li><li>iOSå’ŒmacOSæ€§èƒ½ä¼˜åŒ–<h3 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h3></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½git<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code git<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9vYmpjNC03NTA=" title="https://github.com/ifgyong/demo/tree/master/OC/objc4-750">runtimeå¯è¿è¡Œçš„æºç git<i class="fa fa-external-link"></i></span></li></ul><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p><p>å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;çœ‹å®Œæœ¬æ–‡ç« ä½ å°†äº†è§£åˆ°&lt;/p&gt;
&lt;blockquote&gt;
&lt;ol&gt;
&lt;li&gt;DisplayLinkå’Œtimerçš„ä½¿ç”¨å’ŒåŸç†&lt;/li&gt;
&lt;li&gt;å†…å­˜åˆ†é…å’Œå†…å­˜ç®¡ç†&lt;/li&gt;
&lt;li&gt;è‡ªåŠ¨é‡Šæ”¾æ± åŸç†&lt;/li&gt;
&lt;li&gt;weakæŒ‡é’ˆåŸç†å’Œé‡Šæ”¾æ—¶æœº&lt;/li&gt;
&lt;li&gt;å¼•ç”¨è®¡æ•°åŸç†&lt;/
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç†  å¤šçº¿ç¨‹ä¹‹å®‰å…¨é”ä»¥åŠå¸¸ç”¨çš„è¯»å†™é” --(11)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E5%AE%89%E5%85%A8%E9%94%81%E4%BB%A5%E5%8F%8A%E5%B8%B8%E7%94%A8%E7%9A%84%E8%AF%BB%E5%86%99%E9%94%81%20--(11)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8B%E5%AE%89%E5%85%A8%E9%94%81%E4%BB%A5%E5%8F%8A%E5%B8%B8%E7%94%A8%E7%9A%84%E8%AF%BB%E5%86%99%E9%94%81%20--(11)/</id>
    <published>2019-12-01T03:21:58.000Z</published>
    <updated>2020-09-04T04:40:21.661Z</updated>
    
    <content type="html"><![CDATA[<p>åªè¦æåˆ°äº†å¤šçº¿ç¨‹å°±åº”è¯¥æƒ³åˆ°çº¿ç¨‹å®‰å…¨ï¼Œé‚£ä¹ˆæ€ä¹ˆåšæ‰èƒ½åšåˆ°åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ä¿è¯å®‰å…¨å‘¢ï¼Ÿ<br>è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è§£çº¿ç¨‹å®‰å…¨ã€‚</p><h3 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h3><p>çº¿ç¨‹å®‰å…¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ‘˜æŠ„ä¸€æ®µ<span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS8lRTclQkElQkYlRTclQTglOEIlRTUlQUUlODklRTUlODUlQTgvOTc0NzcyND9mcj1hbGFkZGlu" title="https://baike.baidu.com/item/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/9747724?fr=aladdin">ç™¾åº¦ç™¾ç§‘<i class="fa fa-external-link"></i></span>çš„ä¸€æ®µè¯</p><blockquote><p>çº¿ç¨‹å®‰å…¨æ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹æ—¶çš„è®¡ç®—æœºç¨‹åºä»£ç ä¸­çš„ä¸€ä¸ªæ¦‚å¿µã€‚åœ¨æ‹¥æœ‰å…±äº«æ•°æ®çš„å¤šæ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œçš„ç¨‹åºä¸­ï¼Œçº¿ç¨‹å®‰å…¨çš„ä»£ç ä¼šé€šè¿‡åŒæ­¥æœºåˆ¶ä¿è¯å„ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æ­£å¸¸ä¸”æ­£ç¡®çš„æ‰§è¡Œï¼Œä¸ä¼šå‡ºç°æ•°æ®æ±¡æŸ“ç­‰æ„å¤–æƒ…å†µã€‚</p></blockquote><h4 id="ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹å®‰å…¨"><a href="#ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹å®‰å…¨" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹å®‰å…¨"></a>ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹å®‰å…¨</h4><p>ATMè‚¯å®šç”¨è¿‡ï¼Œä½ è¦æ˜¯è¾¹å–é’±ï¼Œè¾¹å­˜é’±ï¼Œä¼šå‡ºé—®é¢˜å—ï¼Ÿå½“ä½ å–é’±çš„æ—¶å€™ï¼Œæ­£åœ¨å–ï¼Œç»“æœæœ‰äººæ±‡æ¬¾æ­£å¥½åˆ°è´¦ï¼Œæœ¬æ¥1000å—å–äº†100å‰©ä¸‹900ï¼Œç»“æœåˆ°è´¦200ï¼Œ1000+200=1200ï¼Œå› ä¸ºä½ å–çš„æ—¶å€™ï¼Œè¿˜æ²¡å–å®Œï¼Œæ±‡æ¬¾åˆ°è´¦äº†ç»“æœæ•°å­—åˆåŠ ä¸Šå»äº†ã€‚ä½ å–çš„é’±è·‘å“ªé‡Œå»äº†ï¼Œè¿™é‡Œå°±éœ€è¦å–é’±çš„æ—¶å€™ä¸èƒ½å†™å…¥æ•°æ®ï¼Œå°±æ˜¯æ±‡æ¬¾éœ€è¦åœ¨ä½ å–é’±å®Œæˆä¹‹åå†æ±‡æ¬¾ï¼Œä¸èƒ½åŒæ—¶è¿›è¡Œã€‚</p><p>é‚£ä¹ˆåœ¨iOSä¸­ï¼Œé”æ˜¯å¦‚ä½•ä½¿ç”¨çš„å‘¢ï¼Ÿ</p><h3 id="è‡ªæ—‹é”-OS-SPINLOCK"><a href="#è‡ªæ—‹é”-OS-SPINLOCK" class="headerlink" title="è‡ªæ—‹é” OS_SPINLOCK"></a>è‡ªæ—‹é” OS_SPINLOCK</h3><h4 id="ä»€ä¹ˆæ˜¯ä¼˜å…ˆçº§åè½¬"><a href="#ä»€ä¹ˆæ˜¯ä¼˜å…ˆçº§åè½¬" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¼˜å…ˆçº§åè½¬"></a>ä»€ä¹ˆæ˜¯ä¼˜å…ˆçº§åè½¬</h4><p>ç®€å•ä»å­—é¢ä¸Šæ¥è¯´ï¼Œå°±æ˜¯ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡å…ˆäºé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æ‰§è¡Œäº†ï¼Œä¼˜å…ˆçº§æåäº†ã€‚é‚£åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šç”Ÿè¿™ç§æƒ…å†µå‘¢ï¼Ÿ</p><p>å‡è®¾ä¸‰ä¸ªä»»åŠ¡å‡†å¤‡æ‰§è¡Œï¼ŒAï¼ŒBï¼ŒCï¼Œä¼˜å…ˆçº§ä¾æ¬¡æ˜¯A&gt;B&gt;Cï¼›</p><p>é¦–å…ˆï¼šCå¤„äºè¿è¡ŒçŠ¶æ€ï¼Œè·å¾—CPUæ­£åœ¨æ‰§è¡Œï¼ŒåŒæ—¶å æœ‰äº†æŸç§èµ„æºï¼›</p><p>å…¶æ¬¡ï¼šAè¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œå› ä¸ºä¼˜å…ˆçº§æ¯”Cé«˜ï¼Œæ‰€ä»¥è·å¾—CPUï¼ŒAè½¬ä¸ºè¿è¡ŒçŠ¶æ€ï¼›Cè¿›å…¥å°±ç»ªçŠ¶æ€ï¼›</p><p>ç¬¬ä¸‰ï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨èµ„æºï¼Œè€Œè¿™ä¸ªèµ„æºåˆè¢«ç­‰å¾…ä¸­çš„Cå æœ‰çš„ï¼Œäºæ˜¯Aè¿›å…¥é˜»å¡çŠ¶æ€ï¼ŒCå›åˆ°è¿è¡ŒçŠ¶æ€ï¼›</p><p>ç¬¬å››ï¼šæ­¤æ—¶Bè¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œå› ä¸ºä¼˜å…ˆçº§æ¯”Cé«˜ï¼ŒBè·å¾—CPUï¼Œè¿›å…¥è¿è¡ŒçŠ¶æ€ï¼›Cåˆå›åˆ°å°±ç»ªçŠ¶æ€ï¼›</p><p>ç¬¬äº”ï¼šå¦‚æœè¿™æ—¶åˆå‡ºç°B2ï¼ŒB3ç­‰ä»»åŠ¡ï¼Œä»–ä»¬çš„ä¼˜å…ˆçº§æ¯”Cé«˜ï¼Œä½†æ¯”Aä½ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„Aä¸èƒ½æ‰§è¡Œï¼Œåè€Œä½ä¼˜å…ˆçº§çš„Bï¼ŒB2ï¼ŒB3ç­‰ä»»åŠ¡å¯ä»¥æ‰§è¡Œçš„å¥‡æ€ªç°è±¡ï¼Œè€Œè¿™å°±æ˜¯ä¼˜å…ˆåè½¬ã€‚</p><p><code>OS_SPINLOCK</code>å«åš<code>è‡ªæ—‹é”</code>ï¼Œç­‰å¾…é”çš„è¿›ç¨‹ä¼šå¤„äºå¿™ç­‰(busy-wait)çŠ¶æ€ï¼Œä¸€ç›´å ç”¨ç€CPUèµ„æºï¼Œç›®å‰å·²ç»ä¸å®‰å…¨ï¼Œå¯èƒ½ä¼šå‡ºç°ä¼˜å…ˆçº§ç¿»è½¬é—®é¢˜ã€‚</p><p><code>OS_SPINLOCK</code>API</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åˆå§‹åŒ– ä¸€èˆ¬æ˜¯0ï¼Œæˆ–è€…ç›´æ¥æ•°å­—0ä¹Ÿæ˜¯okçš„ã€‚</span><br><span class="line">#defineOS_SPINLOCK_INIT    0</span><br><span class="line">&#x2F;&#x2F;é”çš„åˆå§‹åŒ–</span><br><span class="line">OSSpinLock lock &#x3D; OS_SPINLOCK_INIT;</span><br><span class="line">&#x2F;&#x2F;å°è¯•åŠ é”</span><br><span class="line">bool ret &#x3D; OSSpinLockTry(&amp;lock);</span><br><span class="line">&#x2F;&#x2F;åŠ é”</span><br><span class="line">OSSpinLockLock(&amp;lock);</span><br><span class="line">&#x2F;&#x2F;è§£é”</span><br><span class="line">OSSpinLockUnlock(&amp;lock);</span><br></pre></td></tr></table></figure><p><code>OSSpinLock</code>ç®€å•å®ç°12306å¦‚ä½•å–ç¥¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åŸºç±»å®ç°çš„å–ç¥¨</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">    NSInteger oldCount &#x3D; self.ticketsCount;</span><br><span class="line">if (isLog) &#123;</span><br><span class="line">sleep(sleepTime);</span><br><span class="line">&#125;</span><br><span class="line">    oldCount --;</span><br><span class="line">    self.ticketsCount &#x3D; oldCount;</span><br><span class="line">if (isLog) &#123;</span><br><span class="line">printf(&quot;è¿˜å‰©% 2ld å¼ ç¥¨ - %s \n&quot;,(long)oldCount,[NSThread currentThread].description.UTF8String);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)ticketTest&#123;</span><br><span class="line">    self.ticketsCount &#x3D; 10000;</span><br><span class="line">NSInteger count &#x3D; self.ticketsCount&#x2F;3;</span><br><span class="line">dispatch_queue_t queue &#x3D; dispatch_queue_create(&quot;tick.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    dispatch_async(queue, ^&#123;</span><br><span class="line">if (time1 &#x3D;&#x3D; 0) &#123;</span><br><span class="line">time1 &#x3D; CFAbsoluteTimeGetCurrent();</span><br><span class="line">&#125;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; count; i ++) &#123;</span><br><span class="line">            [self __saleTicket];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_async(queue, ^&#123;</span><br><span class="line">if (time1 &#x3D;&#x3D; 0) &#123;</span><br><span class="line">time1 &#x3D; CFAbsoluteTimeGetCurrent();</span><br><span class="line">&#125;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; count; i ++) &#123;</span><br><span class="line">            [self __saleTicket];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(queue, ^&#123;</span><br><span class="line">if (time1 &#x3D;&#x3D; 0) &#123;</span><br><span class="line">time1 &#x3D; CFAbsoluteTimeGetCurrent();</span><br><span class="line">&#125;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; count; i ++) &#123;</span><br><span class="line">            [self __saleTicket];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">dispatch_barrier_async(queue, ^&#123;</span><br><span class="line">CFAbsoluteTime time &#x3D; CFAbsoluteTimeGetCurrent() - time1;</span><br><span class="line">printf(&quot;tick cost time:%f&quot;,time);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__getMonery&#123;</span><br><span class="line">    OSSpinLockLock(&amp;_moneyLock);</span><br><span class="line">    [super __getMonery];</span><br><span class="line">    OSSpinLockUnlock(&amp;_moneyLock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">    OSSpinLockLock(&amp;_moneyLock);</span><br><span class="line">    [super __saleTicket];</span><br><span class="line">    OSSpinLockUnlock(&amp;_moneyLock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saveMonery&#123;</span><br><span class="line">    OSSpinLockLock(&amp;_moneyLock);</span><br><span class="line">    [super __saveMonery];</span><br><span class="line">    OSSpinLockUnlock(&amp;_moneyLock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">    NSInteger oldCount &#x3D; self.ticketsCount;</span><br><span class="line">    oldCount --;</span><br><span class="line">    self.ticketsCount &#x3D; oldCount;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x600003dc6080&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x600003dc6080&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x600003dc6080&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x600003df3a00&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x600003df3a00&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x600003df3a00&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x600003dc0000&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x600003dc0000&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x600003dc0000&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125;</span><br></pre></td></tr></table></figure><h4 id="æ±‡ç¼–åˆ†æ"><a href="#æ±‡ç¼–åˆ†æ" class="headerlink" title="æ±‡ç¼–åˆ†æ"></a>æ±‡ç¼–åˆ†æ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">for (NSInteger i &#x3D; 0; i &lt; 5; i ++) &#123;</span><br><span class="line">[[[NSThread alloc]initWithTarget:self selector:@selector(__saleTicket) object:nil] start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ç„¶åå°†ç¡çœ æ—¶é—´è®¾ç½®ä¸º600sï¼Œæ–¹ä¾¿æˆ‘ä»¬è°ƒè¯•ã€‚</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">    OSSpinLockLock(&amp;_moneyLock);&#x2F;&#x2F;æ­¤è¡Œæ‰“æ–­ç‚¹</span><br><span class="line">    [super __saleTicket];</span><br><span class="line">    OSSpinLockUnlock(&amp;_moneyLock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°äº†æ–­ç‚¹è¿›å…¥<code>Debug-&gt;Debug WorkFlow -&gt;Always Show Disassembly</code>ï¼Œåˆ°äº†æ±‡ç¼–ç•Œé¢ï¼Œåœ¨<code>LLDB</code>è¾“å…¥<code>stepi</code>ï¼Œç„¶åä¸€ç›´æŒ‰<code>enter</code>ï¼Œä¸€ç›´é‡å¤æ‰§è¡Œä¸Šå¥å‘½ä»¤ï¼Œç›´åˆ°è¿›å…¥äº†å¾ªç¯ï¼Œå°±æ˜¯ç±»ä¼¼ä¸‹åˆ—çš„ä¸‰è¡Œï¼Œå‘ç°<code>ja</code>è·³è½¬åˆ°åœ°å€<code>0x103f3d0f9</code>ï¼Œæ¯æ¬¡æ‰§è¡Œåˆ°<code>ja</code>æ€»æ˜¯è·³è½¬åˆ°<code>0x103f3d0f9</code>ï¼Œç›´åˆ°çº¿ç¨‹ç¡çœ ç»“æŸã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  0x103f3d0f9 &lt;+241&gt;: movq   %rcx, (%r8)</span><br><span class="line">0x103f3d0fc &lt;+244&gt;: addq   $0x8, %r8</span><br><span class="line">0x103f3d100 &lt;+248&gt;: cmpq   %r8, %r9</span><br><span class="line">0x103f3d103 &lt;+251&gt;: ja     0x103f3d0f9</span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡æ±‡ç¼–åˆ†æäº†è§£åˆ°<code>è‡ªæ—‹é”</code>æ˜¯çœŸçš„<code>å¿™ç­‰</code>ï¼Œé—²ä¸ä½çš„é”ã€‚</p><h3 id="os-unfair-lock"><a href="#os-unfair-lock" class="headerlink" title="os_unfair_lock"></a>os_unfair_lock</h3><p><code>os_unfair_lock</code>è¢«ç³»ç»Ÿå®šä¹‰ä¸ºä½çº§é”ï¼Œä¸€èˆ¬ä½çº§é”éƒ½æ˜¯é—²çš„æ—¶å€™åœ¨ç¡çœ ï¼Œåœ¨ç­‰å¾…çš„æ—¶å€™è¢«å†…æ ¸å”¤é†’ï¼Œç›®çš„æ˜¯æ›¿æ¢å·²å¼ƒç”¨çš„<code>OSSpinLock</code>ï¼Œè€Œä¸”å¿…é¡»ä½¿ç”¨<code>OS_UNFAIR_LOCK_INIT</code>æ¥åˆå§‹åŒ–ï¼ŒåŠ é”å’Œè§£é”å¿…é¡»åœ¨ç›¸åŒçš„çº¿ç¨‹ï¼Œå¦åˆ™ä¼šä¸­æ–­è¿›ç¨‹ï¼Œä½¿ç”¨è¯¥é”éœ€è¦ç³»ç»Ÿåœ¨<code>__IOS_AVAILABLE(10.0)</code>ï¼Œé”çš„æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªç»“æ„ä½“</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OS_UNFAIR_LOCK_AVAILABILITY</span><br><span class="line">typedef struct os_unfair_lock_s &#123;</span><br><span class="line">uint32_t _os_unfair_lock_opaque;</span><br><span class="line">&#125; os_unfair_lock, *os_unfair_lock_t;</span><br></pre></td></tr></table></figure><p><code>os_unfair_lock</code>ä½¿ç”¨éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨ä»»åŠ¡å‰åŠ é”ï¼Œä»»åŠ¡åè§£é”å³å¯ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@interface FYOSUnfairLockDemo : FYBaseDemo</span><br><span class="line">@property (nonatomic,assign) os_unfair_lock lock;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYOSUnfairLockDemo</span><br><span class="line">- (instancetype)init&#123;</span><br><span class="line">if (self &#x3D; [super init]) &#123;</span><br><span class="line">self.lock &#x3D; OS_UNFAIR_LOCK_INIT;</span><br><span class="line">&#125;</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)__saveMonery&#123;</span><br><span class="line">os_unfair_lock_lock(&amp;_unlock);</span><br><span class="line">[super __saveMonery];</span><br><span class="line">os_unfair_lock_unlock(&amp;_unlock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__getMonery&#123;</span><br><span class="line">os_unfair_lock_lock(&amp;_unlock);</span><br><span class="line">[super __getMonery];</span><br><span class="line">os_unfair_lock_unlock(&amp;_unlock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">os_unfair_lock_lock(&amp;_unlock);</span><br><span class="line">[super __saleTicket];</span><br><span class="line">os_unfair_lock_unlock(&amp;_unlock);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x600002eb4bc0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x600002eb4bc0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x600002eb4bc0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x600002eb1500&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x600002eb1500&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x600002eb1500&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x600002ed4340&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x600002ed4340&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x600002ed4340&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125;</span><br></pre></td></tr></table></figure><h4 id="æ±‡ç¼–åˆ†æ-1"><a href="#æ±‡ç¼–åˆ†æ-1" class="headerlink" title="æ±‡ç¼–åˆ†æ"></a>æ±‡ç¼–åˆ†æ</h4><p><code>LLDB</code> ä¸­å‘½ä»¤<code>stepi</code>é‡åˆ°å‡½æ•°ä¼šè¿›å…¥åˆ°å‡½æ•°ï¼Œ<code>nexti</code>ä¼šè·³è¿‡å‡½æ•°ã€‚æˆ‘ä»¬å°†æ–­ç‚¹æ‰“åˆ°æ·»åŠ é”çš„ä½ç½®</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (void)__saleTicket&#123;</span><br><span class="line"> os_unfair_lock_lock(&amp;_unlock);&#x2F;&#x2F;æ–­ç‚¹ä½ç½®</span><br><span class="line">[super __saleTicket];</span><br><span class="line">os_unfair_lock_unlock(&amp;_unlock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>si</code>,ä¸€ç›´<code>enter</code>ï¼Œæœ€ç»ˆæ˜¯åœæ­¢è¯¥ä½å­ï¼Œæ¨¡æ‹Ÿå™¨ç¼ºè·³å‡ºæ¥äº†ï¼Œå†<code>enter</code>ä¹Ÿæ²¡ç”¨äº†ï¼Œå› ä¸ºçº¿ç¨‹åœ¨ç¡çœ äº†ã€‚<code>syscall</code>æ˜¯è°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„å‘½ä»¤ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">libsystem_kernel.dylib&#96;__ulock_wait:</span><br><span class="line">    0x107a3b9d4 &lt;+0&gt;:  movl   $0x2000203, %eax          ; imm &#x3D; 0x2000203 </span><br><span class="line">    0x107a3b9d9 &lt;+5&gt;:  movq   %rcx, %r10</span><br><span class="line">-&gt;  0x107a3b9dc &lt;+8&gt;:  syscall</span><br></pre></td></tr></table></figure><h3 id="äº’æ–¥é”-pthread-mutex-t"><a href="#äº’æ–¥é”-pthread-mutex-t" class="headerlink" title="äº’æ–¥é” pthread_mutex_t"></a>äº’æ–¥é” pthread_mutex_t</h3><p><code>mutex</code>å«äº’æ–¥é”ï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¼šå¤„äºä¼‘çœ çŠ¶æ€ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">-(void)dealloc&#123;</span><br><span class="line">pthread_mutex_destroy(&amp;_plock);</span><br><span class="line">pthread_mutexattr_destroy(&amp;t);</span><br><span class="line">&#125;</span><br><span class="line">-(instancetype)init&#123;</span><br><span class="line">if (self &#x3D;[super init]) &#123;</span><br><span class="line">&#x2F;&#x2F;åˆå§‹åŒ–é”çš„å±æ€§ </span><br><span class="line">&#x2F;&#x2F;pthread_mutexattr_init(&amp;t);</span><br><span class="line">&#x2F;&#x2F;pthread_mutexattr_settype(&amp;t, PTHREAD_MUTEX_NORMAL);</span><br><span class="line">&#x2F;&#x2F;&#x2F;&#x2F;åˆå§‹åŒ–é”</span><br><span class="line">&#x2F;&#x2F;pthread_mutex_init(&amp;_plock, &amp;t);</span><br><span class="line"></span><br><span class="line">pthread_mutex_t plock &#x3D; PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line">self.plock &#x3D; plock;</span><br><span class="line">&#125;</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line">-(void)__saleTicket&#123;</span><br><span class="line">pthread_mutex_lock(&amp;_plock);</span><br><span class="line">[super __saleTicket];</span><br><span class="line">pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__getMonery&#123;</span><br><span class="line">pthread_mutex_lock(&amp;_plock);</span><br><span class="line">[super __getMonery];</span><br><span class="line">pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saveMonery&#123;</span><br><span class="line">pthread_mutex_lock(&amp;_plock);</span><br><span class="line">[super __saveMonery];</span><br><span class="line">pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x6000014e3600&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8d80&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8f40&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8f40&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8f40&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8d80&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x6000014e3600&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8d80&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x6000014e3600&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125;</span><br></pre></td></tr></table></figure><p>äº’æ–¥é”æœ‰ä¸‰ä¸ªç±»å‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line"> * Mutex type attributes</span><br><span class="line"> *&#x2F;</span><br><span class="line"> æ™®é€šé”</span><br><span class="line">#define PTHREAD_MUTEX_NORMAL0</span><br><span class="line">&#x2F;&#x2F;æ£€æŸ¥é”™è¯¯</span><br><span class="line">#define PTHREAD_MUTEX_ERRORCHECK1</span><br><span class="line">&#x2F;&#x2F;é€’å½’é”</span><br><span class="line">#define PTHREAD_MUTEX_RECURSIVE2</span><br><span class="line">&#x2F;&#x2F;æ™®é€šé”</span><br><span class="line">#define PTHREAD_MUTEX_DEFAULTPTHREAD_MUTEX_NORMAL</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬è¿™æ ·å­å‡½æ•°è°ƒç”¨å‡½æ•°ä¼šå‡ºç°æ­»é”çš„é—®é¢˜ï¼Œè¿™æ˜¯æ€ä¹ˆå‡ºç°çš„å‘¢ï¼Ÿç¬¬ä¸€æŠŠé”æ˜¯é”ä½çŠ¶æ€ï¼Œç„¶åè¿›å…¥ç¬¬äºŒä¸ªå‡½æ•°ï¼Œé”åœ¨é”ä½çŠ¶æ€ï¼Œåœ¨ç­‰å¾…ï¼Œä½†æ˜¯è¿™æŠŠé”éœ€è¦å‘åæ‰§è¡Œæ‰ä¼šè§£é”ï¼Œåˆ°æ—¶æ— é™æœŸçš„ç­‰å¾…ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (void)otherTest&#123;</span><br><span class="line">pthread_mutex_lock(&amp;_plock);</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">[self otherTest2];</span><br><span class="line">pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)otherTest2&#123;</span><br><span class="line">pthread_mutex_lock(&amp;_plock);</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">-[FYPthread_mutex2 otherTest]</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªéœ€æ±‚éœ€è¦ä½¿ç”¨ä¸¤æŠŠé”ï¼Œæˆ–è€…ä½¿ç”¨é€’å½’é”æ¥è§£å†³é—®é¢˜ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (void)otherTest&#123;</span><br><span class="line">pthread_mutex_lock(&amp;_plock);</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">[self otherTest2];</span><br><span class="line">pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)otherTest2&#123;</span><br><span class="line">pthread_mutex_lock(&amp;_plock2);</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">pthread_mutex_unlock(&amp;_plock2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">-[FYPthread_mutex2 otherTest]</span><br><span class="line">-[FYPthread_mutex2 otherTest2]</span><br></pre></td></tr></table></figure><p>ä»ä½¿ç”¨2æŠŠé”æ˜¯å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚<br>é€’å½’é”æ˜¯ä»€ä¹ˆé”å‘¢ï¼Ÿå…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€æŠŠé”é‡å¤åŠ é”ã€‚</p><h3 id="NSLockã€NSRecursiveLosk"><a href="#NSLockã€NSRecursiveLosk" class="headerlink" title="NSLockã€NSRecursiveLosk"></a>NSLockã€NSRecursiveLosk</h3><p><code>NSLock</code>æ˜¯å¯¹<code>mutex</code>æ™®é€šé”çš„å°è£…</p><p>ä½¿ç”¨<code>(LLDB) si</code>å¯ä»¥è·Ÿè¸ª<code>[myLock lock];</code>çš„å†…éƒ¨å‡½æ•°æœ€ç»ˆæ˜¯<code>pthread_mutex_lock</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Foundation&#96;-[NSLock lock]:</span><br><span class="line">    0x1090dfb5a &lt;+0&gt;:  pushq  %rbp</span><br><span class="line">    0x1090dfb5b &lt;+1&gt;:  movq   %rsp, %rbp</span><br><span class="line">    0x1090dfb5e &lt;+4&gt;:  callq  0x1092ca3fe               ; symbol stub for: object_getIndexedIvars</span><br><span class="line">    0x1090dfb63 &lt;+9&gt;:  movq   %rax, %rdi</span><br><span class="line">    0x1090dfb66 &lt;+12&gt;: popq   %rbp</span><br><span class="line">-&gt;  0x1090dfb67 &lt;+13&gt;: jmp    0x1092ca596   ;</span><br><span class="line">&#x2F;&#x2F;  symbol stub for: pthread_mutex_lock</span><br></pre></td></tr></table></figure><p><code>NSLock API</code>å¤§å…¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åè®®NSLocking</span><br><span class="line">@protocol NSLocking</span><br><span class="line"></span><br><span class="line">- (void)lock;</span><br><span class="line">- (void)unlock;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface NSLock : NSObject &lt;NSLocking&gt; &#123;</span><br><span class="line">@private</span><br><span class="line">    void *_priv;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)tryLock;&#x2F;&#x2F;å°è¯•åŠ é”</span><br><span class="line">- (BOOL)lockBeforeDate:(NSDate *)limit;&#x2F;&#x2F;åœ¨æŸä¸ªæ—¥æœŸå‰åŠ é”ï¼Œ</span><br><span class="line">@property (nullable, copy) NSString *name API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>ç”¨æ³•ä¹Ÿå¾ˆç®€å•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@interface FYNSLock()&#123;</span><br><span class="line">NSLock *_lock;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYNSLock</span><br><span class="line">- (instancetype)init&#123;</span><br><span class="line">if (self &#x3D; [super init]) &#123;</span><br><span class="line">&#x2F;&#x2F;å°è£…äº†mutexçš„æ™®é€šé”</span><br><span class="line">_lock&#x3D;[[NSLock alloc]init];</span><br><span class="line">&#125;</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)__saveMonery&#123;</span><br><span class="line">[_lock lock];</span><br><span class="line">[super __saveMonery];</span><br><span class="line">[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">[_lock lock];</span><br><span class="line">[super __saleTicket];</span><br><span class="line">[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">- (void)__getMonery&#123;</span><br><span class="line">[_lock lock];</span><br><span class="line">[super __getMonery];</span><br><span class="line">[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x600003d4dc40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x600003d4dc40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x600003d4dc40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x600003d7bfc0&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x600003d7bfc0&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x600003d7bfc0&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x600003d66c00&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x600003d66c00&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x600003d66c00&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125;</span><br></pre></td></tr></table></figure><p><code>NSRecursiveLock</code>ä¹Ÿæ˜¯å¯¹<code>mutexé€’å½’é”</code>çš„å°è£…ï¼Œ<code>API</code>è·Ÿ<code>NSLock</code>åŸºæœ¬ä¸€è‡´</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)tryLock;&#x2F;&#x2F;å°è¯•åŠ é”</span><br><span class="line">- (BOOL)lockBeforeDate:(NSDate *)limit;&#x2F;&#x2F;æ—¥æœŸå‰åŠ é”</span><br></pre></td></tr></table></figure><p>é€’å½’é”å¯ä»¥å¯¹ç›¸åŒçš„çº¿ç¨‹è¿›è¡Œåå¤åŠ é”</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@implementation FYRecursiveLockDemo</span><br><span class="line">- (instancetype)init&#123;</span><br><span class="line">if (self &#x3D; [super init]) &#123;</span><br><span class="line">&#x2F;&#x2F;å°è£…äº†mutexçš„é€’å½’é”</span><br><span class="line">_lock&#x3D;[[NSRecursiveLock alloc]init];</span><br><span class="line">&#125;</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)otherTest&#123;</span><br><span class="line">static int count &#x3D; 10;</span><br><span class="line">[_lock lock];</span><br><span class="line">while (count &gt; 0) &#123;</span><br><span class="line">count -&#x3D; 1;</span><br><span class="line">printf(&quot;å¾ªç¯% 2dæ¬¡ - %s \n&quot;,count,[NSThread currentThread].description.UTF8String);</span><br><span class="line">[self otherTest];</span><br><span class="line">&#125;</span><br><span class="line">[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">å¾ªç¯ 9æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; </span><br><span class="line">å¾ªç¯ 8æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; </span><br><span class="line">å¾ªç¯ 7æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; </span><br><span class="line">å¾ªç¯ 6æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; </span><br><span class="line">å¾ªç¯ 5æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; </span><br><span class="line">å¾ªç¯ 4æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; </span><br><span class="line">å¾ªç¯ 3æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; </span><br><span class="line">å¾ªç¯ 2æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; </span><br><span class="line">å¾ªç¯ 1æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; </span><br><span class="line">å¾ªç¯ 0æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125;</span><br></pre></td></tr></table></figure><h3 id="NSCondition-æ¡ä»¶"><a href="#NSCondition-æ¡ä»¶" class="headerlink" title="NSCondition æ¡ä»¶"></a>NSCondition æ¡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (void)wait;&#x2F;&#x2F;ç­‰å¾…</span><br><span class="line">- (BOOL)waitUntilDate:(NSDate *)limit;</span><br><span class="line">- (void)signal;&#x2F;&#x2F;å”¤é†’ä¸€ä¸ªçº¿ç¨‹</span><br><span class="line">- (void)broadcast;&#x2F;&#x2F;å”¤é†’å¤šä¸ªçº¿ç¨‹</span><br></pre></td></tr></table></figure><p><code>NSCondition</code>æ˜¯å¯¹<code>mutex</code>å’Œ<code>cond</code>çš„å°è£…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)init&#123;</span><br><span class="line">if (self &#x3D; [super init]) &#123;</span><br><span class="line">&#x2F;&#x2F;éµå®ˆçš„ lockåè®® çš„ æ¡ä»¶ğŸ”</span><br><span class="line">_lock&#x3D;[[NSCondition alloc]init];</span><br><span class="line">self.array &#x3D;[NSMutableArray array];</span><br><span class="line">&#125;</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)otherTest&#123;</span><br><span class="line">[[[NSThread alloc]initWithTarget:self selector:@selector(__remove) object:nil] start];</span><br><span class="line">[[[NSThread alloc]initWithTarget:self selector:@selector(__add) object:nil] start];</span><br><span class="line">&#125;</span><br><span class="line">- (void)__add&#123;</span><br><span class="line">[_lock lock];</span><br><span class="line">[self.array addObject:@&quot;Test&quot;];</span><br><span class="line">NSLog(@&quot;æ·»åŠ æˆåŠŸ&quot;);</span><br><span class="line">sleep(1);</span><br><span class="line">[_lock signal];&#x2F;&#x2F;å”¤é†’ä¸€ä¸ªçº¿ç¨‹</span><br><span class="line">[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">- (void)__remove&#123;</span><br><span class="line">[_lock lock];</span><br><span class="line">if (self.array.count &#x3D;&#x3D; 0) &#123;</span><br><span class="line">[_lock wait];</span><br><span class="line">&#125;</span><br><span class="line">[self.array removeLastObject];</span><br><span class="line">NSLog(@&quot;åˆ é™¤æˆåŠŸ&quot;);</span><br><span class="line"></span><br><span class="line">[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">&#x2F;&#x2F;Log</span><br><span class="line"></span><br><span class="line">2019-07-29 10:06:48.904648+0800 day16--çº¿ç¨‹å®‰å…¨[43603:4402260] æ·»åŠ æˆåŠŸ</span><br><span class="line">2019-07-29 10:06:49.907641+0800 day16--çº¿ç¨‹å®‰å…¨[43603:4402259] åˆ é™¤æˆåŠŸ</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ—¶é—´ä¸Šå·®äº†1ç§’ï¼Œæ­£å¥½æ˜¯æˆ‘ä»¬è®¾å®šçš„<code>sleep(1);</code>ã€‚ä¼˜ç‚¹æ˜¯å¯ä»¥è®©çº¿ç¨‹ä¹‹é—´å½¢æˆä¾èµ–ï¼Œç¼ºç‚¹æ˜¯æ²¡æœ‰æ˜ç¡®çš„æ¡ä»¶ã€‚</p><h3 id="NSConditionLock-å¯ä»¥å®ç°çº¿ç¨‹ä¾èµ–çš„é”"><a href="#NSConditionLock-å¯ä»¥å®ç°çº¿ç¨‹ä¾èµ–çš„é”" class="headerlink" title="NSConditionLock å¯ä»¥å®ç°çº¿ç¨‹ä¾èµ–çš„é”"></a>NSConditionLock å¯ä»¥å®ç°çº¿ç¨‹ä¾èµ–çš„é”</h3><p><code>NSConditionLock</code>æ˜¯å¯ä»¥å®ç°å¤šä¸ªå­çº¿ç¨‹è¿›è¡Œçº¿ç¨‹é—´çš„ä¾èµ–ï¼ŒAä¾èµ–äºBæ‰§è¡Œå®Œæˆï¼ŒBä¾èµ–äºCæ‰§è¡Œå®Œæ¯•åˆ™å¯ä»¥ä½¿ç”¨<code>NSConditionLock</code>æ¥è§£å†³é—®é¢˜ã€‚<br>é¦–å…ˆçœ‹ä¸‹<code>API</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@property (readonly) NSInteger condition;&#x2F;&#x2F;æ¡ä»¶å€¼</span><br><span class="line">- (void)lockWhenCondition:(NSInteger)condition;&#x2F;&#x2F;å½“conä¸ºconditionè¿›è¡Œé”ä½</span><br><span class="line">&#x2F;&#x2F;å°è¯•åŠ é”</span><br><span class="line">- (BOOL)tryLock;</span><br><span class="line">&#x2F;&#x2F;å½“conä¸ºconditionè¿›è¡Œå°è¯•é”ä½</span><br><span class="line">- (BOOL)tryLockWhenCondition:(NSInteger)condition;</span><br><span class="line">&#x2F;&#x2F;å½“conä¸ºconditionè¿›è¡Œè§£é”</span><br><span class="line">- (void)unlockWithCondition:(NSInteger)condition;</span><br><span class="line">&#x2F;&#x2F;NSDate å°ä½™ limitè¿›è¡Œ åŠ é”</span><br><span class="line">- (BOOL)lockBeforeDate:(NSDate *)limit;</span><br><span class="line">&#x2F;&#x2F;æ¡ä»¶ä¸ºcondition åœ¨limitä¹‹å‰è¿›è¡ŒåŠ é”</span><br><span class="line">- (BOOL)lockWhenCondition:(NSInteger)condition beforeDate:(NSDate *)limit;</span><br></pre></td></tr></table></figure><p>æ¡ä»¶é”çš„ä½¿ç”¨ï¼Œåœ¨<code>lockWhenCondition:(NSInteger)condition</code>çš„æ¡ä»¶åˆ°è¾¾çš„æ—¶å€™æ‰èƒ½è¿›è¡Œæ­£å¸¸çš„åŠ é”å’Œ<code>unlockWithCondition:(NSInteger)condition</code>è§£é”ï¼Œå¦åˆ™ä¼šé˜»å¡çº¿ç¨‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- (void)otherTest&#123;</span><br><span class="line">[[[NSThread alloc]initWithTarget:self selector:@selector(__test2) object:nil] start];</span><br><span class="line">[[[NSThread alloc]initWithTarget:self selector:@selector(__test1) object:nil] start];</span><br><span class="line">[[[NSThread alloc]initWithTarget:self selector:@selector(__test3) object:nil] start];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">- (void)__test1&#123;</span><br><span class="line">[_lock lockWhenCondition:1];</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">[_lock unlockWithCondition:2];&#x2F;&#x2F;è§£é” å¹¶èµ‹å€¼2</span><br><span class="line">&#125;</span><br><span class="line">- (void)__test2&#123;</span><br><span class="line">[_lock lockWhenCondition:2];</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">[_lock unlockWithCondition:3];&#x2F;&#x2F;è§£é” å¹¶èµ‹å€¼3</span><br><span class="line">&#125;</span><br><span class="line">- (void)__test3&#123;</span><br><span class="line">[_lock lockWhenCondition:3];</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">[_lock unlockWithCondition:4];&#x2F;&#x2F;è§£é” å¹¶èµ‹å€¼4</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">-[FYCondLockDemo2 __test1]</span><br><span class="line">-[FYCondLockDemo2 __test2]</span><br><span class="line">-[FYCondLockDemo2 __test3]</span><br></pre></td></tr></table></figure><p>å½“<code>con = 1</code>è¿›è¡Œ<code>test1</code>åŠ é”å’Œæ‰§è¡Œä»»åŠ¡<code>A</code>ï¼Œä»»åŠ¡<code>A</code>æ‰§è¡Œå®Œæ¯•ï¼Œè¿›è¡Œè§£é”ï¼Œå¹¶æŠŠå€¼2èµ‹å€¼ç»™<code>lock</code>ï¼Œè¿™æ˜¯å½“<code>con = 2</code>çš„é”å¼€å§‹åŠ é”ï¼Œè¿›å…¥ä»»åŠ¡<code>B</code>ï¼Œå¼€å§‹æ‰§è¡Œä»»åŠ¡<code>B</code>ï¼Œå½“ä»»åŠ¡<code>B</code>æ‰§è¡Œå®Œæ¯•ï¼Œè¿›è¡Œè§£é”å¹¶èµ‹å€¼ä¸º3ï¼Œç„¶å<code>con=3</code>çš„é”è¿›è¡ŒåŠ é”ï¼Œè§£é”å¹¶èµ‹å€¼4æ¥è¿›è¡Œçº¿ç¨‹ä¹‹é—´çš„ä¾èµ–ã€‚</p><h3 id="dispatch-queue-ç‰¹æ®Šçš„é”"><a href="#dispatch-queue-ç‰¹æ®Šçš„é”" class="headerlink" title="dispatch_queue ç‰¹æ®Šçš„é”"></a>dispatch_queue ç‰¹æ®Šçš„é”</h3><p>å…¶å®ç›´æ¥ä½¿ç”¨GCDçš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œä¹Ÿæ˜¯å¯ä»¥å®ç°çº¿ç¨‹åŒæ­¥çš„ã€‚ä¸²è¡Œé˜Ÿåˆ—å…¶å®å°±æ˜¯çº¿ç¨‹çš„ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­æŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œè¾¾åˆ°äº†é”çš„ç›®çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@interface FYSerialQueueDemo()&#123;</span><br><span class="line">dispatch_queue_t _queue;</span><br><span class="line">&#125;@end</span><br><span class="line">@implementation FYSerialQueueDemo</span><br><span class="line">- (instancetype)init&#123;</span><br><span class="line">if (self &#x3D;[super init]) &#123;</span><br><span class="line">_queue &#x3D; dispatch_queue_create(&quot;fyserial.queue&quot;, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">&#125;</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">dispatch_sync(_queue, ^&#123;</span><br><span class="line">[super __saleTicket];</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__getMonery&#123;</span><br><span class="line">dispatch_sync(_queue, ^&#123;</span><br><span class="line">[super __getMonery];</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saveMonery&#123;</span><br><span class="line">dispatch_sync(_queue, ^&#123;</span><br><span class="line">[super __saveMonery];</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x600001211b40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x600001243700&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x60000121dd80&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x600001211b40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x600001243700&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x60000121dd80&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x600001211b40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x600001243700&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x60000121dd80&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125;</span><br></pre></td></tr></table></figure><h3 id="dispatch-semaphore-ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡"><a href="#dispatch-semaphore-ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡" class="headerlink" title="dispatch_semaphore ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡"></a>dispatch_semaphore ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡</h3><p>å½“æˆ‘ä»¬æœ‰å¤§é‡ä»»åŠ¡éœ€è¦å¹¶å‘æ‰§è¡Œï¼Œè€Œä¸”åŒæ—¶æœ€å¤§å¹¶å‘é‡ä¸º5ä¸ªçº¿ç¨‹ï¼Œè¿™æ ·å­åˆè¯¥å¦‚ä½•æ§åˆ¶å‘¢ï¼Ÿ<code>dispatch_semaphore</code>ä¿¡å·é‡æ­£å¥½å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚<br><code>dispatch_semaphore</code>å¯ä»¥æ§åˆ¶å¹¶å‘çº¿ç¨‹çš„æ•°é‡ï¼Œå½“è®¾ç½®ä¸º1æ—¶ï¼Œå¯ä»¥ä½œä¸ºåŒæ­¥é”æ¥ç”¨ï¼Œè®¾ç½®å¤šä¸ªçš„æ—¶å€™ï¼Œå°±æ˜¯å¼‚æ­¥å¹¶å‘é˜Ÿåˆ—ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åˆå§‹åŒ–ä¿¡å·é‡ å€¼ä¸º2ï¼Œå°±æ˜¯æœ€å¤šå…è®¸åŒæ—¶2ä¸ªçº¿ç¨‹æ‰§è¡Œ</span><br><span class="line">_semaphore &#x3D; dispatch_semaphore_create(2);</span><br><span class="line">&#x2F;&#x2F;ç”Ÿæˆå¤šä¸ªçº¿ç¨‹è¿›è¡Œå¹¶å‘è®¿é—®test</span><br><span class="line">- (void)otherTest&#123;</span><br><span class="line">for (int i &#x3D; 0; i &lt; 10; i ++) &#123;</span><br><span class="line">[[[NSThread alloc]initWithTarget:self selector:@selector(test) object:nil]start];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)test&#123;</span><br><span class="line">&#x2F;&#x2F;å¦‚æœä¿¡å·é‡&gt;0 ï¼Œè®©ä¿¡å·é‡-1ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚</span><br><span class="line">&#x2F;&#x2F;å¦‚æœä¿¡å·é‡ &lt;&#x3D; 0;å°±ä¼šç­‰å¾…ï¼Œç­‰å¾…æ—¶é—´æ˜¯ DISPATCH_TIME_FOREVER</span><br><span class="line">dispatch_semaphore_wait(_semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">sleep(2);&#x2F;&#x2F;ç¡çœ æ—¶é—´2s</span><br><span class="line">NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">&#x2F;&#x2F;é‡Šæ”¾ä¸€ä¸ªä¿¡å·é‡</span><br><span class="line">dispatch_semaphore_signal(_semaphore);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">2019-07-29 11:17:53.233318+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529610] &lt;NSThread: 0x600002c45240&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-29 11:17:53.233329+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529609] &lt;NSThread: 0x600002c45200&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-29 11:17:55.233879+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529616] &lt;NSThread: 0x600002c45540&gt;&#123;number &#x3D; 10, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-29 11:17:55.233879+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529612] &lt;NSThread: 0x600002c45440&gt;&#123;number &#x3D; 6, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-29 11:17:57.238860+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529613] &lt;NSThread: 0x600002c45480&gt;&#123;number &#x3D; 7, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-29 11:17:57.238867+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529614] &lt;NSThread: 0x600002c454c0&gt;&#123;number &#x3D; 8, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-29 11:17:59.241352+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529615] &lt;NSThread: 0x600002c45500&gt;&#123;number &#x3D; 9, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-29 11:17:59.241324+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529611] &lt;NSThread: 0x600002c45400&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-29 11:18:01.245790+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529618] &lt;NSThread: 0x600002c455c0&gt;&#123;number &#x3D; 12, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-29 11:18:01.245790+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529617] &lt;NSThread: 0x600002c45580&gt;&#123;number &#x3D; 11, name &#x3D; (null)&#125;</span><br></pre></td></tr></table></figure><p>ä¸€æ¬¡æœ€å¤š2ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä»»åŠ¡ï¼Œæš‚åœæ—¶é—´æ˜¯2sã€‚<br>ä½¿ç”¨ä¿¡å·é‡å®ç°çº¿ç¨‹æœ€å¤§å¹¶å‘é”ï¼Œ<br>åŒæ—¶åªæœ‰2ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)init&#123;</span><br><span class="line">if (self &#x3D;[super init]) &#123;</span><br><span class="line">_semaphore &#x3D; dispatch_semaphore_create(1);</span><br><span class="line">&#125;</span><br><span class="line">return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">dispatch_semaphore_wait(_semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">[super __saleTicket];</span><br><span class="line">dispatch_semaphore_signal(_semaphore);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0c00&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0dc0&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x6000022ce880&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0c00&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0dc0&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x6000022ce880&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0c00&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0dc0&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x6000022ce880&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125;</span><br></pre></td></tr></table></figure><h3 id="synchronized"><a href="#synchronized" class="headerlink" title="@synchronized"></a>@synchronized</h3><p><code>@synchronized(id obj){}</code>é”çš„æ˜¯å¯¹è±¡<code>obj</code>ï¼Œä½¿ç”¨è¯¥é”çš„æ—¶å€™ï¼Œåº•å±‚æ˜¯å¯¹è±¡è®¡ç®—å‡ºæ¥çš„å€¼ä½œä¸º<code>key</code>ï¼Œç”Ÿæˆä¸€æŠŠé”ï¼Œä¸åŒçš„èµ„æºçš„è¯»å†™å¯ä»¥ä½¿ç”¨ä¸åŒ<code>obj</code>ä½œä¸ºé”å¯¹è±¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">@synchronized (self) &#123;</span><br><span class="line">[super __saleTicket];</span><br><span class="line">&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#x2F;&#x2F;log</span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x60000057d5c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x60000056f340&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x60000057d500&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x60000057d5c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x60000056f340&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x60000057d500&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x60000057d5c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x60000056f340&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x60000057d500&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125;</span><br></pre></td></tr></table></figure><h3 id="atmoic-åŸå­æ“ä½œ"><a href="#atmoic-åŸå­æ“ä½œ" class="headerlink" title="atmoic åŸå­æ“ä½œ"></a>atmoic åŸå­æ“ä½œ</h3><p>ç»™å±æ€§æ·»åŠ <code>atmoic</code>ä¿®é¥°ï¼Œå¯ä»¥ä¿è¯å±æ€§çš„<code>setter</code>å’Œ<code>getter</code>éƒ½æ˜¯åŸå­æ€§æ“ä½œï¼Œä¹Ÿå°±ä¿è¯äº†<code>setter</code>å’Œ<code>getter</code>çš„å†…éƒ¨æ˜¯çº¿ç¨‹åŒæ­¥çš„ã€‚<br>åŸå­æ“ä½œæ˜¯æœ€ç»ˆè°ƒç”¨äº†<code>static inline void reallySetProperty(id self, SEL _cmd, id newValue, ptrdiff_t offset, bool atomic, bool copy, bool mutableCopy) objc-accessors.mm 48è¡Œ</code>ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°å‡½æ•°å†…éƒ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;è®¾ç½®å±æ€§åŸå­æ“ä½œ</span><br><span class="line">void objc_setProperty_atomic(id self, SEL _cmd, id newValue, ptrdiff_t offset)</span><br><span class="line">&#123;</span><br><span class="line">    reallySetProperty(self, _cmd, newValue, offset, true, false, false);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;éåŸå­æ“ä½œè®¾ç½®å±æ€§</span><br><span class="line">void objc_setProperty_nonatomic(id self, SEL _cmd, id newValue, ptrdiff_t offset)</span><br><span class="line">&#123;</span><br><span class="line">    reallySetProperty(self, _cmd, newValue, offset, false, false, false);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void reallySetProperty(id self, SEL _cmd, id newValue, ptrdiff_t offset, bool atomic, bool copy, bool mutableCopy)</span><br><span class="line">&#123;&#x2F;&#x2F;åç§»é‡ç­‰äº0åˆ™æ˜¯classæŒ‡é’ˆ</span><br><span class="line">    if (offset &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        object_setClass(self, newValue);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F;å…¶ä»–çš„value</span><br><span class="line">    id oldValue;</span><br><span class="line">    id *slot &#x3D; (id*) ((char*)self + offset);</span><br><span class="line"></span><br><span class="line">    if (copy) &#123;</span><br><span class="line">    &#x2F;&#x2F;å¦‚æœæ˜¯copy ç”¨copyWithZone:</span><br><span class="line">        newValue &#x3D; [newValue copyWithZone:nil];</span><br><span class="line">    &#125; else if (mutableCopy) &#123;</span><br><span class="line">        &#x2F;&#x2F;mutableCopyåˆ™è°ƒç”¨mutableCopyWithZone:</span><br><span class="line">        newValue &#x3D; [newValue mutableCopyWithZone:nil];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    &#x2F;&#x2F;å¦‚æœèµ‹å€¼å’ŒåŸæ¥çš„ç›¸ç­‰ åˆ™ä¸æ“ä½œ</span><br><span class="line">        if (*slot &#x3D;&#x3D; newValue) return;</span><br><span class="line">        newValue &#x3D; objc_retain(newValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!atomic) &#123;&#x2F;&#x2F;éåŸå­æ“ä½œ ç›´æ¥èµ‹å€¼</span><br><span class="line">        oldValue &#x3D; *slot;</span><br><span class="line">        *slot &#x3D; newValue;</span><br><span class="line">    &#125; else &#123;&#x2F;&#x2F;åŸå­æ“ä½œ åŠ é”</span><br><span class="line">    &#x2F;&#x2F;é”å’Œå±æ€§æ˜¯ä¸€ä¸€å¯¹åº”çš„-&gt;è‡ªæ—‹é”</span><br><span class="line">        spinlock_t&amp; slotlock &#x3D; PropertyLocks[slot];</span><br><span class="line">        slotlock.lock();</span><br><span class="line">        oldValue &#x3D; *slot;</span><br><span class="line">        *slot &#x3D; newValue;&#x2F;&#x2F;èµ‹å€¼</span><br><span class="line">        slotlock.unlock();&#x2F;&#x2F;è§£é”</span><br><span class="line">    &#125;</span><br><span class="line">    objc_release(oldValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">id objc_getProperty(id self, SEL _cmd, ptrdiff_t offset, BOOL atomic) &#123;</span><br><span class="line">    if (offset &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        return object_getClass(self);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Retain release world</span><br><span class="line">    id *slot &#x3D; (id*) ((char*)self + offset);</span><br><span class="line">    if (!atomic) return *slot;&#x2F;&#x2F;éåŸå­æ“ä½œ ç›´æ¥è¿”å›å€¼</span><br><span class="line">        </span><br><span class="line">    &#x2F;&#x2F; Atomic retain release world</span><br><span class="line">&#x2F;&#x2F;åŸå­æ“ä½œ åŠ é”-&gt;è‡ªæ—‹é”</span><br><span class="line">    spinlock_t&amp; slotlock &#x3D; PropertyLocks[slot];</span><br><span class="line">    slotlock.lock();&#x2F;&#x2F;åŠ é”</span><br><span class="line">    id value &#x3D; objc_retain(*slot);</span><br><span class="line">    slotlock.unlock();&#x2F;&#x2F;è§£é”</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; for performance, we (safely) issue the autorelease OUTSIDE of the spinlock.</span><br><span class="line">    return objc_autoreleaseReturnValue(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ä»¥å±æ€§çš„åœ°å€ä¸ºå‚æ•°è®¡ç®—å‡ºkey ï¼Œé”ä¸ºvalue</span><br><span class="line">StripedMap&lt;spinlock_t&gt; PropertyLocks;</span><br></pre></td></tr></table></figure><p>ä»æºç äº†è§£åˆ°è®¾ç½®å±æ€§è¯»å–æ˜¯<code>self</code>+å±æ€§çš„åç§»é‡ï¼Œå½“<code>copy</code>æˆ–<code>mutableCopy</code>ä¼šè°ƒç”¨åˆ°<code>[newValue copyWithZone:nil]</code>æˆ–<code>[newValue mutableCopyWithZone:nil]</code>ï¼Œå¦‚æœæ–°æ—§å€¼ç›¸ç­‰åˆ™ä¸è¿›è¡Œæ“ä½œï¼ŒéåŸå­æ“ä½œç›´æ¥èµ‹å€¼ï¼ŒåŸå­æ“ä½œåˆ™è·å–<code>spinlock_t&amp; slotlock = PropertyLocks[slot]</code>è¿›è¡ŒåŠ é”ã€èµ‹å€¼ã€è§£é”æ“ä½œã€‚è€Œä¸”<code>PropertyLocks</code>æ˜¯ä¸€ä¸ªç±»ï¼Œç±»æœ‰ä¸€ä¸ªæ•°ç»„å±æ€§ï¼Œä½¿ç”¨<code>*p</code>è®¡ç®—å‡ºæ¥çš„å€¼ä½œä¸º<code>key</code>ã€‚</p><p>æˆ‘ä»¬æå–å‡ºæ¥å…³é”®ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åŸå­æ“ä½œ åŠ é”</span><br><span class="line">spinlock_t&amp; slotlock &#x3D; PropertyLocks[slot];</span><br><span class="line">slotlock.lock();</span><br><span class="line">oldValue &#x3D; *slot;</span><br><span class="line">*slot &#x3D; newValue;&#x2F;&#x2F;èµ‹å€¼</span><br><span class="line">slotlock.unlock();&#x2F;&#x2F;è§£é”</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨è‡ªæ—‹é”å¯¹èµ‹å€¼æ“ä½œè¿›è¡ŒåŠ é”ï¼Œä¿è¯äº†<code>setter()</code>æ–¹æ³•çš„å®‰å…¨æ€§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åŸå­æ“ä½œ åŠ é” -&gt;è‡ªæ—‹é”</span><br><span class="line">spinlock_t&amp; slotlock &#x3D; PropertyLocks[slot];</span><br><span class="line">slotlock.lock();&#x2F;&#x2F;åŠ é”</span><br><span class="line">id value &#x3D; objc_retain(*slot);</span><br><span class="line">slotlock.unlock();&#x2F;&#x2F;è§£é”</span><br></pre></td></tr></table></figure><p>å–å€¼ä¹‹å‰è¿›è¡ŒåŠ é”ï¼Œå–å€¼ä¹‹åè¿›è¡Œè§£é”ï¼Œä¿è¯äº†<code>getter()</code>æ–¹æ³•çš„å®‰å…¨ã€‚</p><p>ç”±ä¸Šé¢å¾—çŸ¥<code>atmoic</code>ä»…ä»…æ˜¯å¯¹æ–¹æ³•<code>setter()</code>å’Œ<code>getter()</code>å®‰å…¨ï¼Œå¯¹æˆå‘˜å˜é‡ä¸ä¿è¯å®‰å…¨ï¼Œå¯¹äºå±æ€§çš„è¯»å†™ä¸€èˆ¬ä½¿ç”¨<code>nonatomic</code>ï¼Œæ€§èƒ½å¥½ï¼Œ<code>atomic</code>è¯»å–é¢‘ç‡é«˜çš„æ—¶å€™ä¼šå¯¼è‡´çº¿ç¨‹éƒ½åœ¨æ’é˜Ÿï¼Œæµªè´¹CPUæ—¶é—´ã€‚</p><p>å¤§æ¦‚ä½¿ç”¨è€…å‡ ç§é”åˆ†åˆ«å¯¹å–ç¥¨åŠŸèƒ½è¿›è¡Œäº†æ€§èƒ½æµ‹è¯•ï¼Œ<br>æ€§èƒ½åˆ†åˆ«1ä¸‡æ¬¡ã€100ä¸‡æ¬¡ã€1000ä¸‡æ¬¡é”èŠ±è´¹çš„æ—¶é—´å¯¹æ¯”ï¼Œå•ä½æ˜¯ç§’ã€‚(ä»…ä¾›å‚è€ƒï¼Œä¸åŒç¯å¢ƒæ—¶é—´ç•¥æœ‰å·®å¼‚)</p><table><thead><tr><th style="text-align:center">é”ç±»å‹</th><th style="text-align:center">1ä¸‡æ¬¡</th><th style="text-align:center">100ä¸‡æ¬¡</th><th style="text-align:center">1000ä¸‡æ¬¡</th></tr></thead><tbody><tr><td style="text-align:center">pthread_mutex_t</td><td style="text-align:center">0.000309</td><td style="text-align:center">0.027238</td><td style="text-align:center">0.284714</td></tr><tr><td style="text-align:center">os_unfair_lock</td><td style="text-align:center">0.000274</td><td style="text-align:center">0.028266</td><td style="text-align:center">0.285685</td></tr><tr><td style="text-align:center">OSSpinLock</td><td style="text-align:center">0.030688</td><td style="text-align:center">0.410067</td><td style="text-align:center">0.437702</td></tr><tr><td style="text-align:center">NSCondition</td><td style="text-align:center">0.005067</td><td style="text-align:center">0.323492</td><td style="text-align:center">1.078636</td></tr><tr><td style="text-align:center">NSLock</td><td style="text-align:center">0.038692</td><td style="text-align:center">0.151601</td><td style="text-align:center">1.322062</td></tr><tr><td style="text-align:center">NSRecursiveLock</td><td style="text-align:center">0.007973</td><td style="text-align:center">0.151601</td><td style="text-align:center">1.673409</td></tr><tr><td style="text-align:center">@synchronized</td><td style="text-align:center">0.008953</td><td style="text-align:center">0.640234</td><td style="text-align:center">2.790291</td></tr><tr><td style="text-align:center">NSConditionLock</td><td style="text-align:center">0.229148</td><td style="text-align:center">5.325272</td><td style="text-align:center">10.681123</td></tr><tr><td style="text-align:center">semaphore</td><td style="text-align:center">0.094267</td><td style="text-align:center">0.415351</td><td style="text-align:center">24.699100</td></tr><tr><td style="text-align:center">SerialQueue</td><td style="text-align:center">0.213386</td><td style="text-align:center">9.058581</td><td style="text-align:center">50.820202</td></tr></tbody></table><h3 id="å»ºè®®"><a href="#å»ºè®®" class="headerlink" title="å»ºè®®"></a>å»ºè®®</h3><p>å¹³æ—¶æˆ‘ä»¬ç®€å•ä½¿ç”¨çš„è¯æ²¡æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œè¿˜æ˜¯æ¨èä½¿ç”¨<code>NSLock</code>å’Œä¿¡å·é‡,æœ€ç®€å•çš„æ˜¯<code>@synchronized</code>ï¼Œä¸ç”¨å£°æ˜å’Œåˆå§‹åŒ–ï¼Œç›´æ¥æ‹¿æ¥å°±ç”¨ã€‚</p><h3 id="è‡ªæ—‹é”ã€äº’æ–¥é”æ¯”è¾ƒ"><a href="#è‡ªæ—‹é”ã€äº’æ–¥é”æ¯”è¾ƒ" class="headerlink" title="è‡ªæ—‹é”ã€äº’æ–¥é”æ¯”è¾ƒ"></a>è‡ªæ—‹é”ã€äº’æ–¥é”æ¯”è¾ƒ</h3><p>è‡ªæ—‹é”å’Œäº’æ–¥é”å„æœ‰ä¼˜åŠ£ï¼Œä»£ç æ‰§è¡Œé¢‘ç‡é«˜ï¼ŒCPUå……è¶³ï¼Œå¯ä»¥ä½¿ç”¨äº’æ–¥é”ï¼Œé¢‘ç‡ä½ï¼Œä»£ç å¤æ‚åˆ™éœ€è¦äº’æ–¥é”ã€‚</p><h4 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h4><ul><li>è‡ªæ—‹é”åœ¨ç­‰å¾…æ—¶é—´æ¯”è¾ƒçŸ­çš„æ—¶å€™æ¯”è¾ƒåˆé€‚</li><li>ä¸´ç•ŒåŒºä»£ç ç»å¸¸è¢«è°ƒç”¨ï¼Œä½†ç«äº‰å¾ˆå°‘å‘ç”Ÿ</li><li>CPUä¸ç´§å¼ </li><li>å¤šæ ¸å¤„ç†å™¨<h4 id="äº’æ–¥é”"><a href="#äº’æ–¥é”" class="headerlink" title="äº’æ–¥é”"></a>äº’æ–¥é”</h4></li><li>é¢„è®¡çº¿ç¨‹ç­‰å¾…æ—¶é—´æ¯”è¾ƒé•¿</li><li>å•æ ¸å¤„ç†å™¨</li><li>ä¸´ç•ŒåŒºIOæ“ä½œ</li><li>ä¸´ç•ŒåŒºä»£ç æ¯”è¾ƒå¤šã€å¤æ‚ï¼Œæˆ–è€…å¾ªç¯é‡å¤§</li><li>ä¸´ç•ŒåŒºç«äº‰éå¸¸æ¿€çƒˆ</li></ul><h2 id="é”çš„åº”ç”¨"><a href="#é”çš„åº”ç”¨" class="headerlink" title="é”çš„åº”ç”¨"></a>é”çš„åº”ç”¨</h2><h4 id="ç®€å•è¯»å†™é”"><a href="#ç®€å•è¯»å†™é”" class="headerlink" title="ç®€å•è¯»å†™é”"></a>ç®€å•è¯»å†™é”</h4><p>ä¸€ä¸ªç®€å•çš„è¯»å†™é”ï¼Œè¯»å†™äº’æ–¥å³å¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¿¡å·é‡ï¼Œå€¼è®¾å®šä¸º1.åŒæ—¶åªèƒ½ä¸€ä¸ªçº¿ç¨‹æ¥æ“ä½œæ–‡ä»¶,è¯»å†™äº’æ–¥ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">[super viewDidLoad];</span><br><span class="line">&#x2F;&#x2F; Do any additional setup after loading the view.</span><br><span class="line">self.semaphore &#x3D; dispatch_semaphore_create(1);</span><br><span class="line"></span><br><span class="line">for (NSInteger i &#x3D; 0; i &lt; 10; i ++) &#123;</span><br><span class="line">[[[NSThread alloc]initWithTarget:self selector:@selector(read) object:nil]start];</span><br><span class="line">[[[NSThread alloc]initWithTarget:self selector:@selector(write) object:nil]start];</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)read&#123;</span><br><span class="line">dispatch_semaphore_wait(self.semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">dispatch_semaphore_signal(self.semaphore);</span><br><span class="line">&#125;</span><br><span class="line">- (void)write&#123;</span><br><span class="line">dispatch_semaphore_wait(self.semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">dispatch_semaphore_signal(self.semaphore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“è¯»å†™éƒ½æ˜¯ä¸€ä¸ªçº¿ç¨‹æ¥æ“ä½œï¼Œä¼šé™ä½æ€§èƒ½ï¼Œå½“å¤šä¸ªçº¿ç¨‹åœ¨è¯»èµ„æºçš„æ—¶å€™ï¼Œå…¶å®ä¸éœ€è¦åŒæ­¥æ“ä½œçš„ï¼Œæœ‰è¯»æ²¡å†™ï¼Œç†è®ºä¸Šè¯´ä¸ç”¨é™åˆ¶å¼‚æ­¥æ•°é‡ï¼Œå†™å…¥çš„æ—¶å€™ä¸èƒ½è¯»ï¼Œæ‰æ˜¯çœŸæ­£é™åˆ¶çº¿ç¨‹æ€§èƒ½çš„åœ°æ–¹ï¼Œè¯»å†™é”å…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹</p><ol><li>åŒä¸€æ—¶é—´ï¼Œåªèƒ½æœ‰1ä¸ªçº¿ç¨‹è¿›è¡Œå†™æ“ä½œ</li><li>åŒä¸€æ—¶é—´ï¼Œå…è®¸æœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œè¯»çš„æ“ä½œ</li><li>åŒä¸€æ—¶é—´ï¼Œä¸å…è®¸è¯»å†™æ“ä½œåŒæ—¶è¿›è¡Œ</li></ol><p>å…¸å‹çš„<code>å¤šè¯»å•å†™</code>ï¼Œç»å¸¸ç”¨äºæ–‡ä»¶ç­‰æ•°æ®çš„è¯»å†™æ“ä½œï¼Œæˆ‘ä»¬å®ç°2ç§</p><h4 id="è¯»å†™é”-pthread-rwlock"><a href="#è¯»å†™é”-pthread-rwlock" class="headerlink" title="è¯»å†™é” pthread_rwlock"></a>è¯»å†™é” pthread_rwlock</h4><p>è¿™æ˜¯æœ‰cè¯­è¨€å°è£…çš„è¯»å†™é”</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åˆå§‹åŒ–è¯»å†™é”</span><br><span class="line">int pthread_rwlock_init(pthread_rwlock_t * __restrict,</span><br><span class="line">const pthread_rwlockattr_t * _Nullable __restrict)</span><br><span class="line">&#x2F;&#x2F;è¯»ä¸Šé”</span><br><span class="line">pthread_rwlock_rdlock(pthread_rwlock_t *)</span><br><span class="line">&#x2F;&#x2F;å°è¯•åŠ é”è¯»</span><br><span class="line">pthread_rwlock_tryrdlock(pthread_rwlock_t *)</span><br><span class="line">&#x2F;&#x2F;å°è¯•åŠ é”å†™</span><br><span class="line">int pthread_rwlock_trywrlock(pthread_rwlock_t *)</span><br><span class="line">&#x2F;&#x2F;å†™å…¥åŠ é”</span><br><span class="line">pthread_rwlock_wrlock(pthread_rwlock_t *)</span><br><span class="line">&#x2F;&#x2F;è§£é”</span><br><span class="line">pthread_rwlock_unlock(pthread_rwlock_t *)</span><br><span class="line">&#x2F;&#x2F;é”€æ¯é”å±æ€§</span><br><span class="line">pthread_rwlockattr_destroy(pthread_rwlockattr_t *)</span><br><span class="line">&#x2F;&#x2F;é”€æ¯é”</span><br><span class="line">pthread_rwlock_destroy(pthread_rwlock_t * )</span><br></pre></td></tr></table></figure><p><code>pthread_rwlock_t</code>ä½¿ç”¨å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨è¯»ä¹‹å‰ä½¿ç”¨<code>pthread_rwlock_rdlock</code>ï¼Œè¯»å®Œè§£é”<code>pthread_rwlock_unlock</code>,å†™å…¥å‰éœ€è¦åŠ é”<code>pthread_rwlock_wrlock</code>ï¼Œå†™å…¥å®Œæˆä¹‹åè§£é”<code>pthread_rwlock_unlock</code>ï¼Œä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†å¯ä»¥é€‰æ‹©é”€æ¯<code>pthread_rwlock_destroy</code>æˆ–è€…ç­‰å¾…ä¸‹æ¬¡ä½¿ç”¨ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic,assign) pthread_rwlock_t rwlock;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">pthread_rwlock_destroy(&amp;_rwlock);&#x2F;&#x2F;é”€æ¯é”</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;åˆå§‹åŒ–è¯»å†™é”</span><br><span class="line">pthread_rwlock_init(&amp;_rwlock, NULL);</span><br><span class="line"></span><br><span class="line">dispatch_queue_t queue &#x3D; dispatch_get_global_queue(0, 0);</span><br><span class="line">for (NSInteger i &#x3D; 0; i &lt; 5; i ++) &#123;</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">[[[NSThread alloc]initWithTarget:self selector:@selector(readPthreadRWLock) object:nil]start];</span><br><span class="line">[[[NSThread alloc]initWithTarget:self selector:@selector(writePthreadRWLock) object:nil]start];</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)readPthreadRWLock&#123;</span><br><span class="line">    pthread_rwlock_rdlock(&amp;_rwlock);</span><br><span class="line">    NSLog(@&quot;è¯»æ–‡ä»¶&quot;);</span><br><span class="line">    sleep(1);</span><br><span class="line">    pthread_rwlock_unlock(&amp;_rwlock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)writePthreadRWLock&#123;</span><br><span class="line">    pthread_rwlock_wrlock(&amp;_rwlock);</span><br><span class="line">    NSLog(@&quot; å†™å…¥æ–‡ä»¶&quot;);</span><br><span class="line">    sleep(1);</span><br><span class="line">    pthread_rwlock_unlock(&amp;_rwlock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-30 10:47:16 è¯»æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:16 è¯»æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:17 å†™å…¥æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:18 å†™å…¥æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:19 è¯»æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:19 è¯»æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:19 è¯»æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:20 å†™å…¥æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:21 å†™å…¥æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:22 å†™å…¥æ–‡ä»¶</span><br></pre></td></tr></table></figure><p>è¯»æ–‡ä»¶ä¼šå‡ºç°åŒä¸€ç§’è¯»å¤šæ¬¡ï¼Œå†™æ–‡ä»¶åŒä¸€ç§’åªæœ‰ä¸€ä¸ªã€‚</p><h4 id="å¼‚æ­¥æ …æ è°ƒç”¨-dispatch-barrier-async"><a href="#å¼‚æ­¥æ …æ è°ƒç”¨-dispatch-barrier-async" class="headerlink" title="å¼‚æ­¥æ …æ è°ƒç”¨ dispatch_barrier_async"></a>å¼‚æ­¥æ …æ è°ƒç”¨ dispatch_barrier_async</h4><p>æ …æ å¤§å®¶éƒ½è§è¿‡ï¼Œä¸ºäº†åˆ†å¼€ä¸€ä¸ªåœ°åŒºè€Œä½¿ç”¨çš„ï¼Œçº¿ç¨‹çš„æ …æ å‡½æ•°æ˜¯åˆ†å¼€ä»»åŠ¡çš„æ‰§è¡Œé¡ºåº</p><table><thead><tr><th style="text-align:center">æ“ä½œ</th><th style="text-align:center">ä»»åŠ¡</th><th style="text-align:center">ä»»åŠ¡</th><th style="text-align:center">ä»»åŠ¡</th></tr></thead><tbody><tr><td style="text-align:center">è¯»</td><td style="text-align:center">A</td><td style="text-align:center">B</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">è¯»</td><td style="text-align:center">A</td><td style="text-align:center">B</td><td style="text-align:center"></td></tr><tr><td style="text-align:center">å†™</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">C</td></tr><tr><td style="text-align:center">å†™</td><td style="text-align:center"></td><td style="text-align:center"></td><td style="text-align:center">C</td></tr><tr><td style="text-align:center">è¯»</td><td style="text-align:center">A</td><td style="text-align:center"></td><td style="text-align:center"></td></tr><tr><td style="text-align:center">è¯»</td><td style="text-align:center">A</td><td style="text-align:center">B</td></tr></tbody></table><p>è¿™ä¸ªå‡½æ•°ä¼ å…¥çš„å¹¶å‘é˜Ÿåˆ—å¿…é¡»æ˜¯é€šè¿‡<code>dispatch_queue_create</code>åˆ›å»ºï¼Œå¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªä¸²è¡Œçš„æˆ–è€…å…¨å±€å¹¶å‘é˜Ÿåˆ—ï¼Œè¿™ä¸ªå‡½æ•°ä¾¿ç­‰åŒäº<code>dispatch_async</code>çš„æ•ˆæœã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åˆå§‹åŒ– å¼‚æ­¥é˜Ÿåˆ—</span><br><span class="line">self.rwqueue &#x3D; dispatch_queue_create(&quot;rw.thread&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">dispatch_queue_t queue &#x3D; dispatch_get_global_queue(0, 0);</span><br><span class="line">for (NSInteger i &#x3D; 0; i &lt; 5; i ++) &#123;</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">[self readBarryier];</span><br><span class="line">[self readBarryier];</span><br><span class="line">[self readBarryier];</span><br><span class="line">[self writeBarrier];</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)readBarryier&#123;</span><br><span class="line">&#x2F;&#x2F;æ·»åŠ ä»»åŠ¡åˆ°rwqueue</span><br><span class="line">dispatch_async(self.rwqueue, ^&#123;</span><br><span class="line">NSLog(@&quot;è¯»æ–‡ä»¶ %@&quot;,[NSThread currentThread]);</span><br><span class="line">sleep(1);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)writeBarrier&#123;</span><br><span class="line">&#x2F;&#x2F;barrier_asyncæ·»åŠ ä»»åŠ¡åˆ°self.rwqueueä¸­</span><br><span class="line">dispatch_barrier_async(self.rwqueue, ^&#123;</span><br><span class="line">NSLog(@&quot;å†™å…¥æ–‡ä»¶ %@&quot;,[NSThread currentThread]);</span><br><span class="line">sleep(1);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">2019-07-30 11:16:53 è¯»æ–‡ä»¶ &lt;NSThread: 0x600001ae0740&gt;&#123;number &#x3D; 9, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-30 11:16:53 è¯»æ–‡ä»¶ &lt;NSThread: 0x600001ae8500&gt;&#123;number &#x3D; 10, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-30 11:16:53 è¯»æ–‡ä»¶ &lt;NSThread: 0x600001ae8040&gt;&#123;number &#x3D; 8, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-30 11:16:53 è¯»æ–‡ä»¶ &lt;NSThread: 0x600001ac3a80&gt;&#123;number &#x3D; 11, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-30 11:16:54 å†™å…¥æ–‡ä»¶&lt;NSThread: 0x600001ac3a80&gt;&#123;number &#x3D; 11, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-30 11:16:55 å†™å…¥æ–‡ä»¶&lt;NSThread: 0x600001ac3a80&gt;&#123;number &#x3D; 11, name &#x3D; (null)&#125;</span><br><span class="line">2019-07-30 11:16:56 å†™å…¥æ–‡ä»¶&lt;NSThread: 0x600001ac3a80&gt;&#123;number &#x3D; 11, name &#x3D; (null)&#125;</span><br></pre></td></tr></table></figure><p>è¯»æ–‡ä»¶ä¼šå‡ºç°åŒä¸€ç§’è¯»å¤šä¸ªï¼Œå†™æ–‡ä»¶åŒä¸€ç§’åªæœ‰ä¸€ä¸ªã€‚</p><p>è¯»å†™ä»»åŠ¡éƒ½æ·»åŠ åˆ°å¼‚æ­¥é˜Ÿåˆ—<code>rwqueue</code>ä¸­ï¼Œä½¿ç”¨æ …æ å‡½æ•°<code>dispatch_barrier_async</code>æ‹¦æˆªä¸€ä¸‹ï¼Œå®ç°è¯»å†™äº’æ–¥ï¼Œè¯»å¯ä»¥å¼‚æ­¥æ— é™è¯»ï¼Œå†™åªèƒ½ä¸€ä¸ªåŒæ­¥å†™çš„åŠŸèƒ½ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>æ™®é€šçº¿ç¨‹é”æœ¬è´¨å°±æ˜¯åŒæ­¥æ‰§è¡Œ</li><li><code>atomic</code>åŸå­æ“ä½œåªé™åˆ¶<code>setter</code>å’Œ<code>getter</code>æ–¹æ³•ï¼Œä¸é™åˆ¶æˆå‘˜å˜é‡</li><li>è¯»å†™é”é«˜æ€§èƒ½å¯ä»¥ä½¿ç”¨<code>pthread_rwlock_t</code>å’Œ<code>dispatch_barrier_async</code><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3></li><li><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ZseV9hc190YWRwb2xlL2FydGljbGUvZGV0YWlscy84NjQzNjE2MQ==" title="https://blog.csdn.net/Fly_as_tadpole/article/details/86436161">ä¼˜å…ˆçº§åè½¬<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81YTkwZGU2OGYyNjVkYTRlOWI1OTJiNDAjaGVhZGluZy0xNg==" title="https://juejin.im/post/5a90de68f265da4e9b592b40#heading-16">iOSå¤šçº¿ç¨‹ï¼šã€GCDã€è¯¦å°½æ€»ç»“<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cDovL3d3dy41MjBpdC5jb20venQvaW9zX21qLw==" title="http://www.520it.com/zt/ios_mj/">å°ç å“¥è§†é¢‘<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cDovL2F3YXlxdS4xMDI0dWwuY29tL2lvcy8yMDE4LzA1LzAyL2djZC0zLmh0bWw=" title="http://awayqu.1024ul.com/ios/2018/05/02/gcd-3.html">ä»»åŠ¡è°ƒåº¦<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscy9saWJkaXNwYXRjaC8=" title="https://opensource.apple.com/tarballs/libdispatch/">libdispatch<i class="fa fa-external-link"></i></span></li><li>iOSå’ŒOSå¤šçº¿ç¨‹ä¸å†…å­˜ç®¡ç†<h3 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h3></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½git<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code git<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9vYmpjNC03NTA=" title="https://github.com/ifgyong/demo/tree/master/OC/objc4-750">runtimeå¯è¿è¡Œçš„æºç git<i class="fa fa-external-link"></i></span></li></ul><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p><p>å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;åªè¦æåˆ°äº†å¤šçº¿ç¨‹å°±åº”è¯¥æƒ³åˆ°çº¿ç¨‹å®‰å…¨ï¼Œé‚£ä¹ˆæ€ä¹ˆåšæ‰èƒ½åšåˆ°åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ä¿è¯å®‰å…¨å‘¢ï¼Ÿ&lt;br&gt;è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è§£çº¿ç¨‹å®‰å…¨ã€‚&lt;/p&gt;
&lt;h3 id=&quot;çº¿ç¨‹å®‰å…¨&quot;&gt;&lt;a href=&quot;#çº¿ç¨‹å®‰å…¨&quot; class=&quot;headerlink&quot; title=&quot;çº¿ç¨‹å®‰å…¨&quot;&gt;&lt;/a&gt;çº¿ç¨‹å®‰å…¨&lt;/h3&gt;&lt;
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç†  å¤šçº¿ç¨‹ä¹‹GCDçœ‹æˆ‘å°±å¤Ÿäº† --(10)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BGCD%20%E7%9C%8B%E6%88%91%E5%B0%B1%E5%A4%9F%E4%BA%86%20--(10)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%E5%A4%9A%E7%BA%BF%E7%A8%8B%E4%B9%8BGCD%20%E7%9C%8B%E6%88%91%E5%B0%B1%E5%A4%9F%E4%BA%86%20--(10)/</id>
    <published>2019-12-01T03:20:58.000Z</published>
    <updated>2020-09-04T04:40:21.661Z</updated>
    
    <content type="html"><![CDATA[<p><code>RunLoop</code>å’Œçº¿ç¨‹çš„å…³ç³»ï¼Œä»¥åŠ<code>Thread</code>å¦‚ä½•ä¿æ´»å’Œæ§åˆ¶ç”Ÿå‘½å‘¨æœŸï¼Œä»Šå¤©æˆ‘ä»¬å†æ¢ç©¶ä¸‹å¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹<code>GCD</code>ï¼Œæ­å¼€è’™å¨œä¸½èçš„é¢çº±ã€‚</p><h3 id="GCD-åŸºç¡€çŸ¥è¯†"><a href="#GCD-åŸºç¡€çŸ¥è¯†" class="headerlink" title="GCD åŸºç¡€çŸ¥è¯†"></a>GCD åŸºç¡€çŸ¥è¯†</h3><p>GCDæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¼•ç”¨<span class="exturl" data-url="aHR0cHM6Ly9iYWlrZS5iYWlkdS5jb20vaXRlbS9HQ0Q=" title="https://baike.baidu.com/item/GCD">ç™¾åº¦ç™¾ç§‘<i class="fa fa-external-link"></i></span>çš„ä¸€æ®µè¯ã€‚</p><blockquote><p>Grand Central Dispatch (GCD)æ˜¯Appleå¼€å‘çš„ä¸€ä¸ªå¤šæ ¸ç¼–ç¨‹çš„è¾ƒæ–°çš„è§£å†³æ–¹æ³•ã€‚å®ƒä¸»è¦ç”¨äºä¼˜åŒ–åº”ç”¨ç¨‹åºä»¥æ”¯æŒå¤šæ ¸å¤„ç†å™¨ä»¥åŠå…¶ä»–å¯¹ç§°å¤šå¤„ç†ç³»ç»Ÿã€‚å®ƒæ˜¯ä¸€ä¸ªåœ¨çº¿ç¨‹æ± æ¨¡å¼çš„åŸºç¡€ä¸Šæ‰§è¡Œçš„å¹¶è¡Œä»»åŠ¡ã€‚åœ¨Mac OS X 10.6é›ªè±¹ä¸­é¦–æ¬¡æ¨å‡ºï¼Œä¹Ÿå¯åœ¨IOS 4åŠä»¥ä¸Šç‰ˆæœ¬ä½¿ç”¨ã€‚</p></blockquote><p>GCDæœ‰å“ªäº›ä¼˜ç‚¹</p><ul><li>GCDè‡ªåŠ¨ç®¡ç†çº¿ç¨‹</li><li>å¼€å‘è€…åªéœ€è¦å°†taskåŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œä¸ç”¨å…³æ³¨ç»†èŠ‚ï¼Œç„¶åå°†taskæ‰§è¡Œå®Œçš„blockä¼ å…¥å³å¯</li><li>GCD è‡ªåŠ¨ç®¡ç†çº¿ç¨‹ï¼Œçº¿ç¨‹åˆ›å»ºï¼ŒæŒ‚èµ·ï¼Œé”€æ¯ã€‚</li></ul><p>é‚£ä¹ˆæˆ‘ä»¬ç ”ç©¶ä¸‹å¦‚ä½•æ›´å¥½çš„ä½¿ç”¨GCDï¼Œé¦–å…ˆè¦äº†è§£åˆ°ä¸²è¡Œé˜Ÿåˆ—ã€å¹¶è¡Œé˜Ÿåˆ—ã€å¹¶å‘</p><h4 id="ä¸²è¡Œé˜Ÿåˆ—"><a href="#ä¸²è¡Œé˜Ÿåˆ—" class="headerlink" title="ä¸²è¡Œé˜Ÿåˆ—"></a>ä¸²è¡Œé˜Ÿåˆ—</h4><p>ä¸²è¡Œæ˜¯åŸºäºé˜Ÿåˆ—çš„ï¼Œé˜Ÿåˆ—ä¼šè‡ªå·±æ§åˆ¶çº¿ç¨‹ï¼Œåœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸­ï¼Œä»»åŠ¡ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªï¼Œæ‰§è¡Œå®Œå½“å‰ä»»åŠ¡æ‰èƒ½ç»§ç»­æ‰§è¡Œä¸‹ä¸ªä»»åŠ¡ã€‚</p><h4 id="å¹¶è¡Œé˜Ÿåˆ—"><a href="#å¹¶è¡Œé˜Ÿåˆ—" class="headerlink" title="å¹¶è¡Œé˜Ÿåˆ—"></a>å¹¶è¡Œé˜Ÿåˆ—</h4><p>å¹¶è¡Œæœ‰é€šè¿‡æ–°å»ºçº¿ç¨‹æ¥å®ç°å¹¶å‘æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶è¡Œé˜Ÿåˆ—ä¸­åŒæ—¶æ˜¯å¯èƒ½æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œå½“å¹¶è¡Œæ•°é‡æ²¡æœ‰é™åˆ¶çš„æ—¶å€™ï¼Œç†è®ºä¸Šæ‰€æœ‰ä»»åŠ¡å¯ä»¥åŒæ—¶æ‰§è¡Œã€‚</p><h4 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h4><p>å¹¶å‘æ˜¯åŸºäºçº¿ç¨‹çš„ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹åªèƒ½ä¸²è¡Œ(åŒä¸€æ—¶åˆ»)æ‰§è¡Œï¼Œè¦æƒ³å®ç°å¹¶å‘ï¼Œåªèƒ½å¤šä¸ªçº¿ç¨‹ä¸€èµ·å¹²æ´»</p><p><strong>ä¸²è¡Œé˜Ÿåˆ—</strong>ç›¸å½“äºå·¥å‚1æ¡æµæ°´çº¿4ä¸ªå·¥äººç”Ÿäº§è®¾å¤‡ï¼Œä»å¼€å§‹åˆ°ç»“æŸï¼Œä¸€ä¸ªäººåªèƒ½å¹²ä¸€ä»¶äº‹ï¼Œç”²åšAä¸åšBã€‚</p><p><strong>å¹¶è¡Œé˜Ÿåˆ—</strong>æ˜¯ä¸€æ¡æµæ°´çº¿4ä¸ªå·¥äººï¼Œå½“å·¥äººå¹²æ´»é€Ÿåº¦ä¸å¤Ÿçš„æ—¶å€™å¯ä»¥å†ç”³è¯·ä¸€æ¡æµæ°´çº¿ï¼Œå®ç°ä¸¤æ¡æµæ°´çº¿åŒæ—¶å¹²æ´»ï¼Œè¿™å°±å®ç°äº†å¹¶å‘ã€‚</p><p><strong>å¹¶å‘</strong>æ˜¯å¤šä¸ªæµæ°´çº¿åœ¨åŒæ—¶åŠ å·¥äº§å“ã€‚</p><h4 id="GCDä¸­çš„ä¸²è¡Œé˜Ÿåˆ—"><a href="#GCDä¸­çš„ä¸²è¡Œé˜Ÿåˆ—" class="headerlink" title="GCDä¸­çš„ä¸²è¡Œé˜Ÿåˆ—()"></a>GCDä¸­çš„ä¸²è¡Œé˜Ÿåˆ—()</h4><h5 id="ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial-Dispatch-Queueï¼‰ï¼š"><a href="#ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial-Dispatch-Queueï¼‰ï¼š" class="headerlink" title="ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial Dispatch Queueï¼‰ï¼š"></a>ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial Dispatch Queueï¼‰ï¼š</h5><p>æŒ‰ç…§<strong>FIFO</strong>(First In First Outå…ˆè¿›å…ˆå‡º)åŸåˆ™ï¼Œå…ˆæ·»åŠ çš„ä»»åŠ¡åœ¨é˜Ÿé¦–ï¼Œåæ·»åŠ çš„ä»»åŠ¡åœ¨é˜Ÿå°¾ï¼Œæ‰§è¡Œä»»åŠ¡çš„æ—¶å€™æŒ‰ç…§é˜Ÿåˆ—çš„ä»é¦–åˆ°å°¾ä¸€ä¸ªæŒ¨ç€ä¸€ä¸ªæ‰§è¡Œï¼Œä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä¸å…·å¤‡å¼€è¾Ÿæ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚</p><p><img src="/images/10-1.png" alt></p><h5 id="å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent-Dispatch-Queueï¼‰ï¼š"><a href="#å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent-Dispatch-Queueï¼‰ï¼š" class="headerlink" title="å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent Dispatch Queueï¼‰ï¼š"></a>å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent Dispatch Queueï¼‰ï¼š</h5><p>æŒ‰ç…§<strong>FIFO</strong>(First In First Outå…ˆè¿›å…ˆå‡º)åŸåˆ™ï¼Œå…ˆæ·»åŠ çš„ä»»åŠ¡åœ¨é˜Ÿé¦–ï¼Œåæ·»åŠ çš„ä»»åŠ¡åœ¨é˜Ÿå°¾ï¼Œæ‰§è¡Œä»»åŠ¡çš„æ—¶å€™æŒ‰ç…§é˜Ÿåˆ—çš„ä»é¦–åˆ°è‹¥å¹²ä¸ªï¼Œæ‰§è¡Œåˆ°é˜Ÿå°¾ï¼Œä¸€æ¬¡å¯ä»¥æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œå…·å¤‡å¼€è¾Ÿæ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚</p><p><img src="/images/10-2.png" alt></p><h3 id="GCDä½¿ç”¨æ­¥éª¤"><a href="#GCDä½¿ç”¨æ­¥éª¤" class="headerlink" title="GCDä½¿ç”¨æ­¥éª¤"></a>GCDä½¿ç”¨æ­¥éª¤</h3><p>GCDçš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œåˆ›å»ºé˜Ÿåˆ—æˆ–è€…åœ¨å…¨å±€é˜Ÿåˆ—ä¸­æ–°åŠ ä»»åŠ¡å°±å¯ä»¥äº†ã€‚</p><p>ä¸‹è¾¹æ¥çœ‹çœ‹ <strong>é˜Ÿåˆ—çš„åˆ›å»ºæ–¹æ³•/è·å–æ–¹æ³•</strong>ï¼Œä»¥åŠ <strong>ä»»åŠ¡çš„åˆ›å»ºæ–¹æ³•</strong>ã€‚</p><h4 id="è·å–ä¸»é˜Ÿåˆ—"><a href="#è·å–ä¸»é˜Ÿåˆ—" class="headerlink" title="è·å–ä¸»é˜Ÿåˆ—"></a>è·å–ä¸»é˜Ÿåˆ—</h4><p>ä¸»é˜Ÿåˆ—æ˜¯ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—ï¼Œä¹Ÿæ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œè´Ÿè´£UIçš„æ›´æ–°ï¼Œä¹Ÿå¯ä»¥åšå…¶ä»–äº‹æƒ…ï¼Œå¯ä»¥é€šè¿‡<code>dispatch_get_main_queue()</code>ï¼Œä¸€èˆ¬å†™çš„ä»£ç æ²¡æœ‰å£°æ˜å¤šçº¿ç¨‹æˆ–è€…æ·»åŠ åˆ°å…¶ä»–é˜Ÿåˆ—ä¸­çš„ä»£ç éƒ½æ˜¯åœ¨ä¸»é˜Ÿåˆ—ä¸­è¿è¡Œçš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;è·å–ä¸»é˜Ÿåˆ—</span><br><span class="line">dispatch_queue_t main_queue&#x3D; dispatch_get_main_queue();</span><br></pre></td></tr></table></figure><h4 id="è·å–å…¨å±€é˜Ÿåˆ—"><a href="#è·å–å…¨å±€é˜Ÿåˆ—" class="headerlink" title="è·å–å…¨å±€é˜Ÿåˆ—"></a>è·å–å…¨å±€é˜Ÿåˆ—</h4><p>å…¨å±€é˜Ÿåˆ—æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¹¶è¡Œé˜Ÿåˆ—ï¼Œç³»ç»Ÿå·²ç»åˆ›å»ºå¥½äº†ï¼Œä½¿ç”¨çš„æ—¶å€™é€šè¿‡<code>dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0)</code>,ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>identifier</code>ï¼Œè¡¨ç¤ºé˜Ÿåˆ—çš„ä¼˜å…ˆçº§ï¼Œä¸€èˆ¬ä¼ å…¥<code>DISPATCH_QUEUE_PRIORITY_DEFAULT</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>flags</code>ï¼Œå®˜æ–¹è¯´æ³•æ˜¯å¿…é¡»æ˜¯0ï¼Œå¦åˆ™è¿”å›NULLã€‚æš‚ä¸”ä¼ å…¥0ã€‚ä¸‹è¾¹æ‘˜è‡ª<span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscy9saWJkaXNwYXRjaC8=" title="https://opensource.apple.com/tarballs/libdispatch/">libdispatch<i class="fa fa-external-link"></i></span></p><blockquote><p>Use the<br>.Fn dispatch_get_global_queue<br>function to obtain the global queue of given priority. The<br>.Fa flags<br>argument is reserved for future use and must be zero. Passing any value other<br>than zero may result in a NULL return value.</p></blockquote><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;è·å–å…¨å±€é˜Ÿåˆ—</span><br><span class="line">dispatch_queue_t main_queue&#x3D; dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br></pre></td></tr></table></figure><h4 id="ä»»åŠ¡çš„åˆ›å»º"><a href="#ä»»åŠ¡çš„åˆ›å»º" class="headerlink" title="ä»»åŠ¡çš„åˆ›å»º"></a>ä»»åŠ¡çš„åˆ›å»º</h4><p>GCD æä¾›äº†åŒæ­¥æ‰§è¡Œä»»åŠ¡çš„åˆ›å»ºæ–¹æ³•<code>dispatch_sync</code>å’Œå¼‚æ­¥æ‰§è¡Œä»»åŠ¡åˆ›å»ºæ–¹æ³•çš„<code>spatch_async</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; åŒæ­¥æ‰§è¡Œä»»åŠ¡åˆ›å»ºæ–¹æ³•</span><br><span class="line">dispatch_sync(queue, ^&#123;</span><br><span class="line">    &#x2F;&#x2F; è¿™é‡Œæ”¾åŒæ­¥æ‰§è¡Œä»»åŠ¡ä»£ç </span><br><span class="line">&#125;);</span><br><span class="line">&#x2F;&#x2F; å¼‚æ­¥æ‰§è¡Œä»»åŠ¡åˆ›å»ºæ–¹æ³•</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">    &#x2F;&#x2F; è¿™é‡Œæ”¾å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ä»£ç </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è™½ç„¶æ˜¯åªæœ‰åŒæ­¥å¼‚æ­¥ä½†æ˜¯ä»–ä»¬ç»„åˆçš„å¤šå˜çš„</p><table><thead><tr><th style="text-align:center"></th><th style="text-align:center">å¹¶å‘é˜Ÿåˆ—</th><th style="text-align:center">åˆ›å»ºçš„ä¸²è¡Œé˜Ÿåˆ—</th><th style="text-align:center">ä¸»é˜Ÿåˆ—</th></tr></thead><tbody><tr><td style="text-align:center">åŒæ­¥(sync)</td><td style="text-align:center">æ²¡å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œ</td><td style="text-align:center">æ²¡å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td><td style="text-align:center">æ²¡å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td></tr><tr><td style="text-align:center">å¼‚æ­¥(async)</td><td style="text-align:center">èƒ½å¼€å¯æ–°çº¿ç¨‹ï¼Œå¹¶å‘æ‰§è¡Œ</td><td style="text-align:center">èƒ½å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td><td style="text-align:center">æ²¡å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td></tr></tbody></table><h3 id="GCDçš„ä½¿ç”¨"><a href="#GCDçš„ä½¿ç”¨" class="headerlink" title="GCDçš„ä½¿ç”¨"></a>GCDçš„ä½¿ç”¨</h3><h4 id="ä¸»é˜Ÿåˆ—-åŒæ­¥"><a href="#ä¸»é˜Ÿåˆ—-åŒæ­¥" class="headerlink" title="ä¸»é˜Ÿåˆ—+åŒæ­¥"></a>ä¸»é˜Ÿåˆ—+åŒæ­¥</h4><p>åœ¨ä¸»é˜Ÿåˆ—ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶åŒæ­¥æ·»åŠ ä»»åŠ¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ä¸»é˜Ÿåˆ—+åŒæ­¥</span><br><span class="line">-(void)syn_main&#123;</span><br><span class="line">NSLog(@&quot;1&quot;);</span><br><span class="line">dispatch_queue_t main_queue &#x3D; dispatch_get_main_queue();</span><br><span class="line">dispatch_sync(main_queue, ^&#123;</span><br><span class="line">NSLog(@&quot;2&quot;);</span><br><span class="line">&#125;);</span><br><span class="line">NSLog(@&quot;3&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">1</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°æ—¥å¿—åªè¾“å‡ºäº†1å°±å´©æºƒäº†æç¤º<code>exc_bad_instuction</code>,ä¸ºä»€ä¹ˆå‡ºé—®é¢˜å‘¢ï¼Ÿ<br>ä¸»é˜Ÿåˆ—æ˜¯åŒæ­¥çš„ï¼Œä»»åŠ¡å‰åæ‰§è¡Œçš„ä»»åŠ¡æ˜¯åœ¨ä¸»é˜Ÿåˆ—ä¸­ï¼Œæ·»åŠ çš„ä»»åŠ¡ä¹Ÿæ˜¯åœ¨ä¸»é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸”æ·»åŠ æ˜¯åŒæ­¥æ·»åŠ ã€‚<br><strong>what</strong>???åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­æ·»åŠ åŒæ­¥ä»»åŠ¡ï¼Œåˆ°åº•æ˜¯æƒ³è®©é˜Ÿåˆ—æ‰§è¡Œä»»åŠ¡è¿˜æ˜¯æ·»åŠ ä»»åŠ¡ã€‚é˜Ÿåˆ—éµå¾ªFIFOåŸåˆ™ï¼Œå‡å¦‚è¦å¤§å®¶éƒ½åœ¨æ’é˜Ÿç­‰æ‰“é¥­ï¼Œæ–°æ¥çš„å‘˜å·¥å«çš„A,åè¾¹ä»£ç å«B,ç„¶åéƒ½åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œçªç„¶æ¥äº†ä¸ªæ’é˜Ÿçš„ï¼Œä½ è¯´Bèƒ½åŒæ„å—ï¼Ÿæ˜æ˜¾å’ŒAå¹²èµ·æ¥äº†ï¼Œç»“æœç³»ç»Ÿè€å¸ˆè¿‡æ¥æ‹‰æ¶äº†è¯´äº†ä¸€å¥<code>exc_bad_instuction</code>ï¼Œæ„æ€æ˜¯ä½ ä¿©åµèµ·æ¥å¤§å®¶éƒ½åƒä¸ä¸Šé¥­äº†ï¼Œç»“æœä»–ä¿©è¿˜æ˜¯æ¥ç€åµï¼ŒæŠŠç³»ç»Ÿåµå´©æºƒäº†ã€‚<br>é‚£ä¹ˆæˆ‘ä»¬èƒ½åœ¨ä¸»é˜Ÿåˆ—ä¸­åŒæ­¥æ·»åŠ ä»»åŠ¡å—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚çœ‹åˆ°ç­”æ¡ˆä¸è¦ç¬‘å“¦</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ä¸»é˜Ÿåˆ—+åŒæ­¥</span><br><span class="line">-(void)syn_main2&#123;</span><br><span class="line">NSLog(@&quot;1ä»»åŠ¡æ‰§è¡Œ&quot;);</span><br><span class="line">sleep(1);</span><br><span class="line">NSLog(@&quot;2ä»»åŠ¡æ‰§è¡Œ&quot;);</span><br><span class="line">sleep(1);</span><br><span class="line">NSLog(@&quot;3ä»»åŠ¡æ‰§è¡Œ&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">1ä»»åŠ¡æ‰§è¡Œ</span><br><span class="line">2ä»»åŠ¡æ‰§è¡Œ</span><br><span class="line">3ä»»åŠ¡æ‰§è¡Œ</span><br></pre></td></tr></table></figure><p>æ²¡çœ‹é”™ï¼Œä¿è¯åœ¨ä¸»é˜Ÿåˆ—ä¸­è°ƒç”¨è¯¥å‡½æ•°ï¼Œé‚£ä¹ˆä»–å°±æ˜¯ä¸»é˜Ÿåˆ—åŒæ­¥æ‰§è¡Œçš„,å¦‚æœåœ¨å…¶ä»–é˜Ÿåˆ—ä¸­è°ƒç”¨ï¼Œé‚£å®ƒåˆ™æ˜¯åœ¨è°ƒç”¨è€…é˜Ÿåˆ—ä¸­åŒæ­¥æ‰§è¡Œã€‚</p><h4 id="ä¸»é˜Ÿåˆ—-å¼‚æ­¥"><a href="#ä¸»é˜Ÿåˆ—-å¼‚æ­¥" class="headerlink" title="ä¸»é˜Ÿåˆ—+å¼‚æ­¥"></a>ä¸»é˜Ÿåˆ—+å¼‚æ­¥</h4><p>åœ¨ä¸»é˜Ÿåˆ—ä¸­å¼‚æ­¥æ·»åŠ ä»»åŠ¡å¹¶æ‰§è¡Œä»»åŠ¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ä¸»é˜Ÿåˆ—+å¼‚æ­¥</span><br><span class="line">NSLog(@&quot;start&quot;);</span><br><span class="line">dispatch_queue_t main_queue &#x3D; dispatch_get_main_queue();</span><br><span class="line">dispatch_async(main_queue, ^&#123;</span><br><span class="line">for (int i &#x3D; 0; i &lt; 3; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">NSLog(@&quot;%@ %d&quot;,[NSThread currentThread],i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_async(main_queue, ^&#123;</span><br><span class="line">for (int i &#x3D; 3; i &lt; 6; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">NSLog(@&quot;%@ %d&quot;,[NSThread currentThread],i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_async(main_queue, ^&#123;</span><br><span class="line">for (int i &#x3D; 7; i &lt; 10; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">NSLog(@&quot;%@ %d&quot;,[NSThread currentThread],i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">NSLog(@&quot;end&quot;);</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-24 15:12:24.73 start</span><br><span class="line">2019-07-24 15:12:24.73 end</span><br><span class="line"></span><br><span class="line">&lt;NSThread: 0x600002f9a940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 0</span><br><span class="line">2019-07-24 15:18:14.971795+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 1</span><br><span class="line">2019-07-24 15:18:15.972421+0800 day15-GCDo[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 2</span><br><span class="line">2019-07-24 15:18:16.973529+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 3</span><br><span class="line">2019-07-24 15:18:17.974978+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 4</span><br><span class="line">2019-07-24 15:18:18.975800+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 5</span><br><span class="line">2019-07-24 15:18:19.977185+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 7</span><br><span class="line">2019-07-24 15:18:20.978615+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 8</span><br><span class="line">2019-07-24 15:18:21.979958+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 9</span><br></pre></td></tr></table></figure><p>åœ¨ä¸»é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œä»æ—¥å¿—çœ‹å‡ºæ¥<code>end</code>æ—©äºä»»åŠ¡çš„æ‰§è¡Œï¼Œç¬¦åˆFIFOåŸåˆ™ï¼Œéƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå¯ä»¥çœ‹åˆ°</p><ul><li>ä¸»çº¿ç¨‹å¤šä¸ªä»»åŠ¡å¼‚æ­¥ä¸èƒ½åˆ›å»ºæ–°çº¿ç¨‹</li><li>ä¸»çº¿ç¨‹å¼‚æ­¥ä¹Ÿæ˜¯ä¸²è¡Œæ‰§è¡Œ</li></ul><h4 id="å…¨å±€é˜Ÿåˆ—-åŒæ­¥"><a href="#å…¨å±€é˜Ÿåˆ—-åŒæ­¥" class="headerlink" title="å…¨å±€é˜Ÿåˆ—+åŒæ­¥"></a>å…¨å±€é˜Ÿåˆ—+åŒæ­¥</h4><p>å…¨å±€é˜Ÿåˆ—æ˜¯å¹¶è¡Œé˜Ÿåˆ—ï¼Œå’ŒåŒæ­¥é…åˆå°±æ˜¯ä¸²è¡Œæ‰§è¡Œäº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;å…¨å±€é˜Ÿåˆ—+åŒæ­¥</span><br><span class="line">-(void)sync_global&#123;</span><br><span class="line">printf(&quot;\n start&quot;);</span><br><span class="line">dispatch_queue_t global_queue &#x3D; dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">dispatch_sync(global_queue, ^&#123;</span><br><span class="line">for (int i &#x3D; 0; i &lt; 3; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_sync(global_queue, ^&#123;</span><br><span class="line">for (int i &#x3D; 3; i &lt; 6; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_sync(global_queue, ^&#123;</span><br><span class="line">NSThread *thread &#x3D; [NSThread currentThread];</span><br><span class="line">for (int i &#x3D; 7; i &lt; 10; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,thread.description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">printf(&quot;\n end&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">start</span><br><span class="line"> 2019-07-24 15:35:36 &lt;NSThread: 0x600000592900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 0</span><br><span class="line"> 2019-07-24 15:35:37 &lt;NSThread: 0x600000592900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 1</span><br><span class="line"> 2019-07-24 15:35:38 &lt;NSThread: 0x600000592900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 2</span><br><span class="line"> 2019-07-24 15:35:39 &lt;NSThread: 0x600000592900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 3</span><br><span class="line"> 2019-07-24 15:35:40 &lt;NSThread: 0x600000592900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 4</span><br><span class="line"> 2019-07-24 15:35:41 &lt;NSThread: 0x600000592900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 5</span><br><span class="line"> 2019-07-24 15:35:42 &lt;NSThread: 0x600000592900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 7</span><br><span class="line"> 2019-07-24 15:35:43 &lt;NSThread: 0x600000592900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 8</span><br><span class="line"> 2019-07-24 15:35:44 &lt;NSThread: 0x600000592900&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 9</span><br><span class="line"> end</span><br></pre></td></tr></table></figure><p>åœ¨å…¨å±€é˜Ÿåˆ—ä¸­ä½¿ç”¨ä¸²è¡Œæ·»åŠ å¤šä¸ªä»»åŠ¡å¹¶æ²¡æœ‰æ–°å»ºå­çº¿ç¨‹æ¥è§£å†³é—®é¢˜ï¼ŒåŒæ­¥å…¶å®å°±æ˜¯ä¸²è¡Œï¼Œä½¿ç”¨FIFOåŸåˆ™ï¼Œä¸€ä¸ªä»»åŠ¡è§£å†³å®Œå†è§£å†³ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</p><h4 id="å…¨å±€é˜Ÿåˆ—-å¼‚æ­¥"><a href="#å…¨å±€é˜Ÿåˆ—-å¼‚æ­¥" class="headerlink" title="å…¨å±€é˜Ÿåˆ—+å¼‚æ­¥"></a>å…¨å±€é˜Ÿåˆ—+å¼‚æ­¥</h4><p>å…¨å±€é˜Ÿåˆ—æœ‰åˆ›å»ºå­çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä½†æ˜¯éœ€è¦å¼‚æ­¥<code>async</code>å»æ‰§è¡Œã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;å…¨å±€é˜Ÿåˆ—+å¼‚æ­¥</span><br><span class="line">-(void)async_global&#123;</span><br><span class="line">printf(&quot;\n start&quot;);</span><br><span class="line">dispatch_queue_t global_queue &#x3D; dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">dispatch_async(global_queue, ^&#123;</span><br><span class="line">for (int i &#x3D; 0; i &lt; 3; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_async(global_queue, ^&#123;</span><br><span class="line">for (int i &#x3D; 3; i &lt; 6; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_async(global_queue, ^&#123;</span><br><span class="line">NSThread *thread &#x3D; [NSThread currentThread];</span><br><span class="line">for (int i &#x3D; 7; i &lt; 10; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,thread.description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">printf(&quot;\n end&quot;);</span><br><span class="line">&#125;</span><br><span class="line">-(NSString *)currentDateString&#123;</span><br><span class="line">NSDate *date&#x3D;[NSDate new];</span><br><span class="line">NSDateFormatter *format &#x3D; [[NSDateFormatter alloc]init];</span><br><span class="line">[format setDateFormat:@&quot;yyyy-MM-dd HH:mm:ss&quot;];</span><br><span class="line">return [format stringFromDate:date];</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line"> start</span><br><span class="line"> end</span><br><span class="line"> 2019-07-24 15:40:21 &lt;NSThread: 0x600003b43dc0&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; 3</span><br><span class="line"> 2019-07-24 15:40:21 &lt;NSThread: 0x600003b44e80&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; 0</span><br><span class="line"> 2019-07-24 15:40:21 &lt;NSThread: 0x600003b45880&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 7</span><br><span class="line"> 2019-07-24 15:40:22 &lt;NSThread: 0x600003b44e80&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; 1</span><br><span class="line"> 2019-07-24 15:40:22 &lt;NSThread: 0x600003b45880&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 8</span><br><span class="line"> 2019-07-24 15:40:22 &lt;NSThread: 0x600003b43dc0&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; 4</span><br><span class="line"> 2019-07-24 15:40:23 &lt;NSThread: 0x600003b45880&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 9</span><br><span class="line"> 2019-07-24 15:40:23 &lt;NSThread: 0x600003b44e80&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; 2</span><br><span class="line"> 2019-07-24 15:40:23 &lt;NSThread: 0x600003b43dc0&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; 5</span><br></pre></td></tr></table></figure><p>å…¨å±€é˜Ÿåˆ—å½“æ­é…<code>async</code>çš„æ—¶å€™ï¼Œè¿½åŠ å¤šä¸ªä»»åŠ¡ï¼Œè¿™æ¬¡æ˜¯ä½¿ç”¨3ä¸ªçº¿ç¨‹ï¼Œè€Œä¸”ä¸ç”¨æˆ‘ä»¬æ¥ç»´æŠ¤çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œè€Œä¸”æ‰§è¡Œçš„é¡ºåºæ˜¯æ— åºçš„ã€‚</p><h4 id="åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—-åŒæ­¥"><a href="#åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—-åŒæ­¥" class="headerlink" title="åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+åŒæ­¥"></a>åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+åŒæ­¥</h4><p>å¼€å‘è€…è‡ªå·±åˆ›å»ºçš„ä¸²è¡Œé˜Ÿåˆ—åŒæ­¥è°ƒç”¨å’Œç³»ç»Ÿä¸»é˜Ÿåˆ—æœ‰ç±»ä¼¼çš„åœ°æ–¹ï¼Œä¹Ÿæœ‰åŒºåˆ«ã€‚ä¸€æ ·éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œï¼ŒåŒºåˆ«æ˜¯è¿½åŠ ä»»åŠ¡çš„æ—¶å€™ä¸€èˆ¬æ˜¯åœ¨ä¸»é˜Ÿåˆ—å‘ä¸²è¡Œé˜Ÿåˆ—æ·»åŠ ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+åŒæ­¥</span><br><span class="line">-(void)sync_cust_queue&#123;</span><br><span class="line">printf(&quot;\n start&quot;);</span><br><span class="line">dispatch_queue_t custQueue &#x3D; dispatch_queue_create(&quot;cust-queue&quot;, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">dispatch_sync(custQueue, ^&#123;</span><br><span class="line">for (int i &#x3D; 0; i &lt; 3; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_sync(custQueue, ^&#123;</span><br><span class="line">for (int i &#x3D; 3; i &lt; 6; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_sync(custQueue, ^&#123;</span><br><span class="line">NSThread *thread &#x3D; [NSThread currentThread];</span><br><span class="line">for (int i &#x3D; 7; i &lt; 10; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,thread.description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">printf(&quot;\n end&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">start</span><br><span class="line"> 2019-07-24 15:53:15 &lt;NSThread: 0x6000017ea940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 0</span><br><span class="line"> 2019-07-24 15:53:16 &lt;NSThread: 0x6000017ea940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 1</span><br><span class="line"> 2019-07-24 15:53:17 &lt;NSThread: 0x6000017ea940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 2</span><br><span class="line"> 2019-07-24 15:53:18 &lt;NSThread: 0x6000017ea940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 3</span><br><span class="line"> 2019-07-24 15:53:19 &lt;NSThread: 0x6000017ea940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 4</span><br><span class="line"> 2019-07-24 15:53:20 &lt;NSThread: 0x6000017ea940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 5</span><br><span class="line"> 2019-07-24 15:53:21 &lt;NSThread: 0x6000017ea940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 7</span><br><span class="line"> 2019-07-24 15:53:22 &lt;NSThread: 0x6000017ea940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 8</span><br><span class="line"> 2019-07-24 15:53:23 &lt;NSThread: 0x6000017ea940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 9</span><br><span class="line"> end</span><br></pre></td></tr></table></figure><p>åŒæ­¥å‘ä¸²è¡Œé˜Ÿåˆ—æ·»åŠ ä»»åŠ¡å¹¶æ²¡æœ‰æ­»é”ï¼åŸå› æ˜¯æ·»åŠ ä»»åŠ¡æ˜¯åœ¨<code>main_queue</code>æ‰§è¡Œçš„ï¼Œæ·»åŠ çš„ä»»åŠ¡æ˜¯åœ¨<code>cust-queue</code>ä¸­æ‰§è¡Œï¼Œç¬¦åˆFIFOåŸåˆ™ï¼Œå…ˆæ·»åŠ çš„å…ˆæ‰§è¡Œï¼Œå…·ä½“æ‰§è¡Œçš„çº¿ç¨‹ç”±ä»–ä»¬è‡ªå·±åˆ†é…ã€‚æ‰§è¡Œçš„ä»»åŠ¡æ˜¯åœ¨<code>main</code>çº¿ç¨‹ä¸­ã€‚</p><h4 id="åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—-å¼‚æ­¥"><a href="#åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—-å¼‚æ­¥" class="headerlink" title="åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+å¼‚æ­¥"></a>åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+å¼‚æ­¥</h4><p>ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œä½†æ˜¯å› ä¸ºä»»åŠ¡æ˜¯ä¸²è¡Œçš„ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+å¼‚æ­¥</span><br><span class="line">-(void)async_cust_queue&#123;</span><br><span class="line">printf(&quot;\n start&quot;);</span><br><span class="line">dispatch_queue_t custQueue &#x3D; dispatch_queue_create(&quot;cust-queue&quot;, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">dispatch_async(custQueue, ^&#123;</span><br><span class="line">for (int i &#x3D; 0; i &lt; 3; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_async(custQueue, ^&#123;</span><br><span class="line">for (int i &#x3D; 3; i &lt; 6; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_async(custQueue, ^&#123;</span><br><span class="line">NSThread *thread &#x3D; [NSThread currentThread];</span><br><span class="line">for (int i &#x3D; 7; i &lt; 10; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,thread.description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">printf(&quot;\n end&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line"> start</span><br><span class="line"> end</span><br><span class="line"> 2019-07-24 16:12:57 &lt;NSThread: 0x600002b346c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 0</span><br><span class="line"> 2019-07-24 16:12:58 &lt;NSThread: 0x600002b346c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 1</span><br><span class="line"> 2019-07-24 16:12:59 &lt;NSThread: 0x600002b346c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 2</span><br><span class="line"> 2019-07-24 16:13:00 &lt;NSThread: 0x600002b346c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 3</span><br><span class="line"> 2019-07-24 16:13:01 &lt;NSThread: 0x600002b346c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 4</span><br><span class="line"> 2019-07-24 16:13:02 &lt;NSThread: 0x600002b346c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 5</span><br><span class="line"> 2019-07-24 16:13:03 &lt;NSThread: 0x600002b346c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 7</span><br><span class="line"> 2019-07-24 16:13:04 &lt;NSThread: 0x600002b346c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 8</span><br><span class="line"> 2019-07-24 16:13:05 &lt;NSThread: 0x600002b346c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 9</span><br></pre></td></tr></table></figure><p>åœ¨<code>å¼‚æ­¥ + ä¸²è¡Œé˜Ÿåˆ—</code>å¯ä»¥çœ‹åˆ°ï¼š</p><p>å¼€å¯äº†ä¸€æ¡æ–°çº¿ç¨‹ï¼ˆå¼‚æ­¥æ‰§è¡Œå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä¸²è¡Œé˜Ÿåˆ—åªå¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼‰ã€‚<br>æ‰€æœ‰ä»»åŠ¡æ˜¯åœ¨æ‰“å°çš„<code>end</code>ä¹‹åæ‰å¼€å§‹æ‰§è¡Œçš„ï¼ˆå¼‚æ­¥æ‰§è¡Œä¸ä¼šåšä»»ä½•ç­‰å¾…ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼‰ã€‚<br>ä»»åŠ¡æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼ˆä¸²è¡Œé˜Ÿåˆ—æ¯æ¬¡åªæœ‰ä¸€ä¸ªä»»åŠ¡è¢«æ‰§è¡Œï¼Œä»»åŠ¡ä¸€ä¸ªæ¥ä¸€ä¸ªæŒ‰é¡ºåºæ‰§è¡Œï¼‰ã€‚</p><h4 id="åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—-åŒæ­¥"><a href="#åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—-åŒæ­¥" class="headerlink" title="åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—+åŒæ­¥"></a>åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—+åŒæ­¥</h4><p>åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">start</span><br><span class="line">2019-07-24 16:21:24 &lt;NSThread: 0x6000031d1380&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 0</span><br><span class="line">2019-07-24 16:21:25 &lt;NSThread: 0x6000031d1380&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 1</span><br><span class="line">2019-07-24 16:21:26 &lt;NSThread: 0x6000031d1380&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 2</span><br><span class="line">2019-07-24 16:21:27 &lt;NSThread: 0x6000031d1380&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 3</span><br><span class="line">2019-07-24 16:21:28 &lt;NSThread: 0x6000031d1380&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 4</span><br><span class="line">2019-07-24 16:21:29 &lt;NSThread: 0x6000031d1380&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 5</span><br><span class="line">2019-07-24 16:21:30 &lt;NSThread: 0x6000031d1380&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 7</span><br><span class="line">2019-07-24 16:21:31 &lt;NSThread: 0x6000031d1380&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 8</span><br><span class="line">2019-07-24 16:21:32 &lt;NSThread: 0x6000031d1380&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 9</span><br><span class="line">end</span><br></pre></td></tr></table></figure><p>å…¨å±€é˜Ÿåˆ—å…¶å®å°±æ˜¯ç‰¹æ®Šçš„å¹¶è¡Œé˜Ÿåˆ—ï¼Œè¿™é‡Œç»“æœå’Œ<code>å…¨å±€é˜Ÿåˆ—+åŒæ­¥</code>ä¸€è‡´ã€‚</p><h4 id="åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—-å¼‚æ­¥"><a href="#åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—-å¼‚æ­¥" class="headerlink" title="åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—+å¼‚æ­¥"></a>åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—+å¼‚æ­¥</h4><p>åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œå¯ä»¥åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—+å¼‚æ­¥</span><br><span class="line">-(void)async_queue&#123;</span><br><span class="line">printf(&quot;\n start&quot;);</span><br><span class="line">dispatch_queue_t custQueue &#x3D; dispatch_queue_create(&quot;cust-queue&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">dispatch_async(custQueue, ^&#123;</span><br><span class="line">for (int i &#x3D; 0; i &lt; 3; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_async(custQueue, ^&#123;</span><br><span class="line">for (int i &#x3D; 3; i &lt; 6; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_async(custQueue, ^&#123;</span><br><span class="line">NSThread *thread &#x3D; [NSThread currentThread];</span><br><span class="line">for (int i &#x3D; 7; i &lt; 10; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,thread.description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">printf(&quot;\n end&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">start</span><br><span class="line"> end</span><br><span class="line"> 2019-07-24 16:22:09 &lt;NSThread: 0x6000004280c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 7</span><br><span class="line"> 2019-07-24 16:22:09 &lt;NSThread: 0x6000004104c0&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; 0</span><br><span class="line"> 2019-07-24 16:22:09 &lt;NSThread: 0x600000422300&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; 3</span><br><span class="line"> 2019-07-24 16:22:10 &lt;NSThread: 0x6000004104c0&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; 1</span><br><span class="line"> 2019-07-24 16:22:10 &lt;NSThread: 0x6000004280c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 8</span><br><span class="line"> 2019-07-24 16:22:10 &lt;NSThread: 0x600000422300&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; 4</span><br><span class="line"> 2019-07-24 16:22:11 &lt;NSThread: 0x6000004280c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 9</span><br><span class="line"> 2019-07-24 16:22:11 &lt;NSThread: 0x6000004104c0&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; 2</span><br><span class="line"> 2019-07-24 16:22:11 &lt;NSThread: 0x600000422300&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; 5</span><br></pre></td></tr></table></figure><p><code>å¹¶è¡Œé˜Ÿåˆ—+å¼‚æ­¥</code>å’Œ<code>å…¨å±€é˜Ÿåˆ—+å¼‚æ­¥</code>ä¸€è‡´ï¼Œä¹Ÿä¼šæ–°å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œä¸”æ˜¯å¹¶å‘æ‰§è¡Œã€‚</p><h3 id="GCDå…¶ä»–é«˜çº§ç”¨æ³•"><a href="#GCDå…¶ä»–é«˜çº§ç”¨æ³•" class="headerlink" title="GCDå…¶ä»–é«˜çº§ç”¨æ³•"></a>GCDå…¶ä»–é«˜çº§ç”¨æ³•</h3><h4 id="å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡-ä¸»çº¿ç¨‹åˆ·æ–°UI"><a href="#å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡-ä¸»çº¿ç¨‹åˆ·æ–°UI" class="headerlink" title="å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ ä¸»çº¿ç¨‹åˆ·æ–°UI"></a>å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ ä¸»çº¿ç¨‹åˆ·æ–°UI</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (void)backToMain&#123;</span><br><span class="line">dispatch_queue_t main &#x3D; dispatch_get_main_queue();</span><br><span class="line">dispatch_queue_t glo &#x3D; dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">dispatch_async(glo, ^&#123;</span><br><span class="line">for (int i &#x3D; 0; i &lt; 3; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">&#125;</span><br><span class="line">dispatch_sync(main, ^&#123;</span><br><span class="line">printf(&quot;\n %s %s æˆ‘åœ¨åˆ·æ–°UI&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"> 2019-07-24 16:45:07 &lt;NSThread: 0x600001e84380&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 0</span><br><span class="line"> 2019-07-24 16:45:08 &lt;NSThread: 0x600001e84380&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 1</span><br><span class="line"> 2019-07-24 16:45:09 &lt;NSThread: 0x600001e84380&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 2</span><br><span class="line"> 2019-07-24 16:45:09 &lt;NSThread: 0x600001ef2940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; æˆ‘åœ¨åˆ·æ–°UI</span><br></pre></td></tr></table></figure><h4 id="é˜Ÿåˆ—åˆ†ç»„-dispatch-group-t"><a href="#é˜Ÿåˆ—åˆ†ç»„-dispatch-group-t" class="headerlink" title="é˜Ÿåˆ—åˆ†ç»„ dispatch_group_t"></a>é˜Ÿåˆ—åˆ†ç»„ dispatch_group_t</h4><h5 id="dispatch-group-notify"><a href="#dispatch-group-notify" class="headerlink" title="dispatch_group_notify"></a>dispatch_group_notify</h5><p>GCDæœ‰æœ‰åˆ†ç»„çš„æ¦‚å¿µï¼Œå½“æ‰€æœ‰åŠ å…¥åˆ†ç»„çš„é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆçš„æ—¶å€™ï¼Œé€šè¿‡<code>dispatch_group_notify</code>å®Œæˆå›è°ƒï¼Œç¬¬ä¸€ä¸ªå‚æ•°<code>group</code>æ˜¯æŸä¸ªåˆ†ç»„çš„å›è°ƒã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">-(void)group&#123;</span><br><span class="line">dispatch_group_t group &#x3D; dispatch_group_create();</span><br><span class="line">dispatch_queue_t queue&#x3D; dispatch_queue_create(&quot;cust.queue.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">dispatch_queue_t queue2&#x3D; dispatch_queue_create(&quot;cust2.queue.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">for (int i &#x3D; 0; i &lt; 3; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_async(group, queue2, ^&#123;</span><br><span class="line">for (int i &#x3D; 4; i &lt; 6; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">printf(&quot;\n %s %s ---end1----&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">for (int i &#x3D; 6; i &lt; 8; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_async(group, queue2, ^&#123;</span><br><span class="line">for (int i &#x3D; 8; i &lt; 10; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="dispatch-group-wait-amp-amp-dispatch-group-enter-amp-amp-dispatch-group-leave"><a href="#dispatch-group-wait-amp-amp-dispatch-group-enter-amp-amp-dispatch-group-leave" class="headerlink" title="dispatch_group_wait &amp;&amp; dispatch_group_enter &amp;&amp; dispatch_group_leave"></a>dispatch_group_wait &amp;&amp; dispatch_group_enter &amp;&amp; dispatch_group_leave</h5><p><code>dispatch_group_enter</code>å’Œ<code>dispatch_group_leave</code>éœ€è¦æˆå¯¹ä½¿ç”¨ï¼Œå¦åˆ™<code>dispatch_group_wait</code>åœ¨ç¼ºå°‘<code>leave</code>çš„æƒ…å†µä¸‹ä¼šç­‰å¾…åˆ°æ­»ï¼Œé€ æˆçº¿ç¨‹é˜»å¡ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">staticdispatch_group_t group ;</span><br><span class="line">if (group &#x3D;&#x3D; nil) &#123;</span><br><span class="line">group &#x3D; dispatch_group_create();</span><br><span class="line">&#125;</span><br><span class="line">dispatch_queue_t queue &#x3D; dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">&#x2F;&#x2F;dispatch_group_enter(group);</span><br><span class="line">dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">[self print];</span><br><span class="line">[NSThread sleepForTimeInterval:2];</span><br><span class="line">&#x2F;&#x2F;dispatch_group_leave(group);&#x2F;&#x2F;å½“æ³¨é‡Šæ‰  é˜»å¡åœ¨waitä¸ç»§ç»­å‘ä¸‹æ‰§è¡Œ</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_wait(group, DISPATCH_TIME_FOREVER);</span><br><span class="line"></span><br><span class="line">dispatch_group_enter(group);</span><br><span class="line">dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">[self print];</span><br><span class="line">[NSThread sleepForTimeInterval:2];</span><br><span class="line">dispatch_group_leave(group);</span><br><span class="line">&#125;);</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-25 10:58:50 &lt;NSThread: 0x600002d84180&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">2019-07-25 10:58:52 &lt;NSThread: 0x600002d84180&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125;</span><br></pre></td></tr></table></figure><h4 id="æ …æ å‡½æ•°-dispatch-barrier-sync"><a href="#æ …æ å‡½æ•°-dispatch-barrier-sync" class="headerlink" title="æ …æ å‡½æ•° dispatch_barrier_sync"></a>æ …æ å‡½æ•° dispatch_barrier_sync</h4><p>æ …æ å‡½æ•°å®ç°äº†å¼‚æ­¥çš„é˜Ÿåˆ—ä¸­åœ¨å¤šä¸ªä»»åŠ¡ç»“æŸçš„æ—¶å€™å®è¡Œå›è°ƒï¼Œå›è°ƒåˆ†å¼‚æ­¥å’ŒåŒæ­¥ï¼ŒåŒæ­¥å›è°ƒåœ¨ä¸»çº¿ç¨‹ï¼Œå¼‚æ­¥åœ¨å…¶ä»–çº¿ç¨‹ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (void)barry&#123;</span><br><span class="line">dispatch_queue_t queue&#x3D; dispatch_queue_create(&quot;cust.queue.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">for (int i &#x3D; 0; i &lt; 3; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_barrier_sync(queue, ^&#123;</span><br><span class="line">printf(&quot;\n %s %s ---ä¸­é—´æš‚åœä¸€ä¸‹----&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">for (int i &#x3D; 3; i &lt; 6; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_barrier_async(queue, ^&#123;</span><br><span class="line">printf(&quot;\n %s %s ---ä¸­é—´ç¬¬äºŒæ¬¡æš‚åœä¸€ä¸‹----&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"> 2019-07-24 16:52:33 &lt;NSThread: 0x600003158440&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 0</span><br><span class="line"> 2019-07-24 16:52:34 &lt;NSThread: 0x600003158440&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 1</span><br><span class="line"> 2019-07-24 16:52:35 &lt;NSThread: 0x600003158440&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 2</span><br><span class="line"> 2019-07-24 16:52:35 &lt;NSThread: 0x6000031293c0&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; ---ä¸­é—´æš‚åœä¸€ä¸‹----</span><br><span class="line"> 2019-07-24 16:52:36 &lt;NSThread: 0x600003158440&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 3</span><br><span class="line"> 2019-07-24 16:52:37 &lt;NSThread: 0x600003158440&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 4</span><br><span class="line"> 2019-07-24 16:52:38 &lt;NSThread: 0x600003158440&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 5</span><br><span class="line"> 2019-07-24 16:52:38 &lt;NSThread: 0x600003158440&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; ---ä¸­é—´ç¬¬äºŒæ¬¡æš‚åœä¸€ä¸‹----</span><br></pre></td></tr></table></figure><h4 id="å•ä¾‹-æ‰§è¡Œä¸€æ¬¡çš„å‡½æ•°-dispatch-once-t"><a href="#å•ä¾‹-æ‰§è¡Œä¸€æ¬¡çš„å‡½æ•°-dispatch-once-t" class="headerlink" title="å•ä¾‹-æ‰§è¡Œä¸€æ¬¡çš„å‡½æ•° dispatch_once_t"></a>å•ä¾‹-æ‰§è¡Œä¸€æ¬¡çš„å‡½æ•° dispatch_once_t</h4><p>å•ä¾‹å¯ä»¥é€šè¿‡è¿™ä¸ªå‡½æ•°å®ç°ï¼Œåªæ‰§è¡Œä¸€æ¬¡çš„å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åªæ‰§è¡Œä¸€æ¬¡çš„dispatch_once</span><br><span class="line">-(void)exc_once&#123;</span><br><span class="line">static dispatch_once_t onceToken;</span><br><span class="line">static NSObject *obj;</span><br><span class="line">dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">obj&#x3D;[NSObject new];</span><br><span class="line">printf(&quot;\n just once %s %s&quot;,[self dateUTF8],obj.description.UTF8String);</span><br><span class="line">&#125;);</span><br><span class="line">printf(&quot;\n %s %s&quot;,[self dateUTF8],obj.description.UTF8String);</span><br><span class="line">&#125;</span><br><span class="line">è°ƒç”¨4æ¬¡</span><br><span class="line">dispatch_apply(4, dispatch_get_global_queue(0, 0), ^(size_t idx) &#123;</span><br><span class="line">[self exc_once];</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">just once 2019-07-25 14:46:00 &lt;NSObject: 0x60000378b100&gt;</span><br><span class="line">2019-07-25 14:46:00 &lt;NSObject: 0x60000378b100&gt;</span><br><span class="line">2019-07-25 14:46:00 &lt;NSObject: 0x60000378b100&gt;</span><br><span class="line">2019-07-25 14:46:00 &lt;NSObject: 0x60000378b100&gt;</span><br></pre></td></tr></table></figure><p>å½“è°ƒç”¨4æ¬¡çš„æ—¶å€™ï¼Œæ—¥å¿—æ‰“å°çš„å››æ¬¡<code>obj</code>å‡ä¸ºåŒä¸€ä¸ªåœ°å€ï¼Œè¯æ˜<code>block</code>å›è°ƒå››æ¬¡ä½†æ˜¯åªæ‰§è¡Œäº†ä¸€æ¬¡ã€‚</p><h4 id="å»¶è¿Ÿæ‰§è¡Œ-dispatch-after"><a href="#å»¶è¿Ÿæ‰§è¡Œ-dispatch-after" class="headerlink" title="å»¶è¿Ÿæ‰§è¡Œ dispatch_after"></a>å»¶è¿Ÿæ‰§è¡Œ dispatch_after</h4><p>å½“è®°å½•æ—¥å¿—æˆ–è€…ç‚¹å‡»äº‹ä»¶çš„æ–¹æ³•æˆ‘ä»¬ä¸å¸Œæœ›ç«‹å³æ‰§è¡Œï¼Œåˆ™ä¼šç”¨åˆ°å»¶è¿Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;å»¶è¿Ÿæ‰§è¡Œ</span><br><span class="line">-(void)delayTimeExc&#123;</span><br><span class="line">printf(&quot;\n %s %s begin&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line"></span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line"></span><br><span class="line">printf(&quot;\n %s %s&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line">printf(&quot;\n %s %s end&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-24 17:07:48 &lt;NSThread: 0x600003cc6940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; begin</span><br><span class="line">2019-07-24 17:07:48 &lt;NSThread: 0x600003cc6940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; end</span><br><span class="line">2019-07-24 17:07:50 &lt;NSThread: 0x600003cc6940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¿¡å·é‡-dispatch-semaphore-t"><a href="#ä¿¡å·é‡-dispatch-semaphore-t" class="headerlink" title="ä¿¡å·é‡  dispatch_semaphore_t"></a>ä¿¡å·é‡  dispatch_semaphore_t</h4><p>ä¿¡å·é‡ä¸º1å¯ä»¥ä½œä¸ºçº¿ç¨‹é”æ¥ç”¨ï¼Œå½“N&gt;1çš„æ—¶å€™ï¼ŒåŒæ—¶æ‰§è¡Œçš„æœ‰Nä¸ªä»»åŠ¡ã€‚<br><code>dispatch_apply</code>å¯ä»¥é€šçŸ¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œç”¨å®ƒæ¥æµ‹è¯•ä¿¡å·é‡å†å¥½ä¸è¿‡äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ä¿¡å·é‡ å½“ä¿¡å·é‡ä¸º1 å¯ä»¥æœªåšé”æ¥ç”¨ï¼Œå½“N&gt;1ï¼Œté€šçŸ¥æ‰§è¡Œçš„æ•°é‡åˆ™æ˜¯æ•°å­—Nã€‚</span><br><span class="line">- (void)semaphore&#123;</span><br><span class="line">static dispatch_semaphore_t sem;</span><br><span class="line">if (sem &#x3D;&#x3D; NULL) &#123;</span><br><span class="line">sem &#x3D; dispatch_semaphore_create(1);</span><br><span class="line">&#125;</span><br><span class="line">dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</span><br><span class="line">static int i &#x3D; 0;</span><br><span class="line">int currentI &#x3D; i +2;</span><br><span class="line">for (; i &lt; currentI; i ++) &#123;</span><br><span class="line">[NSThread sleepForTimeInterval:1];</span><br><span class="line">printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">&#125;</span><br><span class="line">dispatch_semaphore_signal(sem);</span><br><span class="line">&#125;</span><br><span class="line">-(void)asyn_semaphore&#123;</span><br><span class="line">dispatch_apply(3, dispatch_get_global_queue(0, 0), ^(size_t idx) &#123;</span><br><span class="line">[self semaphore];</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">2019-07-24 17:25:04 &lt;NSThread: 0x6000002a2940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 0</span><br><span class="line">2019-07-24 17:25:05 &lt;NSThread: 0x6000002a2940&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; 1</span><br><span class="line">2019-07-24 17:25:06 &lt;NSThread: 0x6000002e2b40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 2</span><br><span class="line">2019-07-24 17:25:07 &lt;NSThread: 0x6000002e2b40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; 3</span><br><span class="line">2019-07-24 17:25:08 &lt;NSThread: 0x6000002d4740&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; 4</span><br><span class="line">2019-07-24 17:25:09 &lt;NSThread: 0x6000002d4740&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; 5</span><br></pre></td></tr></table></figure><p>è®¾è®¡ä¸€ä¸ªç»å…¸é—®é¢˜ï¼Œç«è½¦ç¥¨çª—å£ä¹°ç¥¨ï¼Œç«è½¦ç«™å–ç¥¨ä¸€èˆ¬æœ‰å¤šä¸ªçª—å£ï¼Œæ’é˜Ÿæ˜¯æ¯ä¸ªçª—å£æ’ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªçª—å£åŒæ—¶åªèƒ½å–ä¸€å¼ ç¥¨ï¼Œé‚£æˆ‘ä»¬è®¾è®¡ä¸€ä¸‹å¦‚ä½•å®ç°å¤šé˜Ÿåˆ—åŒæ—¶è®¿é—®å¤šä¸ªçª—å£çš„çš„é—®é¢˜ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">-(void)muchQueueBuyTick&#123;</span><br><span class="line">dispatch_queue_t queue&#x3D; dispatch_queue_create(&quot;com.buy.tick&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">for (NSInteger i &#x3D; 0; i &lt; 5; i ++) &#123;</span><br><span class="line">[self semaphore_buy_ticks:4];</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_queue_t queue2&#x3D; dispatch_queue_create(&quot;com.buy2.tick&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">dispatch_async(queue2, ^&#123;</span><br><span class="line">for (NSInteger i &#x3D; 0; i &lt; 5; i ++) &#123;</span><br><span class="line">[self semaphore_buy_ticks:2];</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)semaphore_buy_ticks:(NSInteger)windowsCount&#123;</span><br><span class="line">static dispatch_semaphore_t sem;</span><br><span class="line">if (sem &#x3D;&#x3D; NULL) &#123;</span><br><span class="line">sem &#x3D; dispatch_semaphore_create(windowsCount);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;ä¿¡å·é‡-1</span><br><span class="line">dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</span><br><span class="line">self.count--;</span><br><span class="line">if (self.count &gt; 0) &#123;</span><br><span class="line">printf(&quot;\n %s %s ç¬¬%ldä¸ªäººä¹°åˆ°ç¥¨äº†&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,(long)self.count);</span><br><span class="line">[NSThread sleepForTimeInterval:0.2];</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;ä¿¡å·é‡+1</span><br><span class="line">dispatch_semaphore_signal(sem);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">2019-07-24 18:01:44 &lt;NSThread: 0x600003935e00&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; ç¬¬8ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:44 &lt;NSThread: 0x600003904c40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; ç¬¬8ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003904c40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; ç¬¬6ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003935e00&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; ç¬¬6ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003935e00&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; ç¬¬4ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003904c40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; ç¬¬4ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003935e00&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; ç¬¬2ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003904c40&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; ç¬¬2ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003935e00&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; ç¬¬0ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªçª—å£(ä¸¤ä¸ªé˜Ÿåˆ—)ï¼Œæ¯ä¸ªçª—å£æ’äº†5(å¾ªç¯5æ¬¡)ä¸ªäººï¼Œä¸€å…±10(count=10)å¼ ç¥¨ã€‚<br>å½“åŒæ—¶ä¸€å¼ ç¥¨å¯ä»¥åˆ†å‰²2æ¬¡ï¼Œå–ç¥¨çš„é”™ä¹±äº†ï¼Œæ˜æ˜¾é”™è¯¯äº†ï¼Œç°åœ¨æŠŠæ¯å¼ ç¥¨éƒ½é”èµ·æ¥ï¼ŒåŒæ—¶åªèƒ½å…è®¸åŒä¸€ä¸ªäººå–ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-(void)muchQueueBuyTick&#123;</span><br><span class="line">dispatch_queue_t queue&#x3D; dispatch_queue_create(&quot;com.buy.tick&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">for (NSInteger i &#x3D; 0; i &lt; 5; i ++) &#123;</span><br><span class="line">[self semaphore_buy_ticks:1];</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_queue_t queue2&#x3D; dispatch_queue_create(&quot;com.buy2.tick&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">dispatch_async(queue2, ^&#123;</span><br><span class="line">for (NSInteger i &#x3D; 0; i &lt; 5; i ++) &#123;</span><br><span class="line">[self semaphore_buy_ticks:1];</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-24 18:03:56 &lt;NSThread: 0x600000e1cac0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; ç¬¬9ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:57 &lt;NSThread: 0x600000e1e0c0&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; ç¬¬8ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:57 &lt;NSThread: 0x600000e1cac0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; ç¬¬7ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:57 &lt;NSThread: 0x600000e1e0c0&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; ç¬¬6ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:57 &lt;NSThread: 0x600000e1cac0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; ç¬¬5ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:57 &lt;NSThread: 0x600000e1e0c0&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; ç¬¬4ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:58 &lt;NSThread: 0x600000e1cac0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; ç¬¬3ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:58 &lt;NSThread: 0x600000e1e0c0&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; ç¬¬2ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:58 &lt;NSThread: 0x600000e1cac0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; ç¬¬1ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br></pre></td></tr></table></figure><p>é¡ºåºæ˜¯å¯¹äº†ï¼Œæ•°é‡ä¹Ÿå¯¹äº†ã€‚</p><p>å†æ¢ä¸€ç§æ€è·¯å®ç°é”ä½çª—å£ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ä½¿ç”¨åŒæ­¥é˜Ÿåˆ—å–ç¥¨</span><br><span class="line">- (void)sync_buy_tick&#123;</span><br><span class="line">dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">self.count--;</span><br><span class="line">if (self.count &gt; 0) &#123;</span><br><span class="line">printf(&quot;\n %s %s ç¬¬%ldä¸ªäººä¹°åˆ°ç¥¨äº†&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,(long)self.count);</span><br><span class="line">[NSThread sleepForTimeInterval:0.2];</span><br><span class="line">&#125;</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-25 09:31:56 &lt;NSThread: 0x6000034d2e40&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; ç¬¬9ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:56 &lt;NSThread: 0x6000034d2e40&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; ç¬¬8ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:56 &lt;NSThread: 0x6000034d2e40&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; ç¬¬7ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:56 &lt;NSThread: 0x6000034d2e40&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; ç¬¬6ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:57 &lt;NSThread: 0x6000034d2e40&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; ç¬¬5ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:57 &lt;NSThread: 0x6000034d2e40&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; ç¬¬4ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:57 &lt;NSThread: 0x6000034d2e40&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; ç¬¬3ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:57 &lt;NSThread: 0x6000034d2e40&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; ç¬¬2ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:57 &lt;NSThread: 0x6000034d2e40&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; ç¬¬1ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br></pre></td></tr></table></figure><p>ä¸²è¡Œé˜Ÿåˆ—ä¸åˆ›å»ºå­çº¿ç¨‹ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½åœ¨åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šæ’é˜Ÿï¼Œå…¶å®ä¸ç®¡å¤šå°‘äººåŒæ—¶ç‚¹å‡»ä¹°ç¥¨ï¼Œç¥¨çš„åˆ†å‰²è¿˜æ˜¯ä¸²è¡Œçš„ï¼Œæ‰€ä»¥çº¿ç¨‹é”çš„å¯ä»¥ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—æ¥è§£å†³ã€‚</p><h4 id="å¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch-apply"><a href="#å¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch-apply" class="headerlink" title="å¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch_apply"></a>å¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch_apply</h4><p>å¿«é€Ÿè¿­ä»£å°±æ˜¯åŒæ—¶åˆ›å»ºå¾ˆå¤šçº¿ç¨‹æ¥åœ¨åšäº‹æƒ…ï¼Œç°åœ¨å·¥å‚æ”¶åˆ°ä¸€ä¸ªäº¿çš„è®¢å•ï¼Œå·¥å‚æœ¬æ¥åªæœ‰2æ¡ç”Ÿäº§çº¿ï¼Œç°åœ¨ç´§æ€¥æ–°å»ºå¾ˆå¤šç”Ÿäº§çº¿æ¥ç”Ÿäº§äº§å“ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;*</span><br><span class="line">åŒæ—¶æ–°å»ºäº†å¤šæ¡çº¿ç¨‹æ¥åšä»»åŠ¡</span><br><span class="line">*&#x2F;</span><br><span class="line">dispatch_apply(10, dispatch_get_global_queue(0, 0), ^(size_t idx) &#123;</span><br><span class="line">printf(&quot;\n %s %s &quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x600000966180&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x60000094a3c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125; </span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x600000979dc0&gt;&#123;number &#x3D; 5, name &#x3D; (null)&#125; </span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x60000090d3c0&gt;&#123;number &#x3D; 1, name &#x3D; main&#125; </span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x60000095cfc0&gt;&#123;number &#x3D; 6, name &#x3D; (null)&#125; </span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x600000950140&gt;&#123;number &#x3D; 8, name &#x3D; (null)&#125; </span><br><span class="line"> 2019-07-25 09:38:38 &lt;NSThread: 0x60000095d0c0&gt;&#123;number &#x3D; 9, name &#x3D; (null)&#125; </span><br><span class="line"> 2019-07-25 09:38:38 &lt;NSThread: 0x60000094a400&gt;&#123;number &#x3D; 7, name &#x3D; (null)&#125; </span><br><span class="line"> 2019-07-25 09:38:38 &lt;NSThread: 0x600000966180&gt;&#123;number &#x3D; 4, name &#x3D; (null)&#125; </span><br><span class="line"> 2019-07-25 09:38:38 &lt;NSThread: 0x60000094a3c0&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æ–°å»ºäº†<code>3</code>ã€<code>4</code>ã€<code>5</code>ã€<code>6</code>ã€<code>7</code>ã€<code>8</code>ã€<code>9</code>ã€<code>main</code>æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p><h3 id="å¤šçº¿ç¨‹RunLoopå®æˆ˜"><a href="#å¤šçº¿ç¨‹RunLoopå®æˆ˜" class="headerlink" title="å¤šçº¿ç¨‹RunLoopå®æˆ˜"></a>å¤šçº¿ç¨‹RunLoopå®æˆ˜</h3><p>é—®é¢˜ä¸€ï¼šè¯·é—®ä¸‹è¾¹ä»£ç è¾“å‡ºä»€ä¹ˆï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-(void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">    dispatch_queue_t  que&#x3D; dispatch_get_global_queue(0, 0);</span><br><span class="line">    dispatch_async(que, ^&#123;</span><br><span class="line">        NSLog(@&quot;1&quot;);</span><br><span class="line">        [self performSelector:@selector(test) withObject:nil afterDelay:.0];</span><br><span class="line">        NSLog(@&quot;3&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)test&#123;</span><br><span class="line">    NSLog(@&quot;2&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>çŒœæƒ³1ï¼šç»“æœæ˜¯<code>123</code></li><li>çŒœæƒ³2ï¼šç»“æœæ˜¯<code>132</code></li></ul><p>æœ‰æ²¡æœ‰ç¬¬ä¸‰ç§ç»“æœå‘¢ï¼Ÿ</p><p>çŒœæƒ³1åˆ†æï¼š<br>å› ä¸ºæ˜¯å»¶è¿Ÿ<code>0</code>sæ‰§è¡Œï¼Œå½“ç„¶æ˜¯å…ˆæ‰§è¡Œ<code>2</code>ï¼Œå†æ‰§è¡Œ<code>3</code>äº†ã€‚</p><p>çŒœæƒ³2åˆ†æï¼š</p><p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼Œå¼‚æ­¥åŠ å…¥å…¨å±€é˜Ÿåˆ—ä¸­ï¼Œå•ä¸ªä»»åŠ¡çš„æ—¶å€™ä¼šåŠ å…¥åˆ°å­çº¿ç¨‹ä¸­ï¼Œé‚£ä¹ˆä¼šå…ˆè¾“å‡º<code>1</code>ï¼Œç„¶åè¾“å‡º<code>3</code>ï¼Œæœ€åè¾“å‡º<code>2</code>.</p><p>æœ€åéªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">3</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆ2æ²¡æœ‰å‡ºæ¥å‘¢ï¼Ÿåœ¨çœ‹ä¸€ä¸‹ä»£ç ï¼Œå…¨å±€é˜Ÿåˆ—ï¼Œå»¶è¿Ÿæ‰§è¡Œï¼Œç‚¹è¿›å»å‡½æ•°æŸ¥çœ‹ï¼ŒåŸæ¥æ˜¯åœ¨<code>runloop.h</code>æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬çŒœæµ‹å»¶è¿Ÿæ‰§è¡Œæ˜¯<code>timer</code>æ·»åŠ åˆ°<code>runloop</code>ä¸­äº†ï¼Œæ·»åŠ è¿›å»ä¹Ÿåº”è¯¥è¾“å‡º<code>132</code>çš„ã€‚å› ä¸ºåœ¨å­çº¿ç¨‹ä¸­ï¼Œæ²¡æœ‰ä¸»åŠ¨è°ƒç”¨ä¸ä¼šæœ‰<code>runloop</code>çš„ï¼ŒåŠæ—¶è°ƒç”¨äº†ä¹Ÿéœ€è¦ä¿æ´»æŠ€æœ¯ï¼Œé‚£ä¹ˆä»£ç æ”¹è¿›ä¸€ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_queue_t  que&#x3D; dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">    dispatch_async(que, ^&#123;</span><br><span class="line">        NSLog(@&quot;1&quot;);</span><br><span class="line">        &#x2F;&#x2F; ç›¸å½“äº[self test];</span><br><span class="line">&#x2F;&#x2F;       [self performSelector:@selector(test) withObject:nil];</span><br><span class="line">        [self performSelector:@selector(test) withObject:nil afterDelay:.0];</span><br><span class="line">        </span><br><span class="line">        [[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSRunLoopCommonModes];</span><br><span class="line">        [[NSRunLoop currentRunLoop] run];</span><br><span class="line">        NSLog(@&quot;3&quot;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p>ç»æµ‹è¯•è¾“å‡ºäº†<code>12</code>ï¼Œè¿™å’Œæˆ‘ä»¬çŒœæƒ³çš„è¿˜æ˜¯ä¸å¯¹ï¼ŒåŸæ¥è¾“å‡º<code>3</code>æ”¾åœ¨äº†æœ€åï¼Œå¯¼è‡´çš„é—®é¢˜ï¼Œ<code>RunLoop</code>è¿è¡Œèµ·æ¥ï¼Œè¿›å…¥äº†å¾ªç¯ï¼Œåˆ™åé¢çš„å°±ä¸ä¼šæ‰§è¡Œäº†ï¼Œé™¤éåœæ­¢å½“å‰<code>RunLoop</code>ï¼Œæˆ‘ä»¬å†æ”¹è¿›ä¸€ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_queue_t  que&#x3D; dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">    dispatch_async(que, ^&#123;</span><br><span class="line">        NSLog(@&quot;1&quot;);</span><br><span class="line">        &#x2F;&#x2F; ç›¸å½“äº[self test];</span><br><span class="line">&#x2F;&#x2F;       [self performSelector:@selector(test) withObject:nil];</span><br><span class="line">        [self performSelector:@selector(test) withObject:nil afterDelay:.0];</span><br><span class="line">         NSLog(@&quot;3&quot;);</span><br><span class="line">        [[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSRunLoopCommonModes];</span><br><span class="line">        [[NSRunLoop currentRunLoop] run];</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p>æœ€åç»ˆäºè¾“å‡ºäº†<code>132</code>ã€‚ç¼ºç‚¹æ˜¯å­çº¿ç¨‹æˆäº†<strong>æ­»å¾…</strong>ï¼Œä¸æ­»ä¹‹èº«ï¼Œå…³äºæ€ä¹ˆæ€æ­»<strong>æ­»å¾…</strong>è¯·çœ‹<span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81ZDM1YjM0N2YyNjVkYTFiODYwOGM0OWI=" title="https://juejin.im/post/5d35b347f265da1b8608c49b">ä¸Šç¯‡ä¼˜é›…æ§åˆ¶RunLoopç”Ÿå‘½å‘¨æœŸ<i class="fa fa-external-link"></i></span>ã€‚<br>å…³äº<code>performSelector:(SEL)aSelector withObject:(nullable id)anArgument afterDelay:(NSTimeInterval)delay</code>ä¸­æœ‰å»¶è¿Ÿçš„ï¼Œéƒ½æ˜¯æ·»åŠ åˆ°å½“å‰ä½ çº¿ç¨‹çš„<code>RunLoop</code>ï¼Œå¦‚æœæ²¡æœ‰å¯åŠ¨<code>RunLoop</code>å’Œä¿æ´»ææ€•ä¹Ÿä¸èƒ½ä¸€ç›´æ‰§è¡Œã€‚<code>[self performSelector:@selector(test) withObject:nil]</code>æ˜¯åœ¨<code>Foudation</code>ä¸­ï¼Œæºç æ˜¯ç›´æ¥<code>objc_msgSend()</code>ï¼Œç›¸å½“äºç›´æ¥<code>[self test]</code>ï¼Œä¸ä¼šæœ‰å»¶è¿Ÿã€‚</p><p>é—®é¢˜2ï¼šè¯·é—®è¾“å‡ºä»€ä¹ˆï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NSThread *thread&#x3D;[[NSThread alloc]initWithBlock:^&#123;</span><br><span class="line">    NSLog(@&quot;1&quot;);</span><br><span class="line">&#125;];</span><br><span class="line">[thread start];</span><br><span class="line">[self performSelector:@selector(test)</span><br><span class="line">             onThread:thread</span><br><span class="line">           withObject:nil</span><br><span class="line">        waitUntilDone:YES];</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå’Œä¸Šé¢çš„ç±»ä¼¼ï¼Œç»“æœæ˜¯æ‰“å°äº†<code>1</code>å°±å´©æºƒäº†ï¼ŒåŸå› æ˜¯<code>thread start</code>ä¹‹åæ‰§è¡Œå®Œ<code>block</code>å°±ç»“æŸäº†ï¼Œæ²¡æœ‰<code>runloop</code>çš„æ”¯æ’‘ã€‚å½“æ‰§è¡Œ<code>performSelector</code>çš„æ—¶å€™ï¼Œçº¿ç¨‹å·²ç»æ­»æ‰ã€‚è§£å†³è¿™ä¸ªé—®é¢˜åªéœ€è¦å‘å­çº¿ç¨‹ä¸­æ·»åŠ <code>RunLoop</code>ï¼Œè€Œä¸”ä¿è¯<code>RunLoop</code>ä¸åœæ­¢å°±è¡Œäº†ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>GCDå¼‚æ­¥è´Ÿè´£æ‰§è¡Œè€—æ—¶ä»»åŠ¡(ä¾‹å¦‚ä¸‹è½½ï¼Œå¤æ‚è®¡ç®—)ï¼Œmainçº¿ç¨‹è´Ÿè´£æ›´æ–°UI</li><li>é˜Ÿåˆ—å¤šä»»åŠ¡å¼‚æ­¥æ‰§è¡Œæœ€åå…¨å±€æ‰§è¡Œå®Œæ¯•å¯ä»¥ä½¿ç”¨<code>group_notify</code>æ¥ç›‘å¬æ‰§è¡Œå®Œæ¯•æ—¶é—´</li><li>é˜Ÿåˆ—å¤šä»»åŠ¡å¼‚æ­¥æ‰§è¡Œç»“æŸæ—¶é—´ï¼Œä¸­é—´æ‹¦æˆªæ›´æ–°UIï¼Œç„¶åå†å¼‚æ­¥æ‰§è¡Œå¯ä»¥ä½¿ç”¨<code>dispatch_barrier_sync</code></li><li>å½“å¤šçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªèµ„æºï¼Œå¯ä»¥ä½¿ç”¨ä¿¡å·é‡æ¥é™åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„çº¿ç¨‹æ•°é‡</li></ul><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ul><li><span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81YTkwZGU2OGYyNjVkYTRlOWI1OTJiNDAjaGVhZGluZy0xNg==" title="https://juejin.im/post/5a90de68f265da4e9b592b40#heading-16">iOSå¤šçº¿ç¨‹ï¼šã€GCDã€è¯¦å°½æ€»ç»“<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cDovL3d3dy41MjBpdC5jb20venQvaW9zX21qLw==" title="http://www.520it.com/zt/ios_mj/">å°ç å“¥è§†é¢‘<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cDovL2F3YXlxdS4xMDI0dWwuY29tL2lvcy8yMDE4LzA1LzAyL2djZC0zLmh0bWw=" title="http://awayqu.1024ul.com/ios/2018/05/02/gcd-3.html">ä»»åŠ¡è°ƒåº¦<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscy9saWJkaXNwYXRjaC8=" title="https://opensource.apple.com/tarballs/libdispatch/">libdispatch<i class="fa fa-external-link"></i></span></li><li>iOSå’ŒOSå¤šçº¿ç¨‹ä¸å†…å­˜ç®¡ç†<h3 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h3></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½git<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code git<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9vYmpjNC03NTA=" title="https://github.com/ifgyong/demo/tree/master/OC/objc4-750">runtimeå¯è¿è¡Œçš„æºç git<i class="fa fa-external-link"></i></span></li></ul><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p><p>å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;code&gt;RunLoop&lt;/code&gt;å’Œçº¿ç¨‹çš„å…³ç³»ï¼Œä»¥åŠ&lt;code&gt;Thread&lt;/code&gt;å¦‚ä½•ä¿æ´»å’Œæ§åˆ¶ç”Ÿå‘½å‘¨æœŸï¼Œä»Šå¤©æˆ‘ä»¬å†æ¢ç©¶ä¸‹å¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹&lt;code&gt;GCD&lt;/code&gt;ï¼Œæ­å¼€è’™å¨œä¸½èçš„é¢çº±ã€‚&lt;/p&gt;
&lt;h3 id=&quot;GCD-åŸºç¡€çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#GC
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç†  RunLoopåŸºç¡€æ€»ç»“å’Œéšå¿ƒæ‰€æ¬²æŒæ¡å­çº¿ç¨‹RunLoopç”Ÿå‘½å‘¨æœŸ --(9)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20RunLoop%E5%9F%BA%E7%A1%80%E6%80%BB%E7%BB%93%E5%92%8C%E9%9A%8F%E5%BF%83%E6%89%80%E6%AC%B2%E6%8E%8C%E6%8F%A1%E5%AD%90%E7%BA%BF%E7%A8%8BRunLoop%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%20--(9)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20RunLoop%E5%9F%BA%E7%A1%80%E6%80%BB%E7%BB%93%E5%92%8C%E9%9A%8F%E5%BF%83%E6%89%80%E6%AC%B2%E6%8E%8C%E6%8F%A1%E5%AD%90%E7%BA%BF%E7%A8%8BRunLoop%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%20--(9)/</id>
    <published>2019-12-01T03:19:58.000Z</published>
    <updated>2020-09-04T04:40:21.658Z</updated>
    
    <content type="html"><![CDATA[<p>ä½¿ç”¨é’©å­å®ç°äº†å¯¹å­—å…¸å’Œæ•°ç»„çš„èµ‹å€¼çš„æ ¡éªŒï¼Œé¡ºä¾¿éšæ‰‹æ’¸äº†ä¸€ä¸ªç®€å•çš„<code>jsonToModel</code>,<code>iOS</code>é™¤äº†<code>runtime</code>è¿˜æœ‰ä¸€ä¸ªä¸œè¥¿çš„å«åš<code>runloop</code>ï¼Œå„ä½çœ‹å®˜è€çˆ·ä¸€å®šéƒ½æœ‰äº†è§£ï¼Œé‚£ä¹ˆä»Šå¤©è¿™ç¯‡æ–‡ç« åˆè¯†ä¸€ä¸‹<code>runloop</code>ã€‚</p><h3 id="ä»€ä¹ˆæ˜¯runloop"><a href="#ä»€ä¹ˆæ˜¯runloop" class="headerlink" title="ä»€ä¹ˆæ˜¯runloop"></a>ä»€ä¹ˆæ˜¯runloop</h3><p>ç®€å•æ¥è®²<code>runloop</code>å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œæˆ‘ä»¬å†™çš„ç¨‹åºï¼Œä¸€èˆ¬æ²¡æœ‰å¾ªç¯çš„è¯ï¼Œæ‰§è¡Œå®Œå°±ç»“æŸäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰‹æœºä¸Šçš„APPæ˜¯å¦‚ä½•ä¸€ç›´è¿è¡Œä¸åœæ­¢çš„å‘¢ï¼ŸAPPå°±æ˜¯ç”¨åˆ°äº†<code>runloop</code>ï¼Œä¿è¯ç¨‹åºä¸€ç›´è¿è¡Œä¸é€€å‡ºï¼Œåœ¨éœ€è¦å¤„ç†äº‹ä»¶çš„æ—¶å€™å¤„ç†äº‹ä»¶ï¼Œä¸å¤„ç†äº‹ä»¶çš„æ—¶å€™è¿›è¡Œä¼‘çœ ï¼Œè·³å‡ºå¾ªç¯ç¨‹åºå°±ç»“æŸã€‚ç”¨ä¼ªä»£ç å®ç°ä¸€ä¸ª<code>runloop</code>å…¶å®æ˜¯è¿™æ ·å­çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int ret &#x3D; 0;</span><br><span class="line">do &#123;</span><br><span class="line">    &#x2F;&#x2F;ç¡çœ ä¸­ç­‰å¾…æ¶ˆæ¯</span><br><span class="line">    int messgae &#x3D; sleep_and_wait();</span><br><span class="line">    &#x2F;&#x2F;å¤„ç†æ¶ˆæ¯</span><br><span class="line">    ret &#x3D; process_message(messgae);</span><br><span class="line">&#125; while (ret &#x3D;&#x3D; 0);</span><br></pre></td></tr></table></figure><h3 id="è·å–runloop"><a href="#è·å–runloop" class="headerlink" title="è·å–runloop"></a>è·å–runloop</h3><p>iOSä¸­æœ‰ä¸¤å¥—å¯ä»¥è·å–runloopä»£ç ï¼Œä¸€ä¸ªæ˜¯<code>Foundation</code>ã€ä¸€ä¸ªæ˜¯<code>Core Foundation</code>ã€‚<br><code>Foundation</code>å…¶å®æ˜¯å¯¹<code>Core Foundation</code>çš„ä¸€ä¸ªå°è£…ï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NSRunLoop * runloop1 &#x3D; [NSRunLoop currentRunLoop];</span><br><span class="line">NSRunLoop *mainloop1 &#x3D; [NSRunLoop mainRunLoop];</span><br><span class="line"></span><br><span class="line">CFRunLoopRef runloop2&#x3D; CFRunLoopGetCurrent();</span><br><span class="line">CFRunLoopRef mainloop2 &#x3D; CFRunLoopGetMain();</span><br><span class="line">NSLog(@&quot;%p %p %p %p&quot;,runloop1,mainloop1,runloop2,mainloop2);</span><br><span class="line">NSLog(@&quot;%@&quot;,runloop1);</span><br><span class="line">&#x2F;&#x2F;æ‰“å°</span><br><span class="line">runlopp1:0x600001bc58c0 </span><br><span class="line">mainloop1:0x600001bc58c0 </span><br><span class="line">runloop2:0x6000003cc300 </span><br><span class="line">mainloop1:0x6000003cc300</span><br><span class="line"></span><br><span class="line">runloop1:&lt;CFRunLoop 0x6000003cc300 [0x10b2e9ae8]&gt;.....</span><br></pre></td></tr></table></figure><p><code>runloop1</code>å’Œ<code>mainloop1</code>åœ°å€ä¸€è‡´ï¼Œè¯´æ˜å½“å‰çš„<code>runloop</code>æ˜¯<code>mainrunloop</code>,<code>runloop1</code>ä½œä¸ºå¯¹è±¡è¾“å‡ºçš„ç»“æœå…¶å®ä¹Ÿæ˜¯<code>runloop2</code>çš„åœ°å€ï¼Œè¯æ˜<code>Foundation runloop</code>æ˜¯å¯¹<code>Core Foundation</code>çš„ä¸€ä¸ªå°è£…ã€‚</p><p><code>RunLoop</code>åº•å±‚æˆ‘ä»¬çŒœæµ‹åº”è¯¥æ˜¯ç»“æ„ä½“ï¼Œæˆ‘ä»¬éƒ½äº†è§£åˆ°å…¶å®<code>OC</code>å°±æ˜¯å°è£…äº†<code>c/c++</code>ï¼Œé‚£ä¹ˆcå‰å®³ä¹‹å¤„å°±æ˜¯æŒ‡é’ˆå’Œç»“æ„ä½“åŸºæœ¬è§£å†³å¸¸ç”¨çš„æ‰€æœ‰ä¸œè¥¿ã€‚æˆ‘ä»¬çª¥æ¢ä¸€ä¸‹<code>runloop</code>çš„çœŸæ˜¯æ¨¡æ ·ï¼Œé€šè¿‡<code>CFRunLoopRef *runloop = CFRunLoopGetMain();</code>æŸ¥çœ‹<code>CFRunloop</code>æ˜¯<code>typedef struct CF_BRIDGED_MUTABLE_TYPE(id) __CFRunLoop * CFRunLoopRef;</code>ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„<code>CFRunLoopRef</code>æ˜¯<code>__CFRunLoop *</code>ç±»å‹çš„ï¼Œé‚£ä¹ˆå†åœ¨<span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscy9DRi8=" title="https://opensource.apple.com/tarballs/CF/">æºç (å¯ä»¥ä¸‹è½½æœ€æ–°çš„æºç )<i class="fa fa-external-link"></i></span>ä¸­æœç´¢ä¸€ä¸‹ <code>struct __CFRunLoop {</code>åœ¨<code>runloop.c 637è¡Œ</code>å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">struct __CFRunLoop &#123;</span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    pthread_mutex_t _lock;&#x2F;* model list é” *&#x2F;</span><br><span class="line">    __CFPort _wakeUpPort;&#x2F;&#x2F; æ¥å— CFRunLoopWakeUpçš„ç«¯å£</span><br><span class="line">    Boolean _unused;&#x2F;&#x2F;æ˜¯å¦ä½¿ç”¨</span><br><span class="line">    volatile _per_run_data *_perRunData;              &#x2F;&#x2F; reset for runs of the run loop</span><br><span class="line">    pthread_t _pthread; &#x2F;&#x2F;çº¿ç¨‹</span><br><span class="line">    uint32_t _winthread;&#x2F;&#x2F;winçº¿ç¨‹</span><br><span class="line">    CFMutableSetRef _commonModes; &#x2F;&#x2F;modes</span><br><span class="line">    CFMutableSetRef _commonModeItems; &#x2F;&#x2F;modeItems</span><br><span class="line">    CFRunLoopModeRef _currentMode; &#x2F;&#x2F;å½“å‰çš„mode</span><br><span class="line">    CFMutableSetRef _modes; &#x2F;&#x2F;æ‰€æœ‰çš„modes</span><br><span class="line">    struct _block_item *_blocks_head; &#x2F;&#x2F;å¾…æ‰§è¡Œçš„blockåˆ—è¡¨å¤´éƒ¨</span><br><span class="line">    struct _block_item *_blocks_tail; &#x2F;&#x2F;å¾…æ‰§è¡Œçš„block å°¾éƒ¨</span><br><span class="line">    CFAbsoluteTime _runTime; &#x2F;&#x2F;runtime</span><br><span class="line">    CFAbsoluteTime _sleepTime; &#x2F;&#x2F;sleeptime</span><br><span class="line">    CFTypeRef _counterpart; &#x2F;&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»è¿‡ç®€åŒ–ä¹‹åï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct __CFRunLoop &#123;</span><br><span class="line">    pthread_t _pthread; &#x2F;&#x2F;çº¿ç¨‹</span><br><span class="line">    CFMutableSetRef _commonModes; &#x2F;&#x2F;modes</span><br><span class="line">    CFMutableSetRef _commonModeItems; &#x2F;&#x2F;modeItems</span><br><span class="line">    CFRunLoopModeRef _currentMode; &#x2F;&#x2F;å½“å‰çš„mode</span><br><span class="line">    CFMutableSetRef _modes; &#x2F;&#x2F;æ‰€æœ‰çš„modes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><code>runloop</code>ä¸­åŒ…å«ä¸€ä¸ªçº¿ç¨‹<code>_pthread</code>ï¼Œä¸€ä¸€å¯¹åº”çš„</li><li><code>CFMutableSetRef _modes</code>å¯ä»¥æœ‰å¤šä¸ª<code>mode</code></li><li><code>CFRunLoopModeRef _currentMode</code>å½“å‰<code>mode</code>åªèƒ½æœ‰ä¸€ä¸ª</li></ol><p>é‚£ä¹ˆmodeé‡Œè¾¹æœ‰ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿæˆ‘ä»¬çŒœæµ‹ä»–åº”è¯¥å’Œ<code>runloop</code>ç±»ä¼¼ï¼Œåœ¨æºç ä¸­æœç´¢<code>CFRuntimeBase _base</code>çœ‹åˆ°åœ¨<code>runloop.c  line 524</code>çœ‹åˆ°å…·ä½“çš„å†…å®¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">struct __CFRunLoopMode &#123;</span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    pthread_mutex_t _lock;&#x2F;* must have the run loop locked before locking this *&#x2F;</span><br><span class="line">    CFStringRef _name;</span><br><span class="line">    Boolean _stopped;</span><br><span class="line">    char _padding[3];</span><br><span class="line">    CFMutableSetRef _sources0;</span><br><span class="line">    CFMutableSetRef _sources1;</span><br><span class="line">    CFMutableArrayRef _observers;</span><br><span class="line">    CFMutableArrayRef _timers;</span><br><span class="line">    CFMutableDictionaryRef _portToV1SourceMap;</span><br><span class="line">    __CFPortSet _portSet;</span><br><span class="line">    CFIndex _observerMask;</span><br><span class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</span><br><span class="line">    dispatch_source_t _timerSource;</span><br><span class="line">    dispatch_queue_t _queue;</span><br><span class="line">    Boolean _timerFired; &#x2F;&#x2F; set to true by the source when a timer has fired</span><br><span class="line">    Boolean _dispatchTimerArmed;</span><br><span class="line">#endif</span><br><span class="line">#if USE_MK_TIMER_TOO</span><br><span class="line">    mach_port_t _timerPort;</span><br><span class="line">    Boolean _mkTimerArmed;</span><br><span class="line">#endif</span><br><span class="line">#if DEPLOYMENT_TARGET_WINDOWS</span><br><span class="line">    DWORD _msgQMask;</span><br><span class="line">    void (*_msgPump)(void);</span><br><span class="line">#endif</span><br><span class="line">    uint64_t _timerSoftDeadline; &#x2F;* TSR *&#x2F;</span><br><span class="line">    uint64_t _timerHardDeadline; &#x2F;* TSR *&#x2F;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>ç»è¿‡ç®€åŒ–ä¹‹åæ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct __CFRunLoopMode &#123;</span><br><span class="line">    CFStringRef _name;&#x2F;&#x2F;å½“å‰modeçš„åå­—</span><br><span class="line">    CFMutableSetRef _sources0;&#x2F;&#x2F;souces0</span><br><span class="line">    CFMutableSetRef _sources1;&#x2F;&#x2F;sources1</span><br><span class="line">    CFMutableArrayRef _observers;&#x2F;&#x2F;observers</span><br><span class="line">    CFMutableArrayRef _timers;&#x2F;&#x2F;timers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ª<code>mode</code>å¯ä»¥æœ‰å¤šä¸ª<code>timer</code>ã€<code>souces0</code>ã€<code>souces1</code>ã€<code>observers</code>ã€<code>timers</code><br>é‚£ä¹ˆä½¿ç”¨å›¾æ›´ç›´è§‚çš„æ¥è¡¨ç¤ºï¼š</p><p><img src="/images/9-1.png" alt></p><p>ä¸€ä¸ª<code>runloop</code>åŒ…å«å¤šä¸ª<code>mode</code>ï¼Œä½†æ˜¯åŒæ—¶åªèƒ½è¿è¡Œä¸€ä¸ª<code>mode</code>ï¼Œè¿™ç‚¹å’Œå¤§å®¶å¼€è½¦çš„é©¾é©¶æ¨¡å¼ç±»ä¼¼ï¼Œè¿åŠ¨æ¨¡å¼å’Œç¯ä¿æ¨¡å¼åŒæ—¶åªèƒ½å¼€ä¸€ä¸ªæ¨¡å¼ï¼Œä¸èƒ½åˆè¿åŠ¨åˆç¯ä¿ï¼Œæ˜æ˜¾ç›¸æ‚–ã€‚å¤šä¸ª<code>mode</code>è¢«éš”ç¦»å¼€æœ‰ç‚¹æ˜¯å¤„ç†äº‹æƒ…æ›´ä¸“ä¸€ï¼Œä¸ä¼šå› ä¸ºå¤šä¸ªåŒæ—¶å¤„ç†äº‹æƒ…é€ æˆå¡é¡¿æˆ–è€…èµ„æºç«äº‰å¯¼è‡´çš„ä¸€ç³»åˆ—é—®é¢˜ã€‚</p><h4 id="souces0"><a href="#souces0" class="headerlink" title="souces0"></a>souces0</h4><ul><li>è§¦æ‘¸äº‹ä»¶</li><li>performSelector:onThread:</li></ul><p>æµ‹è¯•ä¸‹ç‚¹å‡»äº‹ä»¶å¤„ç†æº</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);&#x2F;&#x2F;æ­¤å¤„æ–­ç‚¹</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(LLDB) bt &#x2F;&#x2F;è¾“å‡ºå½“å‰è°ƒç”¨æ ˆ</span><br><span class="line">* thread #1, queue &#x3D; &#39;com.apple.main-thread&#39;, stop reason &#x3D; breakpoint 1.1</span><br><span class="line">  * frame #0: 0x000000010c5bb66d CFRunloop&#96;::-[ViewController touchesBegan:withEvent:](self&#x3D;0x00007fc69ec087e0, _cmd&#x3D;&quot;touchesBegan:withEvent:&quot;, touches&#x3D;1 element, event&#x3D;0x00006000012a01b0) at ViewController.mm:22:2</span><br><span class="line">    frame #1: 0x0000000110685a09 UIKitCore&#96;forwardTouchMethod + 353</span><br><span class="line">    frame #2: 0x0000000110685897 UIKitCore&#96;-[UIResponder touchesBegan:withEvent:] + 49</span><br><span class="line">    frame #3: 0x0000000110694c48 UIKitCore&#96;-[UIWindow _sendTouchesForEvent:] + 1869</span><br><span class="line">    frame #4: 0x00000001106965d2 UIKitCore&#96;-[UIWindow sendEvent:] + 4079</span><br><span class="line">    frame #5: 0x0000000110674d16 UIKitCore&#96;-[UIApplication sendEvent:] + 356</span><br><span class="line">    frame #6: 0x0000000110745293 UIKitCore&#96;__dispatchPreprocessedEventFromEventQueue + 3232</span><br><span class="line">    frame #7: 0x0000000110747bb9 UIKitCore&#96;__handleEventQueueInternal + 5911</span><br><span class="line">    frame #8: 0x000000010d8eabe1 CoreFoundation&#96;__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 17</span><br><span class="line">    frame #9: 0x000000010d8ea463 CoreFoundation&#96;__CFRunLoopDoSources0 + 243</span><br><span class="line">    frame #10: 0x000000010d8e4b1f CoreFoundation&#96;__CFRunLoopRun + 1231</span><br><span class="line">    frame #11: 0x000000010d8e4302 CoreFoundation&#96;CFRunLoopRunSpecific + 626</span><br><span class="line">    frame #12: 0x0000000115ddc2fe GraphicsServices&#96;GSEventRunModal + 65</span><br><span class="line">    frame #13: 0x000000011065aba2 UIKitCore&#96;UIApplicationMain + 140</span><br><span class="line">    frame #14: 0x000000010c5bb760 CFRunloop&#96;main(argc&#x3D;1, argv&#x3D;0x00007ffee3643f68) at main.m:14:13</span><br><span class="line">    frame #15: 0x000000010f1cb541 libdyld.dylib&#96;start + 1</span><br><span class="line">    frame #16: 0x000000010f1cb541 libdyld.dylib&#96;start + 1</span><br></pre></td></tr></table></figure><p><code>#1</code>çœ‹åˆ°ç°åœ¨æ˜¯åœ¨é˜Ÿåˆ—queue = â€˜com.apple.main-threadâ€™ä¸­ï¼Œ<code>#10</code> <code>Runloop</code>å¯åŠ¨ï¼Œ<code>#9</code>è¿›å…¥åˆ°<code>__CFRunLoopDoSources0</code>,æœ€ç»ˆ<code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</code>è°ƒç”¨äº†<code>__handleEventQueueInternal</code>-&gt;<code>[UIApplication sendEvent:]</code>-&gt;<code>[UIWindow sendEvent:]</code>-&gt;<code>[UIWindow _sendTouchesForEvent:]</code>-&gt;<code>[UIResponder touchesBegan:withEvent:]</code>-&gt;<code>-[ViewController touchesBegan:withEvent:](self=0x00007fc69ec087e0, _cmd=&quot;touchesBegan:withEvent:&quot;, touches=1 element, event=0x00006000012a01b0) at ViewController.mm:22:2</code>ï¼Œå¯ä»¥çœ‹åˆ°å¦å¤–ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œæ‰‹åŠ¿çš„ä¼ é€’æ˜¯ä»ä¸Šå¾€ä¸‹çš„ï¼Œé¡ºåºæ˜¯<code>UIApplication -&gt; UIWindow -&gt; UIResponder -&gt; ViewController</code>ã€‚</p><h4 id="Source1"><a href="#Source1" class="headerlink" title="Source1"></a>Source1</h4><ul><li>åŸºäºPortçš„çº¿ç¨‹é—´é€šä¿¡</li><li>ç³»ç»Ÿäº‹ä»¶æ•æ‰</li></ul><h4 id="Timers"><a href="#Timers" class="headerlink" title="Timers"></a>Timers</h4><ul><li>NSTimer</li><li>performSelector:withObject:afterDelay:</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">timer &#x3D; dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, dispatch_get_main_queue());</span><br><span class="line">static int count &#x3D; 5;</span><br><span class="line">dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC, 0 * NSEC_PER_SEC);</span><br><span class="line">dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">NSLog(@&quot;-------ï¼š%d \n&quot;,count++);</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_resume(timer);</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">(lldb) bt</span><br><span class="line">* thread #1, queue &#x3D; &#39;com.apple.main-thread&#39;, stop reason &#x3D; breakpoint 1.1</span><br><span class="line">  * frame #0: 0x0000000101f26457 CFRunloop&#96;::__29-[ViewController viewDidLoad]_block_invoke(.block_descriptor&#x3D;0x0000000101f28100) at ViewController.mm:72:33</span><br><span class="line">    frame #1: 0x0000000104ac2db5 libdispatch.dylib&#96;_dispatch_client_callout + 8</span><br><span class="line">    frame #2: 0x0000000104ac5c95 libdispatch.dylib&#96;_dispatch_continuation_pop + 552</span><br><span class="line">    frame #3: 0x0000000104ad7e93 libdispatch.dylib&#96;_dispatch_source_invoke + 2249</span><br><span class="line">    frame #4: 0x0000000104acfead libdispatch.dylib&#96;_dispatch_main_queue_callback_4CF + 1073</span><br><span class="line">    frame #5: 0x00000001032568a9 CoreFoundation&#96;__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__ + 9</span><br><span class="line">    frame #6: 0x0000000103250f56 CoreFoundation&#96;__CFRunLoopRun + 2310</span><br><span class="line">    frame #7: 0x0000000103250302 CoreFoundation&#96;CFRunLoopRunSpecific + 626</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè¿›å…¥å‡½æ•°<code>__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__</code>è°ƒç”¨äº†<span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscy9saWJkaXNwYXRjaC8=" title="https://opensource.apple.com/tarballs/libdispatch/">libdispatch<i class="fa fa-external-link"></i></span>çš„<code>_dispatch_main_queue_callback_4CF</code>å‡½æ•°ï¼Œå…·ä½“å®ç°æœ‰å…´è¶£çš„å¤§ä½¬å¯ä»¥çœ‹ä¸‹æºç çš„å®ç°ã€‚</p><h4 id="Observers"><a href="#Observers" class="headerlink" title="Observers"></a>Observers</h4><ul><li>ç”¨äºç›‘å¬RunLoopçš„çŠ¶æ€</li><li>UIåˆ·æ–°ï¼ˆBeforeWaitingï¼‰</li><li>Autorelease poolï¼ˆBeforeWaitingï¼‰</li></ul><p><code>Mode</code>ç±»å‹éƒ½å¤šä¸ª,ç³»ç»Ÿæš´éœ²åœ¨å¤–çš„å°±ä¸¤ä¸ªï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CF_EXPORT const CFRunLoopMode kCFRunLoopDefaultMode;</span><br><span class="line">CF_EXPORT const CFRunLoopMode kCFRunLoopCommonModes;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™ä¸¤ä¸ªModeéƒ½æ˜¯åœ¨ä»€ä¹ˆæƒ…å†µä¸‹è¿è¡Œçš„å‘¢ï¼Ÿ</p><ol><li><code>kCFRunLoopDefaultModeï¼ˆNSDefaultRunLoopModeï¼‰</code>ï¼š<code>App</code>çš„é»˜è®¤<code>Mode</code>ï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ª<code>Mode</code>ä¸‹è¿è¡Œ</li><li><code>UITrackingRunLoopMode</code>ï¼šç•Œé¢è·Ÿè¸ª<code>Mode</code>ï¼Œç”¨äº<code>ScrollView</code> è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»–<code>Mode</code>å½±å“</li></ol><p>è¿›å…¥åˆ°æŸä¸ª<code>Mode</code>ï¼Œå¤„ç†äº‹æƒ…ä¹Ÿåº”è¯¥æœ‰å…ˆåé¡ºåºå’Œä¼‘æ¯çš„æ—¶é—´ï¼Œé‚£ä¹ˆç°åœ¨éœ€è¦ä¸€ä¸ªçŠ¶æ€æ¥è¡¨ç¤ºæ­¤æ—¶æ­¤åˆ»çš„<code>status</code>ï¼Œç³»ç»Ÿå·²ç»å‡†å¤‡äº†<code>CFRunLoopActivity</code>æ¥è¡¨ç¤ºå½“å‰çš„çŠ¶æ€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;</span><br><span class="line">    kCFRunLoopEntry &#x3D; (1UL &lt;&lt; 0), &#x2F;&#x2F;å³å°†è¿›å…¥loop</span><br><span class="line">    kCFRunLoopBeforeTimers &#x3D; (1UL &lt;&lt; 1),&#x2F;&#x2F;å³å°†å¤„ç†timers</span><br><span class="line">    kCFRunLoopBeforeSources &#x3D; (1UL &lt;&lt; 2), &#x2F;&#x2F;å³å°†å¤„ç†sourcs</span><br><span class="line">    kCFRunLoopBeforeWaiting &#x3D; (1UL &lt;&lt; 5),&#x2F;&#x2F;å³å°†è¿›å…¥ä¼‘çœ </span><br><span class="line">    kCFRunLoopAfterWaiting &#x3D; (1UL &lt;&lt; 6),&#x2F;&#x2F;å³å°†ä»ä¼‘çœ ä¸­å”¤é†’</span><br><span class="line">    kCFRunLoopExit &#x3D; (1UL &lt;&lt; 7),&#x2F;&#x2F;å³å°†é€€å‡º</span><br><span class="line">    kCFRunLoopAllActivities &#x3D; 0x0FFFFFFFU&#x2F;&#x2F;æ‰€æœ‰çŠ¶æ€</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>1UL</code>è¡¨ç¤ºæ— ç¬¦å·é•¿æ•´å½¢æ•°å­—<code>1</code>ï¼Œå†æ¬¡çœ‹åˆ°è¿™ä¸ª<code>(1UL &lt;&lt; 1)</code>æˆ‘ä¹ˆçŒœæµ‹ç”¨åˆ°äº†<span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81ZDJiY2YzZGYyNjVkYTFiNjcyMTNkNjk=" title="https://juejin.im/post/5d2bcf3df265da1b67213d69">ä½åŸŸæˆ–è€…è”åˆä½“<i class="fa fa-external-link"></i></span>ï¼Œè¾¾åˆ°çœç©ºé—´çš„ç›®çš„ã€‚<code>kCFRunLoopAllActivities = 0x0FFFFFFFU</code>è½¬æ¢æˆäºŒè¿›åˆ¶å°±æ˜¯28ä¸ª<code>1</code>ï¼Œå†è¿›è¡Œ<code>mask</code>çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å€¼éƒ½èƒ½å–å‡ºæ¥ã€‚</p><p>ç°åœ¨æˆ‘ä»¬äº†è§£åˆ°ï¼š</p><ol><li><code>CFRunloopRef</code>ä»£è¡¨<code>RunLoop</code>çš„è¿è¡Œæ¨¡å¼</li><li>ä¸€ä¸ª<code>Runloop</code>åŒ…å«è‹¥å¹²ä¸ª<code>Mode</code>,æ¯ä¸ª<code>Mode</code>åŒ…å«è‹¥å¹²ä¸ª<code>Source0/Source1/Timer/Obser</code></li><li><code>Runloop</code>å¯åŠ¨åªèƒ½é€‰æ‹©ä¸€ä¸ª<code>Mode</code>ä½œä¸º<code>currentMode</code></li><li>å¦‚æœéœ€è¦åˆ‡æ¢<code>Mode</code>ï¼Œåªèƒ½é€€å‡ºå½“å‰<code>Loop</code>ï¼Œå†é‡æ–°é€‰æ‹©ä¸€ä¸ª<code>Mode</code>è¿›å…¥</li><li>ä¸åŒç»„çš„<code>Source0/Source1/Timer/Observer</code>èƒ½åˆ†éš”å¼€æ¥ï¼Œäº’ä¸å½±å“</li><li>å¦‚æœ<code>Mode</code>æ²¡æœ‰ä»»ä½•<code>Source0/Source1/Timer/Observer</code>ï¼Œ<code>Runloop</code>ç«‹é©¬é€€å‡ºã€‚</li></ol><h5 id="runloopåˆ‡æ¢Mode"><a href="#runloopåˆ‡æ¢Mode" class="headerlink" title="runloopåˆ‡æ¢Mode"></a>runloopåˆ‡æ¢Mode</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">CFRunLoopObserverRef obs&#x3D; CFRunLoopObserverCreateWithHandler(kCFAllocatorDefault, kCFRunLoopAllActivities, YES, 0, ^(CFRunLoopObserverRef observer, CFRunLoopActivity activity) &#123;</span><br><span class="line">    switch (activity) &#123;</span><br><span class="line">    case kCFRunLoopEntry:&#123;</span><br><span class="line">    CFRunLoopMode m &#x3D; CFRunLoopCopyCurrentMode(CFRunLoopGetCurrent());</span><br><span class="line">    NSLog(@&quot;å³å°†è¿›å…¥ mode:%@&quot;,m);</span><br><span class="line">    CFRelease(m);</span><br><span class="line">    break;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    case kCFRunLoopExit:</span><br><span class="line">    &#123;</span><br><span class="line">    CFRunLoopMode m &#x3D; CFRunLoopCopyCurrentMode(CFRunLoopGetCurrent());</span><br><span class="line">    NSLog(@&quot;å³å°†é€€å‡º mode:%@&quot;,m);</span><br><span class="line">    CFRelease(m);</span><br><span class="line">    break;</span><br><span class="line">    &#125;</span><br><span class="line">    default:</span><br><span class="line">    break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line">CFRunLoopAddObserver(CFRunLoopGetMain(), obs, kCFRunLoopCommonModes);</span><br><span class="line">CFRelease(obs);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å½“æ»‘åŠ¨tbçš„æ—¶å€™log</span><br><span class="line"></span><br><span class="line">å³å°†é€€å‡º mode:kCFRunLoopDefaultMode</span><br><span class="line">å³å°†è¿›å…¥ mode:UITrackingRunLoopMode</span><br><span class="line">å³å°†é€€å‡º mode:UITrackingRunLoopMode</span><br><span class="line">å³å°†è¿›å…¥ mode:kCFRunLoopDefaultMode</span><br></pre></td></tr></table></figure><p>å½“<code>runloop</code>åˆ‡æ¢<code>mode</code>çš„æ—¶å€™ï¼Œä¼šé€€å‡ºå½“å‰<code>kCFRunLoopDefaultMode</code>ï¼ŒåŠ å…¥åˆ°å…¶ä»–çš„<code>UITrackingRunLoopMode</code>ï¼Œå½“å‰<code>UITrackingRunLoopMode</code>å®Œæˆä¹‹åå†é€€å‡ºä¹‹åå†åŠ å…¥åˆ°<code>kCFRunLoopDefaultMode</code>ã€‚</p><p>æˆ‘ä»¬å†æ¢ç©¶ä¸‹<code>runloop</code>çš„å¾ªç¯çš„çŠ¶æ€åˆ°åº•æ˜¯æ€æ ·æ¥å˜æ›´çš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F;&#x2F;è·å–loop</span><br><span class="line">CFRunLoopRef ref &#x3D; CFRunLoopGetMain();</span><br><span class="line">&#x2F;&#x2F;è·å–obs</span><br><span class="line">CFRunLoopObserverRef obs &#x3D; CFRunLoopObserverCreate(kCFAllocatorDefault,kCFRunLoopAllActivities, YES, 0, callback, NULL);</span><br><span class="line">&#x2F;&#x2F;æ·»åŠ ç›‘å¬</span><br><span class="line">CFRunLoopAddObserver(ref, obs, CFRunLoopCopyCurrentMode(ref));</span><br><span class="line">CFRelease(obs);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int count &#x3D; 0;&#x2F;&#x2F;å®šä¹‰å…¨å±€å˜é‡æ¥è®¡ç®—ä¸€ä¸ªmodeä¸­çŠ¶æ€åˆ‡æ¢çš„ç»Ÿè®¡æ•°æ®</span><br><span class="line">void callback(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info)&#123;</span><br><span class="line">printf(&quot;- &quot;);</span><br><span class="line">count ++;</span><br><span class="line">printf(&quot;%d&quot;,count);</span><br><span class="line">switch (activity) &#123;</span><br><span class="line">case kCFRunLoopEntry:</span><br><span class="line">printf(&quot;å³å°†è¿›å…¥ \n&quot;);</span><br><span class="line">count &#x3D; 0;</span><br><span class="line">break;</span><br><span class="line">case kCFRunLoopExit:</span><br><span class="line">printf(&quot;å³å°†é€€å‡º \n&quot;);</span><br><span class="line">break;</span><br><span class="line">case kCFRunLoopAfterWaiting:</span><br><span class="line">printf(&quot;å³å°†ä»ä¼‘çœ ä¸­å”¤é†’ \n&quot;);</span><br><span class="line">break;</span><br><span class="line">case kCFRunLoopBeforeTimers:</span><br><span class="line">printf(&quot;å³å°†è¿›å…¥å¤„ç† timers \n&quot;);</span><br><span class="line">break;</span><br><span class="line">case kCFRunLoopBeforeSources:</span><br><span class="line">printf(&quot;å³å°†è¿›å…¥ sources \n&quot;);</span><br><span class="line">break;</span><br><span class="line">case kCFRunLoopBeforeWaiting:</span><br><span class="line">printf(&quot;å³å°†è¿›å…¥ ä¼‘çœ  \n&quot;);</span><br><span class="line">count &#x3D; 0;</span><br><span class="line">break;</span><br><span class="line">default:</span><br><span class="line">break;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ç‚¹å‡»çš„æ—¶å€™ ä¼šå‡ºå‘loopæ¥å¤„ç†è§¦æ‘¸äº‹ä»¶</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">- 1å³å°†ä»ä¼‘çœ ä¸­å”¤é†’ </span><br><span class="line">- 2å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 3å³å°†è¿›å…¥ sources </span><br><span class="line">-[ViewController touchesBegan:withEvent:]</span><br><span class="line">- 4å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 5å³å°†è¿›å…¥ sources </span><br><span class="line">- 6å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 7å³å°†è¿›å…¥ sources </span><br><span class="line">- 8å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 9å³å°†è¿›å…¥ sources </span><br><span class="line">- 10å³å°†è¿›å…¥ ä¼‘çœ  </span><br><span class="line">- 1å³å°†ä»ä¼‘çœ ä¸­å”¤é†’ </span><br><span class="line">- 2å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 3å³å°†è¿›å…¥ sources </span><br><span class="line">- 4å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 5å³å°†è¿›å…¥ sources </span><br><span class="line">- 6å³å°†è¿›å…¥ ä¼‘çœ  </span><br><span class="line">- 1å³å°†ä»ä¼‘çœ ä¸­å”¤é†’ </span><br><span class="line">- 2å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 3å³å°†è¿›å…¥ sources </span><br><span class="line">- 4å³å°†è¿›å…¥ ä¼‘çœ </span><br></pre></td></tr></table></figure><p><code>runloop</code>å”¤é†’ä¹‹åä¸æ˜¯ç«‹é©¬å¤„ç†äº‹ä»¶çš„ï¼Œè€Œæ˜¯çœ‹çœ‹<code>timer</code>æœ‰æ²¡æœ‰äº‹æƒ…ï¼Œç„¶åæ˜¯<code>sources</code>,å‘ç°æœ‰è§¦æ‘¸äº‹ä»¶å°±å¤„ç†äº†ï¼Œç„¶ååˆå¾ªç¯æŸ¥çœ‹<code>timer</code>å’Œ<code>sources</code>ä¸€èˆ¬å¾ªç¯2æ¬¡è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå¤„ç†<code>source</code>ä¹‹åæ˜¯å¾ªç¯ä¸‰æ¬¡ã€‚</p><h5 id="RunLoopåœ¨ä¸è·å–çš„æ—¶å€™ä¸å­˜åœ¨-è·å–æ‰ç”Ÿæˆ"><a href="#RunLoopåœ¨ä¸è·å–çš„æ—¶å€™ä¸å­˜åœ¨-è·å–æ‰ç”Ÿæˆ" class="headerlink" title="RunLoopåœ¨ä¸è·å–çš„æ—¶å€™ä¸å­˜åœ¨,è·å–æ‰ç”Ÿæˆ"></a>RunLoopåœ¨ä¸è·å–çš„æ—¶å€™ä¸å­˜åœ¨,è·å–æ‰ç”Ÿæˆ</h5><p><code>RunLoop</code>æ˜¯åœ¨ä¸»åŠ¨è·å–çš„æ—¶å€™æ‰ä¼šç”Ÿæˆä¸€ä¸ªï¼Œä¸»çº¿ç¨‹æ˜¯ç³»ç»Ÿè‡ªå·±è°ƒç”¨ç”Ÿæˆçš„ï¼Œå­çº¿ç¨‹å¼€å‘è€…è°ƒç”¨ï¼Œæˆ‘ä»¬çœ‹ä¸‹<code>CFRunLoopGetCurrent</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CFRunLoopRef CFRunLoopGetCurrent(void) &#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    CFRunLoopRef rl &#x3D; (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</span><br><span class="line">    if (rl) return rl;</span><br><span class="line">    return _CFRunLoopGet0(pthread_self());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°åˆ°è¿™é‡Œç›¸ä¿¡å¤§å®¶å·²ç»å¯¹<code>runloop</code>æœ‰äº†åŸºæœ¬çš„è®¤è¯†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†æ¢ç©¶ä¸€ä¸‹åº•å±‚<code>runloop</code>æ˜¯æ€ä¹ˆè¿è½¬çš„ã€‚</p><p>é¦–å…ˆçœ‹å®˜æ–¹ç»™çš„å›¾ï¼š</p><p><img src="/images/9-2.png" alt><br>é‚£æˆ‘åˆæ•´ç†äº†ä¸€ä¸ªè¡¨æ ¼æ¥æ›´ç›´è§‚çš„äº†è§£çŠ¶æ€è¿è½¬</p><table><thead><tr><th style="text-align:center">æ­¥éª¤</th><th style="text-align:center">ä»»åŠ¡</th></tr></thead><tbody><tr><td style="text-align:center">1</td><td style="text-align:center">é€šçŸ¥Observers:è¿›å…¥Loop</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">é€šçŸ¥Observers:å³å°†å¤„ç†Timers</td></tr><tr><td style="text-align:center">3</td><td style="text-align:center">é€šçŸ¥Observers:å³å°†å¤„ç†Sources</td></tr><tr><td style="text-align:center">4</td><td style="text-align:center">å¤„ç†blocks</td></tr><tr><td style="text-align:center">5</td><td style="text-align:center">å¤„ç†Source0(å¯èƒ½å†å¤„ç†Blocks)</td></tr><tr><td style="text-align:center">6</td><td style="text-align:center">å¦‚æœå­˜åœ¨Source1ï¼Œè·³è½¬ç¬¬8æ­¥</td></tr><tr><td style="text-align:center">7</td><td style="text-align:center">é€šçŸ¥Observers:å¼€å§‹ä¼‘çœ </td></tr><tr><td style="text-align:center">8</td><td style="text-align:center">é€šçŸ¥Observers:ç»“æŸä¼‘çœ 1.å¤„ç†Timer2.å¤„ç†GCD Asyn To Main Queue 3.å¤„ç†Source1</td></tr><tr><td style="text-align:center">9</td><td style="text-align:center">å¤„ç†Blocks</td></tr><tr><td style="text-align:center">10</td><td style="text-align:center">æ ¹æ®å‰é¢çš„æ‰§è¡Œç»“æœï¼Œå†³å®šå¦‚ä½•æ“ä½œ1.è¿”å›ç¬¬2æ­¥ï¼Œ2é€€å‡ºloop</td></tr><tr><td style="text-align:center">11</td><td style="text-align:center">é€šçŸ¥Observers:é€€å‡ºLoop</td></tr></tbody></table><p>æŸ¥çœ‹<span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscy9DRi8=" title="https://opensource.apple.com/tarballs/CF/">runloopæºç <i class="fa fa-external-link"></i></span>ä¸­<code>runloop.c</code>2333è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;å…¥å£å‡½æ•°</span><br><span class="line">static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</span><br><span class="line">    uint64_t startTSR &#x3D; mach_absolute_time();</span><br><span class="line"></span><br><span class="line">    if (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">        __CFRunLoopUnsetStopped(rl);</span><br><span class="line">return kCFRunLoopRunStopped;</span><br><span class="line">    &#125; else if (rlm-&gt;_stopped) &#123;</span><br><span class="line">rlm-&gt;_stopped &#x3D; false;</span><br><span class="line">return kCFRunLoopRunStopped;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mach_port_name_t dispatchPort &#x3D; MACH_PORT_NULL;</span><br><span class="line">    Boolean libdispatchQSafe &#x3D; pthread_main_np() &amp;&amp; ((HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; NULL &#x3D;&#x3D; previousMode) || (!HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; 0 &#x3D;&#x3D; _CFGetTSD(__CFTSDKeyIsInGCDMainQ)));</span><br><span class="line">    if (libdispatchQSafe &amp;&amp; (CFRunLoopGetMain() &#x3D;&#x3D; rl) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name)) dispatchPort &#x3D; _dispatch_get_main_queue_port_4CF();</span><br><span class="line">    </span><br><span class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</span><br><span class="line">    mach_port_name_t modeQueuePort &#x3D; MACH_PORT_NULL;</span><br><span class="line">    if (rlm-&gt;_queue) &#123;</span><br><span class="line">        modeQueuePort &#x3D; _dispatch_runloop_root_queue_get_port_4CF(rlm-&gt;_queue);</span><br><span class="line">        if (!modeQueuePort) &#123;</span><br><span class="line">            CRASH(&quot;Unable to get port for run loop mode queue (%d)&quot;, -1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    </span><br><span class="line">    dispatch_source_t timeout_timer &#x3D; NULL;</span><br><span class="line">    struct __timeout_context *timeout_context &#x3D; (struct __timeout_context *)malloc(sizeof(*timeout_context));</span><br><span class="line">    if (seconds &lt;&#x3D; 0.0) &#123; &#x2F;&#x2F; instant timeout</span><br><span class="line">        seconds &#x3D; 0.0;</span><br><span class="line">        timeout_context-&gt;termTSR &#x3D; 0ULL;</span><br><span class="line">    &#125; else if (seconds &lt;&#x3D; TIMER_INTERVAL_LIMIT) &#123;</span><br><span class="line">dispatch_queue_t queue &#x3D; pthread_main_np() ? __CFDispatchQueueGetGenericMatchingMain() : __CFDispatchQueueGetGenericBackground();</span><br><span class="line">timeout_timer &#x3D; dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);</span><br><span class="line">        dispatch_retain(timeout_timer);</span><br><span class="line">timeout_context-&gt;ds &#x3D; timeout_timer;</span><br><span class="line">timeout_context-&gt;rl &#x3D; (CFRunLoopRef)CFRetain(rl);</span><br><span class="line">timeout_context-&gt;termTSR &#x3D; startTSR + __CFTimeIntervalToTSR(seconds);</span><br><span class="line">dispatch_set_context(timeout_timer, timeout_context); &#x2F;&#x2F; source gets ownership of context</span><br><span class="line">dispatch_source_set_event_handler_f(timeout_timer, __CFRunLoopTimeout);</span><br><span class="line">        dispatch_source_set_cancel_handler_f(timeout_timer, __CFRunLoopTimeoutCancel);</span><br><span class="line">        uint64_t ns_at &#x3D; (uint64_t)((__CFTSRToTimeInterval(startTSR) + seconds) * 1000000000ULL);</span><br><span class="line">        dispatch_source_set_timer(timeout_timer, dispatch_time(1, ns_at), DISPATCH_TIME_FOREVER, 1000ULL);</span><br><span class="line">        dispatch_resume(timeout_timer);</span><br><span class="line">    &#125; else &#123; &#x2F;&#x2F; infinite timeout</span><br><span class="line">        seconds &#x3D; 9999999999.0;</span><br><span class="line">        timeout_context-&gt;termTSR &#x3D; UINT64_MAX;</span><br><span class="line">    &#125;</span><br><span class="line">    Boolean didDispatchPortLastTime &#x3D; true;</span><br><span class="line">    int32_t retVal &#x3D; 0;</span><br><span class="line">    do &#123;</span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">        voucher_mach_msg_state_t voucherState &#x3D; VOUCHER_MACH_MSG_STATE_UNCHANGED;</span><br><span class="line">        voucher_t voucherCopy &#x3D; NULL;</span><br><span class="line">#endif</span><br><span class="line">        uint8_t msg_buffer[3 * 1024];</span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">        mach_msg_header_t *msg &#x3D; NULL;</span><br><span class="line">        mach_port_t livePort &#x3D; MACH_PORT_NULL;</span><br><span class="line">#endif</span><br><span class="line">__CFPortSet waitSet &#x3D; rlm-&gt;_portSet;</span><br><span class="line"></span><br><span class="line">        __CFRunLoopUnsetIgnoreWakeUps(rl);</span><br><span class="line">&#x2F;&#x2F;é€šçŸ¥å³å°†å¤„ç†Timers</span><br><span class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers)</span><br><span class="line">__CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</span><br><span class="line">&#x2F;&#x2F;é€šçŸ¥å³å°†å¤„ç†Sources</span><br><span class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources)</span><br><span class="line">__CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</span><br><span class="line">&#x2F;&#x2F;å¤„ç†Blocks</span><br><span class="line">__CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">&#x2F;&#x2F;å¤„ç†Source0</span><br><span class="line">        Boolean sourceHandledThisLoop &#x3D; __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</span><br><span class="line">        if (sourceHandledThisLoop) &#123;</span><br><span class="line">&#x2F;&#x2F;å¤„ç†Block</span><br><span class="line">            __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">&#125;</span><br><span class="line">        Boolean poll &#x3D; sourceHandledThisLoop || (0ULL &#x3D;&#x3D; timeout_context-&gt;termTSR);</span><br><span class="line"></span><br><span class="line">        if (MACH_PORT_NULL !&#x3D; dispatchPort &amp;&amp; !didDispatchPortLastTime) &#123;</span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">            msg &#x3D; (mach_msg_header_t *)msg_buffer;</span><br><span class="line">&#x2F;&#x2F;yåˆ¤æ–­æ˜¯å¦æœ‰Source1</span><br><span class="line">            if (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, sizeof(msg_buffer), &amp;livePort, 0, &amp;voucherState, NULL)) &#123;</span><br><span class="line">&#x2F;&#x2F;æœ‰åˆ™å» handle_msg</span><br><span class="line">                goto handle_msg;</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line">        didDispatchPortLastTime &#x3D; false;</span><br><span class="line">&#x2F;&#x2F;å³å°†è¿›å…¥ä¼‘çœ </span><br><span class="line">if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</span><br><span class="line">&#x2F;&#x2F;å¼€å§‹ä¼‘çœ </span><br><span class="line">__CFRunLoopSetSleeping(rl);</span><br><span class="line"></span><br><span class="line">    __CFPortSetInsert(dispatchPort, waitSet);</span><br><span class="line">        </span><br><span class="line">__CFRunLoopModeUnlock(rlm);</span><br><span class="line">__CFRunLoopUnlock(rl);</span><br><span class="line"></span><br><span class="line">        CFAbsoluteTime sleepStart &#x3D; poll ? 0.0 : CFAbsoluteTimeGetCurrent();</span><br><span class="line"></span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</span><br><span class="line">        do &#123;</span><br><span class="line">            if (kCFUseCollectableAllocator) &#123;</span><br><span class="line"></span><br><span class="line">                memset(msg_buffer, 0, sizeof(msg_buffer));</span><br><span class="line">            &#125;</span><br><span class="line">            msg &#x3D; (mach_msg_header_t *)msg_buffer;</span><br><span class="line">            &#x2F;&#x2F;ç­‰å¾…æ¶ˆæ¯æ¥å”¤é†’å½“å‰çº¿ç¨‹</span><br><span class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line"></span><br><span class="line">            if (modeQueuePort !&#x3D; MACH_PORT_NULL &amp;&amp; livePort &#x3D;&#x3D; modeQueuePort) &#123;</span><br><span class="line">          (_dispatch_runloop_root_queue_perform_4CF(rlm-&gt;_queue));</span><br><span class="line">                if (rlm-&gt;_timerFired) &#123;</span><br><span class="line"></span><br><span class="line">                    rlm-&gt;_timerFired &#x3D; false;</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    if (msg &amp;&amp; msg !&#x3D; (mach_msg_header_t *)msg_buffer) free(msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F; Go ahead and leave the inner loop.</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; while (1);</span><br><span class="line">#else</span><br><span class="line">        if (kCFUseCollectableAllocator) &#123;</span><br><span class="line">            memset(msg_buffer, 0, sizeof(msg_buffer));</span><br><span class="line">        &#125;</span><br><span class="line">        msg &#x3D; (mach_msg_header_t *)msg_buffer;</span><br><span class="line">        __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line">#endif</span><br><span class="line">        </span><br><span class="line">        __CFRunLoopLock(rl);</span><br><span class="line">        __CFRunLoopModeLock(rlm);</span><br><span class="line"></span><br><span class="line">        rl-&gt;_sleepTime +&#x3D; (poll ? 0.0 : (CFAbsoluteTimeGetCurrent() - sleepStart));</span><br><span class="line"></span><br><span class="line">        __CFPortSetRemove(dispatchPort, waitSet);</span><br><span class="line">        </span><br><span class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; user callouts now OK again</span><br><span class="line">__CFRunLoopUnsetSleeping(rl);</span><br><span class="line">if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting))</span><br><span class="line">&#x2F;&#x2F;ç»“æŸä¼‘çœ </span><br><span class="line">__CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</span><br><span class="line">&#x2F;&#x2F;æ ‡ç­¾ handle_msg</span><br><span class="line">        handle_msg:;</span><br><span class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</span><br><span class="line"></span><br><span class="line">        if (MACH_PORT_NULL &#x3D;&#x3D; livePort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_NOTHING();</span><br><span class="line">            &#x2F;&#x2F; handle nothing</span><br><span class="line">        &#125; else if (livePort &#x3D;&#x3D; rl-&gt;_wakeUpPort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_WAKEUP();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</span><br><span class="line">        else if (modeQueuePort !&#x3D; MACH_PORT_NULL &amp;&amp; livePort &#x3D;&#x3D; modeQueuePort) &#123;</span><br><span class="line">&#x2F;&#x2F;è¢«timerå”¤é†’</span><br><span class="line">CFRUNLOOP_WAKEUP_FOR_TIMER();</span><br><span class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">#if USE_MK_TIMER_TOO</span><br><span class="line">        else if (rlm-&gt;_timerPort !&#x3D; MACH_PORT_NULL &amp;&amp; livePort &#x3D;&#x3D; rlm-&gt;_timerPort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</span><br><span class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">&#x2F;&#x2F;è¢«GCDæ¢é†’</span><br><span class="line">        else if (livePort &#x3D;&#x3D; dispatchPort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_DISPATCH();</span><br><span class="line">            __CFRunLoopModeUnlock(rlm);</span><br><span class="line">            __CFRunLoopUnlock(rl);</span><br><span class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)6, NULL);</span><br><span class="line">&#x2F;&#x2F;å¤„ç†GCD</span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)0, NULL);</span><br><span class="line">            __CFRunLoopLock(rl);</span><br><span class="line">            __CFRunLoopModeLock(rlm);</span><br><span class="line">            sourceHandledThisLoop &#x3D; true;</span><br><span class="line">            didDispatchPortLastTime &#x3D; true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">&#x2F;&#x2F;å¤„ç†Source1</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_SOURCE();</span><br><span class="line"></span><br><span class="line">            voucher_t previousVoucher &#x3D; _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, (void *)voucherCopy, os_release);</span><br><span class="line"></span><br><span class="line">            CFRunLoopSourceRef rls &#x3D; __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort);</span><br><span class="line">            if (rls) &#123;</span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">mach_msg_header_t *reply &#x3D; NULL;</span><br><span class="line">sourceHandledThisLoop &#x3D; __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</span><br><span class="line">if (NULL !&#x3D; reply) &#123;</span><br><span class="line">    (void)mach_msg(reply, MACH_SEND_MSG, reply-&gt;msgh_size, 0, MACH_PORT_NULL, 0, MACH_PORT_NULL);</span><br><span class="line">    CFAllocatorDeallocate(kCFAllocatorSystemDefault, reply);</span><br><span class="line">&#125;</span><br><span class="line">#endif</span><br><span class="line">    &#125;</span><br><span class="line">            </span><br><span class="line">            _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, previousVoucher, os_release);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;å¤„ç†bBlock</span><br><span class="line">__CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        </span><br><span class="line">&#x2F;&#x2F;è®¾ç½®è¿”å›å€¼</span><br><span class="line">if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">    retVal &#x3D; kCFRunLoopRunHandledSource;</span><br><span class="line">        &#125; else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</span><br><span class="line">            retVal &#x3D; kCFRunLoopRunTimedOut;</span><br><span class="line">&#125; else if (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">            __CFRunLoopUnsetStopped(rl);</span><br><span class="line">    retVal &#x3D; kCFRunLoopRunStopped;</span><br><span class="line">&#125; else if (rlm-&gt;_stopped) &#123;</span><br><span class="line">    rlm-&gt;_stopped &#x3D; false;</span><br><span class="line">    retVal &#x3D; kCFRunLoopRunStopped;</span><br><span class="line">&#125; else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</span><br><span class="line">    retVal &#x3D; kCFRunLoopRunFinished;</span><br><span class="line">&#125;</span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">        voucher_mach_msg_revert(voucherState);</span><br><span class="line">        os_release(voucherCopy);</span><br><span class="line">#endif</span><br><span class="line">    &#125; while (0 &#x3D;&#x3D; retVal);</span><br><span class="line">    if (timeout_timer) &#123;</span><br><span class="line">        dispatch_source_cancel(timeout_timer);</span><br><span class="line">        dispatch_release(timeout_timer);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        free(timeout_context);</span><br><span class="line">    &#125;</span><br><span class="line">    return retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡åŠè¿›ä¸€æ­¥ç²¾ç®€</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;å…¥å£å‡½æ•°</span><br><span class="line">static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</span><br><span class="line">    uint64_t startTSR &#x3D; mach_absolute_time();</span><br><span class="line"></span><br><span class="line">    if (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">        __CFRunLoopUnsetStopped(rl);</span><br><span class="line">return kCFRunLoopRunStopped;</span><br><span class="line">    &#125; else if (rlm-&gt;_stopped) &#123;</span><br><span class="line">rlm-&gt;_stopped &#x3D; false;</span><br><span class="line">return kCFRunLoopRunStopped;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Boolean didDispatchPortLastTime &#x3D; true;</span><br><span class="line">    int32_t retVal &#x3D; 0;</span><br><span class="line">    do &#123;</span><br><span class="line">        __CFRunLoopUnsetIgnoreWakeUps(rl);</span><br><span class="line">&#x2F;&#x2F;é€šçŸ¥å³å°†å¤„ç†Timers</span><br><span class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers)</span><br><span class="line">__CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</span><br><span class="line">&#x2F;&#x2F;é€šçŸ¥å³å°†å¤„ç†Sources</span><br><span class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources)</span><br><span class="line">__CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</span><br><span class="line">&#x2F;&#x2F;å¤„ç†Blocks</span><br><span class="line">__CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">&#x2F;&#x2F;å¤„ç†Source0</span><br><span class="line">        Boolean sourceHandledThisLoop &#x3D; __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</span><br><span class="line">        if (sourceHandledThisLoop) &#123;</span><br><span class="line">&#x2F;&#x2F;å¤„ç†Block</span><br><span class="line">            __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">&#125;</span><br><span class="line">            msg &#x3D; (mach_msg_header_t *)msg_buffer;</span><br><span class="line">&#x2F;&#x2F;yåˆ¤æ–­æ˜¯å¦æœ‰Source1</span><br><span class="line">            if (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, sizeof(msg_buffer), &amp;livePort, 0, &amp;voucherState, NULL)) &#123;</span><br><span class="line">&#x2F;&#x2F;æœ‰åˆ™å» handle_msg</span><br><span class="line">                goto handle_msg;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å³å°†è¿›å…¥ä¼‘çœ </span><br><span class="line">if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</span><br><span class="line">&#x2F;&#x2F;å¼€å§‹ä¼‘çœ </span><br><span class="line">__CFRunLoopSetSleeping(rl);</span><br><span class="line">        do &#123;</span><br><span class="line">    &#x2F;&#x2F;ç­‰å¾…æ¶ˆæ¯æ¥å”¤é†’å½“å‰çº¿ç¨‹</span><br><span class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line">        &#125; while (1);</span><br><span class="line">#else</span><br><span class="line">if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting))</span><br><span class="line">&#x2F;&#x2F;ç»“æŸä¼‘çœ </span><br><span class="line">__CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</span><br><span class="line">&#x2F;&#x2F;æ ‡ç­¾ handle_msg</span><br><span class="line">        handle_msg:;</span><br><span class="line">&#x2F;&#x2F;è¢«timerå”¤é†’</span><br><span class="line">CFRUNLOOP_WAKEUP_FOR_TIMER();</span><br><span class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">#if USE_MK_TIMER_TOO</span><br><span class="line">        else if (rlm-&gt;_timerPort !&#x3D; MACH_PORT_NULL &amp;&amp; livePort &#x3D;&#x3D; rlm-&gt;_timerPort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</span><br><span class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">&#x2F;&#x2F;è¢«GCDæ¢é†’</span><br><span class="line">        else if (livePort &#x3D;&#x3D; dispatchPort) &#123;</span><br><span class="line">&#x2F;&#x2F;å¤„ç†GCD</span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            CFRunLoopSourceRef rls &#x3D; __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort);</span><br><span class="line">&#x2F;&#x2F;å¤„ç†Source1</span><br><span class="line">sourceHandledThisLoop &#x3D; __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</span><br><span class="line">            &#x2F;&#x2F; Restore the previous voucher</span><br><span class="line">            _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, previousVoucher, os_release);</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F;å¤„ç†bBlock</span><br><span class="line">__CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        </span><br><span class="line">    &#x2F;&#x2F;è®¾ç½®è¿”å›å€¼</span><br><span class="line">if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">    retVal &#x3D; kCFRunLoopRunHandledSource;</span><br><span class="line">        &#125; else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</span><br><span class="line">            retVal &#x3D; kCFRunLoopRunTimedOut;</span><br><span class="line">&#125; else if (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">            __CFRunLoopUnsetStopped(rl);</span><br><span class="line">    retVal &#x3D; kCFRunLoopRunStopped;</span><br><span class="line">&#125; else if (rlm-&gt;_stopped) &#123;</span><br><span class="line">    rlm-&gt;_stopped &#x3D; false;</span><br><span class="line">    retVal &#x3D; kCFRunLoopRunStopped;</span><br><span class="line">&#125; else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</span><br><span class="line">    retVal &#x3D; kCFRunLoopRunFinished;</span><br><span class="line">&#125;</span><br><span class="line">    &#125; while (0 &#x3D;&#x3D; retVal);</span><br><span class="line">    return retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç²¾ç®€åˆ°è¿™é‡ŒåŸºæœ¬éƒ½èƒ½çœ‹æ‡‚äº†ï¼Œè¿˜å†™äº†å¾ˆå¤šæ³¨é‡Šï¼ŒåŸºæœ¬å’Œä¸Šé¢æ•´ç†çš„è¡¨æ ¼ä¸€è‡´ã€‚<br>è¿™é‡Œçš„çº¿ç¨‹ä¼‘çœ <code>__CFRunLoopServiceMachPort</code>æ˜¯è°ƒç”¨å†…æ ¸å‡½æ•°<span class="exturl" data-url="aHR0cDovL3dlYi5taXQuZWR1L2Rhcndpbi9zcmMvbW9kdWxlcy94bnUvb3NmbWsvbWFuL21hY2hfbXNnLmh0bWw=" title="http://web.mit.edu/darwin/src/modules/xnu/osfmk/man/mach_msg.html">mach_msg()<i class="fa fa-external-link"></i></span>è¿›è¡Œä¼‘çœ ï¼Œå’Œæˆ‘ä»¬å¹³æ—¶<code>while(1)</code>å¤§ä¸åŒï¼Œ<code>while(1)</code>å«æ­»å¾ªç¯ï¼Œå…¶å®ç³»ç»Ÿæ¯æ—¶æ¯åˆ»éƒ½åœ¨åˆ¤æ–­æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼Œè€—è´¹å¾ˆé«˜çš„CPUï¼Œå†…æ ¸åˆ™ä¸åŒï¼ŒMachå†…æ ¸æä¾›é¢å‘æ¶ˆæ¯ï¼ŒåŸºäºåŸºç¡€çš„è¿›ç¨‹é—´é€šä¿¡ã€‚</p><h4 id="ä¿æ´»æœºåˆ¶"><a href="#ä¿æ´»æœºåˆ¶" class="headerlink" title="ä¿æ´»æœºåˆ¶"></a>ä¿æ´»æœºåˆ¶</h4><p>ä¸€ä¸ªç¨‹åºè¿è¡Œå®Œæ¯•ç»“æŸäº†å°±æ­»æ‰äº†ï¼Œ<code>timer</code>å’Œå˜é‡ä¹Ÿä¸€æ ·ï¼Œè¿è¡Œå®Œæ¯•å°±ç»“æŸäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆå¯ä»¥ä¿è¯<code>timer</code>ä¸€ç›´æ´»è·ƒå’Œçº¿ç¨‹ä¸ç»“æŸå‘¢ï¼Ÿ</p><h5 id="timerä¿æ´»å’Œå¤šmodeè¿è¡Œ"><a href="#timerä¿æ´»å’Œå¤šmodeè¿è¡Œ" class="headerlink" title="timerä¿æ´»å’Œå¤šmodeè¿è¡Œ"></a>timerä¿æ´»å’Œå¤šmodeè¿è¡Œ</h5><p><code>timer</code>å¯ä»¥æ·»åŠ åˆ°<code>self</code>çš„å±æ€§ä¿è¯ä¸€ç›´æ´»ç€ï¼Œåªè¦<code>self</code>ä¸æ­»ï¼Œ<code>timer</code>å°±ä¸æ­»ã€‚<code>timer</code>é»˜è®¤æ˜¯æ·»åŠ åˆ°<code>NSDefaultRunLoopMode</code>æ¨¡å¼ä¸­ï¼Œå› ä¸º<code>RunLoop</code>åŒæ—¶è¿è¡Œåªèƒ½æœ‰ä¸€ä¸ªæ¨¡å¼ï¼Œé‚£ä¹ˆåœ¨æ»‘åŠ¨<code>scroller</code>çš„æ—¶å€™æ€<code>Timer</code>ä¼šå¡é¡¿åœæ­¢ç›´åˆ°å†æ¬¡åˆ‡æ¢å›æ¥ï¼Œé‚£ä¹ˆå¦‚ä½•ä¿è¯åŒæ—¶ä¸¤ä¸ªæ¨¡å¼éƒ½å¯ä»¥è¿è¡Œå‘¢ï¼Ÿ<br><code>Foundation</code>æä¾›äº†ä¸€ä¸ªAPI<code>(void)addTimer:(NSTimer *)timer forMode:(NSRunLoopMode)mode</code>æ·»åŠ ä¸Šï¼Œ<code>mode</code>å€¼ä¸º<code>NSRunLoopCommonModes</code>å¯ä»¥ä¿è¯åŒæ—¶å…¼é¡¾2ç§æ¨¡å¼ã€‚</p><p>æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static int i &#x3D; 0;</span><br><span class="line">NSTimer *timer&#x3D;[NSTimer timerWithTimeInterval:1 repeats:YES block:^(NSTimer * _Nonnull timer) &#123;</span><br><span class="line">NSLog(@&quot;%d&quot;,++i);</span><br><span class="line">&#125;];</span><br><span class="line">&#x2F;&#x2F;NSRunLoopCommonModes å¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ¨¡å¼ï¼Œå®ƒè¿™è¿˜æ˜¯ä¸€ä¸ªæ ‡è®°</span><br><span class="line">&#x2F;&#x2F;timeråœ¨è®¾ç½®ä¸ºcommonæ¨¡å¼ä¸‹èƒ½è¿è¡Œ</span><br><span class="line">&#x2F;&#x2F;NSRunLoopCommonModes èƒ½åœ¨ _commentModesä¸­æ•°ç»„ä¸­çš„æ¨¡å¼éƒ½å¯ä»¥è¿è¡Œ</span><br><span class="line">&#x2F;&#x2F;[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSDefaultRunLoopMode];&#x2F;&#x2F;é»˜è®¤çš„æ¨¡å¼</span><br><span class="line">[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">2019-07-23 15:14:31 CFRunloop[62358:34093079] 1</span><br><span class="line">2019-07-23 15:14:32 CFRunloop[62358:34093079] 2</span><br><span class="line">2019-07-23 15:14:33 CFRunloop[62358:34093079] 3</span><br><span class="line">2019-07-23 15:14:34 CFRunloop[62358:34093079] 4</span><br><span class="line">2019-07-23 15:14:35 CFRunloop[62358:34093079] 5</span><br><span class="line">2019-07-23 15:14:36 CFRunloop[62358:34093079] 6</span><br><span class="line">2019-07-23 15:14:37 CFRunloop[62358:34093079] 7</span><br><span class="line">2019-07-23 15:14:38 CFRunloop[62358:34093079] 8</span><br></pre></td></tr></table></figure><p>å½“æ»‘åŠ¨çš„æ—¶å€™<code>timer</code>çš„æ—¶å€™ï¼Œ<code>timer</code>è¿˜æ˜¯å¦‚æ­¤ä¸æ»‘ï¼Œæ²¡æœ‰ä¸€ç‚¹åœé¡¿ã€‚<br>æ²¡æœ‰å¡é¡¿ä¹‹åæˆ‘ä»¬<code>VC -&gt; dealloc</code>ä¸­<code>timer</code>è¿˜æ˜¯åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆéœ€è¦åœ¨<code>dealloc</code>ä¸­å»ä¸‹å’Œåˆ é™¤è§‚å¯Ÿè€…</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-(void)dealloc&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">CFRunLoopRemoveObserver(CFRunLoopGetMain(), obs, m);</span><br><span class="line">dispatch_source_cancel(timer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€€å‡º<code>vc</code>ä¹‹å<code>dealloc</code>ç…§å¸¸æ‰§è¡Œï¼Œæ—¥å¿—åªæœ‰<code>-[ViewController dealloc]</code>ï¼Œè€Œä¸”æ•°å­—æ²¡æœ‰ç»§ç»­è¾“å‡ºï¼Œè¯´æ˜åˆ é™¤è§‚å¯Ÿè€…å’Œå–æ¶ˆ<code>source</code>éƒ½æˆåŠŸäº†ã€‚</p><p>é‚£ä¹ˆ<code>NSRunLoopCommonModes</code>æ˜¯å¦å¤–ä¸€ç§æ¨¡å¼å—ï¼Ÿ</p><p>é€šè¿‡æºç æŸ¥çœ‹å¾—çŸ¥ï¼Œåœ¨<code>runloop.c line:1632  line:2608</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (CFStringGetTypeID() &#x3D;&#x3D; CFGetTypeID(curr-&gt;_mode)) &#123;</span><br><span class="line">    doit &#x3D; CFEqual(curr-&gt;_mode, curMode) || (CFEqual(curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    doit &#x3D; CFSetContainsValue((CFSetRef)curr-&gt;_mode, curMode) || (CFSetContainsValue((CFSetRef)curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿˜æœ‰å¾ˆå¤šåœ°æ–¹å‡å¯ä»¥çœ‹å‡ºï¼Œå½“æ˜¯<code>currentMode</code>éœ€è¦å’Œ<code>_mode</code>ç›¸ç­‰æ‰å»æ‰§è¡Œï¼Œå½“æ˜¯<code>kCFRunLoopCommonModes</code>çš„æ—¶å€™ï¼Œåªéœ€è¦åŒ…å«<code>curMode</code>å³å¯æ‰§è¡Œã€‚å¯è§<code>kCFRunLoopCommonModes</code>å…¶å®æ˜¯ä¸€ä¸ªé›†åˆï¼Œä¸æ˜¯æŸä¸ªç‰¹å®šçš„<code>mode</code>ã€‚</p><h5 id="çº¿ç¨‹ä¿æ´»"><a href="#çº¿ç¨‹ä¿æ´»" class="headerlink" title="çº¿ç¨‹ä¿æ´»"></a>çº¿ç¨‹ä¿æ´»</h5><p>çº¿ç¨‹ä¸ºä»€ä¹ˆéœ€è¦ä¿æ´»ï¼Ÿæ€§èƒ½å…¶å®å¾ˆå¤§çš„ç“¶é¢ˆæ˜¯åœ¨äºç©ºé—´çš„ç”³è¯·å’Œé‡Šæ”¾ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡çš„æ—¶å€™åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œä»»åŠ¡ç»“æŸå°±é‡Šæ”¾æ‰è¯¥çº¿ç¨‹ï¼Œå¦‚æœä»»åŠ¡é¢‘ç‡æ¯”è¾ƒé«˜ï¼Œé‚£ä¹ˆä¸€ä¸ªä¸€ç›´æ´»è·ƒçš„çº¿ç¨‹æ¥æ‰§è¡Œæˆ‘ä»¬çš„ä»»åŠ¡å°±çœå»ç”³è¯·å’Œé‡Šæ”¾ç©ºé—´çš„æ—¶é—´å’Œæ€§èƒ½ã€‚ä¸Šè¾¹å·²ç»è®²è¿‡äº†<br><code>runloop</code>éœ€è¦æœ‰ä»»åŠ¡æ‰èƒ½ä¸é€€å‡ºï¼Œæ€»ä¸å¯èƒ½ç›´æ¥è®©ä»–æ‰§è¡Œ<code>while(1)</code>å§ï¼Œè¿™ç§æ–¹æ³•æ˜æ˜¾ä¸å¯¹çš„ï¼Œç”±æºç å¾—çŸ¥ï¼Œå½“æœ‰ç›‘æµ‹ç«¯å£çš„æ—¶å€™ï¼Œä¹Ÿä¸ä¼šé€€å‡ºï¼Œä¹Ÿä¸ä¼šå½±å“åº”èƒ½ã€‚æ‰€ä»¥åœ¨çº¿ç¨‹åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[[NSRunLoop currentRunLoop] addPort:[NSPort port] </span><br><span class="line">                            forMode:NSRunLoopCommonModes];</span><br></pre></td></tr></table></figure><p>æ¥ä¿æ´»ã€‚<br>åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œç³»ç»Ÿå·²ç»åœ¨APPå¯åŠ¨çš„æ—¶å€™è¿›è¡Œäº†è°ƒç”¨ï¼Œåˆ™å·²ç»åŠ å…¥åˆ°å…¨å±€çš„å­—å…¸ä¸­äº†ã€‚</p><p>éªŒè¯çº¿ç¨‹ä¿æ´»</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic,strong) FYThread *thread;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">[super viewDidLoad];</span><br><span class="line">self.thread&#x3D;[[FYThread alloc]initWithTarget:self selector:@selector(test) object:nil];</span><br><span class="line">_thread.name &#x3D; @&quot;test thread&quot;;</span><br><span class="line">[_thread start];</span><br><span class="line">&#125;</span><br><span class="line">- (void)test &#123;</span><br><span class="line">&#x2F;&#x2F;æ·»åŠ ç«¯å£</span><br><span class="line">[[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSDefaultRunLoopMode];</span><br><span class="line"></span><br><span class="line">NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">NSLog(@&quot;--start--&quot;);</span><br><span class="line">[[NSRunLoop currentRunLoop] run];</span><br><span class="line">NSLog(@&quot;--end--&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">[self performSelector:@selector(alive) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">NSLog(@&quot;æ‰§è¡Œå®Œæ¯•äº†å­çº¿ç¨‹&quot;);&#x2F;&#x2F;ä¸æ‰§è¡Œ å› ä¸ºå­çº¿ç¨‹ä¿æ´»äº† ä¸ä¼šæ‰§è¡Œå®Œæ¯•</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;æµ‹è¯•å­çº¿ç¨‹æ˜¯å¦è¿˜æ´»ç€</span><br><span class="line">- (void)alive&#123;</span><br><span class="line">NSLog(@&quot;æˆ‘è¿˜æ´»ç€å‘¢-&gt;%@&quot;,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">&#x2F;&#x2F;æ³¨é‡Šæ‰æ·»åŠ ç«¯å£ä»£ç </span><br><span class="line">&lt;FYThread: 0x6000013a9540&gt;&#123;number &#x3D; 3, name &#x3D; test thread&#125;</span><br><span class="line">--start--</span><br><span class="line">--end--</span><br><span class="line">-[ViewController touchesBegan:withEvent:]</span><br><span class="line">æ‰§è¡Œå®Œæ¯•äº†å­çº¿ç¨‹</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;æ³¨é‡Šæ”¾å¼€çš„æ—¶å€™ç‚¹å‡»è§¦å‘log</span><br><span class="line">&lt;FYThread: 0x6000013a9540&gt;&#123;number &#x3D; 3, name &#x3D; test thread&#125;</span><br><span class="line">--start--</span><br><span class="line"></span><br><span class="line">-[ViewController touchesBegan:withEvent:]</span><br><span class="line">æ‰§è¡Œå®Œæ¯•äº†å­çº¿ç¨‹</span><br><span class="line">æˆ‘è¿˜æ´»ç€å‘¢-&gt;&lt;FYThread: 0x6000017e5c80&gt;&#123;number &#x3D; 3, name &#x3D; test thread&#125;</span><br></pre></td></tr></table></figure><p><code>[[NSRunLoop currentRunLoop] addPort:[NSPort port]forMode:NSDefaultRunLoopMode]</code>æ·»åŠ ç«¯å£æ³¨é‡Šæ‰ï¼Œç›´æ¥æ‰§è¡Œäº†<code>--end--</code>ï¼Œçº¿ç¨‹è™½ç„¶<code>strong</code>å¼ºå¼•ç”¨ï¼Œä½†æ˜¯<code>runloop</code>å·²ç»é€€å‡ºäº†ï¼Œæ‰€ä»¥å‡½æ•°<code>alive</code>æ²¡æœ‰æ‰§è¡Œï¼Œä¸æ³¨é‡Šçš„è¯ï¼Œ<code>alive</code>è¿˜ä¼šæ‰§è¡Œï¼Œ<code>end</code>ä¸€ç›´ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºè¿›å…¥äº†<code>runloop</code>ï¼Œè€Œä¸”æ²¡æœ‰é€€å‡ºï¼Œä»£ç å°±ä¸ä¼šå‘ä¸‹æ‰§è¡Œã€‚</p><p>é‚£æˆ‘ä»¬æµ‹è¯•ä¸‹è¯¥çº¿ç¨‹å£°æ˜å‘¨æœŸå¤šé•¿ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">[super viewDidLoad];</span><br><span class="line">self.thread&#x3D;[[FYThread alloc]initWithTarget:self selector:@selector(test) object:nil];</span><br><span class="line">_thread.name &#x3D; @&quot;test thread&quot;;</span><br><span class="line">[_thread start];</span><br><span class="line">&#125;</span><br><span class="line">- (void)test &#123;</span><br><span class="line">[[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSDefaultRunLoopMode];</span><br><span class="line">&#x2F;&#x2F;è·å–obs</span><br><span class="line">NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">NSLog(@&quot;--start--&quot;);</span><br><span class="line">&#x2F;*</span><br><span class="line"> If no input sources or timers are attached to the run loop, this method exits immediately; otherwise, it runs the receiver in the NSDefaultRunLoopMode by repeatedly invoking runMode:beforeDate:. In other words, this method effectively begins an infinite loop that processes data from the run loopâ€™s input sources and timers.</span><br><span class="line"> *&#x2F;</span><br><span class="line">[[NSRunLoop currentRunLoop] run];</span><br><span class="line">NSLog(@&quot;--end--&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">[self performSelector:@selector(alive) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">NSLog(@&quot;æ‰§è¡Œå®Œæ¯•äº†å­çº¿ç¨‹&quot;);&#x2F;&#x2F;ä¸æ‰§è¡Œ å› ä¸ºå­çº¿ç¨‹ä¿æ´»äº† ä¸ä¼šæ‰§è¡Œå®Œæ¯•</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;è¿”å›ä¸Šé¡µ</span><br><span class="line">- (IBAction)popVC:(id)sender &#123;</span><br><span class="line">[self performSelector:@selector(stop) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;æµ‹è¯•å­çº¿ç¨‹æ˜¯å¦è¿˜æ´»ç€</span><br><span class="line">- (void)alive&#123;</span><br><span class="line">NSLog(@&quot;æˆ‘è¿˜æ´»ç€å‘¢-&gt;%@&quot;,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;åœæ­¢å­çº¿ç¨‹çº¿ç¨‹</span><br><span class="line">- (void)stop&#123;</span><br><span class="line">CFRunLoopStop(CFRunLoopGetCurrent());</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">&lt;FYThread: 0x600003394780&gt;&#123;number &#x3D; 3, name &#x3D; test thread&#125;</span><br><span class="line">--start--</span><br><span class="line">-[ViewController stop]</span><br><span class="line">-[ViewController stop]</span><br></pre></td></tr></table></figure><p>æ‹¥æœ‰è¯¥çº¿ç¨‹çš„æ˜¯<code>VC</code>ï¼Œç‚¹å‡»<code>pop</code>çš„æ—¶å€™ï¼Œä½†æ˜¯<code>VC</code>å’Œ<code>thread</code>æ²¡é‡Šæ”¾æ‰,å¥½åƒ<code>thread</code>å’Œ<code>VC</code>å»ºç«‹çš„å¾ªç¯å¼•ç”¨ï¼Œå½“<code>self.thread=[[FYThread alloc]initWithTarget:self selector:@selector(test) object:nil];</code>æ³¨é‡Šäº†ï¼Œåˆ™<code>VC</code>å¯ä»¥è¿›è¡Œæ­£å¸¸é‡Šæ”¾ã€‚</p><p>é€šè¿‡æµ‹è¯•äº†è§£åˆ°<br>è¿™ä¸ªçº¿ç¨‹è¾¾åˆ°äº†<strong>æ°¸ç”Ÿ</strong>ï¼Œå°±æ˜¯ä½ æ€ä¸æ­»ä»–ï¼Œç®€ç›´äº†<strong>æ­»å¾…</strong>ã€‚æŸ¥æ‰¾äº†ä¸å°‘èµ„æ–™æ‰å‘ç°å®˜æ–¹æ–‡æ¡£æ‰æ˜¯æœ€ç¨³çš„ã€‚æœ‰å¯¹è¿™å¥<code>[[NSRunLoop currentRunLoop] run]</code>çš„è§£é‡Š</p><blockquote><p>If no input sources or timers are attached to the run loop, this method exits immediately; otherwise, it runs the receiver in the NSDefaultRunLoopMode by repeatedly invoking runMode:beforeDate:. In other words, this method effectively begins an infinite loop that processes data from the run loopâ€™s input sources and timers.</p></blockquote><p>å°±æ˜¯ç³»ç»Ÿå†™äº†ä»¥ä¸€ä¸ªæ­»å¾ªç¯ä½†æ˜¯æ²¡æœ‰é˜»æ­¢ä»–çš„å‚æ•°ï¼Œç›¸å½“äºä¸€ç›´åœ¨å¾ªç¯è°ƒç”¨<br><code>runMode:beforeDate:</code>ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ<br>å®˜æ–¹æ–‡æ¡£ç»™å‡ºäº†è§£å†³æ–¹æ¡ˆ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">BOOL shouldKeepRunning &#x3D; YES; &#x2F;&#x2F; global</span><br><span class="line">NSRunLoop *theRL &#x3D; [NSRunLoop currentRunLoop];</span><br><span class="line">while (shouldKeepRunning &amp;&amp; [theRL runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]]);</span><br></pre></td></tr></table></figure><p>å°†ä»£ç æ”¹æˆä¸‹é¢çš„æˆåŠŸå°†<strong>æ­»å¾…</strong>æ€æ­»äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">- (void)test &#123;</span><br><span class="line">[[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSDefaultRunLoopMode];</span><br><span class="line">&#x2F;&#x2F;è·å–obs</span><br><span class="line">NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">NSLog(@&quot;--start--&quot;);</span><br><span class="line">self.shouldKeepRunning &#x3D; YES;&#x2F;&#x2F;é»˜è®¤è¿è¡Œ</span><br><span class="line">NSRunLoop *theRL &#x3D; [NSRunLoop currentRunLoop];</span><br><span class="line">while (_shouldKeepRunning &amp;&amp; [theRL runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]]);</span><br><span class="line">NSLog(@&quot;--end--&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">[self performSelector:@selector(alive) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">NSLog(@&quot;æ‰§è¡Œå®Œæ¯•äº†å­çº¿ç¨‹&quot;);&#x2F;&#x2F;ä¸æ‰§è¡Œ å› ä¸ºå­çº¿ç¨‹ä¿æ´»äº† ä¸ä¼šæ‰§è¡Œå®Œæ¯•</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;è¿”å›ä¸Šé¡µ</span><br><span class="line">- (IBAction)popVC:(id)sender &#123;</span><br><span class="line">self.shouldKeepRunning &#x3D; NO;</span><br><span class="line">[self performSelector:@selector(stop) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;æµ‹è¯•å­çº¿ç¨‹æ˜¯å¦è¿˜æ´»ç€</span><br><span class="line">- (void)alive&#123;</span><br><span class="line">NSLog(@&quot;æˆ‘è¿˜æ´»ç€å‘¢-&gt;%@&quot;,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;åœæ­¢å­çº¿ç¨‹çº¿ç¨‹</span><br><span class="line">- (void)stop&#123;</span><br><span class="line">CFRunLoopStop(CFRunLoopGetCurrent());</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">[self performSelectorOnMainThread:@selector(pop) withObject:nil waitUntilDone:NO];</span><br><span class="line">&#125;</span><br><span class="line">- (void)pop&#123;</span><br><span class="line">[self.navigationController popViewControllerAnimated:YES];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">&lt;FYThread: 0x600002699fc0&gt;&#123;number &#x3D; 3, name &#x3D; test thread&#125;</span><br><span class="line">--start--</span><br><span class="line">-[ViewController stop]</span><br><span class="line">--end--</span><br><span class="line">-[ViewController dealloc]</span><br><span class="line">-[FYThread dealloc]</span><br></pre></td></tr></table></figure><p>ç‚¹å‡»<code>popVC:</code>é¦–å…ˆå°†<code>self.shouldKeepRunning = NO</code>ï¼Œç„¶å<strong>å­çº¿ç¨‹</strong>æ‰§è¡Œ<code>CFRunLoopStop(CFRunLoopGetCurrent())</code>ï¼Œç„¶ååœ¨<strong>ä¸»çº¿ç¨‹</strong>æ‰§è¡Œ<code>pop</code>å‡½æ•°ï¼Œæœ€ç»ˆè¿”å›ä¸Šçº§é¡µé¢è€Œä¸”æˆåŠŸæ€æ­»<code>VC</code>å’Œ<strong>æ­»å¾…</strong>ã€‚<br>å½“ç„¶è¿™ä¸ª<strong>æ­»å¾…</strong>å…¶å®ä¹Ÿæ˜¯æœ‰ç”¨å¤„çš„ï¼Œå½“ä½¿ç”¨å•ä¾‹æ¨¡å¼ä½œä¸ºä¸‹è½½å™¨çš„æ—¶å€™ä½¿ç”¨<strong>æ­»å¾…</strong>ä¹Ÿæ²¡é—®é¢˜ã€‚è¿™æ ·å­å¤„ç†æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾åœ¨<code>VC</code>çš„<code>dealloc</code>çœ‹çœ‹æ˜¯å¦èƒ½æˆåŠŸã€‚<br>å…³é”®å‡½æ•°ç¨å¾®æ›´æ”¹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åœæ­¢å­çº¿ç¨‹çº¿ç¨‹</span><br><span class="line">- (void)stop&#123;</span><br><span class="line">    if (self.thread &#x3D;&#x3D; nil) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">        [self performSelector:@selector(stopThread) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">&#125;</span><br><span class="line">- (void)stopThread&#123;</span><br><span class="line">    self.shouldKeepRunning &#x3D; NO;</span><br><span class="line">    CFRunLoopStop(CFRunLoopGetCurrent());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">    [self stop];</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç‚¹å‡»è¿”å›æŒ‰é’®<code>VC</code>å’Œçº¿ç¨‹éƒ½æ²¡æ­»ï¼ŒåŸæ¥ä»–ä»¬å½¢æˆäº†å¼ºå¼•ç”¨æ— æ³•é‡Šæ”¾,å°±æ˜¯<code>VC</code>å§‹ç»ˆæ— æ³•æ‰§è¡Œ<code>dealloc</code>ã€‚å°†å‡½æ•°æ”¹æˆ<code>block</code>å®ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__weak typeof(self) __weakSelf &#x3D; self;</span><br><span class="line">self.thread &#x3D; [[FYThread alloc]initWithBlock:^&#123;</span><br><span class="line">    [[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSDefaultRunLoopMode];</span><br><span class="line">    NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">    NSLog(@&quot;--start--&quot;);</span><br><span class="line">    __weakSelf.shouldKeepRunning &#x3D; YES;&#x2F;&#x2F;é»˜è®¤è¿è¡Œ</span><br><span class="line">    NSRunLoop *theRL &#x3D; [NSRunLoop currentRunLoop];</span><br><span class="line">    while (__weakSelf &amp;&amp; __weakSelf.shouldKeepRunning  )&#123;</span><br><span class="line">        [theRL runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];</span><br><span class="line">    &#125;;</span><br><span class="line">    NSLog(@&quot;--end--&quot;);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä¸‹å´©æºƒäº†ï¼Œå´©æºƒåˆ°äº†ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">while (__weakSelf.shouldKeepRunning  )&#123;</span><br><span class="line">        [theRL runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];&#x2F;&#x2F;å´©æºƒçš„åœ°æ–¹</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure><p>æ€ä¹ˆæƒ³æ„Ÿè§‰ä¸å¯¹åŠ²å•Šï¼Œæ€ä¹ˆä¼šä¸è¡Œå‘¢ï¼Ÿ<code>VC</code>é”€æ¯çš„æ—¶å€™è°ƒç”¨å­çº¿ç¨‹<code>stop</code>,æœ€åæ‰“æ–­ç‚¹å‘ç°åˆ°äº†å´©æºƒçš„åœ°æ–¹<code>self</code>å·²ç»ä¸å­˜åœ¨äº†ï¼Œè¯´æ˜æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå¾€å‰æŸ¥æ‰¾ä½¿ç”¨å¼‚æ­¥çš„å‡½æ•°æœ€åå‡ºç°åœ¨äº†<code>[self performSelector:@selector(stopThread) onThread:self.thread withObject:nil waitUntilDone:NO];</code>ï¼Œè¡¨ç¤ºä¸ç”¨ç­‰å¾…<code>stopThread</code>å‡½æ•°æ‰§è¡Œæ—¶é—´ï¼Œç›´æ¥å‘å‰ç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥<code>VC</code>é‡Šæ”¾æ‰äº†ï¼Œ<code>while (__weakSelf.shouldKeepRunning )</code>æ˜¯<code>true</code>ï¼Œè¿˜çœŸè¿›å»äº†ï¼Œè®¿é—®äº†<code>exe_bad_access</code>ï¼Œæ‰€ä»¥æ”¹æˆ<code>while (__weakSelf&amp;&amp;__weakSelf.shouldKeepRunning )</code>å†è·‘ä¸€ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;log</span><br><span class="line"></span><br><span class="line">--start--</span><br><span class="line">-[ViewController stop]</span><br><span class="line">-[ViewController dealloc]</span><br><span class="line">--end--</span><br><span class="line">-[FYThread dealloc]</span><br></pre></td></tr></table></figure><p>å¦‚ç‰›å¥¶èˆ¬ä¸æ»‘ï¼Œè§£å†³äº†é‡Šæ”¾é—®é¢˜ï¼Œä¹Ÿè§£å†³äº†å¤æ‚æ“ä½œã€‚æœ¬æ–‡ç« æ‰€æœ‰ä»£ç å‡åœ¨åº•éƒ¨é“¾æ¥å¯ä»¥ä¸‹è½½ã€‚<br>ä½¿ç”¨è¿™ä¸ªæ€è·¯è‡ªå·±å°è£…äº†ä¸€ä¸ªç®€å•çš„åŠŸèƒ½ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±å°è£…ä¸€ä¸‹ç„¶åå¯¹æ¯”ä¸€ä¸‹æˆ‘çš„æ€è·¯ï¼Œè¯´ä¸å®šæœ‰æƒŠå–œï¼</p><h3 id="èµ„æ–™å‚è€ƒ"><a href="#èµ„æ–™å‚è€ƒ" class="headerlink" title="èµ„æ–™å‚è€ƒ"></a>èµ„æ–™å‚è€ƒ</h3><ul><li><span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscy9DRi8=" title="https://opensource.apple.com/tarballs/CF/">runloopæºç <i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cDovL3d3dy41MjBpdC5jb20venQvaW9zX21qLw==" title="http://www.520it.com/zt/ios_mj/">å°ç å“¥è§†é¢‘<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cDovL2F3YXlxdS4xMDI0dWwuY29tL2lvcy8yMDE4LzA1LzAyL2djZC0zLmh0bWw=" title="http://awayqu.1024ul.com/ios/2018/05/02/gcd-3.html">ä»»åŠ¡è°ƒåº¦<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscy9saWJkaXNwYXRjaC8=" title="https://opensource.apple.com/tarballs/libdispatch/">libdispatch<i class="fa fa-external-link"></i></span><h3 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h3></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½git<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code git<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9vYmpjNC03NTA=" title="https://github.com/ifgyong/demo/tree/master/OC/objc4-750">runtimeå¯è¿è¡Œçš„æºç git<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9PQyVFNiU5QyVBQyVFOCVCNCVBOC9kYXkxNC1DRlJ1bmxvb3AlRTclQkElQkYlRTclQTglOEIlRTQlQkYlOUQlRTYlQjQlQkIlRTUlQjAlODElRTglQTMlODUlRTclOUElODRjJUU4JUFGJUFEJUU4JUE4JTgw" title="https://github.com/ifgyong/demo/tree/master/OC/OC%E6%9C%AC%E8%B4%A8/day14-CFRunloop%E7%BA%BF%E7%A8%8B%E4%BF%9D%E6%B4%BB%E5%B0%81%E8%A3%85%E7%9A%84c%E8%AF%AD%E8%A8%80">threadä¿æ´»cè¯­è¨€ç‰ˆæœ¬<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9PQyVFNiU5QyVBQyVFOCVCNCVBOC9kYXkxNC1DRlJ1bmxvb3AlRTclQkElQkYlRTclQTglOEIlRTQlQkYlOUQlRTYlQjQlQkIlRTUlQjAlODElRTglQTMlODU=" title="https://github.com/ifgyong/demo/tree/master/OC/OC%E6%9C%AC%E8%B4%A8/day14-CFRunloop%E7%BA%BF%E7%A8%8B%E4%BF%9D%E6%B4%BB%E5%B0%81%E8%A3%85">thread ä¿æ´»<i class="fa fa-external-link"></i></span></li></ul><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p><p>å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä½¿ç”¨é’©å­å®ç°äº†å¯¹å­—å…¸å’Œæ•°ç»„çš„èµ‹å€¼çš„æ ¡éªŒï¼Œé¡ºä¾¿éšæ‰‹æ’¸äº†ä¸€ä¸ªç®€å•çš„&lt;code&gt;jsonToModel&lt;/code&gt;,&lt;code&gt;iOS&lt;/code&gt;é™¤äº†&lt;code&gt;runtime&lt;/code&gt;è¿˜æœ‰ä¸€ä¸ªä¸œè¥¿çš„å«åš&lt;code&gt;runloop&lt;/code&gt;ï¼Œå„ä½çœ‹å®˜è€çˆ·ä¸€å®šéƒ½æœ‰äº†è§£ï¼Œ
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç† runtime - superã€hookã€ä»¥åŠç®€å•åº”ç”¨--(8)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20runtime%20-%20super%E3%80%81hook%E3%80%81%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BA%94%E7%94%A8--(8)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20runtime%20-%20super%E3%80%81hook%E3%80%81%E4%BB%A5%E5%8F%8A%E7%AE%80%E5%8D%95%E5%BA%94%E7%94%A8--(8)/</id>
    <published>2019-12-01T03:18:58.000Z</published>
    <updated>2020-09-04T04:40:21.658Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å…³é”®å­—-super"><a href="#å…³é”®å­—-super" class="headerlink" title="å…³é”®å­— super"></a>å…³é”®å­— super</h3><p>å…³é”®å­—<code>super</code>,åœ¨è°ƒç”¨<code>[super init]</code>çš„æ—¶å€™ï¼Œ<code>super</code>ä¼šè½¬åŒ–æˆç»“æ„ä½“<code>__rw_objc_super</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct __rw_objc_super &#123; </span><br><span class="line">struct objc_object *object; &#x2F;&#x2F;æ¶ˆæ¯æ¥å—è€…</span><br><span class="line">struct objc_object *superClass; &#x2F;&#x2F;çˆ¶ç±»</span><br><span class="line">__rw_objc_super(struct objc_object *o, struct objc_object *s) : object(o), superClass(s) &#123;&#125; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>[super init]</code>ä½¿ç”¨å‘½ä»¤<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime=ios-8.0.0 Student.m</code>è½¬åŒ–æˆ<code>cpp</code><br>æ‰“å¼€<code>cpp</code>å¤§æ¦‚åœ¨åº•éƒ¨çš„ä½ç½®æ‰¾åˆ°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Student *(*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super)&#123;(id)self, (id)class_getSuperclass(objc_getClass(&quot;Student&quot;))&#125;, sel_registerName(&quot;init&quot;))</span><br></pre></td></tr></table></figure><p>ç®€åŒ–ä¹‹åæ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(void *)objc_msgSendSuper((__rw_objc_super)&#123;self, class_getSuperclass(objc_getClass(&quot;Student&quot;))&#125;, sel_registerName(&quot;init&quot;))</span><br></pre></td></tr></table></figure><p><code>voidobjc_msgSendSuper(void /* struct objc_super *super, SEL op, ... */ )</code><br>    å…¶å®æ˜¯å‘çˆ¶ç±»å‘é€æ¶ˆæ¯ï¼Œå‚æ•°æ˜¯<code>struct objc_super *super, SEL op, ...</code>ï¼Œæˆ‘ä»¬æºç ä¸­æ‰¾åˆ°äº†è¯¥å‡½æ•°çš„å®ç°åœ¨<code>objc-msg-arm64.s</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ENTRY _objc_msgSendSuper</span><br><span class="line">UNWIND _objc_msgSendSuper, NoFrame</span><br><span class="line">&#x2F;&#x2F;æ ¹æ®ç»“æ„ä½“struct __rw_objc_super </span><br><span class="line">&#123; </span><br><span class="line">&#x2F;&#x2F;struct objc_object *object; &#x2F;&#x2F;æ¶ˆæ¯æ¥å—è€…</span><br><span class="line">&#x2F;&#x2F;struct objc_object *superClass; &#x2F;&#x2F;çˆ¶ç±»</span><br><span class="line">&#125;å ç”¨ç©ºé—´16å­—èŠ‚ï¼Œobjc_msgSendSuperå‚æ•°æ˜¯__rw_objc_superï¼Œ</span><br><span class="line">&#x2F;&#x2F;ä½¿x0åç§»16å­—èŠ‚ï¼Œå°±æ˜¯ä¸¤ä¸ªæŒ‡é’ˆçš„ç©ºé—´ï¼Œèµ‹å€¼ç»™p0 å’Œp16</span><br><span class="line">ldpp0, p16, [x0]&#x2F;&#x2F; p0 &#x3D; self , p16 &#x3D; superclass</span><br><span class="line"></span><br><span class="line">CacheLookup NORMAL&#x2F;&#x2F; calls imp or objc_msgSend_uncached</span><br><span class="line"></span><br><span class="line">END_ENTRY _objc_msgSendSuper</span><br></pre></td></tr></table></figure><p>å°†<code>self</code>å’Œ<code>superclass</code>èµ‹å€¼ç»™ <code>p0, p16</code>è°ƒç”¨<code>CacheLookup NORMAL</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">.macro CacheLookup &#x2F;&#x2F;.macro æ˜¯ä¸€ä¸ªå® ä½¿ç”¨ _cmd&amp;mask æŸ¥æ‰¾ç¼“å­˜ä¸­çš„æ–¹æ³•</span><br><span class="line">&#x2F;&#x2F; p1 &#x3D; SEL, p16 &#x3D; isa</span><br><span class="line">ldpp10, p11, [x16, #CACHE]&#x2F;&#x2F; p10 &#x3D; buckets, p11 &#x3D; occupied|mask</span><br><span class="line">#if !__LP64__</span><br><span class="line">andw11, w11, 0xffff&#x2F;&#x2F; p11 &#x3D; mask</span><br><span class="line">#endif</span><br><span class="line">andw12, w1, w11&#x2F;&#x2F; x12 &#x3D; _cmd &amp; mask</span><br><span class="line">addp12, p10, p12, LSL #(1+PTRSHIFT)</span><br><span class="line">             &#x2F;&#x2F; p12 &#x3D; buckets + ((_cmd &amp; mask) &lt;&lt; (1+PTRSHIFT))</span><br><span class="line"></span><br><span class="line">ldpp17, p9, [x12]&#x2F;&#x2F; &#123;imp, sel&#125; &#x3D; *bucket</span><br><span class="line">1:cmpp9, p1&#x2F;&#x2F; if (bucket-&gt;sel !&#x3D; _cmd)</span><br><span class="line">b.ne2f&#x2F;&#x2F;     scan more</span><br><span class="line">CacheHit $0&#x2F;&#x2F; call or return imp å‘½ä¸­ è°ƒç”¨æˆ–è€…è¿”å›imp</span><br><span class="line"></span><br><span class="line">2:&#x2F;&#x2F; not hit: p12 &#x3D; not-hit bucket æ²¡æœ‰å‘½ä¸­</span><br><span class="line">CheckMiss $0&#x2F;&#x2F; miss if bucket-&gt;sel &#x3D;&#x3D; 0</span><br><span class="line">cmpp12, p10&#x2F;&#x2F; wrap if bucket &#x3D;&#x3D; buckets</span><br><span class="line">b.eq3f</span><br><span class="line">ldpp17, p9, [x12, #-BUCKET_SIZE]!&#x2F;&#x2F; &#123;imp, sel&#125; &#x3D; *--bucket</span><br><span class="line">b1b&#x2F;&#x2F; loop</span><br><span class="line"></span><br><span class="line">3:&#x2F;&#x2F; wrap: p12 &#x3D; first bucket, w11 &#x3D; mask</span><br><span class="line">addp12, p12, w11, UXTW #(1+PTRSHIFT)</span><br><span class="line">                        &#x2F;&#x2F; p12 &#x3D; buckets + (mask &lt;&lt; 1+PTRSHIFT)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Clone scanning loop to miss instead of hang when cache is corrupt.</span><br><span class="line">&#x2F;&#x2F; The slow path may detect any corruption and halt later.</span><br><span class="line"></span><br><span class="line">ldpp17, p9, [x12]&#x2F;&#x2F; &#123;imp, sel&#125; &#x3D; *bucket</span><br><span class="line">1:cmpp9, p1&#x2F;&#x2F; if (bucket-&gt;sel !&#x3D; _cmd)</span><br><span class="line">b.ne2f&#x2F;&#x2F;     scan more</span><br><span class="line">CacheHit $0&#x2F;&#x2F; call or return imp</span><br><span class="line"></span><br><span class="line">2:&#x2F;&#x2F; not hit: p12 &#x3D; not-hit bucket</span><br><span class="line">CheckMiss $0&#x2F;&#x2F; miss if bucket-&gt;sel &#x3D;&#x3D; 0</span><br><span class="line">cmpp12, p10&#x2F;&#x2F; wrap if bucket &#x3D;&#x3D; buckets</span><br><span class="line">b.eq3f</span><br><span class="line">ldpp17, p9, [x12, #-BUCKET_SIZE]!&#x2F;&#x2F; &#123;imp, sel&#125; &#x3D; *--bucket</span><br><span class="line">b1b&#x2F;&#x2F; loop</span><br><span class="line"></span><br><span class="line">3:&#x2F;&#x2F; double wrap</span><br><span class="line">JumpMiss $0</span><br><span class="line"></span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure><p>æ±‡ç¼–æ¯”è¾ƒå¤šï¼Œåªçœ‹åˆ°ç¬¬äºŒè¡Œ<code>p1 = SEL, p16 = isa</code>ï¼ŒæŸ¥æ‰¾ç¼“å­˜æ˜¯ä»<code>p16</code>,ä¹Ÿå°±æ˜¯<code>superclass</code>å¼€å§‹æŸ¥æ‰¾ï¼Œåè¾¹çš„éƒ½å’Œ<code>objc_msgSend</code>ä¸€æ ·ã€‚<br>å¤§è‡´ä¸Šæ¯”è¾ƒæ¸…æ¥šäº†ï¼Œ<code>super</code>æœ¬è´¨ä¸Šè°ƒç”¨äº†<code>objc_msgSendSuper</code>ï¼Œ<code>objc_msgSendSuper</code>æ˜¯æŸ¥æ‰¾ä»çˆ¶ç±»å¼€å§‹æŸ¥æ‰¾æ–¹æ³•ã€‚</p><p><code>[super init]</code>å°±æ˜¯<code>self</code>ç›´æ¥è°ƒç”¨çˆ¶ç±»<code>init</code>çš„æ–¹æ³•ï¼Œä½†æ˜¯<code>objc_msgSend</code>æ¥å—è€…æ˜¯<code>self</code>ï¼Œå‡å¦‚æ˜¯<code>[self init]</code>åˆ™ä¼šäº§ç”Ÿæ­»å¾ªç¯ã€‚<code>[super test]</code>åˆ™æ˜¯æ‰§è¡Œçˆ¶ç±»çš„<code>test</code>ã€‚<br>ä½¿ç”¨<code>Debug Workflow-&gt;Always Show Disassemdly</code>å‘ç°<code>super</code>å…¶å®è°ƒç”¨äº†æ±‡ç¼–çš„<code>objc_msgSendSuper2</code>ï¼Œè¿›å…¥<code>objc_msgSendSuper2 objc-msg-arm64.s 422 è¡Œ</code>å‘ç°å’Œ<code>objc_msgSendSuper</code>å…¶å®åŸºæœ¬ä¸€è‡´çš„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;_objc_msgSendSuper å¼€å§‹</span><br><span class="line">ENTRY _objc_msgSendSuper</span><br><span class="line">UNWIND _objc_msgSendSuper, NoFrame</span><br><span class="line">&#x2F;&#x2F;x0åç§»16å­—èŠ‚ï¼Œå°±æ˜¯ä¸¤ä¸ªæŒ‡é’ˆçš„ç©ºé—´ï¼Œèµ‹å€¼ç»™p0 å’Œp16</span><br><span class="line">ldpp0, p16, [x0]&#x2F;&#x2F; p0 &#x3D; self , p16 &#x3D; superclass</span><br><span class="line">CacheLookup NORMAL&#x2F;&#x2F; calls imp or objc_msgSend_uncached</span><br><span class="line">END_ENTRY _objc_msgSendSuper  &#x2F;&#x2F;_objc_msgSendSuper ç»“æŸ</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;objc_msgLookupSuper2 å¼€å§‹</span><br><span class="line">ENTRY _objc_msgSendSuper2 </span><br><span class="line">UNWIND _objc_msgSendSuper2, NoFrame</span><br><span class="line"></span><br><span class="line">ldpp0, p16, [x0]&#x2F;&#x2F; p0 &#x3D; real receiver, p16 &#x3D; class</span><br><span class="line">&#x2F;&#x2F;å°†å­˜å‚¨å™¨åœ°å€ä¸ºx16+8çš„å­—æ•°æ®è¯»å…¥å¯„å­˜å™¨p16ã€‚</span><br><span class="line">ldrp16, [x16, #SUPERCLASS]&#x2F;&#x2F; p16 &#x3D; class-&gt;superclass</span><br><span class="line">CacheLookup NORMAL</span><br><span class="line">END_ENTRY _objc_msgSendSuper2</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>LLVM</code>è½¬åŒ–æˆä¸­é—´ä»£ç æ¥æŸ¥çœ‹ï¼Œ<code>clang -emit-llvm -S FYCat.m</code>æŸ¥çœ‹å…³é”®å‡½æ•°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define internal void @&quot;\01-[FYCat forwardInvocation:]&quot;(%1*, i8*, %2*) #1 &#123;</span><br><span class="line">    call void bitcast (i8* (%struct._objc_super*, i8*, ...)* @objc_msgSendSuper2 to void (%struct._objc_super*, i8*, %2*)*)(%struct._objc_super* %7, i8* %18, %2* %12)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯<code>forwardInvocation</code>å‡½æ•°çš„è°ƒç”¨ä»£ç ï¼Œç®€åŒ–ä¹‹åæ˜¯<code>objc_msgSendSuper2(self,struct._objc_super i8*,%2*)</code>ï¼Œå°±æ˜¯<code>objc_msgSendSuper2(self,superclass,@selector(forwardInvocation),anInvocation)</code>ã€‚</p><p>éªŒè¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">- (int)age;</span><br><span class="line">-(void)test;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYPerson</span><br><span class="line">- (void)test&#123;</span><br><span class="line">    ;    NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">- (int)age&#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">    return 10;</span><br><span class="line">&#125;</span><br><span class="line">- (NSString *)name&#123;</span><br><span class="line">    return [_name stringByAppendingString:@&quot; eat apple&quot;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@interface FYStudent : FYPerson</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line">@implementation FYStudent</span><br><span class="line">- (void)test&#123;</span><br><span class="line">    [super test]; &#x2F;&#x2F;æ‰§è¡Œçˆ¶ç±»çš„test</span><br><span class="line">    int age &#x3D; [super age]; &#x2F;&#x2F;è·å–çˆ¶ç±»çš„æ–¹æ³• è¿”å›å€¼</span><br><span class="line">    NSLog(@&quot;age is %d&quot;,age);</span><br><span class="line">    NSString * name &#x3D; [self name]; &#x2F;&#x2F;ä»çˆ¶ç±»å¼€å§‹å¯»æ‰¾nameçš„å€¼ï¼Œä½†è¿”å›çš„æ˜¯self.nameçš„å€¼</span><br><span class="line">    NSLog(@&quot;%@&quot;,name);</span><br><span class="line">&#125;</span><br><span class="line">-(int)age&#123;</span><br><span class="line">    return 12;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">-[FYPerson test]</span><br><span class="line">-[FYPerson age]</span><br><span class="line">age is 10</span><br><span class="line">å°æå­ eat apple</span><br></pre></td></tr></table></figure><p><code>test</code>æ˜¯æ‰§è¡Œçˆ¶ç±»çš„æ–¹æ³•ï¼Œ<code>[super age]</code>è·å–çˆ¶ç±»ä¸­å›ºå®šçš„<code>age</code>,<br><code>[self name]</code>ä»çˆ¶ç±»å¼€å§‹å¯»æ‰¾<code>name</code>çš„å€¼ï¼Œä½†è¿”å›çš„æ˜¯<code>self.name</code>çš„å€¼ã€‚</p><h3 id="isMemberOfClass-amp-isKindOfClass"><a href="#isMemberOfClass-amp-isKindOfClass" class="headerlink" title="isMemberOfClass &amp;  isKindOfClass"></a>isMemberOfClass &amp;  isKindOfClass</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">+ (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    return object_getClass((id)self) &#x3D;&#x3D; cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    return [self class] &#x3D;&#x3D; cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls &#x3D; object_getClass((id)self); tcls; tcls &#x3D; tcls-&gt;superclass) &#123;</span><br><span class="line">        printf(&quot;%s %s\n&quot;,class_getName(tcls),class_getName(cls));</span><br><span class="line">        if (tcls &#x3D;&#x3D; cls)</span><br><span class="line">        &#123;return YES;&#125;else&#123;</span><br><span class="line">            printf(&quot;%s&quot;,class_getName(tcls));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls &#x3D; [self class]; tcls; tcls &#x3D; tcls-&gt;superclass) &#123;</span><br><span class="line">        </span><br><span class="line">        printf(&quot; %s %s\n&quot;,class_getName(tcls),class_getName(cls));</span><br><span class="line">        if (tcls &#x3D;&#x3D; cls) return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (BOOL)isSubclassOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls &#x3D; self; tcls; tcls &#x3D; tcls-&gt;superclass) &#123;</span><br><span class="line">        if (tcls &#x3D;&#x3D; cls) return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>- (BOOL)isMemberOfClass</code>å’Œ<code>- (BOOL)isKindOfClass:(Class)cls</code>æ¯”è¾ƒç®€å•ï¼Œéƒ½æ˜¯åˆ¤æ–­<code>self.class</code> å’Œ<code>cls</code>ï¼Œ<code>+ (BOOL)isMemberOfClass:(Class)cls</code>æ˜¯åˆ¤æ–­<code>self.class-&gt;isa</code>æ˜¯å¦å’Œ<code>cls</code>ç›¸ç­‰ï¼Œ<code>+ (BOOL)isKindOfClass:(Class)cls</code>åˆ¤æ–­<code>cls-&gt;isa</code>å’Œ<code>cls-&gt;isa-&gt;isa</code>æœ‰æ²¡æœ‰å¯èƒ½å’Œ<code>cls</code>ç›¸ç­‰ï¼Ÿåªæœ‰åŸºç±»æ˜¯ï¼Œå…¶ä»–çš„éƒ½ä¸æ˜¯ã€‚</p><h4 id="éªŒè¯-å®ä¾‹æ–¹æ³•"><a href="#éªŒè¯-å®ä¾‹æ–¹æ³•" class="headerlink" title="éªŒè¯ å®ä¾‹æ–¹æ³•"></a>éªŒè¯ å®ä¾‹æ–¹æ³•</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Class cls &#x3D; NSObject.class;</span><br><span class="line">Class pcls &#x3D; FYPerson.class;</span><br><span class="line">FYPerson *p&#x3D;[FYPerson new];</span><br><span class="line">NSObject *obj&#x3D;[NSObject new];</span><br><span class="line">BOOL res11 &#x3D;[p isKindOfClass:pcls];</span><br><span class="line">BOOL res12 &#x3D;[p isMemberOfClass:pcls];</span><br><span class="line">BOOL res13 &#x3D;[obj isKindOfClass:cls];</span><br><span class="line">BOOL res14 &#x3D;[obj isMemberOfClass:cls];</span><br><span class="line">NSLog(@&quot;instance:%d %d %d %d&quot;,res11,res12,res13,res14);</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">&#x2F;&#x2F;instance:1 1 1 1</span><br></pre></td></tr></table></figure><p><code>p</code>æ˜¯<code>pcls</code>çš„å­ç±»ï¼Œ<code>obj</code> æ˜¯<code>cls</code>çš„å­ç±»ï¼Œåœ¨æ˜æ˜¾ä¸è¿‡äº†ã€‚</p><h4 id="éªŒè¯-ç±»æ–¹æ³•"><a href="#éªŒè¯-ç±»æ–¹æ³•" class="headerlink" title="éªŒè¯ ç±»æ–¹æ³•"></a>éªŒè¯ ç±»æ–¹æ³•</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#x2F;&#x2F;isKindOfClass cls-&gt;isa å’Œcls&#x2F;cls-&gt;superclassç›¸ç­‰å—?</span><br><span class="line">&#x2F;&#x2F;å…ƒç±»å¯¹è±¡å’Œç±»å¯¹è±¡ä¸ç›¸ç­‰ï¼Œä½†æ˜¯æœ€åä¸€ä¸ªå…ƒç±»çš„isa-&gt;superclassæ˜¯æŒ‡å‘NSObjectçš„class æ‰€ä»¥res1 &#x3D; YES;</span><br><span class="line">&#x2F;&#x2F;cls-&gt;isa:å…ƒç±»å¯¹è±¡ cls-&gt;isa-&gt;superclass: NSObjectç±»å¯¹è±¡</span><br><span class="line">&#x2F;&#x2F;cls:ç±»å¯¹è±¡</span><br><span class="line">BOOL res1 &#x3D;[cls isKindOfClass:cls];</span><br><span class="line">&#x2F;&#x2F;cls-&gt;isa å’Œclsç›¸ç­‰å—ï¼Ÿ ä¸ç›¸ç­‰ cls-&gt;isaæ˜¯å…ƒç±»å¯¹è±¡,clsæ˜¯ç±»å¯¹è±¡ï¼Œä¸å¯èƒ½ç›¸ç­‰ã€‚</span><br><span class="line">BOOL res2 &#x3D;[cls isMemberOfClass:cls];</span><br><span class="line">&#x2F;&#x2F;pcls-&gt;isa:personçš„å…ƒç±»å¯¹è±¡ cls-&gt;isa-&gt;superclass: NSObjectå…ƒç±»ç±»å¯¹è±¡ -&gt;superclass:NSObjectç±»å¯¹è±¡ -&gt;superclass:nil</span><br><span class="line">&#x2F;&#x2F;pcls:personç±»å¯¹è±¡</span><br><span class="line">BOOL res3 &#x3D;[pcls isKindOfClass:pcls];</span><br><span class="line">&#x2F;&#x2F;pcls-&gt;isa:personçš„å…ƒç±»å¯¹è±¡</span><br><span class="line">&#x2F;&#x2F;pcls:personç±»å¯¹è±¡</span><br><span class="line">BOOL res4 &#x3D;[pcls isMemberOfClass:pcls];</span><br><span class="line">NSLog(@&quot;%d %d %d %d&quot;,res1,res2,res3,res4);</span><br><span class="line">ç»“æœï¼š</span><br><span class="line">1 0 0 0</span><br></pre></td></tr></table></figure><h3 id="å †æ ˆ-å¯¹è±¡æœ¬è´¨-classæœ¬è´¨å®æˆ˜"><a href="#å †æ ˆ-å¯¹è±¡æœ¬è´¨-classæœ¬è´¨å®æˆ˜" class="headerlink" title="å †æ ˆ å¯¹è±¡æœ¬è´¨ classæœ¬è´¨å®æˆ˜"></a>å †æ ˆ å¯¹è±¡æœ¬è´¨ classæœ¬è´¨å®æˆ˜</h3><p>ç½‘ä¸Šçœ‹åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„é¢è¯•é¢˜ï¼Œä»Šå¤©æˆ‘ä»¬å°±å€Ÿæ­¤æœºä¼šåˆ†æä¸€ä¸‹,è™½ç„¶ç½‘ä¸Šå¾ˆå¤šåšæ–‡å·²ç»è®²äº†ï¼Œä½†æ˜¯å¥½åƒéƒ½ä¸å¾ˆå¯¹ï¼Œæˆ–è€…æ²¡æœ‰è®²åˆ°æ ¹æœ¬çš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä»Šå¤©å†æ¥æ¢è®¨ä¸€ä¸‹ç©¶ç«Ÿã€‚<br>å…¶å®è¿™é“é¢˜è€ƒå¯Ÿäº†å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€ï¼Œç±»å’Œå¯¹è±¡çš„å…³ç³»ï¼Œå’Œå †ä¸Šçš„å†…å­˜å¸ƒå±€ã€‚åŸºç¡€çŸ¥è¯†ä¸å¾ˆç‰¢å›ºçš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘å†å²çš„åšæ–‡<span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81ZDJkMjAwYmU1MWQ0NTEwYTczMjgxNjE=" title="https://juejin.im/post/5d2d200be51d4510a7328161">obj_msgsendåŸºç¡€<i class="fa fa-external-link"></i></span>ã€<span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81ZDE5YzU5ZTZmYjlhMDdmMDQyMDVmOTU=" title="https://juejin.im/post/5d19c59e6fb9a07f04205f95">ç±»çš„æœ¬è´¨<i class="fa fa-external-link"></i></span>ã€<span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81ZDE1ODg3ZWU1MWQ0NTEwODEyNmQyOGQ=" title="https://juejin.im/post/5d15887ee51d45108126d28d">å¯¹è±¡çš„æœ¬è´¨<i class="fa fa-external-link"></i></span>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">- (void)print;</span><br><span class="line">@end</span><br><span class="line">@implementation FYPerson</span><br><span class="line">- (void)print&#123;</span><br><span class="line">    NSLog(@&quot;my name is %@&quot;,self.name);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    NSObject *fix &#x3D;[NSObject new]; &#x2F;&#x2F; 16å­—èŠ‚ 0x60000219b030</span><br><span class="line">    id cls  &#x3D; [FYPerson class];é’ˆ</span><br><span class="line">    void * obj &#x3D; &amp;cls; </span><br><span class="line">    [(__bridge id)obj print];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é—®é¢˜ä¸€-èƒ½å¦ç¼–è¯‘æˆåŠŸï¼Ÿ"><a href="#é—®é¢˜ä¸€-èƒ½å¦ç¼–è¯‘æˆåŠŸï¼Ÿ" class="headerlink" title="é—®é¢˜ä¸€ èƒ½å¦ç¼–è¯‘æˆåŠŸï¼Ÿ"></a>é—®é¢˜ä¸€ èƒ½å¦ç¼–è¯‘æˆåŠŸï¼Ÿ</h4><p>å½“å¤§å®¶çœ‹åˆ°ç¬¬äºŒä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œä¸å‚»çš„è¯éƒ½ä¼šå›ç­”èƒ½ç¼–è¯‘æˆåŠŸï¼Œå¦åˆ™è¿˜é—®ç»“æœå¹²å˜›ã€‚æˆ‘ä»¬ä»ä¹‹å‰å­¦çš„åªæ˜¯æ¥åˆ†æä¸€ä¸‹ï¼Œè°ƒç”¨æ–¹æ³•æˆåŠŸéœ€è¦æœ‰<code>id self</code>å’Œ<code>SEL sel</code>ï¼Œç°åœ¨<code>cls</code>å’Œ<code>obj</code>éƒ½åœ¨æ ˆåŒºï¼Œ<code>obj</code> æŒ‡é’ˆæŒ‡å‘<code>cls</code>çš„å†…å­˜åœ°å€ï¼Œè®¿é—®<code>obj</code>ç›¸å½“äºç›´æ¥è®¿é—®<code>cls</code>å†…å­˜å­˜å‚¨çš„å€¼ï¼Œ<code>cls</code>å­˜å‚¨çš„æ˜¯<code>Person.class</code>,<code>[obj print]</code> ç›¸å½“äº<code>objc_msgSend(cls,@selector(print))</code>,<code>cls</code>æ˜¯æœ‰<code>print</code>æ–¹æ³•çš„ï¼Œæ‰€ä»¥ä¼šç¼–è¯‘æˆåŠŸã€‚</p><h4 id="è¾“å‡ºä»€ä¹ˆï¼Ÿ"><a href="#è¾“å‡ºä»€ä¹ˆï¼Ÿ" class="headerlink" title="è¾“å‡ºä»€ä¹ˆï¼Ÿ"></a>è¾“å‡ºä»€ä¹ˆï¼Ÿ</h4><p><code>fix/cls/obj</code>è¿™ä¸‰ä¸ªå¯¹è±¡éƒ½æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šï¼Œ<code>fix/cls/obj</code>åœ°å€æ˜¯è¿ç»­ä»é«˜åˆ°ä½çš„ï¼Œè€Œä¸”ä»–ä»¬åœ°å€ç›¸å·®éƒ½æ˜¯<code>8</code>å­—èŠ‚ï¼Œä¸€ä¸ªæŒ‡é’ˆå¤§å°æ˜¯<code>8</code>å­—èŠ‚ã€‚ä»–ä»¬ä¸‰ä¸ªåœ°å€å¦‚ä¸‹æ‰€ç¤ºï¼š</p><p>ä½¿ç”¨å›¾æ¥è¡¨ç¤º<code>fix</code>å’Œ<code>obj</code>ï¼š</p><table><thead><tr><th style="text-align:center">å¯¹è±¡</th><th style="text-align:center">åœ°å€</th><th style="text-align:center">åœ°å€é«˜ä½</th></tr></thead><tbody><tr><td style="text-align:center">fix</td><td style="text-align:center">0x7ffeec3df920</td><td style="text-align:center">é«˜</td></tr><tr><td style="text-align:center">cls</td><td style="text-align:center">0x7ffeec3df918</td><td style="text-align:center">ä¸­</td></tr><tr><td style="text-align:center">obj</td><td style="text-align:center">0x7ffeec3df910</td><td style="text-align:center">ä½</td></tr></tbody></table><p>å¯»æ‰¾å±æ€§å…ˆæ˜¯å¯»æ‰¾<code>isa</code>ï¼Œç„¶åå†åœ¨<code>isa</code>åœ°å€ä¸Š+<code>8</code>åˆ™æ˜¯å±æ€§çš„å€¼ï¼Œæ‰€ä»¥æ ¹æ®<code>obj</code>å¯»æ‰¾<code>cls</code>åœ°å€æ˜¯<code>0x7ffeec3df918</code>,ç„¶å<code>cls</code>åœ°å€+8å­—èŠ‚åˆ™æ˜¯<code>_name</code>çš„åœ°å€ï¼Œ<code>cls</code>åœ°å€æ˜¯<code>0x7ffeec3df918</code>ï¼ŒåŠ ä¸Š<code>8</code>å­—èŠ‚æ­£å¥½æ˜¯<code>fix</code>çš„åœ°å€<code>0x7ffeec3df920</code>ï¼Œå› ä¸ºéƒ½æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥éƒ½æ˜¯<code>8</code>å­—èŠ‚,æ‰€ä»¥æœ€åè¾“å‡ºæ˜¯ç»“æœæ˜¯<code>fix</code>å¯¹è±¡çš„åœ°å€çš„æ•°æ®ã€‚</p><p>æƒ…å†µå†å¤æ‚ä¸€ç‚¹ï¼Œ<code>FYPerson</code>ç»“æ„æ”¹åŠ¨ä¸€ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@property (nonatomic,copy) NSString *name2;</span><br><span class="line">@property (nonatomic,copy) NSString *name3;</span><br><span class="line">- (void)print;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><br>åˆ™ä»–ä»¬çš„<code>_name</code>ã€<code>_name2</code>ã€<code>_name3</code>åˆ™åœ¨<code>cls</code>çš„åœ°å€åŸºç¡€ä¸Šå†å‘ä¸Šå¯»æ‰¾<code>8*1=8/8*2=16/8*3=24</code>å­—èŠ‚ï¼Œå°±æ˜¯å‘ä¸Šå¯»æ‰¾ç¬¬1ä¸ªï¼Œç¬¬2ä¸ªï¼Œç¬¬3ä¸ªæŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆã€‚</p><p>æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@property (nonatomic,copy) NSString *name2;</span><br><span class="line">@property (nonatomic,copy) NSString *name3;</span><br><span class="line">- (void)print;</span><br><span class="line">@end</span><br><span class="line">@implementation FYPerson</span><br><span class="line">- (void)print&#123;</span><br><span class="line">    NSLog(@&quot;name1:%@ name2:%@ name3:%@&quot;,self.name1,self.name2,self.name3);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ä¸»å‡½æ•°</span><br><span class="line"></span><br><span class="line">NSObject *fix &#x3D;[NSObject new];</span><br><span class="line">FYPerson *fix2 &#x3D;[FYPerson new];</span><br><span class="line"></span><br><span class="line">id cls  &#x3D; [FYPerson class];</span><br><span class="line">void * obj &#x3D; &amp;cls; </span><br><span class="line">[(__bridge id)obj print];&#x2F;&#x2F;objc_msgSend(self,sel);</span><br><span class="line">NSLog(@&quot;fix:%p fix2:%p cls:%p obj:%p&quot;,&amp;fix,&amp;fix2,&amp;cls,&amp;obj);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">name1:&lt;FYPerson: 0x6000033a38a0&gt; </span><br><span class="line">name2:&lt;NSObject: 0x6000031f5380&gt; </span><br><span class="line">name3:&lt;ViewController: 0x7f8307505580&gt;</span><br><span class="line"></span><br><span class="line">fix: 0x7ffeec3d f9 28 </span><br><span class="line">fix2:0x7ffeec3d f9 20 </span><br><span class="line">cls: 0x7ffeec3d f9 18 </span><br><span class="line">obj: 0x7ffeec3d f9 10</span><br></pre></td></tr></table></figure><p>å†å˜å½¢ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">&#x2F;*</span><br><span class="line"> objc_msgSuperSend(self,ViewController,sel)</span><br><span class="line"> *&#x2F;</span><br><span class="line">NSLog(@&quot;self:%p ViewController.class:%p SEL:%p&quot;,self,ViewController.class,@selector(viewDidLoad));</span><br><span class="line">    id cls  &#x3D; [FYPerson class];&#x2F;&#x2F;cls æ˜¯ç±»æŒ‡é’ˆ</span><br><span class="line">    void * obj &#x3D; &amp;cls; &#x2F;&#x2F;obj </span><br><span class="line">    [(__bridge id)obj print];&#x2F;&#x2F;objc_msgSend(self,sel);</span><br><span class="line">    </span><br><span class="line"> NSLog(@&quot;cls:%p obj:%p&quot;,&amp;cls,&amp;obj);</span><br><span class="line"> &#x2F;&#x2F;log</span><br><span class="line"> </span><br><span class="line"> name1:&lt;ViewController: 0x7fad03e04ea0&gt; </span><br><span class="line"> name2:ViewController</span><br><span class="line"> </span><br><span class="line"> self:                  0x7fad03e04ea0 </span><br><span class="line"> ViewController.class:  0x10d0edf00 </span><br><span class="line"> SEL:                   0x1117d5687</span><br><span class="line"> </span><br><span class="line"> cls:0x7ffee2b11908 </span><br><span class="line"> obj:0x7ffee2b11900</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>_name1</code>æ˜¯<code>cls</code>åœ°å€å‘ä¸Š+8å­—èŠ‚ï¼Œ<code>_name2</code>æ˜¯å‘ä¸Šç§»åŠ¨16å­—èŠ‚ï¼Œ<code>[super viewDidLoad]</code>æœ¬è´¨ä¸Šæ˜¯<code>objc_msgSuperSend(self,ViewController.class,sel)</code>ï¼Œ<code>self</code>ã€<code>ViewController.class</code>ã€<code>SEL</code>æ˜¯åŒä¸€å—è¿ç»­å†…å­˜ï¼Œå¸ƒå±€ç”±ä½åˆ°é«˜ï¼Œçœ‹äº†ä¸‹å›¾çš„å†…å­˜å¸ƒå±€å°±ä¼šé¡¿æ‚Ÿï¼Œ<br>ç»“æ„ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><table><thead><tr><th style="text-align:center">å¯¹è±¡</th><th style="text-align:center">åœ°å€é«˜ä½</th></tr></thead><tbody><tr><td style="text-align:center">self</td><td style="text-align:center">ä½</td></tr><tr><td style="text-align:center">ViewController.class</td><td style="text-align:center">ä¸­</td></tr><tr><td style="text-align:center">SEL</td><td style="text-align:center">é«˜</td></tr></tbody></table><h3 id="å¸¸ç”¨çš„runtimeAPI"><a href="#å¸¸ç”¨çš„runtimeAPI" class="headerlink" title="å¸¸ç”¨çš„runtimeAPI"></a>å¸¸ç”¨çš„runtimeAPI</h3><table><thead><tr><th style="text-align:center">method</th><th style="text-align:center">desc</th></tr></thead><tbody><tr><td style="text-align:center">Class objc_allocateClassPair(Class superclass, const char *name, size_t extraBytes)</td><td style="text-align:center">åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»ï¼ˆå‚æ•°ï¼šçˆ¶ç±»ï¼Œç±»åï¼Œé¢å¤–çš„å†…å­˜ç©ºé—´</td></tr><tr><td style="text-align:center">void objc_registerClassPair(Class cls))</td><td style="text-align:center">æ³¨å†Œä¸€ä¸ªç±»</td></tr><tr><td style="text-align:center">void objc_disposeClassPair(Class cls)</td><td style="text-align:center">é”€æ¯ä¸€ä¸ªç±»</td></tr><tr><td style="text-align:center">Class objcect_getClass(id obj)</td><td style="text-align:center">è·å–isaæŒ‡å‘çš„class</td></tr><tr><td style="text-align:center">Class object_setClass (id obj,Class cls)</td><td style="text-align:center">è®¾ç½®isaæŒ‡å‘çš„class</td></tr><tr><td style="text-align:center">BOOL object_isClass(id class)</td><td style="text-align:center">åˆ¤æ–­ocå¯¹è±¡æ˜¯å¦ä¸ºClass</td></tr><tr><td style="text-align:center">BOOL class_isMetaClass(Class cls)</td><td style="text-align:center">æ˜¯å¦æ˜¯å…ƒç±»</td></tr><tr><td style="text-align:center">Class class_getSuperclass(Class cls)</td><td style="text-align:center">è·å–çˆ¶ç±»</td></tr><tr><td style="text-align:center">Ivar class_getInstanceVariable(Class cls ,const char * name</td><td style="text-align:center">è·å–ä¸€ä¸ªå®ä¾‹å˜é‡ä¿¡æ¯</td></tr><tr><td style="text-align:center">Ivar <em> class_copyIvarList(Class cls,unsigned int </em> outCount)</td><td style="text-align:center">æ‹·è´å®ä¾‹å˜é‡åˆ—è¡¨ï¼Œéœ€è¦free</td></tr><tr><td style="text-align:center">void object_setIvar(id obj,Ivar ivar,id value</td><td style="text-align:center">è®¾ç½®è·å–å®ä¾‹å˜é‡çš„å€¼</td></tr><tr><td style="text-align:center">id object_getIvar(id obj,Ivar ivar)</td><td style="text-align:center">è·å–å®ä¾‹å˜é‡çš„å€¼</td></tr><tr><td style="text-align:center">BOOL class_addIvar(Class cls,const cahr <em> name ,size_t size,uint_t alignment,const char </em> types)</td><td style="text-align:center">åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡ï¼ˆå·²æ³¨å†Œçš„ç±»ä¸èƒ½åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡ï¼‰</td></tr><tr><td style="text-align:center">const char * ivar_getNameï¼ˆIvar v)</td><td style="text-align:center">è·å–å˜é‡åå­—</td></tr><tr><td style="text-align:center">const char * ivar_getTypeEncoding(Ivar v)</td><td style="text-align:center">å˜é‡çš„encode</td></tr><tr><td style="text-align:center">objc_property_t class_getProperty(Class cls,const char* name)</td><td style="text-align:center">è·å–ä¸€ä¸ªå±æ€§</td></tr><tr><td style="text-align:center">objc_property_t _Nonnull <em> _Nullable class_copyPropertyList(Class _Nullable cls, unsigned int </em> _Nullable outCount)</td><td style="text-align:center">æ‹·è´å±æ€§åˆ—è¡¨</td></tr><tr><td style="text-align:center">objc_property_t _Nullable class_getProperty(Class _Nullable cls, const char * _Nonnull name)</td><td style="text-align:center">è·å–å±æ€§åˆ—è¡¨</td></tr><tr><td style="text-align:center">BOOL class_addProperty(Class _Nullable cls, const char <em> _Nonnull name,const objc_property_attribute_t </em> _Nullable attributes,unsigned int attributeCount)</td><td style="text-align:center">æ·»åŠ å±æ€§</td></tr><tr><td style="text-align:center">void class_replaceProperty(Class _Nullable cls, const char <em> _Nonnull name,const objc_property_attribute_t </em> _Nullable attributes, unsigned int attributeCount)</td><td style="text-align:center">æ›¿æ¢å±æ€§</td></tr><tr><td style="text-align:center">void class_replaceProperty(Class cls, const char <em>name, const objc_property_attribute_t </em>attributes,unsigned int attributeCount)</td><td style="text-align:center">åŠ¨æ€æ›¿æ¢å±æ€§</td></tr><tr><td style="text-align:center">const char * _Nonnull property_getName(objc_property_t _Nonnull property)</td><td style="text-align:center">è·å–name</td></tr><tr><td style="text-align:center">const char * _Nullable property_getAttributes(objc_property_t _Nonnull property)</td><td style="text-align:center">è·å–å±æ€§çš„å±æ€§</td></tr><tr><td style="text-align:center">IMP imp_implementationWithBlock(id block)</td><td style="text-align:center">è·å–blockçš„IMP</td></tr><tr><td style="text-align:center">id imp_getBlock(IMP anIMP)</td><td style="text-align:center">é€šè¿‡imp è·å–block</td></tr><tr><td style="text-align:center">BOOL imp_removeBlock(IMP anIMP)</td><td style="text-align:center">IMPæ˜¯å¦è¢«åˆ é™¤</td></tr><tr><td style="text-align:center">â€¦</td><td style="text-align:center">â€¦</td></tr></tbody></table><p>åœ¨ä¸šåŠ¡ä¸Šæœ‰äº›æ—¶å€™éœ€è¦ç»™ç³»ç»Ÿæ§ä»¶çš„æŸä¸ªå±æ€§èµ‹å€¼ï¼Œä½†æ˜¯ç³»ç»Ÿæ²¡æœ‰æä¾›æ–¹æ³•ï¼Œåªèƒ½é è‡ªå·±äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬<br>è·å–<code>class</code>çš„æ‰€æœ‰æˆå‘˜å˜é‡,å¯ä»¥è·å–<code>Ivar</code>æŸ¥çœ‹æ˜¯å¦æœ‰è¯¥å˜é‡ï¼Œç„¶åå¯ä»¥é€šè¿‡<code>KVC</code>æ¥èµ‹å€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@interface FYCat : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString * name;</span><br><span class="line">@property (nonatomic,assign) int  age;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">FYCat *cat&#x3D;[FYCat new];</span><br><span class="line">unsigned int count &#x3D; 0;</span><br><span class="line">Ivar *vars&#x3D; class_copyIvarList(cat.class, &amp;count);</span><br><span class="line">for (int i &#x3D; 0; i &lt; count; i ++) &#123;</span><br><span class="line">Ivar item &#x3D; vars[i];</span><br><span class="line">const char *name &#x3D; ivar_getName(item);</span><br><span class="line">NSLog(@&quot;%s&quot;,name);</span><br><span class="line">&#125;</span><br><span class="line">free(vars);</span><br><span class="line"></span><br><span class="line">Method *m1&#x3D; class_copyMethodList(cat.class, &amp;count);</span><br><span class="line">for (int i &#x3D; 0; i &lt; count; i ++) &#123;</span><br><span class="line">Method item &#x3D; m1[i];</span><br><span class="line">SEL name &#x3D; method_getName(item);</span><br><span class="line">printf(&quot;method:%s \n&quot;,NSStringFromSelector(name).UTF8String);</span><br><span class="line">&#125;</span><br><span class="line">free(m1);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">_age</span><br><span class="line">_name</span><br><span class="line"></span><br><span class="line">method:.cxx_destruct </span><br><span class="line">method:name </span><br><span class="line">method:setName: </span><br><span class="line">method:methodSignatureForSelector: </span><br><span class="line">method:forwardInvocation: </span><br><span class="line">method:age </span><br><span class="line">method:setAge:</span><br></pre></td></tr></table></figure><p>å¤§å®¶å¸¸ç”¨çš„ä¸€ä¸ªåŠŸèƒ½æ˜¯<code>JsonToModel</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å·²ç»äº†è§£åˆ°äº†<code>runtime</code>çš„åŸºç¡€çŸ¥è¯†ï¼Œç°åœ¨å¯ä»¥è‡ªå·±æ’¸ä¸€ä¸ª<code>JsonToModel</code>äº†ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@interface NSObject (Json)</span><br><span class="line">+ (instancetype)fy_objectWithJson:(NSDictionary *)json;</span><br><span class="line">@end</span><br><span class="line">@implementation NSObject (Json)</span><br><span class="line">+ (instancetype)fy_objectWithJson:(NSDictionary *)json&#123;</span><br><span class="line">id obj &#x3D; [[self alloc]init];</span><br><span class="line">unsigned int count &#x3D; 0;</span><br><span class="line">Ivar *vars&#x3D; class_copyIvarList(self, &amp;count);</span><br><span class="line">for (int i &#x3D; 0; i &lt; count; i ++) &#123;</span><br><span class="line">Ivar item &#x3D; vars[i];</span><br><span class="line">const char *name &#x3D; ivar_getName(item);</span><br><span class="line">NSString * nameOC&#x3D; [NSString stringWithUTF8String:name];</span><br><span class="line">if (nameOC.length&gt;1) &#123;</span><br><span class="line">nameOC &#x3D; [nameOC substringFromIndex:1];</span><br><span class="line">NSString * value &#x3D; json[nameOC];</span><br><span class="line">if ([value isKindOfClass:NSString.class] &amp;&amp; value.length) &#123;</span><br><span class="line">[obj setValue:value forKey:nameOC];</span><br><span class="line">&#125;else if ([value isKindOfClass:NSArray.class])&#123;</span><br><span class="line">[obj setValue:value forKey:nameOC];</span><br><span class="line">&#125;else if ([value isKindOfClass:NSDictionary.class])&#123;</span><br><span class="line">[obj setValue:value forKey:nameOC];</span><br><span class="line">&#125;else if ([value isKindOfClass:[NSNull class]] || [value isEqual:nil])</span><br><span class="line">&#123;</span><br><span class="line">printf(&quot;%s value is nil or null \n&quot;,name);</span><br><span class="line">&#125;else if ([value integerValue] &gt; 0)&#123;</span><br><span class="line">[obj setValue:value forKey:nameOC];</span><br><span class="line">&#125;else&#123;</span><br><span class="line">printf(&quot;æœªçŸ¥é”™è¯¯ \n&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">free(vars);</span><br><span class="line">return obj;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>ç„¶åè‡ªå·±å®šä¹‰ä¸€ä¸ªå­—å…¸ï¼Œæ¥æµ‹è¯•ä¸€ä¸‹è¿™æ®µä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@interface FYCat : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString * name;</span><br><span class="line">@property (nonatomic,assign) int  age;</span><br><span class="line"></span><br><span class="line">- (void)run;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">NSDictionary * info &#x3D; @&#123;@&quot;age&quot;:@&quot;10&quot;,@&quot;value&quot;:@10,@&quot;name&quot;:@&quot;å°æ˜&quot;&#125;;</span><br><span class="line">FYCat *cat&#x3D;[FYCat fy_objectWithJson:info];</span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line">age:10 name:å°æ˜</span><br></pre></td></tr></table></figure><h4 id="hooké’©å­-method-exchangeImplementations"><a href="#hooké’©å­-method-exchangeImplementations" class="headerlink" title="hooké’©å­(method_exchangeImplementations)"></a>hooké’©å­(method_exchangeImplementations)</h4><p>ç”±äºä¸šåŠ¡éœ€æ±‚éœ€è¦åœ¨æŸäº›æŒ‰é’®ç‚¹å‡»äº‹ä»¶è¿›è¡Œè®°å½•æ—¥å¿—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨é’©å­æ¥å®ç°æ‹¦æˆªæ‰€æœ‰buttonçš„ç‚¹å‡»äº‹ä»¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@implementation UIButton (add)</span><br><span class="line">+ (void)load&#123;</span><br><span class="line">Method m1&#x3D; class_getInstanceMethod(self.class, @selector(sendAction:to:forEvent:));</span><br><span class="line">Method m2&#x3D; class_getInstanceMethod(self.class, @selector(fy_sendAction:to:forEvent:));</span><br><span class="line">static dispatch_once_t onceToken;</span><br><span class="line">dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">method_exchangeImplementations(m1, m2);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)fy_sendAction:(SEL)action to:(id)target forEvent:(UIEvent *)event&#123;</span><br><span class="line">NSLog(@&quot;%@ &quot;,NSStringFromSelector(action));</span><br><span class="line">&#x2F;*</span><br><span class="line"> code here</span><br><span class="line"> *&#x2F;</span><br><span class="line"> &#x2F;&#x2F;sel IMP å·²ç»äº¤æ¢è¿‡äº†ï¼Œæ‰€ä»¥ä¸ä¼šæ­»å¾ªç¯</span><br><span class="line">[self fy_sendAction:action to:target forEvent:event];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>å¯ä»¥åœ¨<code>code here</code>æ·»åŠ éœ€è¦å¤„ç†çš„ä»£ç ï¼Œä¸€èˆ¬è®°å½•æ—¥å¿—å’Œå»¶è¿Ÿè§¦å‘éƒ½å¯ä»¥å¤„ç†ã€‚<code>[self fy_sendAction:action to:target forEvent:event];</code>ä¸ä¼šäº§ç”Ÿæ­»å¾ªç¯ï¼ŒåŸå› æ˜¯åœ¨<code>+load</code>ä¸­å·²ç»å°†<code>m1</code>å’Œ<code>m2</code>å·²ç»äº¤æ¢è¿‡äº†<code>IMP</code>ã€‚æˆ‘ä»¬è¿›å…¥åˆ°<code>method_exchangeImplementations</code>å†…éƒ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">void method_exchangeImplementations(Method m1, Method m2)</span><br><span class="line">&#123;</span><br><span class="line">    if (!m1  ||  !m2) return;</span><br><span class="line"></span><br><span class="line">    mutex_locker_t lock(runtimeLock);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;äº¤æ¢IMP</span><br><span class="line">    IMP m1_imp &#x3D; m1-&gt;imp;</span><br><span class="line">    m1-&gt;imp &#x3D; m2-&gt;imp;</span><br><span class="line">    m2-&gt;imp &#x3D; m1_imp;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;åˆ·æ–°ç¼“å­˜</span><br><span class="line">    flushCaches(nil);</span><br><span class="line"></span><br><span class="line">    updateCustomRR_AWZ(nil, m1);</span><br><span class="line">    updateCustomRR_AWZ(nil, m2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct method_t &#123;</span><br><span class="line">    SEL name;</span><br><span class="line">    const char *types;</span><br><span class="line">    MethodListIMP imp;</span><br><span class="line">&#125;;</span><br><span class="line">using MethodListIMP &#x3D; IMP;</span><br></pre></td></tr></table></figure><p><code>m1</code>å’Œ<code>m2</code>äº¤æ¢äº†<code>IMP</code>ï¼Œäº¤æ¢çš„æ˜¯<code>method_t-&gt;imp</code>ï¼Œç„¶ååˆ·æ–°ç¼“å­˜(æ¸…ç©ºç¼“å­˜)ï¼Œç­‰ä¸‹æ¬¡è°ƒç”¨<code>IMP</code>åˆ™éœ€è¦åœ¨<code>cls-&gt;rw-&gt;data-&gt;method</code>ä¸­å»å¯»æ‰¾ã€‚</p><h4 id="æ•°ç»„è¶Šç•Œå’Œnilå¤„ç†"><a href="#æ•°ç»„è¶Šç•Œå’Œnilå¤„ç†" class="headerlink" title="æ•°ç»„è¶Šç•Œå’Œnilå¤„ç†"></a>æ•°ç»„è¶Šç•Œå’Œnilå¤„ç†</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@implementation NSMutableArray (add)</span><br><span class="line">+ (void)load&#123;</span><br><span class="line">Class cls&#x3D; NSClassFromString(@&quot;__NSArrayM&quot;);</span><br><span class="line">Method m1&#x3D; class_getInstanceMethod(cls, @selector(insertObject:atIndex:));</span><br><span class="line">SEL sel &#x3D; @selector(fy_insertObject:atIndex:);</span><br><span class="line">Method m2&#x3D; class_getInstanceMethod(cls, sel);</span><br><span class="line"></span><br><span class="line">Method m3&#x3D; class_getInstanceMethod(cls, @selector(objectAtIndexedSubscript:));</span><br><span class="line">Method m4&#x3D; class_getInstanceMethod(cls, @selector(fy_objectAtIndexedSubscript:));</span><br><span class="line"></span><br><span class="line">static dispatch_once_t onceToken;</span><br><span class="line">dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">method_exchangeImplementations(m1, m2);</span><br><span class="line">method_exchangeImplementations(m3, m4);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)fy_insertObject:(id)anObject atIndex:(NSUInteger)index&#123;</span><br><span class="line">if (anObject !&#x3D; nil) &#123;</span><br><span class="line">[self fy_insertObject:anObject atIndex:index];</span><br><span class="line">&#125;else&#123;</span><br><span class="line">printf(&quot; anObject is nil \n&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (id)fy_objectAtIndexedSubscript:(NSUInteger)idx&#123;</span><br><span class="line">if (self.count &gt; idx) &#123;</span><br><span class="line">return [self fy_objectAtIndexedSubscript:idx];</span><br><span class="line">&#125;else&#123;</span><br><span class="line">printf(&quot; %ld is outof rang \n&quot;,(long)idx);</span><br><span class="line">return nil;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NSMutableArray *array&#x3D;[NSMutableArray array];</span><br><span class="line">id obj &#x3D; nil;</span><br><span class="line">[array addObject:obj];</span><br><span class="line">array[1];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;log</span><br><span class="line"> anObject is nil </span><br><span class="line"> 1 is outof rang</span><br></pre></td></tr></table></figure><p><code>NSMutableArray</code>æ˜¯ç±»ç°‡ï¼Œä½¿ç”¨å·¥å‚æ¨¡å¼ï¼Œ<code>NSMutableArray</code>ä¸æ˜¯æ•°ç»„å®ä¾‹ï¼Œè€Œæ˜¯ç”Ÿäº§æ•°ç»„å¯¹è±¡çš„å·¥å‚ã€‚<br>çœŸå®çš„æ•°ç»„å¯¹è±¡æ˜¯<code>__NSArrayM</code>,ç„¶åç»™<code>__NSArrayM</code>é’©å­ï¼Œäº¤æ¢<code>objectAtIndexedSubscript:(NSUInteger)idx</code>å’Œ<code>insertObject:(id)anObject atIndex:(NSUInteger)index</code>æ–¹æ³•ï¼Œå®ç°å´©æºƒé¿å…ã€‚</p><h4 id="å­—å…¸nilå¤„ç†"><a href="#å­—å…¸nilå¤„ç†" class="headerlink" title="å­—å…¸nilå¤„ç†"></a>å­—å…¸nilå¤„ç†</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@interface NSMutableDictionary (add)</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation NSMutableDictionary (add)</span><br><span class="line">+ (void)load&#123;</span><br><span class="line">    Class cls&#x3D; NSClassFromString(@&quot;__NSDictionaryM&quot;);</span><br><span class="line">    Method m1&#x3D; class_getInstanceMethod(cls, @selector(setObject:forKey:));</span><br><span class="line">&#x2F;&#x2F;    __NSDictionaryM</span><br><span class="line">    SEL sel &#x3D; @selector(fy_setObject:forKey:);</span><br><span class="line">    Method m2&#x3D; class_getInstanceMethod(cls, sel);</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        method_exchangeImplementations(m1, m2);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)fy_setObject:(id)anObject forKey:(id&lt;NSCopying&gt;)aKey&#123;</span><br><span class="line">    if (anObject) &#123;</span><br><span class="line">        [self fy_setObject:anObject forKey:aKey];</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        NSString * key &#x3D; (NSString *)aKey;</span><br><span class="line">        printf(&quot;key:%s anobj is nil \n&quot;,key.UTF8String);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨ç±»åˆ«<code>+load</code>ç»™<code>__NSDictionaryM</code>æ·»åŠ æ–¹æ³•ï¼Œç„¶åäº¤æ¢<code>IMP</code>ï¼Œå®ç°ç»™<code>NSMutableDictionary setObject:Key:</code>çš„æ—¶å€™è¿›è¡Œ<code>nil</code>æ ¡éªŒ,<code>+load</code>è™½ç„¶ç³»ç»Ÿå¯åŠ¨çš„è‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡çš„ï¼Œä½†æ˜¯ä¸ºé˜²æ­¢å¼€å‘è€…å†æ¬¡è°ƒç”¨é€ æˆ<code>IMP</code>å’Œ<code>SEL</code>æ··ä¹±ï¼Œä½¿ç”¨<code>dispatch_once</code>è¿›è¡Œå•æ¬¡è¿è¡Œã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol><li><code>super</code>æœ¬è´¨ä¸Šæ˜¯<code>self</code>è°ƒç”¨å‡½æ•°ï¼Œä¸è¿‡æŸ¥æ‰¾å‡½æ•°æ˜¯ä»<code>sueprclass</code>å¼€å§‹æŸ¥æ‰¾çš„</li><li><code>+isKandOfClass</code>æ˜¯åˆ¤æ–­<code>self</code>æ˜¯å¦æ˜¯<code>cls</code>çš„å­ç±»ï¼Œ<code>+isMemberOfClass:</code>æ˜¯åˆ¤æ–­<code>self</code>æ˜¯å¦å’Œ<code>cls</code>ç›¸åŒã€‚</li><li>äº†è§£<code>+load</code>åœ¨<code>Category</code>æ˜¯å¯åŠ¨çš„æ—¶å€™ä½¿ç”¨è¿è¡Œæ—¶ç¼–è¯‘çš„ï¼Œè€Œä¸”åªä¼šåŠ è½½ä¸€æ¬¡,ç„¶ååˆ©ç”¨<code>objc/runtime.h</code>ä¸­<code>method_exchangeImplementations</code>å®ç°äº¤æ¢ä¸¤ä¸ªå‡½æ•°çš„<code>IMP</code>ï¼Œå¯ä»¥å®ç°æ‹¦æˆª<code>nil</code>ï¼Œé™ä½å´©æºƒç‡ã€‚</li><li><code>NSMutableDictionary</code>ã€<code>NSMutableArray</code>æ˜¯ç±»ç°‡ï¼Œå…ˆæ‰¾åˆ°ä»–ä»¬çš„ç±»ç„¶åå†äº¤æ¢è¯¥ç±»çš„å‡½æ•°çš„<code>IMP</code>ã€‚</li></ol><h3 id="èµ„æ–™å‚è€ƒ"><a href="#èµ„æ–™å‚è€ƒ" class="headerlink" title="èµ„æ–™å‚è€ƒ"></a>èµ„æ–™å‚è€ƒ</h3><ul><li><span class="exturl" data-url="aHR0cDovL3d3dy41MjBpdC5jb20venQvaW9zX21qLw==" title="http://www.520it.com/zt/ios_mj/">å°ç å“¥è§†é¢‘<i class="fa fa-external-link"></i></span></li></ul><h4 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h4><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9vYmpjNC03NTA=" title="https://github.com/ifgyong/demo/tree/master/OC/objc4-750">runtimeå¯è¿è¡Œçš„æºç <i class="fa fa-external-link"></i></span></li></ul><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p><p>å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å…³é”®å­—-super&quot;&gt;&lt;a href=&quot;#å…³é”®å­—-super&quot; class=&quot;headerlink&quot; title=&quot;å…³é”®å­— super&quot;&gt;&lt;/a&gt;å…³é”®å­— super&lt;/h3&gt;&lt;p&gt;å…³é”®å­—&lt;code&gt;super&lt;/code&gt;,åœ¨è°ƒç”¨&lt;code&gt;[super init
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç† runtime- objc_msgSendæ‹¾é—åŸºç¡€ç¯‡--(7)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20runtime-%20objc_msgSend%E6%8B%BE%E9%81%97%E5%9F%BA%E7%A1%80%E7%AF%87--(7)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20runtime-%20objc_msgSend%E6%8B%BE%E9%81%97%E5%9F%BA%E7%A1%80%E7%AF%87--(7)/</id>
    <published>2019-12-01T03:17:58.000Z</published>
    <updated>2020-09-04T04:40:21.659Z</updated>
    
    <content type="html"><![CDATA[<p>arm64ä¹‹åisaæ˜¯ä½¿ç”¨è”åˆä½“ä½¿ç”¨æ›´å°‘çš„ç©ºé—´å­˜å‚¨æ›´å¤šçš„æ•°æ®ï¼Œä»¥åŠå¦‚ä½•è‡ªå®šä¹‰å’Œä½¿ç”¨è”åˆä½“ï¼Œ<code>objc_class-&gt;cache_t cache</code>æ˜¯ä¸€ä¸ªæ˜¯ç¼“å­˜æœ€è¿‘è°ƒç”¨<code>class</code>çš„æ–¹æ³•ï¼Œå½“ç¼“å­˜å‰©ä½™ç©ºé—´å°ä½™1/4åˆ™è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹ä¸ºåŸæ¥çš„ä¸¤å€ï¼Œæ‰©å®¹ä¹‹åï¼Œå·²å­˜å‚¨çš„<code>method_t</code>æ‰©å®¹ä¹‹åä¹‹åè¢«æ¸…ç©ºã€‚ä»Šå¤©æˆ‘ä»¬åœ¨äº†è§£runtimeçš„æ¶ˆæ¯è½¬å‘æœºåˆ¶ã€‚</p><h4 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h4><p>OCä¸­çš„æ–¹æ³•è°ƒç”¨ï¼Œå…¶å®éƒ½æ˜¯è½¬æ¢ä¸ºobjc_msgSendå‡½æ•°çš„è°ƒç”¨</p><p>objc_msgSendçš„æ‰§è¡Œæµç¨‹å¯ä»¥åˆ†ä¸º3å¤§é˜¶æ®µ</p><ol><li>æ¶ˆæ¯å‘é€</li><li>åŠ¨æ€æ–¹æ³•è§£æ</li><li>æ¶ˆæ¯è½¬å‘</li></ol><p>é‚£ä¹ˆæˆ‘ä»¬æ ¹æ®è¿™ä¸‰å—å†…å®¹è¿›è¡Œæºç è§£è¯»ã€‚æºç æ‰§è¡Œçš„é¡ºåºå¤§æ¦‚å¦‚ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">objc-msg-arm64.s</span><br><span class="line">ENTRY _objc_msgSend</span><br><span class="line">b.leLNilOrTagged &#x2F;&#x2F;&lt;0åˆ™è¿”å›</span><br><span class="line">CacheLookup NORMAL &#x2F;&#x2F;ç¼“å­˜æŸ¥æ‰¾ æœªå‘½ä¸­åˆ™ç»§ç»­æŸ¥æ‰¾</span><br><span class="line">.macro CacheLookup&#x2F;&#x2F; é€šè¿‡å® æŸ¥æ‰¾cacheï¼Œå‘½ä¸­ç›´æ¥call or return imp</span><br><span class="line">.macro CheckMiss &#x2F;&#x2F;miss åˆ™è·³è½¬__objc_msgSend_uncached</span><br><span class="line">STATIC_ENTRY __objc_msgSend_uncached </span><br><span class="line">.macro MethodTableLookup&#x2F;&#x2F;æ–¹æ³•ä¸­æŸ¥æ‰¾</span><br><span class="line">__class_lookupMethodAndLoadCache3&#x2F;&#x2F;è·³è½¬-&gt;__class_lookupMethodAndLoadCache3 åœ¨runtime-class-new.mm 4856è¡Œ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">objc-runtime-new.mm</span><br><span class="line">_class_lookupMethodAndLoadCache3</span><br><span class="line">lookUpImpOrForward</span><br><span class="line">getMethodNoSuper_nolockã€search_method_listã€log_and_fill_cache</span><br><span class="line">cache_getImpã€log_and_fill_cacheã€getMethodNoSuper_nolockã€log_and_fill_cache</span><br><span class="line">_class_resolveInstanceMethod</span><br><span class="line">_objc_msgForward_impcache</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">objc-msg-arm64.s</span><br><span class="line">STATIC_ENTRY __objc_msgForward_impcache</span><br><span class="line">ENTRY __objc_msgForward</span><br><span class="line"></span><br><span class="line">Core Foundation</span><br><span class="line">__forwarding__ï¼ˆä¸å¼€æºï¼‰</span><br></pre></td></tr></table></figure><h3 id="æ¶ˆæ¯å‘é€"><a href="#æ¶ˆæ¯å‘é€" class="headerlink" title="æ¶ˆæ¯å‘é€"></a>æ¶ˆæ¯å‘é€</h3><p><code>objc_msgSend</code>æ˜¯æ±‡ç¼–å†™çš„ï¼Œåœ¨æºç <code>objc-msg-arm64.s</code>304è¡Œï¼Œæ˜¯<code>objc_msgSend</code>çš„å¼€å§‹ï¼Œ<code>_objc_msgSend</code>ç»“æŸæ˜¯351è¡Œ,<br>è¿›å…¥åˆ°<code>objc_msgSend</code>å‡½æ•°å†…éƒ¨ä¸€æ¢ç©¶ç«Ÿï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">ENTRY _objc_msgSend &#x2F;&#x2F; _objc_msgSend å¼€å§‹</span><br><span class="line">UNWIND _objc_msgSend, NoFrame</span><br><span class="line"></span><br><span class="line">cmpp0, #0&#x2F;&#x2F; æ£€æŸ¥p0å¯„å­˜å™¨æ˜¯å¦æ˜¯0  _objc_msgSend()ç¬¬ä¸€ä¸ªå‚æ•°:self</span><br><span class="line">#if SUPPORT_TAGGED_POINTERS</span><br><span class="line">b.leLNilOrTagged&#x2F;&#x2F; if le &lt; 0 -&gt;  è·³è½¬åˆ°æ ‡ç­¾  LNilOrTagged</span><br><span class="line">#else</span><br><span class="line">b.eqLReturnZero &#x2F;&#x2F; if le &#x3D;&#x3D; 0 -&gt;  è·³è½¬åˆ°æ ‡ç­¾  LReturnZero</span><br><span class="line">#endif</span><br><span class="line">ldrp13, [x0]&#x2F;&#x2F; p13 &#x3D; isa</span><br><span class="line">GetClassFromIsa_p16 p13&#x2F;&#x2F; p16 &#x3D; class</span><br><span class="line">LGetIsaDone:</span><br><span class="line">CacheLookup NORMAL&#x2F;&#x2F; calls imp or objc_msgSend_uncached</span><br><span class="line"></span><br><span class="line">#if SUPPORT_TAGGED_POINTERS</span><br><span class="line">LNilOrTagged:</span><br><span class="line">b.eqLReturnZero&#x2F;&#x2F; å¦‚æœ&#x3D;&#x3D;0 -&gt; LReturnZero</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; tagged</span><br><span class="line">adrpx10, _objc_debug_taggedpointer_classes@PAGE</span><br><span class="line">addx10, x10, _objc_debug_taggedpointer_classes@PAGEOFF</span><br><span class="line">ubfxx11, x0, #60, #4</span><br><span class="line">ldrx16, [x10, x11, LSL #3]</span><br><span class="line">adrpx10, _OBJC_CLASS_$___NSUnrecognizedTaggedPointer@PAGE</span><br><span class="line">addx10, x10, _OBJC_CLASS_$___NSUnrecognizedTaggedPointer@PAGEOFF</span><br><span class="line">cmpx10, x16</span><br><span class="line">b.neLGetIsaDone</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; ext tagged</span><br><span class="line">adrpx10, _objc_debug_taggedpointer_ext_classes@PAGE</span><br><span class="line">addx10, x10, _objc_debug_taggedpointer_ext_classes@PAGEOFF</span><br><span class="line">ubfxx11, x0, #52, #8</span><br><span class="line">ldrx16, [x10, x11, LSL #3]</span><br><span class="line">bLGetIsaDone</span><br><span class="line">&#x2F;&#x2F; SUPPORT_TAGGED_POINTERS</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">LReturnZero:</span><br><span class="line">&#x2F;&#x2F; x0 is already zero</span><br><span class="line">movx1, #0</span><br><span class="line">movid0, #0</span><br><span class="line">movid1, #0</span><br><span class="line">movid2, #0</span><br><span class="line">movid3, #0</span><br><span class="line">ret &#x2F;&#x2F;return è¿”å›ç»“æŸæ‰</span><br><span class="line"></span><br><span class="line">END_ENTRY _objc_msgSend &#x2F;&#x2F; _objc_msgSend ç»“æŸ</span><br></pre></td></tr></table></figure><p>å½“<code>objc_msgSend(id,SEL,arg)</code>çš„<code>id</code>ä¸ºç©ºçš„æ—¶å€™ï¼Œè·³è½¬æ ‡ç­¾<code>LNilOrTagged</code>,è¿›å…¥æ ‡ç­¾å†…ï¼Œå½“ç­‰äº0åˆ™è·³è½¬<code>LReturnZero</code>,è¿›å…¥åˆ°<code>LReturnZero</code>å†…ï¼Œæ¸…é™¤æ•°æ®å’Œreturnã€‚ä¸ç­‰äºé›¶ï¼Œè·å–isaå’Œclassï¼Œè°ƒç”¨<code>CacheLookup NORMAL</code>,è¿›å…¥åˆ°<code>CacheLookup</code>å†…éƒ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">.macro CacheLookup &#x2F;&#x2F;.macro æ˜¯ä¸€ä¸ªå® ä½¿ç”¨ _cmd&amp;mask æŸ¥æ‰¾ç¼“å­˜ä¸­çš„æ–¹æ³•</span><br><span class="line">&#x2F;&#x2F; p1 &#x3D; SEL, p16 &#x3D; isa</span><br><span class="line">ldpp10, p11, [x16, #CACHE]&#x2F;&#x2F; p10 &#x3D; buckets, p11 &#x3D; occupied|mask</span><br><span class="line">#if !__LP64__</span><br><span class="line">andw11, w11, 0xffff&#x2F;&#x2F; p11 &#x3D; mask</span><br><span class="line">#endif</span><br><span class="line">andw12, w1, w11&#x2F;&#x2F; x12 &#x3D; _cmd &amp; mask</span><br><span class="line">addp12, p10, p12, LSL #(1+PTRSHIFT)</span><br><span class="line">             &#x2F;&#x2F; p12 &#x3D; buckets + ((_cmd &amp; mask) &lt;&lt; (1+PTRSHIFT))</span><br><span class="line"></span><br><span class="line">ldpp17, p9, [x12]&#x2F;&#x2F; &#123;imp, sel&#125; &#x3D; *bucket</span><br><span class="line">1:cmpp9, p1&#x2F;&#x2F; if (bucket-&gt;sel !&#x3D; _cmd)</span><br><span class="line">b.ne2f&#x2F;&#x2F;     scan more</span><br><span class="line">CacheHit $0&#x2F;&#x2F; call or return imp å‘½ä¸­ è°ƒç”¨æˆ–è€…è¿”å›imp</span><br><span class="line"></span><br><span class="line">2:&#x2F;&#x2F; not hit: p12 &#x3D; not-hit bucket æ²¡æœ‰å‘½ä¸­</span><br><span class="line">CheckMiss $0&#x2F;&#x2F; miss if bucket-&gt;sel &#x3D;&#x3D; 0</span><br><span class="line">cmpp12, p10&#x2F;&#x2F; wrap if bucket &#x3D;&#x3D; buckets</span><br><span class="line">b.eq3f</span><br><span class="line">ldpp17, p9, [x12, #-BUCKET_SIZE]!&#x2F;&#x2F; &#123;imp, sel&#125; &#x3D; *--bucket</span><br><span class="line">b1b&#x2F;&#x2F; loop</span><br><span class="line"></span><br><span class="line">3:&#x2F;&#x2F; wrap: p12 &#x3D; first bucket, w11 &#x3D; mask</span><br><span class="line">addp12, p12, w11, UXTW #(1+PTRSHIFT)</span><br><span class="line">                        &#x2F;&#x2F; p12 &#x3D; buckets + (mask &lt;&lt; 1+PTRSHIFT)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Clone scanning loop to miss instead of hang when cache is corrupt.</span><br><span class="line">&#x2F;&#x2F; The slow path may detect any corruption and halt later.</span><br><span class="line"></span><br><span class="line">ldpp17, p9, [x12]&#x2F;&#x2F; &#123;imp, sel&#125; &#x3D; *bucket</span><br><span class="line">1:cmpp9, p1&#x2F;&#x2F; if (bucket-&gt;sel !&#x3D; _cmd)</span><br><span class="line">b.ne2f&#x2F;&#x2F;     scan more</span><br><span class="line">CacheHit $0&#x2F;&#x2F; call or return imp</span><br><span class="line"></span><br><span class="line">2:&#x2F;&#x2F; not hit: p12 &#x3D; not-hit bucket</span><br><span class="line">CheckMiss $0&#x2F;&#x2F; miss if bucket-&gt;sel &#x3D;&#x3D; 0</span><br><span class="line">cmpp12, p10&#x2F;&#x2F; wrap if bucket &#x3D;&#x3D; buckets</span><br><span class="line">b.eq3f</span><br><span class="line">ldpp17, p9, [x12, #-BUCKET_SIZE]!&#x2F;&#x2F; &#123;imp, sel&#125; &#x3D; *--bucket</span><br><span class="line">b1b&#x2F;&#x2F; loop</span><br><span class="line"></span><br><span class="line">3:&#x2F;&#x2F; double wrap</span><br><span class="line">JumpMiss $0</span><br><span class="line"></span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure><p>æ±‡ç¼–ä»£ç å·¦è¾¹æ˜¯ä»£ç ï¼Œå³è¾¹æ˜¯æ³¨é‡Šï¼Œå¤§æ¦‚éƒ½å¯ä»¥çœ‹æ‡‚çš„ã€‚<br>å½“å‘½ä¸­åˆ™<code>return imp</code>,å¦åˆ™åˆ™è·³è½¬<code>CheckMiss</code>,è¿›å…¥åˆ°<code>CheckMiss</code>å†…éƒ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.macro CheckMiss</span><br><span class="line">&#x2F;&#x2F; miss if bucket-&gt;sel &#x3D;&#x3D; 0</span><br><span class="line">.if $0 &#x3D;&#x3D; GETIMP</span><br><span class="line">cbzp9, LGetImpMiss</span><br><span class="line">.elseif $0 &#x3D;&#x3D; NORMAL</span><br><span class="line">cbzp9, __objc_msgSend_uncached</span><br><span class="line">.elseif $0 &#x3D;&#x3D; LOOKUP</span><br><span class="line">cbzp9, __objc_msgLookup_uncached</span><br><span class="line">.else</span><br><span class="line">.abort oops</span><br><span class="line">.endif</span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure><p>åˆšæ‰ä¼ çš„å€¼æ˜¯<code>NORMAL</code>ï¼Œåˆ™è·³è½¬<code>__objc_msgSend_uncached</code>ï¼Œè¿›å…¥åˆ°<code>__objc_msgSend_uncached</code>å†…éƒ¨(484è¡Œ)ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ENTRY __objc_msgSend_uncached</span><br><span class="line">UNWIND __objc_msgSend_uncached, FrameWithNoSaves</span><br><span class="line">MethodTableLookup</span><br><span class="line">TailCallFunctionPointer x17</span><br><span class="line">END_ENTRY __objc_msgSend_uncached</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>MethodTableLookup</code>,æˆ‘ä»¬æŸ¥çœ‹<code>MethodTableLookup</code>å†…éƒ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">.macro MethodTableLookup</span><br><span class="line">&#x2F;&#x2F; push frame</span><br><span class="line">SignLR</span><br><span class="line">stpfp, lr, [sp, #-16]!</span><br><span class="line">movfp, sp</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; save parameter registers: x0..x8, q0..q7</span><br><span class="line">subsp, sp, #(10*8 + 8*16)</span><br><span class="line">stpq0, q1, [sp, #(0*16)]</span><br><span class="line">stpq2, q3, [sp, #(2*16)]</span><br><span class="line">stpq4, q5, [sp, #(4*16)]</span><br><span class="line">stpq6, q7, [sp, #(6*16)]</span><br><span class="line">stpx0, x1, [sp, #(8*16+0*8)]</span><br><span class="line">stpx2, x3, [sp, #(8*16+2*8)]</span><br><span class="line">stpx4, x5, [sp, #(8*16+4*8)]</span><br><span class="line">stpx6, x7, [sp, #(8*16+6*8)]</span><br><span class="line">strx8,     [sp, #(8*16+8*8)]</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; receiver and selector already in x0 and x1</span><br><span class="line">movx2, x16</span><br><span class="line">bl__class_lookupMethodAndLoadCache3&#x2F;&#x2F;è·³è½¬-&gt;__class_lookupMethodAndLoadCache3 åœ¨runtime-class-new.mm 4856è¡Œ</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; IMP in x0</span><br><span class="line">movx17, x0</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; restore registers and return</span><br><span class="line">ldpq0, q1, [sp, #(0*16)]</span><br><span class="line">ldpq2, q3, [sp, #(2*16)]</span><br><span class="line">ldpq4, q5, [sp, #(4*16)]</span><br><span class="line">ldpq6, q7, [sp, #(6*16)]</span><br><span class="line">ldpx0, x1, [sp, #(8*16+0*8)]</span><br><span class="line">ldpx2, x3, [sp, #(8*16+2*8)]</span><br><span class="line">ldpx4, x5, [sp, #(8*16+4*8)]</span><br><span class="line">ldpx6, x7, [sp, #(8*16+6*8)]</span><br><span class="line">ldrx8,     [sp, #(8*16+8*8)]</span><br><span class="line"></span><br><span class="line">movsp, fp</span><br><span class="line">ldpfp, lr, [sp], #16</span><br><span class="line">AuthenticateLR</span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆè·³è½¬åˆ°<code>__class_lookupMethodAndLoadCache3</code>,å»æ‰ä¸€ä¸ªä¸‹åˆ’çº¿å°±æ˜¯cå‡½æ•°ï¼Œåœ¨<code>runtime-class-new.mm 4856è¡Œ</code>,<br>è°ƒç”¨äº†å‡½æ•°<code>lookUpImpOrForward(cls, sel, obj,                               YES/*initialize*/, NO/*cache*/, YES/*resolver*/);</code>,ç¬¬ä¸€æ¬¡ä¼šåˆå§‹åŒ–<code>cls</code>å’Œ<code>resolver</code>çš„å€¼ï¼Œ<br>ä¸­æœ€ç»ˆè·³è½¬åˆ°<code>c/c++</code>å‡½æ•°<code>lookUpImpOrForward</code>ï¼Œè¯¥å‡½æ•°æ˜¯æœ€ç»ˆèƒ½çœ‹åˆ°çš„<code>c/c++</code>,ç°åœ¨æˆ‘ä»¬è¿›å…¥åˆ°<code>lookUpImpOrForward</code>å†…éƒ¨æŸ¥çœ‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;***********************************************************************</span><br><span class="line">* lookUpImpOrForward.</span><br><span class="line">* initialize&#x3D;&#x3D;NO å°½é‡é¿å…è°ƒç”¨ï¼Œæœ‰æ—¶å¯èƒ½ä¹Ÿä¼šè°ƒç”¨ã€‚</span><br><span class="line">* cache&#x3D;&#x3D;NO è·³è¿‡ç¼“å­˜æŸ¥æ‰¾ï¼Œå…¶ä»–åœ°æ–¹å¯èƒ½ä¼šä¸è°ƒè¿‡</span><br><span class="line">* å¤§å¤šæ•°äººä¼šä¼ å€¼ initialize&#x3D;&#x3D;YES and cache&#x3D;&#x3D;YES</span><br><span class="line">*   å¦‚æœclsæ˜¯éåˆå§‹åŒ–çš„å…ƒç±»ï¼Œåˆ™éNon-nilä¼šå¿«ç‚¹</span><br><span class="line">* May return _objc_msgForward_impcache. IMPs destined for external use </span><br><span class="line">*   must be converted to _objc_msgForward or _objc_msgForward_stret.</span><br><span class="line">* å¦‚æœä½ ä¸æƒ³ç”¨forwardingï¼Œåˆ™è°ƒç”¨lookUpImpOrNil()ä»£æ›¿</span><br><span class="line">**********************************************************************&#x2F;</span><br><span class="line">IMP lookUpImpOrForward(Class cls, SEL sel, id inst, </span><br><span class="line">                       bool initialize, bool cache, bool resolver)</span><br><span class="line">&#123;</span><br><span class="line">    IMP imp &#x3D; nil;</span><br><span class="line">    bool triedResolver &#x3D; NO;</span><br><span class="line"></span><br><span class="line">    runtimeLock.assertUnlocked();</span><br><span class="line">    &#x2F;&#x2F; Optimistic cache lookup</span><br><span class="line">    if (cache) &#123; &#x2F;&#x2F;ä»æ±‡ç¼–è¿‡æ¥æ˜¯NO</span><br><span class="line">        imp &#x3D; cache_getImp(cls, sel);</span><br><span class="line">        if (imp) return imp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    runtimeLock.lock();</span><br><span class="line">    checkIsKnownClass(cls);</span><br><span class="line"></span><br><span class="line">    if (!cls-&gt;isRealized()) &#123;</span><br><span class="line">        realizeClass(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (initialize  &amp;&amp;  !cls-&gt;isInitialized()) &#123;</span><br><span class="line">&#x2F;&#x2F;å½“clséœ€è¦åˆå§‹åŒ–å’Œæ²¡æœ‰åˆå§‹åŒ–çš„æ—¶å€™ è¿›è¡Œclsåˆå§‹åŒ–ï¼Œ</span><br><span class="line">&#x2F;&#x2F;åˆå§‹åŒ–ä¼šåŠ å…¥åˆ°ä¸€ä¸ªçº¿ç¨‹ï¼ŒåŒæ­¥æ‰§è¡Œï¼Œå…ˆåˆå§‹åŒ–çˆ¶ç±»ï¼Œå†åˆå§‹åŒ–å­ç±»</span><br><span class="line">&#x2F;&#x2F;æ•°æ®çš„å¤§å°æœ€å°æ˜¯4ï¼Œæ‰©å®¹è§„åˆ™æ˜¯ï¼šn*2+1;</span><br><span class="line">        runtimeLock.unlock();</span><br><span class="line">        _class_initialize (_class_getNonMetaClass(cls, inst));</span><br><span class="line">        runtimeLock.lock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"> retry:    </span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å†æ¬¡è·å–imp</span><br><span class="line">    imp &#x3D; cache_getImp(cls, sel);</span><br><span class="line">    if (imp) goto done;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;å°è¯•åœ¨æœ¬ç±»ä¸­æŸ¥æ‰¾method</span><br><span class="line">    &#123;&#x2F;&#x2F;ä»cls-&gt;data()-&gt;methodsæŸ¥æ‰¾method</span><br><span class="line">        Method meth &#x3D; getMethodNoSuper_nolock(cls, sel);</span><br><span class="line">        if (meth) &#123;&#x2F;&#x2F;æ‰¾åˆ°æ·»åŠ åˆ°cacheä¸­</span><br><span class="line">            log_and_fill_cache(cls, meth-&gt;imp, sel, inst, cls);</span><br><span class="line">            imp &#x3D; meth-&gt;imp;</span><br><span class="line">            goto done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Try superclass caches and method lists.</span><br><span class="line">&#x2F;&#x2F;ä»cls-&gt;superclass-&gt;data()-&gt;methodsæŸ¥æ‰¾methdï¼Œsuperclsæ²¡æœ‰æŸ¥æ‰¾å‡ºæ¥ï¼Œå†æŸ¥æ‰¾çˆ¶ç±»çš„çˆ¶ç±»ã€‚</span><br><span class="line">    &#123;</span><br><span class="line">        unsigned attempts &#x3D; unreasonableClassCount();</span><br><span class="line">        for (Class curClass &#x3D; cls-&gt;superclass;</span><br><span class="line">             curClass !&#x3D; nil;</span><br><span class="line">             curClass &#x3D; curClass-&gt;superclass)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; Halt if there is a cycle in the superclass chain.</span><br><span class="line">            if (--attempts &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                _objc_fatal(&quot;Memory corruption in class list.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; Superclass cache.</span><br><span class="line">            imp &#x3D; cache_getImp(curClass, sel);</span><br><span class="line">            if (imp) &#123;</span><br><span class="line">                if (imp !&#x3D; (IMP)_objc_msgForward_impcache) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Found the method in a superclass. Cache it in this class.</span><br><span class="line">&#x2F;&#x2F;å°†çˆ¶ç±»æ·»åŠ åˆ° å­ç±»çš„ç¼“å­˜ä¸­</span><br><span class="line">                    log_and_fill_cache(cls, imp, sel, inst, curClass);</span><br><span class="line">                    goto done;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    &#x2F;&#x2F; Found a forward:: entry in a superclass.</span><br><span class="line">                    &#x2F;&#x2F; Stop searching, but don&#39;t cache yet; call method </span><br><span class="line">                    &#x2F;&#x2F; resolver for this class first.</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; Superclass method list.</span><br><span class="line">            Method meth &#x3D; getMethodNoSuper_nolock(curClass, sel);</span><br><span class="line">            if (meth) &#123;</span><br><span class="line">                log_and_fill_cache(cls, meth-&gt;imp, sel, inst, curClass);</span><br><span class="line">                imp &#x3D; meth-&gt;imp;</span><br><span class="line">                goto done;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°impï¼Œè¿›å…¥åŠ¨æ€æ–¹æ³•è§£æé˜¶æ®µ</span><br><span class="line">    if (resolver  &amp;&amp;  !triedResolver) &#123;</span><br><span class="line">        runtimeLock.unlock();</span><br><span class="line">        _class_resolveMethod(cls, sel, inst);</span><br><span class="line">        runtimeLock.lock();</span><br><span class="line">        triedResolver &#x3D; YES;</span><br><span class="line">        goto retry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;å¦‚æœæ²¡æ‰¾åˆ°resolveInstanceMethod å’ŒresolveClassMethodï¼Œ</span><br><span class="line">&#x2F;&#x2F;è¿›è¡Œæ¶ˆæ¯è½¬å‘ é˜¶æ®µ</span><br><span class="line">    imp &#x3D; (IMP)_objc_msgForward_impcache;</span><br><span class="line">&#x2F;&#x2F;å¡«å…… cache</span><br><span class="line">    cache_fill(cls, sel, imp, inst);</span><br><span class="line"> done:</span><br><span class="line">    runtimeLock.unlock();</span><br><span class="line">    return imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>SUPPORT_INDEXED_ISA</code>æ˜¯åœ¨<code>arm64</code>å’Œ<code>LP64</code> è¿˜æœ‰<code>arm_arch_7k&gt;2</code>ä¸º1ï¼Œ<code>iphone</code>å±äº<code>arm64</code>ã€<code>mac os</code>å±äº<code>LP64</code>,æ‰€ä»¥<code>SUPPORT_INDEXED_ISA = 1</code>.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Define SUPPORT_INDEXED_ISA&#x3D;1 on platforms that store the class in the isa </span><br><span class="line">&#x2F;&#x2F; field as an index into a class table.</span><br><span class="line">&#x2F;&#x2F; Note, keep this in sync with any .s files which also define it.</span><br><span class="line">&#x2F;&#x2F; Be sure to edit objc-abi.h as well.</span><br><span class="line">&#x2F;&#x2F; __ARM_ARCH_7K__ å¤„ç†å™¨æ¶æ„æŒ‡ä»¤é›†ç‰ˆæœ¬</span><br><span class="line">&#x2F;&#x2F;__arm64__ æ¶æ„</span><br><span class="line">&#x2F;&#x2F;__LP64__ uinx å’Œuinx  mac os</span><br><span class="line">#if __ARM_ARCH_7K__ &gt;&#x3D; 2  ||  (__arm64__ &amp;&amp; !__LP64__)</span><br><span class="line">#   define SUPPORT_INDEXED_ISA 1</span><br><span class="line">#else</span><br><span class="line">#   define SUPPORT_INDEXED_ISA 0</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure><p><code>lookUpImpOrForward</code>å‡½æ•°çš„ å¤§æ¦‚æ€è·¯å¦‚ä¸‹ï¼š</p><p>é¦–æ¬¡å·²ç»ä»ç¼“å­˜ä¸­æŸ¥è¿‡æ²¡æœ‰å‘½ä¸­æ‰€ä»¥ä¸å†å»ç¼“å­˜ä¸­æŸ¥äº†ï¼Œç„¶ååˆ¤æ–­<code>cls</code>æ˜¯å¦å·²ç»å®ç°ï¼Œ<code>cls-&gt;isRealized()</code>ï¼Œæ²¡æœ‰å®ç°çš„è¯è¿›è¡Œå®ç°<code>realizeClass(cls)</code>ï¼Œä¸»è¦æ˜¯å°†åˆå§‹åŒ–<code>read-write data</code>å’Œå…¶ä»–çš„ä¸€äº›æ•°æ®ï¼Œåç»­ä¼šç»†è®²ã€‚ç„¶åè¿›è¡Œ<code>cls</code>çš„åˆå§‹åŒ–<code>_class_initialize()</code>ï¼Œå½“<code>cls</code>éœ€è¦åˆå§‹åŒ–å’Œæ²¡æœ‰åˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œclsåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–ä¼šåŠ å…¥åˆ°ä¸€ä¸ªçº¿ç¨‹ï¼ŒåŒæ­¥æ‰§è¡Œï¼Œå…ˆåˆå§‹åŒ–çˆ¶ç±»ï¼Œå†åˆå§‹åŒ–å­ç±»,æ•°æ®çš„å¤§å°æœ€å°æ˜¯4ï¼Œæ‰©å®¹è§„åˆ™æ˜¯ï¼š<code>n*2+1</code>;ç„¶åå†æ¬¡è·å–imp<code>cache_getImp</code>,ç„¶ååœ¨<code>cls</code>æ–¹æ³•ä¸­æŸ¥æ‰¾è¯¥<code>method</code>ï¼Œç„¶åå°±æ˜¯åœ¨<code>superclass</code>ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œç›´åˆ°çˆ¶ç±»æ˜¯nilï¼Œæ‰¾åˆ°çš„è¯ï¼Œè·å–<code>imp</code>å¹¶å°†<code>cls</code>å’Œ<code>sel</code>åŠ å…¥åˆ°<code>cache</code>ä¸­ï¼Œå¦åˆ™è¿›å…¥åˆ°æ¶ˆæ¯è§£æé˜¶æ®µ<code>_class_resolveMethod</code>ï¼Œåœ¨è½¬å‘é˜¶æ®µï¼Œä¸æ˜¯å…ƒç±»çš„è¯ï¼Œè¿›å…¥åˆ°<code>_class_resolveInstanceMethod</code>æ˜¯å…ƒç±»çš„è¯è°ƒç”¨<code>_class_resolveClassMethod</code>,è¿™ä¸¤ç§åˆ†åˆ«éƒ½ä¼šè¿›å…¥åˆ°<code>lookUpImpOrNil</code>ï¼Œå†æ¬¡æŸ¥æ‰¾<code>IMP</code>ï¼Œå½“æ²¡æ‰¾åˆ°çš„è¯å°±è¿”å›ï¼Œæ‰¾åˆ°çš„è¯ç”¨<code>objc_msgSend</code>å‘é€æ¶ˆæ¯å®ç°è°ƒç”¨<code>SEL_resolveInstanceMethod</code>å¹¶æ ‡è®°<code>triedResolver</code>ä¸ºå·²åŠ¨æ€è§£ææ ‡å¿—ã€‚ç„¶åè¿›å…¥åˆ°æ¶ˆæ¯åŠ¨æ€è½¬å‘é˜¶æ®µ<code>_objc_msgForward_impcache</code>,è‡³æ­¤<code>runtime</code>å‘é€æ¶ˆæ¯ç»“æŸã€‚</p><p>å€Ÿç”¨ç½‘ä¸Šæ‰¾ä¸€ä¸ªå›¾ï¼Œ å¯ä»¥æ›´ç›´è§‚çš„çœ‹å‡ºæµç¨‹è¿è½¬ã€‚</p><p><img src="/images/7-1.png" alt></p><h4 id="realizeClass-è§£æ"><a href="#realizeClass-è§£æ" class="headerlink" title="realizeClass()è§£æ"></a>realizeClass()è§£æ</h4><p><code>realizeClass</code>æ˜¯åˆå§‹åŒ–äº†å¾ˆå¤šæ•°æ®ï¼ŒåŒ…æ‹¬<code>cls-&gt;ro</code>èµ‹å€¼ç»™<code>cls-&gt;rw</code>ï¼Œæ·»åŠ å…ƒç±»<code>version</code>ä¸º7,<code>cls-&gt;chooseClassArrayIndex()</code>è®¾ç½®<code>cls</code>çš„ç´¢å¼•ï¼Œ<code>supercls = realizeClass(remapClass(cls-&gt;superclass));    metacls = realizeClass(remapClass(cls-&gt;ISA()))</code>åˆå§‹åŒ–<code>superclass</code>å’Œ<code>cls-&gt;isa</code>,åè¾¹é’ˆå¯¹æ²¡æœ‰ä¼˜åŒ–çš„ç»“æ„è¿›è¡Œèµ‹å€¼è¿™é‡Œä¸å¤šè®²ï¼Œç„¶ååè°ƒå®ä¾‹å˜é‡åç§»å¸ƒå±€ï¼Œè®¾ç½®<code>cls-&gt;setInstanceSize</code>,æ‹·è´<code>flags</code>ä»<code>ro</code>åˆ°<code>rw</code>ä¸­ï¼Œç„¶åæ·»åŠ <code>subclass</code>å’Œ<code>rootclass</code>ï¼Œæœ€åæ·»åŠ ç±»åˆ«çš„æ–¹æ³•ï¼Œåè®®ï¼Œå’Œå±æ€§ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;***********************************************************************</span><br><span class="line">* realizeClass</span><br><span class="line"> clsç¬¬ä¸€æ¬¡åˆå§‹åŒ–ä¼šæ‰§è¡Œï¼ŒåŒ…æ‹¬cls-&gt;rw-&gt;data(),è¿”å›çœŸå®çš„cls ç»“æ„ä½“</span><br><span class="line"> runtimelock å¿…é¡»æœ‰è°ƒç”¨è€…æŠŠå†™å…¥é”é”èµ·æ¥</span><br><span class="line">**********************************************************************&#x2F;</span><br><span class="line">static Class realizeClass(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    const class_ro_t *ro;</span><br><span class="line">    class_rw_t *rw;</span><br><span class="line">    Class supercls;</span><br><span class="line">    Class metacls;</span><br><span class="line">    bool isMeta;</span><br><span class="line"></span><br><span class="line">    if (!cls) return nil;</span><br><span class="line">    if (cls-&gt;isRealized()) return cls;</span><br><span class="line">    assert(cls &#x3D;&#x3D; remapClass(cls));</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; fixme verify class is not in an un-dlopened part of the shared cache?</span><br><span class="line">&#x2F;&#x2F;é¦–å…ˆå°†twèµ‹å€¼ç»™toï¼Œå› ä¸ºæ•°æ®ç»“æ„ä¸€æ ·å¯ä»¥ç›´æ¥å¼ºåˆ¶è½¬åŒ–</span><br><span class="line">    ro &#x3D; (const class_ro_t *)cls-&gt;data();</span><br><span class="line">    if (ro-&gt;flags &amp; RO_FUTURE) &#123;&#x2F;&#x2F;æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡ï¼Œåˆå§‹åŒ–è¿‡çš„å“ˆ åˆ™ cls-&gt;rw å·²ç»åˆå§‹åŒ–è¿‡</span><br><span class="line">        rw &#x3D; cls-&gt;data();</span><br><span class="line">        ro &#x3D; cls-&gt;data()-&gt;ro;</span><br><span class="line">        cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; æ­£å¸¸æƒ…å†µä¸‹ ç”³è¯·class_rw_tç©ºé—´</span><br><span class="line">        rw &#x3D; (class_rw_t *)calloc(sizeof(class_rw_t), 1);</span><br><span class="line">        rw-&gt;ro &#x3D; ro;&#x2F;&#x2F;cls-&gt;rw-&gt;ro æŒ‡å‘ç°åœ¨çš„ro</span><br><span class="line">        rw-&gt;flags &#x3D; RW_REALIZED|RW_REALIZING;&#x2F;&#x2F;realized &#x3D; 1 and  realizing &#x3D; 1</span><br><span class="line">        cls-&gt;setData(rw);&#x2F;&#x2F;èµ‹å€¼</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isMeta &#x3D; ro-&gt;flags &amp; RO_META;&#x2F;&#x2F;æ˜¯å¦æ˜¯å…ƒç±»</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    rw-&gt;version &#x3D; isMeta ? 7 : 0;  &#x2F;&#x2F; å…ƒç±»ç‰ˆæœ¬æ˜¯7ï¼Œæ—§ç‰ˆçš„6ï¼Œå¦å°±æ˜¯0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Choose an index for this class.</span><br><span class="line">&#x2F;&#x2F;è®¾ç½®clsçš„ç´¢å¼•</span><br><span class="line">cls-&gt;chooseClassArrayIndex();</span><br><span class="line"></span><br><span class="line">    if (PrintConnecting) &#123;</span><br><span class="line">        _objc_inform(&quot;CLASS: realizing class &#39;%s&#39;%s %p %p #%u&quot;, </span><br><span class="line">                     cls-&gt;nameForLogging(), isMeta ? &quot; (meta)&quot; : &quot;&quot;, </span><br><span class="line">                     (void*)cls, ro, cls-&gt;classArrayIndex());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; å¦‚æœçˆ¶ç±»æ²¡æœ‰åˆå§‹åŒ–åˆ™è¿›è¡Œåˆå§‹åŒ–</span><br><span class="line">    &#x2F;&#x2F; root_class åšå®Œéœ€è¦è®¾ç½®RW_REALIZED&#x3D;1ï¼Œ</span><br><span class="line">    &#x2F;&#x2F; root metaclasses éœ€è¦æ‰§è¡Œå®Œ.</span><br><span class="line">&#x2F;&#x2F;ä»NXMapTable è·å–cls ï¼Œç„¶åè¿›è¡Œåˆå§‹åŒ–</span><br><span class="line">&#x2F;&#x2F;ä»NXMapTable è·å–cls-&gt;isa ï¼Œç„¶åè¿›è¡Œåˆå§‹åŒ–</span><br><span class="line">    supercls &#x3D; realizeClass(remapClass(cls-&gt;superclass));</span><br><span class="line">    metacls &#x3D; realizeClass(remapClass(cls-&gt;ISA()));</span><br><span class="line">&#x2F;&#x2F;æ²¡æœ‰ç»è¿‡ä¼˜åŒ–çš„isaæ‰§è¡Œçš„ï¼Œç°åœ¨å·²ç»æ˜¯version&#x3D;7ï¼Œåœ¨arm64ä¸Šæ˜¯ä¼˜åŒ–è¿‡çš„ï¼Œè¿™ä¸ªå…ˆä¸çœ‹äº†ã€‚</span><br><span class="line">#if SUPPORT_NONPOINTER_ISA</span><br><span class="line">    &#x2F;&#x2F; Disable non-pointer isa for some classes and&#x2F;or platforms.</span><br><span class="line">    &#x2F;&#x2F; Set instancesRequireRawIsa.</span><br><span class="line">    bool instancesRequireRawIsa &#x3D; cls-&gt;instancesRequireRawIsa();</span><br><span class="line">    bool rawIsaIsInherited &#x3D; false;</span><br><span class="line">    static bool hackedDispatch &#x3D; false;</span><br><span class="line"></span><br><span class="line">    if (DisableNonpointerIsa) &#123;</span><br><span class="line">        &#x2F;&#x2F; Non-pointer isa disabled by environment or app SDK version</span><br><span class="line">        instancesRequireRawIsa &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (!hackedDispatch  &amp;&amp;  !(ro-&gt;flags &amp; RO_META)  &amp;&amp;  </span><br><span class="line">             0 &#x3D;&#x3D; strcmp(ro-&gt;name, &quot;OS_object&quot;)) </span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; hack for libdispatch et al - isa also acts as vtable pointer</span><br><span class="line">        hackedDispatch &#x3D; true;</span><br><span class="line">        instancesRequireRawIsa &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (supercls  &amp;&amp;  supercls-&gt;superclass  &amp;&amp;  </span><br><span class="line">             supercls-&gt;instancesRequireRawIsa()) </span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; This is also propagated by addSubclass() </span><br><span class="line">        &#x2F;&#x2F; but nonpointer isa setup needs it earlier.</span><br><span class="line">        &#x2F;&#x2F; Special case: instancesRequireRawIsa does not propagate </span><br><span class="line">        &#x2F;&#x2F; from root class to root metaclass</span><br><span class="line">        instancesRequireRawIsa &#x3D; true;</span><br><span class="line">        rawIsaIsInherited &#x3D; true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (instancesRequireRawIsa) &#123;</span><br><span class="line">        cls-&gt;setInstancesRequireRawIsa(rawIsaIsInherited);</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F; SUPPORT_NONPOINTER_ISA</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Update superclass and metaclass in case of remapping</span><br><span class="line">    cls-&gt;superclass &#x3D; supercls;</span><br><span class="line">    cls-&gt;initClassIsa(metacls);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; åè°ƒå®ä¾‹å˜é‡åç§»&#x2F;å¸ƒå±€</span><br><span class="line">&#x2F;&#x2F;å¯èƒ½é‡æ–°ç”³è¯·ç©ºé—´ class_ro_t,æ›´æ–°æˆ‘ä»¬çš„class_ro_t</span><br><span class="line">    if (supercls  &amp;&amp;  !isMeta) reconcileInstanceVariables(cls, supercls, ro);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; è®¾ç½®setInstanceSize ä»ro-&gt;instanceSize</span><br><span class="line">    cls-&gt;setInstanceSize(ro-&gt;instanceSize);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;æ‹·è´flags ä»roåˆ°rwä¸­</span><br><span class="line">    if (ro-&gt;flags &amp; RO_HAS_CXX_STRUCTORS) &#123;</span><br><span class="line">        cls-&gt;setHasCxxDtor();</span><br><span class="line">        if (! (ro-&gt;flags &amp; RO_HAS_CXX_DTOR_ONLY)) &#123;</span><br><span class="line">            cls-&gt;setHasCxxCtor();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F;æ·»åŠ superclassæŒ‡é’ˆ</span><br><span class="line">    if (supercls) &#123;</span><br><span class="line">        addSubclass(supercls, cls);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        addRootClass(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Attach categories</span><br><span class="line">&#x2F;&#x2F;ç±»åˆ«çš„æ–¹æ³• åœ¨ç¼–è¯‘çš„æ—¶å€™æ²¡æœ‰æ·»åŠ åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™æ·»åŠ è¿›å»çš„</span><br><span class="line">    methodizeClass(cls);</span><br><span class="line"></span><br><span class="line">    return cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ€åæ·»åŠ ç±»åˆ«çš„æ•°æ®æ˜¯è°ƒç”¨äº†<code>methodizeClass</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é¦–å…ˆæ·»åŠ <code>method_list_t *list = ro-&gt;baseMethods()</code>åˆ°<code>rw-&gt;methods.attachLists(&amp;list, 1)</code>ï¼Œç„¶åå°†å±æ€§<code>property_list_t *proplist=ro-&gt;baseProperties</code>æ·»åŠ åˆ°<code>rw-&gt;properties.attachLists(&amp;proplist, 1)</code>,æœ€åå°†åè®®åˆ—è¡¨<code>protocol_list_t *protolist = ro-&gt;baseProtocols</code>è¿½åŠ åˆ°<code>rw-&gt;protocols.attachLists(&amp;protolist, 1)</code>ï¼Œå¦‚æœæ˜¯<code>metaclass</code>åˆ™æ·»åŠ <code>SEL_initialize</code>,ç„¶åä»å…¨å±€<code>NXMapTable *category_map</code>åˆ é™¤å·²ç»åŠ è½½çš„<code>category_list</code>,æœ€åè°ƒç”¨<code>attachCategories(cls, cats, false /*don&#39;t flush caches*/)</code>å°†å·²ç»åŠ è½½çš„<code>cats</code>çš„æ–¹æ³•æ·»åŠ åˆ°<code>cls-&gt;rw</code>ä¸Šé¢å¹¶ä¸”ä¸åˆ·æ–°<code>caches</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;***********************************************************************</span><br><span class="line">* methodizeClass</span><br><span class="line"> ä¿®å¤clsæ–¹æ³•åˆ—è¡¨æƒ³ï¼Œåè®®åˆ—è¡¨å’Œå±æ€§åˆ—è¡¨</span><br><span class="line">* åŠ é”</span><br><span class="line">**********************************************************************&#x2F;</span><br><span class="line">static void methodizeClass(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    bool isMeta &#x3D; cls-&gt;isMetaClass();</span><br><span class="line">    auto rw &#x3D; cls-&gt;data();</span><br><span class="line">    auto ro &#x3D; rw-&gt;ro;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Methodizing for the first time</span><br><span class="line">    if (PrintConnecting) &#123;</span><br><span class="line">        _objc_inform(&quot;CLASS: methodizing class &#39;%s&#39; %s&quot;, </span><br><span class="line">                     cls-&gt;nameForLogging(), isMeta ? &quot;(meta)&quot; : &quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;æ–¹æ³•åˆ—è¡¨</span><br><span class="line">    method_list_t *list &#x3D; ro-&gt;baseMethods();</span><br><span class="line">    if (list) &#123;</span><br><span class="line">        prepareMethodLists(cls, &amp;list, 1, YES, isBundleClass(cls));</span><br><span class="line">&#x2F;&#x2F;å°†å¯¹è±¡çš„æ–¹æ³•è¿½åŠ åˆ°cls-&gt;rw-&gt;methodsåé¢</span><br><span class="line">        rw-&gt;methods.attachLists(&amp;list, 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    property_list_t *proplist &#x3D; ro-&gt;baseProperties;</span><br><span class="line">    if (proplist) &#123;</span><br><span class="line">&#x2F;&#x2F;å°†å¯¹è±¡çš„å±æ€§è¿½åŠ åˆ°rw-&gt;propertiesåé¢</span><br><span class="line">        rw-&gt;properties.attachLists(&amp;proplist, 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protocol_list_t *protolist &#x3D; ro-&gt;baseProtocols;</span><br><span class="line">    if (protolist) &#123;</span><br><span class="line">&#x2F;&#x2F;å°†å¯¹è±¡çš„åè®®è¿½åŠ åˆ°rw-&gt;protocolsåé¢</span><br><span class="line">        rw-&gt;protocols.attachLists(&amp;protolist, 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Root classes get bonus method implementations if they don&#39;t have </span><br><span class="line">    &#x2F;&#x2F; them already. These apply before category replacements.</span><br><span class="line">    if (cls-&gt;isRootMetaclass()) &#123;</span><br><span class="line">        &#x2F;&#x2F; root metaclass</span><br><span class="line">        addMethod(cls, SEL_initialize, (IMP)&amp;objc_noop_imp, &quot;&quot;, NO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Attach categories.</span><br><span class="line">&#x2F;&#x2F;ç±»åˆ« ä»å…¨å±€NXMapTable *category_map å·²ç»åŠ è½½è¿‡äº†ã€‚</span><br><span class="line">    category_list *cats &#x3D; unattachedCategoriesForClass(cls, true &#x2F;*realizing*&#x2F;);</span><br><span class="line">&#x2F;&#x2F;æ”¶é›†æ‰€æœ‰çš„catsåˆ°cls -&gt; rwä¸­</span><br><span class="line">    attachCategories(cls, cats, false &#x2F;*don&#39;t flush caches*&#x2F;);</span><br><span class="line"></span><br><span class="line">    if (PrintConnecting) &#123;</span><br><span class="line">        if (cats) &#123;</span><br><span class="line">            for (uint32_t i &#x3D; 0; i &lt; cats-&gt;count; i++) &#123;</span><br><span class="line">                _objc_inform(&quot;CLASS: attached category %c%s(%s)&quot;, </span><br><span class="line">                             isMeta ? &#39;+&#39; : &#39;-&#39;, </span><br><span class="line">                             cls-&gt;nameForLogging(), cats-&gt;list[i].cat-&gt;name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (cats) free(cats);&#x2F;&#x2F;é‡Šæ”¾cats</span><br><span class="line"></span><br><span class="line">#if DEBUG</span><br><span class="line">    &#x2F;&#x2F; Debug: sanity-check all SELs; log method list contents</span><br><span class="line">    for (const auto&amp; meth : rw-&gt;methods) &#123;</span><br><span class="line">        if (PrintConnecting) &#123;</span><br><span class="line">            _objc_inform(&quot;METHOD %c[%s %s]&quot;, isMeta ? &#39;+&#39; : &#39;-&#39;, </span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(meth.name));</span><br><span class="line">        &#125;</span><br><span class="line">        assert(sel_registerName(sel_getName(meth.name)) &#x3D;&#x3D; meth.name); </span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="attachCategories-è§£æ"><a href="#attachCategories-è§£æ" class="headerlink" title="attachCategories()è§£æ"></a>attachCategories()è§£æ</h4><p><code>methodizeClass</code>ä¹‹å‰<code>rw</code>åˆå§‹åŒ–çš„æ—¶å€™å¹¶æ²¡æœ‰å°†å…¶ä»–æ•°æ®éƒ½éƒ½å¤åˆ¶ç»™<code>rw</code>,ç°åœ¨<code>methodizeClass</code>å®ç°äº†å°†æœ¬æ¥çš„<code>ro</code>æ•°æ®æ‹·è´ç»™<code>rw</code>,ç„¶å<code>attachCategories</code>å°†<br>åˆ†ç±»çš„æ–¹æ³•ï¼Œå±æ€§ï¼Œåè®®è¿½åŠ åˆ°<code>cls-&gt;data-&gt;rw</code>ï¼Œæˆ‘ä»¬è¿›å…¥<code>attachCategories</code>å†…éƒ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">static void attachCategories(Class cls, category_list *cats, bool flush_caches)</span><br><span class="line">&#123;</span><br><span class="line">    if (!cats) return;</span><br><span class="line">    if (PrintReplacedMethods) printReplacements(cls, cats);</span><br><span class="line"></span><br><span class="line">    bool isMeta &#x3D; cls-&gt;isMetaClass();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; fixme rearrange to remove these intermediate allocations</span><br><span class="line">&#x2F;&#x2F;æ–¹æ³•æ•°ç»„[[1,2,3],[4,5,6],[7,8,9]]</span><br><span class="line">    method_list_t **mlists &#x3D; (method_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*mlists));</span><br><span class="line">&#x2F;&#x2F;å±æ€§æ•°ç»„</span><br><span class="line">    property_list_t **proplists &#x3D; (property_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*proplists));</span><br><span class="line">&#x2F;&#x2F;åè®®æ•°ç»„</span><br><span class="line">    protocol_list_t **protolists &#x3D; (protocol_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*protolists));</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Count backwards through cats to get newest categories first</span><br><span class="line">    int mcount &#x3D; 0;</span><br><span class="line">    int propcount &#x3D; 0;</span><br><span class="line">    int protocount &#x3D; 0;</span><br><span class="line">    int i &#x3D; cats-&gt;count;</span><br><span class="line">    bool fromBundle &#x3D; NO;</span><br><span class="line">    while (i--) &#123;</span><br><span class="line">&#x2F;&#x2F;å–å‡ºæŸä¸ªåˆ†ç±»</span><br><span class="line">        auto&amp; entry &#x3D; cats-&gt;list[i];</span><br><span class="line">&#x2F;&#x2F;å–å‡ºåˆ†ç±» çš„ instanceæ–¹æ³•æˆ–è€…classæ–¹æ³•</span><br><span class="line">        method_list_t *mlist &#x3D; entry.cat-&gt;methodsForMeta(isMeta);</span><br><span class="line">        if (mlist) &#123;</span><br><span class="line">            mlists[mcount++] &#x3D; mlist; &#x2F;&#x2F;mlists æ¥å—æ‰€æœ‰åˆ†ç±»æ–¹æ³•</span><br><span class="line">            fromBundle |&#x3D; entry.hi-&gt;isBundle();</span><br><span class="line">        &#125;</span><br><span class="line">&#x2F;&#x2F;proplist æ¥å—æ‰€æœ‰åˆ†ç±»å±æ€§</span><br><span class="line">        property_list_t *proplist &#x3D; </span><br><span class="line">            entry.cat-&gt;propertiesForMeta(isMeta, entry.hi);</span><br><span class="line">        if (proplist) &#123;</span><br><span class="line">            proplists[propcount++] &#x3D; proplist;</span><br><span class="line">        &#125;</span><br><span class="line">&#x2F;&#x2F;proplist æ¥å—æ‰€æœ‰åè®®æ–¹æ³•</span><br><span class="line">        protocol_list_t *protolist &#x3D; entry.cat-&gt;protocols;</span><br><span class="line">        if (protolist) &#123;</span><br><span class="line">            protolists[protocount++] &#x3D; protolist;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F;æ”¶é›†äº†æ‰€æœ‰åè®® åˆ†ç±»æ–¹æ³•</span><br><span class="line">    auto rw &#x3D; cls-&gt;data();</span><br><span class="line"></span><br><span class="line">    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);</span><br><span class="line">&#x2F;&#x2F;è¿½åŠ æ‰€æœ‰åˆ†ç±»æ–¹æ³•</span><br><span class="line">    rw-&gt;methods.attachLists(mlists, mcount);</span><br><span class="line">&#x2F;&#x2F;é‡Šæ”¾æ•°ç»„</span><br><span class="line">    free(mlists);</span><br><span class="line">&#x2F;&#x2F;åˆ·æ–°è¯¥ç±»çš„ç¼“å­˜</span><br><span class="line">    if (flush_caches  &amp;&amp;  mcount &gt; 0) flushCaches(cls);</span><br><span class="line">&#x2F;&#x2F;è¿½åŠ æ‰€æœ‰åˆ†ç±»å±æ€§</span><br><span class="line">    rw-&gt;properties.attachLists(proplists, propcount);</span><br><span class="line">    free(proplists);&#x2F;&#x2F;é‡Šæ”¾æ•°ç»„</span><br><span class="line">&#x2F;&#x2F;è¿½åŠ æ‰€æœ‰åˆ†ç±»åè®®</span><br><span class="line">    rw-&gt;protocols.attachLists(protolists, protocount);</span><br><span class="line">    free(protolists);&#x2F;&#x2F;é‡Šæ”¾æ•°ç»„</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="rw-gt-list-gt-attachLists-è§£æ"><a href="#rw-gt-list-gt-attachLists-è§£æ" class="headerlink" title="rw-&gt;list-&gt;attachLists()è§£æ"></a>rw-&gt;list-&gt;attachLists()è§£æ</h4><p>æ·»åŠ <code>attachLists</code>å‡½æ•°è§„åˆ™æ˜¯åæ¥çš„å´æ·»åŠ åˆ°å†…å­˜çš„å‰éƒ¨åˆ†ï¼Œè¿™é‡Œå°±æ¸…æ¥šä¸ºä»€ä¹ˆåç¼–è¯‘ç±»åˆ«èƒ½åè¾¹çš„ç±»åˆ«è¦†ç›–å‰è¾¹çš„ç±»åˆ«çš„ç›¸åŒåå­—çš„æ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">void attachLists(List* const * addedLists, uint32_t addedCount) &#123;</span><br><span class="line">       if (addedCount &#x3D;&#x3D; 0) return;</span><br><span class="line"></span><br><span class="line">       if (hasArray()) &#123;</span><br><span class="line">           &#x2F;&#x2F; many lists -&gt; many lists</span><br><span class="line">           uint32_t oldCount &#x3D; array()-&gt;count;</span><br><span class="line">&#x2F;&#x2F;ä¸€å…±éœ€è¦çš„æ•°é‡</span><br><span class="line">           uint32_t newCount &#x3D; oldCount + addedCount;</span><br><span class="line">&#x2F;&#x2F;åˆ†é…å†…å­˜ å†…å­˜ä¸å¤Ÿç”¨äº†ï¼Œéœ€è¦æ‰©å®¹</span><br><span class="line">           setArray((array_t *)realloc(array(), array_t::byteSize(newCount)));</span><br><span class="line">&#x2F;&#x2F;èµ‹å€¼count</span><br><span class="line">           array()-&gt;count &#x3D; newCount;</span><br><span class="line">&#x2F;&#x2F; array()-&gt;listsï¼šåŸæ¥çš„æ–¹æ³•åˆ—è¡¨å‘åç§»åŠ¨ oldCount * sizeof(array()-&gt;lists[0]ä¸ªé•¿åº¦</span><br><span class="line">           memmove(array()-&gt;lists + addedCount&#x2F;*æ•°ç»„æœ«å°¾*&#x2F;, array()-&gt;lists&#x2F;*æ•°ç»„*&#x2F;,</span><br><span class="line">                   oldCount * sizeof(array()-&gt;lists[0])&#x2F;*ç§»åŠ¨çš„å¤§å°*&#x2F;);</span><br><span class="line">&#x2F;&#x2F;ç©ºå‡ºæ¥çš„ å†…å­˜ä½¿ç”¨addedListsæ‹·è´è¿‡å» å¤§å°æ˜¯:addedCount * sizeof(array()-&gt;lists[0])</span><br><span class="line">           memcpy(array()-&gt;lists, addedLists, </span><br><span class="line">                  addedCount * sizeof(array()-&gt;lists[0]));</span><br><span class="line">&#x2F;*</span><br><span class="line">å›¾ç¤ºè®²è§£ï¼š</span><br><span class="line">array()-&gt;lists:A-&gt;B-&gt;C-&gt;D-&gt;E</span><br><span class="line">addedCount:3</span><br><span class="line">addedLists:P-&gt;L-&gt;V</span><br><span class="line">memmoveä¹‹åï¼šnil-&gt;nil-&gt;nil-&gt;A-&gt;B-&gt;C-&gt;D-&gt;E</span><br><span class="line">ç„¶åå†è®²addedListsæ’å…¥åˆ°æ•°ç»„å‰è¾¹,æœ€ç»ˆarray()-&gt;listsçš„å€¼æ˜¯ï¼š</span><br><span class="line">P-&gt;L-&gt;V-&gt;A-&gt;B-&gt;C-&gt;D-&gt;E</span><br><span class="line"> *&#x2F;</span><br><span class="line">       &#125;</span><br><span class="line">       else if (!list  &amp;&amp;  addedCount &#x3D;&#x3D; 1) &#123;</span><br><span class="line">           &#x2F;&#x2F; 0 lists -&gt; 1 list</span><br><span class="line">           list &#x3D; addedLists[0];</span><br><span class="line">       &#125; </span><br><span class="line">       else &#123;</span><br><span class="line">           &#x2F;&#x2F; 1 list -&gt; many lists</span><br><span class="line">           List* oldList &#x3D; list;</span><br><span class="line">           uint32_t oldCount &#x3D; oldList ? 1 : 0;</span><br><span class="line">           uint32_t newCount &#x3D; oldCount + addedCount;</span><br><span class="line">           setArray((array_t *)malloc(array_t::byteSize(newCount)));</span><br><span class="line">           array()-&gt;count &#x3D; newCount;</span><br><span class="line">           if (oldList) array()-&gt;lists[addedCount] &#x3D; oldList;</span><br><span class="line">           memcpy(array()-&gt;lists, addedLists, </span><br><span class="line">                  addedCount * sizeof(array()-&gt;lists[0]));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><code>class</code>åˆå§‹åŒ–å®Œæˆäº†ï¼Œç„¶åå†æ¬¡å°è¯•è·å–<code>imp = cache_getImp</code>,ç”±äºç¼“å­˜æ²¡æœ‰ä¸­é—´ä¹Ÿæ²¡æ·»åŠ è¿›å»ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯ç©ºçš„ï¼Œç„¶åä»<code>getMethodNoSuper_nolock</code>è·å–è¯¥<code>cls</code>çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œæ²¡æœ‰çš„è¯å†ä»<code>superclass</code>æŸ¥æ‰¾<code>cache</code>å’Œ<code>method</code>,æ‰¾åˆ°çš„è¯ï¼Œè¿›è¡Œ<code>log_and_fill_cache</code>è‡³æ­¤æ¶ˆæ¯å‘é€å®Œæˆã€‚</p><h3 id="æ¶ˆæ¯åŠ¨æ€è§£æ"><a href="#æ¶ˆæ¯åŠ¨æ€è§£æ" class="headerlink" title="æ¶ˆæ¯åŠ¨æ€è§£æ"></a>æ¶ˆæ¯åŠ¨æ€è§£æ</h3><p>åŠ¨æ€è§£æå‡½æ•°<code>_class_resolveMethod(cls, sel, inst)</code>ï¼Œå¦‚æœä¸æ˜¯å…ƒç±»è°ƒç”¨<code>_class_resolveInstanceMethod</code>,å¦‚æœæ˜¯çš„è¯è°ƒç”¨<code>_class_resolveClassMethod</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;***********************************************************************</span><br><span class="line">* _class_resolveMethod</span><br><span class="line">* è°ƒç”¨ +resolveClassMethod æˆ–è€… +resolveInstanceMethod</span><br><span class="line">* å¦‚æœå­˜åœ¨äº†åˆ™ä¸æ£€æŸ¥</span><br><span class="line">**********************************************************************&#x2F;</span><br><span class="line">void _class_resolveMethod(Class cls, SEL sel, id inst)</span><br><span class="line">&#123;</span><br><span class="line">    if (! cls-&gt;isMetaClass()) &#123;&#x2F;&#x2F;ä¸æ˜¯å…ƒç±»åˆ™è°ƒç”¨ å®ä¾‹çš„</span><br><span class="line">&#x2F;&#x2F;é¦–å…ˆè°ƒç”¨</span><br><span class="line">_class_resolveInstanceMethod(cls, sel, inst);</span><br><span class="line">    &#125; </span><br><span class="line">    else &#123;</span><br><span class="line">        &#x2F;&#x2F; try [nonMetaClass resolveClassMethod:sel]</span><br><span class="line">        &#x2F;&#x2F; and [cls resolveInstanceMethod:sel]</span><br><span class="line">&#x2F;&#x2F;å¯»æ‰¾classMethod</span><br><span class="line">        _class_resolveClassMethod(cls, sel, inst);</span><br><span class="line">        if (!lookUpImpOrNil(cls, sel, inst, </span><br><span class="line">                            NO&#x2F;*initialize*&#x2F;, YES&#x2F;*cache*&#x2F;, NO&#x2F;*resolver*&#x2F;)) </span><br><span class="line">        &#123;</span><br><span class="line">            _class_resolveInstanceMethod(cls, sel, inst);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>resolveInstanceMethod</code>ï¼ŒæŸ¥æ‰¾<code>SEL_resolveInstanceMethod</code>ï¼Œä¼ å€¼ä¸ç”¨åˆå§‹åŒ–ï¼Œä¸ç”¨æ¶ˆæ¯è§£æï¼Œä½†æ˜¯<code>cache</code>è¦æŸ¥æ‰¾ã€‚æ²¡æœ‰æ‰¾åˆ°çš„ç›´æ¥è¿”å›ï¼Œæ‰¾åˆ°çš„è¯ä½¿ç”¨<code>objc_msgSend</code>å‘é€æ¶ˆæ¯è°ƒç”¨<code>SEL_resolveInstanceMethod</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;***********************************************************************</span><br><span class="line">* _class_resolveInstanceMethod</span><br><span class="line">* è°ƒç”¨ classæ·»åŠ çš„å‡½æ•° +resolveInstanceMethod</span><br><span class="line">* æœ‰å¯èƒ½æ˜¯å…ƒç±»</span><br><span class="line">* å¦‚æœæ–¹æ³•å­˜åœ¨åˆ™ä¸æ£€æŸ¥</span><br><span class="line">**********************************************************************&#x2F;</span><br><span class="line">static void _class_resolveInstanceMethod(Class cls, SEL sel, id inst)</span><br><span class="line">&#123;</span><br><span class="line">    if (! lookUpImpOrNil(cls-&gt;ISA(), SEL_resolveInstanceMethod, cls, </span><br><span class="line">                         NO&#x2F;*initialize*&#x2F;, YES&#x2F;*cache*&#x2F;, NO&#x2F;*resolver*&#x2F;)) </span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; Resolver not implemented.</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F;å¦‚æœæ‰¾åˆ°SEL_resolveInstanceMethod åˆ™ä½¿ç”¨objc_msgSendå‡½æ•°</span><br><span class="line">    BOOL (*msg)(Class, SEL, SEL) &#x3D; (typeof(msg))objc_msgSend;</span><br><span class="line">    bool resolved &#x3D; msg(cls, SEL_resolveInstanceMethod, sel);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Cache the result (good or bad) so the resolver doesn&#39;t fire next time.</span><br><span class="line">    &#x2F;&#x2F; +resolveInstanceMethod adds to self a.k.a. cls</span><br><span class="line">    IMP imp &#x3D; lookUpImpOrNil(cls, sel, inst, </span><br><span class="line">                             NO&#x2F;*initialize*&#x2F;, YES&#x2F;*cache*&#x2F;, NO&#x2F;*resolver*&#x2F;);</span><br><span class="line"></span><br><span class="line">    if (resolved  &amp;&amp;  PrintResolving) &#123;</span><br><span class="line">        if (imp) &#123;</span><br><span class="line">            _objc_inform(&quot;RESOLVE: method %c[%s %s] &quot;</span><br><span class="line">                         &quot;dynamically resolved to %p&quot;, </span><br><span class="line">                         cls-&gt;isMetaClass() ? &#39;+&#39; : &#39;-&#39;, </span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel), imp);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            &#x2F;&#x2F; Method resolver didn&#39;t add anything?</span><br><span class="line">            _objc_inform(&quot;RESOLVE: +[%s resolveInstanceMethod:%s] returned YES&quot;</span><br><span class="line">                         &quot;, but no new implementation of %c[%s %s] was found&quot;,</span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel), </span><br><span class="line">                         cls-&gt;isMetaClass() ? &#39;+&#39; : &#39;-&#39;, </span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>_class_resolveClassMethod</code>ä¸­ï¼Œç¬¬ä¸€æ­¥å…ˆå»<code>lookUpImpOrNil</code>æŸ¥æ‰¾<code>+SEL_resolveClassMethod</code>æ–¹æ³•ï¼Œæ²¡æ‰¾åˆ°çš„å°±ç»“æŸï¼Œæ‰¾åˆ°åˆ™è°ƒç”¨<code>objc_msgsend(id,sel)</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">static void _class_resolveClassMethod(Class cls, SEL sel, id inst)</span><br><span class="line">&#123;</span><br><span class="line">    assert(cls-&gt;isMetaClass());</span><br><span class="line"></span><br><span class="line">    if (! lookUpImpOrNil(cls, SEL_resolveClassMethod, inst, </span><br><span class="line">                         NO&#x2F;*initialize*&#x2F;, YES&#x2F;*cache*&#x2F;, NO&#x2F;*resolver*&#x2F;)) </span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;&#x2F; Resolver not implemented.</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BOOL (*msg)(Class, SEL, SEL) &#x3D; (typeof(msg))objc_msgSend;</span><br><span class="line">    bool resolved &#x3D; msg(_class_getNonMetaClass(cls, inst), </span><br><span class="line">                        SEL_resolveClassMethod, sel);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Cache the result (good or bad) so the resolver doesn&#39;t fire next time.</span><br><span class="line">    &#x2F;&#x2F; +resolveClassMethod adds to self-&gt;ISA() a.k.a. cls</span><br><span class="line">    IMP imp &#x3D; lookUpImpOrNil(cls, sel, inst, </span><br><span class="line">                             NO&#x2F;*initialize*&#x2F;, YES&#x2F;*cache*&#x2F;, NO&#x2F;*resolver*&#x2F;);</span><br><span class="line"></span><br><span class="line">    if (resolved  &amp;&amp;  PrintResolving) &#123;</span><br><span class="line">        if (imp) &#123;</span><br><span class="line">            _objc_inform(&quot;RESOLVE: method %c[%s %s] &quot;</span><br><span class="line">                         &quot;dynamically resolved to %p&quot;, </span><br><span class="line">                         cls-&gt;isMetaClass() ? &#39;+&#39; : &#39;-&#39;, </span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel), imp);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            &#x2F;&#x2F; Method resolver didn&#39;t add anything?</span><br><span class="line">            _objc_inform(&quot;RESOLVE: +[%s resolveClassMethod:%s] returned YES&quot;</span><br><span class="line">                         &quot;, but no new implementation of %c[%s %s] was found&quot;,</span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel), </span><br><span class="line">                         cls-&gt;isMetaClass() ? &#39;+&#39; : &#39;-&#39;, </span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŠ¨æ€è§£æè‡³æ­¤å®Œæˆã€‚</p><h3 id="æ¶ˆæ¯è½¬å‘"><a href="#æ¶ˆæ¯è½¬å‘" class="headerlink" title="æ¶ˆæ¯è½¬å‘"></a>æ¶ˆæ¯è½¬å‘</h3><p><code>_objc_msgForward_impcache</code>æ˜¯è½¬å‘çš„å‡½æ•°åœ°å€ï¼Œåœ¨æœç´¢æ¡†æœç´¢å‘ç°ï¼Œè¿™ä¸ªå‡½æ•°é™¤äº†<code>.s</code>æ–‡ä»¶ä¸­æœ‰ï¼Œå…¶ä»–åœ°æ–¹å‡åªæ˜¯è°ƒç”¨ï¼Œè¯´æ˜è¿™ä¸ªå‡½æ•°æ˜¯æ±‡ç¼–å®ç°ï¼Œåœ¨<code>objc-msg-arm64.s 531 è¡Œ</code>å‘ç°ä¸€ç‚¹è¸ªè¿¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ENTRY __objc_msgForward_impcache &#x2F;&#x2F;å¼€å§‹__objc_msgForward_impcache</span><br><span class="line">&#x2F;&#x2F; No stret specialization.</span><br><span class="line">b__objc_msgForward&#x2F;&#x2F;è·³è½¬-&gt;__objc_msgForward</span><br><span class="line">END_ENTRY __objc_msgForward_impcache &#x2F;&#x2F; ç»“æŸ__objc_msgForward_impcache</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ENTRY __objc_msgForward &#x2F;&#x2F; å¼€å§‹ __objc_msgForward</span><br><span class="line"></span><br><span class="line">adrpx17, __objc_forward_handler@PAGE</span><br><span class="line">ldrp17, [x17, __objc_forward_handler@PAGEOFF]&#x2F;&#x2F;p17&#x3D; x17 å’Œ __objc_forward_handler@PAGEOFFçš„å’Œ</span><br><span class="line">TailCallFunctionPointer x17 &#x2F;&#x2F;è·³è½¬-&gt; TailCallFunctionPointer</span><br><span class="line"></span><br><span class="line">END_ENTRY __objc_msgForward&#x2F;&#x2F;ç»“æŸ __objc_msgForward</span><br></pre></td></tr></table></figure><p>å½“è·³è½¬åˆ°<code>adrp    x17, __objc_forward_handler@PAGE</code>è¿™ä¸€è¡Œï¼Œæœæœç´¢å‡½æ•°<code>_objc_forward_handler</code>ï¼Œçœ‹åˆ°åªæ˜¯ä¸ªæ‰“å°å‡½æ•°ï¼Œå¹¶æ²¡æœ‰å…¶ä»–å‡½æ•°æ¥æ›¿ä»£è¿™ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬ç”¨å…¶ä»–æ–¹æ³•æ¥æ¢ç©¶ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((noreturn)) void </span><br><span class="line">objc_defaultForwardHandler(id self, SEL sel)</span><br><span class="line">&#123;</span><br><span class="line">    _objc_fatal(&quot;%c[%s %s]: unrecognized selector sent to instance %p &quot;</span><br><span class="line">                &quot;(no message forward handler is installed)&quot;, </span><br><span class="line">                class_isMetaClass(object_getClass(self)) ? &#39;+&#39; : &#39;-&#39;, </span><br><span class="line">                object_getClassName(self), sel_getName(sel), self);</span><br><span class="line">&#125;</span><br><span class="line">void *_objc_forward_handler &#x3D; (void*)objc_defaultForwardHandler;</span><br></pre></td></tr></table></figure><p>ç½‘ä¸Šæœ‰å¤§ç¥æ€»ç»“çš„ç‚¹æˆ‘ä»¬å…ˆå‚è€ƒä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; ä¼ªä»£ç </span><br><span class="line">int __forwarding__(void *frameStackPointer, int isStret) &#123;</span><br><span class="line">    id receiver &#x3D; *(id *)frameStackPointer;</span><br><span class="line">    SEL sel &#x3D; *(SEL *)(frameStackPointer + 8);</span><br><span class="line">    const char *selName &#x3D; sel_getName(sel);</span><br><span class="line">    Class receiverClass &#x3D; object_getClass(receiver);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; è°ƒç”¨ forwardingTargetForSelector:</span><br><span class="line">    if (class_respondsToSelector(receiverClass, @selector(forwardingTargetForSelector:))) &#123;</span><br><span class="line">        id forwardingTarget &#x3D; [receiver forwardingTargetForSelector:sel];</span><br><span class="line">        if (forwardingTarget &amp;&amp; forwardingTarget !&#x3D; receiver) &#123;</span><br><span class="line">            if (isStret &#x3D;&#x3D; 1) &#123;</span><br><span class="line">                int ret;</span><br><span class="line">                objc_msgSend_stret(&amp;ret,forwardingTarget, sel, ...);</span><br><span class="line">                return ret;</span><br><span class="line">            &#125;</span><br><span class="line">            return objc_msgSend(forwardingTarget, sel, ...);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; åƒµå°¸å¯¹è±¡</span><br><span class="line">    const char *className &#x3D; class_getName(receiverClass);</span><br><span class="line">    const char *zombiePrefix &#x3D; &quot;_NSZombie_&quot;;</span><br><span class="line">    size_t prefixLen &#x3D; strlen(zombiePrefix); &#x2F;&#x2F; 0xa</span><br><span class="line">    if (strncmp(className, zombiePrefix, prefixLen) &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        CFLog(kCFLogLevelError,</span><br><span class="line">              @&quot;*** -[%s %s]: message sent to deallocated instance %p&quot;,</span><br><span class="line">              className + prefixLen,</span><br><span class="line">              selName,</span><br><span class="line">              receiver);</span><br><span class="line">        &lt;breakpoint-interrupt&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; è°ƒç”¨ methodSignatureForSelector è·å–æ–¹æ³•ç­¾ååå†è°ƒç”¨ forwardInvocation</span><br><span class="line">    if (class_respondsToSelector(receiverClass, @selector(methodSignatureForSelector:))) &#123;</span><br><span class="line">        NSMethodSignature *methodSignature &#x3D; [receiver methodSignatureForSelector:sel];</span><br><span class="line">        if (methodSignature) &#123;</span><br><span class="line">            BOOL signatureIsStret &#x3D; [methodSignature _frameDescriptor]-&gt;returnArgInfo.flags.isStruct;</span><br><span class="line">            if (signatureIsStret !&#x3D; isStret) &#123;</span><br><span class="line">                CFLog(kCFLogLevelWarning ,</span><br><span class="line">                      @&quot;*** NSForwarding: warning: method signature and compiler disagree on struct-return-edness of &#39;%s&#39;.  Signature thinks it does%s return a struct, and compiler thinks it does%s.&quot;,</span><br><span class="line">                      selName,</span><br><span class="line">                      signatureIsStret ? &quot;&quot; : not,</span><br><span class="line">                      isStret ? &quot;&quot; : not);</span><br><span class="line">            &#125;</span><br><span class="line">            if (class_respondsToSelector(receiverClass, @selector(forwardInvocation:))) &#123;</span><br><span class="line">                NSInvocation *invocation &#x3D; [NSInvocation _invocationWithMethodSignature:methodSignature frame:frameStackPointer];</span><br><span class="line"></span><br><span class="line">                [receiver forwardInvocation:invocation];</span><br><span class="line"></span><br><span class="line">                void *returnValue &#x3D; NULL;</span><br><span class="line">                [invocation getReturnValue:&amp;value];</span><br><span class="line">                return returnValue;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                CFLog(kCFLogLevelWarning ,</span><br><span class="line">                      @&quot;*** NSForwarding: warning: object %p of class &#39;%s&#39; does not implement forwardInvocation: -- dropping message&quot;,</span><br><span class="line">                      receiver,</span><br><span class="line">                      className);</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SEL *registeredSel &#x3D; sel_getUid(selName);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; selector æ˜¯å¦å·²ç»åœ¨ Runtime æ³¨å†Œè¿‡</span><br><span class="line">    if (sel !&#x3D; registeredSel) &#123;</span><br><span class="line">        CFLog(kCFLogLevelWarning ,</span><br><span class="line">              @&quot;*** NSForwarding: warning: selector (%p) for message &#39;%s&#39; does not match selector known to Objective C runtime (%p)-- abort&quot;,</span><br><span class="line">              sel,</span><br><span class="line">              selName,</span><br><span class="line">              registeredSel);</span><br><span class="line">    &#125; &#x2F;&#x2F; doesNotRecognizeSelector</span><br><span class="line">    else if (class_respondsToSelector(receiverClass,@selector(doesNotRecognizeSelector:))) &#123;</span><br><span class="line">        [receiver doesNotRecognizeSelector:sel];</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        CFLog(kCFLogLevelWarning ,</span><br><span class="line">              @&quot;*** NSForwarding: warning: object %p of class &#39;%s&#39; does not implement doesNotRecognizeSelector: -- abort&quot;,</span><br><span class="line">              receiver,</span><br><span class="line">              className);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; The point of no return.</span><br><span class="line">    kill(getpid(), 9);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="éªŒè¯åŠ¨æ€è§£æ"><a href="#éªŒè¯åŠ¨æ€è§£æ" class="headerlink" title="éªŒè¯åŠ¨æ€è§£æ"></a>éªŒè¯åŠ¨æ€è§£æ</h3><p>æˆ‘ä»¬ç®€å•å®šä¹‰ä¸€ä¸ª<code>test</code>å‡½æ•°ï¼Œç„¶åå¹¶æ‰§è¡Œè¿™ä¸ªå‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@interface Person : NSObject</span><br><span class="line">- (void)test;</span><br><span class="line">@end</span><br><span class="line">@implementation Person</span><br><span class="line">+(BOOL)resolveInstanceMethod:(SEL)sel&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">if (sel &#x3D;&#x3D; @selector(test)) &#123;</span><br><span class="line">Method me &#x3D; class_getInstanceMethod(self, @selector(test2));</span><br><span class="line">class_addMethod(self, sel,</span><br><span class="line">method_getImplementation(me),</span><br><span class="line">method_getTypeEncoding(me));</span><br><span class="line">return YES;</span><br><span class="line">&#125;</span><br><span class="line">return [super resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line">-(void)test2&#123;</span><br><span class="line">NSLog(@&quot;æ¥äº†ï¼Œè€å¼Ÿ&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">Person *p &#x3D; [[Person alloc]init];</span><br><span class="line">[p test];</span><br><span class="line">[p test];</span><br><span class="line"> &#x2F;&#x2F;è¾“å‡º</span><br><span class="line">+[FYPerson resolveInstanceMethod:]</span><br><span class="line"> -[FYPerson test3]</span><br><span class="line"> -[FYPerson test3]</span><br></pre></td></tr></table></figure><p><code>[p test]</code>åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ä¼šèµ°åˆ°æ¶ˆæ¯åŠ¨æ€è§£æçš„è¿™ä¸€æ­¥,ç„¶åé€šè¿‡<code>objc_msgsend</code>è°ƒç”¨äº†<code>test</code>ï¼Œå¹¶ä¸”æŠŠ<code>test</code>æ·»åŠ åˆ°äº†ç¼“å­˜ä¸­ï¼Œæ‰€ä»¥è¾“å‡ºäº†<code>+[FYPerson resolveInstanceMethod:]</code>ï¼Œåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šä»ç¼“å­˜ä¸­æŸ¥åˆ°<code>imp</code>ï¼Œæ‰€ä»¥ç›´æ¥è¾“å‡ºäº†<code>-[FYPerson test3]</code>ã€‚</p><p>åœ¨<code>+resolveInstanceMethod</code>å¯ä»¥æ‹¦æˆªæ‰å®ä¾‹æ–¹æ³•çš„åŠ¨æ€è§£æï¼Œåœ¨<code>+resolveClassMethod</code>å¯ä»¥æ‹¦æˆªç±»æ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@interface Person : NSObject</span><br><span class="line">+ (void)test;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">+ (void)test3&#123;</span><br><span class="line">NSLog(@&quot;æ¥äº†ï¼Œè€å¼Ÿ&quot;);</span><br><span class="line">&#125;</span><br><span class="line">+ (BOOL)resolveClassMethod:(SEL)sel&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">if (sel &#x3D;&#x3D; @selector(test)) &#123;</span><br><span class="line">Method me &#x3D; class_getClassMethod(self, @selector(test3));&#x2F;&#x2F;è·å–method</span><br><span class="line">&#x2F;&#x2F;ç»™sel æ·»åŠ æ–¹æ³•å®ç° @selecter(test3)</span><br><span class="line">class_addMethod(object_getClass(self), sel,</span><br><span class="line">method_getImplementation(me),</span><br><span class="line">method_getTypeEncoding(me));</span><br><span class="line">return YES;</span><br><span class="line">&#125;</span><br><span class="line">return [super resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[Person test];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">+[Person resolveClassMethod:]</span><br><span class="line">æ¥äº†ï¼Œè€å¼Ÿ</span><br></pre></td></tr></table></figure><p>æ‹¦æˆª<code>+resolveClassMethod</code>,åœ¨æ¡ä»¶ä¸º<code>sel==@selector(test)</code>çš„æ—¶å€™ï¼Œå°†å‡½æ•°å®ç°<code>+test3()</code>çš„<code>IMP</code>ä½¿ç”¨<code>class_addMethod</code>æ·»åŠ åˆ°<code>Person</code>ä¸Šï¼Œå¾…ä¸‹æ¬¡è°ƒç”¨<code>test</code>çš„æ—¶å€™ç›´æ¥é€šè¿‡<code>imp = cache_getImp(cls, sel);</code>è·å–åˆ°<code>imp</code>å‡½æ•°æŒ‡é’ˆå¹¶ä¸”æ‰§è¡Œã€‚<br>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ·»åŠ cå‡½æ•°çš„impæ¥å®ç°ç»™classæ·»åŠ å‡½æ•°å®ç°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+(BOOL)resolveInstanceMethod:(SEL)sel&#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">    if (sel &#x3D;&#x3D; @selector(test)) &#123;</span><br><span class="line">&#x2F;&#x2F;        Method me &#x3D; class_getInstanceMethod(self, @selector(test3));</span><br><span class="line">&#x2F;&#x2F;        class_addMethod(self.class, sel, method_getImplementation(me), method_getTypeEncoding(me));</span><br><span class="line">        class_addMethod(self.class, sel, (IMP)test3, &quot;v16@0:8&quot;);</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return [super resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line">void test3(id self,SEL sel)&#123;</span><br><span class="line">    NSLog(@&quot;test3:%s&quot;,NSStringFromSelector(sel).UTF8String);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">+[FYPerson resolveInstanceMethod:]</span><br><span class="line">test3:test</span><br><span class="line">test3:test</span><br></pre></td></tr></table></figure><p><code>v16@0:8</code>æ˜¯è¿”å›å€¼ä¸º<code>void</code>å‚æ•°å ç”¨16å­—èŠ‚å¤§å°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä»0å¼€å§‹ï¼Œç¬¬äºŒä¸ªä»8å­—èŠ‚å¼€å§‹ã€‚<br>è¿™æ®µä»£ç å’Œä¸Šé¢çš„å…¶å®æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œä¸€ä¸ªæ˜¯ç»™<code>class</code>æ·»åŠ å‡½æ•°å®ç°ï¼Œä½¿<code>sel</code>å’Œ<code>imp</code>å¯¹åº”èµ·æ¥ï¼Œè¿™ä¸ªæ˜¯å°†<code>c</code>å‡½æ•°çš„<code>imp</code>å’Œ<code>sel</code>è¿›è¡Œå…³è”ï¼Œæ·»åŠ ç¼“å­˜ä¹‹åï¼Œä½¿ç”¨<code>objc_msgsend()</code>æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p><h3 id="éªŒè¯æ¶ˆæ¯è½¬å‘"><a href="#éªŒè¯æ¶ˆæ¯è½¬å‘" class="headerlink" title="éªŒè¯æ¶ˆæ¯è½¬å‘"></a>éªŒè¯æ¶ˆæ¯è½¬å‘</h3><p>æ¶ˆæ¯è½¬å‘å¯åˆ†ä¸º3æ­¥ï¼Œç¬¬ä¸€æ­¥æ ¹æ®<code>- (id)forwardingTargetForSelector:(SEL)aSelector</code>è¿”å›çš„ç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡ï¼Œå°†æ–¹æ³•è½¬å‘ç»™è¯¥å¯¹è±¡ã€‚å‡å¦‚ç¬¬ä¸€æ­¥æ²¡å®ç°ï¼Œåˆ™ç¬¬äºŒæ­¥æ ¹æ®è¿”å›çš„<code>-(NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>æˆ–<code>+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>å‡½æ•°ç­¾åï¼Œåœ¨ç¬¬ä¸‰æ­¥<code>(void)forwardInvocation:(NSInvocation *)anInvocation</code>è°ƒç”¨å‡½æ•°<code>[anInvocation invoke]</code>è¿›è¡Œæ ¡éªŒæˆåŠŸä¹‹åè¿›è¡Œè°ƒç”¨å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@interface Person : NSObject</span><br><span class="line">- (void)test;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">#import &quot;Person.h&quot;</span><br><span class="line">#import &quot;Student.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation Person</span><br><span class="line">- (id)forwardingTargetForSelector:(SEL)aSelector&#123;</span><br><span class="line">if (aSelector &#x3D;&#x3D; @selector(test)) &#123;</span><br><span class="line">&#x2F;&#x2F;objc_msgSend([[Struent alloc]init],test)</span><br><span class="line">return [[Struent alloc]init];</span><br><span class="line">&#125;</span><br><span class="line">return [super forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">-[Student test]</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>Person</code>åªå£°æ˜äº†<code>test</code>æ²¡æœ‰å®ç°ï¼Œç„¶ååœ¨æ¶ˆæ¯è½¬å‘ç¬¬ä¸€æ­¥<code>forwardingTargetForSelector</code>å°†è¦å¤„ç†çš„å¯¹è±¡è¿”å›ï¼ŒæˆåŠŸè°ƒç”¨äº†<code>Student</code>çš„<code>test</code>æ–¹æ³•ã€‚</p><p>ç¬¬ä¸€æ­¥æ²¡æ‹¦æˆªï¼Œå¯ä»¥åœ¨ç¬¬äºŒæ­¥æ‹¦æˆªã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;æ¶ˆæ¯è½¬å‘ç¬¬äºŒæ­¥ æ²¡æœ‰å¯¹è±¡æ¥å¤„ç†æ–¹æ³•ï¼Œé‚£å°†å‡½æ•°ç­¾åæ¥å®ç°</span><br><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">if (aSelector &#x3D;&#x3D; @selector(test)) &#123;</span><br><span class="line">NSMethodSignature *sign &#x3D; [NSMethodSignature signatureWithObjCTypes:&quot;v16@0:8&quot;];</span><br><span class="line">return sign;</span><br><span class="line">&#125;</span><br><span class="line">return [super methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; å‡½æ•°ç­¾åå·²è¿”å›ï¼Œåˆ°äº†å‡½æ•°è°ƒç”¨çš„åœ°æ–¹</span><br><span class="line">&#x2F;&#x2F;selector å‡½æ•°çš„sel</span><br><span class="line">&#x2F;&#x2F;target   å‡½æ•°è°ƒç”¨è€…</span><br><span class="line">&#x2F;&#x2F;methodSignature å‡½æ•°ç­¾å</span><br><span class="line">&#x2F;&#x2F;NSInvocation  å°è£…æ•°æ®çš„å¯¹è±¡</span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation&#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">-[Person forwardInvocation:]</span><br></pre></td></tr></table></figure></p><p>æ‰“å°å‡ºäº†<code>-[Person forwardInvocation:]</code>è€Œä¸”æ²¡æœ‰å´©æºƒï¼Œåœ¨<code>forwardInvocation:(NSInvocation *)anInvocation</code>æ€ä¹ˆæ“ä½œçœ‹å¼€å‘è€…æ€ä¹ˆå¤„ç†äº†ï¼Œæ¢ç©¶ä¸‹éƒ½å¯ä»¥åšä»€ä¹ˆäº‹æƒ…ã€‚<br>çœ‹åˆ°<code>NSInvocation</code>çš„å±æ€§å’Œå‡½æ•°,<code>sel</code>å’Œ<code>target</code>æ˜¯è¯»å†™ï¼Œå‡½æ•°ç­¾åæ˜¯å¿…é¡»çš„ï¼Œæ‰€ä»¥<code>(NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>å¿…é¡»å°†å‡½æ•°ç­¾åè¿”å›ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@property (readonly, retain) NSMethodSignature *methodSignature;&#x2F;&#x2F;åªè¯»</span><br><span class="line">- (void)retainArguments;</span><br><span class="line">@property (readonly) BOOL argumentsRetained;</span><br><span class="line">@property (nullable, assign) id target;&#x2F;&#x2F;è¯»å†™</span><br><span class="line">@property SEL selector;&#x2F;&#x2F;è¯»å†™</span><br></pre></td></tr></table></figure><p>å½“æ‹¦æˆªæ–¹æ³•æ˜¯ç±»æ–¹æ³•çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨<code>+ (id)forwardingTargetForSelector:(SEL)aSelecto</code>æ‹¦æˆªï¼Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;class è½¬å‘</span><br><span class="line">&#x2F;&#x2F; æ¶ˆæ¯è½¬å‘ç¬¬ä¸€æ­¥ æ‹¦æˆªæ˜¯å¦æœ‰è½¬å‘çš„classå¯¹è±¡å¤„ç†æ–¹æ³•</span><br><span class="line">+ (id)forwardingTargetForSelector:(SEL)aSelector&#123;</span><br><span class="line">if (aSelector &#x3D;&#x3D; @selector(test3)) &#123;</span><br><span class="line">&#x2F;&#x2F;objc_msgSend([[Struent alloc]init],test)</span><br><span class="line">return [Student class];</span><br><span class="line">&#125;</span><br><span class="line">return [super forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)test3&#123;</span><br><span class="line">&#x2F;&#x2F;NSLog(@&quot;+[Student test3]&quot;);</span><br><span class="line">&#x2F;&#x2F;å½“[Person test3]ä¸Šä¸€è¡Œå†™è¿™ä¹ˆä¸€è¡Œï¼ŒPerson *p &#x3D; [[Person alloc]init] è¿™å¥æŠ¥é”™</span><br><span class="line">&#x2F;&#x2F;æš‚æ—¶ä¸æ‡‚ä¸ºä»€ä¹ˆä¸èƒ½è°ƒç”¨NSLogï¼Œä½†æ˜¯å·²ç»è¿›æ¥äº†æ‰€ä»¥è°ƒç”¨äº†test2ã€‚</span><br><span class="line">&#x2F;&#x2F;æ³¨é‡Šæ‰ [[Person alloc]init]ï¼Œä¸€åˆ‡æ­£å¸¸ã€‚ æœ‰å¤§ä½¬äº†è§£å—</span><br><span class="line">&#125;</span><br><span class="line">- (void)test2&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¾“å‡º</span><br><span class="line">-[Student test2]</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥ç”¨è¿”å›<code>return [[Student alloc]init];</code>å°†<code>class</code>ç±»æ–¹æ³•è½¬åŒ–æˆå®ä¾‹æ–¹æ³•,æœ€åè°ƒç”¨äº†<code>Student</code>çš„å¯¹è±¡æ–¹æ³•<code>test3</code>ã€‚å…¶å®æœ¬è´¨ä¸Šéƒ½æ˜¯<code>objc_msgSend(id,SEL,...)</code>ï¼Œæˆ‘ä»¬ä¿®æ”¹çš„åªæ˜¯<code>id</code>çš„å€¼ï¼Œ<code>id</code>ç±»å‹åœ¨è¿™æ®µä»£ç ä¸­æœ¬è´¨æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥<code>return instance</code>ä¹Ÿå¯ä»¥<code>reurn class</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+ (id)forwardingTargetForSelector:(SEL)aSelector&#123;</span><br><span class="line">if (aSelector &#x3D;&#x3D; @selector(test3)) &#123;</span><br><span class="line">&#x2F;&#x2F;objc_msgSend([[Struent alloc]init],test)</span><br><span class="line">return [[Student alloc]init];</span><br><span class="line">&#125;</span><br><span class="line">return [super forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)test3&#123;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">-[Student test3]</span><br></pre></td></tr></table></figure><p>å°†åˆšæ‰å†™çš„<code>methodSignatureForSelector</code>å’Œ<code>forwardInvocation</code>æ”¹æˆç±»æ–¹æ³•ï¼Œä¹Ÿæ˜¯åŒæ ·å¯ä»¥æ‹¦æˆªç±»æ–¹æ³•çš„ã€‚æˆ‘ä»¬çœ‹ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;æ¶ˆæ¯è½¬å‘ç¬¬äºŒæ­¥ æ²¡æœ‰classæ¥å¤„ç†æ–¹æ³•ï¼Œé‚£å°†å‡½æ•°ç­¾åæ¥å®ç°</span><br><span class="line">+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">if (aSelector &#x3D;&#x3D; @selector(test3)) &#123;</span><br><span class="line">NSMethodSignature *sign &#x3D; [NSMethodSignature signatureWithObjCTypes:&quot;v16@0:8&quot;];</span><br><span class="line">return sign;</span><br><span class="line">&#125;</span><br><span class="line">return [super methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; å‡½æ•°ç­¾åå·²è¿”å›ï¼Œåˆ°äº†å‡½æ•°è°ƒç”¨çš„åœ°æ–¹</span><br><span class="line">&#x2F;&#x2F;selector å‡½æ•°çš„sel</span><br><span class="line">&#x2F;&#x2F;target   å‡½æ•°è°ƒç”¨è€…</span><br><span class="line">&#x2F;&#x2F;methodSignature å‡½æ•°ç­¾å</span><br><span class="line">&#x2F;&#x2F;NSInvocation  å°è£…æ•°æ®çš„å¯¹è±¡</span><br><span class="line">+ (void)forwardInvocation:(NSInvocation *)anInvocation&#123;</span><br><span class="line">&#x2F;&#x2F;anInvocation.selector &#x3D; @selector(test2);</span><br><span class="line">&#x2F;&#x2F;æ­¤å¤„æ¢æˆ[Student class]åŒæ ·å¯ä»¥</span><br><span class="line">&#x2F;&#x2F;anInvocation.target &#x3D; (id)[[Student alloc]init];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;[anInvocation invoke];</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">+[Person forwardInvocation:]</span><br></pre></td></tr></table></figure><p>æµ‹è¿‡å…¶å®å¯¹è±¡æ–¹æ³•å’Œç±»æ–¹æ³•éƒ½æ˜¯ç”¨åŒæ ·çš„æµç¨‹æ‹¦æˆªçš„ï¼Œå¯¹è±¡æ–¹æ³•æ˜¯ç”¨<code>-</code>æ–¹æ³•,ç±»æ–¹æ³•æ˜¯ç”¨<code>+</code>æ–¹æ³•ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>objc_msgSendå‘é€æ¶ˆæ¯ï¼Œä¼šé¦–å…ˆåœ¨cacheä¸­æŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾ä¸åˆ°åˆ™å»æ–¹æ³•åˆ—è¡¨(é¡ºåºæ˜¯<code>cache-&gt;class_rw_t-&gt;supclass cache -&gt;superclass class_rw_t -&gt;åŠ¨æ€è§£æ</code>)</li><li>ç¬¬äºŒæ­¥æ˜¯åŠ¨æ€è§£æï¼Œèƒ½åœ¨resolveInstanceMethodæˆ–+ (BOOL)resolveClassMethod:(SEL)selæ¥æ¥æ‹¦æˆªï¼Œå¯ä»¥ç»™classæ–°å¢å®ç°å‡½æ•°ï¼Œè¾¾åˆ°ä¸å´©æºƒç›®çš„</li><li>ç¬¬ä¸‰æ­¥æ˜¯æ¶ˆæ¯è½¬å‘ï¼Œè½¬å‘ç¬¬ä¸€æ­¥å¯ä»¥åœ¨<code>+ (id)forwardingTargetForSelector:(SEL)aSelector</code>æˆ–<code>- (id)forwardingTargetForSelector:(SEL)aSelector</code>æ‹¦æˆªç±»æˆ–å®ä¾‹æ–¹æ³•ï¼Œèƒ½å°†å¯¹è±¡æ–¹æ³•è½¬å‘ç»™å…¶ä»–å¯¹è±¡ï¼Œä¹Ÿèƒ½å°†å¯¹è±¡æ–¹æ³•è½¬å‘ç»™ç±»æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å°†ç±»æ–¹æ³•è½¬å‘ç»™å®ä¾‹æ–¹æ³•</li><li>ç¬¬ä¸‰æ­¥æ¶ˆæ¯è½¬å‘çš„ç¬¬äºŒæ­¥å¯ä»¥åœ¨<code>+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>æˆ–<code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>å®ç°æ‹¦æˆªç±»å’Œå®ä¾‹æ–¹æ³•å¹¶è¿”å›å‡½æ•°ç­¾å</li><li>ç¬¬ä¸‰æ­¥æ¶ˆæ¯è½¬å‘çš„ç¬¬ä¸‰æ­¥å¯ä»¥<code>+ (void)forwardInvocation:(NSInvocation *)anInvocation</code>æˆ–<code>- (void)forwardInvocation:(NSInvocation *)anInvocation</code>å®ç°ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•çš„è°ƒç”¨å’Œè·å–è¿”å›å€¼</li></ul><h4 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h4><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9vYmpjNC03NTA=" title="https://github.com/ifgyong/demo/tree/master/OC/objc4-750">runtimeå¯è¿è¡Œçš„æºç <i class="fa fa-external-link"></i></span></li></ul><p>æœ¬æ–‡ç« ä¹‹æ‰€ä»¥å›¾ç‰‡æ¯”è¾ƒå°‘ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯è·Ÿç€ä»£ç æ•²ä¸€éï¼Œå°è±¡æ¯”è¾ƒæ·±åˆ»ã€‚</p><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p><p>å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;arm64ä¹‹åisaæ˜¯ä½¿ç”¨è”åˆä½“ä½¿ç”¨æ›´å°‘çš„ç©ºé—´å­˜å‚¨æ›´å¤šçš„æ•°æ®ï¼Œä»¥åŠå¦‚ä½•è‡ªå®šä¹‰å’Œä½¿ç”¨è”åˆä½“ï¼Œ&lt;code&gt;objc_class-&amp;gt;cache_t cache&lt;/code&gt;æ˜¯ä¸€ä¸ªæ˜¯ç¼“å­˜æœ€è¿‘è°ƒç”¨&lt;code&gt;class&lt;/code&gt;çš„æ–¹æ³•ï¼Œå½“ç¼“å­˜å‰©ä½™ç©ºé—´å°ä½™1/4åˆ™è¿›è¡Œæ‰©å®¹ï¼Œæ‰©
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç† runtime-object_classæ‹¾é—åŸºç¡€ç¯‡--(6)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20runtime-object_class%E6%8B%BE%E9%81%97%E5%9F%BA%E7%A1%80%E7%AF%87--(6)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20runtime-object_class%E6%8B%BE%E9%81%97%E5%9F%BA%E7%A1%80%E7%AF%87--(6)/</id>
    <published>2019-12-01T03:16:58.000Z</published>
    <updated>2020-09-04T04:40:21.659Z</updated>
    
    <content type="html"><![CDATA[<h3 id="runtime-åŸºç¡€çŸ¥è¯†"><a href="#runtime-åŸºç¡€çŸ¥è¯†" class="headerlink" title="runtime åŸºç¡€çŸ¥è¯†"></a>runtime åŸºç¡€çŸ¥è¯†</h3><p><code>runtime</code>æ˜¯è¿è¡Œæ—¶ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™åšä¸€äº›äº‹è¯·ï¼Œå¯ä»¥åŠ¨æ€æ·»åŠ ç±»å’Œäº¤æ¢å‡½æ•°ï¼Œé‚£ä¹ˆæœ‰ä¸€ä¸ªåŸºç¡€çŸ¥è¯†éœ€è¦äº†è§£ï¼Œarm64æ¶æ„å‰ï¼ŒisaæŒ‡é’ˆæ˜¯æ™®é€šæŒ‡é’ˆï¼Œå­˜å‚¨classå’Œmeta-classå¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œä»arm64æ¶æ„å¼€å§‹ï¼Œå¯¹isaè¿›è¡Œäº†ä¼˜åŒ–ï¼Œå˜æˆäº†ä¸€ä¸ª<code>union</code>å…±ç”¨ä½“ï¼Œè¿˜æ˜¯ç”¨ä½åŸŸæ¥å­˜å‚¨æ›´å¤šçš„ä¿¡æ¯ï¼Œæˆ‘ä»¬é¦–å…ˆçœ‹ä¸€ä¸‹isaæŒ‡é’ˆçš„ç»“æ„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">struct objc_object &#123;</span><br><span class="line">private:</span><br><span class="line">    isa_t isa;</span><br><span class="line">public:</span><br><span class="line">    &#x2F;&#x2F; ISA() assumes this is NOT a tagged pointer object</span><br><span class="line">    Class ISA();</span><br><span class="line">    &#x2F;&#x2F; getIsa() allows this to be a tagged pointer object</span><br><span class="line">    Class getIsa();</span><br><span class="line">    &#x2F;&#x2F;****</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#include &quot;isa.h&quot;</span><br><span class="line">union isa_t &#123;</span><br><span class="line">    isa_t() &#123; &#125;</span><br><span class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    uintptr_t bits;</span><br><span class="line">#if defined(ISA_BITFIELD)</span><br><span class="line">    struct &#123;</span><br><span class="line">        ISA_BITFIELD;  &#x2F;&#x2F; defined in isa.h</span><br><span class="line">    &#125;;</span><br><span class="line">#endif</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>objc_object</code>æ˜¯ç»“æ„ä½“ï¼ŒåŒ…å«äº†ç§æœ‰å±æ€§<code>isa_t</code>,<code>isa_t isa</code>æ˜¯ä¸€ä¸ªå…±ç”¨ä½“ï¼ŒåŒ…å«äº†<code>ISA_BITFIELD</code>æ˜¯ä¸€ä¸ªå®(ç»“æ„ä½“)ï¼Œ<code>bits</code>æ˜¯<code>uintptr_t</code>ç±»å‹ï¼Œ<code>uintptr_t</code>å…¶å®æ˜¯<code>unsign long</code>ç±»å‹å ç”¨8å­—èŠ‚ï¼Œå°±æ˜¯64ä½ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°<code>ISA_BITFIELD</code>å†…éƒ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"># if __arm64__</span><br><span class="line">#   define ISA_MASK        0x0000000ffffffff8ULL</span><br><span class="line">#   define ISA_MAGIC_MASK  0x000003f000000001ULL</span><br><span class="line">#   define ISA_MAGIC_VALUE 0x000001a000000001ULL</span><br><span class="line">#   define ISA_BITFIELD                                         </span><br><span class="line">      uintptr_t nonpointer        : 1;                              </span><br><span class="line">      uintptr_t has_assoc         : 1;                                  </span><br><span class="line">      uintptr_t has_cxx_dtor      : 1;                                  </span><br><span class="line">      uintptr_t shiftcls          : 33; &#x2F;*MACH_VM_MAX_ADDRESS 0x1000000000*&#x2F; \</span><br><span class="line">      uintptr_t magic             : 6;                                  </span><br><span class="line">      uintptr_t weakly_referenced : 1;                                  </span><br><span class="line">      uintptr_t deallocating      : 1;                                  </span><br><span class="line">      uintptr_t has_sidetable_rc  : 1;                                  </span><br><span class="line">      uintptr_t extra_rc          : 19</span><br><span class="line">#   define RC_ONE   (1ULL&lt;&lt;45)</span><br><span class="line">#   define RC_HALF  (1ULL&lt;&lt;18)</span><br><span class="line"></span><br><span class="line"># elif __x86_64__</span><br><span class="line">#   define ISA_MASK        0x00007ffffffffff8ULL</span><br><span class="line">#   define ISA_MAGIC_MASK  0x001f800000000001ULL</span><br><span class="line">#   define ISA_MAGIC_VALUE 0x001d800000000001ULL</span><br><span class="line">#   define ISA_BITFIELD                                                 </span><br><span class="line">      uintptr_t nonpointer        : 1;                                  </span><br><span class="line">      uintptr_t has_assoc         : 1;                                  </span><br><span class="line">      uintptr_t has_cxx_dtor      : 1;                                  </span><br><span class="line">      uintptr_t shiftcls          : 44; &#x2F;*MACH_VM_MAX_ADDRESS 0x7fffffe00000*&#x2F; \</span><br><span class="line">      uintptr_t magic             : 6;                                  </span><br><span class="line">      uintptr_t weakly_referenced : 1;                                  </span><br><span class="line">      uintptr_t deallocating      : 1;                                  </span><br><span class="line">      uintptr_t has_sidetable_rc  : 1;                                  </span><br><span class="line">      uintptr_t extra_rc          : 8</span><br><span class="line">#   define RC_ONE   (1ULL&lt;&lt;56)</span><br><span class="line">#   define RC_HALF  (1ULL&lt;&lt;7)</span><br><span class="line"># else</span><br><span class="line">#   error unknown architecture for packed isa</span><br><span class="line"># endif</span><br></pre></td></tr></table></figure><p><code>ISA_BITFIELD</code>åœ¨<code>arm64</code>å’Œ<code>x86</code>æ˜¯ä¸¤ç§ç»“æ„ï¼Œå­˜å‚¨äº†<code>nonpointer</code>,<code>has_assoc</code>,<code>has_cxx_dtor</code>,<code>shiftcls</code>,<code>magic</code>,<code>weakly_referenced</code>,<code>deallocating</code>,<code>has_sidetable_rc</code>,<code>extra_rc</code>è¿™äº›ä¿¡æ¯ï¼Œ<code>:1</code>å°±å ç”¨äº†ä¸€ä½ï¼Œ<code>:44</code>å°±æ˜¯å ç”¨äº†44ä½ï¼Œ<code>:6</code>å°±æ˜¯å ç”¨äº†6ä½ï¼Œ<code>:8</code>å°±æ˜¯å ç”¨äº†8ä½ï¼Œé‚£ä¹ˆå…±ç”¨ä½“<code>isa_t</code>ç®€åŒ–ä¹‹å</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">union isa_t &#123;</span><br><span class="line">    isa_t() &#123; &#125;</span><br><span class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    uintptr_t bits;</span><br><span class="line">    struct &#123;</span><br><span class="line">      uintptr_t nonpointer        : 1;                                </span><br><span class="line">      uintptr_t has_assoc         : 1;                                  </span><br><span class="line">      uintptr_t has_cxx_dtor      : 1;                                  </span><br><span class="line">      uintptr_t shiftcls          : 44; &#x2F;*MACH_VM_MAX_ADDRESS 0x7fffffe00000*&#x2F; \</span><br><span class="line">      uintptr_t magic             : 6;                                  </span><br><span class="line">      uintptr_t weakly_referenced : 1;                                  </span><br><span class="line">      uintptr_t deallocating      : 1;                                  </span><br><span class="line">      uintptr_t has_sidetable_rc  : 1;                                  </span><br><span class="line">      uintptr_t extra_rc          : 8</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>isa_t</code>æ˜¯ä½¿ç”¨å…±ç”¨ä½“ç»“æ„ï¼Œä½¿ç”¨<code>bits</code>å­˜å‚¨äº†ç»“æ„ä½“çš„æ•°æ®ï¼Œé‚£ä¹ˆå…±ç”¨ä½“æ˜¯å¦‚ä½•ä½¿ç”¨çš„ï¼Ÿæˆ‘ä»¬æ¥æ¢ç©¶ä¸€ä¸‹</p><h4 id="å…±ç”¨ä½“åŸºç¡€çŸ¥è¯†"><a href="#å…±ç”¨ä½“åŸºç¡€çŸ¥è¯†" class="headerlink" title="å…±ç”¨ä½“åŸºç¡€çŸ¥è¯†"></a>å…±ç”¨ä½“åŸºç¡€çŸ¥è¯†</h4><p>é¦–å…ˆæˆ‘ä»¬å®šä¹‰ä¸€ä¸ª<code>FYPerson</code>ï¼Œæ·»åŠ 2ä¸ªå±æ€§</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,assign) BOOL rich;</span><br><span class="line">@property (nonatomic,assign) BOOL tell;</span><br><span class="line">@property (nonatomic,assign) BOOL handsome;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>ç„¶åæŸ¥çœ‹è¯¥ç±»çš„å®ä¾‹å ç”¨ç©ºé—´å¤§å°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FYPerson *p&#x3D;[[FYPerson alloc]init];</span><br><span class="line">p.handsome &#x3D; YES;</span><br><span class="line">p.rich &#x3D; NO;</span><br><span class="line">NSLog(@&quot;å¤§å°ï¼š%zu&quot;,class_getInstanceSize(FYPerson.class));</span><br><span class="line">&#x2F;&#x2F;16</span><br></pre></td></tr></table></figure><p><code>FYPerson</code>å®šä¹‰äº†ä¸‰ä¸ªå±æ€§ï¼Œå ç”¨ç©ºé—´æ˜¯16å­—èŠ‚ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ¢ä¸€ç§æ–¹æ³•å®ç°è¿™ä¸ªä¸‰ä¸ªå±æ€§çš„åŠŸèƒ½ã€‚<br>æˆ‘ä»¬å®šä¹‰6ä¸ªæ–¹æ³•ï¼Œ3ä¸ªsetæ–¹æ³•ï¼Œ3ä¸ªgetæ–¹æ³•ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">- (void)setTall:(BOOL)tall;</span><br><span class="line">- (void)setRich:(BOOL)rich;</span><br><span class="line">- (void)setHandsome:(BOOL)handsome;</span><br><span class="line"></span><br><span class="line">- (BOOL)isTall;</span><br><span class="line">- (BOOL)isRich;</span><br><span class="line">- (BOOL)isHandsome;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å®ç°ï¼š</span><br><span class="line">&#x2F;&#x2F;ä½¿ç”¨0b00000000ä¸æ˜¯å¾ˆæ˜“è¯»ï¼Œæˆ‘ä»¬æ¢æˆä¸‹è¾¹çš„å†™æ³•1&lt;&lt;0</span><br><span class="line">&#x2F;&#x2F;#define FYHandsomeMask 0b00000001</span><br><span class="line">&#x2F;&#x2F;#define FYTallMask 0b00000010</span><br><span class="line">&#x2F;&#x2F;#define FYRichMask 0b00000001</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#define FYHandsomeMask (1&lt;&lt;0)</span><br><span class="line">#define FYTallMask (1&lt;&lt;1)</span><br><span class="line">#define FYRichMask (1&lt;&lt;2)</span><br><span class="line"></span><br><span class="line">@interface FYPerson()</span><br><span class="line">&#123;</span><br><span class="line">char _richTellHandsome;&#x2F;&#x2F;0000 0000 rich tall handsome</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@implementation FYPerson</span><br><span class="line"></span><br><span class="line">- (void)setRich:(BOOL)tall&#123;</span><br><span class="line">if (tall) &#123;</span><br><span class="line">_richTellHandsome &#x3D; _richTellHandsome|FYRichMask;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">_richTellHandsome &#x3D; _richTellHandsome&amp;~FYRichMask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">- (void)setTall:(BOOL)tall&#123;</span><br><span class="line">if (tall) &#123;</span><br><span class="line">_richTellHandsome &#x3D; _richTellHandsome|FYTallMask;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">_richTellHandsome &#x3D; _richTellHandsome&amp;~FYTallMask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">- (void)setHandsome:(BOOL)tall&#123;</span><br><span class="line">if (tall) &#123;</span><br><span class="line">_richTellHandsome &#x3D; _richTellHandsome|FYHandsomeMask;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">_richTellHandsome &#x3D; _richTellHandsome&amp;~FYHandsomeMask;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isRich&#123;</span><br><span class="line">return !!(_richTellHandsome&amp;FYRichMask);</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isTall&#123;</span><br><span class="line">return !!(_richTellHandsome&amp;FYTallMask);</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isHandsome&#123;</span><br><span class="line">return !!(_richTellHandsome&amp;FYHandsomeMask);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªcharç±»å‹çš„å˜é‡<code>_richTellHandsome</code>,4å­—èŠ‚ï¼Œ32ä½ï¼Œå¯ä»¥å­˜å‚¨32ä¸ªboolç±»å‹çš„å˜é‡ã€‚èµ‹å€¼æ˜¯ä½¿ç”¨<code>_richTellHandsome = _richTellHandsome|FYRichMask</code>,æˆ–<code>_richTellHandsome = _richTellHandsome&amp;~FYRichMask</code>,å–å€¼æ˜¯<code>!!(_richTellHandsome&amp;FYRichMask)</code>ï¼Œå‰è¾¹åŠ <code>!!</code>æ˜¯è½¬åŒ–æˆ<code>bool</code>ç±»å‹çš„ï¼Œå¦åˆ™å–å€¼å‡ºæ¥æ˜¯<code>1 or  2 or 4</code>ã€‚æˆ‘ä»¬å†æ¢ä¸€ç§æ€è·¯å°†ä¸‰ä¸ªå˜é‡å®šä¹‰æˆä¸€ä¸ªç»“æ„ä½“ï¼Œå–å€¼å’Œèµ‹å€¼éƒ½æ˜¯å¯ä»¥ç›´æ¥æ“ä½œçš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson()</span><br><span class="line">&#123;</span><br><span class="line">&#x2F;&#x2F;char _richTellHandsome;&#x2F;&#x2F;0000 0000 rich tall handsome</span><br><span class="line">&#x2F;&#x2F;ä½åŸŸ</span><br><span class="line">struct&#123;</span><br><span class="line">char tall : 1;&#x2F;&#x2F;é«˜åº¦</span><br><span class="line">char rich : 1;&#x2F;&#x2F;å¯Œæœ‰</span><br><span class="line">char handsome : 1; &#x2F;&#x2F;å¸…</span><br><span class="line">&#125; _richTellHandsome; &#x2F;&#x2F; 0b0000 0000</span><br><span class="line">&#x2F;&#x2F;ä½¿ç”¨2ä½ yeså°±æ˜¯0b01 è½¬åŒ–æˆ1å­—èŠ‚8ä½å°±æ˜¯:0o0101 0101 ç»“æœæ˜¯1</span><br><span class="line">&#x2F;&#x2F;ä½¿ç”¨1ä½ yeså°±æ˜¯0b1 è½¬åŒ–æˆ1å­—èŠ‚8ä½å°±æ˜¯:0o1111 1111 æ‰€ä»¥ç»“æœæ˜¯-1</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@implementation FYPerson</span><br><span class="line"></span><br><span class="line">- (void)setRich:(BOOL)tall&#123;</span><br><span class="line">_richTellHandsome.rich &#x3D; tall;</span><br><span class="line">&#125;</span><br><span class="line">- (void)setTall:(BOOL)tall&#123;</span><br><span class="line">_richTellHandsome.tall &#x3D; tall;</span><br><span class="line">&#125;</span><br><span class="line">- (void)setHandsome:(BOOL)tall&#123;</span><br><span class="line">_richTellHandsome.handsome &#x3D; tall;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isRich&#123;</span><br><span class="line">return !!_richTellHandsome.rich;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isTall&#123;</span><br><span class="line">return !!_richTellHandsome.tall;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isHandsome&#123;</span><br><span class="line">return !!_richTellHandsome.handsome;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>ç»“æ„ä½“<code>_richTellHandsome</code>åŒ…å«ä¸‰ä¸ªå˜é‡<code>char tall : 1;</code>,<code>char rich : 1;</code>,<code>char handsome : 1</code>ã€‚æ¯ä¸€ä¸ªå˜é‡å ç”¨ç©ºé—´ä¸º1ä½ï¼Œ3ä¸ªå˜é‡å ç”¨3ä½ã€‚å–å€¼çš„æ—¶å€™ä½¿ç”¨<code>!!(_richTellHandsome&amp;FYHandsomeMask)</code>ï¼Œèµ‹å€¼ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (tall) &#123;</span><br><span class="line">_richTellHandsome &#x3D; _richTellHandsome|FYHandsomeMask;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">_richTellHandsome &#x3D; _richTellHandsome&amp;~FYHandsomeMask</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬é‡‡ç”¨ä½åŸŸæ¥å­˜å‚¨ä¿¡æ¯ï¼Œ<br>ä½åŸŸæ˜¯æŒ‡ä¿¡æ¯åœ¨å­˜å‚¨æ—¶ï¼Œå¹¶ä¸éœ€è¦å ç”¨ä¸€ä¸ªå®Œæ•´çš„å­—èŠ‚ï¼Œ è€Œåªéœ€å å‡ ä¸ªæˆ–ä¸€ä¸ªäºŒè¿›åˆ¶ä½ã€‚ä¾‹å¦‚åœ¨å­˜æ”¾ä¸€ä¸ªå¼€å…³é‡æ—¶ï¼Œåªæœ‰0å’Œ1 ä¸¤ç§çŠ¶æ€ï¼Œ ç”¨ä¸€ä½äºŒè¿›ä½å³å¯ã€‚ä¸ºäº†èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œå¹¶ä½¿å¤„ç†ç®€ä¾¿ï¼ŒCè¯­è¨€åˆæä¾›äº†ä¸€ç§æ•°æ®ç»“æ„ï¼Œç§°ä¸ºâ€œä½åŸŸâ€æˆ–â€œä½æ®µâ€ã€‚æ‰€è°“â€œä½åŸŸâ€æ˜¯æŠŠä¸€ä¸ªå­—èŠ‚ä¸­çš„äºŒè¿›ä½åˆ’åˆ†ä¸ºå‡  ä¸ªä¸åŒçš„åŒºåŸŸï¼Œ å¹¶è¯´æ˜æ¯ä¸ªåŒºåŸŸçš„ä½æ•°ã€‚æ¯ä¸ªåŸŸæœ‰ä¸€ä¸ªåŸŸåï¼Œå…è®¸åœ¨ç¨‹åºä¸­æŒ‰åŸŸåè¿›è¡Œæ“ä½œã€‚ è¿™æ ·å°±å¯ä»¥æŠŠå‡ ä¸ªä¸åŒçš„å¯¹è±¡ç”¨ä¸€ä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶ä½åŸŸæ¥è¡¨ç¤ºã€‚</p><p>å¦å¤–ä¸€ä¸ªçœç©ºé—´çš„æ€è·¯æ˜¯ä½¿ç”¨<code>è”åˆ</code>,<br>ä½¿ç”¨<code>union</code>ï¼Œå¯ä»¥æ›´çœç©ºé—´ï¼Œâ€œè”åˆâ€æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»ï¼Œä¹Ÿæ˜¯ä¸€ç§æ„é€ ç±»å‹çš„æ•°æ®ç»“æ„ã€‚åœ¨ä¸€ä¸ªâ€œè”åˆâ€å†…å¯ä»¥å®šä¹‰å¤šç§ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œ ä¸€ä¸ªè¢«è¯´æ˜ä¸ºè¯¥â€œè”åˆâ€ç±»å‹çš„å˜é‡ä¸­ï¼Œå…è®¸è£…å…¥è¯¥â€œè”åˆâ€æ‰€å®šä¹‰çš„ä»»ä½•ä¸€ç§æ•°æ®ï¼Œè¿™äº›æ•°æ®å…±äº«åŒä¸€æ®µå†…å­˜ï¼Œä»¥è¾¾åˆ°èŠ‚çœç©ºé—´çš„ç›®çš„ï¼ˆè¿˜æœ‰ä¸€ä¸ªèŠ‚çœç©ºé—´çš„ç±»å‹ï¼šä½åŸŸï¼‰ã€‚ è¿™æ˜¯ä¸€ä¸ªéå¸¸ç‰¹æ®Šçš„åœ°æ–¹ï¼Œä¹Ÿæ˜¯è”åˆçš„ç‰¹å¾ã€‚å¦å¤–ï¼ŒåŒstructä¸€æ ·ï¼Œè”åˆé»˜è®¤è®¿é—®æƒé™ä¹Ÿæ˜¯å…¬æœ‰çš„ï¼Œå¹¶ä¸”ï¼Œä¹Ÿå…·æœ‰æˆå‘˜å‡½æ•°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson()</span><br><span class="line">&#123;</span><br><span class="line">union &#123;</span><br><span class="line">char bits; &#x2F;&#x2F;ä¸€ä¸ªå­—èŠ‚8ä½ ricH &#x2F;tall&#x2F;handsomeéƒ½æ˜¯å ç”¨çš„bitsçš„å†…å­˜ç©ºé—´</span><br><span class="line">struct&#123;</span><br><span class="line">char tall : 1;&#x2F;&#x2F;é«˜åº¦</span><br><span class="line">char rich : 1;&#x2F;&#x2F;å¯Œæœ‰</span><br><span class="line">char handsome : 1; &#x2F;&#x2F;å¸…</span><br><span class="line">&#125;; &#x2F;&#x2F; 0b0000 0000</span><br><span class="line">&#125;_richTellHandsome;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@implementation FYPerson</span><br><span class="line"></span><br><span class="line">- (void)setRich:(BOOL)tall&#123;</span><br><span class="line">if (tall) &#123;</span><br><span class="line">_richTellHandsome.bits |&#x3D; FYRichMask;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">_richTellHandsome.bits &amp;&#x3D; ~FYRichMask;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)setTall:(BOOL)tall&#123;</span><br><span class="line">if (tall) &#123;</span><br><span class="line">_richTellHandsome.bits |&#x3D; FYTallMask;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">_richTellHandsome.bits &amp;&#x3D; ~FYTallMask;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)setHandsome:(BOOL)tall&#123;</span><br><span class="line">if (tall) &#123;</span><br><span class="line">_richTellHandsome.bits |&#x3D; FYHandsomeMask;</span><br><span class="line">&#125;else&#123;</span><br><span class="line">_richTellHandsome.bits &amp;&#x3D; ~FYHandsomeMask;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isRich&#123;</span><br><span class="line">return !!(_richTellHandsome.bits &amp; FYRichMask);</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isTall&#123;</span><br><span class="line">return !!(_richTellHandsome.bits &amp; FYTallMask);</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)isHandsome&#123;</span><br><span class="line">return (_richTellHandsome.bits &amp; FYHandsomeMask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>è”åˆ</code>å…±ç”¨ä½“ï¼Œè¾¾åˆ°çœç©ºé—´çš„ç›®çš„ï¼Œ<code>runtime</code>æºç ä¸­æ˜¯ç”¨æ¥å¾ˆå¤š<code>union</code>å’Œä½è¿ç®—ã€‚<br>ä¾‹å¦‚KVO çš„NSKeyValueObservingOptions<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef NS_OPTIONS(NSUInteger, NSKeyValueObservingOptions)&#123;</span><br><span class="line">        NSKeyValueObservingOptionNew &#x3D; 0x01,</span><br><span class="line">    NSKeyValueObservingOptionOld &#x3D; 0x02,</span><br><span class="line">    NSKeyValueObservingOptionInitial &#x3D; 0x04,</span><br><span class="line">    NSKeyValueObservingOptionPrior &#x3D; 0x08</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><br>è¿™ä¸ª<code>NSKeyValueObservingOptions</code>ä½¿ç”¨ä½åŸŸï¼Œå½“ä¼ è¿›å»çš„æ—¶å€™<code>NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld</code>,åˆ™ä¼ è¿›å»çš„å€¼ä¸º<code>0x3</code>,è½¬åŒ–æˆäºŒè¿›åˆ¶å°±æ˜¯<code>0b11</code>ï¼Œåˆ™ä¸¤ä½éƒ½æ˜¯<code>1</code>å¯ä»¥åŒ…å«2ä¸ªå€¼ã€‚<br>é‚£ä¹ˆæˆ‘ä»¬æ¥è®¾è®¡ä¸€ä¸ªç®€å•çš„å¯ä»¥ä½¿ç”¨æˆ–æ¥ä¼ å€¼çš„æšä¸¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">typedef enum &#123;</span><br><span class="line">FYOne &#x3D; 1,&#x2F;&#x2F;  0b 0001</span><br><span class="line">FYTwo &#x3D; 2,&#x2F;&#x2F;  0b 0010</span><br><span class="line">FYTHree &#x3D; 4,&#x2F;&#x2F;0b 0100</span><br><span class="line">FYFour &#x3D; 8,&#x2F;&#x2F; 0b 1000</span><br><span class="line">&#125;FYOptions;</span><br><span class="line"></span><br><span class="line">- (void)setOptions:(FYOptions )ops&#123;</span><br><span class="line">if (ops &amp;FYOne) &#123;</span><br><span class="line">NSLog(@&quot;FYOne is show&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if (ops &amp;FYTwo) &#123;</span><br><span class="line">NSLog(@&quot;FYTwo is show&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if (ops &amp;FYTHree) &#123;</span><br><span class="line">NSLog(@&quot;FYTHree is show&quot;);</span><br><span class="line">&#125;</span><br><span class="line">if (ops &amp;FYFour) &#123;</span><br><span class="line">NSLog(@&quot;FYFour is show&quot;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[self setOptions:FYOne|FYTwo|FYTHree];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è¾“å‡ºæ˜¯ï¼š</span><br><span class="line">FYOne is show</span><br><span class="line">FYTwo is show</span><br><span class="line">FYTHree is show</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªåå­—ä¸º<code>FYOptions</code>çš„æšä¸¾ï¼Œç¬¬ä¸€ä¸ªæ˜¯åè¿›åˆ¶æ˜¯1ï¼ŒäºŒè¿›åˆ¶æ˜¯<code>0b 0001</code>,ç¬¬äºŒä¸ªåè¿›åˆ¶æ˜¯2ï¼ŒäºŒè¿›åˆ¶æ˜¯<code>0b 0010</code>,ç¬¬ä¸‰ä¸ªåè¿›åˆ¶æ˜¯4ï¼ŒäºŒè¿›åˆ¶æ˜¯<code>0b 0100</code>,ç¬¬å››ä¸ªåè¿›åˆ¶æ˜¯8ï¼ŒäºŒè¿›åˆ¶æ˜¯<code>0b 1000</code>ã€‚<br>é‚£ä¹ˆæˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™å¯ä»¥<code>FYOne|FYTwo|FYTHree</code>ï¼Œæ‰“åŒ…æˆä¸€ä¸ªå€¼ï¼Œç›¸å½“äº<code>1|2|4 = 7</code>,äºŒè¿›åˆ¶è¡¨ç¤ºæ˜¯<code>0b0111</code>ï¼Œåä¸‰ä½éƒ½æ˜¯1ï¼Œå¯ä»¥é€šè¿‡&amp;maskå–å‡ºå¯¹åº”çš„æ¯ä¸€ä½çš„æ•°å€¼ã€‚</p><h4 id="Classçš„ç»“æ„"><a href="#Classçš„ç»“æ„" class="headerlink" title="Classçš„ç»“æ„"></a>Classçš„ç»“æ„</h4><p>isaè¯¦è§£ â€“ ä½åŸŸå­˜å‚¨çš„æ•°æ®åŠå…¶å«ä¹‰</p><table><thead><tr><th>å‚æ•°</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>nonpointer</td><td>0-&gt;ä»£è¡¨æ™®é€šçš„æŒ‡é’ˆï¼Œå­˜å‚¨ç€Classã€Meta-Classå¯¹è±¡çš„å†…å­˜åœ°å€ã€‚1-&gt;ä»£è¡¨ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šçš„ä¿¡æ¯</td></tr><tr><td>has_assoc</td><td>æ˜¯å¦æœ‰è®¾ç½®è¿‡å…³è”å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«</td></tr><tr><td>has_cxx_dtor</td><td>æ˜¯å¦æœ‰C++çš„ææ„å‡½æ•°ï¼ˆ.cxx_destructï¼‰ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«</td></tr><tr><td>shiftcls</td><td>å­˜å‚¨ç€Classã€Meta-Classå¯¹è±¡çš„å†…å­˜åœ°å€ä¿¡æ¯</td></tr><tr><td>magic</td><td>ç”¨äºåœ¨è°ƒè¯•æ—¶åˆ†è¾¨å¯¹è±¡æ˜¯å¦æœªå®Œæˆåˆå§‹åŒ–</td></tr><tr><td>weakly_referenced</td><td>æ˜¯å¦æœ‰è¢«å¼±å¼•ç”¨æŒ‡å‘è¿‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«</td></tr><tr><td>deallocating</td><td>å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾</td></tr><tr><td>extra_rc</td><td>é‡Œé¢å­˜å‚¨çš„å€¼æ˜¯å¼•ç”¨è®¡æ•°å™¨å‡1</td></tr><tr><td>has_sidetable_rc</td><td>å¼•ç”¨è®¡æ•°å™¨æ˜¯å¦è¿‡å¤§æ— æ³•å­˜å‚¨åœ¨isaä¸­</td></tr></tbody></table><p>å¦‚æœä¸º1ï¼Œé‚£ä¹ˆå¼•ç”¨è®¡æ•°ä¼šå­˜å‚¨åœ¨ä¸€ä¸ªå«SideTableçš„ç±»çš„å±æ€§ä¸­|</p><p>classç»“æ„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">struct fy_objc_class : xx_objc_object &#123;</span><br><span class="line">Class superclass;</span><br><span class="line">cache_t cache;</span><br><span class="line">class_data_bits_t bits;</span><br><span class="line">public:</span><br><span class="line">class_rw_t* data() &#123;</span><br><span class="line">return bits.data();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fy_objc_class* metaClass() &#123; &#x2F;&#x2F; æä¾›metaClasså‡½æ•°ï¼Œè·å–å…ƒç±»å¯¹è±¡</span><br><span class="line">&#x2F;&#x2F; ä¸Šä¸€ç¯‡æˆ‘ä»¬è®²è§£è¿‡ï¼ŒisaæŒ‡é’ˆéœ€è¦ç»è¿‡ä¸€æ¬¡ &amp; ISA_MASKæ“ä½œä¹‹åæ‰å¾—åˆ°çœŸæ­£çš„åœ°å€</span><br><span class="line">return (fy_objc_class *)((long long)isa &amp; ISA_MASK);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">struct class_rw_t &#123;</span><br><span class="line">uint32_t flags;</span><br><span class="line">uint32_t version;</span><br><span class="line">const class_ro_t *ro;&#x2F;&#x2F;åªè¯» æ•°æ®</span><br><span class="line">method_list_t * methods;    &#x2F;&#x2F; æ–¹æ³•åˆ—è¡¨</span><br><span class="line">property_list_t *properties;    &#x2F;&#x2F; å±æ€§åˆ—è¡¨</span><br><span class="line">const protocol_list_t * protocols;  &#x2F;&#x2F; åè®®åˆ—è¡¨</span><br><span class="line">Class firstSubclass;</span><br><span class="line">Class nextSiblingClass;</span><br><span class="line">char *demangledName;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">struct class_ro_t &#123;</span><br><span class="line">uint32_t flags;</span><br><span class="line">uint32_t instanceStart;</span><br><span class="line">uint32_t instanceSize;  &#x2F;&#x2F; instanceå¯¹è±¡å ç”¨çš„å†…å­˜ç©ºé—´</span><br><span class="line">#ifdef __LP64__</span><br><span class="line">uint32_t reserved;</span><br><span class="line">#endif</span><br><span class="line">const uint8_t * ivarLayout;</span><br><span class="line">const char * name;  &#x2F;&#x2F; ç±»å</span><br><span class="line">method_list_t * baseMethodList;</span><br><span class="line">protocol_list_t * baseProtocols;</span><br><span class="line">const ivar_list_t * ivars;  &#x2F;&#x2F; æˆå‘˜å˜é‡åˆ—è¡¨</span><br><span class="line">const uint8_t * weakIvarLayout;</span><br><span class="line">property_list_t *baseProperties;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>class_ro_t</code>æ˜¯åªè¯»çš„ï¼Œ<code>class_rw_t</code>æ˜¯è¯»å†™çš„ï¼Œåœ¨æºç ä¸­<code>runtime</code>-&gt;<code>Source</code>-&gt;<code>objc-runtime-new.mm</code>-&gt;<code>static Class realizeClass(Class cls) 1869è¡Œ</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">    const class_ro_t *ro;</span><br><span class="line">    class_rw_t *rw;</span><br><span class="line">    Class supercls;</span><br><span class="line">    Class metacls;</span><br><span class="line">    bool isMeta;</span><br><span class="line"></span><br><span class="line">    if (!cls) return nil;</span><br><span class="line">    &#x2F;&#x2F;å¦‚æœå·²æ³¨å†Œ å°±è¿”å›</span><br><span class="line">    if (cls-&gt;isRealized()) return cls;</span><br><span class="line">    assert(cls &#x3D;&#x3D; remapClass(cls));</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; fixme verify class is not in an un-dlopened part of the shared cache?</span><br><span class="line">&#x2F;&#x2F;åªè¯»ro</span><br><span class="line">    ro &#x3D; (const class_ro_t *)cls-&gt;data();</span><br><span class="line">    if (ro-&gt;flags &amp; RO_FUTURE) &#123;</span><br><span class="line">        &#x2F;&#x2F; This was a future class. rw data is already allocated.</span><br><span class="line">        rw &#x3D; cls-&gt;data();&#x2F;&#x2F;åˆå§‹åŒ–ro</span><br><span class="line">        ro &#x3D; cls-&gt;data()-&gt;ro;</span><br><span class="line">        cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        &#x2F;&#x2F; Normal class. Allocate writeable class data.</span><br><span class="line">        &#x2F;&#x2F;åˆå§‹åŒ– rw </span><br><span class="line">        rw &#x3D; (class_rw_t *)calloc(sizeof(class_rw_t), 1);</span><br><span class="line">        rw-&gt;ro &#x3D; ro;</span><br><span class="line">        rw-&gt;flags &#x3D; RW_REALIZED|RW_REALIZING;</span><br><span class="line">        &#x2F;&#x2F;æŒ‡é’ˆæŒ‡å‘rw ä¸€å¼€å§‹æ˜¯æŒ‡å‘roçš„</span><br><span class="line">        cls-&gt;setData(rw);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isMeta &#x3D; ro-&gt;flags &amp; RO_META;</span><br><span class="line"></span><br><span class="line">    rw-&gt;version &#x3D; isMeta ? 7 : 0;  &#x2F;&#x2F; old runtime went up to 6</span><br><span class="line">&#96;</span><br></pre></td></tr></table></figure><p>å¼€å§‹<code>cls-&gt;data</code>æŒ‡å‘çš„æ˜¯<code>ro</code>ï¼Œåˆå§‹åŒ–ä¹‹åï¼ŒæŒ‡å‘çš„<code>rw</code>,<code>rw-&gt;ro</code>æŒ‡å‘çš„æ˜¯åŸæ¥çš„<code>ro</code>ã€‚<br><code>class_rw_t</code>ä¸­çš„<code>method_array_t</code>æ˜¯å­˜å‚¨çš„æ–¹æ³•åˆ—è¡¨ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°<code>method_array_t</code>çœ‹ä¸‹å®ƒçš„æ•°æ®ç»“æ„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">class method_array_t : </span><br><span class="line">    public list_array_tt&lt;method_t, method_list_t&gt; </span><br><span class="line">&#123;</span><br><span class="line">    typedef list_array_tt&lt;method_t, method_list_t&gt; Super;</span><br><span class="line"></span><br><span class="line"> public:</span><br><span class="line">    method_list_t **beginCategoryMethodLists() &#123;</span><br><span class="line">        return beginLists();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    method_list_t **endCategoryMethodLists(Class cls);</span><br><span class="line"></span><br><span class="line">    method_array_t duplicate() &#123;</span><br><span class="line">        return Super::duplicate&lt;method_array_t&gt;();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>method_array_t</code>æ˜¯ä¸€ä¸ªç±»ï¼Œå­˜å‚¨äº†<code>method_t</code>äºŒç»´æ•°ç»„ï¼Œé‚£ä¹ˆæˆ‘ä»¬çœ‹ä¸‹<code>method_t</code>çš„ç»“æ„</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">struct method_t &#123;</span><br><span class="line">    SEL name;</span><br><span class="line">    const char *types;</span><br><span class="line">    MethodListIMP imp;</span><br><span class="line"></span><br><span class="line">    struct SortBySELAddress :</span><br><span class="line">        public std::binary_function&lt;const method_t&amp;,const method_t&amp;, bool&gt;</span><br><span class="line">    &#123;</span><br><span class="line">        bool operator() (const method_t&amp; lhs,</span><br><span class="line">                         const method_t&amp; rhs)</span><br><span class="line">        &#123; return lhs.name &lt; rhs.name; &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>method_t</code>æ˜¯å­˜å‚¨äº†3ä¸ªå˜é‡çš„ç»“æ„ä½“ï¼Œ<code>SEL</code>æ˜¯æ–¹æ³•åï¼Œ<code>types</code>æ˜¯ç¼–ç (æ–¹æ³•è¿”å›ç±»å‹ï¼Œå‚æ•°ç±»å‹)ï¼Œ <code>imp</code>å‡½æ•°æŒ‡é’ˆ(å‡½æ•°åœ°å€)ã€‚</p><h5 id="SEL"><a href="#SEL" class="headerlink" title="SEL"></a>SEL</h5><ul><li>SELä»£è¡¨æ–¹æ³•\å‡½æ•°åï¼Œä¸€èˆ¬å«åšé€‰æ‹©å™¨ï¼Œåº•å±‚ç»“æ„è·Ÿchar *ç±»ä¼¼</li><li>å¯ä»¥é€šè¿‡@selector()å’Œsel_registerName()è·å¾—</li><li>å¯ä»¥é€šè¿‡sel_getName()å’ŒNSStringFromSelector()è½¬æˆå­—ç¬¦ä¸²</li><li>ä¸åŒç±»ä¸­ç›¸åŒåå­—çš„æ–¹æ³•ï¼Œæ‰€å¯¹åº”çš„æ–¹æ³•é€‰æ‹©å™¨æ˜¯ç›¸åŒçš„</li></ul><h5 id="Type-Encoding"><a href="#Type-Encoding" class="headerlink" title="Type Encoding"></a>Type Encoding</h5><p>iOSä¸­æä¾›äº†ä¸€ä¸ªå«åš@encodeçš„æŒ‡ä»¤ï¼Œå¯ä»¥å°†å…·ä½“çš„ç±»å‹è½¬æˆå­—ç¬¦ç¼–ç ï¼Œ<span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2xpYnJhcnkvYXJjaGl2ZS9kb2N1bWVudGF0aW9uL0NvY29hL0NvbmNlcHR1YWwvT2JqQ1J1bnRpbWVHdWlkZS9BcnRpY2xlcy9vY3J0VHlwZUVuY29kaW5ncy5odG1s" title="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjCRuntimeGuide/Articles/ocrtTypeEncodings.html">å®˜æ–¹ç½‘ç«™æ’ä»¶encodeing<i class="fa fa-external-link"></i></span></p><table><thead><tr><th>code</th><th>Meaning</th></tr></thead><tbody><tr><td>c</td><td>A char</td></tr><tr><td>i</td><td>An int</td></tr><tr><td>s</td><td>A short</td></tr><tr><td>l</td><td>A long</td></tr><tr><td>l</td><td>is treated as a 32-bit quantity on 64-bit programs.</td></tr><tr><td>q</td><td>A long long</td></tr><tr><td>C</td><td>An unsigned char</td></tr><tr><td>I</td><td>An unsigned int</td></tr><tr><td>S</td><td>An unsigned short</td></tr><tr><td>L</td><td>An unsigned long</td></tr><tr><td>Q</td><td>An unsigned long long</td></tr><tr><td>f</td><td>A float</td></tr><tr><td>d</td><td>A double</td></tr><tr><td>B</td><td>A C++ bool or a C99 _Bool</td></tr><tr><td>v</td><td>A void</td></tr><tr><td>*</td><td>A character string (char *)</td></tr><tr><td>@</td><td>An object (whether statically typed or typed id)</td></tr><tr><td>#</td><td>A class object (Class)</td></tr><tr><td>:</td><td>A method selector (SEL)</td></tr><tr><td>[array type]</td><td>An array</td></tr><tr><td>{name=typeâ€¦}</td><td>A structure</td></tr><tr><td>(name=typeâ€¦)</td><td>A union</td></tr><tr><td>bnum</td><td>A bit field of num bits</td></tr><tr><td>^type</td><td>A pointer to type</td></tr><tr><td>?</td><td>An unknown type (among other things, this code is used for function pointers)</td></tr></tbody></table><p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥äº†è§£encode</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">-(void)test:(int)age heiht:(float)height&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FYPerson *p&#x3D;[[FYPerson alloc]init];</span><br><span class="line">SEL sel &#x3D; @selector(test:heiht:);</span><br><span class="line">Method m1&#x3D; class_getInstanceMethod(p.class, sel);</span><br><span class="line">const char *type &#x3D; method_getTypeEncoding(m1);</span><br><span class="line">NSLog(@&quot;%s&quot;,type);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">v24@0:8i16f20</span><br><span class="line">&#x2F;&#x2F;0id 8 SEL 16 int 20 float &#x3D; 24</span><br></pre></td></tr></table></figure><p><code>v24@0:8i16f20</code>æ˜¯encodingçš„å€¼ï¼Œæˆ‘ä»¬æ¥åˆ†è§£ä¸€ä¸‹ï¼Œå‰è¾¹æ˜¯<code>v24</code>æ˜¯å‡½æ•°è¿”å›å€¼æ˜¯<code>void</code>ï¼Œæ‰€æœ‰å‚æ•°å ç”¨äº†<code>24</code>å­—èŠ‚,<code>@0:8</code>æ˜¯ä»ç¬¬0å¼€å§‹ï¼Œé•¿åº¦æ˜¯8å­—èŠ‚çš„ä½ç½®ï¼Œ<code>i16</code>æ˜¯ä»16å­—èŠ‚å¼€å§‹çš„<code>int</code>ç±»å‹ï¼Œ<code>f20</code>æ˜¯ä»20å­—èŠ‚å¼€å§‹ï¼Œç±»å‹æ˜¯<code>float</code>ã€‚</p><h4 id="æ–¹æ³•ç¼“å­˜"><a href="#æ–¹æ³•ç¼“å­˜" class="headerlink" title="æ–¹æ³•ç¼“å­˜"></a>æ–¹æ³•ç¼“å­˜</h4><p>Classå†…éƒ¨ç»“æ„ä¸­æœ‰ä¸ªæ–¹æ³•ç¼“å­˜ï¼ˆcache_tï¼‰ï¼Œç”¨æ•£åˆ—è¡¨ï¼ˆå“ˆå¸Œè¡¨ï¼‰æ¥ç¼“å­˜æ›¾ç»è°ƒç”¨è¿‡çš„æ–¹æ³•ï¼Œå¯ä»¥æé«˜æ–¹æ³•çš„æŸ¥æ‰¾é€Ÿåº¦ã€‚<br>æˆ‘ä»¬æ¥åˆ°<code>cache_t</code>å†…éƒ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">struct cache_t &#123;</span><br><span class="line">    struct bucket_t *_buckets;&#x2F;&#x2F;æ•£åˆ—è¡¨</span><br><span class="line">    mask_t _mask;&#x2F;&#x2F;æ•£åˆ—è¡¨é•¿åº¦-1</span><br><span class="line">    mask_t _occupied;&#x2F;&#x2F;å·²ç»å­˜å‚¨çš„æ–¹æ³•æ•°é‡</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct bucket_t &#123;</span><br><span class="line">#if __arm64__</span><br><span class="line">    MethodCacheIMP _imp;</span><br><span class="line">    cache_key_t _key;</span><br><span class="line">#else</span><br><span class="line">    cache_key_t _key;&#x2F;&#x2F;SELä½œä¸ºkey </span><br><span class="line">    MethodCacheIMP _imp; &#x2F;&#x2F;å‡½æ•°åœ°å€</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•£åˆ—è¡¨çš„æ•°æ®ç»“æ„è¡¨æ ¼æ‰€ç¤º</p><table><thead><tr><th>ç´¢å¼•</th><th>bucket_t</th></tr></thead><tbody><tr><td>0</td><td>bucket_t(_key,_imp)</td></tr><tr><td>1</td><td>bucket_t(_key,_imp)</td></tr><tr><td>2</td><td>bucket_t(_key,_imp)</td></tr><tr><td>3</td><td>bucket_t(_key,_imp)</td></tr><tr><td>4</td><td>bucket_t(_key,_imp)</td></tr><tr><td>â€¦</td><td>â€¦</td></tr></tbody></table><p>é€šè¿‡<code>cache_getImp(cls, sel)</code>è·å–<code>IMP</code>ã€‚å…·ä½“åœ¨<code>cache_t::find</code>å‡½æ•°ä¸­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">bucket_t * cache_t::find(cache_key_t k, id receiver)</span><br><span class="line">&#123;</span><br><span class="line">    assert(k !&#x3D; 0);</span><br><span class="line"></span><br><span class="line">    bucket_t *b &#x3D; buckets();</span><br><span class="line">    mask_t m &#x3D; mask();</span><br><span class="line">&#x2F;&#x2F;key&amp;mask å¾—åˆ°ç´¢å¼•</span><br><span class="line">    mask_t begin &#x3D; cache_hash(k, m);</span><br><span class="line">    mask_t i &#x3D; begin;</span><br><span class="line">    do &#123;</span><br><span class="line">        if (b[i].key() &#x3D;&#x3D; 0  ||  b[i].key() &#x3D;&#x3D; k) &#123;</span><br><span class="line">            return &amp;b[i];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; while ((i &#x3D; cache_next(i, m)) !&#x3D; begin);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; hack</span><br><span class="line">    Class cls &#x3D; (Class)((uintptr_t)this - offsetof(objc_class, cache));</span><br><span class="line">    cache_t::bad_cache(receiver, (SEL)k, cls);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Class points to cache. SEL is key. Cache buckets store SEL+IMP.</span><br><span class="line">&#x2F;&#x2F; Caches are never built in the dyld shared cache.</span><br><span class="line"></span><br><span class="line">static inline mask_t cache_hash(cache_key_t key, mask_t mask) </span><br><span class="line">&#123;</span><br><span class="line">    return (mask_t)(key &amp; mask);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè·å–<code>buckets()</code>è·å–<code>butket_t</code>,ç„¶åè·å–<code>_mask</code>ï¼Œé€šè¿‡<br><code>cache_hash(k, m)</code>è·å–ç¬¬ä¸€æ¬¡è®¿é—®çš„ç´¢å¼•<code>i</code>ï¼Œ<code>cache_hash</code>é€šè¿‡<code>(mask_t)(key &amp; mask)</code>å¾—å‡ºå…·ä½“çš„<code>ç´¢å¼•</code>,å½“ç¬¬ä¸€æ¬¡æˆåŠŸè·å–åˆ°<code>butket_t</code>åˆ™ç›´æ¥è¿”å›,å¦åˆ™æ‰§è¡Œ<code>cache_next(i, m)</code>è·å–ä¸‹ä¸€ä¸ªç´¢å¼•ï¼Œç›´åˆ°è·å–åˆ°æˆ–è€…å¾ªç¯ä¸€éç»“æŸã€‚<br>é‚£ä¹ˆæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹å·²ç»æ‰§è¡Œçš„å‡½æ•°çš„ç¡®æ˜¯å­˜åœ¨cacheä¸­çš„ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰äº†<code>class_rw_t</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line">#import &lt;Foundation&#x2F;Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">#ifndef MJClassInfo_h</span><br><span class="line">#define MJClassInfo_h</span><br><span class="line"></span><br><span class="line"># if __arm64__</span><br><span class="line">#   define ISA_MASK        0x0000000ffffffff8ULL</span><br><span class="line"># elif __x86_64__</span><br><span class="line">#   define ISA_MASK        0x00007ffffffffff8ULL</span><br><span class="line"># endif</span><br><span class="line"></span><br><span class="line">#if __LP64__</span><br><span class="line">typedef uint32_t mask_t;</span><br><span class="line">#else</span><br><span class="line">typedef uint16_t mask_t;</span><br><span class="line">#endif</span><br><span class="line">typedef uintptr_t cache_key_t;</span><br><span class="line"></span><br><span class="line">#if __arm__  ||  __x86_64__  ||  __i386__</span><br><span class="line">&#x2F;&#x2F; objc_msgSend has few registers available.</span><br><span class="line">&#x2F;&#x2F; Cache scan increments and wraps at special end-marking bucket.</span><br><span class="line">#define CACHE_END_MARKER 1</span><br><span class="line">static inline mask_t cache_next(mask_t i, mask_t mask) &#123;</span><br><span class="line">    return (i+1) &amp; mask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#elif __arm64__</span><br><span class="line">&#x2F;&#x2F; objc_msgSend has lots of registers available.</span><br><span class="line">&#x2F;&#x2F; Cache scan decrements. No end marker needed.</span><br><span class="line">#define CACHE_END_MARKER 0</span><br><span class="line">static inline mask_t cache_next(mask_t i, mask_t mask) &#123;</span><br><span class="line">    return i ? i-1 : mask;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">#else</span><br><span class="line">#error unknown architecture</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">struct bucket_t &#123;</span><br><span class="line">    cache_key_t _key;</span><br><span class="line">    IMP _imp;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct cache_t &#123;</span><br><span class="line">    bucket_t *_buckets;</span><br><span class="line">    mask_t _mask;</span><br><span class="line">    mask_t _occupied;</span><br><span class="line">    </span><br><span class="line">    IMP imp(SEL selector)</span><br><span class="line">    &#123;</span><br><span class="line">        mask_t begin &#x3D; _mask &amp; (long long)selector;</span><br><span class="line">        mask_t i &#x3D; begin;</span><br><span class="line">        do &#123;</span><br><span class="line">            if (_buckets[i]._key &#x3D;&#x3D; 0  ||  _buckets[i]._key &#x3D;&#x3D; (long long)selector) &#123;</span><br><span class="line">                return _buckets[i]._imp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; while ((i &#x3D; cache_next(i, _mask)) !&#x3D; begin);</span><br><span class="line">        return NULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct entsize_list_tt &#123;</span><br><span class="line">    uint32_t entsizeAndFlags;</span><br><span class="line">    uint32_t count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct method_t &#123;</span><br><span class="line">    SEL name;</span><br><span class="line">    const char *types;</span><br><span class="line">    IMP imp;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct method_list_t : entsize_list_tt &#123;</span><br><span class="line">    method_t first;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct ivar_t &#123;</span><br><span class="line">    int32_t *offset;</span><br><span class="line">    const char *name;</span><br><span class="line">    const char *type;</span><br><span class="line">    uint32_t alignment_raw;</span><br><span class="line">    uint32_t size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct ivar_list_t : entsize_list_tt &#123;</span><br><span class="line">    ivar_t first;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct property_t &#123;</span><br><span class="line">    const char *name;</span><br><span class="line">    const char *attributes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct property_list_t : entsize_list_tt &#123;</span><br><span class="line">    property_t first;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct chained_property_list &#123;</span><br><span class="line">    chained_property_list *next;</span><br><span class="line">    uint32_t count;</span><br><span class="line">    property_t list[0];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">typedef uintptr_t protocol_ref_t;</span><br><span class="line">struct protocol_list_t &#123;</span><br><span class="line">    uintptr_t count;</span><br><span class="line">    protocol_ref_t list[0];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct class_ro_t &#123;</span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t instanceStart;</span><br><span class="line">    uint32_t instanceSize;  &#x2F;&#x2F; instanceå¯¹è±¡å ç”¨çš„å†…å­˜ç©ºé—´</span><br><span class="line">#ifdef __LP64__</span><br><span class="line">    uint32_t reserved;</span><br><span class="line">#endif</span><br><span class="line">    const uint8_t * ivarLayout;</span><br><span class="line">    const char * name;  &#x2F;&#x2F; ç±»å</span><br><span class="line">    method_list_t * baseMethodList;</span><br><span class="line">    protocol_list_t * baseProtocols;</span><br><span class="line">    const ivar_list_t * ivars;  &#x2F;&#x2F; æˆå‘˜å˜é‡åˆ—è¡¨</span><br><span class="line">    const uint8_t * weakIvarLayout;</span><br><span class="line">    property_list_t *baseProperties;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct class_rw_t &#123;</span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t version;</span><br><span class="line">    const class_ro_t *ro;</span><br><span class="line">    method_list_t * methods;    &#x2F;&#x2F; æ–¹æ³•åˆ—è¡¨</span><br><span class="line">    property_list_t *properties;    &#x2F;&#x2F; å±æ€§åˆ—è¡¨</span><br><span class="line">    const protocol_list_t * protocols;  &#x2F;&#x2F; åè®®åˆ—è¡¨</span><br><span class="line">    Class firstSubclass;</span><br><span class="line">    Class nextSiblingClass;</span><br><span class="line">    char *demangledName;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#define FAST_DATA_MASK          0x00007ffffffffff8UL</span><br><span class="line">struct class_data_bits_t &#123;</span><br><span class="line">    uintptr_t bits;</span><br><span class="line">public:</span><br><span class="line">    class_rw_t* data() &#123;</span><br><span class="line">        return (class_rw_t *)(bits &amp; FAST_DATA_MASK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;* OCå¯¹è±¡ *&#x2F;</span><br><span class="line">struct mj_objc_object &#123;</span><br><span class="line">    void *isa;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;* ç±»å¯¹è±¡ *&#x2F;</span><br><span class="line">struct mj_objc_class : mj_objc_object &#123;</span><br><span class="line">    Class superclass;</span><br><span class="line">    cache_t cache;</span><br><span class="line">    class_data_bits_t bits;</span><br><span class="line">public:</span><br><span class="line">    class_rw_t* data() &#123;</span><br><span class="line">        return bits.data();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mj_objc_class* metaClass() &#123;</span><br><span class="line">        return (mj_objc_class *)((long long)isa &amp; ISA_MASK);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#endif</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç æ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">FYPerson *p &#x3D; [[FYPerson alloc]init];</span><br><span class="line">Method test1Method &#x3D; class_getInstanceMethod(p.class, @selector(test));</span><br><span class="line">Method test2Method &#x3D; class_getInstanceMethod(p.class, @selector(test2));</span><br><span class="line">IMP imp1&#x3D; method_getImplementation(test1Method);</span><br><span class="line">IMP imp2&#x3D; method_getImplementation(test2Method);</span><br><span class="line"></span><br><span class="line">mj_objc_class *cls &#x3D; (__bridge mj_objc_class *)p.class;</span><br><span class="line">NSLog(@&quot;-----&quot;);</span><br><span class="line">[p test];</span><br><span class="line">[p test2];</span><br><span class="line">cache_t cache &#x3D; cls-&gt;cache;</span><br><span class="line">bucket_t *buck &#x3D; cache._buckets;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for (int i &#x3D; 0; i &lt;&#x3D; cache._mask; i ++) &#123;</span><br><span class="line">bucket_t item &#x3D; buck[i];</span><br><span class="line">if (item._key !&#x3D; 0) &#123;</span><br><span class="line">NSLog(@&quot;key:%lu imp:%p&quot;,item._key,item._imp);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">p imp1</span><br><span class="line">(IMP) $0 &#x3D; 0x0000000100000df0 (day11-runtime1&#96;-[FYPerson test] at FYPerson.m:12)</span><br><span class="line">(lldb) p imp2</span><br><span class="line">(IMP) $1 &#x3D; 0x0000000100000e20 (day11-runtime1&#96;-[FYPerson test2] at FYPerson.m:15)</span><br><span class="line">p&#x2F;d @selector(test)             &#x2F;&#x2F;è¾“å‡º testæ–¹æ³•çš„selåœ°å€</span><br><span class="line">(SEL) $6 &#x3D; 140734025103231 &quot;test&quot;</span><br><span class="line">(lldb) p&#x2F;d @selector(test2)     &#x2F;&#x2F;è¾“å‡º test2æ–¹æ³•çš„selåœ°å€</span><br><span class="line">(SEL) $7 &#x3D; 4294971267 &quot;test2&quot;</span><br><span class="line"></span><br><span class="line">key1:140733954181041 imp1:0x7fff59fc4cd1</span><br><span class="line">key2:4294971267 imp2:0x100000e20         &#x2F;&#x2F;å¯¹åº”test2</span><br><span class="line">key3:140734025103231 imp3:0x100000df0    &#x2F;&#x2F;å¯¹åº”test1</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥<code>IMP1</code>å’Œ<code>IMP2</code>ã€<code>key1</code> å’Œ<code>key2</code>åˆ†åˆ«å¯¹åº”äº†<code>bucket_t</code>ä¸­çš„<code>key2</code>,<code>key3</code>å’Œ<code>imp2</code>å’Œ<code>imp3</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">static void cache_fill_nolock(Class cls, SEL sel, IMP imp, id receiver)</span><br><span class="line">&#123;</span><br><span class="line">    cacheUpdateLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;å½“initialized æ²¡æœ‰æ‰§è¡Œå®Œæ¯•çš„æ—¶å€™ä¸ç¼“å­˜</span><br><span class="line">    if (!cls-&gt;isInitialized()) return;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Make sure the entry wasn&#39;t added to the cache by some other thread </span><br><span class="line">    &#x2F;&#x2F; before we grabbed the cacheUpdateLock.</span><br><span class="line">    if (cache_getImp(cls, sel)) return;</span><br><span class="line"></span><br><span class="line">    cache_t *cache &#x3D; getCache(cls);</span><br><span class="line">    cache_key_t key &#x3D; getKey(sel);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Use the cache as-is if it is less than 3&#x2F;4 full</span><br><span class="line">    mask_t newOccupied &#x3D; cache-&gt;occupied() + 1;</span><br><span class="line">    mask_t capacity &#x3D; cache-&gt;capacity();</span><br><span class="line">    if (cache-&gt;isConstantEmptyCache()) &#123;</span><br><span class="line">        &#x2F;&#x2F; Cache is read-only. Replace it.</span><br><span class="line">        cache-&gt;reallocate(capacity, capacity ?: INIT_CACHE_SIZE);</span><br><span class="line">    &#125;</span><br><span class="line">    else if (newOccupied &lt;&#x3D; capacity &#x2F; 4 * 3) &#123;</span><br><span class="line">        &#x2F;&#x2F; Cache &lt;&#x3D; 3&#x2F;4 </span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        æ‰©å®¹ ä¹‹åï¼Œç¼“å­˜æ¸…ç©º</span><br><span class="line">        cache-&gt;expand();</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F;bucket_t æœ€å°æ˜¯4ï¼Œå½“&gt;3&#x2F;4æ—¶å€™ï¼Œæ‰©å®¹ï¼Œç©ºé—´æ‰©å®¹ä¹‹åæ˜¯ä¹‹å‰çš„2ï¸å€ã€‚</span><br><span class="line">    bucket_t *bucket &#x3D; cache-&gt;find(key, receiver);</span><br><span class="line">    if (bucket-&gt;key() &#x3D;&#x3D; 0) cache-&gt;incrementOccupied();</span><br><span class="line">    bucket-&gt;set(key, imp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>cache_t</code>åˆå§‹åŒ–æ˜¯å¤§å°æ˜¯4ï¼Œå½“å¤§äº3/4æ—¶ï¼Œè¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹ä¹‹åæ˜¯ä¹‹å‰çš„2å€ï¼Œæ•°æ®è¢«æ¸…ç©ºï¼Œ<code>cacha-&gt;_occupied</code>æ¢å¤ä¸º0ã€‚<br>éªŒè¯ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">FYPerson *p &#x3D; [[FYPerson alloc]init];</span><br><span class="line">mj_objc_class *cls &#x3D; (__bridge mj_objc_class *)p.class;</span><br><span class="line">NSLog(@&quot;-----&quot;);</span><br><span class="line">[p test];</span><br><span class="line">&#x2F;*</span><br><span class="line"> key:init imp:0x7fff58807c2d</span><br><span class="line"> key:class imp:0x7fff588084b7</span><br><span class="line"> key:(null) imp:0x0</span><br><span class="line"> key:test imp:0x100000bf0</span><br><span class="line"> Program ended with exit code: 0</span><br><span class="line"> *&#x2F;</span><br><span class="line">[p test2]; &#x2F;&#x2F;å½“æ‰§è¡Œè¯¥å‡½æ•°çš„æ—¶å€™</span><br><span class="line">&#x2F;*</span><br><span class="line"> key:(null) imp:0x0</span><br><span class="line"> key:(null) imp:0x0</span><br><span class="line"> key:(null) imp:0x0</span><br><span class="line"> key:(null) imp:0x0</span><br><span class="line"> key:(null) imp:0x0</span><br><span class="line"> key:(null) imp:0x0</span><br><span class="line"> key:test2 imp:0x100000c20</span><br><span class="line"> key:(null) imp:0x0</span><br><span class="line"> *&#x2F;</span><br><span class="line"></span><br><span class="line">cache_t cache &#x3D; cls-&gt;cache;</span><br><span class="line">bucket_t *buck &#x3D; cache._buckets;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">for (int i &#x3D; 0; i &lt;&#x3D; cache._mask; i ++) &#123;</span><br><span class="line">bucket_t item &#x3D; buck[i];</span><br><span class="line">&#x2F;&#x2F;            if (item._key !&#x3D; 0) &#123;</span><br><span class="line">&#x2F;&#x2F;&#x2F;&#x2F;                printf(&quot;key:%s imp:%p \n&quot;,(const char *)item._key,item._imp);</span><br><span class="line">&#x2F;&#x2F;            &#125;</span><br><span class="line">    printf(&quot;key:%s imp:%p \n&quot;,(const char *)item._key,item._imp);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>arm64ä¹‹åisaä½¿ç”¨è”åˆä½“ç”¨æ›´å°‘çš„ç©ºé—´å­˜å‚¨æ›´å¤šçš„æ•°æ®ï¼Œarm64ä¹‹å‰å­˜å‚¨classå’Œmeta-classæŒ‡é’ˆã€‚</li><li>å‡½æ•°æ‰§è¡Œä¼šå…ˆä»cacheä¸­æŸ¥æ‰¾ï¼Œæ²¡æœ‰çš„è¯ï¼Œå½“å†æ¬¡æ‰¾åˆ°è¯¥å‡½æ•°ä¼šæ·»åŠ åˆ°cacheä¸­</li><li>ä»<code>class-&gt;cache</code>æŸ¥æ‰¾<code>bucket_t</code>çš„keyéœ€è¦å…ˆ<code>&amp;_mask</code>ä¹‹åå†åˆ¤æ–­æ˜¯å¦æœ‰è¯¥<code>key</code></li><li>cacheæ‰©å®¹åœ¨å¤§äº3/4è¿›è¡Œ2å€æ‰©å®¹ï¼Œæ‰©å®¹ä¹‹åï¼Œæ—§æ•°æ®åˆ é™¤ï¼Œ<code>imp</code>ä¸ªæ•°æ¸…ç©º</li><li><code>class-&gt;rw</code>åœ¨åˆå§‹åŒ–ä¸­è®²<code>class_ro_t</code>å€¼èµ‹å€¼ç»™<code>rw</code>,ç„¶å<code>rw-&gt;ro</code>æŒ‡å‘ä¹‹å‰çš„<code>ro</code>ã€‚</li></ul><h4 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h4><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code<i class="fa fa-external-link"></i></span></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9vYmpjNC03NTA=" title="https://github.com/ifgyong/demo/tree/master/OC/objc4-750">runtimeå¯è¿è¡Œçš„æºç <i class="fa fa-external-link"></i></span></p><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p></li></ul><p>å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;runtime-åŸºç¡€çŸ¥è¯†&quot;&gt;&lt;a href=&quot;#runtime-åŸºç¡€çŸ¥è¯†&quot; class=&quot;headerlink&quot; title=&quot;runtime åŸºç¡€çŸ¥è¯†&quot;&gt;&lt;/a&gt;runtime åŸºç¡€çŸ¥è¯†&lt;/h3&gt;&lt;p&gt;&lt;code&gt;runtime&lt;/code&gt;æ˜¯è¿è¡Œæ—¶ï¼Œåœ¨è¿è¡Œçš„æ—¶
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç†  blockæœ¬è´¨ --(5)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%20block%E6%9C%AC%E8%B4%A8%20--(5)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%20block%E6%9C%AC%E8%B4%A8%20--(5)/</id>
    <published>2019-12-01T03:15:58.000Z</published>
    <updated>2020-09-04T04:40:21.656Z</updated>
    
    <content type="html"><![CDATA[<p>æœ¬ç« è®²è§£blockçš„ç”¨æ³•å’Œåº•å±‚æ•°æ®ç»“æ„ï¼Œä»¥åŠä½¿ç”¨è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„çš„ç‚¹ã€‚</p><h3 id="blockæœ¬è´¨"><a href="#blockæœ¬è´¨" class="headerlink" title="blockæœ¬è´¨"></a>blockæœ¬è´¨</h3><p>å‰å‡ ç¯‡æ–‡ç« è®²è¿‡äº†ï¼Œ<code>class</code>æ˜¯å¯¹è±¡ï¼Œå…ƒç±»ä¹Ÿæ˜¯å¯¹è±¡ï¼Œæœ¬è´¨æ˜¯ç»“æ„ä½“ï¼Œé‚£ä¹ˆblockæ˜¯å¦ä¹Ÿæ˜¯å¦‚æ­¤å‘¢ï¼Ÿ<code>block</code>å…·æœ‰è¿™å‡ ä¸ªç‰¹ç‚¹ï¼š/</p><ul><li>blockæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªOCå¯¹è±¡ï¼Œå®ƒå†…éƒ¨ä¹Ÿæœ‰isaæŒ‡é’ˆ</li><li>blockæ˜¯å°è£…äº†å‡½æ•°è°ƒç”¨ä»¥åŠå‡½æ•°è°ƒç”¨ç¯å¢ƒçš„ocå¯¹è±¡</li></ul><p>å…ˆç®€å•æ¥çœ‹ä¸€ä¸‹<code>block</code>ç¼–è¯‘ä¹‹åçš„æ ·å­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        void (^block)(void) &#x3D; ^(void)&#123;</span><br><span class="line">            NSLog(@&quot;hello word&quot;);</span><br><span class="line">        &#125;;</span><br><span class="line">        block();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘½ä»¤è¡Œæ‰§è¡Œ<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.mm -o main.cpp</code>,æ¥åˆ°<code>main.cpp</code>å†…éƒ¨ï¼Œå·²ç»å»é™¤å¤šä½™çš„è½¬åŒ–å‡½æ•°ï¼Œå‰©ä½™éª¨æ¶ï¼Œå¯ä»¥çœ‹å¾—æ›´æ¸…æ™°ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">struct __main_block_impl_0 &#123;</span><br><span class="line">  struct __block_impl impl;</span><br><span class="line">  struct __main_block_desc_0* Desc;</span><br><span class="line">    &#x2F;&#x2F;æ„é€ å‡½æ•° ç±»ä¼¼OC initå‡½æ•°</span><br><span class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags&#x3D;0) &#123;</span><br><span class="line">    impl.isa &#x3D; &amp;_NSConcreteStackBlock;&#x2F;&#x2F;blockç±»å‹</span><br><span class="line">    impl.Flags &#x3D; flags;</span><br><span class="line">    impl.FuncPtr &#x3D; fp;&#x2F;&#x2F; æ‰§è¡Œå‡½æ•°çš„åœ°å€</span><br><span class="line">    Desc &#x3D; desc;&#x2F;&#x2F;desc å­˜å‚¨ __main_block_desc_0ï¼ˆ0ï¼Œsizeof(__main_block_impl_0)ï¼‰çš„å€¼</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">    &#x2F;&#x2F;block å†…éƒ¨ä»£ç å°è£…æˆå‡½æ•°</span><br><span class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line"></span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_5p_cwsr3ytd5md9r_kgb2fv_2c40000gn_T_main_b7cca8_mii_0);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">static struct __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;&#x2F;&#x2F;å­˜å‚¨ç»“æ„ä½“å ç”¨ç©ºé—´çš„å¤§å°</span><br><span class="line">&#125; __main_block_desc_0_DATA &#x3D; &#123; 0, sizeof(struct __main_block_impl_0)&#125;;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    &#x2F;* @autoreleasepool *&#x2F; &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line">&#x2F;&#x2F;å®šä¹‰block</span><br><span class="line">        void (*block)(void) &#x3D; &amp;__main_block_impl_0(__main_block_func_0, &amp;__main_block_desc_0_DATA);</span><br><span class="line">        &#x2F;&#x2F;æ‰§è¡Œblock</span><br><span class="line">        block-&gt;FuncPtr(block);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€ç»ˆ<code>block</code>è½¬åŒ–æˆ<code>__main_block_impl_0</code>ç»“æ„ä½“ï¼Œèµ‹å€¼ç»™å˜é‡<code>block</code>ï¼Œä¼ å…¥å‚æ•°æ˜¯<code>__main_block_func_0</code>å’Œ<code>__main_block_desc_0_DATA</code>æ¥æ‰§è¡Œ<code>__main_block_impl_0</code>çš„æ„é€ å‡½æ•°ï¼Œ<code>__main_block_desc_0_DATA</code>å‡½æ•°èµ‹å€¼ç»™<code>__main_block_impl_0-&gt;FuncPtr</code>ï¼Œæ‰§è¡Œå‡½æ•°æ˜¯<code>block-&gt;FuncPtr(block)</code>ï¼Œåˆ é™¤å†—ä½™ä»£ç ä¹‹å‰æ˜¯<code>((void (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</code>ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆ<code>block</code>å¯ä»¥ç›´æ¥å¼ºåˆ¶è½¬åŒ–æˆ<code>__block_impl</code>å‘¢ï¼Ÿå› ä¸º<code>__main_block_impl_0</code>ç»“æ„ä½“çš„ç¬¬ä¸€è¡Œå˜é‡æ˜¯<code>__block_impl</code>ï¼Œç›¸å½“äº<code>__main_block_impl_0</code>çš„å†…å­˜åœ°å€å’Œ<code>__block_impl</code>çš„å†…å­˜åœ°å€ä¸€æ ·ï¼Œå¼ºåˆ¶è½¬åŒ–ä¹Ÿä¸ä¼šæœ‰é—®é¢˜ã€‚</p><h3 id="å˜é‡æ•è·"><a href="#å˜é‡æ•è·" class="headerlink" title="å˜é‡æ•è·"></a>å˜é‡æ•è·</h3><p>å˜é‡æ•è·åˆ†ä¸º3ç§ï¼š</p><table><thead><tr><th>å˜é‡ç±»å‹</th><th>æ˜¯å¦ä¼šæ•è·åˆ°blockå†…éƒ¨</th><th>è®¿é—®æ–¹å¼</th><th>å†…éƒ¨å˜é‡å‡å®šæ˜¯a</th></tr></thead><tbody><tr><td>å±€éƒ¨å˜é‡ auto</td><td>ä¼š</td><td>å€¼ä¼ é€’</td><td>a</td></tr><tr><td>å±€éƒ¨å˜é‡ static</td><td>ä¼š</td><td>æŒ‡é’ˆä¼ é€’</td><td>*a</td></tr><tr><td>å…¨å±€å˜é‡</td><td>ä¸ä¼š</td><td>ç›´æ¥è®¿é—®</td><td>ç©º</td></tr></tbody></table><h4 id="autoå˜é‡æ•è·"><a href="#autoå˜é‡æ•è·" class="headerlink" title="autoå˜é‡æ•è·"></a>autoå˜é‡æ•è·</h4><p><code>auto</code> å˜é‡ï¼Œä¸€èˆ¬<code>auto</code>æ˜¯çœç•¥ä¸å†™çš„ï¼Œè®¿é—®æ–¹å¼æ˜¯å€¼ä¼ é€’ï¼Œå…³äºå€¼ä¼ é€’ä¸æ‡‚çš„è¯å¯ä»¥çœ‹<span class="exturl" data-url="aHR0cHM6Ly93d3cuZ29vZ2xlLmNvbS9zZWFyY2g/cT0lRTUlODAlQkMlRTQlQkMlQTAlRTklODAlOTImYW1wO29xPSVFNSU4MCVCQyVFNCVCQyVBMCVFOSU4MCU5MiZhbXA7YXFzPWNocm9tZS4uNjlpNTcuNTE2OWowajQmYW1wO3NvdXJjZWlkPWNocm9tZSZhbXA7aWU9VVRGLTg=" title="https://www.google.com/search?q=%E5%80%BC%E4%BC%A0%E9%80%92&amp;oq=%E5%80%BC%E4%BC%A0%E9%80%92&amp;aqs=chrome..69i57.5169j0j4&amp;sourceid=chrome&amp;ie=UTF-8">è¿™ç¯‡åšå®¢<i class="fa fa-external-link"></i></span>ï¼Œ<br>çœ‹ä¸‹è¿™ä¸ªä¾‹å­</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int age &#x3D; 10;</span><br><span class="line">void (^block)(void) &#x3D; ^(void)&#123;</span><br><span class="line">    NSLog(@&quot;age is %d&quot;,age);</span><br><span class="line">&#125;;</span><br><span class="line">age &#x3D; 20;</span><br><span class="line">block();</span><br><span class="line">&#x2F;&#x2F;å®é™…è¾“å‡ºæ˜¯ age is 10</span><br></pre></td></tr></table></figure><p>æœ‰æ²¡æœ‰ç–‘é—®å‘¢ï¼Ÿåœ¨<code>block</code>æ‰§è¡Œä¹‹å‰<code>age =20</code>ï¼Œä¸ºä»€ä¹ˆè¾“å‡ºæ˜¯10å‘¢ï¼Ÿ<br>å°†è¿™æ®µä»£ç è½¬åŒ–æˆ<code>c/c++</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">struct __main_block_impl_0 &#123;</span><br><span class="line">  struct __block_impl impl;</span><br><span class="line">  struct __main_block_desc_0* Desc;</span><br><span class="line">  int age;&#x2F;&#x2F;å¤šäº†ä¸€ä¸ªå˜é‡age,å­˜å‚¨å€¼æ˜¯10</span><br><span class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _age, int flags&#x3D;0) : age(_age) &#123;</span><br><span class="line">    impl.isa &#x3D; &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags &#x3D; flags;</span><br><span class="line">    impl.FuncPtr &#x3D; fp;</span><br><span class="line">    Desc &#x3D; desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  int age &#x3D; __cself-&gt;age; &#x2F;&#x2F; bound by copy</span><br><span class="line"></span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_5p_cwsr3ytd5md9r_kgb2fv_2c40000gn_T_main_baf352_mii_0,age);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">static struct __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA &#x3D; &#123; 0, sizeof(struct __main_block_impl_0)&#125;;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    &#x2F;* @autoreleasepool *&#x2F; &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line">        int age &#x3D; 10;</span><br><span class="line">        void (*block)(void) &#x3D; ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA, age));</span><br><span class="line">        age &#x3D; 20;</span><br><span class="line">        ((void (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æ„ä½“<code>__main_block_impl_0</code>å¤šäº†ä¸€ä¸ªå˜é‡<code>age</code>ï¼Œåœ¨<code>block</code>è½¬åŒ–æˆ<code>c</code>å‡½æ•°çš„æ—¶å€™<code>__main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int _age, int flags=0) : age(_age)</code>ç›´æ¥å°†ageçš„å€¼å­˜å‚¨åœ¨<code>__main_block_impl_0.age</code>ä¸­ï¼Œæ­¤æ—¶<code>__main_block_impl_0.age</code>æ˜¯å­˜å‚¨åœ¨å †ä¸Šçš„ï¼Œä¹‹å‰çš„<code>age</code>æ˜¯å­˜å‚¨åœ¨æ•°æ®æ®µçš„ï¼Œæ‰§è¡Œ<code>block</code>è®¿é—®çš„å˜é‡æ˜¯å †ä¸Šçš„<code>`__main_block_impl_0.age</code>,æ‰€ä»¥æœ€ç»ˆè¾“å‡ºæ¥<code>age is 10</code>ã€‚</p><h4 id="staticå˜é‡æ•è·"><a href="#staticå˜é‡æ•è·" class="headerlink" title="staticå˜é‡æ•è·"></a>staticå˜é‡æ•è·</h4><p>æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­æ¥è®²è§£staticå’ŒautoåŒºåˆ«ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">void(^block)(void);</span><br><span class="line">void test()&#123;</span><br><span class="line">    int age &#x3D; 10;</span><br><span class="line">    static int level &#x3D; 12;</span><br><span class="line">    block &#x3D; ^(void)&#123;</span><br><span class="line">        NSLog(@&quot;age is %d,level is %d&quot;,age,level);</span><br><span class="line">    &#125;;</span><br><span class="line">    age &#x3D; 20;</span><br><span class="line">    level &#x3D; 13;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        test();</span><br><span class="line">        block();</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è¾“å‡ºï¼šage is 10,level is 13</span><br></pre></td></tr></table></figure><p>è½¬åŒ–æˆæºç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">void(*block)(void);</span><br><span class="line"></span><br><span class="line">struct __test_block_impl_0 &#123;</span><br><span class="line">  struct __block_impl impl;</span><br><span class="line">  struct __test_block_desc_0* Desc;</span><br><span class="line">  int age;</span><br><span class="line">  int *level;</span><br><span class="line">  __test_block_impl_0(void *fp, struct __test_block_desc_0 *desc, int _age, int *_level, int flags&#x3D;0) : age(_age), level(_level) &#123;</span><br><span class="line">    impl.isa &#x3D; &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags &#x3D; flags;</span><br><span class="line">    impl.FuncPtr &#x3D; fp;</span><br><span class="line">    Desc &#x3D; desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">static void __test_block_func_0(struct __test_block_impl_0 *__cself) &#123;</span><br><span class="line">  int age &#x3D; __cself-&gt;age; &#x2F;&#x2F; bound by copy</span><br><span class="line">  int *level &#x3D; __cself-&gt;level; &#x2F;&#x2F; bound by copy</span><br><span class="line"></span><br><span class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_5p_cwsr3ytd5md9r_kgb2fv_2c40000gn_T_main_b26797_mii_0,age,(*level));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">static struct __test_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">&#125; __test_block_desc_0_DATA &#x3D; &#123; 0, sizeof(struct __test_block_impl_0)&#125;;</span><br><span class="line">void test()&#123;</span><br><span class="line">    int age &#x3D; 10;</span><br><span class="line">    static int level &#x3D; 12;</span><br><span class="line">    block &#x3D; ((void (*)())&amp;__test_block_impl_0((void *)__test_block_func_0, &amp;__test_block_desc_0_DATA, age, &amp;level));</span><br><span class="line">    age &#x3D; 20;</span><br><span class="line">    level &#x3D; 13;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    &#x2F;* @autoreleasepool *&#x2F; &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line">        test();</span><br><span class="line">        ((void (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“æ‰§è¡Œå®Œ<code>test()</code>å‡½æ•°ï¼Œ<code>age</code>å˜é‡å·²ç»è¢«æ”¶å›ï¼Œä½†æ˜¯<code>age</code>çš„å€¼å­˜å‚¨åœ¨<code>block</code>ç»“æ„ä½“ä¸­ï¼Œ<code>level</code>çš„åœ°å€å­˜å‚¨åœ¨<code>__test_block_impl_0.level</code>,å¯ä»¥çœ‹åˆ°<code>level</code>ç±»å‹æ˜¯æŒ‡é’ˆç±»å‹ï¼Œè¯»å–å€¼çš„æ—¶å€™ä¹Ÿæ˜¯<code>*level</code>ï¼Œåˆ™ä¸ç®¡ä»€ä¹ˆæ—¶é—´æ”¹åŠ¨<code>level</code>çš„å€¼ï¼Œè¯»<code>level</code>çš„å€¼éƒ½æ˜¯æœ€æ–°çš„ï¼Œå› ä¸ºå®ƒæ˜¯ä»åœ°å€ç›´æ¥è¯»çš„ã€‚æ‰€ä»¥ç»“æœæ˜¯<code>age is 10,level is 13</code>ã€‚</p><h4 id="å…¨å±€å˜é‡"><a href="#å…¨å±€å˜é‡" class="headerlink" title="å…¨å±€å˜é‡"></a>å…¨å±€å˜é‡</h4><p>å…¨å±€ä¸ç”¨æ•è·çš„ï¼Œè®¿é—®çš„æ—¶å€™ç›´æ¥è®¿é—®ã€‚æˆ‘ä»¬æ¥æµ‹è¯•ä¸‹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">int age &#x3D; 10;</span><br><span class="line">static int level &#x3D; 12;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line"></span><br><span class="line">        void(^block)(void) &#x3D; ^(void)&#123;</span><br><span class="line">            NSLog(@&quot;age is %d,level is %d&quot;,age,level);</span><br><span class="line">        &#125;;</span><br><span class="line">        age &#x3D; 20;</span><br><span class="line">        level &#x3D; 13;</span><br><span class="line">        block();</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è½¬åŒ–æˆ<code>c/c++</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">int age &#x3D; 10;</span><br><span class="line">static int level &#x3D; 12;</span><br><span class="line"></span><br><span class="line">struct __main_block_impl_0 &#123;</span><br><span class="line">  struct __block_impl impl;</span><br><span class="line">  struct __main_block_desc_0* Desc;</span><br><span class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, int flags&#x3D;0) &#123;</span><br><span class="line">    impl.isa &#x3D; &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags &#x3D; flags;</span><br><span class="line">    impl.FuncPtr &#x3D; fp;</span><br><span class="line">    Desc &#x3D; desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line"></span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_5p_cwsr3ytd5md9r_kgb2fv_2c40000gn_T_main_45cab9_mii_0,age,level);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">static struct __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">&#125; __main_block_desc_0_DATA &#x3D; &#123; 0, sizeof(struct __main_block_impl_0)&#125;;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">    &#x2F;* @autoreleasepool *&#x2F; &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">        void(*block)(void) &#x3D; ((void (*)())&amp;__main_block_impl_0((void *)__main_block_func_0, &amp;__main_block_desc_0_DATA));</span><br><span class="line">        age &#x3D; 20;</span><br><span class="line">        level &#x3D; 13;</span><br><span class="line">        ((void (*)(__block_impl *))((__block_impl *)block)-&gt;FuncPtr)((__block_impl *)block);</span><br><span class="line">    &#125;</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ç¼–è¯‘ä¹‹åä»…ä»…æ˜¯å¤šäº†ä¸¤è¡Œ<code>int age = 10;static int level = 12;</code>ï¼Œç»“æ„ä½“<code>__main_block_impl_0</code>å†…éƒ¨å’Œæ„é€ å‡½æ•°å¹¶æ²¡æœ‰ä¸“é—¨æ¥å­˜å‚¨å€¼æˆ–è€…æŒ‡é’ˆï¼ŒåŸå› æ˜¯å½“æ‰§è¡Œ<code>__main_block_func_0</code>ï¼Œå¯ä»¥ç›´æ¥è®¿é—®å˜é‡<code>age</code>å’Œ <code>level</code>ï¼Œå› ä¸ºå…¨å±€å˜é‡æœ‰æ•ˆåŒºåŸŸæ˜¯å…¨å±€ï¼Œä¸ä¼šå‡ºäº†<code>main</code>å‡½æ•°å°±æ¶ˆå¤±ã€‚<br><strong>åŸºæœ¬æ¦‚æ‹¬æ¥è®²å°±æ˜¯è¶…å‡ºæ‰§è¡ŒåŒºåŸŸä¸å¯èƒ½æ¶ˆå¤±çš„ä¼šæ•è·ï¼Œä¸€å®šä¸ä¼šæ¶ˆå¤±çš„ä¸ä¼šæ•è·ã€‚</strong></p><p>æˆ‘ä»¬å†çœ‹ä¸‹æ›´å¤æ‚çš„æƒ…å†µï¼Œå¯¹è±¡ç±»å‹çš„å¼•ç”¨æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString * name;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYPerson</span><br><span class="line">- (void)test&#123;</span><br><span class="line">    void (^block)(void) &#x3D; ^&#123;</span><br><span class="line">        NSLog(@&quot;person is %@&quot;,self);</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    void (^block2)(void) &#x3D; ^&#123;</span><br><span class="line">        NSLog(@&quot;name is %@&quot;,_name);</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">struct __FYPerson__test_block_impl_0 &#123;</span><br><span class="line">  struct __block_impl impl;</span><br><span class="line">  struct __FYPerson__test_block_desc_0* Desc;</span><br><span class="line">  FYPerson *self;</span><br><span class="line">  __FYPerson__test_block_impl_0(void *fp, struct __FYPerson__test_block_desc_0 *desc, FYPerson *_self, int flags&#x3D;0) : self(_self) &#123;</span><br><span class="line">    impl.isa &#x3D; &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags &#x3D; flags;</span><br><span class="line">    impl.FuncPtr &#x3D; fp;</span><br><span class="line">    Desc &#x3D; desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">static void __FYPerson__test_block_func_0(struct __FYPerson__test_block_impl_0 *__cself) &#123;</span><br><span class="line">  FYPerson *self &#x3D; __cself-&gt;self; &#x2F;&#x2F; bound by copy</span><br><span class="line"></span><br><span class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_5p_cwsr3ytd5md9r_kgb2fv_2c40000gn_T_FYPerson_c624e0_mi_0,self);</span><br><span class="line">    &#125;</span><br><span class="line">static void __FYPerson__test_block_copy_0(struct __FYPerson__test_block_impl_0*dst, struct __FYPerson__test_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;dst-&gt;self, (void*)src-&gt;self, 3&#x2F;*BLOCK_FIELD_IS_OBJECT*&#x2F;);&#125;</span><br><span class="line"></span><br><span class="line">static void __FYPerson__test_block_dispose_0(struct __FYPerson__test_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&gt;self, 3&#x2F;*BLOCK_FIELD_IS_OBJECT*&#x2F;);&#125;</span><br><span class="line"></span><br><span class="line">static struct __FYPerson__test_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  void (*copy)(struct __FYPerson__test_block_impl_0*, struct __FYPerson__test_block_impl_0*);</span><br><span class="line">  void (*dispose)(struct __FYPerson__test_block_impl_0*);</span><br><span class="line">&#125; __FYPerson__test_block_desc_0_DATA &#x3D; &#123; 0, sizeof(struct __FYPerson__test_block_impl_0), __FYPerson__test_block_copy_0, __FYPerson__test_block_dispose_0&#125;;</span><br><span class="line"></span><br><span class="line">struct __FYPerson__test_block_impl_1 &#123;</span><br><span class="line">  struct __block_impl impl;</span><br><span class="line">  struct __FYPerson__test_block_desc_1* Desc;</span><br><span class="line">  FYPerson *self;</span><br><span class="line">  __FYPerson__test_block_impl_1(void *fp, struct __FYPerson__test_block_desc_1 *desc, FYPerson *_self, int flags&#x3D;0) : self(_self) &#123;</span><br><span class="line">    impl.isa &#x3D; &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags &#x3D; flags;</span><br><span class="line">    impl.FuncPtr &#x3D; fp;</span><br><span class="line">    Desc &#x3D; desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">static void __FYPerson__test_block_func_1(struct __FYPerson__test_block_impl_1 *__cself) &#123;</span><br><span class="line">  FYPerson *self &#x3D; __cself-&gt;self; &#x2F;&#x2F; bound by copy</span><br><span class="line"></span><br><span class="line">        NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_5p_cwsr3ytd5md9r_kgb2fv_2c40000gn_T_FYPerson_c624e0_mi_1,(*(NSString * _Nonnull *)((char *)self + OBJC_IVAR_$_FYPerson$_name)));</span><br><span class="line">    &#125;</span><br><span class="line">static void __FYPerson__test_block_copy_1(struct __FYPerson__test_block_impl_1*dst, struct __FYPerson__test_block_impl_1*src) &#123;_Block_object_assign((void*)&amp;dst-&gt;self, (void*)src-&gt;self, 3&#x2F;*BLOCK_FIELD_IS_OBJECT*&#x2F;);&#125;</span><br><span class="line"></span><br><span class="line">static void __FYPerson__test_block_dispose_1(struct __FYPerson__test_block_impl_1*src) &#123;_Block_object_dispose((void*)src-&gt;self, 3&#x2F;*BLOCK_FIELD_IS_OBJECT*&#x2F;);&#125;</span><br><span class="line"></span><br><span class="line">static struct __FYPerson__test_block_desc_1 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  void (*copy)(struct __FYPerson__test_block_impl_1*, struct __FYPerson__test_block_impl_1*);</span><br><span class="line">  void (*dispose)(struct __FYPerson__test_block_impl_1*);</span><br><span class="line">&#125; __FYPerson__test_block_desc_1_DATA &#x3D; &#123; 0, sizeof(struct __FYPerson__test_block_impl_1), __FYPerson__test_block_copy_1, __FYPerson__test_block_dispose_1&#125;;</span><br><span class="line"></span><br><span class="line">static void _I_FYPerson_test(FYPerson * self, SEL _cmd) &#123;</span><br><span class="line">    void (*block)(void) &#x3D; ((void (*)())&amp;__FYPerson__test_block_impl_0((void *)__FYPerson__test_block_func_0, &amp;__FYPerson__test_block_desc_0_DATA, self, 570425344));</span><br><span class="line"></span><br><span class="line">    void (*block2)(void) &#x3D; ((void (*)())&amp;__FYPerson__test_block_impl_1((void *)__FYPerson__test_block_func_1, &amp;__FYPerson__test_block_desc_1_DATA, self, 570425344));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>block</code>å’Œ<code>block2</code>éƒ½æ˜¯ç»“æ„ä½“<code>__FYPerson__test_block_impl_1</code>å†…éƒ¨å¼•ç”¨äº†ä¸€ä¸ª<code>FYPerson</code>å¯¹è±¡æŒ‡é’ˆï¼Œ<code>FYPerson</code>å¯¹è±¡å±äºå±€éƒ¨å˜é‡ï¼Œéœ€è¦æ•è·ã€‚ç¬¬2ä¸ª<code>block</code>è®¿é—®<code>_name</code>æ•æ‰çš„ä¹Ÿæ˜¯<code>FYPerson</code>å¯¹è±¡ï¼Œè®¿é—®<code>_name</code>ï¼Œéœ€è¦å…ˆè®¿é—®<code>FYPerson</code>å¯¹è±¡ï¼Œç„¶åå†è®¿é—®<code>_name</code>ï¼Œæœ¬è´¨ä¸Šæ˜¯è®¿é—®<code>person.name</code>,æ‰€ä»¥æ•æ‰çš„æ˜¯<code>FYPerson</code>å¯¹è±¡ã€‚</p><h4 id="éªŒè¯blockæ˜¯å¯¹è±¡ç±»å‹ï¼š"><a href="#éªŒè¯blockæ˜¯å¯¹è±¡ç±»å‹ï¼š" class="headerlink" title="éªŒè¯blockæ˜¯å¯¹è±¡ç±»å‹ï¼š"></a>éªŒè¯blockæ˜¯å¯¹è±¡ç±»å‹ï¼š</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ARCç¯å¢ƒä¸‹</span><br><span class="line">void(^block)(void)&#x3D;^&#123;</span><br><span class="line">NSLog(@&quot;Hello, World!&quot;);</span><br><span class="line">&#125;;</span><br><span class="line">NSLog(@&quot;è‡ªå·±classï¼š%@ å®ƒçˆ¹class:%@  å®ƒçˆ·çˆ·class:%@ å®ƒè€çˆ·çˆ·çš„tclass:%@&quot;,[block class],[[block class] superclass],[[[block class] superclass]superclass],[[[[block class] superclass]superclass] superclass]);</span><br><span class="line">&#x2F;&#x2F;è¾“å‡ºæ˜¯ï¼šè‡ªå·±classï¼š__NSGlobalBlock__ å®ƒçˆ¹class:__NSGlobalBlock  å®ƒçˆ·çˆ·class:NSBlock å®ƒè€çˆ·çˆ·çš„tclass:NSObject</span><br></pre></td></tr></table></figure><p>å¯ä»¥äº†è§£åˆ°<code>block</code>æ˜¯ç»§æ‰¿ä¸åŸºç±»çš„ï¼Œæ‰€ä»¥<code>block</code>ä¹Ÿæ˜¯OCå¯¹è±¡ã€‚</p><h4 id="blockçš„åˆ†ç±»"><a href="#blockçš„åˆ†ç±»" class="headerlink" title="blockçš„åˆ†ç±»"></a>blockçš„åˆ†ç±»</h4><p><code>block</code>æœ‰3ç§ç±»å‹ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥é€šè¿‡è°ƒç”¨<code>class</code>æ–¹æ³•æˆ–è€…<code>isa</code>æŒ‡é’ˆæŸ¥çœ‹å…·ä½“ç±»å‹ï¼Œæœ€ç»ˆéƒ½æ˜¯ç»§æ‰¿æ¥è‡ª<code>NSBlock</code>ç±»å‹ã€‚</p><ul><li><strong>NSGlobalBLock</strong>ï¼ˆ_NSConcreteGLobalBlockï¼‰</li><li><strong>NSStackBlock</strong>ï¼ˆ_NSConcreteStackBlockï¼‰</li><li><strong>NSMallocBLock</strong>ï¼ˆ_NSConcreteMallocBlockï¼‰</li></ul><p>åœ¨åº”ç”¨ç¨‹åºä¸­å†…å­˜åˆ†é…æ˜¯è¿™æ ·å­çš„ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">---------------</span><br><span class="line">ç¨‹åºåŒºåŸŸ .textåŒº</span><br><span class="line">---------------</span><br><span class="line">æ•°æ®åŒºåŸŸ .dataåŒº     &lt;--------- _NSConcreteGlobalBlock(å­˜å‚¨å…¨å±€å˜é‡)</span><br><span class="line">---------------</span><br><span class="line">å †                  &lt;--------- _NSConcreteMallocBlock(åŠ¨æ€ç”³è¯·é‡Šæ”¾å†…å­˜åŒºåŸŸ)</span><br><span class="line">---------------</span><br><span class="line">æ ˆ                  &lt;--------- _NSConcreteStackBlock(å­˜å‚¨å­˜å±€éƒ¨å˜é‡)</span><br><span class="line">---------------</span><br></pre></td></tr></table></figure><table><thead><tr><th>blockç±»å‹</th><th>ç¯å¢ƒ</th></tr></thead><tbody><tr><td><strong>NSGlobalBLock</strong></td><td>æ²¡æœ‰è®¿é—®autoå˜é‡</td></tr><tr><td><strong>NSStackBlock</strong></td><td>è®¿é—®autoå˜é‡</td></tr><tr><td><strong>NSMallocBLock</strong></td><td><strong>NSStackBlock</strong> è°ƒç”¨copy</td></tr></tbody></table><p>éªŒè¯éœ€è¦è®¾ç½®æˆMRCï¼Œæ‰¾åˆ°å·¥ç¨‹æ–‡ä»¶ï¼Œè®¾ç½®<code>project-&gt;Object-C Automatic Reference Counting=</code>ä¸º<code>NO</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">int age &#x3D; 10;</span><br><span class="line"></span><br><span class="line">void(^block1)(void)&#x3D;^&#123;</span><br><span class="line">NSLog(@&quot;block1&quot;);</span><br><span class="line">&#125;;</span><br><span class="line">void(^block2)(void)&#x3D;^&#123;</span><br><span class="line">NSLog(@&quot;block2 %d&quot;,age);</span><br><span class="line">&#125;;</span><br><span class="line">void(^block3)(void)&#x3D;[block2 copy];</span><br><span class="line">NSLog(@&quot;block1:%@   block2:%@ block3:%@ &quot;,[block1 class],[block2 class],[block3 class]);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">block1:__NSGlobalBlock__   </span><br><span class="line">block2:__NSStackBlock__ </span><br><span class="line">block3:__NSMallocBlock__</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰è®¿é—®<code>auto</code>å˜é‡çš„<code>block</code>å±äº<code>__NSGlobalBlock__</code>ï¼Œè®¿é—®äº†autoå˜é‡çš„æ˜¯<code>__NSStackBlock__</code>ï¼Œæ‰‹åŠ¨è°ƒç”¨äº†<code>copy</code>çš„<code>block</code>å±äº<code>__NSMallocBlock__</code>ã€‚<code>__NSMallocBlock__</code>æ˜¯åœ¨å †ä¸Šï¼Œéœ€è¦ç¨‹åºå‘˜æ‰‹åŠ¨é‡Šæ”¾<code>[block3 release];</code>ï¼Œä¸é‡Šæ”¾ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚</p><p>æ¯ä¸€ç§ç±»å‹çš„<code>block</code>è°ƒç”¨<code>copy</code>åçš„ç»“æœå¦‚ä¸‹</p><table><thead><tr><th>blockç±»å‹</th><th>å‰¯æœ¬æºçš„é…ç½®å­˜å‚¨åŸŸ</th><th>å¤åˆ¶æ•ˆæœ</th></tr></thead><tbody><tr><td><strong>NSGlobalBLock</strong></td><td>å †</td><td>ä»æ ˆå¤åˆ¶åˆ°å †</td></tr><tr><td><strong>NSStackBlock</strong></td><td>ç¨‹åºçš„æ•°æ®åŒºåŸŸ</td><td>ä»€ä¹ˆä¹Ÿä¸åš</td></tr><tr><td><strong>NSMallocBLock</strong></td><td>å †</td><td>å¼•ç”¨è®¡æ•°+1</td></tr></tbody></table><h4 id="åœ¨ARCç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®è‡ªèº«æƒ…å†µè‡ªåŠ¨å°†æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †ä¸Šï¼Œæ¯”å¦‚ä¸‹åˆ—æƒ…å†µ"><a href="#åœ¨ARCç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®è‡ªèº«æƒ…å†µè‡ªåŠ¨å°†æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †ä¸Šï¼Œæ¯”å¦‚ä¸‹åˆ—æƒ…å†µ" class="headerlink" title="åœ¨ARCç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®è‡ªèº«æƒ…å†µè‡ªåŠ¨å°†æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †ä¸Šï¼Œæ¯”å¦‚ä¸‹åˆ—æƒ…å†µ"></a>åœ¨ARCç¯å¢ƒä¸‹ï¼Œç¼–è¯‘å™¨ä¼šæ ¹æ®è‡ªèº«æƒ…å†µè‡ªåŠ¨å°†æ ˆä¸Šçš„blockå¤åˆ¶åˆ°å †ä¸Šï¼Œæ¯”å¦‚ä¸‹åˆ—æƒ…å†µ</h4><ul><li>blockä½œä¸ºå‡½æ•°è¿”å›å€¼æ—¶</li><li>å°†blockèµ‹å€¼ç»™__strongæŒ‡é’ˆæ—¶</li><li>blockä½œä¸ºCocoa APIä¸­æ–¹æ³•åå«æœ‰usingBlockçš„æ–¹æ³•å‚æ•°æ—¶</li><li>blockä½œä¸ºGCD APIçš„æ–¹æ³•å‚æ•°æ—¶</li></ul><p>åœ¨ARCç¯å¢ƒä¸‹æµ‹è¯•:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">typedef void (^FYBlock)(void);</span><br><span class="line">typedef void (^FYBlockInt)(int);</span><br><span class="line">FYBlock myBlock()&#123;</span><br><span class="line">return ^&#123;</span><br><span class="line">NSLog(@&quot;å“ˆå“ˆ&quot;);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">FYBlock myBlock2()&#123;</span><br><span class="line">int age &#x3D; 10;</span><br><span class="line">return ^&#123;</span><br><span class="line">NSLog(@&quot;å“ˆå“ˆ %d&quot;,age);</span><br><span class="line">&#125;;</span><br><span class="line">&#125;;</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">@autoreleasepool &#123;</span><br><span class="line">FYBlock block &#x3D; myBlock();</span><br><span class="line">FYBlock block2 &#x3D; myBlock2();</span><br><span class="line">int age &#x3D; 10;</span><br><span class="line">FYBlock block3&#x3D; ^&#123;</span><br><span class="line">NSLog(@&quot;å¼ºæŒ‡é’ˆblock %d&quot;,age);</span><br><span class="line">&#125;;</span><br><span class="line">NSLog(@&quot;æ²¡è®¿é—®å˜é‡:%@ è®¿é—®å¸ƒå±€å˜é‡ï¼š%@ å¼ºæŒ‡é’ˆ:%@&quot;,[block class],[block2 class],[block3 class]);</span><br><span class="line">&#125;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">æ²¡è®¿é—®å˜é‡:__NSGlobalBlock__ </span><br><span class="line">è®¿é—®å±€éƒ¨å˜é‡ï¼š__NSMallocBlock__ </span><br><span class="line">å¼ºæŒ‡é’ˆ:__NSMallocBlock__</span><br></pre></td></tr></table></figure><p><code>arc</code>ç¯å¢ƒä¸‹ï¼Œæ²¡è®¿é—®å˜é‡çš„<code>block</code>æ˜¯<code>__NSGlobalBlock__</code>ï¼Œè®¿é—®äº†å±€éƒ¨å˜é‡æ˜¯<code>__NSMallocBlock__</code>,æœ‰å¼ºæŒ‡é’ˆå¼•ç”¨çš„æ˜¯<code>__NSMallocBlock__</code>,å¼ºæŒ‡é’ˆç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œäº†copyæ“ä½œï¼Œç”±æ ˆåŒºå¤åˆ¶åˆ°å †åŒºï¼Œç”±ç³»ç»Ÿç®¡ç†æ”¹ä¸ºå¼€å‘è€…æ‰‹åŠ¨ç®¡ç†ã€‚</p><p><strong>æ‰€ä»¥æœ‰ä»¥ä¸‹å»ºè®®ï¼š</strong></p><p>MRCä¸‹blockå±æ€§çš„å»ºè®®å†™æ³•</p><ul><li>@property (copy, nonatomic) void (^block)(void);</li></ul><p>ARCä¸‹blockå±æ€§çš„å»ºè®®å†™æ³•</p><ul><li>@property (strong, nonatomic) void (^block)(void);</li><li>@property (copy, nonatomic) void (^block)(void);</li></ul><h3 id="å¯¹è±¡ç±»å‹æ•°æ®å’Œblockäº¤äº’"><a href="#å¯¹è±¡ç±»å‹æ•°æ®å’Œblockäº¤äº’" class="headerlink" title="å¯¹è±¡ç±»å‹æ•°æ®å’Œblockäº¤äº’"></a>å¯¹è±¡ç±»å‹æ•°æ®å’Œblockäº¤äº’</h3><p>å¹³æ—¶æˆ‘ä»¬ä½¿ç”¨<code>block</code>ï¼Œå¯¹è±¡ç±»å‹æ¥ä¼ é€’æ•°æ®çš„æ¯”è¾ƒå¤šï¼Œå¯¹è±¡ç±»å‹è¯»å–åˆ°<code>block</code>ä¸­ç”¨<code>__block</code>ä¿®é¥°ç¬¦ï¼Œä¼šæŠŠå¯¹è±¡åœ°å€ç›´æ¥è¯»å–åˆ°<code>block</code>ç»“æ„ä½“å†…ï¼Œ<code>__weak</code>ä¿®é¥°çš„å¯¹è±¡æ˜¯å¼±å¼•ç”¨ï¼Œé»˜è®¤æ˜¯å¼ºå¼•ç”¨ï¼Œæˆ‘ä»¬çœ‹ä¸‹è¿™æ®µä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;FYPerson.h</span><br><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,assign) int age;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;FYPerson.m</span><br><span class="line">@implementation FYPerson</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;main.m</span><br><span class="line">typedef void (^FYBlock)(void);</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">@autoreleasepool &#123;</span><br><span class="line">FYBlock block ;</span><br><span class="line">FYPerson *person &#x3D; [[FYPerson alloc]init];</span><br><span class="line">person.age &#x3D; 10;</span><br><span class="line">__weak typeof(person) __weakPerson &#x3D; person;</span><br><span class="line">block &#x3D; ^&#123;</span><br><span class="line">NSLog(@&quot; %d&quot;,__weakPerson.age);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">block();</span><br><span class="line">&#125;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸‹é¢è¯¥å‘½ä»¤è½¬åŒ–æˆ<code>cpp</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime&#x3D;ios-8.0.0 main.m -o main.cpp</span><br></pre></td></tr></table></figure><p>æ‘˜å–å…³é”®ç»“æ„ä½“ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">struct __main_block_impl_0 &#123;</span><br><span class="line">  struct __block_impl impl;</span><br><span class="line">  struct __main_block_desc_0* Desc;</span><br><span class="line">  FYPerson *__weak __weakPerson;</span><br><span class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, FYPerson *__weak ___weakPerson, int flags&#x3D;0) : __weakPerson(___weakPerson) &#123;</span><br><span class="line">    impl.isa &#x3D; &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags &#x3D; flags;</span><br><span class="line">    impl.FuncPtr &#x3D; fp;</span><br><span class="line">    Desc &#x3D; desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  FYPerson *__weak __weakPerson &#x3D; __cself-&gt;__weakPerson; &#x2F;&#x2F; bound by copy</span><br><span class="line"></span><br><span class="line">    NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_c0_7nm4_r7s4xd0mbs67ljb_b8m0000gn_T_main_7f0272_mi_0,((int (*)(id, SEL))(void *)objc_msgSend)((id)__weakPerson, sel_registerName(&quot;age&quot;)));</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p><code>FYPerson *__weak __weakPerson</code>æ˜¯<code>__weak</code>ä¿®é¥°çš„å¯¹è±¡<br>å½“blockå†…éƒ¨æ¢æˆ<code>block = ^{                NSLog(@&quot; %d&quot;,person.age);            };</code>ï¼Œè½¬æ¢æºç ä¹‹åæ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">struct __main_block_impl_0 &#123;</span><br><span class="line">  struct __block_impl impl;</span><br><span class="line">  struct __main_block_desc_0* Desc;</span><br><span class="line">  FYPerson *__strong person;</span><br><span class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, FYPerson *__strong _person, int flags&#x3D;0) : person(_person) &#123;</span><br><span class="line">    impl.isa &#x3D; &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags &#x3D; flags;</span><br><span class="line">    impl.FuncPtr &#x3D; fp;</span><br><span class="line">    Desc &#x3D; desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>person</code>é»˜è®¤æ˜¯ä½¿ç”¨<code>__storng</code>æ¥ä¿®é¥°çš„ï¼Œ<code>arc</code>ä¸­ï¼Œ<code>block</code>å¼•ç”¨å¤–ç•Œå˜é‡ï¼Œç³»ç»Ÿæ‰§è¡Œäº†<code>copy</code>æ“ä½œï¼Œå°†<code>block</code> <code>copy</code>åˆ°å †ä¸Šï¼Œç”±å¼€å‘è€…è‡ªå·±ç®¡ç†ï¼Œè½¬<code>c/c++</code>ä¸­ç»“æ„ä½“æè¿°ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">static struct __main_block_desc_0 &#123;</span><br><span class="line">  size_t reserved;</span><br><span class="line">  size_t Block_size;</span><br><span class="line">  void (*copy)(struct __main_block_impl_0*, struct __main_block_impl_0*);</span><br><span class="line">  void (*dispose)(struct __main_block_impl_0*);</span><br><span class="line">&#125; __main_block_desc_0_DATA &#x3D; &#123; 0, sizeof(struct __main_block_impl_0)</span><br><span class="line"></span><br><span class="line">static void __main_block_copy_0(struct __main_block_impl_0*dst, struct __main_block_impl_0*src) &#123;_Block_object_assign((void*)&amp;dst-&gt;__weakPerson, (void*)src-&gt;__weakPerson, 3&#x2F;*BLOCK_FIELD_IS_OBJECT*&#x2F;);&#125;</span><br><span class="line"></span><br><span class="line">static void __main_block_dispose_0(struct __main_block_impl_0*src) &#123;_Block_object_dispose((void*)src-&gt;__weakPerson, 3&#x2F;*BLOCK_FIELD_IS_OBJECT*&#x2F;);&#125;</span><br></pre></td></tr></table></figure><p>æœ‰å¯¹è±¡çš„ä½¿ç”¨ï¼Œåˆ™æœ‰å†…å­˜ç®¡ç†ï¼Œæ—¢ç„¶æ˜¯arcï¼Œåˆ™æ˜¯ç³»ç»Ÿå¸®å¼€å‘è€…ç®¡ç†å†…å­˜ï¼Œå‡½æ•°<code>void (*copy)</code>å’Œ<code>void (*dispose)</code>å°±æ˜¯å¯¹blockçš„å¼•ç”¨è®¡æ•°çš„<code>+1</code>å’Œ<code>-1</code>ã€‚</p><p>å¦‚æœblockè¢«æ‹·è´åˆ°å †ä¸Š</p><ul><li>ä¼šè°ƒç”¨blockå†…éƒ¨çš„copyå‡½æ•°</li><li>copyå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_assignå‡½æ•°</li><li>_Block_object_assignå‡½æ•°ä¼šæ ¹æ®autoå˜é‡çš„ä¿®é¥°ç¬¦ï¼ˆ<strong>strongã€</strong>weakã€__unsafe_unretainedï¼‰åšå‡ºç›¸åº”çš„æ“ä½œï¼Œå½¢æˆå¼ºå¼•ç”¨ï¼ˆretainï¼‰æˆ–è€…å¼±å¼•ç”¨</li></ul><p>å¦‚æœblockä»å †ä¸Šç§»é™¤</p><ul><li>ä¼šè°ƒç”¨blockå†…éƒ¨çš„disposeå‡½æ•°</li><li>disposeå‡½æ•°å†…éƒ¨ä¼šè°ƒç”¨_Block_object_disposeå‡½æ•°</li><li>_Block_object_disposeå‡½æ•°ä¼šè‡ªåŠ¨é‡Šæ”¾å¼•ç”¨çš„autoå˜é‡ï¼ˆreleaseï¼Œå¼•ç”¨è®¡æ•°-1ï¼Œè‹¥ä¸º0ï¼Œåˆ™é”€æ¯ï¼‰</li></ul><table><thead><tr><th style="text-align:center">å‡½æ•°</th><th style="text-align:center">è°ƒç”¨æ—¶æœº</th></tr></thead><tbody><tr><td style="text-align:center">copyå‡½æ•°</td><td style="text-align:center">æ ˆä¸Šçš„Blockå¤åˆ¶åˆ°å †æ—¶</td></tr><tr><td style="text-align:center">disposeå‡½æ•°</td><td style="text-align:center">å †ä¸Šçš„Blockè¢«åºŸå¼ƒæ—¶</td></tr></tbody></table><h4 id="é¢˜ç›®"><a href="#é¢˜ç›®" class="headerlink" title="é¢˜ç›®"></a>é¢˜ç›®</h4><p>personä»€ä¹ˆæ—¶é—´é‡Šæ”¾ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-(void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">FYPerson *person &#x3D; [[FYPerson alloc]init];</span><br><span class="line">person.age &#x3D; 10;</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3*NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">NSLog(@&quot;---%d&quot;,person.age);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3såé‡Šæ”¾ï¼Œ<code>dispatch</code>å¯¹<code>block</code>å¼ºå¼•ç”¨ï¼Œ<code>block</code>å¼ºå¼•ç”¨<code>person</code>ï¼Œåœ¨<code>block</code>é‡Šæ”¾çš„æ—¶å€™ï¼Œ<code>person</code>æ²¡å…¶ä»–çš„å¼•ç”¨ï¼Œå°±é‡Šæ”¾æ‰äº†ã€‚</p><p>å˜æ¢1ï¼š<code>person</code>ä»€ä¹ˆæ—¶é—´é‡Šæ”¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FYPerson *person &#x3D; [[FYPerson alloc]init];</span><br><span class="line">person.age &#x3D; 10;</span><br><span class="line">__weak FYPerson *__weakPerosn &#x3D; person;</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3*NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">NSLog(@&quot;---%d&quot;,__weakPerosn.age);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>__weak</code>æ²¡æœ‰å¯¹<code>perosn</code>è¿›è¡Œå¼ºå¼•ç”¨ï¼Œå’‹æ‰§è¡Œå®Œdispatch_blockåˆ™ç«‹é©¬é‡Šæ”¾ï¼Œç­”æ¡ˆæ˜¯ç«‹å³é‡Šæ”¾ã€‚<br>å˜æ¢2ï¼š<code>person</code>ä»€ä¹ˆæ—¶é—´é‡Šæ”¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FYPerson *person &#x3D; [[FYPerson alloc]init];</span><br><span class="line">person.age &#x3D; 10;</span><br><span class="line">__weak typeof(person) __weakPerson &#x3D; person;</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2*NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">NSLog(@&quot;---%d&quot;,__weakPerson.age);</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2*NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">NSLog(@&quot;---%d&quot;,person.age);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>person</code>è¢«å†…éƒ¨<code>block</code>å¼ºå¼•ç”¨ï¼Œåˆ™<code>block</code>é”€æ¯ä¹‹å‰<code>person</code>ä¸ä¼šé‡Šæ”¾ï¼Œ<code>__weakPerson</code>æ‰§è¡Œå®Œ<code>person</code>ä¸ä¼šé”€æ¯ï¼Œ<code>NSLog(@&quot;---%d&quot;,person.age)</code>æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ<code>person</code>é”€æ¯ã€‚ç­”æ¡ˆæ˜¯4ç§’ä¹‹å<code>NSLog(@&quot;---%d&quot;,person.age)</code>æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œ<code>person</code>é”€æ¯ã€‚</p><p>å˜æ¢3ï¼š<code>person</code>ä»€ä¹ˆæ—¶é—´é‡Šæ”¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">FYPerson *person &#x3D; [[FYPerson alloc]init];</span><br><span class="line">person.age &#x3D; 10;</span><br><span class="line">__weak typeof(person) __weakPerson &#x3D; person;</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2*NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">NSLog(@&quot;---%d&quot;,person.age);</span><br><span class="line">dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2*NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">NSLog(@&quot;---%d&quot;,__weakPerson.age);</span><br><span class="line">&#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p><code>person</code>è¢«å¼ºå¼•ç”¨äºç¬¬ä¸€å±‚<code>block</code>ï¼Œç¬¬äºŒå±‚å¼±å¼•ç”¨<code>person</code>ï¼Œä»…ä»…å½“ç¬¬ä¸€å±‚blockæ‰§è¡Œå®Œæ¯•çš„æ—¶å€™ï¼Œ<code>person</code>é‡Šæ”¾ã€‚</p><h4 id="ä¿®æ”¹blockå¤–éƒ¨å˜é‡"><a href="#ä¿®æ”¹blockå¤–éƒ¨å˜é‡" class="headerlink" title="ä¿®æ”¹blockå¤–éƒ¨å˜é‡"></a>ä¿®æ”¹blockå¤–éƒ¨å˜é‡</h4><p>æƒ³è¦ä¿®æ”¹å˜é‡ï¼Œé¦–å…ˆè¦å˜é‡çš„æœ‰æ•ˆåŒºåŸŸï¼Œæˆ–è€…blockæŒæœ‰å˜é‡çš„åœ°å€ã€‚<br>ä¾‹å­1ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int age &#x3D; 10;</span><br><span class="line">FYBlock block &#x3D; ^&#123;</span><br><span class="line">    age &#x3D; 20;&#x2F;&#x2F;ä¼šæŠ¥é”™</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æŠ¥é”™çš„åŸå› æ˜¯<code>age</code>æ˜¯å€¼ä¼ é€’ï¼Œæƒ³è¦ä¸æŠ¥é”™åªéœ€è¦å°†<code>int age = 10</code>æ”¹æˆ<code>static int age = 10</code>ï¼Œå°±ç”±å€¼ä¼ é€’å˜æˆåœ°å€ä¼ é€’ï¼Œæœ‰äº†<code>age</code>çš„åœ°å€ï¼Œåœ¨<code>block</code>çš„å†…éƒ¨å°±å¯ä»¥æ›´æ”¹<code>age</code>çš„å€¼äº†ã€‚æˆ–è€…å°†<code>int age = 10</code>æ”¹æˆå…¨å±€å˜é‡ï¼Œå…¨å±€å˜é‡åœ¨<code>block</code>ä¸­ä¸ç”¨æ•è·ï¼Œ<code>block</code>æœ¬è´¨ä¼šç¼–è¯‘æˆ<code>c</code>å‡½æ•°ï¼Œ<code>c</code>å‡½æ•°è®¿é—®å…¨å±€å˜é‡åœ¨ä»»æ„åœ°æ–¹éƒ½å¯ä»¥ç›´æ¥è®¿é—®ã€‚</p><h4 id="blockæœ¬è´¨-1"><a href="#blockæœ¬è´¨-1" class="headerlink" title="__blockæœ¬è´¨"></a>__blockæœ¬è´¨</h4><p><code>__block</code>æœ¬è´¨ä¸Šæ˜¯ä¿®é¥°çš„å¯¹è±¡æˆ–åŸºæœ¬ç±»å‹ï¼Œç¼–è¯‘ä¹‹åä¼šç”Ÿæˆä¸€ä¸ªç»“æ„ä½“<code>__Block_byref_age_0</code>,ç»“æ„ä½“ä¸­<code>*__forwarding</code>æŒ‡å‘ç»“æ„ä½“è‡ªå·±ï¼Œé€šè¿‡<br><code>(age-&gt;__forwarding-&gt;age) = 20</code>æ¥ä¿®æ”¹å˜é‡çš„å€¼ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">struct __Block_byref_age_0 &#123;</span><br><span class="line">  void *__isa;</span><br><span class="line">__Block_byref_age_0 *__forwarding;</span><br><span class="line"> int __flags;</span><br><span class="line"> int __size;</span><br><span class="line"> int age;&#x2F;&#x2F;10</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct __main_block_impl_0 &#123;</span><br><span class="line">  struct __block_impl impl;</span><br><span class="line">  struct __main_block_desc_0* Desc;</span><br><span class="line">  __Block_byref_age_0 *age; &#x2F;&#x2F; by ref</span><br><span class="line">  __main_block_impl_0(void *fp, struct __main_block_desc_0 *desc, __Block_byref_age_0 *_age, int flags&#x3D;0) : age(_age-&gt;__forwarding) &#123;</span><br><span class="line">    impl.isa &#x3D; &amp;_NSConcreteStackBlock;</span><br><span class="line">    impl.Flags &#x3D; flags;</span><br><span class="line">    impl.FuncPtr &#x3D; fp;</span><br><span class="line">    Desc &#x3D; desc;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line">static void __main_block_func_0(struct __main_block_impl_0 *__cself) &#123;</span><br><span class="line">  __Block_byref_age_0 *age &#x3D; __cself-&gt;age; &#x2F;&#x2F; bound by ref</span><br><span class="line">            (age-&gt;__forwarding-&gt;age) &#x3D; 20;</span><br><span class="line">            NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_5p_cwsr3ytd5md9r_kgb2fv_2c40000gn_T_main_043d00_mi_0,(age-&gt;__forwarding-&gt;age));</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p><code>age</code>åœ¨<code>block</code>å¤–éƒ¨æœ‰ä¸€ä¸ªï¼Œåœ¨<code>block</code>å†…éƒ¨æœ‰ä¸€ä¸ªï¼Œä»–ä»¬æ˜¯åŒä¸€ä¸ªå—ï¼Ÿæˆ‘ä»¬æ¥æ¢ç©¶ä¸€ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">typedef   void (^FYBlock)(void);</span><br><span class="line">struct __Block_byref_age_0 &#123;</span><br><span class="line">    void *__isa;</span><br><span class="line">    struct __Block_byref_age_0 *__forwarding;</span><br><span class="line">    int __flags;</span><br><span class="line">    int __size;</span><br><span class="line">    int age;&#x2F;&#x2F;10</span><br><span class="line">&#125;;</span><br><span class="line">struct __main_block_desc_0 &#123;</span><br><span class="line">    size_t reserved;</span><br><span class="line">    size_t Block_size;</span><br><span class="line">    void (*copy)(void);</span><br><span class="line">    void (*dispose)(void);</span><br><span class="line">&#125;;</span><br><span class="line">struct __block_impl &#123;</span><br><span class="line">    void *isa;</span><br><span class="line">    int Flags;</span><br><span class="line">    int Reserved;</span><br><span class="line">    void *FuncPtr;</span><br><span class="line">&#125;;</span><br><span class="line">struct __main_block_impl_0 &#123;</span><br><span class="line">    struct __block_impl impl;</span><br><span class="line">    struct __main_block_desc_0* Desc;</span><br><span class="line">    struct __Block_byref_age_0 *age; &#x2F;&#x2F; by ref</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">@autoreleasepool &#123;</span><br><span class="line">    &#x2F;&#x2F; insert code here...</span><br><span class="line">__blockint age &#x3D; 10;</span><br><span class="line">        NSLog(@&quot; age1:%p&quot;,&amp;age);</span><br><span class="line">        FYBlock block &#x3D; ^&#123;</span><br><span class="line">            age &#x3D; 20;</span><br><span class="line">            NSLog(@&quot;age is %d&quot;,age);</span><br><span class="line">        &#125;;</span><br><span class="line">        struct __main_block_impl_0 *main&#x3D; (__bridge struct __main_block_impl_0 *)block;</span><br><span class="line">        NSLog(@&quot; age1:%p age2:%p&quot;,&amp;age,&amp;(main-&gt;age-&gt;__forwarding-&gt;age));</span><br><span class="line">&#125;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br><span class="line">è¾“å‡ºï¼š</span><br><span class="line">age1:0x7ffeefbff548</span><br><span class="line">age1:0x100605358 age2:0x100605358</span><br></pre></td></tr></table></figure><p>ç»è¿‡<code>__block</code>ä¿®é¥°ä¹‹åï¼Œä¹‹åè®¿é—®çš„<code>age</code>å’Œç»“æ„ä½“<code>__Block_byref_age_0</code>ä¸­çš„<code>age</code>åœ°å€æ˜¯ä¸€æ ·çš„ï¼Œå¯ä»¥åˆ¤å®š<code>age</code>è¢«ç³»ç»Ÿ<code>copy</code>äº†ä¸€ä»½ã€‚</p><p>ä¾‹å­ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__blockint age &#x3D; 10;</span><br><span class="line">       NSLog(@&quot; age1:%p&quot;,&amp;age);</span><br><span class="line">       NSObject *obj&#x3D;[[NSObject alloc]init];</span><br><span class="line">       FYBlock block &#x3D; ^&#123;</span><br><span class="line">           </span><br><span class="line">           NSLog(@&quot;age is %d,obj is %p&quot;,age,&amp;obj);</span><br><span class="line">       &#125;;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å‘½ä»¤ç¼–è¯‘</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime&#x3D;ios-8.0.0 main.m</span><br></pre></td></tr></table></figure><p>æ‘˜å½•ä¸»è¦å‡½æ•°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">struct __Block_byref_age_0 &#123;</span><br><span class="line">  void *__isa;</span><br><span class="line">__Block_byref_age_0 *__forwarding;</span><br><span class="line"> int __flags;</span><br><span class="line"> int __size;</span><br><span class="line"> int age;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct __main_block_impl_0 &#123;</span><br><span class="line">  struct __block_impl impl;</span><br><span class="line">  struct __main_block_desc_0* Desc;</span><br><span class="line">  NSObject *__strong obj;</span><br><span class="line">  __Block_byref_age_0 *age; &#x2F;&#x2F; by ref</span><br><span class="line">&#125;;</span><br><span class="line">&#96;&#96;&#96; </span><br><span class="line"></span><br><span class="line">&#96;__main_block_impl_0&#96;ç»“æ„ä½“å¯¹&#96;age&#96;è¿›è¡Œäº†ä¸€ä¸ªå¼ºå¼•ç”¨å¹¶æŒæœ‰è¯¥ç»“æ„ä½“çš„åœ°å€ï¼Œå°†&#96;age&#96;å¤åˆ¶åˆ°äº†å †ä¸Šï¼Œ&#96;age&#96;è½¬åŒ–æˆ&#96;__Block_byref_age_0&#96;å¯¹è±¡ï¼Œ&#96;__main_block_impl_0&#96;å¯ä»¥å¯¹&#96;__Block_byref_age_0-&gt;__forwarding-&gt;age&#96;è¿›è¡Œèµ‹å€¼ã€‚&#96;__Block_byref_age_0&#96;æ—¢ç„¶æ˜¯å¯¹è±¡ï¼Œå°±éœ€è¦å†…å­˜ç®¡ç†ï¼Œ&#96;__main_block_copy_0&#96;å‡ºç°äº†&#96;_Block_object_assign&#96;å’Œ&#96;_Block_object_dispose&#96;å¯¹&#96;__Block_byref_age_0&#96;è¿›è¡Œå†…å­˜ç®¡ç†çš„ä»£ç ã€‚</span><br></pre></td></tr></table></figure><p>static void <strong>main_block_copy_0(struct </strong>main_block_impl_0<em>dst, struct __main_block_impl_0</em>src) {<br>    _Block_object_assign((void<em>)&amp;dst-&gt;age, (void</em>)src-&gt;age, 8/<em>BLOCK_FIELD_IS_BYREF</em>/);<br>    _Block_object_assign((void<em>)&amp;dst-&gt;obj, (void</em>)src-&gt;obj, 3/<em>BLOCK_FIELD_IS_OBJECT</em>/);}</p><pre><code>static void __main_block_dispose_0(struct __main_block_impl_0*src) {_Block_object_dispose((void*)src-&gt;age, 8/*BLOCK_FIELD_IS_BYREF*/);_Block_object_dispose((void*)src-&gt;obj, 3/*BLOCK_FIELD_IS_OBJECT*/);}</code></pre><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;age&#96;å’Œ&#96;obj&#96;æ˜¯ä¸€ä¸ªå¯¹è±¡ç»“æ„ä½“ï¼Œ&#96;obj&#96;åªæ˜¯ä¸€ä¸ªå¼ºå¼•ç”¨è€Œæ²¡æœ‰åœ°å€å˜æ¢åŸå› æ˜¯&#96;obj&#96;æœ¬èº«å°±åœ¨å †ä¸Šï¼Œ&#96;block&#96;ä¹Ÿåœ¨å †ä¸Šï¼Œæ•…æ— éœ€å¤åˆ¶å‡ºæ–°çš„&#96;obj&#96;æ¥è¿›è¡Œç®¡ç†ã€‚</span><br><span class="line"></span><br><span class="line">çœ‹ä¸€ä¸‹å¾ªç¯å¼•ç”¨æ˜¯åé¢æ•™æ</span><br></pre></td></tr></table></figure><p>typedef   void (^FYBlock)(void);<br>@interface FYPerson : NSObject</p><p>@property (nonatomic,copy) FYBlock blcok;<br>@end</p><p>@implementation FYPerson</p><ul><li>(void)dealloc{<br>  NSLog(@â€%sâ€,<strong>func</strong>);<br>}<br>@end</li></ul><p>int main(int argc, const char <em> argv[]) {<br>    @autoreleasepool {<br>        NSLog(@â€ age1:%pâ€,&amp;age);<br>        FYPerson </em>obj=[[FYPerson alloc]init];<br>        [obj setBlcok:^{<br>            NSLog(@â€%pâ€,&amp;obj);<br>        }];<br>        NSLog(@â€â€”â€”â€”â€”â€“â€);<br>    }<br>    return 0;<br>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">è¾“å‡ºæ˜¯ï¼š</span><br></pre></td></tr></table></figure><br>age1:0x7ffeefbff4e8<br>block æ‰§è¡Œå®Œæ¯•â€”â€”â€”â€”â€“<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;obj&#96;é€šè¿‡&#96;copy&#96;æ“ä½œå¼ºå¼•ç”¨&#96;block&#96;,&#96;block&#96;é€šè¿‡é»˜è®¤&#96;__strong&#96;å¼ºåˆ¶å¼•ç”¨&#96;obj&#96;,è¿™å°±æ˜¯&#96;A&lt;----&gt;B&#96;ï¼Œç›¸äº’å¼•ç”¨å¯¼è‡´æ‰§è¡Œç»“æŸåº”è¯¥é‡Šæ”¾çš„æ—¶å€™æ— æ³•é‡Šæ”¾ã€‚</span><br><span class="line">å°†&#96;main&#96;æ”¹æˆ</span><br></pre></td></tr></table></figure><br>FYPerson <em>obj=[[FYPerson alloc]init];<br>        <strong>weak typeof(obj) weakObj = obj;<br>        [obj setBlcok:^{<br>            NSLog(@â€%pâ€,&amp;weakObj);<br>        }];<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ç»“æœæ˜¯</span><br></pre></td></tr></table></figure><br>age1:0x7ffeefbff4e8<br>block æ‰§è¡Œå®Œæ¯•â€”â€”â€”â€”â€“<br>-[FYPerson dealloc]<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">ä½¿ç”¨&#96;__weak&#96;æˆ–&#96;__unsafe__unretain&#96;å¼±å¼•ç”¨&#96;obj&#96;,åœ¨&#96;block&#96;æ‰§è¡Œå®Œæ¯•çš„æ—¶å€™ï¼Œ&#96;obj&#96;é‡Šæ”¾ï¼Œ&#96;block&#96;é‡Šæ”¾ï¼Œæ— ç›¸äº’å¼ºå¼•ç”¨ï¼Œæ­£å¸¸é‡Šæ”¾ã€‚</span><br><span class="line">#### &#96;__weak&#96;å’Œ&#96;__unsafe__unretain&#96;</span><br><span class="line">&#96;__weak&#96;å’Œ&#96;__unsafe__unretain&#96;éƒ½æ˜¯å¼±å¼•ç”¨&#96;obj&#96;,éƒ½æ˜¯ä¸å½±å“&#96;obj&#96;æ­£å¸¸é‡Šæ”¾ï¼ŒåŒºåˆ«æ˜¯&#96;__weak&#96;åœ¨é‡Šæ”¾ä¹‹åä¼šå°†å€¼ä¸ºnilï¼Œ&#96;__unsafe__unretain&#96;ä¸å¯¹è¯¥å†…å­˜å¤„ç†ã€‚</span><br><span class="line">ä¸‹é¢æˆ‘ä»¬æ¥å…·ä½“éªŒè¯ä¸€ä¸‹è¯¥ç»“è®ºï¼š</span><br></pre></td></tr></table></figure><br>typedef   void (^FYBlock)(void);<br>@interface FYPerson : NSObject<br>@property (nonatomic,assign) int age ;<br>@end<br>@implementation FYPerson<br>-(void)dealloc{<br>    NSLog(@â€%sâ€,</strong>func<strong>);<br>}<br>@end<br>struct </strong>Block_byref_age_0 {<br>    void </em><strong>isa;<br>    struct </strong>Block_byref_age_0 <em><strong>forwarding;<br>    int </strong>flags;<br>    int <strong>size;<br>    int age;<br>};<br>struct </strong>block_impl {<br>    void </em>isa;<br>    int Flags;<br>    int Reserved;<br>    void <em>FuncPtr;<br>};<br>struct __main_block_desc_0 {<br>    size_t reserved;<br>    size_t Block_size;<br>    void (</em>copy)(void);<br>    void (<em>dispose)(void);<br>};<br>struct <strong>main_block_impl_0 {<br>    struct </strong>block_impl impl;<br>    struct __main_block_desc_0</em> Desc;<br>    FYPerson *<strong>unsafe_unretained </strong>unsafe_obj;<br>};</p><p>int main(int argc, const char <em> argv[]) {<br>    @autoreleasepool {<br>        // insert code hereâ€¦<br>        FYBlock block;<br>        {<br>            FYPerson </em>obj=[[FYPerson alloc]init];<br>            obj.age = 5;<br>            <strong>weak typeof(obj) </strong>unsafe_obj = obj;<br>            block = ^{</p><pre><code>            NSLog(@&quot;obj-&gt;age is %d obj:%p&quot;,__unsafe_obj.age,&amp;__unsafe_obj);        };        struct __main_block_impl_0 *suct = (__bridge struct __main_block_desc_0 *)block;        NSLog(@&quot;inside struct-&gt;obj:%p&quot;,suct-&gt;__unsafe_obj);//æ–­ç‚¹1    }    struct __main_block_impl_0 *suct = (__bridge struct __main_block_desc_0 *)block;    NSLog(@&quot;outside struct-&gt;obj:%p&quot;,suct-&gt;__unsafe_obj);//æ–­ç‚¹2    block();    NSLog(@&quot;----end------&quot;);}return 0;</code></pre><p>}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">æ ¹æ®æ–‡ä¸­æç¤ºæ–­ç‚¹1å¤„ä½¿ç”¨&#96;lldb&#96;æ‰“å°&#96;obj&#96;å‘½ä»¤</span><br></pre></td></tr></table></figure><br>(lldb) p suct-&gt;__unsafe_obj-&gt;_age<br>(int) $0 = 5 //å¹´é¾„5è¿˜æ˜¯å­˜å‚¨åœ¨è¿™é‡Œçš„<br>inside struct-&gt;obj:0x102929d80</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">åœ¨æ–­ç‚¹2å¤„å†æ¬¡æŸ¥çœ‹&#96;obj&#96;çš„å€¼ï¼ŒæŠ¥é”™ä¸å¯è¯»å–è¯¥å†…å­˜</span><br></pre></td></tr></table></figure><p>-[FYPerson dealloc]<br>outside struct-&gt;obj:0x0<br>p suct-&gt;<strong>unsafe_obj-&gt;_age<br>error: Couldnâ€™t apply expression side effects : Couldnâ€™t dematerialize a result variable: couldnâ€™t read its memory<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">å·²ç»è¶…å‡ºäº†&#96;obj&#96;çš„æœ‰æ•ˆèŒƒå›´ï¼Œ&#96;obj&#96;å·²ç»é‡ç½®ä¸ºnilï¼Œä¹Ÿå°±æ˜¯&#96;0x0000000000000000&#96;ã€‚</span><br><span class="line">ä¸Šæ–‡ä»£ç &#96;__weak&#96;æ”¹ä¸º&#96;__unsafe_unretained&#96;å†æ¬¡åœ¨&#96;obj&#96;æ–­ç‚¹1æŸ¥çœ‹åœ°å€ï¼š</span><br></pre></td></tr></table></figure><br>(lldb) p suct-&gt;</strong>unsafe_obj-&gt;_age<br>(int) $0 = 5<br>inside struct-&gt;obj:0x10078c0c0</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">åœ¨æ–­ç‚¹2å‡ºå†æ¬¡æŸ¥çœ‹åœ°å€å¹¶æŸ¥çœ‹&#96;age&#96;çš„å€¼</span><br></pre></td></tr></table></figure><p>-[FYPerson dealloc]<br>outside struct-&gt;obj:0x10078c0c0<br>(lldb) p suct-&gt;<strong>unsafe_obj-&gt;_age<br>(int) $1 = 5<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&#96;__unsafe_unretained&#96;åœ¨&#96;obj&#96;é”€æ¯ä¹‹åå†…å­˜å¹¶æ²¡æœ‰åŠæ—¶é‡ç½®ä¸ºç©ºã€‚</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">å½“æˆ‘ä»¬ç¦»å¼€æŸä¸ªé¡µé¢éœ€è¦å†æ‰§è¡Œçš„æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬æ”¹æ€ä¹ˆåŠï¼Ÿ</span><br><span class="line">å®é™…åº”ç”¨A:</span><br></pre></td></tr></table></figure><br>-(void)test{    </strong>weak typeof(self) <strong>weakself = self;<br>    [self setBlcok:^{<br>        dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(3 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{<br>            NSLog(@â€perosn :%pâ€,</strong>weakself);<br>        });<br>    }];<br>    self.blcok();<br>}</p><p>int main(int argc, const char <em> argv[]) {<br>    @autoreleasepool {<br>        {<br>            FYPerson </em>obj=[[FYPerson alloc]init];<br>            [obj test];<br>            NSLog(@â€block æ‰§è¡Œå®Œæ¯•â€”â€”â€”â€”â€“â€);<br>        }<br>        NSLog(@â€person æ­»äº†â€);<br>    }<br>    return 0;<br>}<br>è¾“å‡ºï¼š<br>block æ‰§è¡Œå®Œæ¯•â€”â€”â€”â€”â€“<br>-[FYPerson dealloc]<br>person æ­»äº†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">çŒ›çš„ä¸€çœ‹ï¼Œå“ªé‡Œéƒ½å¯¹ï¼ä½¿ç”¨&#96;__weak&#96;å¯¹&#96;self&#96;è¿›è¡Œå¼±å¼•ç”¨ï¼Œä¸ä¼šå¯¼è‡´æ­»å¾ªç¯ï¼Œåœ¨&#96;self&#96;æ­»çš„æ—¶å€™ï¼Œ&#96;block&#96;ä¹Ÿä¼šæ­»ï¼Œå°±ä¼šå¯¼è‡´ä¸€ä¸ªé—®é¢˜ï¼Œ&#96;self&#96;å’Œ&#96;block&#96;å…±å­˜äº¡ï¼Œä½†æ˜¯è¿™ä¸ªéœ€è¦3ç§’åå†æ‰§è¡Œï¼Œ3ç§’åï¼Œ&#96;self&#96;å·²ç»æ­»äº†ï¼Œ&#96;block&#96;ä¹Ÿæ­»äº†ï¼Œæ˜¾ç„¶ä¸ç¬¦åˆæˆ‘ä»¬çš„ä¸šåŠ¡éœ€æ±‚ã€‚</span><br><span class="line">é‚£ä¹ˆæˆ‘ä»¬å‰¥ç¦»&#96;block&#96;å’Œ&#96;self&#96;çš„å…³ç³»ï¼Œè®©&#96;block&#96;å¼ºå¼•ç”¨&#96;self&#96;,&#96;self&#96;ä¸æŒæœ‰&#96;block&#96;å°±èƒ½æ»¡è¶³ä¸šåŠ¡äº†ã€‚å¦‚ä¸‹æ‰€ç¤ºï¼š</span><br></pre></td></tr></table></figure><br>    <strong>block typeof(self) </strong>weakSelf = self;//<strong>blockæˆ–è€…æ²¡æœ‰ä¿®é¥°ç¬¦<br>    dispatch_async(dispatch_get_main_queue(), ^{<br>        sleep(2);<br>        NSLog(@â€obj:%@â€,</strong>weakSelf-&gt;_obj);<br>    });<br>//perosn :0x0<br>```</p><p>å½“<code>self</code>ä¸æŒç”¨<code>block</code>çš„æ—¶å€™ï¼Œ<code>block</code>å¯ä»¥å¼ºå¼•ç”¨<code>self</code>,<code>block</code>æ‰§è¡Œå®Œæ¯•è‡ªå·±é‡Šæ”¾ï¼Œä¹Ÿä¼šé‡Šæ”¾<code>self</code>ï¼Œå½“<code>self</code>æŒæœ‰<code>block</code>ï¼Œ<code>block</code>å¿…é¡»å¼±å¼•ç”¨<code>self</code>,åˆ™é‡Šæ”¾<code>self</code>,<code>block</code>ä¹Ÿä¼šé‡Šæ”¾ï¼Œå¦åˆ™ä¼šå¾ªç¯å¼•ç”¨ã€‚</p><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li><code>block</code>æœ¬è´¨æ˜¯ä¸€ä¸ªå°è£…äº†å‡½æ•°è°ƒç”¨ä»¥åŠè°ƒç”¨ç¯å¢ƒçš„<code>ç»“æ„ä½“</code>å¯¹è±¡</li><li><code>__block</code>ä¿®é¥°çš„å˜é‡ä¼šè¢«å°è£…æˆ<code>ç»“æ„ä½“</code>å¯¹è±¡ï¼Œä¹‹å‰åœ¨æ•°æ®æ®µçš„ä¼šè¢«å¤åˆ¶åˆ°å †ä¸Šï¼Œä¹‹å‰åœ¨å †ä¸Šçš„åˆ™ä¸å—å½±å“ï¼Œè§£å†³<code>auto</code>å¯¹è±¡åœ¨<code>block</code>å†…éƒ¨æ— æ³•ä¿®æ”¹çš„é—®é¢˜ï¼Œåœ¨<code>MRC</code>ç¯å¢ƒä¸‹,<code>__block</code>ä¸ä¼šå¯¹å˜é‡äº§ç”Ÿå¼ºå¼•ç”¨.</li><li><code>block</code>ä¸ä½¿ç”¨<code>copy</code>åˆ™ä¸ä¼šä»å…¨å±€æˆ–è€…æ ˆåŒºåŸŸç§»åŠ¨åˆ°å †ä¸Šï¼Œä½¿ç”¨<code>copy</code>ä¹‹åæœ‰ç”±å‘è€…ç®¡ç†</li><li>ä½¿ç”¨<code>block</code>è¦æ³¨æ„ä¸èƒ½äº§ç”Ÿå¾ªç¯å¼•ç”¨ï¼Œå¼•ç”¨ä¸èƒ½å˜æˆä¸€ä¸ªç¯ï¼Œä¸»åŠ¨ä½¿å…¶ä¸­ä¸€ä¸ªå¼•ç”¨æˆå¼±å¼•ç”¨ï¼Œåˆ™ä¸ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨ã€‚</li><li><code>__weak</code>ä¿®é¥°çš„å¯¹è±¡ï¼Œ<code>block</code>ä¸ä¼šå¯¹å¯¹è±¡å¼ºå¼•ç”¨ï¼Œåœ¨æ‰§è¡Œ<code>block</code>çš„æ—¶å€™æœ‰å¯èƒ½ä¼šå€¼å·²ç»è¢«ç³»ç»Ÿç½®ä¸º<code>nil</code>,<code>__unsafe_unretained</code>ä¿®é¥°çš„é”€æ¯ä¹‹åå†…å­˜ä¸ä¼šåŠæ—¶é‡ç½®ä¸ºç©ºã€‚</li></ul><p>æˆ‘ä»¬çœ‹çš„<code>cpp</code>æ˜¯ç¼–è¯‘ä¹‹åçš„ä»£ç ï¼Œ<code>runtime</code>æ˜¯å¦å’Œæˆ‘ä»¬çœ‹åˆ°çš„ä¸€è‡´å‘¢ï¼Ÿè¯·å¬ä¸‹å›åˆ†è§£ã€‚</p><h4 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h4><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code<i class="fa fa-external-link"></i></span></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9vYmpjNC03NTA=" title="https://github.com/ifgyong/demo/tree/master/OC/objc4-750">runtimeå¯è¿è¡Œçš„æºç <i class="fa fa-external-link"></i></span></p><p>æœ¬æ–‡ç« ä¹‹æ‰€ä»¥å›¾ç‰‡æ¯”è¾ƒå°‘ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯è·Ÿç€ä»£ç æ•²ä¸€éï¼Œå°è±¡æ¯”è¾ƒæ·±åˆ»ã€‚</p><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p></li></ul><p>å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æœ¬ç« è®²è§£blockçš„ç”¨æ³•å’Œåº•å±‚æ•°æ®ç»“æ„ï¼Œä»¥åŠä½¿ç”¨è¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„çš„ç‚¹ã€‚&lt;/p&gt;
&lt;h3 id=&quot;blockæœ¬è´¨&quot;&gt;&lt;a href=&quot;#blockæœ¬è´¨&quot; class=&quot;headerlink&quot; title=&quot;blockæœ¬è´¨&quot;&gt;&lt;/a&gt;blockæœ¬è´¨&lt;/h3&gt;&lt;p&gt;å‰å‡ ç¯‡æ–‡ç« è®²è¿‡äº†
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç† Categoryä¸å…³è”å¯¹è±¡æœ¬è´¨--(4)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20Category%E4%B8%8E%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E6%9C%AC%E8%B4%A8--(4)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20Category%E4%B8%8E%E5%85%B3%E8%81%94%E5%AF%B9%E8%B1%A1%E6%9C%AC%E8%B4%A8--(4)/</id>
    <published>2019-12-01T03:14:58.000Z</published>
    <updated>2020-09-04T04:40:21.656Z</updated>
    
    <content type="html"><![CDATA[<p> ä»Šå¤©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹<code>Category</code>çš„åº•å±‚åŸç†ã€‚<br> å…ˆçœ‹ä¸€ä¸‹<code>Category</code>çš„ç®€å•ä½¿ç”¨ï¼Œé¦–å…ˆæ–°å¢ä¸€ä¸ªç±»çš„<code>Category</code>ï¼Œç„¶åæ·»åŠ éœ€è¦çš„å‡½æ•°ï¼Œç„¶ååœ¨ä½¿ç”¨çš„æ–‡ä»¶ä¸­å¯¼å…¥å°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚ä»£ç å¦‚ä¸‹:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">- (void)run;</span><br><span class="line">@end</span><br><span class="line">@implementation FYPerson</span><br><span class="line">-(void)run&#123;</span><br><span class="line">NSLog(@&quot;run is run&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ç±»åˆ«</span><br><span class="line">@interface FYPerson (test)</span><br><span class="line">- (void)test;</span><br><span class="line">@end</span><br><span class="line">@implementation FYPerson (test)</span><br><span class="line">- (void)test&#123;</span><br><span class="line">NSLog(@&quot;test is run&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ä½¿ç”¨</span><br><span class="line">#import &quot;FYPerson.h&quot;</span><br><span class="line">#import &quot;FYPerson+test.h&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FYPerson *person&#x3D;[[FYPerson alloc]init];</span><br><span class="line">[person test];</span><br><span class="line">[person run];</span><br></pre></td></tr></table></figure><p>  ç±»åˆ«ä½¿ç”¨å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚<br>  é‚£ä¹ˆç±»åˆ«çš„æœ¬è´¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿç±»çš„æ–¹æ³•æ˜¯å­˜å‚¨åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿ<br>  ç¬¬ä¸€ç¯‡<span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vcG9zdC81ZDE1ODg3ZWU1MWQ0NTEwODEyNmQyOGQ=" title="https://juejin.im/post/5d15887ee51d45108126d28d">ç±»çš„æœ¬è´¨<i class="fa fa-external-link"></i></span>å·²ç»è®²è¿‡äº†ï¼Œè¿è¡Œæ—¶ä¸­ï¼Œç±»å¯¹è±¡æ˜¯æœ‰ä¸€ä»½ï¼Œæ–¹æ³•éƒ½å­˜å‚¨åœ¨ç±»å¯¹è±¡ç»“æ„ä½“<code>fy_objc_class</code>ä¸­çš„<code>class_data_bits_t-&gt;data()-&gt;method_list_t</code>ä¸­çš„ï¼Œé‚£ä¹ˆç±»åˆ«æ–¹æ³•ä¹Ÿæ˜¯å­˜å‚¨åœ¨<code>method_list_t</code>å’Œå–å…ƒç±»å¯¹è±¡çš„<code>method_list_t</code>ä¸­çš„ã€‚ç¼–è¯‘çš„æ—¶å€™ç±»åˆ«ç¼–è¯‘æˆç»“æ„ä½“<code>_category_t</code>,ç„¶å<code>runtime</code>åœ¨è¿è¡Œæ—¶åŠ¨æ€å°†æ–¹æ³•æ·»åŠ åˆ°<code>method_list_t</code>ä¸­ã€‚è¿è¡Œ<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc FYPerson+test.m -o FYPerson+test.cpp</code>è¿›å…¥åˆ°<code>FYPerson+test.cpp</code>å†…éƒ¨æŸ¥çœ‹ç¼–è¯‘ä¹‹åçš„ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">  struct _category_t &#123;</span><br><span class="line">const char *name; &#x2F;&#x2F;&quot;FYPerson&quot;</span><br><span class="line">struct _class_t *cls;</span><br><span class="line">const struct _method_list_t *instance_methods;</span><br><span class="line">const struct _method_list_t *class_methods;</span><br><span class="line">const struct _protocol_list_t *protocols;</span><br><span class="line">const struct _prop_list_t *properties;</span><br><span class="line">&#125;;</span><br><span class="line">&#x2F;&#x2F;å­˜å‚¨ testæ–¹æ³•</span><br><span class="line">static struct &#x2F;*_method_list_t*&#x2F; &#123;</span><br><span class="line">unsigned int entsize;  &#x2F;&#x2F; sizeof(struct _objc_method)</span><br><span class="line">unsigned int method_count;</span><br><span class="line">struct _objc_method method_list[1];</span><br><span class="line">&#125; _OBJC_$_CATEGORY_INSTANCE_METHODS_FYPerson_$_test __attribute__ ((used, section (&quot;__DATA,__objc_const&quot;))) &#x3D; &#123;</span><br><span class="line">sizeof(_objc_method),</span><br><span class="line">1,</span><br><span class="line">&#123;&#123;(struct objc_selector *)&quot;test&quot;, &quot;v16@0:8&quot;, (void *)_I_FYPerson_test_test&#125;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">extern &quot;C&quot; __declspec(dllimport) struct _class_t OBJC_CLASS_$_FYPerson;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;_category_t å­˜å‚¨FYPersonçš„åˆ†ç±»çš„æ•°æ®</span><br><span class="line">static struct _category_t _OBJC_$_CATEGORY_FYPerson_$_test __attribute__ ((used, section (&quot;__DATA,__objc_const&quot;))) &#x3D; </span><br><span class="line">&#123;</span><br><span class="line">&quot;FYPerson&quot;,</span><br><span class="line">0, &#x2F;&#x2F; &amp;OBJC_CLASS_$_FYPerson,</span><br><span class="line">(const struct _method_list_t *)&amp;_OBJC_$_CATEGORY_INSTANCE_METHODS_FYPerson_$_test,&#x2F;&#x2F;instaceæ–¹æ³•</span><br><span class="line">0,&#x2F;&#x2F;ç±»æ–¹æ³•</span><br><span class="line">0,&#x2F;&#x2F;åè®®æ–¹æ³•</span><br><span class="line">0,&#x2F;&#x2F;å±æ€§</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å­˜å‚¨åœ¨<code>_category_t</code>ä¸­çš„æ•°æ®æ˜¯ä»€ä¹ˆæ—¶é—´åŠ è½½åˆ°<code>FYPerson</code>çš„<code>class_data_bits_t.data</code>å‘¢ï¼Ÿæˆ‘ä»¬æ¢ç©¶ä¸€ä¸‹ï¼Œæ‰“å¼€<span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscy9vYmpjNC8=" title="https://opensource.apple.com/tarballs/objc4/">æºç <i class="fa fa-external-link"></i></span>ä¸‹è½½æ‰“å¼€å·¥ç¨‹é˜…è¯»æºç æ‰¾åˆ°<code>objc-os.mm</code>,é€šè¿‡æŸ¥æ‰¾å‡½æ•°è¿è¡Œé¡ºåºå¾—åˆ°<code>_objec_init-&gt;map_images-&gt;map_images_noljock-&gt;_read_images-&gt;remethodizeClass(cls)-&gt;attachCategories(cls, cats, true /*flush caches*/)</code>ï¼Œæœ€ç»ˆè¿›å…¥åˆ°<code>attachCategories</code>å…³é”®å‡½æ•°å†…éƒ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">  &#x2F;&#x2F; Attach method lists and properties and protocols from categories to a class.</span><br><span class="line">&#x2F;&#x2F; Assumes the categories in cats are all loaded and sorted by load order, </span><br><span class="line">&#x2F;&#x2F; oldest categories first.</span><br><span class="line">static void </span><br><span class="line">attachCategories(Class cls, category_list *cats, bool flush_caches)</span><br><span class="line">&#123;</span><br><span class="line">    if (!cats) return;</span><br><span class="line">    if (PrintReplacedMethods) printReplacements(cls, cats);</span><br><span class="line"></span><br><span class="line">    bool isMeta &#x3D; cls-&gt;isMetaClass();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; fixme rearrange to remove these intermediate allocations</span><br><span class="line">&#x2F;&#x2F;æ–¹æ³•æ•°ç»„[[1,2,3],[4,5,6],[7,8,9]]</span><br><span class="line">    method_list_t **mlists &#x3D; (method_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*mlists));</span><br><span class="line">&#x2F;&#x2F;å±æ€§æ•°ç»„</span><br><span class="line">    property_list_t **proplists &#x3D; (property_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*proplists));</span><br><span class="line">&#x2F;&#x2F;åè®®æ•°ç»„</span><br><span class="line">    protocol_list_t **protolists &#x3D; (protocol_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*protolists));</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Count backwards through cats to get newest categories first</span><br><span class="line">    int mcount &#x3D; 0;</span><br><span class="line">    int propcount &#x3D; 0;</span><br><span class="line">    int protocount &#x3D; 0;</span><br><span class="line">    int i &#x3D; cats-&gt;count;</span><br><span class="line">    bool fromBundle &#x3D; NO;</span><br><span class="line">    &#x2F;&#x2F;æœ€åçš„ç¼–è¯‘æ–‡ä»¶æ”¾åˆ°æœ€å‰è¾¹</span><br><span class="line">    while (i--) &#123;</span><br><span class="line">&#x2F;&#x2F;å–å‡ºæŸä¸ªåˆ†ç±»</span><br><span class="line">        auto&amp; entry &#x3D; cats-&gt;list[i];</span><br><span class="line">&#x2F;&#x2F;å–å‡ºåˆ†ç±» çš„ instanceæ–¹æ³•æˆ–è€…classæ–¹æ³•</span><br><span class="line">        method_list_t *mlist &#x3D; entry.cat-&gt;methodsForMeta(isMeta);</span><br><span class="line">        if (mlist) &#123;</span><br><span class="line">            mlists[mcount++] &#x3D; mlist; &#x2F;&#x2F;mlists æ¥å—æ‰€æœ‰åˆ†ç±»æ–¹æ³•</span><br><span class="line">            fromBundle |&#x3D; entry.hi-&gt;isBundle();</span><br><span class="line">        &#125;</span><br><span class="line">&#x2F;&#x2F;proplist æ¥å—æ‰€æœ‰åˆ†ç±»å±æ€§</span><br><span class="line">        property_list_t *proplist &#x3D; </span><br><span class="line">            entry.cat-&gt;propertiesForMeta(isMeta, entry.hi);</span><br><span class="line">        if (proplist) &#123;</span><br><span class="line">            proplists[propcount++] &#x3D; proplist;</span><br><span class="line">        &#125;</span><br><span class="line">&#x2F;&#x2F;proplist æ¥å—æ‰€æœ‰åè®®æ–¹æ³•</span><br><span class="line">        protocol_list_t *protolist &#x3D; entry.cat-&gt;protocols;</span><br><span class="line">        if (protolist) &#123;</span><br><span class="line">            protolists[protocount++] &#x3D; protolist;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#x2F;&#x2F;æ”¶é›†äº†æ‰€æœ‰åè®® åˆ†ç±»æ–¹æ³•</span><br><span class="line">    auto rw &#x3D; cls-&gt;data();</span><br><span class="line"></span><br><span class="line">    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);</span><br><span class="line">&#x2F;&#x2F;è¿½åŠ æ‰€æœ‰åˆ†ç±»æ–¹æ³•</span><br><span class="line">    rw-&gt;methods.attachLists(mlists, mcount);</span><br><span class="line">&#x2F;&#x2F;é‡Šæ”¾æ•°ç»„</span><br><span class="line">    free(mlists);</span><br><span class="line">&#x2F;&#x2F;åˆ·æ–°è¯¥ç±»çš„ç¼“å­˜</span><br><span class="line">    if (flush_caches  &amp;&amp;  mcount &gt; 0) flushCaches(cls);</span><br><span class="line">&#x2F;&#x2F;è¿½åŠ æ‰€æœ‰åˆ†ç±»å±æ€§</span><br><span class="line">    rw-&gt;properties.attachLists(proplists, propcount);</span><br><span class="line">    free(proplists);&#x2F;&#x2F;é‡Šæ”¾æ•°ç»„</span><br><span class="line">&#x2F;&#x2F;è¿½åŠ æ‰€æœ‰åˆ†ç±»åè®®</span><br><span class="line">    rw-&gt;protocols.attachLists(protolists, protocount);</span><br><span class="line">    free(protolists);&#x2F;&#x2F;é‡Šæ”¾æ•°ç»„</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>attachCategories</code>æ˜¯å°†æ‰€æœ‰çš„åˆ†ç±»æ–¹æ³•å’Œåè®®ï¼Œå±æ€§å€’åºæ·»åŠ åˆ°ç±»ä¸­ï¼Œå…·ä½“æ·»åŠ çš„ä¼˜å…ˆçº§æ˜¯æ€ä¹ˆæ“ä½œçš„ï¼Ÿè¿›å…¥åˆ°<code>rw-&gt;protocols.attachLists</code>å†…éƒ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">void attachLists(List* const * addedLists, uint32_t addedCount) &#123;</span><br><span class="line">        if (addedCount &#x3D;&#x3D; 0) return;</span><br><span class="line">        if (hasArray()) &#123;</span><br><span class="line">            &#x2F;&#x2F; many lists -&gt; many lists</span><br><span class="line">            uint32_t oldCount &#x3D; array()-&gt;count;</span><br><span class="line">&#x2F;&#x2F;ä¸€å…±éœ€è¦çš„æ•°é‡</span><br><span class="line">            uint32_t newCount &#x3D; oldCount + addedCount;</span><br><span class="line">&#x2F;&#x2F;åˆ†é…å†…å­˜ å†…å­˜ä¸å¤Ÿç”¨äº†ï¼Œéœ€è¦æ‰©å®¹</span><br><span class="line">            setArray((array_t *)realloc(array(), array_t::byteSize(newCount)));</span><br><span class="line">&#x2F;&#x2F;èµ‹å€¼count</span><br><span class="line">            array()-&gt;count &#x3D; newCount;</span><br><span class="line">&#x2F;&#x2F; array()-&gt;listsï¼šåŸæ¥çš„æ–¹æ³•åˆ—è¡¨å‘åç§»åŠ¨ oldCount * sizeof(array()-&gt;lists[0]ä¸ªé•¿åº¦</span><br><span class="line">            memmove(array()-&gt;lists + addedCount&#x2F;*æŒ‡é’ˆç§»åŠ¨åˆ°æ•°ç»„æœ«å°¾*&#x2F;, array()-&gt;lists&#x2F;*æ•°ç»„*&#x2F;,</span><br><span class="line">                    oldCount * sizeof(array()-&gt;lists[0])&#x2F;*ç§»åŠ¨æ•°æ®çš„å¤§å°*&#x2F;);</span><br><span class="line">&#x2F;&#x2F;ç©ºå‡ºæ¥çš„ å†…å­˜ä½¿ç”¨addedListsæ‹·è´è¿‡å» å¤§å°æ˜¯:addedCount * sizeof(array()-&gt;lists[0])</span><br><span class="line">            memcpy(array()-&gt;lists, addedLists, </span><br><span class="line">                   addedCount * sizeof(array()-&gt;lists[0]));</span><br><span class="line">&#x2F;*</span><br><span class="line">å›¾ç¤ºè®²è§£ï¼š</span><br><span class="line">array()-&gt;lists:A-&gt;B-&gt;C-&gt;D-&gt;E</span><br><span class="line">addedCount:3</span><br><span class="line">addedLists:P-&gt;L-&gt;V</span><br><span class="line">memmoveä¹‹åï¼šnil-&gt;nil-&gt;nil-&gt;A-&gt;B-&gt;C-&gt;D-&gt;E</span><br><span class="line">ç„¶åå†è®²addedListsæ’å…¥åˆ°æ•°ç»„å‰è¾¹,æœ€ç»ˆarray()-&gt;listsçš„å€¼æ˜¯ï¼š</span><br><span class="line">P-&gt;L-&gt;V-&gt;A-&gt;B-&gt;C-&gt;D-&gt;E</span><br><span class="line"> *&#x2F;</span><br><span class="line">        &#125;</span><br><span class="line">        else if (!list  &amp;&amp;  addedCount &#x3D;&#x3D; 1) &#123;</span><br><span class="line">            &#x2F;&#x2F; 0 lists -&gt; 1 list</span><br><span class="line">            list &#x3D; addedLists[0];</span><br><span class="line">        &#125; </span><br><span class="line">        else &#123;</span><br><span class="line">            &#x2F;&#x2F; 1 list -&gt; many lists</span><br><span class="line">            List* oldList &#x3D; list;</span><br><span class="line">            uint32_t oldCount &#x3D; oldList ? 1 : 0;</span><br><span class="line">            uint32_t newCount &#x3D; oldCount + addedCount;</span><br><span class="line">            setArray((array_t *)malloc(array_t::byteSize(newCount)));</span><br><span class="line">            array()-&gt;count &#x3D; newCount;</span><br><span class="line">            if (oldList) array()-&gt;lists[addedCount] &#x3D; oldList;</span><br><span class="line">            memcpy(array()-&gt;lists, addedLists, </span><br><span class="line">                   addedCount * sizeof(array()-&gt;lists[0]));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ï¼š</p><ol><li>é¦–å…ˆé€šè¿‡<code>runtime</code>åŠ è½½æŸä¸ªç±»çš„æ‰€æœ‰Categoryæ•°æ®</li><li>æŠŠæ‰€æœ‰Categoryçš„æ–¹æ³•ï¼Œå±æ€§ï¼Œåè®®æ•°æ®åˆå¹¶åˆ°ä¸€ä¸ªå¤§æ•°ç»„ä¸­ï¼Œåé¢å‚ä¸ç¼–è¯‘çš„æ•°ç»„ä¼šå‡ºç°åœ¨æ•°ç»„å‰è¾¹</li><li>å°†åˆå¹¶åçš„åˆ†ç±»æ•°ç»„(æ–¹æ³•ï¼Œå±æ€§ï¼Œåè®®)æ’å…¥åˆ°ç±»åŸæ¥çš„æ•°æ®çš„å‰é¢ã€‚</li></ol><p>å…·ä½“çš„ç¼–è¯‘é¡ºåºæ˜¯projectæ–‡ä»¶ä¸­-&gt;Build Phases-&gt;Complile Sourcesçš„é¡ºåºã€‚</p><h3 id="è°ƒç”¨é¡ºåº"><a href="#è°ƒç”¨é¡ºåº" class="headerlink" title="è°ƒç”¨é¡ºåº"></a>è°ƒç”¨é¡ºåº</h3><h4 id="loadåŠ è½½é¡ºåº"><a href="#loadåŠ è½½é¡ºåº" class="headerlink" title="+loadåŠ è½½é¡ºåº"></a>+loadåŠ è½½é¡ºåº</h4><p>æ¯ä¸ªç±»å’Œåˆ†ç±»éƒ½ä¼šåŠ è½½çš„æ—¶å€™è°ƒç”¨<code>+load</code>æ–¹æ³•ï¼Œå…·ä½“æ˜¯æ€ä¹ˆè°ƒç”¨å‘¢ï¼Ÿæˆ‘ä»¬æŸ¥çœ‹æºç <code>_objc_init-&gt;load_images-&gt;call_load_methods</code></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">void call_load_methods(void)</span><br><span class="line">&#123;</span><br><span class="line">    static bool loading &#x3D; NO;</span><br><span class="line">    bool more_categories;</span><br><span class="line"></span><br><span class="line">    loadMethodLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Re-entrant calls do nothing; the outermost call will finish the job.</span><br><span class="line">    if (loading) return;</span><br><span class="line">    loading &#x3D; YES;</span><br><span class="line"></span><br><span class="line">    void *pool &#x3D; objc_autoreleasePoolPush();</span><br><span class="line"></span><br><span class="line">    do &#123;</span><br><span class="line">        &#x2F;&#x2F; 1. Repeatedly call class +loads until there aren&#39;t any more</span><br><span class="line">        &#x2F;&#x2F;æ‰§è¡Œclass+loadç›´åˆ°å®Œæˆ</span><br><span class="line">        while (loadable_classes_used &gt; 0) &#123;</span><br><span class="line">            call_class_loads();</span><br><span class="line">        &#125;</span><br><span class="line">&#x2F;&#x2F;æ‰§è¡ŒCategory +load ä¸€æ¬¡</span><br><span class="line">        &#x2F;&#x2F; 2. Call category +loads ONCE</span><br><span class="line">        more_categories &#x3D; call_category_loads();</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 3. Run more +loads if there are classes OR more untried categories</span><br><span class="line">    &#125; while (loadable_classes_used &gt; 0  ||  more_categories);</span><br><span class="line"></span><br><span class="line">    objc_autoreleasePoolPop(pool);</span><br><span class="line"></span><br><span class="line">    loading &#x3D; NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»<code>+load</code>åœ¨<code>Category+load</code>å‰è¾¹æ‰§è¡Œï¼Œå½“ç±»çš„<code>+load</code>æ‰§è¡Œå®Œæ¯•ç„¶åå†å»æ‰§è¡Œ<code>Category+load</code>,è€Œä¸”åªæœ‰ä¸€æ¬¡ã€‚<br>å½“classæœ‰å­ç±»çš„æ—¶å€™åŠ è½½é¡ºåºå‘¢ï¼Ÿå…¶å®æ‰€æœ‰ç±»éƒ½æ˜¯åŸºäº<code>NSObject</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å‡è®¾æŒ‰ç…§ç¼–è¯‘é¡ºåºåŠ è½½<code>Class+load</code>ï¼Œå°±æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯çˆ¶ç±»+loadæ‰§è¡Œçš„æ“ä½œå²‚ä¸æ˜¯åœ¨å­ç±»æ‰§è¡Œçš„æ—¶å€™è¿˜æ²¡æœ‰æ‰§è¡Œå—ï¼Ÿè¿™ä¸ªå‡è®¾æ˜æ˜¾ä¸å¯¹ï¼ŒåŸºç±»<code>+load</code>ä¸­çš„æ“ä½œæ˜¯ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ï¼Œå…¶ä»–å­ç±»æ˜¯æŒ‰ç…§<code>superclass-&gt;class-&gt;sonclass</code>çš„é¡ºåºæ‰§è¡Œçš„ã€‚<br>æŸ¥çœ‹æºç <code>_objc_init-&gt;load_images-&gt;prepare_load_methods((const headerType *)mh)-&gt;schedule_class_load</code>åœ¨<code>objc-runtime-new.mm</code>2856è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;***********************************************************************</span><br><span class="line">* Schedule +load for classes in this image, any un-+load-ed </span><br><span class="line">* superclasses in other images, and any categories in this image.</span><br><span class="line">**********************************************************************&#x2F;</span><br><span class="line">&#x2F;&#x2F; Recursively schedule +load for cls and any un-+load-ed superclasses.</span><br><span class="line">&#x2F;&#x2F; cls must already be connected.</span><br><span class="line">static void schedule_class_load(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    if (!cls) return;</span><br><span class="line">    assert(cls-&gt;isRealized());  &#x2F;&#x2F; _read_images should realize</span><br><span class="line"></span><br><span class="line">    if (cls-&gt;data()-&gt;flags &amp; RW_LOADED) return;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Ensure superclass-first ordering</span><br><span class="line">    &#x2F;&#x2F;é€’å½’è°ƒç”¨è‡ªå·±ç›´åˆ°è°ƒç”¨clas-&gt;self</span><br><span class="line">    schedule_class_load(cls-&gt;superclass);</span><br><span class="line">&#x2F;&#x2F;æ·»åŠ class</span><br><span class="line">    add_class_to_loadable_list(cls);</span><br><span class="line">    cls-&gt;setInfo(RW_LOADED); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥äº†è§£åˆ°è¯¥å‡½æ•°é€’å½’è°ƒç”¨è‡ªå·±ï¼Œç›´åˆ°<code>+load</code>æ–¹æ³•å·²ç»è°ƒç”¨è¿‡ä¸ºæ­¢ï¼Œæ‰€ä»¥ä¸ç®¡ç¼–è¯‘é¡ºåºæ˜¯é«˜ä½ï¼Œ<code>+load</code>çš„åŠ è½½é¡ºåºå§‹ç»ˆæ˜¯<code>NSObject-&gt;FYPrson-&gt;FYStudent</code>ã€‚å¤šä¸ªç±»å¹³è¡Œå…³ç³»çš„è¯ï¼ŒæŒ‰ç…§ç¼–è¯‘é¡ºåºåŠ è½½ã€‚<br>ä¸‹è¾¹æ˜¯ç¨å¾®å¤æ‚ç‚¹çš„ç±»å…³ç³»ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">NSObject</span><br><span class="line">    Person</span><br><span class="line">        Student</span><br><span class="line">NSObjet</span><br><span class="line">    Car</span><br><span class="line">        BigCar</span><br><span class="line">            BigOrSmallCar</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘é¡ºåºæ˜¯</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Person</span><br><span class="line">Student</span><br><span class="line">Car</span><br><span class="line">BigOrSmallCar</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆä»–ä»¬<code>+load</code>çš„åŠ è½½é¡ºåºæ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">NSobject-&gt;Person-&gt;Student-&gt;Car-&gt;BigCar-&gt;BigOrSmallCar</span><br></pre></td></tr></table></figure><p>çœ‹ç€ä¸æ˜¯å¾ˆæ˜ç™½çš„ å¯ä»¥å†çœ‹ä¸€ä¸‹åˆšæ‰çš„<code>schedule_class_load</code>å‡½æ•°ã€‚<br>åŠ è½½æˆåŠŸä¹‹åï¼Œæ˜¯æŒ‰ç…§<code>objc_msgsend()</code>æµç¨‹å‘é€çš„å—ï¼Ÿæˆ‘ä»¬è¿›å…¥åˆ°<code>call_class_loads</code>å†…éƒ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">static void call_class_loads(void)</span><br><span class="line">&#123;</span><br><span class="line">    int i;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; Detach current loadable list.</span><br><span class="line">    struct loadable_class *classes &#x3D; loadable_classes;</span><br><span class="line">    int used &#x3D; loadable_classes_used;</span><br><span class="line">    loadable_classes &#x3D; nil;</span><br><span class="line">    loadable_classes_allocated &#x3D; 0;</span><br><span class="line">    loadable_classes_used &#x3D; 0;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; Call all +loads for the detached list.</span><br><span class="line">    for (i &#x3D; 0; i &lt; used; i++) &#123;</span><br><span class="line">        Class cls &#x3D; classes[i].cls;</span><br><span class="line">        load_method_t load_method &#x3D; (load_method_t)classes[i].method;</span><br><span class="line">        if (!cls) continue; </span><br><span class="line"></span><br><span class="line">        if (PrintLoading) &#123;</span><br><span class="line">            _objc_inform(&quot;LOAD: +[%s load]\n&quot;, cls-&gt;nameForLogging());</span><br><span class="line">        &#125;</span><br><span class="line">        (*load_method)(cls, SEL_load);</span><br><span class="line">    &#125;</span><br><span class="line">    if (classes) free(classes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥æ‰¾åˆ°<code>(*load_method)(cls, SEL_load);</code>è¯¥å‡½æ•°ï¼Œè¯¥å‡½æ•°æ˜¯ç›´æ¥ä½¿ç”¨<code>IMP</code>æ‰§è¡Œçš„ï¼Œ<code>IMP</code>å°±æ˜¯å‡½æ•°åœ°å€ï¼Œå¯ä»¥ç›´æ¥è®¿é—®å‡½æ•°è€Œä¸ç”¨æ¶ˆæ¯çš„è½¬å‘æµç¨‹ã€‚</p><h4 id="initializeè°ƒç”¨"><a href="#initializeè°ƒç”¨" class="headerlink" title="+initializeè°ƒç”¨"></a>+initializeè°ƒç”¨</h4><ul><li>+initializeæ–¹æ³•ä¼šåœ¨ç±»ç¬¬ä¸€æ¬¡æ¥æ”¶åˆ°æ¶ˆæ¯æ—¶è°ƒç”¨</li><li>å…ˆè°ƒç”¨çˆ¶ç±»çš„+initializeï¼Œå†è°ƒç”¨å­ç±»çš„+initialize</li><li>å…ˆåˆå§‹åŒ–çˆ¶ç±»ï¼Œå†åˆå§‹åŒ–å­ç±»ï¼Œæ¯ä¸ªç±»åªä¼šåˆå§‹åŒ–1æ¬¡</li></ul><p><code>objc</code>æºç è§£è¯»è¿‡ç¨‹<code>objc-msg-arm64.x-&gt;objc_msgSend-&gt;objc-&gt;runtime-new-&gt;class_getinstanceMethod-&gt;lookUpImpOrNil-&gt;lookUpImpOrForward-&gt;_clas_initialize-&gt;callInitialize-&gt;objc_msgSend(cls,SEL_Initialize)</code><br>åœ¨<code>runtime-new.h</code>4819è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Method class_getInstanceMethod(Class cls, SEL sel)</span><br><span class="line">&#123;</span><br><span class="line">    if (!cls  ||  !sel) return nil;</span><br><span class="line"></span><br><span class="line">    lookUpImpOrNil(cls, sel, nil, </span><br><span class="line">                   NO&#x2F;*initialize*&#x2F;, NO&#x2F;*cache*&#x2F;, YES&#x2F;*resolver*&#x2F;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return _class_getMethod(cls, sel);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¹æ®<code>lookUpImpOrNil</code>æŸ¥çœ‹4916è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">IMP lookUpImpOrForward(Class cls, SEL sel, id inst, </span><br><span class="line">                       bool initialize, bool cache, bool resolver)</span><br><span class="line">&#123;</span><br><span class="line">    IMP imp &#x3D; nil;</span><br><span class="line">    bool triedResolver &#x3D; NO;</span><br><span class="line"></span><br><span class="line">    runtimeLock.assertUnlocked();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Optimistic cache lookup</span><br><span class="line">    if (cache) &#123;</span><br><span class="line">        imp &#x3D; cache_getImp(cls, sel);</span><br><span class="line">        if (imp) return imp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    runtimeLock.lock();</span><br><span class="line">    checkIsKnownClass(cls);</span><br><span class="line"></span><br><span class="line">    if (!cls-&gt;isRealized()) &#123;</span><br><span class="line">        realizeClass(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (initialize  &amp;&amp;  !cls-&gt;isInitialized()) &#123;</span><br><span class="line">        runtimeLock.unlock();</span><br><span class="line">        _class_initialize (_class_getNonMetaClass(cls, inst));</span><br><span class="line">        runtimeLock.lock();</span><br><span class="line">      &#x2F;&#x2F;å½“ç¬¬ä¸€æ¬¡æ”¶åˆ°æ¶ˆæ¯ï¼Œclsæ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™è°ƒç”¨_class_initializeè¿›è¡Œåˆå§‹åŒ–</span><br><span class="line">      &#125;</span><br><span class="line"> retry:    </span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line">    imp &#x3D; cache_getImp(cls, sel);</span><br><span class="line">    if (imp) goto done;</span><br><span class="line">   &#x2F;&#x2F; Try this class&#39;s method lists.</span><br><span class="line">    &#x2F;&#x2F;åœ¨æœ¬ç±»ä¸­æŸ¥æ‰¾method</span><br><span class="line">    &#123;</span><br><span class="line">        Method meth &#x3D; getMethodNoSuper_nolock(cls, sel);</span><br><span class="line">        if (meth) &#123;</span><br><span class="line">            log_and_fill_cache(cls, meth-&gt;imp, sel, inst, cls);</span><br><span class="line">            imp &#x3D; meth-&gt;imp;</span><br><span class="line">            goto done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Try superclass caches and method lists.</span><br><span class="line">    &#123;</span><br><span class="line">        unsigned attempts &#x3D; unreasonableClassCount();</span><br><span class="line">        for (Class curClass &#x3D; cls-&gt;superclass;</span><br><span class="line">             curClass !&#x3D; nil;</span><br><span class="line">             curClass &#x3D; curClass-&gt;superclass)</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; Halt if there is a cycle in the superclass chain.</span><br><span class="line">            if (--attempts &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                _objc_fatal(&quot;Memory corruption in class list.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; Superclass cache.</span><br><span class="line">            imp &#x3D; cache_getImp(curClass, sel);</span><br><span class="line">            if (imp) &#123;</span><br><span class="line">                if (imp !&#x3D; (IMP)_objc_msgForward_impcache) &#123;</span><br><span class="line">                    &#x2F;&#x2F; Found the method in a superclass. Cache it in this class.</span><br><span class="line">                    log_and_fill_cache(cls, imp, sel, inst, curClass);</span><br><span class="line">                    goto done;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    &#x2F;&#x2F; Found a forward:: entry in a superclass.</span><br><span class="line">                    &#x2F;&#x2F; Stop searching, but don&#39;t cache yet; call method </span><br><span class="line">                    &#x2F;&#x2F; resolver for this class first.</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            &#x2F;&#x2F; Superclass method list.</span><br><span class="line">            Method meth &#x3D; getMethodNoSuper_nolock(curClass, sel);</span><br><span class="line">            if (meth) &#123;</span><br><span class="line">                log_and_fill_cache(cls, meth-&gt;imp, sel, inst, curClass);</span><br><span class="line">                imp &#x3D; meth-&gt;imp;</span><br><span class="line">                goto done;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; No implementation found. Try method resolver once.</span><br><span class="line"></span><br><span class="line">    if (resolver  &amp;&amp;  !triedResolver) &#123;</span><br><span class="line">        runtimeLock.unlock();</span><br><span class="line">        _class_resolveMethod(cls, sel, inst);</span><br><span class="line">        runtimeLock.lock();</span><br><span class="line">        &#x2F;&#x2F; Don&#39;t cache the result; we don&#39;t hold the lock so it may have </span><br><span class="line">        &#x2F;&#x2F; changed already. Re-do the search from scratch instead.</span><br><span class="line">        triedResolver &#x3D; YES;</span><br><span class="line">        goto retry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; No implementation found, and method resolver didn&#39;t help. </span><br><span class="line">    &#x2F;&#x2F; Use forwarding.</span><br><span class="line"></span><br><span class="line">    imp &#x3D; (IMP)_objc_msgForward_impcache;</span><br><span class="line">    cache_fill(cls, sel, imp, inst);</span><br><span class="line"></span><br><span class="line"> done:</span><br><span class="line">    runtimeLock.unlock();</span><br><span class="line"></span><br><span class="line">    return imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç¬¬ä¸€æ¬¡æ”¶åˆ°æ¶ˆæ¯ï¼Œclsæ²¡æœ‰åˆå§‹åŒ–ï¼Œåˆ™è°ƒç”¨<code>_class_initialize</code>è¿›è¡Œåˆå§‹åŒ–<br>æˆ‘ä»¬è¿›å…¥åˆ°<code>_class_initialize</code>å†…éƒ¨<code>objc-initialize.mm</code>484è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">void _class_initialize(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    assert(!cls-&gt;isMetaClass());</span><br><span class="line"></span><br><span class="line">    Class supercls;</span><br><span class="line">    bool reallyInitialize &#x3D; NO;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Make sure super is done initializing BEFORE beginning to initialize cls.</span><br><span class="line">    &#x2F;&#x2F; See note about deadlock above.</span><br><span class="line">    &#x2F;&#x2F;é€’å½’è°ƒç”¨çˆ¶ç±»æ˜¯å¦æœ‰åˆå§‹åŒ–å’Œæ˜¯å¦æœ‰çˆ¶ç±»</span><br><span class="line">    supercls &#x3D; cls-&gt;superclass;</span><br><span class="line">    if (supercls  &amp;&amp;  !supercls-&gt;isInitialized()) &#123;</span><br><span class="line">        _class_initialize(supercls);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; Try to atomically set CLS_INITIALIZING.</span><br><span class="line">    &#123;</span><br><span class="line">        monitor_locker_t lock(classInitLock);</span><br><span class="line">        if (!cls-&gt;isInitialized() &amp;&amp; !cls-&gt;isInitializing()) &#123;</span><br><span class="line">            cls-&gt;setInitializing();</span><br><span class="line">            reallyInitialize &#x3D; YES;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (reallyInitialize) &#123;</span><br><span class="line">        &#x2F;&#x2F; We successfully set the CLS_INITIALIZING bit. Initialize the class.</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; Record that we&#39;re initializing this class so we can message it.</span><br><span class="line">        _setThisThreadIsInitializingClass(cls);</span><br><span class="line"></span><br><span class="line">        if (MultithreadedForkChild) &#123;</span><br><span class="line">            &#x2F;&#x2F; LOL JK we don&#39;t really call +initialize methods after fork().</span><br><span class="line">            performForkChildInitialize(cls, supercls);</span><br><span class="line">            return;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; Send the +initialize message.</span><br><span class="line">        &#x2F;&#x2F; Note that +initialize is sent to the superclass (again) if </span><br><span class="line">        &#x2F;&#x2F; this class doesn&#39;t implement +initialize. 2157218</span><br><span class="line">        if (PrintInitializing) &#123;</span><br><span class="line">            _objc_inform(&quot;INITIALIZE: thread %p: calling +[%s initialize]&quot;,</span><br><span class="line">                         pthread_self(), cls-&gt;nameForLogging());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; Exceptions: A +initialize call that throws an exception </span><br><span class="line">        &#x2F;&#x2F; is deemed to be a complete and successful +initialize.</span><br><span class="line">        &#x2F;&#x2F;</span><br><span class="line">        &#x2F;&#x2F; Only __OBJC2__ adds these handlers. !__OBJC2__ has a</span><br><span class="line">        &#x2F;&#x2F; bootstrapping problem of this versus CF&#39;s call to</span><br><span class="line">        &#x2F;&#x2F; objc_exception_set_functions().</span><br><span class="line">#if __OBJC2__</span><br><span class="line">        @try</span><br><span class="line">#endif</span><br><span class="line">        &#123;</span><br><span class="line">            callInitialize(cls);</span><br><span class="line"></span><br><span class="line">            if (PrintInitializing) &#123;</span><br><span class="line">                _objc_inform(&quot;INITIALIZE: thread %p: finished +[%s initialize]&quot;,</span><br><span class="line">                             pthread_self(), cls-&gt;nameForLogging());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">#if __OBJC2__</span><br><span class="line">        @catch (...) &#123;</span><br><span class="line">            if (PrintInitializing) &#123;</span><br><span class="line">                _objc_inform(&quot;INITIALIZE: thread %p: +[%s initialize] &quot;</span><br><span class="line">                             &quot;threw an exception&quot;,</span><br><span class="line">                             pthread_self(), cls-&gt;nameForLogging());</span><br><span class="line">            &#125;</span><br><span class="line">            @throw;</span><br><span class="line">        &#125;</span><br><span class="line">        @finally</span><br><span class="line">#endif</span><br><span class="line">        &#123;</span><br><span class="line">            &#x2F;&#x2F; Done initializing.</span><br><span class="line">            lockAndFinishInitializing(cls, supercls);</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    else if (cls-&gt;isInitializing()) &#123;</span><br><span class="line">        &#x2F;&#x2F; We couldn&#39;t set INITIALIZING because INITIALIZING was already set.</span><br><span class="line">        &#x2F;&#x2F; If this thread set it earlier, continue normally.</span><br><span class="line">        &#x2F;&#x2F; If some other thread set it, block until initialize is done.</span><br><span class="line">        &#x2F;&#x2F; It&#39;s ok if INITIALIZING changes to INITIALIZED while we&#39;re here, </span><br><span class="line">        &#x2F;&#x2F;   because we safely check for INITIALIZED inside the lock </span><br><span class="line">        &#x2F;&#x2F;   before blocking.</span><br><span class="line">        if (_thisThreadIsInitializingClass(cls)) &#123;</span><br><span class="line">            return;</span><br><span class="line">        &#125; else if (!MultithreadedForkChild) &#123;</span><br><span class="line">            waitForInitializeToComplete(cls);</span><br><span class="line">            return;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; We&#39;re on the child side of fork(), facing a class that</span><br><span class="line">            &#x2F;&#x2F; was initializing by some other thread when fork() was called.</span><br><span class="line">            _setThisThreadIsInitializingClass(cls);</span><br><span class="line">            performForkChildInitialize(cls, supercls);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    else if (cls-&gt;isInitialized()) &#123;</span><br><span class="line">        &#x2F;&#x2F; Set CLS_INITIALIZING failed because someone else already </span><br><span class="line">        &#x2F;&#x2F;   initialized the class. Continue normally.</span><br><span class="line">        &#x2F;&#x2F; NOTE this check must come AFTER the ISINITIALIZING case.</span><br><span class="line">        &#x2F;&#x2F; Otherwise: Another thread is initializing this class. ISINITIALIZED </span><br><span class="line">        &#x2F;&#x2F;   is false. Skip this clause. Then the other thread finishes </span><br><span class="line">        &#x2F;&#x2F;   initialization and sets INITIALIZING&#x3D;no and INITIALIZED&#x3D;yes. </span><br><span class="line">        &#x2F;&#x2F;   Skip the ISINITIALIZING clause. Die horribly.</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    else &#123;</span><br><span class="line">        &#x2F;&#x2F; We shouldn&#39;t be here. </span><br><span class="line">        _objc_fatal(&quot;thread-safe class init in objc runtime is buggy!&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ï¼Œå’Œ<code>+load</code>æ–¹æ³•ä¸€æ ·ï¼Œå…ˆçˆ¶ç±»åå­ç±»ã€‚ç„¶åèµ‹å€¼<code>reallyInitialize = YES;</code>ï¼Œåè¾¹ä½¿ç”¨<code>try</code>ä¸»åŠ¨è°ƒç”¨<code>callInitialize(cls);</code>ï¼Œæ¥åˆ°<code>callInitialize(cls);</code>å†…éƒ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void callInitialize(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    ((void(*)(Class, SEL))objc_msgSend)(cls, SEL_initialize);</span><br><span class="line">    asm(&quot;&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°æœ€ç»ˆè¿˜æ˜¯ä½¿ç”¨<code>((void(*)(Class, SEL))objc_msgSend)(cls, SEL_initialize)</code>ä¸»åŠ¨è°ƒç”¨äº†è¯¥å‡½æ•°ã€‚</p><h3 id="åŒºåˆ«"><a href="#åŒºåˆ«" class="headerlink" title="åŒºåˆ«"></a>åŒºåˆ«</h3><p><code>+initialize</code>å’Œ<code>+load</code>çš„å¾ˆå¤§åŒºåˆ«æ˜¯ï¼Œ<code>+initialize</code>æ˜¯é€šè¿‡<code>objc_msgSend</code>è¿›è¡Œè°ƒç”¨çš„ï¼Œæ‰€ä»¥æœ‰ä»¥ä¸‹ç‰¹ç‚¹<br>å¦‚æœå­ç±»æ²¡æœ‰å®ç°<code>+initialize</code>ï¼Œä¼šè°ƒç”¨çˆ¶ç±»çš„<code>+initialize</code>ï¼ˆæ‰€ä»¥çˆ¶ç±»çš„<code>+initialize</code>å¯èƒ½ä¼šè¢«è°ƒç”¨å¤šæ¬¡ï¼‰<br>å¦‚æœåˆ†ç±»å®ç°äº†<code>+initialize</code>ï¼Œå°±è¦†ç›–ç±»æœ¬èº«çš„<code>+initialize</code>è°ƒç”¨</p><p>ç”¨ä¼ªä»£ç å®ç°ä»¥ä¸‹æ€è·¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if(class æ²¡æœ‰åˆå§‹åŒ–)&#123;</span><br><span class="line">    çˆ¶ç±»åˆå§‹åŒ–</span><br><span class="line">    å­ç±»åˆå§‹åŒ–</span><br><span class="line">    è°ƒç”¨initialize</span><br><span class="line">&#125;</span><br><span class="line">å¦‚æœå­ç±»æ²¡æœ‰å®ç°initializeï¼Œåˆ™å»è°ƒç”¨çˆ¶ç±»initializeã€‚</span><br></pre></td></tr></table></figure><p>è‡³äºå­ç±»æ²¡æœ‰å®ç°çš„è¯æ˜¯ç›´æ¥è°ƒç”¨çˆ¶ç±»çš„<code>initialize</code>ï¼Œæ˜¯ä½¿ç”¨<code>objc-msgsend</code>çš„åŸå› ã€‚</p><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line">+(void)initialize&#123;</span><br><span class="line">printf(&quot;\n%s&quot;,__func__);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">+(void)load&#123;</span><br><span class="line">printf(&quot;\n%s&quot;,__func__);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">@interface FYPerson (test1)</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">+(void)initialize&#123;</span><br><span class="line">printf(&quot;\n%s&quot;,__func__);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">+(void)load&#123;</span><br><span class="line">printf(&quot;\n%s&quot;,__func__);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;è¾“å‡º</span><br><span class="line">+[FYPerson load]</span><br><span class="line">+[FYPerson(test2) load]</span><br><span class="line">+[FYPerson(test1) load]</span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li><code>+load</code>æ˜¯æ ¹æ®å‡½æ•°åœ°å€ç›´æ¥è°ƒç”¨ï¼Œ<code>initialize</code>æ˜¯é€šè¿‡<code>objc_msgSend</code>è°ƒç”¨</li><li><code>+load</code>æ˜¯runtimeåŠ è½½ç±»ã€åˆ†ç±»æ—¶å€™è°ƒç”¨ï¼ˆåªä¼šè°ƒç”¨ä¸€æ¬¡ï¼‰</li><li><code>initialize</code>æ˜¯ç¬¬ä¸€æ¬¡æ¥å—æ¶ˆæ¯çš„æ—¶å€™è°ƒç”¨ï¼Œæ¯ä¸ªç±»åªä¼šè°ƒç”¨ä¸€æ¬¡ï¼ˆå­ç±»æ²¡å®ç°ï¼Œçˆ¶ç±»å¯èƒ½è¢«è°ƒç”¨å¤šæ¬¡ï¼‰</li><li><code>+load</code>è°ƒç”¨ä¼˜å…ˆäº<code>initialize</code>,å­ç±»è°ƒç”¨<code>+load</code>ä¹‹å‰ä¼šè°ƒç”¨çˆ¶ç±»çš„<code>+load</code>ï¼Œå†è°ƒç”¨åˆ†ç±»çš„<code>+load</code>,åˆ†ç±»ä¹‹é—´å…ˆç¼–è¯‘ï¼Œå…ˆè°ƒç”¨ã€‚</li><li><code>initialize</code>å…ˆåˆå§‹åŒ–çˆ¶ç±»ï¼Œå†åˆå§‹åŒ–å­ç±»ï¼ˆå¯èƒ½æœ€ç»ˆè°ƒç”¨çˆ¶ç±»çš„<code>initialize</code>ï¼‰</li></ul><h3 id="å…³è”å¯¹è±¡æœ¬è´¨"><a href="#å…³è”å¯¹è±¡æœ¬è´¨" class="headerlink" title="å…³è”å¯¹è±¡æœ¬è´¨"></a>å…³è”å¯¹è±¡æœ¬è´¨</h3><h4 id="å…³è”å¯¹è±¡çš„æœ¬è´¨-ç»“æ„ä½“"><a href="#å…³è”å¯¹è±¡çš„æœ¬è´¨-ç»“æ„ä½“" class="headerlink" title="å…³è”å¯¹è±¡çš„æœ¬è´¨-ç»“æ„ä½“"></a>å…³è”å¯¹è±¡çš„æœ¬è´¨-ç»“æ„ä½“</h4><p>ç»§æ‰¿<code>NSObject</code>æ˜¯å¯ä»¥å¯ä»¥ç›´æ¥ä½¿ç”¨<code>@property (nonatomic,assign) int age;</code>ï¼Œä½†æ˜¯åœ¨<code>Category</code>ä¸­ä¼šæŠ¥é”™ï¼Œé‚£ä¹ˆæ€ä¹ˆå®ç°å’Œç»§æ‰¿åŸºç±»ä¸€æ ·çš„æ•ˆæœå‘¢ï¼Ÿ<br>æˆ‘ä»¬æŸ¥çœ‹<code>Category</code>ç»“æ„ä½“</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">  struct _category_t &#123;</span><br><span class="line">const char *name; &#x2F;&#x2F;&quot;FYPerson&quot;</span><br><span class="line">struct _class_t *cls;</span><br><span class="line">const struct _method_list_t *instance_methods;</span><br><span class="line">const struct _method_list_t *class_methods;</span><br><span class="line">const struct _protocol_list_t *protocols;</span><br><span class="line">const struct _prop_list_t *properties;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>const struct _prop_list_t *properties;</code>æ˜¯å­˜å‚¨å±æ€§çš„ï¼Œä½†æ˜¯ç¼ºå°‘æˆå‘˜å˜é‡ï¼Œè€Œæˆ‘ä»¬ä¹Ÿä¸èƒ½ä¸»åŠ¨åœ¨<code>_category_t</code>æ’å…¥<code>ivar</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨<code>objc_setAssociatedObject</code>å°†å±æ€§çš„å€¼å­˜å‚¨å…¨å±€çš„<code>AssociationsHashMap</code>ä¸­ï¼Œä½¿ç”¨çš„æ—¶å€™<code>objc_getAssociatedObject(id object, const void *key)</code>,ä¸ä½¿ç”¨çš„æ—¶å€™åˆ é™¤ä½¿ç”¨<code>objc_removeAssociatedObjects</code>åˆ é™¤ã€‚</p><p>æˆ‘ä»¬è¿›å…¥åˆ°<code>objc_setAssociatedObject</code>å†…éƒ¨,<code>objc-references.mm</code>275è¡Œ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">void _object_set_associative_reference(id object, void *key, id value, uintptr_t policy) &#123;</span><br><span class="line">    &#x2F;&#x2F; retain the new value (if any) outside the lock.</span><br><span class="line">    ObjcAssociation old_association(0, nil);</span><br><span class="line">&#x2F;&#x2F;æ ¹æ®key value å¤„ç†</span><br><span class="line">    id new_value &#x3D; value ? acquireValue(value, policy) : nil;</span><br><span class="line">    &#123;</span><br><span class="line">        AssociationsManager manager;</span><br><span class="line">&#x2F;&#x2F;ç”Ÿæˆä¸€ä¸ªå…¨å±€çš„ HashMap</span><br><span class="line">        AssociationsHashMap &amp;associations(manager.associations());</span><br><span class="line">        disguised_ptr_t disguised_object &#x3D; DISGUISE(object);</span><br><span class="line">&#x2F;&#x2F;æœ‰value å°±å¤„ç†</span><br><span class="line">        if (new_value) &#123;</span><br><span class="line">            &#x2F;&#x2F; break any existing association.</span><br><span class="line">&#x2F;&#x2F;éå† hashMapæ˜¯å¦æœ‰è¯¥obj</span><br><span class="line">            AssociationsHashMap::iterator i &#x3D; associations.find(disguised_object);</span><br><span class="line">            if (i !&#x3D; associations.end()) &#123;</span><br><span class="line">                &#x2F;&#x2F; secondary table exists</span><br><span class="line">&#x2F;&#x2F;æœ‰çš„è¯ æ›´æ–°å…¶ value</span><br><span class="line">                ObjectAssociationMap *refs &#x3D; i-&gt;second;</span><br><span class="line">                ObjectAssociationMap::iterator j &#x3D; refs-&gt;find(key);</span><br><span class="line">                if (j !&#x3D; refs-&gt;end()) &#123;</span><br><span class="line">                    old_association &#x3D; j-&gt;second;</span><br><span class="line">                    j-&gt;second &#x3D; ObjcAssociation(policy, new_value);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    (*refs)[key] &#x3D; ObjcAssociation(policy, new_value);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                &#x2F;&#x2F; create the new association (first time).</span><br><span class="line">&#x2F;&#x2F;æ²¡æœ‰çš„è¯ èµ‹å€¼ç»™ refs</span><br><span class="line">                ObjectAssociationMap *refs &#x3D; new ObjectAssociationMap;</span><br><span class="line">                associations[disguised_object] &#x3D; refs;</span><br><span class="line">                (*refs)[key] &#x3D; ObjcAssociation(policy, new_value);</span><br><span class="line">                object-&gt;setHasAssociatedObjects();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            &#x2F;&#x2F; setting the association to nil breaks the association.</span><br><span class="line">            AssociationsHashMap::iterator i &#x3D; associations.find(disguised_object);</span><br><span class="line">            if (i !&#x3D;  associations.end()) &#123;</span><br><span class="line">                ObjectAssociationMap *refs &#x3D; i-&gt;second;</span><br><span class="line">                ObjectAssociationMap::iterator j &#x3D; refs-&gt;find(key);</span><br><span class="line">                if (j !&#x3D; refs-&gt;end()) &#123;</span><br><span class="line">                    old_association &#x3D; j-&gt;second;</span><br><span class="line">                    &#x2F;&#x2F;åˆ é™¤refs </span><br><span class="line">                    refs-&gt;erase(j);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; release the old value (outside of the lock).</span><br><span class="line">    if (old_association.hasValue()) ReleaseValue()(old_association);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¯¥å‡½æ•°æˆ‘ä»¬äº†è§£åˆ°</p><ul><li>å…³è”å¯¹è±¡å¹¶ä¸æ˜¯å­˜å‚¨åœ¨å…³è”å¯¹è±¡çš„æœ¬èº«å†…å­˜ä¸­</li><li>å…³è”å¯¹è±¡æ˜¯å­˜å‚¨åœ¨å…¨å±€ç»Ÿä¸€çš„<code>AssociationsManager</code>ç®¡ç†çš„<code>AssociationsHashMap</code>ä¸­</li><li>ä¼ å…¥value =nilï¼Œä¼šç§»é™¤è¯¥å…³è”å¯¹çº¿<br><code>AssociationsManager</code>å…¶å®æ˜¯ç®¡ç†äº†å·²<code>keyä¸ºid object</code>å¯¹åº”çš„<code>AssociationsHashMap</code>ï¼Œ<code>AssociationsHashMap</code>å­˜å‚¨äº†<code>key</code>å¯¹åº”çš„<code>ObjcAssociation</code>ï¼Œ<code>ObjcAssociation</code>æ˜¯å­˜å‚¨äº†<code>value</code> å’Œ<code>policy</code>ï¼Œ<code>ObjcAssociation</code>çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class ObjcAssociation &#123;</span><br><span class="line">        uintptr_t _policy;</span><br><span class="line">        id _value;</span><br><span class="line">        *****</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“æŠ½è±¡å…³ç³»è§ä¸‹å›¾</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AssociationsManager --&gt; AssociationsHashMap --&gt; ObjectAssociationMap</span><br><span class="line">--&gt;void * ObjectAssociation --&gt;uintprt_t _policy ,id _value;</span><br></pre></td></tr></table></figure><p>ç®€å•æ¥è®²å°±æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ä¿å­˜äº†ä»¥<code>class</code>ä¸º<code>key</code>å¯¹åº”çš„<code>AssociationsHashMap</code>ï¼Œè¿™ä¸ª<code>AssociationsHashMap</code>å­˜å‚¨äº†ä¸€ä¸ª<code>key</code>å¯¹åº”çš„<code>ObjectAssociation</code>ï¼Œ<code>ObjectAssociation</code>åŒ…å«äº†<code>value</code>å’Œ<code>_policy</code>ã€‚é€šè¿‡2å±‚mapä¿å­˜äº†æ•°æ®ã€‚</p><h4 id="å…³è”å¯¹è±¡çš„ä½¿ç”¨"><a href="#å…³è”å¯¹è±¡çš„ä½¿ç”¨" class="headerlink" title="å…³è”å¯¹è±¡çš„ä½¿ç”¨"></a>å…³è”å¯¹è±¡çš„ä½¿ç”¨</h4><table><thead><tr><th>objc_setAssociatedObject</th><th>obj,key,value,policy</th></tr></thead><tbody><tr><td>objc_getAssociatedObject</td><td>æ ¹æ® obj å’Œ keyè·å–å€¼</td></tr><tr><td>void objc_removeAssociatedObjects(id object)</td><td>æ ¹æ®obj åˆ é™¤å…³è”å‡½æ•°</td></tr></tbody></table><p><code>objc_AssociationPolicy</code>çš„ç±»å‹ï¼š</p><table><thead><tr><th>OBJC_ASSOCIATION_ASSIGN</th><th>weak å¼•ç”¨</th></tr></thead><tbody><tr><td>OBJC_ASSOCIATION_RETAIN_NONATOMIC</td><td>éåŸå­å¼ºå¼•ç”¨</td></tr><tr><td>OBJC_ASSOCIATION_COPY_NONATOMIC</td><td>éåŸå­ç›¸å½“äºcopy</td></tr><tr><td>OBJC_ASSOCIATION_RETAIN</td><td>å¼ºå¼•ç”¨</td></tr><tr><td>OBJC_ASSOCIATION_COPY</td><td>åŸå­æ“ä½œï¼Œç›¸å½“äºcopy</td></tr></tbody></table><h4 id="ä»£ç ç¤ºä¾‹"><a href="#ä»£ç ç¤ºä¾‹" class="headerlink" title="ä»£ç ç¤ºä¾‹"></a>ä»£ç ç¤ºä¾‹</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">@interface NSObject (test)</span><br><span class="line">@property (nonatomic,assign) NSString * name;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">#import &quot;NSObject+test.h&quot;</span><br><span class="line">#import &quot;objc&#x2F;runtime.h&quot;</span><br><span class="line">@implementation NSObject (test)</span><br><span class="line">-(void)setName:(NSString *)name&#123;</span><br><span class="line">objc_setAssociatedObject(self, @selector(name), name, OBJC_ASSOCIATION_COPY);</span><br><span class="line">&#125;</span><br><span class="line">- (NSString *)name&#123;</span><br><span class="line">return  objc_getAssociatedObject(self, @selector(name));</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NSObject *obj &#x3D;[[NSObject alloc]init];</span><br><span class="line">obj.name &#x3D; @&quot;è€å¼Ÿæ¥äº†&quot;;</span><br><span class="line">printf(&quot;%s&quot;,obj.name.UTF8String);</span><br><span class="line">&#x2F;&#x2F;è€å¼Ÿæ¥äº†</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æˆ‘ä»¬å®ç°äº†ç»™åŸºç±»æ·»åŠ ä¸€ä¸ªæˆå‘˜å˜é‡<code>name</code>ï¼Œç„¶ååˆæˆåŠŸå–å‡ºäº†å€¼ï¼Œæ ‡ç¤ºæˆ‘ä»¬åšæ–°å¢çš„ä¿å­˜æˆå‘˜å˜é‡çš„å€¼æ˜¯å¯¹çš„ã€‚</p><h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>Category <code>+load</code>åœ¨å†·å¯åŠ¨æ—¶å€™æ‰§è¡Œï¼Œæ‰§è¡Œé¡ºåºå’Œç¼–è¯‘é¡ºåºæˆå¼±ç›¸å…³ï¼Œå…ˆçˆ¶ç±»ï¼Œåå­ç±»ï¼Œè€Œä¸”æ¯ä¸ªç±»æ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡Œæ˜¯ç›´æ¥è°ƒç”¨å‡½æ•°åœ°å€ã€‚</li><li>Category <code>+initialize</code>åœ¨ç¬¬ä¸€æ¬¡æ¥å—æ¶ˆæ¯æ‰§è¡Œï¼Œå…ˆçˆ¶ç±»ï¼Œåå­ç±»ï¼Œå­ç±»æ²¡å®ç°ï¼Œä¼šè°ƒç”¨çˆ¶ç±»ï¼Œåˆ©ç”¨<code>objc-msgsend</code>æœºåˆ¶è°ƒç”¨ã€‚</li><li>Category å¯ä»¥åˆ©ç”¨<code>Associative</code>æ·»åŠ å’Œè¯»å–å±æ€§çš„å€¼</li></ul><h4 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h4><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code<i class="fa fa-external-link"></i></span></li><li><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQy9vYmpjNC03NTA=" title="https://github.com/ifgyong/demo/tree/master/OC/objc4-750">runtimeå¯è¿è¡Œçš„æºç <i class="fa fa-external-link"></i></span></p><p>æœ¬æ–‡ç« ä¹‹æ‰€ä»¥å›¾ç‰‡æ¯”è¾ƒå°‘ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯è·Ÿç€ä»£ç æ•²ä¸€éï¼Œå°è±¡æ¯”è¾ƒæ·±åˆ»ã€‚</p><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p><p>å¹¿å‘Šæ—¶é—´</p></li></ul><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt; ä»Šå¤©æˆ‘ä»¬å†çœ‹ä¸€ä¸‹&lt;code&gt;Category&lt;/code&gt;çš„åº•å±‚åŸç†ã€‚&lt;br&gt; å…ˆçœ‹ä¸€ä¸‹&lt;code&gt;Category&lt;/code&gt;çš„ç®€å•ä½¿ç”¨ï¼Œé¦–å…ˆæ–°å¢ä¸€ä¸ªç±»çš„&lt;code&gt;Category&lt;/code&gt;ï¼Œç„¶åæ·»åŠ éœ€è¦çš„å‡½æ•°ï¼Œç„¶ååœ¨ä½¿ç”¨çš„æ–‡ä»¶ä¸­å¯¼å…¥å°±å¯ä»¥ç›´æ¥ä½¿ç”¨äº†ã€‚ä»£ç å¦‚ä¸‹:
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç†  KVOå’ŒKVCæœ¬è´¨ä¸è”ç³» --(3)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20KVO%E5%92%8CKVC%E6%9C%AC%E8%B4%A8%E4%B8%8E%E8%81%94%E7%B3%BB%20--(3)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20KVO%E5%92%8CKVC%E6%9C%AC%E8%B4%A8%E4%B8%8E%E8%81%94%E7%B3%BB%20--(3)/</id>
    <published>2019-12-01T03:13:58.000Z</published>
    <updated>2020-09-04T04:40:21.657Z</updated>
    
    <content type="html"><![CDATA[<p>æˆ‘ä»¬çŸ¥é“å®ä¾‹å®é™…æ˜¯å­˜å‚¨äº†æˆå‘˜å˜é‡çš„å€¼å’ŒæŒ‡å‘ç±»çš„<code>isa</code>æŒ‡é’ˆï¼Œ<code>class</code>å¯¹è±¡å’Œ<code>meta-class</code>å¯¹è±¡åŒ…å« <code>isa</code>ã€<code>superclass</code>å’Œ<code>class_rw_t</code>è¿™å‡ ç§ç»“æ„ä½“ï¼Œåªæ˜¯æ•°æ®ä¸ä¸€æ ·ï¼Œ<code>isa</code>éœ€è¦<code>ISA_MASK</code>&amp;ä¹‹åæ‰æ˜¯çœŸæ­£çš„å€¼ã€‚é‚£ä¹ˆä»Šå¤©æˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹Key-Value Observingçš„æœ¬è´¨ã€‚</p><h3 id="KVOæœ¬è´¨"><a href="#KVOæœ¬è´¨" class="headerlink" title="KVOæœ¬è´¨"></a>KVOæœ¬è´¨</h3><p> é¦–å…ˆéœ€è¦äº†è§£KVOåŸºæœ¬ä½¿ç”¨ï¼ŒKVOçš„å…¨ç§° Key-Value Observingï¼Œä¿—ç§°â€œé”®å€¼ç›‘å¬â€ï¼Œå¯ä»¥ç”¨äºç›‘å¬æŸä¸ªå¯¹è±¡å±æ€§å€¼çš„æ”¹å˜ã€‚ä¸‹é¢æˆ‘ä»¬å±•ç¤ºä¸€ä¸‹KVOçš„åŸºæœ¬ä½¿ç”¨ã€‚</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"> </span><br><span class="line"> #import &lt;Foundation&#x2F;Foundation.h&gt;</span><br><span class="line"></span><br><span class="line">NS_ASSUME_NONNULL_BEGIN</span><br><span class="line"></span><br><span class="line">@interface FYPerson : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic,assign) NSInteger age;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">NS_ASSUME_NONNULL_END</span><br><span class="line"></span><br><span class="line">#import &quot;ViewController.h&quot;</span><br><span class="line">#import &quot;FYPerson.h&quot;</span><br><span class="line"></span><br><span class="line">@interface ViewController ()</span><br><span class="line">@property (nonatomic,strong)FYPerson *person;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">[super viewDidLoad];</span><br><span class="line">&#x2F;&#x2F; Do any additional setup after loading the view.</span><br><span class="line">self.person&#x3D;[FYPerson new];</span><br><span class="line">self.person.age &#x3D; 10;</span><br><span class="line">[self.person addObserver:self</span><br><span class="line">      forKeyPath:@&quot;age&quot;</span><br><span class="line">     options:NSKeyValueObservingOptionNew</span><br><span class="line">     context:nil];</span><br><span class="line">&#125;</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">self.person.age +&#x3D; 1;</span><br><span class="line">&#125;</span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context&#123;</span><br><span class="line">NSLog(@&quot;ç›‘å¬åˆ°äº†ageå˜åŒ–ï¼š %@&quot;,change);</span><br><span class="line">&#125;</span><br><span class="line">-(void)dealloc&#123;</span><br><span class="line">[self.person removeObserver:self forKeyPath:@&quot;age&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ä¸‹è¾¹æ˜¯è¾“å‡ºç»“æœ</span><br><span class="line">ç›‘å¬åˆ°äº†ageå˜åŒ–ï¼š &#123;</span><br><span class="line">    kind &#x3D; 1;</span><br><span class="line">    new &#x3D; 12;</span><br><span class="line">    old &#x3D; 11;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> ä»ä¸Šè¿°ä»£ç å¯ä»¥çœ‹å‡ºï¼Œæ·»åŠ ç›‘å¬ä¹‹åï¼Œå½“å€¼æ”¹å˜æ—¶ï¼Œä¼šè§¦å‘å‡½æ•°<code>observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context</code>ã€‚</p><h4 id="è§¦å‘æ¡ä»¶"><a href="#è§¦å‘æ¡ä»¶" class="headerlink" title="è§¦å‘æ¡ä»¶"></a>è§¦å‘æ¡ä»¶</h4> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> - (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">&#x2F;&#x2F;self.person.age +&#x3D; 1;</span><br><span class="line">[self.person willChangeValueForKey:@&quot;age&quot;];</span><br><span class="line">[self.person didChangeValueForKey:@&quot;age&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> å½“æŠŠ<code>age</code>å…·ä½“å€¼çš„æ”¹å˜ï¼Œå˜æˆæ‰‹åŠ¨è°ƒç”¨<code>willChangeValueForKey</code>å’Œ<code>didChangeValueForKey</code>çš„æ—¶å€™ï¼Œç»“æœå¦‚ä¸‹ï¼š</p> <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  ç›‘å¬åˆ°äº†ageå˜åŒ–ï¼š &#123;</span><br><span class="line">    kind &#x3D; 1;</span><br><span class="line">    new &#x3D; 10;</span><br><span class="line">    old &#x3D; 10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> <code>new</code>å’Œ<code>old</code>çš„å€¼ç«Ÿç„¶ä¸€æ ·ï¼Œç»æµ‹è¯•åªæœ‰åŒæ—¶å…ˆåè°ƒç”¨<code>willChangeValueForKey</code>å’Œ<code>didChangeValueForKey</code>ï¼Œä¼šè§¦å‘å›è°ƒå‡½æ•°<code>observeValueForKeyPath</code>ï¼Œç”±æ­¤å¯çŸ¥è§¦å‘æ¡ä»¶æ˜¯<code>willChangeValueForKey</code>å’Œ<code>didChangeValueForKey</code>é…åˆä½¿ç”¨ã€‚</p><h4 id="æ¢å¯»KVOåº•å±‚å®ç°åŸç†"><a href="#æ¢å¯»KVOåº•å±‚å®ç°åŸç†" class="headerlink" title="æ¢å¯»KVOåº•å±‚å®ç°åŸç†"></a>æ¢å¯»KVOåº•å±‚å®ç°åŸç†</h4><p>é€šè¿‡ä¸Šè¿°ä»£ç æˆ‘ä»¬å‘ç°ï¼Œä¸€æ—¦ageå±æ€§çš„å€¼å‘ç”Ÿæ”¹å˜æ—¶ï¼Œå°±ä¼šé€šçŸ¥åˆ°ç›‘å¬è€…ï¼Œå¹¶ä¸”æˆ‘ä»¬çŸ¥é“èµ‹å€¼æ“ä½œéƒ½æ˜¯è°ƒç”¨ setæ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ¥åˆ°Personç±»ä¸­é‡å†™ageçš„setæ–¹æ³•ï¼Œè§‚å¯Ÿæ˜¯å¦æ˜¯KVOåœ¨setæ–¹æ³•å†…éƒ¨åšäº†ä¸€äº›æ“ä½œæ¥é€šçŸ¥ç›‘å¬è€…ã€‚<br>æˆ‘ä»¬å‘ç°å³ä½¿é‡å†™äº†setæ–¹æ³•ï¼Œp1å¯¹è±¡å’Œp2å¯¹è±¡è°ƒç”¨åŒæ ·çš„setæ–¹æ³•ï¼Œä½†æ˜¯æˆ‘ä»¬å‘ç°p1é™¤äº†è°ƒç”¨setæ–¹æ³•ä¹‹å¤–è¿˜ä¼šå¦å¤–æ‰§è¡Œç›‘å¬å™¨çš„observeValueForKeyPathæ–¹æ³•ã€‚<br>è¯´æ˜KVOåœ¨è¿è¡Œæ—¶è·å–å¯¹p1å¯¹è±¡åšäº†ä¸€äº›æ”¹å˜ã€‚ç›¸å½“äºåœ¨ç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯¹p1å¯¹è±¡åšäº†ä¸€äº›å˜åŒ–ï¼Œä½¿å¾—p1å¯¹è±¡åœ¨è°ƒç”¨setageæ–¹æ³•çš„æ—¶å€™å¯èƒ½åšäº†ä¸€äº›é¢å¤–çš„æ“ä½œï¼Œæ‰€ä»¥é—®é¢˜å‡ºåœ¨å¯¹è±¡èº«ä¸Šï¼Œä¸¤ä¸ªå¯¹è±¡åœ¨å†…å­˜ä¸­è‚¯å®šä¸ä¸€æ ·ï¼Œä¸¤ä¸ªå¯¹è±¡å¯èƒ½æœ¬è´¨ä¸Šå¹¶ä¸ä¸€æ ·ã€‚æ¥ä¸‹æ¥æ¥æ¢ç´¢KVOå†…éƒ¨æ˜¯æ€ä¹ˆå®ç°çš„ã€‚<br>KVOåº•å±‚å®ç°åˆ†æ<br>é¦–å…ˆæˆ‘ä»¬å¯¹ä¸Šè¿°ä»£ç ä¸­æ·»åŠ ç›‘å¬çš„åœ°æ–¹æ‰“æ–­ç‚¹ï¼Œçœ‹è§‚å¯Ÿä¸€ä¸‹ï¼ŒaddObserveræ–¹æ³•å¯¹p1å¯¹è±¡åšäº†ä»€ä¹ˆå¤„ç†ï¼Ÿä¹Ÿå°±æ˜¯è¯´p1å¯¹è±¡åœ¨ç»è¿‡addObserveræ–¹æ³•ä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆæ”¹å˜ï¼Œæˆ‘ä»¬é€šè¿‡æ‰“å°isaæŒ‡é’ˆï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">@interface ViewController ()</span><br><span class="line">@property (nonatomic,strong)FYPerson *person;</span><br><span class="line">@property (nonatomic,strong)FYPerson *person2;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">[super viewDidLoad];</span><br><span class="line">&#x2F;&#x2F; Do any additional setup after loading the view.</span><br><span class="line">self.person&#x3D;[FYPerson new];</span><br><span class="line">self.person2 &#x3D;[FYPerson new];</span><br><span class="line">self.person.age &#x3D; 10;</span><br><span class="line">[self.person addObserver:self</span><br><span class="line">  forKeyPath:@&quot;age&quot;</span><br><span class="line"> options:NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld</span><br><span class="line"> context:nil];</span><br><span class="line"> Class superclass &#x3D; NSStringFromClass( class_getSuperclass(NSClassFromString(@&quot;NSKVONotifying_FYPerson&quot;)));</span><br><span class="line">Class NSKVONotifying_FYPerson &#x3D; objc_getClass(&quot;NSKVONotifying_FYPerson&quot;);</span><br><span class="line">    fy_objc_class* NSKVONotifying_FYPerson_class &#x3D; (__bridge fy_objc_class *)NSKVONotifying_FYPerson;</span><br><span class="line"> &#x2F;&#x2F;æ­¤å¤„æ‰“æ–­ç‚¹</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;p å‘½ä»¤è¾“å‡ºisaæŒ‡é’ˆ </span><br><span class="line">(lldb) p self.person2-&gt;isa</span><br><span class="line">(Class) $0 &#x3D; FYPerson</span><br><span class="line">(lldb) p self.person-&gt;isa</span><br><span class="line">(Class) $1 &#x3D; NSKVONotifying_FYPerson</span><br><span class="line"></span><br><span class="line">(lldb) p superclass</span><br><span class="line">(Class) $0 &#x3D; FYPerson</span><br><span class="line"></span><br><span class="line">(lldb) p NSKVONotifying_FYPerson_class-&gt;superclass</span><br><span class="line">(Class) $4 &#x3D; FYPerson</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¾“å‡ºçš„isaæŒ‡é’ˆçœ‹æ¥ï¼Œç»è¿‡<code>ã€person addObserverã€‘</code>ä¹‹åï¼Œ<code>person</code>çš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘äº†<code>NSKVONotifying_FYPerson</code>,è€Œ<code>person2</code>çš„<code>isa</code>æ˜¯<code>FYPerson</code>ï¼Œå¯ä»¥çœ‹å‡ºç³»ç»Ÿæ˜¯å¯¹<code>instance</code>å¯¹è±¡çš„<code>isa</code>è¿›è¡Œäº†èµ‹å€¼æ“ä½œã€‚é€šè¿‡<code>p NSKVONotifying_FYPerson_class-&gt;superclass==FYPerson</code>å¯ä»¥çœ‹å‡ºisaæ˜¯æŒ‡å‘äº†å­ç±»ï¼Œé‚£ä¹ˆå­ç±»<code>NSKVONotifying_FYPerson</code>åˆ°åº•åšäº†é‚£äº›äº‹æƒ…å‘¢ï¼Ÿ</p><p>çœ‹ä¸‹è¾¹ä»£ç æŸ¥çœ‹å‡½æ•°isaæ”¹å˜è¿‡ç¨‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">self.person&#x3D;[FYPerson new];</span><br><span class="line">self.person2 &#x3D;[FYPerson new];</span><br><span class="line">self.person.age &#x3D; 10;</span><br><span class="line">&#x2F;&#x2F;æ‰“æ–­ç‚¹ è¾“å‡º po [_person methodForSelector:@selector(setAge:)]</span><br><span class="line">[self.person addObserver:self</span><br><span class="line">  forKeyPath:@&quot;age&quot;</span><br><span class="line"> options:NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld</span><br><span class="line"> context:nil];</span><br><span class="line">&#x2F;&#x2F;æ‰“æ–­ç‚¹ è¾“å‡º po [_person methodForSelector:@selector(setAge:)]</span><br><span class="line"></span><br><span class="line">(lldb) po [_person methodForSelector:@selector(setAge:)]</span><br><span class="line">0x000000010666b720</span><br><span class="line"></span><br><span class="line">(lldb) po [_person methodForSelector:@selector(setAge:)]</span><br><span class="line">0x00000001069c63d2</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;æŸ¥çœ‹IMPæŒ‡é’ˆå¯¹åº”åœ°å€å’Œå†…å®¹</span><br><span class="line">(lldb) p (IMP)0x000000010666b720</span><br><span class="line">(IMP) $2 &#x3D; 0x000000010666b720 (day03-KVOæœ¬è´¨&#96;::-[FYPerson setAge:](int) at FYPerson.h:14)</span><br><span class="line">(lldb) p (IMP)0x00000001069c63d2</span><br><span class="line">(IMP) $3 &#x3D; 0x00000001069c63d2 (Foundation&#96;_NSSetIntValueAndNotify)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥ä¸¤æ¬¡çš„å‡½æ•°åœ°å€ä¸ä¸€è‡´ï¼Œæ·»åŠ KVOä¹‹å‰æ˜¯<code>[FYPerson setAge:]</code>,æ·»åŠ ä¹‹åæ˜¯<code>(Foundation_NSSetIntValueAndNotify)</code>ã€‚æˆ‘ä»¬å°†<code>age</code>çš„ç±»å‹æ”¹æˆ<code>double</code>ï¼Œå†çœ‹ä¸€ä¸‹ç»“æœï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(lldb) po [_person methodForSelector:@selector(setAge:)]</span><br><span class="line">0x00000001080c4710</span><br><span class="line"></span><br><span class="line">(lldb) po [_person methodForSelector:@selector(setAge:)]</span><br><span class="line">0x000000010841f18c</span><br><span class="line"></span><br><span class="line">(lldb) p (IMP)0x00000001080c4710</span><br><span class="line">(IMP) $2 &#x3D; 0x00000001080c4710 (day03-KVOæœ¬è´¨&#96;::-[FYPerson setAge:](double) at FYPerson.h:14)</span><br><span class="line">(lldb) p (IMP)0x000000010841f18c</span><br><span class="line">(IMP) $3 &#x3D; 0x000000010841f18c (Foundation&#96;_NSSetDoubleValueAndNotify)</span><br></pre></td></tr></table></figure><p><code>age</code>æ˜¯<code>int</code>çš„æ—¶å€™æ·»åŠ ä¹‹åæ˜¯<code>Foundation _NSSetIntValueAndNotify</code>,æ”¹æˆ<code>double</code>ä¹‹åï¼Œæ˜¯<code>Foundation _NSSetDoubleValueAndNotify</code>ã€‚é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥æ¨æµ‹<code>Foundation</code>æ¡†æ¶ä¸­è¿˜æœ‰å¾ˆå¤šä¾‹å¦‚<code>_NSSetBoolValueAndNotifyã€_NSSetCharValueAndNotifyã€_NSSetFloatValueAndNotifyã€_NSSetLongValueAndNotify</code>ç­‰ç­‰å‡½æ•°ã€‚<br>è¿è¡Œ<code>nm Foundation | grep ValueAndNotify</code>ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">nm Foundation  | grep ValueAndNotify</span><br><span class="line">__NSSetBoolValueAndNotify</span><br><span class="line">__NSSetCharValueAndNotify</span><br><span class="line">__NSSetDoubleValueAndNotify</span><br><span class="line">__NSSetFloatValueAndNotify</span><br><span class="line">__NSSetIntValueAndNotify</span><br><span class="line">__NSSetLongLongValueAndNotify</span><br><span class="line">__NSSetLongValueAndNotify</span><br><span class="line">__NSSetObjectValueAndNotify</span><br><span class="line">__NSSetPointValueAndNotify</span><br><span class="line">__NSSetRangeValueAndNotify</span><br><span class="line">__NSSetRectValueAndNotify</span><br><span class="line">__NSSetShortValueAndNotify</span><br><span class="line">__NSSetSizeValueAndNotify</span><br></pre></td></tr></table></figure><h4 id="å¦å¤–ä¸€ç§éªŒè¯æ–¹æ³•"><a href="#å¦å¤–ä¸€ç§éªŒè¯æ–¹æ³•" class="headerlink" title="å¦å¤–ä¸€ç§éªŒè¯æ–¹æ³•"></a>å¦å¤–ä¸€ç§éªŒè¯æ–¹æ³•</h4><p>åœ¨macOSä¸­å¯ä»¥ä½¿ç”¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;å¼€å§‹è®°å½•æ—¥å¿—</span><br><span class="line">instrumentObjcMessageSends(YES);</span><br><span class="line">    &#x2F;&#x2F; Do stuff.</span><br><span class="line">instrumentObjcMessageSends(NO);&#x2F;&#x2F;ç»“æŸè®°å½•æ—¥å¿—</span><br></pre></td></tr></table></figure><p>å¦‚æœå°†<code>NSObjCMessageLoggingEnabled</code>ç¯å¢ƒå˜é‡è®¾ç½®ä¸º<code>YES</code>ï¼Œåˆ™<code>Objective-C</code>è¿è¡Œæ—¶ä¼šå°†æ‰€æœ‰å·²åˆ†æ´¾çš„<code>Objective-C</code>æ¶ˆæ¯è®°å½•åˆ°åä¸º<code>/tmp/msgSends-&lt;pid&gt;</code>çš„æ–‡ä»¶ä¸­ã€‚æ¯ä¸€æ¬¡è¿è¡Œä¼šç”Ÿæˆä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°è¯¥æ–‡ä»¶å†…éƒ¨ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;åˆå§‹åŒ–</span><br><span class="line">+ FYPerson NSObject initialize</span><br><span class="line">+ FYPerson NSObject new</span><br><span class="line">- FYPerson NSObject init</span><br><span class="line">- FYPerson NSObject addObserver:forKeyPath:options:context:</span><br><span class="line">- FYPerson NSObject _isKVOA</span><br><span class="line"></span><br><span class="line">****</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;å­ç±»è®¾ç½®age [NSKVONotifying_FYPerson setAge:]</span><br><span class="line"></span><br><span class="line">- NSKVONotifying_FYPerson NSKVONotifying_FYPerson setAge:</span><br><span class="line">- NSKVONotifying_FYPerson NSObject _changeValueForKey:key:key:usingBlock:</span><br><span class="line">- NSKVONotifying_FYPerson NSObject _changeValueForKeys:count:maybeOldValuesDict:maybeNewValuesDict:usingBlock:</span><br><span class="line"></span><br><span class="line">- NSKeyValueUnnestedProperty NSKeyValueUnnestedProperty keyPathIfAffectedByValueForKey:exactMatch:</span><br><span class="line">- NSKeyValueUnnestedProperty NSKeyValueUnnestedProperty _keyPathIfAffectedByValueForKey:exactMatch:</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;will changeValueForKey</span><br><span class="line">- NSKeyValueUnnestedProperty NSKeyValueUnnestedProperty object:withObservance:willChangeValueForKeyOrKeys:recurse:forwardingValues:</span><br><span class="line"> </span><br><span class="line">&#x2F;&#x2F;FYPerson è®¾ç½®age</span><br><span class="line">- FYPerson FYPerson setAge:</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; didChangeValueForKeyOrKeys</span><br><span class="line">- NSKeyValueUnnestedProperty NSKeyValueUnnestedProperty object:withObservance:didChangeValueForKeyOrKeys:recurse:forwardingValues:</span><br><span class="line">- NSKeyValueUnnestedProperty NSKeyValueProperty keyPath</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;æ‰¾åˆ°key å‘é€ å…·ä½“çš„keyå¯¹åº”çš„value åˆ°observe</span><br><span class="line"></span><br><span class="line">- NSKVONotifying_FYPerson NSObject valueForKeyPath:</span><br><span class="line"></span><br><span class="line">- NSKVONotifying_FYPerson NSObject valueForKey:</span><br><span class="line">+ NSKVONotifying_FYPerson NSObject _createValueGetterWithContainerClassID:key:</span><br><span class="line">-</span><br><span class="line">+ NSKVONotifying_FYPerson NSObject resolveInstanceMethod:</span><br><span class="line">+ NSKVONotifying_FYPerson NSObject resolveInstanceMethod:</span><br><span class="line">- NSKVONotifying_FYPerson FYPerson age</span><br><span class="line">+ NSKeyValueMethodGetter NSObject alloc</span><br><span class="line">- NSKeyValueMethodGetter NSKeyValueMethodGetter initWithContainerClassID:key:method:</span><br><span class="line">- NSKeyValueGetter NSKeyValueAccessor initWithContainerClassID:key:implementation:selector:extraArguments:count:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- NSKVONotifying_FYPerson NSObject respondsToSelector:</span><br><span class="line">- NSKVONotifying_FYPerson NSKVONotifying_FYPerson class</span><br><span class="line">- NSKVONotifying_FYPerson NSKVONotifying_FYPerson _isKVOA</span><br><span class="line">+ FYPerson NSObject class</span><br><span class="line">+ FYPerson NSObject resolveInstanceMethod:</span><br><span class="line">+ FYPerson NSObject resolveInstanceMethod:</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;æ•°æ®å­—å…¸</span><br><span class="line">+ NSDictionary NSObject self</span><br><span class="line">+ NSMutableDictionary NSObject self</span><br><span class="line">- NSKeyValueChangeDictionary NSKeyValueChangeDictionary initWithDetailsNoCopy:originalObservable:isPriorNotification:</span><br><span class="line">- NSDictionary NSObject init</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; æ‰§è¡Œè§‚å¯Ÿè€…å›è°ƒå‡½æ•°</span><br><span class="line">- NSKVONotifying_FYPerson FYPerson observeValueForKeyPath:ofObject:change:context:</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+ Student NSObject alloc</span><br><span class="line">- Student NSObject init</span><br><span class="line">- Student NSObject dealloc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">***&#x2F;&#x2F;çœç•¥ä¸€éƒ¨åˆ†ä»£ç </span><br><span class="line"> NSKVONotifying_FYPerson NSObject release</span><br><span class="line">- NSKeyValueChangeDictionary NSObject release</span><br><span class="line">- NSKeyValueChangeDictionary NSKeyValueChangeDictionary dealloc</span><br><span class="line">- NSDictionary NSObject dealloc</span><br><span class="line">- NSKeyValueObservationInfo NSObject release</span><br><span class="line">- NSKVONotifying_FYPerson NSObject release</span><br></pre></td></tr></table></figure><p>ç»è¿‡ä»”ç»†æŠŠé‡è¦çš„å‡½æ•°è¿‡æ»¤å‡ºæ¥ï¼Œæˆ‘ä»¬å¯ä»¥äº†è§£åˆ°<code>person.age = 12</code>çš„æ‰§è¡Œè¿‡ç¨‹æ˜¯<code>NSKVONotifying_FYPerson setAge:</code>-&gt;<code>NSKeyValueUnnestedProperty object:withObservance:willChangeValueForKeyOrKeys:recurse:forwardingValues</code>-&gt;<code>FYPerson FYPerson setAge:</code>-&gt;<code>NSKeyValueUnnestedProperty NSKeyValueUnnestedProperty object:withObservance:didChangeValueForKeyOrKeys:recurse:forwardingValues:</code>-&gt;<code>NSKVONotifying_FYPerson NSObject valueForKeyPath:</code>-&gt;<code>NSMutableDictionary NSObject self</code>-&gt;<code>- NSKVONotifying_FYPerson FYPerson observeValueForKeyPath:ofObject:change:context:</code>ï¼Œæˆ‘ä»¬æ¥ç”¨ä¼ªä»£ç å®ç°ä¸€éï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;person.age &#x3D; 12</span><br><span class="line">[NSKVONotifying_FYPerson setAge:12];</span><br><span class="line">willChangeValueForKey@&quot;age&quot;;</span><br><span class="line">[FYPerson setAge:12];</span><br><span class="line">didChangeValueForKey@&quot;age&quot;;</span><br><span class="line">[[NSMutableDictionary alloc] init];</span><br><span class="line">[NSKVONotifying_FYPerson observeValueForKeyPath:ofObject:change:context];</span><br></pre></td></tr></table></figure><p>NSKVONotifyin_Personå†…éƒ¨ç»“æ„æ˜¯æ€æ ·çš„ï¼Ÿ<br>é¦–å…ˆæˆ‘ä»¬çŸ¥é“ï¼ŒNSKVONotifyin_Personä½œä¸ºPersonçš„å­ç±»ï¼Œå…¶superclassæŒ‡é’ˆæŒ‡å‘Personç±»ï¼Œå¹¶ä¸”NSKVONotifyin_Personå†…éƒ¨ä¸€å®šå¯¹setAgeæ–¹æ³•åšäº†å•ç‹¬çš„å®ç°ï¼Œé‚£ä¹ˆNSKVONotifyin_PersonåŒPersonç±»çš„å·®åˆ«å¯èƒ½å°±åœ¨äºå…¶å†…å­˜å‚¨çš„å¯¹è±¡æ–¹æ³•åŠå®ç°ä¸åŒã€‚<br>æˆ‘ä»¬é€šè¿‡runtimeåˆ†åˆ«æ‰“å°Personç±»å¯¹è±¡å’ŒNSKVONotifyin_Personç±»å¯¹è±¡å†…å­˜å‚¨çš„å¯¹è±¡æ–¹æ³•</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line"></span><br><span class="line">    Person *p1 &#x3D; [[Person alloc] init];</span><br><span class="line">    p1.age &#x3D; 1.0;</span><br><span class="line">    Person *p2 &#x3D; [[Person alloc] init];</span><br><span class="line">    p1.age &#x3D; 2.0;</span><br><span class="line">    &#x2F;&#x2F; self ç›‘å¬ p1çš„ ageå±æ€§</span><br><span class="line">    NSKeyValueObservingOptions options &#x3D; NSKeyValueObservingOptionNew | NSKeyValueObservingOptionOld;</span><br><span class="line">    [p1 addObserver:self forKeyPath:@&quot;age&quot; options:options context:nil];</span><br><span class="line"></span><br><span class="line">    [self printMethods: object_getClass(p2)];</span><br><span class="line">    [self printMethods: object_getClass(p1)];</span><br><span class="line"></span><br><span class="line">    [p1 removeObserver:self forKeyPath:@&quot;age&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void) printMethods:(Class)cls</span><br><span class="line">&#123;</span><br><span class="line">    unsigned int count ;</span><br><span class="line">    Method *methods &#x3D; class_copyMethodList(cls, &amp;count);</span><br><span class="line">    NSMutableString *methodNames &#x3D; [NSMutableString string];</span><br><span class="line">    [methodNames appendFormat:@&quot;%@ - &quot;, cls];</span><br><span class="line">    </span><br><span class="line">    for (int i &#x3D; 0 ; i &lt; count; i++) &#123;</span><br><span class="line">        Method method &#x3D; methods[i];</span><br><span class="line">        NSString *methodName  &#x3D; NSStringFromSelector(method_getName(method));</span><br><span class="line">        </span><br><span class="line">        [methodNames appendString: methodName];</span><br><span class="line">        [methodNames appendString:@&quot; &quot;];</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSLog(@&quot;%@&quot;,methodNames);</span><br><span class="line">    free(methods);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ç»“æœå¦‚ä¸‹ï¼š</span><br><span class="line">NSKVONotifying_FYPerson - setAge: class dealloc _isKVOA</span><br><span class="line">FYPerson - setAge: age</span><br></pre></td></tr></table></figure><p> é€šè¿‡ä¸Šè¿°ä»£ç æˆ‘ä»¬å‘ç°NSKVONotifyin_Personä¸­æœ‰4ä¸ªå¯¹è±¡æ–¹æ³•ã€‚åˆ†åˆ«ä¸ºsetAge: class dealloc _isKVOAï¼Œé‚£ä¹ˆè‡³æ­¤æˆ‘ä»¬å¯ä»¥ç”»å‡ºNSKVONotifyin_Personçš„å†…å­˜ç»“æ„ä»¥åŠæ–¹æ³•è°ƒç”¨é¡ºåºã€‚</p><p><img src="/images/3-1.png" alt></p><p>è¿™é‡ŒNSKVONotifyin_Personé‡å†™classæ–¹æ³•æ˜¯ä¸ºäº†éšè—NSKVONotifyin_Personã€‚ä¸è¢«å¤–ç•Œæ‰€çœ‹åˆ°ã€‚æˆ‘ä»¬åœ¨p1æ·»åŠ è¿‡KVOç›‘å¬ä¹‹åï¼Œåˆ†åˆ«æ‰“å°p1å’Œp2å¯¹è±¡çš„classå¯ä»¥å‘ç°ä»–ä»¬éƒ½è¿”å›Personã€‚</p><p>å¦‚æœNSKVONotifyin_Personä¸é‡å†™classæ–¹æ³•ï¼Œé‚£ä¹ˆå½“å¯¹è±¡è¦è°ƒç”¨classå¯¹è±¡æ–¹æ³•çš„æ—¶å€™å°±ä¼šä¸€ç›´å‘ä¸Šæ‰¾æ¥åˆ°nsobjectï¼Œè€Œnsobectçš„classçš„å®ç°å¤§è‡´ä¸ºè¿”å›è‡ªå·±isaæŒ‡å‘çš„ç±»ï¼Œè¿”å›p1çš„isaæŒ‡å‘çš„ç±»é‚£ä¹ˆæ‰“å°å‡ºæ¥çš„ç±»å°±æ˜¯NSKVONotifyin_Personï¼Œä½†æ˜¯appleä¸å¸Œæœ›å°†NSKVONotifyin_Personç±»æš´éœ²å‡ºæ¥ï¼Œå¹¶ä¸”ä¸å¸Œæœ›æˆ‘ä»¬çŸ¥é“NSKVONotifyin_Personå†…éƒ¨å®ç°ï¼Œæ‰€ä»¥åœ¨å†…éƒ¨é‡å†™äº†classç±»ï¼Œç›´æ¥è¿”å›Personç±»ï¼Œæ‰€ä»¥å¤–ç•Œåœ¨è°ƒç”¨p1çš„classå¯¹è±¡æ–¹æ³•æ—¶ï¼Œæ˜¯Personç±»ã€‚è¿™æ ·p1ç»™å¤–ç•Œçš„æ„Ÿè§‰p1è¿˜æ˜¯Personç±»ï¼Œå¹¶ä¸çŸ¥é“NSKVONotifyin_Personå­ç±»çš„å­˜åœ¨ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥çŒœæµ‹NSKVONotifyin_Personå†…é‡å†™çš„classå†…éƒ¨å®ç°å¤§è‡´ä¸º</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (Class) class &#123;</span><br><span class="line">     &#x2F;&#x2F; å¾—åˆ°ç±»å¯¹è±¡ï¼Œåœ¨æ‰¾åˆ°ç±»å¯¹è±¡çˆ¶ç±»</span><br><span class="line">     return class_getSuperclass(object_getClass(self));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åè‡ªå·±å†™ä»£ç éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@implementation FYPerson</span><br><span class="line">-(void)willChangeValueForKey:(NSString *)key&#123;</span><br><span class="line">NSLog(@&quot;%s å¼€å§‹&quot;,__func__);</span><br><span class="line">[super didChangeValueForKey:key];</span><br><span class="line">NSLog(@&quot;%s ç»“æŸ&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">- (void)didChangeValueForKey:(NSString *)key&#123;</span><br><span class="line">NSLog(@&quot;%s å¼€å§‹&quot;,__func__);</span><br><span class="line">[super didChangeValueForKey:key];</span><br><span class="line">NSLog(@&quot;%s ç»“æŸ&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">- (void)setAge:(double)age&#123;</span><br><span class="line">_age &#x3D; age;</span><br><span class="line">NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¹‹åç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-[FYPerson willChangeValueForKey:] å¼€å§‹</span><br><span class="line">-[FYPerson willChangeValueForKey:] ç»“æŸ</span><br><span class="line">-[FYPerson setAge:]</span><br><span class="line">-[FYPerson didChangeValueForKey:] å¼€å§‹</span><br><span class="line"> ç›‘å¬åˆ°äº†ageå˜åŒ–ï¼š &#123;</span><br><span class="line">    kind &#x3D; 1;</span><br><span class="line">    new &#x3D; 11;</span><br><span class="line">    old &#x3D; 10;</span><br><span class="line">&#125;</span><br><span class="line">-[FYPerson didChangeValueForKey:] ç»“æŸ</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h4><p>KVOå…¶å®æ˜¯ä¸€ä¸ªé€šè¿‡runtimeæ³¨å†Œå»ºç«‹å­ç±»ï¼Œé€šè¿‡ä¿®æ”¹instanceçš„isaæŒ‡é’ˆï¼ŒæŒ‡å‘æ–°çš„å­ç±»ï¼Œé‡å†™instaceçš„classæ–¹æ³•æ¥æ©ç›–ï¼Œå­ç±»æ‹¥æœ‰è‡ªå·±çš„setæ–¹æ³•ï¼Œè°ƒç”¨é¡ºåºæ˜¯willChangeValueForKeyæ–¹æ³•ã€åŸæ¥çš„setteræ–¹æ³•å®ç°ã€didChangeValueForKeyæ–¹æ³•ï¼Œè€ŒdidChangeValueForKeyæ–¹æ³•å†…éƒ¨åˆä¼šè°ƒç”¨ç›‘å¬å™¨çš„observeValueForKeyPath:ofObject:change:context:ç›‘å¬æ–¹æ³•ã€‚</p><h3 id="KVCçš„æœ¬è´¨"><a href="#KVCçš„æœ¬è´¨" class="headerlink" title="KVCçš„æœ¬è´¨"></a>KVCçš„æœ¬è´¨</h3><p>KVCçš„å…¨ç§°æ˜¯Key-Value Codingï¼Œä¿—ç§°â€œé”®å€¼ç¼–ç â€ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªkeyæ¥è®¿é—®æŸä¸ªå±æ€§ã€‚<br>å¸¸ç”¨çš„APIæœ‰</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (void)setValue:(id)value forKeyPath:(NSString *)keyPath;</span><br><span class="line">- (void)setValue:(id)value forKey:(NSString *)key;</span><br><span class="line">- (id)valueForKeyPath:(NSString *)keyPath;</span><br><span class="line">- (id)valueForKey:(NSString *)key;</span><br></pre></td></tr></table></figure><p>å…¶å®å½“Objè°ƒç”¨<code>(void)setValue:(id)value forKey:(NSString *)key</code>çš„æ—¶å€™ï¼Œ<code>obj</code>ä¼šä¸»åŠ¨å¯»æ‰¾æ–¹æ³•<code>setKey</code>å’Œ<code>_setKey</code>ä¸¤ä¸ªæ–¹æ³•ï¼Œæ²¡æœ‰æ‰¾åˆ°è¿™ä¸¤ä¸ªæ–¹æ³•ä¼šå†å»å¯»æ‰¾<code>accessInstanceVariablesDirectly</code>ï¼Œè¿”å›å€¼ä¸º<code>NO</code>åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œè¿”å›<code>YES</code>åˆ™å»æŒ‰ç…§<code>_key</code>ã€<code>_isKey</code>ã€<code>key</code>ã€<code>isKey</code>çš„æŸ¥æ‰¾ä¼˜å…ˆçº§æŸ¥æ‰¾æˆå‘˜å˜é‡ï¼Œæ‰¾åˆ°ä¹‹åç›´æ¥å¤åˆ¶ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚<br>æˆ‘ä»¬ä½¿ç”¨è¿™æ®µä»£ç æ¥éªŒè¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson()&#123;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">@implementation FYPerson</span><br><span class="line">&#x2F;&#x2F;code1</span><br><span class="line">- (void)setAge:(NSInteger)age&#123;</span><br><span class="line">NSLog(@&quot;%s %ld&quot;,__func__,(long)age);</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F;code2</span><br><span class="line">- (void)_setAge:(NSInteger)age&#123;</span><br><span class="line">NSLog(@&quot;%s %ld&quot;,__func__,(long)age);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FYPerson *p&#x3D;[[FYPerson alloc]init];</span><br><span class="line">[p setValue:@(2) forKey:@&quot;age&quot;];</span><br></pre></td></tr></table></figure><p>å½“æ‰§è¡Œ<code>code1</code>å’Œ<code>code2</code>éƒ½æœ‰çš„æ—¶å€™ï¼Œè¾“å‡º<code>-[FYPerson setAge:] 2</code>ï¼Œå½“<code>code1</code>æ³¨é‡Šæ‰ï¼Œè¾“å‡º<code>-[FYPerson _setAge:] 2</code>ï¼Œå¯ä»¥çœ‹å‡ºæ‰§è¡Œé¡ºåºæ˜¯<code>setAge</code>ï¼Œæ²¡æœ‰<code>setAge</code>çš„æ—¶å€™å†å»æ‰§è¡Œ<code>_setAge</code>ã€‚</p><p>ç°åœ¨æ–°å¢<code>FYPerson</code>4ä¸ªæˆå‘˜å˜é‡ï¼Œä¾æ¬¡æ³¨é‡Šæ‰ä»–ä»¬æ¥æµ‹è¯•å¯»æ‰¾æˆå‘˜å˜é‡çš„é¡ºåºã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@interface FYPerson : NSObject</span><br><span class="line">&#123;</span><br><span class="line">@public</span><br><span class="line">NSInteger _age;</span><br><span class="line">NSInteger _isAge;</span><br><span class="line">NSInteger age;</span><br><span class="line">NSInteger isAge;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FYPerson *p&#x3D;[[FYPerson alloc]init];</span><br><span class="line">[p setValue:@(2) forKey:@&quot;age&quot;];</span><br><span class="line"></span><br><span class="line">NSLog(@&quot;age:%d _age:%d isAge:%d _isAge:%d&quot;,(int)p-&gt;age,(int)p-&gt;_age,(int)p-&gt;isAge,(int)p-&gt;_isAge);</span><br></pre></td></tr></table></figure></p><ul><li>æ²¡æ³¨é‡Šè¾“å‡º <code>age:0 _age:2 isAge:0 _isAge:0</code></li><li>æ³¨é‡Š<code>_age</code>è¾“å‡º <code>age:0 isAge:0 _isAge:2</code></li><li>æ³¨é‡Š<code>_isAge</code>è¾“å‡º <code>age:2 isAge:0</code></li><li>æ³¨é‡Š<code>age</code>è¾“å‡º <code>isAge:2</code></li></ul><h4 id="KVCå’ŒKVOè”ç³»"><a href="#KVCå’ŒKVOè”ç³»" class="headerlink" title="KVCå’ŒKVOè”ç³»"></a>KVCå’ŒKVOè”ç³»</h4><p>æˆ‘ä»¬çŸ¥é“KVCæœ¬è´¨ä¹Ÿæ˜¯è°ƒç”¨setteræ–¹æ³•ï¼Œé‚£ä¹ˆä¼šå‡ºå‘KVOå—ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">FYPerson *p&#x3D;[[FYPerson alloc]init];</span><br><span class="line">[p addObserver:p</span><br><span class="line">forKeyPath:@&quot;age&quot;</span><br><span class="line">   options:NSKeyValueChangeNewKey</span><br><span class="line">   context:nil];</span><br><span class="line">[p setValue:@2 forKey:@&quot;age&quot;];</span><br><span class="line">[p removeObserver:p forKeyPath:@&quot;age&quot;];</span><br><span class="line"></span><br><span class="line">@interface FYPerson()&#123;</span><br><span class="line">@public</span><br><span class="line">NSInteger _age;</span><br><span class="line">NSInteger _isAge;</span><br><span class="line">NSInteger age;</span><br><span class="line">NSInteger isAge;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">@implementation FYPerson</span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context&#123;</span><br><span class="line">NSLog(@&quot;%@&quot;,change);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;ç»“æœ</span><br><span class="line">&#123;</span><br><span class="line">    kind &#x3D; 1;</span><br><span class="line">    new &#x3D; 2;</span><br><span class="line">    old &#x3D; 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡æµ‹è¯•ï¼Œå¯ä»¥çœ‹å‡ºKVCèƒ½è§¦å‘KVOçš„ã€‚é‚£ä¹ˆ<code>valueForKey:key</code>åº•å±‚æ˜¯æ€ä¹ˆè¿è¡Œçš„å‘¢ï¼Ÿå…¶å®åº•å±‚æ˜¯æŒ‰ç…§é¡ºåºæŸ¥æ‰¾å››ä¸ªæ–¹æ³•<code>_age</code>-&gt;<code>_isAge</code>-&gt;<code>age</code>-&gt;<code>isAge</code>ã€‚æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">FYPerson *p&#x3D;[[FYPerson alloc]init];</span><br><span class="line">p-&gt;_age &#x3D; 1;</span><br><span class="line">p-&gt;_isAge &#x3D; 2;</span><br><span class="line">p-&gt;age &#x3D; 3;</span><br><span class="line">p-&gt;isAge &#x3D; 4;</span><br><span class="line">NSLog(@&quot;value:%@&quot;,[p valueForKey:@&quot;age&quot;]);</span><br><span class="line">&#x2F;&#x2F;ä¾æ¬¡æ³¨é‡Š1,2,3ï¼Œä¾æ¬¡è¾“å‡ºæ˜¯1-&gt;2-&gt;3-&gt;4</span><br></pre></td></tr></table></figure><h4 id="æ€»ç»“ï¼š-1"><a href="#æ€»ç»“ï¼š-1" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h4><p>KVCå…¶å®æœ¬è´¨æ˜¯æ‰§è¡Œ4ä¸ªsetæ–¹æ³•å’Œ4ä¸ªgetæ–¹æ³•ï¼Œå½“ä½¿ç”¨<code>setValue:forKey:key</code>ä¼šè§¦å‘KVOï¼Œæ‰¾ä¸åˆ°4ä¸ªæ–¹æ³•çš„æ—¶å€™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p><h4 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h4><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code<i class="fa fa-external-link"></i></span></li></ul><p>ä¹‹å‰çœ‹çš„æ²¡æœ‰æ‰‹åŠ¨å»è¯•éªŒä¸€ä¸‹ï¼Œç„¶åå†å†™å‡ºæ¥ï¼Œç°åœ¨æ€»ç»“ä¸€ä¸‹ï¼Œå‚è€ƒäº†å¾ˆå¤šæ–‡ç« ï¼Œè¿˜æœ‰macOSä¸­æ—¥å¿—è®°å½•æ˜¯æ— æ„æœç´¢å‡ºæ¥äº†ä¸€ä¸ªè€å¤–çš„blogï¼Œå¤§å®¶å¯ä»¥äº†è§£ä¸‹ï¼Œä»¥åä¼šæœ‰ç”¨ï¼Œåè¾¹ä¼šè®²å¦‚ä½•<code>hook objc_msgsend</code>,æ„Ÿè§‰è¿™ä¸ªæŒºå¥½ç©çš„ã€‚</p><p>æœ¬æ–‡ç« ä¹‹æ‰€ä»¥å›¾ç‰‡æ¯”è¾ƒå°‘ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯è·Ÿç€ä»£ç æ•²ä¸€éï¼Œå°è±¡æ¯”è¾ƒæ·±åˆ»ã€‚</p><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p><p> å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;æˆ‘ä»¬çŸ¥é“å®ä¾‹å®é™…æ˜¯å­˜å‚¨äº†æˆå‘˜å˜é‡çš„å€¼å’ŒæŒ‡å‘ç±»çš„&lt;code&gt;isa&lt;/code&gt;æŒ‡é’ˆï¼Œ&lt;code&gt;class&lt;/code&gt;å¯¹è±¡å’Œ&lt;code&gt;meta-class&lt;/code&gt;å¯¹è±¡åŒ…å« &lt;code&gt;isa&lt;/code&gt;ã€&lt;code&gt;superclass&lt;/code&gt;å’Œ&lt;code
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç†  ç±»çš„æœ¬è´¨ --(2)</title>
    <link href="http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%E7%B1%BB%E7%9A%84%E6%9C%AC%E8%B4%A8--(2)/"/>
    <id>http://fgyong.cn/2019/12/01/iOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%E7%B1%BB%E7%9A%84%E6%9C%AC%E8%B4%A8--(2)/</id>
    <published>2019-12-01T03:12:58.000Z</published>
    <updated>2020-09-04T04:40:21.662Z</updated>
    
    <content type="html"><![CDATA[<h3 id="åº•å±‚åŸç†-ç±»çš„æœ¬è´¨"><a href="#åº•å±‚åŸç†-ç±»çš„æœ¬è´¨" class="headerlink" title="åº•å±‚åŸç† ç±»çš„æœ¬è´¨"></a>åº•å±‚åŸç† ç±»çš„æœ¬è´¨</h3><p>å¤ä¹ ä¸€ä¸‹<a href>IOS åº•å±‚åŸç† å¯¹è±¡çš„æœ¬è´¨â€“(1)</a>ï¼Œå¯ä»¥çœ‹å‡ºæ¥å®ä¾‹å¯¹è±¡å®é™…æ˜¯ä¸Šç»“æ„ä½“ï¼Œé‚£ä¹ˆè¿™ä¸ªç»“æ„ä½“æ˜¯æœ‰ç±»æŒ‡é’ˆå’Œæˆå‘˜å˜é‡ç»„æˆçš„ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;Person</span><br><span class="line">@interface Person : NSObject</span><br><span class="line">&#123;</span><br><span class="line">@public</span><br><span class="line">int _age;&#x2F;&#x2F;4bytes</span><br><span class="line">int _level;&#x2F;&#x2F;4bytes</span><br><span class="line">int _code;&#x2F;&#x2F;4bytes</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">@implementation Person</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>ç»è¿‡<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main64.cpp</code>ç¼–è¯‘ä¹‹åå…¶å®<code>Person</code>å¯¹è±¡æ˜¯:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">struct Person_IMPL &#123;</span><br><span class="line">struct NSObject_IMPL NSObject_IVARS;</span><br><span class="line">int _age;</span><br><span class="line">int _level;</span><br><span class="line">int _code;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>NSObject_IMPL</code>ç»“æ„ä½“ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct NSObject_IMPL &#123;</span><br><span class="line">Class isa;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆ<code>NSObject</code>åœ¨å†…å­˜ä¸­åŒ…æ‹¬</p><ul><li><code>isa</code>æŒ‡é’ˆ</li><li>å…¶ä»–æˆå‘˜å˜é‡</li></ul><p><img src="/images/2-1.png" alt></p><p><code>isa</code>åœ°å€å°±æ˜¯<code>instance</code>çš„åœ°å€ï¼Œå…¶ä»–æˆå‘˜å˜é‡æ’åœ¨åè¾¹ï¼Œä¹Ÿå°±æ˜¯<code>instance</code>çš„åœ°å€å°±æ˜¯<code>isa</code>çš„åœ°å€ã€‚</p><p>é‚£ä¹ˆè¿™ä¸ª<code>isa</code>æŒ‡å‘çš„åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br>è¯·å¾€ä¸‹ç»§ç»­çœ‹ï¼š<br>å…ˆçœ‹ä¸‹è¿™æ®µä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NSObject *ob1&#x3D;[[NSObject alloc]init];</span><br><span class="line">NSObject *ob2&#x3D;[[NSObject alloc]init];</span><br><span class="line"></span><br><span class="line">Class cl1 &#x3D; object_getClass([ob1 class]);</span><br><span class="line">Class cl2 &#x3D; object_getClass([ob2 class]);</span><br><span class="line"></span><br><span class="line">Class cl3 &#x3D; ob1.class;</span><br><span class="line">Class cl4 &#x3D; ob2.class;</span><br><span class="line"></span><br><span class="line">Class cl5 &#x3D; NSObject.class;</span><br><span class="line"></span><br><span class="line">NSLog(@&quot; %p %p %p %p %p&quot;,cl1,cl2,cl3,cl4,cl5);</span><br><span class="line">&#x2F;&#x2F;0x7fff8e3ba0f0 0x7fff8e3ba0f0 </span><br><span class="line">&#x2F;&#x2F;0x7fff8e3ba140 0x7fff8e3ba140 0x7fff8e3ba140</span><br></pre></td></tr></table></figure><p>è¿™ä»£ç æ˜¯è¾“å‡ºäº†å‡ ä¸ª<code>NSObject</code>çš„å¯¹è±¡çš„ç±»å’Œ<code>NSObject</code>çš„ç±»å¯¹è±¡çš„åœ°å€ï¼Œå¯ä»¥çœ‹åˆ°<code>cl1==cl2</code>ã€<code>cl3==cl4==cl5</code>ã€‚</p><h4 id="Classçš„æœ¬è´¨"><a href="#Classçš„æœ¬è´¨" class="headerlink" title="Classçš„æœ¬è´¨"></a>Classçš„æœ¬è´¨</h4><p>æˆ‘ä»¬çŸ¥é“ä¸ç®¡æ˜¯ç±»å¯¹è±¡è¿˜æ˜¯å…ƒç±»å¯¹è±¡ï¼Œç±»å‹éƒ½æ˜¯Classï¼Œclasså’Œmete-classçš„åº•å±‚éƒ½æ˜¯objc_classç»“æ„ä½“çš„æŒ‡é’ˆï¼Œå†…å­˜ä¸­å°±æ˜¯ç»“æ„ä½“ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class objectClass &#x3D; [NSObject class];        </span><br><span class="line">Class objectMetaClass &#x3D; object_getClass([NSObject class]);</span><br></pre></td></tr></table></figure><p>ç‚¹å‡»classæ¥åˆ°å†…éƒ¨ï¼Œå¯ä»¥å‘ç°</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_class *Class;</span><br></pre></td></tr></table></figure><p><code>class</code>å¯¹è±¡å…¶å®æ˜¯æŒ‡å‘objc_classçš„ç»“æ„ä½“ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥è¯´ç±»å¯¹è±¡æˆ–å…ƒç±»å¯¹è±¡åœ¨å†…å­˜ä¸­å…¶å®å°±æ˜¯objc_classç»“æ„ä½“ã€‚</p><p>æ¥åˆ°<code>objc_class</code>å†…éƒ¨ï¼Œåœ¨æºç ä¸­ç»å¸¸çœ‹åˆ°è¿™æ®µæºç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">struct objc_class &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;&#x2F;&#x2F;isa</span><br><span class="line"></span><br><span class="line">#if !__OBJC2__</span><br><span class="line">    Class _Nullable super_class                    &#x2F;&#x2F;çˆ¶ç±»          OBJC2_UNAVAILABLE;</span><br><span class="line">    const char * _Nonnull name                              &#x2F;&#x2F;objåå­— OBJC2_UNAVAILABLE;</span><br><span class="line">    long version                                            &#x2F;&#x2F;ç‰ˆæœ¬ OBJC2_UNAVAILABLE;</span><br><span class="line">    long info                                               &#x2F;&#x2F;info OBJC2_UNAVAILABLE;</span><br><span class="line">    long instance_size                                      &#x2F;&#x2F; OBJC2_UNAVAILABLE;</span><br><span class="line">    struct objc_ivar_list * _Nullable ivars             &#x2F;&#x2F;æˆå‘˜å˜é‡é“¾è¡¨     OBJC2_UNAVAILABLE;</span><br><span class="line">    struct objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;&#x2F;&#x2F;æ–¹æ³•é“¾è¡¨</span><br><span class="line">    struct objc_cache * _Nonnull cache      &#x2F;&#x2F;ç¼“å­˜é“¾è¡¨                 OBJC2_UNAVAILABLE;</span><br><span class="line">    struct objc_protocol_list * _Nullable protocols         &#x2F;&#x2F;åè®®é“¾è¡¨ OBJC2_UNAVAILABLE;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br><span class="line">&#x2F;* Use &#96;Class&#96; instead of &#96;struct objc_class *&#96; *&#x2F;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç æ˜æ˜¾æ˜¯ å·²ç»<code>OBJC2_UNAVAILABLE</code>ï¼Œè¯´æ˜ä»£ç å·²ç»ä¸åœ¨ä½¿ç”¨äº†ã€‚é‚£ä¹ˆ<code>objc_class</code>ç»“æ„ä½“å†…éƒ¨ç»“æ„åˆ°åº•æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿé€šè¿‡objcæœå¯»<code>runtime</code>çš„å†…å®¹å¯ä»¥çœ‹åˆ°<code>objc_class</code>å†…éƒ¨</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">struct objc_class : objc_object &#123;</span><br><span class="line">    &#x2F;&#x2F; Class ISA;</span><br><span class="line">    Class superclass;</span><br><span class="line">    cache_t cache;             &#x2F;&#x2F; formerly cache pointer and vtable</span><br><span class="line">    class_data_bits_t bits;    &#x2F;&#x2F; class_rw_t * plus custom rr&#x2F;alloc flags</span><br><span class="line"></span><br><span class="line">    class_rw_t *data() &#123; </span><br><span class="line">        return bits.data();</span><br><span class="line">    &#125;</span><br><span class="line">    void setData(class_rw_t *newData) &#123;</span><br><span class="line">        bits.setData(newData);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void setInfo(uint32_t set) &#123;</span><br><span class="line">        assert(isFuture()  ||  isRealized());</span><br><span class="line">        data()-&gt;setFlags(set);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    void clearInfo(uint32_t clear) &#123;</span><br><span class="line">        assert(isFuture()  ||  isRealized());</span><br><span class="line">        data()-&gt;clearFlags(clear);</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F;**åè¾¹çœç•¥</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬å‘ç°è¿™ä¸ªç»“æ„ä½“ç»§æ‰¿ <code>objc_object</code> å¹¶ä¸”ç»“æ„ä½“å†…æœ‰ä¸€äº›å‡½æ•°ï¼Œå› ä¸ºè¿™æ˜¯<code>c++</code>ç»“æ„ä½“ï¼Œåœ¨cä¸Šåšäº†æ‰©å±•ï¼Œå› æ­¤ç»“æ„ä½“ä¸­å¯ä»¥åŒ…å«å‡½æ•°ã€‚æˆ‘ä»¬æ¥åˆ°<code>objc_object</code>å†…ï¼Œæˆªå–éƒ¨åˆ†ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">struct objc_object &#123;</span><br><span class="line">private:</span><br><span class="line">    isa_t isa;</span><br><span class="line"></span><br><span class="line">public:</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; ISA() assumes this is NOT a tagged pointer object</span><br><span class="line">    Class ISA();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; getIsa() allows this to be a tagged pointer object</span><br><span class="line">    Class getIsa();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; initIsa() should be used to init the isa of new objects only.</span><br><span class="line">    &#x2F;&#x2F; If this object already has an isa, use changeIsa() for correctness.</span><br><span class="line">    &#x2F;&#x2F; initInstanceIsa(): objects with no custom RR&#x2F;AWZ</span><br><span class="line">    &#x2F;&#x2F; initClassIsa(): class objects</span><br><span class="line">    &#x2F;&#x2F; initProtocolIsa(): protocol objects</span><br><span class="line">    &#x2F;&#x2F; initIsa(): other objects</span><br><span class="line">    void initIsa(Class cls &#x2F;*nonpointer&#x3D;false*&#x2F;);</span><br><span class="line">    void initClassIsa(Class cls &#x2F;*nonpointer&#x3D;maybe*&#x2F;);</span><br><span class="line">    void initProtocolIsa(Class cls &#x2F;*nonpointer&#x3D;maybe*&#x2F;);</span><br><span class="line">    void initInstanceIsa(Class cls, bool hasCxxDtor);</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬ä¹‹å‰äº†è§£åˆ°çš„ï¼Œç±»ä¸­å­˜å‚¨çš„ç±»çš„æˆå‘˜å˜é‡ä¿¡æ¯ï¼Œæ–¹æ³•åˆ—è¡¨ï¼Œåè®®åˆ—è¡¨ï¼Œæˆªå–<code>class_rw_t</code>å†…éƒ¨å®ç°ä»£ç </p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">struct class_rw_t &#123;</span><br><span class="line">    &#x2F;&#x2F; Be warned that Symbolication knows the layout of this structure.</span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t version;</span><br><span class="line"></span><br><span class="line">    const class_ro_t *ro;</span><br><span class="line"></span><br><span class="line">    method_array_t methods;&#x2F;&#x2F;æ–¹æ³•åˆ—è¡¨</span><br><span class="line">    property_array_t properties;&#x2F;&#x2F;å±æ€§åˆ—è¡¨</span><br><span class="line">    protocol_array_t protocols;&#x2F;&#x2F;åè®®åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">    Class firstSubclass;</span><br><span class="line">    Class nextSiblingClass;</span><br><span class="line">**</span><br><span class="line">&#x2F;&#x2F;åè¾¹çœç•¥</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>class_rw_t</code>æ˜¯é€šè¿‡<code>bits.data()</code>è·å–çš„ï¼Œæˆªå–<code>bits.data()</code>æŸ¥çœ‹å†…éƒ¨å®ç°,è€Œä»…ä»…æ˜¯<code>bits&amp;FAST_DATA_MASK</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class_rw_t* data() &#123;</span><br><span class="line">    return (class_rw_t *)(bits &amp; FAST_DATA_MASK);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œæˆå‘˜å˜é‡åˆ™æ˜¯å­˜å‚¨åœ¨<code>class_ro_t</code>å†…éƒ¨ä¸­çš„ï¼Œæˆ‘ä»¬æ¥åˆ°<code>class_ro_t</code>å†…éƒ¨æŸ¥çœ‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">struct class_ro_t &#123;</span><br><span class="line">    uint32_t flags;</span><br><span class="line">    uint32_t instanceStart;</span><br><span class="line">    uint32_t instanceSize;</span><br><span class="line">#ifdef __LP64__</span><br><span class="line">    uint32_t reserved;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    const uint8_t * ivarLayout;</span><br><span class="line">    </span><br><span class="line">    const char * name;</span><br><span class="line">    method_list_t * baseMethodList;&#x2F;&#x2F;æ–¹æ³•åˆ—è¡¨</span><br><span class="line">    protocol_list_t * baseProtocols;&#x2F;&#x2F;åè®®åˆ—è¡¨</span><br><span class="line">    const ivar_list_t * ivars;&#x2F;&#x2F;æˆå‘˜å˜é‡åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">    const uint8_t * weakIvarLayout;</span><br><span class="line">    property_list_t *baseProperties;&#x2F;&#x2F;å±æ€§åˆ—è¡¨</span><br><span class="line"></span><br><span class="line">    method_list_t *baseMethods() const &#123;</span><br><span class="line">        return baseMethodList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>æœ€åé€šè¿‡ä¸€å¼ å›¾æ€»ç»“ä¸€ä¸‹ï¼š</p><p><img src="/images/2-2.png" alt></p><p>é‚£ä¹ˆæˆ‘ä»¬æ¥è¯æ˜ä¸€ä¸‹ï¼š<br>æˆ‘ä»¬å¯ä»¥è‡ªå®šä¹‰ä¸€ä¸‹ä¸€ä¸ªå’Œç³»ç»Ÿä¸€æ ·çš„ç»“æ„ä½“ï¼Œé‚£ä¹ˆæˆ‘ä»¬å½“æˆ‘ä»¬å¼ºåˆ¶è½¬åŒ–çš„æ—¶å€™ï¼Œä»–ä»¬èµ‹å€¼ä¼šä¸€ä¸€å¯¹åº”ï¼Œæ­¤æ—¶æˆ‘ä»¬å°±å¯ä»¥æ‹¿åˆ°ç»“æ„ä½“çš„å†…éƒ¨çš„å€¼ã€‚<br>ä¸‹è¾¹ä»£ç æ˜¯æˆ‘ä»¬è‡ªå®šä¹‰çš„å€¼ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;  Header.h</span><br><span class="line">&#x2F;&#x2F;  day02-ç±»çš„æœ¬è´¨1</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F;  Created by Charlie on 2019&#x2F;7&#x2F;2.</span><br><span class="line">&#x2F;&#x2F;  Copyright Â© 2019 www.fgyong.cn. All rights reserved.</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line"></span><br><span class="line">#ifndef Header_h</span><br><span class="line">#define Header_h</span><br><span class="line"></span><br><span class="line">#import &lt;Foundation&#x2F;Foundation.h&gt;</span><br><span class="line">#import &lt;objc&#x2F;runtime.h&gt;</span><br><span class="line"></span><br><span class="line"># if __arm64__</span><br><span class="line">#   define ISA_MASK        0x0000000ffffffff8ULL</span><br><span class="line"># elif __x86_64__</span><br><span class="line">#   define ISA_MASK        0x00007ffffffffff8ULL</span><br><span class="line"># endif</span><br><span class="line"></span><br><span class="line">#if __LP64__</span><br><span class="line">typedef uint32_t mask_t;</span><br><span class="line">#else</span><br><span class="line">typedef uint16_t mask_t;</span><br><span class="line">#endif</span><br><span class="line">typedef uintptr_t cache_key_t;</span><br><span class="line"></span><br><span class="line">struct bucket_t &#123;</span><br><span class="line">cache_key_t _key;</span><br><span class="line">IMP _imp;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct cache_t &#123;</span><br><span class="line">bucket_t *_buckets;</span><br><span class="line">mask_t _mask;</span><br><span class="line">mask_t _occupied;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct entsize_list_tt &#123;</span><br><span class="line">uint32_t entsizeAndFlags;</span><br><span class="line">uint32_t count;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct method_t &#123;</span><br><span class="line">SEL name;</span><br><span class="line">const char *types;</span><br><span class="line">IMP imp;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct method_list_t : entsize_list_tt &#123;</span><br><span class="line">method_t first;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct ivar_t &#123;</span><br><span class="line">int32_t *offset;</span><br><span class="line">const char *name;</span><br><span class="line">const char *type;</span><br><span class="line">uint32_t alignment_raw;</span><br><span class="line">uint32_t size;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct ivar_list_t : entsize_list_tt &#123;</span><br><span class="line">ivar_t first;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct property_t &#123;</span><br><span class="line">const char *name;</span><br><span class="line">const char *attributes;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct property_list_t : entsize_list_tt &#123;</span><br><span class="line">property_t first;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct chained_property_list &#123;</span><br><span class="line">chained_property_list *next;</span><br><span class="line">uint32_t count;</span><br><span class="line">property_t list[0];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">typedef uintptr_t protocol_ref_t;</span><br><span class="line">struct protocol_list_t &#123;</span><br><span class="line">uintptr_t count;</span><br><span class="line">protocol_ref_t list[0];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct class_ro_t &#123;</span><br><span class="line">uint32_t flags;</span><br><span class="line">uint32_t instanceStart;</span><br><span class="line">uint32_t instanceSize;  &#x2F;&#x2F; instanceå¯¹è±¡å ç”¨çš„å†…å­˜ç©ºé—´</span><br><span class="line">#ifdef __LP64__</span><br><span class="line">uint32_t reserved;</span><br><span class="line">#endif</span><br><span class="line">const uint8_t * ivarLayout;</span><br><span class="line">const char * name;  &#x2F;&#x2F; ç±»å</span><br><span class="line">method_list_t * baseMethodList;</span><br><span class="line">protocol_list_t * baseProtocols;</span><br><span class="line">const ivar_list_t * ivars;  &#x2F;&#x2F; æˆå‘˜å˜é‡åˆ—è¡¨</span><br><span class="line">const uint8_t * weakIvarLayout;</span><br><span class="line">property_list_t *baseProperties;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">struct class_rw_t &#123;</span><br><span class="line">uint32_t flags;</span><br><span class="line">uint32_t version;</span><br><span class="line">const class_ro_t *ro;</span><br><span class="line">method_list_t * methods;    &#x2F;&#x2F; æ–¹æ³•åˆ—è¡¨</span><br><span class="line">property_list_t *properties;    &#x2F;&#x2F; å±æ€§åˆ—è¡¨</span><br><span class="line">const protocol_list_t * protocols;  &#x2F;&#x2F; åè®®åˆ—è¡¨</span><br><span class="line">Class firstSubclass;</span><br><span class="line">Class nextSiblingClass;</span><br><span class="line">char *demangledName;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#define FAST_DATA_MASK          0x00007ffffffffff8UL</span><br><span class="line">struct class_data_bits_t &#123;</span><br><span class="line">uintptr_t bits;</span><br><span class="line">public:</span><br><span class="line">class_rw_t* data() &#123; &#x2F;&#x2F; æä¾›data()æ–¹æ³•è¿›è¡Œ &amp; FAST_DATA_MASK æ“ä½œ</span><br><span class="line">return (class_rw_t *)(bits &amp; FAST_DATA_MASK);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;* OCå¯¹è±¡ *&#x2F;</span><br><span class="line">struct xx_objc_object &#123;</span><br><span class="line">void *isa;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#x2F;* ç±»å¯¹è±¡ *&#x2F;</span><br><span class="line">struct fy_objc_class : xx_objc_object &#123;</span><br><span class="line">Class superclass;</span><br><span class="line">cache_t cache;</span><br><span class="line">class_data_bits_t bits;</span><br><span class="line">public:</span><br><span class="line">class_rw_t* data() &#123;</span><br><span class="line">return bits.data();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fy_objc_class* metaClass() &#123; &#x2F;&#x2F; æä¾›metaClasså‡½æ•°ï¼Œè·å–å…ƒç±»å¯¹è±¡</span><br><span class="line">&#x2F;&#x2F; ä¸Šä¸€ç¯‡æˆ‘ä»¬è®²è§£è¿‡ï¼ŒisaæŒ‡é’ˆéœ€è¦ç»è¿‡ä¸€æ¬¡ &amp; ISA_MASKæ“ä½œä¹‹åæ‰å¾—åˆ°çœŸæ­£çš„åœ°å€</span><br><span class="line">return (fy_objc_class *)((long long)isa &amp; ISA_MASK);</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">#endif &#x2F;* Header_h *&#x2F;</span><br></pre></td></tr></table></figure><p>è¿™æ®µä»£ç äº²æµ‹å¯ç”¨ï¼Œç›´æ¥å¤åˆ¶è‡ªå·±æ–°å»º<code>.h</code>æ–‡ä»¶å¯¼å…¥â€™main.mâ€™å³å¯ï¼Œå°†<code>main.m</code>æ”¹æˆ<code>main.mm</code>æˆ–è€…å°†å…¶ä»–æŸä¸€ä¸ª<code>.m</code>æ”¹æˆ<code>.mm</code>è¿è¡Œå°±å¯ä»¥è¿è¡Œäº†ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å†æ‹¿å‡ºæ¥ç»å…¸çš„é‚£å¼ å›¾æŒ¨ç€åˆ†æ<code>isa</code> å’Œ<code>superclass</code>çš„æŒ‡å‘</p><p><img src="/images/2-2.png" alt></p><h4 id="instance-å¯¹è±¡éªŒè¯"><a href="#instance-å¯¹è±¡éªŒè¯" class="headerlink" title="instance å¯¹è±¡éªŒè¯"></a>instance å¯¹è±¡éªŒè¯</h4><p>ä½¿ç”¨ <code>p/x</code>è¾“å‡º<code>obj</code>16è¿›åˆ¶çš„åœ°å€ï¼Œç„¶å<strong>isaæŒ‡é’ˆéœ€è¦ç»è¿‡ä¸€æ¬¡ &amp; ISA_MASKæ“ä½œä¹‹åæ‰å¾—åˆ°çœŸæ­£çš„åœ°å€</strong>ã€‚å®æ–½ä¹‹åï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;object</span><br><span class="line"></span><br><span class="line">Printing description of student:</span><br><span class="line">&lt;Student: 0x1021729c0&gt;</span><br><span class="line">(lldb) p&#x2F;x object-&gt;isa &#x2F;&#x2F;æŸ¥çœ‹isaæŒ‡é’ˆåœ°å€</span><br><span class="line">(Class) $0 &#x3D; 0x001dffff8e3ba141 NSObject </span><br><span class="line">(lldb) p&#x2F;x objectClass&#x2F;&#x2F;è¾“å‡º objectClassçš„åœ°å€</span><br><span class="line">(fy_objc_class *) $1 &#x3D; 0x00007fff8e3ba140</span><br><span class="line">(lldb) p&#x2F;x 0x001dffff8e3ba141&amp;0x00007ffffffffff8&#x2F;&#x2F;è®¡ç®—å¾—å‡ºobject-&gt;isaçœŸæ­£çš„åœ°å€</span><br><span class="line">(long) $2 &#x3D; 0x00007fff8e3ba140 &#x2F;&#x2F;0x00007fff8e3ba140æ˜¯ objectClassåœ°å€å’Œobject-&gt;isaåœ°å€ä¸€æ ·</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;person</span><br><span class="line"></span><br><span class="line">Printing description of person: &lt;Person: 0x102175300&gt;</span><br><span class="line">(lldb) p&#x2F;x person-&gt;isa</span><br><span class="line">(Class) $3 &#x3D; 0x001d800100002469 Person</span><br><span class="line">(lldb) p&#x2F;x 0x001d800100002469&amp;0x00007ffffffffff8</span><br><span class="line">(long) $4 &#x3D; 0x0000000100002468</span><br><span class="line">(lldb) p&#x2F;x personClass</span><br><span class="line">(fy_objc_class *) $5 &#x3D; 0x0000000100002468&#x2F;&#x2F;isa å’Œpersonclassåœ°å€éƒ½æ˜¯0x0000000100002468</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;student</span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;x student-&gt;isa</span><br><span class="line">(Class) $6 &#x3D; 0x001d8001000024b9 Student</span><br><span class="line">(lldb) p&#x2F;x 0x001d8001000024b9&amp;0x00007ffffffffff8</span><br><span class="line">(long) $7 &#x3D; 0x00000001000024b8</span><br><span class="line">(lldb) p&#x2F;x studentClass</span><br><span class="line">(fy_objc_class *) $8 &#x3D; 0x00000001000024b8&#x2F;&#x2F;studentclass å’Œisaåœ°å€éƒ½æ˜¯0x00000001000024b8</span><br><span class="line">(lldb)</span><br></pre></td></tr></table></figure><p>ä»é¢çš„è¾“å‡ºç»“æœä¸­æˆ‘ä»¬å¯ä»¥å‘ç°instanceå¯¹è±¡ä¸­ç¡®å®å­˜å‚¨äº†isaæŒ‡é’ˆå’Œå…¶æˆå‘˜å˜é‡ï¼ŒåŒæ—¶å°†instanceå¯¹è±¡çš„isaæŒ‡é’ˆç»è¿‡&amp;è¿ç®—ä¹‹åè®¡ç®—å‡ºçš„åœ°å€ç¡®å®æ˜¯å…¶ç›¸åº”ç±»å¯¹è±¡çš„å†…å­˜åœ°å€ã€‚ç”±æ­¤æˆ‘ä»¬è¯æ˜isaï¼ŒsuperclassæŒ‡å‘å›¾ä¸­çš„1ï¼Œ2ï¼Œ3å·çº¿ã€‚</p><h4 id="class-å¯¹è±¡éªŒè¯"><a href="#class-å¯¹è±¡éªŒè¯" class="headerlink" title="class å¯¹è±¡éªŒè¯"></a>class å¯¹è±¡éªŒè¯</h4><p>æ¥ç€æˆ‘ä»¬æ¥çœ‹<code>class</code>å¯¹è±¡ï¼ŒåŒæ ·é€šè¿‡ä¸Šä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘ä»¬æ˜ç¡®<code>class</code>å¯¹è±¡ä¸­å­˜å‚¨ç€<code>isa</code>æŒ‡é’ˆï¼Œ<code>superclass</code>æŒ‡é’ˆï¼Œä»¥åŠç±»çš„å±æ€§ä¿¡æ¯ï¼Œç±»çš„æˆå‘˜å˜é‡ä¿¡æ¯ï¼Œç±»çš„å¯¹è±¡æ–¹æ³•ï¼Œå’Œç±»çš„åè®®ä¿¡æ¯ï¼Œè€Œé€šè¿‡ä¸Šé¢å¯¹<code>object</code>æºç çš„åˆ†æï¼Œæˆ‘ä»¬çŸ¥é“è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨<code>class</code>å¯¹è±¡çš„<code>class_rw_t</code>ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡å¼ºåˆ¶è½¬åŒ–æ¥çª¥æ¢å…¶ä¸­çš„å†…å®¹</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;objectClass and objectMetaClass</span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;x objectClass-&gt;isa</span><br><span class="line">(__NSAtom *) $6 &#x3D; 0x001dffff8e3ba0f1</span><br><span class="line">(lldb) p&#x2F;x 0x001dffff8e3ba0f1&amp;0x00007ffffffffff8</span><br><span class="line">(long) $7 &#x3D; 0x00007fff8e3ba0f0</span><br><span class="line">(lldb) p&#x2F;x objectMetaClass</span><br><span class="line">(fy_objc_class *) $8 &#x3D; 0x00007fff8e3ba0f0</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;personClass and personMetaClass</span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;x personClass-&gt;isa</span><br><span class="line">(__NSAtom *) $9 &#x3D; 0x001d800100002441</span><br><span class="line">(lldb) p&#x2F;x personMetaClass</span><br><span class="line">(fy_objc_class *) $10 &#x3D; 0x0000000100002440</span><br><span class="line">(lldb) p&#x2F;x 0x001d800100002441&amp;0x00007ffffffffff8</span><br><span class="line">(long) $11 &#x3D; 0x0000000100002440</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;sutdentClass and studentMetaClass</span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;x studentClass-&gt;isa</span><br><span class="line">(__NSAtom *) $12 &#x3D; 0x001d800100002491</span><br><span class="line">(lldb) p&#x2F;x 0x001d800100002491&amp;0x00007ffffffffff8</span><br><span class="line">(long) $13 &#x3D; 0x0000000100002490</span><br><span class="line">(lldb) p&#x2F;x studentMetaClass</span><br><span class="line">(fy_objc_class *) $14 &#x3D; 0x0000000100002490</span><br></pre></td></tr></table></figure><p>æœ‰æ­¤ç»“æœå¾—çŸ¥<code>objectMetaClass==objectClass-&gt;isa==0x00007fff8e3ba0f0</code>,<code>personClass-&gt;isa==personMetaClass==0x0000000100002440</code>,<code>studentClass-&gt;isa==studentMetaClass==0x0000000100002490</code>ã€‚<br>ç”±æ­¤æˆ‘ä»¬è¯æ˜isaï¼ŒsuperclassæŒ‡å‘å›¾ä¸­ï¼ŒisaæŒ‡é’ˆçš„4ï¼Œ5ï¼Œ6å·çº¿ï¼Œä»¥åŠsuperclassæŒ‡é’ˆçš„7,8,9å·çº¿ã€‚</p><h4 id="meta-classå¯¹è±¡éªŒè¯"><a href="#meta-classå¯¹è±¡éªŒè¯" class="headerlink" title="meta-classå¯¹è±¡éªŒè¯"></a>meta-classå¯¹è±¡éªŒè¯</h4><p>æœ€åæˆ‘ä»¬æ¥çœ‹<code>meta-class</code>å…ƒç±»å¯¹è±¡ï¼Œä¸Šæ–‡æåˆ°<code>meta-class</code>ä¸­å­˜å‚¨ç€<code>isa</code>æŒ‡é’ˆï¼Œ<code>superclass</code>æŒ‡é’ˆï¼Œä»¥åŠç±»çš„ç±»æ–¹æ³•ä¿¡æ¯ã€‚åŒæ—¶æˆ‘ä»¬çŸ¥é“<code>meta-class</code>å…ƒç±»å¯¹è±¡ä¸<code>class</code>ç±»å¯¹è±¡ï¼Œå…·æœ‰ç›¸åŒçš„ç»“æ„ï¼Œåªä¸è¿‡å­˜å‚¨çš„ä¿¡æ¯ä¸åŒï¼Œå¹¶ä¸”å…ƒç±»å¯¹è±¡çš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘åŸºç±»çš„å…ƒç±»å¯¹è±¡ï¼ŒåŸºç±»çš„å…ƒç±»å¯¹è±¡çš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘è‡ªå·±ã€‚å…ƒç±»å¯¹è±¡çš„<code>superclass</code>æŒ‡é’ˆæŒ‡å‘å…¶çˆ¶ç±»çš„å…ƒç±»å¯¹è±¡ï¼ŒåŸºç±»çš„å…ƒç±»å¯¹è±¡çš„<code>superclass</code>æŒ‡é’ˆæŒ‡å‘å…¶ç±»å¯¹è±¡ã€‚<br>ä¸<code>class</code>å¯¹è±¡ç›¸åŒï¼Œæˆ‘ä»¬åŒæ ·é€šè¿‡æ¨¡æ‹Ÿå¯¹<code>person</code>å…ƒç±»å¯¹è±¡è°ƒç”¨<code>.data</code>å‡½æ•°ï¼Œå³å¯¹<code>bits</code>è¿›è¡Œ<code>&amp;FAST_DATA_MASK(0x00007ffffffffff8UL)</code>è¿ç®—ï¼Œå¹¶è½¬åŒ–ä¸º<code>class_rw_t</code>ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; objectMetaClass-&gt;superclass &#x3D; 0x00007fff8e3ba140  NSObject</span><br><span class="line">&#x2F;&#x2F;objectMetaClass-&gt;isa &#x3D;   0x00007fff8e3ba0f0</span><br><span class="line">&#x2F;&#x2F;objectMetaClass &#x3D; 0x00007fff8e3ba0f0</span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;x objectMetaClass-&gt;superclass</span><br><span class="line">(Class) $20 &#x3D; 0x00007fff8e3ba140 NSObject</span><br><span class="line">(lldb) p&#x2F;x objectMetaClass-&gt;isa</span><br><span class="line">(__NSAtom *) $21 &#x3D; 0x001dffff8e3ba0f1</span><br><span class="line">(lldb) p&#x2F;x 0x001dffff8e3ba0f1&amp;0x00007ffffffffff8</span><br><span class="line">(long) $22 &#x3D; 0x00007fff8e3ba0f0</span><br><span class="line">(lldb) p&#x2F;x objectMetaClass</span><br><span class="line">(fy_objc_class *) $23 &#x3D; 0x00007fff8e3ba0f0</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; personMetaClass-&gt;superclas&#x3D;0x00007fff8e3ba0f0</span><br><span class="line">&#x2F;&#x2F;personMetaClass-&gt;isa&#x3D;0x00007fff8e3ba0f0</span><br><span class="line">&#x2F;&#x2F;personMetaClass &#x3D; 0x0000000100002440</span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;x personMetaClass-&gt;superclass</span><br><span class="line">(Class) $25 &#x3D; 0x00007fff8e3ba0f0</span><br><span class="line">(lldb) p&#x2F;x personMetaClass-&gt;isa</span><br><span class="line">(__NSAtom *) $26 &#x3D; 0x001dffff8e3ba0f1</span><br><span class="line">(lldb) p&#x2F;x personMetaClass</span><br><span class="line">(fy_objc_class *) $30 &#x3D; 0x0000000100002440</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; studentMetaClass-&gt;superclas&#x3D;0x0000000100002440</span><br><span class="line">&#x2F;&#x2F;studentMetaClass-&gt;isa&#x3D;0x00007fff8e3ba0f0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(lldb) p&#x2F;x studentMetaClass-&gt;superclass</span><br><span class="line">(Class) $27 &#x3D; 0x0000000100002440</span><br><span class="line">(lldb) p&#x2F;x studentMetaClass-&gt;isa</span><br><span class="line">(__NSAtom *) $28 &#x3D; 0x001dffff8e3ba0f1</span><br><span class="line">(lldb) p&#x2F;x 0x001dffff8e3ba0f1 &amp; 0x00007ffffffffff8</span><br><span class="line">(long) $29 &#x3D; 0x00007fff8e3ba0f0</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šé¢å¯ä»¥çœ‹å‡ºï¼Œ<code>studentMetaClass-&gt;isa</code>,<code>personMetaClass-&gt;isa</code>,<code>objectMetaClass-&gt;isa</code>ç»“æœ<code>mask</code>ä¹‹åéƒ½æ˜¯<code>0x00007fff8e3ba0f0</code>ï¼Œä¸<code>p/x objectMetaClass</code>ç»“æœä¸€è‡´ï¼Œåˆ™éªŒè¯äº†13ï¼Œ14ï¼Œ15å·çº¿ï¼Œ<code>studentMetaClass-&gt;superclass =0x0000000100002440</code>,<code>personMetaClass = 0x0000000100002440</code>éªŒè¯12å·çº¿ï¼Œ<code>personMetaClass-&gt;isa=0x00007fff8e3ba0f0</code>å’Œ<code>objectMetaClass = 0x00007fff8e3ba0f0</code>éªŒè¯äº†11å·çº¿ï¼Œ<code>objectMetaClass-&gt;superclass = 0x00007fff8e3ba140  NSObject</code>éªŒè¯10å·çº¿ã€‚</p><h4 id="æ€»ç»“ï¼š"><a href="#æ€»ç»“ï¼š" class="headerlink" title="æ€»ç»“ï¼š"></a>æ€»ç»“ï¼š</h4><p>å¯¹è±¡çš„isaæŒ‡å‘å“ªé‡Œï¼Ÿ</p><ul><li>instanceå¯¹è±¡çš„isaæŒ‡å‘classå¯¹è±¡</li><li>classå¯¹è±¡çš„isaæŒ‡å‘meta-classå¯¹è±¡</li><li>meta-classå¯¹è±¡çš„isaæŒ‡å‘åŸºç±»çš„meta-classå¯¹è±¡</li><li>classå’Œmeta-classçš„å†…å­˜ç»“æ„ä¸€æ ·çš„ï¼Œåªæ˜¯å€¼ä¸ä¸€æ ·</li></ul><p>OCçš„ç±»ä¿¡æ¯å­˜æ”¾åœ¨å“ªé‡Œï¼Ÿ</p><ul><li>å¯¹è±¡æ–¹æ³•ã€å±æ€§ã€æˆå‘˜å˜é‡ã€åè®®ä¿¡æ¯å­˜æ”¾åœ¨classå¯¹è±¡ä¸­</li><li>ç±»æ–¹æ³•å­˜æ”¾åœ¨meta-classå¯¹è±¡ä¸­</li><li>æˆå‘˜å˜é‡å…·ä½“å€¼å­˜æ”¾åœ¨instanceå¯¹è±¡ä¸­</li></ul><h4 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h4><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo code<i class="fa fa-external-link"></i></span></li></ul><hr><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p><p>æœ¬æ–‡ç« ä¹‹æ‰€ä»¥å›¾ç‰‡æ¯”è¾ƒå°‘ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯è·Ÿç€ä»£ç æ•²ä¸€éï¼Œå°è±¡æ¯”è¾ƒæ·±åˆ»ã€‚</p><p><img src="/images/0.png" alt></p><p>/</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;åº•å±‚åŸç†-ç±»çš„æœ¬è´¨&quot;&gt;&lt;a href=&quot;#åº•å±‚åŸç†-ç±»çš„æœ¬è´¨&quot; class=&quot;headerlink&quot; title=&quot;åº•å±‚åŸç† ç±»çš„æœ¬è´¨&quot;&gt;&lt;/a&gt;åº•å±‚åŸç† ç±»çš„æœ¬è´¨&lt;/h3&gt;&lt;p&gt;å¤ä¹ ä¸€ä¸‹&lt;a href&gt;IOS åº•å±‚åŸç† å¯¹è±¡çš„æœ¬è´¨â€“(1)&lt;/a&gt;ï¼Œå¯ä»¥çœ‹å‡ºæ¥å®ä¾‹
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOSåº•å±‚åŸç†  å¯¹è±¡çš„æœ¬è´¨ --(1)</title>
    <link href="http://fgyong.cn/2019/12/01/IOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%9C%AC%E8%B4%A8--(1)/"/>
    <id>http://fgyong.cn/2019/12/01/IOS%E5%BA%95%E5%B1%82%E5%8E%9F%E7%90%86%20%E5%AF%B9%E8%B1%A1%E7%9A%84%E6%9C%AC%E8%B4%A8--(1)/</id>
    <published>2019-12-01T03:11:58.000Z</published>
    <updated>2020-09-04T04:40:21.651Z</updated>
    
    <content type="html"><![CDATA[<h3 id="å¯¹è±¡çš„æœ¬è´¨"><a href="#å¯¹è±¡çš„æœ¬è´¨" class="headerlink" title="å¯¹è±¡çš„æœ¬è´¨"></a>å¯¹è±¡çš„æœ¬è´¨</h3><p>æ¢å¯»OCå¯¹è±¡çš„æœ¬è´¨ï¼Œæˆ‘ä»¬å¹³æ—¶ç¼–å†™çš„Objective-Cä»£ç ï¼Œåº•å±‚å®ç°å…¶å®éƒ½æ˜¯C\C++ä»£ç ã€‚<br>é‚£ä¹ˆä¸€ä¸ªOCå¯¹è±¡å ç”¨å¤šå°‘å†…å­˜å‘¢ï¼Ÿçœ‹å®Œè¿™ç¯‡æ–‡ç« ä½ å°†äº†è§£OC/å¯¹è±¡çš„å†…å­˜å¸ƒå±€å’Œå†…å­˜åˆ†é…æœºåˆ¶ã€‚</p><p>ä½¿ç”¨çš„<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">ä»£ç ä¸‹è½½<i class="fa fa-external-link"></i></span><br>è¦ç”¨çš„å·¥å…·:</p><ul><li><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2NuL3N1cHBvcnQveGNvZGUv" title="https://developer.apple.com/cn/support/xcode/">Xcode 10.2<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly96aXB6YXBtYWMuY29tL0dvMlNoZWxs" title="https://zipzapmac.com/Go2Shell">gotoShell<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cDovL2Z0cC5nbnUub3JnL2dudS9nbGliYy8=" title="http://ftp.gnu.org/gnu/glibc/">linux-glibc-2.29æºç <i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscy9saWJtYWxsb2Mv" title="https://opensource.apple.com/tarballs/libmalloc/">libmallocæºç <i class="fa fa-external-link"></i></span></li></ul><p>é¦–å…ˆæˆ‘ä»¬ä½¿ç”¨æœ€åŸºæœ¬çš„ä»£ç éªŒè¯å¯¹è±¡æ˜¯ä»€ä¹ˆ?</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">@autoreleasepool &#123;</span><br><span class="line">    &#x2F;&#x2F; insert code here...</span><br><span class="line">NSObject *obj&#x3D;[[NSObject alloc]init];</span><br><span class="line">    NSLog(@&quot;Hello, World!&quot;);</span><br><span class="line">&#125;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>clang</code>ç¼–è¯‘å™¨ç¼–è¯‘æˆ<code>cpp</code>ï¼Œ<br>æ‰§è¡Œ<code>clang -rewrite-objc main.m -o main.cpp</code>ä¹‹åç”Ÿæˆçš„<code>cpp</code>ï¼Œè¿™ä¸ªç”Ÿæˆçš„<code>cpp</code>æˆ‘ä»¬ä¸çŸ¥é“æ˜¯è·‘åœ¨å“ªä¸ªå¹³å°çš„ï¼Œç°åœ¨æˆ‘ä»¬æŒ‡å®š<code>iphoeos</code>å’Œ<code>arm64</code>é‡æ–°ç¼–è¯‘ä¸€ä¸‹ã€‚<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main64.cpp</code>ï¼Œå°†<code>main64.cpp</code>æ‹–æ‹½åˆ°Xcodeä¸­å¹¶æ‰“å¼€ã€‚<br>|clang|ç¼–è¯‘å™¨|<br>|â€”â€”â€”â€”â€“|â€”â€”-|<br>|xcrun|å‘½ä»¤|<br>|sdk|æŒ‡å®šç¼–è¯‘çš„å¹³å°|<br>|arch|arm64æ¶æ„|<br>|-rewrite-objc|é‡å†™|<br>|main.m|é‡å†™çš„æ–‡ä»¶|<br>|main64.cpp|å¯¼å‡ºçš„æ–‡ä»¶|<br>|-o|å¯¼å‡º|</p><p><code>command + F</code>æŸ¥æ‰¾<code>int main</code>,æ‰¾åˆ°å…³é”®ä»£ç ï¼Œè¿™å°±æ˜¯<code>main</code>å‡½æ•°çš„è½¬åŒ–æˆ<code>c/c++</code>çš„ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line"> &#x2F;* @autoreleasepool *&#x2F; &#123; __AtAutoreleasePool __autoreleasepool; </span><br><span class="line"></span><br><span class="line">  NSObject *obj&#x3D;((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)((NSObject *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(&quot;NSObject&quot;), sel_registerName(&quot;alloc&quot;)), sel_registerName(&quot;init&quot;));</span><br><span class="line"></span><br><span class="line">     NSLog((NSString *)&amp;__NSConstantStringImpl__var_folders_c0_7nm4_r7s4xd0mbs67ljb_b8m0000gn_T_main_1b47c1_mi_0);</span><br><span class="line"> &#125;</span><br><span class="line"> return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæœç´¢</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">struct NSObject_IMPL &#123;</span><br><span class="line">Class isa;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¿™ä¸ªç»“æ„ä½“æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br>å…¶å®æˆ‘ä»¬<code>Object-C</code>ç¼–è¯‘ä¹‹åå¯¹è±¡ä¼šç¼–è¯‘æˆç»“æ„ä½“ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š<br><img src="/images/1-1.png" alt><br>é‚£ä¹ˆ<code>isa</code>æ˜¯ä»€ä¹ˆå—ï¼Ÿé€šè¿‡æŸ¥çœ‹æºç å¾—çŸ¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef struct objc_class *Class;</span><br></pre></td></tr></table></figure><p><code>class</code>å…¶å®æ˜¯ä¸€ä¸ªæŒ‡å‘ç»“æ„ä½“çš„æŒ‡é’ˆï¼Œç„¶å<code>com+ç‚¹å‡»class</code>å¾—åˆ°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">struct objc_class &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line"></span><br><span class="line">#if !__OBJC2__</span><br><span class="line">    Class _Nullable super_class                              OBJC2_UNAVAILABLE;</span><br><span class="line">    const char * _Nonnull name                               OBJC2_UNAVAILABLE;</span><br><span class="line">    long version                                             OBJC2_UNAVAILABLE;</span><br><span class="line">    long info                                                OBJC2_UNAVAILABLE;</span><br><span class="line">    long instance_size                                       OBJC2_UNAVAILABLE;</span><br><span class="line">    struct objc_ivar_list * _Nullable ivars                  OBJC2_UNAVAILABLE;</span><br><span class="line">    struct objc_method_list * _Nullable * _Nullable methodLists                    OBJC2_UNAVAILABLE;</span><br><span class="line">    struct objc_cache * _Nonnull cache                       OBJC2_UNAVAILABLE;</span><br><span class="line">    struct objc_protocol_list * _Nullable protocols          OBJC2_UNAVAILABLE;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">&#125; OBJC2_UNAVAILABLE;</span><br></pre></td></tr></table></figure><p><code>class</code>æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆå ç”¨å¤šå°‘å†…å­˜å‘¢ï¼Ÿå¤§å®¶éƒ½çŸ¥é“<strong>æŒ‡é’ˆåœ¨32ä½æ˜¯4å­—èŠ‚ï¼Œåœ¨64ä½æ˜¯8å­—èŠ‚ã€‚</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">NSObject *obj&#x3D;[[NSObject alloc]init];</span><br></pre></td></tr></table></figure><p>å¯ä»¥ç†è§£æˆå®ä¾‹å¯¹è±¡æ˜¯ä¸€ä¸ªæŒ‡é’ˆ,æŒ‡é’ˆå ç”¨8æˆ–è€…4å­—èŠ‚ï¼Œé‚£ä¹ˆæš‚æ—¶å‡è®¾æœºå™¨æ˜¯64ä½ï¼Œè®°ä¸ºå¯¹è±¡å ç”¨8å­—èŠ‚ã€‚<br><code>obj</code>å°±æ˜¯æŒ‡å‘ç»“æ„ä½“<code>class</code>çš„ä¸€ä¸ªæŒ‡é’ˆã€‚<br>é‚£ä¹ˆæˆ‘ä»¬æ¥éªŒè¯ä¸€ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">@autoreleasepool &#123;</span><br><span class="line">    &#x2F;&#x2F; insert code here...</span><br><span class="line">NSObject *obj&#x3D;[[NSObject alloc]init];</span><br><span class="line">&#x2F;&#x2F;è·å¾—NSobjectå¯¹è±¡å®ä¾‹å¤§å°</span><br><span class="line">size_t size &#x3D; class_getInstanceSize(obj.class);</span><br><span class="line">&#x2F;&#x2F;è·å–NSObjetæŒ‡é’ˆçš„æŒ‡å‘çš„å†…å­˜å¤§å°</span><br><span class="line">&#x2F;&#x2F;éœ€è¦å¯¼å…¥ï¼š#import &lt;malloc&#x2F;malloc.h&gt;</span><br><span class="line">size_t size2 &#x3D; malloc_size((__bridge const void *)(obj));</span><br><span class="line">NSLog(@&quot;size:%zu size2:%zu&quot;,size,size2);</span><br><span class="line">&#125;</span><br><span class="line">return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾—å‡ºç»“æœæ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">size:8 size2:16</span><br></pre></td></tr></table></figure><p>ç»“è®ºæ˜¯ï¼š<strong>æŒ‡é’ˆæ˜¯8å­—èŠ‚ï¼ŒæŒ‡é’ˆæŒ‡å‘çš„çš„å†…å­˜å¤§å°ä¸º16å­—èŠ‚ã€‚</strong><br>æŸ¥çœ‹æºç å¾—çŸ¥<code>[[NSObject alloc]init]</code>çš„å‡½æ•°è¿è¡Œé¡ºåºæ˜¯:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">class_createInstance</span><br><span class="line">    -_class_createInstanceFromZone</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">id</span><br><span class="line">_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone, </span><br><span class="line">                              bool cxxConstruct &#x3D; true, </span><br><span class="line">                              size_t *outAllocatedSize &#x3D; nil)</span><br><span class="line">&#123;</span><br><span class="line">    if (!cls) return nil;</span><br><span class="line">    **</span><br><span class="line">    size_t size &#x3D; cls-&gt;instanceSize(extraBytes);</span><br><span class="line">    **</span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‡½æ•°å‰è¾¹åè¾¹çœç•¥ï¼Œå–å‡ºå…³é”®ä»£ç ï¼Œå…¶å®<code>size</code>æ˜¯<code>cls-&gt;instanceSize(extraBytes)</code>æ‰§è¡Œçš„ç»“æœã€‚é‚£ä¹ˆæˆ‘ä»¬å†çœ‹ä¸‹<code>cls-&gt;instanceSize</code>çš„æºç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;æˆå‘˜å˜é‡å¤§å° 8bytes</span><br><span class="line">    uint32_t alignedInstanceSize() &#123;</span><br><span class="line">        return word_align(unalignedInstanceSize());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    size_t instanceSize(size_t extraBytes) &#123;</span><br><span class="line">        size_t size &#x3D; alignedInstanceSize() + extraBytes;</span><br><span class="line">        &#x2F;&#x2F; CF requires all objects be at least 16 bytes.</span><br><span class="line">        if (size &lt; 16) size &#x3D; 16;</span><br><span class="line">        return size;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡æºç æ³¨é‡Šå¾—çŸ¥ï¼šCFè¦æ±‚æ‰€æœ‰çš„objects æœ€å°æ˜¯16bytesã€‚</p><p><code>class_getInstanceSize</code>å‡½æ•°çš„å†…éƒ¨æ‰§è¡Œé¡ºåºæ˜¯<code>class_getInstanceSize-&gt;cls-&gt;alignedInstanceSize()</code><br>æŸ¥é˜…æºç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;æˆå‘˜å˜é‡å¤§å° 8bytes</span><br><span class="line">    uint32_t alignedInstanceSize() &#123;</span><br><span class="line">        return word_align(unalignedInstanceSize());</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><br>æ‰€ä»¥æœ€ç»ˆç»“è®ºæ˜¯ï¼š<strong>å¯¹è±¡æŒ‡é’ˆå®é™…å¤§å°ä¸º8bytesï¼Œå†…å­˜åˆ†é…ä¸º16bytesï¼Œå…¶å®æ˜¯ç©ºå‡ºäº†8bytes</strong>ã€‚</p><p>éªŒè¯ï¼š<br>åœ¨åˆšæ‰ çš„ä»£ç æ‰“æ–­ç‚¹å’Œè®¾ç½®<code>Debug-&gt;Debug Workflow-&gt;View Memory</code>,ç„¶åè¿è¡Œç¨‹åºï¼Œ</p><p><img src="/images/1-2.png" alt></p><p><img src="/images/1-3.png" alt><br>ç‚¹å‡»<code>obj-&gt;view *objc</code>å¾—åˆ°ä¸Šå›¾æ‰€ç¤ºçš„å†…å­˜å¸ƒå±€ï¼Œä»<code>address</code>çœ‹å‡ºå’Œ<code>obj</code>å†…å­˜ä¸€æ ·ï¼Œå·¦ä¸Šè§’æ˜¯16å­—èŠ‚ï¼Œ8ä¸ªå­—èŠ‚æœ‰æ•°æ®ï¼Œ8ä¸ªå­—èŠ‚æ˜¯ç©ºçš„ï¼Œé»˜è®¤æ˜¯0.</p><p>ä½¿ç”¨lldbå‘½ä»¤<code>memory read 0x100601f30</code>è¾“å‡ºå†…å­˜å¸ƒå±€ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="/images/1-4.png" alt><br>æˆ–è€…ä½¿ç”¨<code>x/4xg 0x100601f30</code>è¾“å‡ºï¼š</p><p><img src="/images/1-5.png" alt><br><code>x/4xg 0x100601f30</code>ä¸­<code>4</code>æ˜¯è¾“å‡º<code>4</code>ä¸ªæ•°æ®,<code>x</code> æ˜¯16è¿›åˆ¶,åè¾¹<code>g</code>æ˜¯8å­—èŠ‚ä¸ºå•ä½ã€‚å¯ä»¥éªŒè¯åˆšæ‰çš„å‡ºçš„ç»“è®ºã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å†ä½¿ç”¨å¤æ‚çš„ä¸€ä¸ªå¯¹è±¡æ¥éªŒè¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@interface Person : NSObject</span><br><span class="line">&#123;</span><br><span class="line">int _age;</span><br><span class="line">int _no;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><br>ä½¿ç”¨<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc main.m -o main64.cpp</code>ç¼–è¯‘ä¹‹åå¯¹åº”çš„æºç æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct NSObject_IMPL &#123;</span><br><span class="line"> Class isa;</span><br><span class="line">&#125;;</span><br><span class="line">struct Person_IMPL &#123;</span><br><span class="line">struct NSObject_IMPL NSObject_IVARS;&#x2F;&#x2F; 8 bytes</span><br><span class="line">int _age;&#x2F;&#x2F;4 bytes</span><br><span class="line">int _no;&#x2F;&#x2F;4 bytes</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p><code>Personâ€”â€”IMPL</code><strong>ç»“æ„ä½“å ç”¨16bytes</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Person *obj&#x3D;[[Person alloc]init];</span><br><span class="line">obj-&gt;_age &#x3D; 15;</span><br><span class="line">obj-&gt;_no &#x3D; 14;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä»£ç éªŒè¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Person *obj&#x3D;[[Person alloc]init];</span><br><span class="line">obj-&gt;_age &#x3D; 15;</span><br><span class="line">obj-&gt;_no &#x3D; 14;</span><br><span class="line"></span><br><span class="line">struct Person_IMPL *p &#x3D;(__bridge struct Person_IMPL*)obj;</span><br><span class="line">NSLog(@&quot;age:%d no:%d&quot;,p-&gt;_age,p-&gt;_no);</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;age:15 no:14</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨å†…å­˜å¸ƒå±€éªŒè¯ï¼š</p><p><img src="/images/1-6.png" alt><br>ä»¥åè¿›åˆ¶è¾“å‡ºæ¯ä¸ª4å­—èŠ‚<br><img src="/images/1-7.png" alt><br>ä½¿ç”¨å†…å­˜å¸ƒå±€æŸ¥çœ‹æ•°æ®éªŒè¯ï¼Œ<code>Person</code>å ç”¨16 bytesã€‚</p><p>ä¸‹è¾¹æ˜¯ä¸€ä¸ªç›´è§‚çš„å†…å­˜å¸ƒå±€å›¾ï¼š</p><p><img src="/images/1-8.png" alt></p><h4 id="å†çœ‹ä¸€ä¸‹æ›´å¤æ‚çš„ç»§æ‰¿å…³ç³»çš„å†…å­˜å¸ƒå±€ï¼š"><a href="#å†çœ‹ä¸€ä¸‹æ›´å¤æ‚çš„ç»§æ‰¿å…³ç³»çš„å†…å­˜å¸ƒå±€ï¼š" class="headerlink" title="å†çœ‹ä¸€ä¸‹æ›´å¤æ‚çš„ç»§æ‰¿å…³ç³»çš„å†…å­˜å¸ƒå±€ï¼š"></a>å†çœ‹ä¸€ä¸‹æ›´å¤æ‚çš„ç»§æ‰¿å…³ç³»çš„å†…å­˜å¸ƒå±€ï¼š</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@interface Person : NSObject</span><br><span class="line">&#123;</span><br><span class="line">@public</span><br><span class="line">int _age;&#x2F;&#x2F;4bytes </span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">@implementation Person</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;Student</span><br><span class="line">@interface Student : Person</span><br><span class="line">&#123;</span><br><span class="line">@public</span><br><span class="line">int _no;&#x2F;&#x2F;4bytes</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">@implementation Student</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><p>é‚£å°ä¼™ä¼´å¯èƒ½è¦è¯´è¿™ä¸€å®šæ˜¯32å­—èŠ‚ï¼Œå› ä¸º<code>Person</code>ä¸Šè¾¹å·²ç»è¯æ˜æ˜¯16å­—èŠ‚ï¼Œ<code>Student</code>åˆå¤šäº†ä¸ªæˆå‘˜å˜é‡<code>_no</code>ï¼Œç”±äºå†…å­˜å¯¹é½ï¼Œä¸€å®šæ˜¯16çš„æ•´å€æ•°ï¼Œé‚£å°±æ˜¯16+16=32å­—èŠ‚ã€‚<br>å…¶å®ä¸ç„¶ï¼Œ<code>Person</code>æ˜¯å†…å­˜åˆ†é…16å­—èŠ‚ï¼Œå…¶å®å ç”¨äº†8+4=12å­—èŠ‚ï¼Œå‰©ä½™4å­—èŠ‚ä½å­ç©ºç€è€Œå·²ï¼Œ<code>Student</code>æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œä¸å¯èƒ½åœ¨æˆå‘˜å˜é‡å’ŒæŒ‡é’ˆä¸­é—´æœ‰å†…å­˜å¯¹é½çš„ï¼Œå‚æ•°å’ŒæŒ‡é’ˆæ˜¯å¯¹è±¡æŒ‡é’ˆ+åç§»é‡å¾—å‡ºæ¥çš„ï¼Œå¤šä¸ªä¸åŒçš„å¯¹è±¡æ‰ä¼šå­˜åœ¨å†…å­˜å¯¹é½ã€‚æ‰€ä»¥<code>Student</code>æ˜¯å ç”¨äº†16å­—èŠ‚ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬æ¥è¯æ˜ä¸€ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Student *obj&#x3D;[[Student alloc]init];</span><br><span class="line">obj-&gt;_age &#x3D; 6;</span><br><span class="line">obj-&gt;_no &#x3D; 7;</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è·å¾—NSobjectå¯¹è±¡å®ä¾‹æˆå‘˜å˜é‡å ç”¨çš„å¤§å° -&gt;8</span><br><span class="line">size_t size &#x3D; class_getInstanceSize(obj.class);</span><br><span class="line">&#x2F;&#x2F;è·å–NSObjetæŒ‡é’ˆçš„æŒ‡å‘çš„å†…å­˜å¤§å° -&gt;16</span><br><span class="line">size_t size2 &#x3D; malloc_size((__bridge const void *)(obj));</span><br><span class="line">NSLog(@&quot;size:%zu size2:%zu&quot;,size,size2);</span><br><span class="line">&#x2F;&#x2F;size:16 size2:16</span><br></pre></td></tr></table></figure><p>å†çœ‹ä¸€ä¸‹LLDBæŸ¥çœ‹çš„å†…å­˜å¸ƒå±€ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">(lldb) x&#x2F;8xw 0x10071ae30</span><br><span class="line">0x10071ae30: 0x00001299 0x001d8001 0x00000006 0x00000007</span><br><span class="line">0x10071ae40: 0xa0090000 0x00000007 0x8735e0b0 0x00007fff</span><br><span class="line"></span><br><span class="line">(lldb) memory read 0x10071ae30</span><br><span class="line">0x10071ae30: 99 12 00 00 01 80 1d 00 06 00 00 00 07 00 00 00  ................</span><br><span class="line">0x10071ae40: 00 00 09 a0 07 00 00 00 b0 e0 35 87 ff 7f 00 00  ..........5.....</span><br><span class="line"></span><br><span class="line">(lldb) x&#x2F;4xg 0x10071ae30</span><br><span class="line">0x10071ae30: 0x001d800100001299 0x0000000700000006</span><br><span class="line">0x10071ae40: 0x00000007a0090000 0x00007fff8735e0b0</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºæ¥<code>0x00000006</code>å’Œ<code>0x00000007</code>å°±æ˜¯ä¸¤ä¸ªæˆå‘˜å˜é‡çš„å€¼ï¼Œå ç”¨å†…å­˜æ˜¯16å­—èŠ‚ã€‚</p><p>æˆ‘ä»¬å°†<code>Student</code>æ–°å¢ä¸€ä¸ªæˆå‘˜å˜é‡ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;Student</span><br><span class="line">@interface Student : Person</span><br><span class="line">&#123;</span><br><span class="line">@public</span><br><span class="line">int _no;&#x2F;&#x2F;4bytes</span><br><span class="line">int _no2;&#x2F;&#x2F;4bytes</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">@implementation Student</span><br><span class="line">@end</span><br></pre></td></tr></table></figure><br>ç„¶åæŸ¥çœ‹å†…å­˜å¸ƒå±€ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">(lldb) x&#x2F;8xg 0x102825db0</span><br><span class="line">0x102825db0: 0x001d8001000012c1 0x0000000700000006</span><br><span class="line">0x102825dc0: 0x0000000000000000 0x0000000000000000</span><br><span class="line">0x102825dd0: 0x001dffff8736ae71 0x0000000100001f80</span><br><span class="line">0x102825de0: 0x0000000102825c60 0x0000000102825890</span><br></pre></td></tr></table></figure><br>ä»<code>LLDB</code>å¯ä»¥çœ‹å‡ºæ¥ï¼Œ<strong>å†…å­˜å˜æˆäº†32å­—èŠ‚ã€‚(0x102825dd0-0x102825db0=0x20)</strong></p><p>æˆ‘ä»¬å†å¢åŠ ä¸€ä¸ªå±æ€§çœ‹ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@interface Person : NSObject</span><br><span class="line">&#123;</span><br><span class="line">@public</span><br><span class="line">int _age;&#x2F;&#x2F;4bytes </span><br><span class="line">&#125;</span><br><span class="line">@property (nonatomic,assign) int level; &#x2F;&#x2F;4å­—èŠ‚</span><br><span class="line">@end</span><br><span class="line">@implementation Person</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;InstanceSize:16 malloc_size:16</span><br></pre></td></tr></table></figure><br>ä¸ºä»€ä¹ˆæ–°å¢äº†ä¸€ä¸ªå±æ€§ï¼Œå†…å­˜è¿˜æ˜¯å’Œæ²¡æœ‰æ–°å¢çš„æ—¶å€™ä¸€æ ·å‘¢ï¼Ÿ<br>å› ä¸º<code>property</code>=<code>setter</code>+<code>getter</code>+<code>ivar</code>,<code>method</code>æ˜¯å­˜åœ¨ç±»å¯¹è±¡ä¸­çš„ï¼Œæ‰€ä»¥å®ä¾‹<code>Person</code>å ç”¨çš„å†…å­˜è¿˜æ˜¯<code>_age</code>,<code>_level</code>å’Œä¸€ä¸ªæŒ‡å‘ç±»çš„æŒ‡é’ˆï¼Œæœ€åç»“æœæ˜¯<code>4+4+8=16bytes</code>ã€‚</p><p>å†çœ‹ä¸‹æˆå‘˜å˜é‡æ˜¯3ä¸ªçš„æ—¶å€™æ˜¯å¤šå°‘å‘¢ï¼Ÿçœ‹ç»“æœä¹‹å‰å…ˆçŒœæµ‹ä¸€ä¸‹ï¼šä¸‰ä¸ª<code>int</code>æˆå‘˜å˜é‡æ˜¯12ï¼Œä¸€ä¸ªæŒ‡é’ˆæ˜¯8ï¼Œæœ€åæ˜¯20ï¼Œç”±äºå†…å­˜æ˜¯8çš„å€æ•°ï¼Œæ‰€ä»¥æ˜¯24ã€‚</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">@interface Person : NSObject</span><br><span class="line">&#123;</span><br><span class="line">@public</span><br><span class="line">int _age;&#x2F;&#x2F;4bytes</span><br><span class="line">int _level;&#x2F;&#x2F;4bytes</span><br><span class="line">int _code;&#x2F;&#x2F;4bytes</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">@implementation Person</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">Person *obj&#x3D;[[Person alloc]init];</span><br><span class="line">obj-&gt;_age &#x3D; 6;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;è·å¾—NSobjectå¯¹è±¡å®ä¾‹æˆå‘˜å˜é‡å ç”¨çš„å¤§å° -&gt;24</span><br><span class="line">Class ocl &#x3D; obj.class;</span><br><span class="line">size_t size &#x3D; class_getInstanceSize(ocl);</span><br><span class="line">&#x2F;&#x2F;è·å–NSObjetæŒ‡é’ˆçš„æŒ‡å‘çš„å†…å­˜å¤§å° -&gt;32</span><br><span class="line">size_t size2 &#x3D; malloc_size((__bridge const void *)(obj));</span><br><span class="line">printf(&quot;InstanceSize:%zu malloc_size:%zu \n&quot;,size,size2);</span><br><span class="line"></span><br><span class="line">InstanceSize:24 malloc_size:32</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆå’Œæˆ‘ä»¬çŒœæµ‹çš„ä¸ä¸€æ ·å‘¢ï¼Ÿ<br>é‚£ä¹ˆæˆ‘ä»¬å†æ¢ç©¶ä¸€ä¸‹ï¼š<br>å®ä¾‹å¯¹è±¡å ç”¨å¤šå°‘å†…å­˜ï¼Œå½“ç„¶æ˜¯åœ¨ç”³è¯·å†…å­˜çš„æ—¶å€™åˆ›å»ºçš„ï¼Œåˆ™æŸ¥æ‰¾æºç <code>NSObject.mm 2306è¡Œ</code>å¾—åˆ°åˆ›å»ºå¯¹è±¡å‡½æ•°è°ƒç”¨é¡ºåº<code>allocWithZone-&gt;_objc_rootAllocWithZone-&gt;_objc_rootAllocWithZone-&gt;class_createInstance-&gt;_class_createInstanceFromZone-&gt;_class_createInstanceFromZone</code>æœ€åæŸ¥çœ‹ä¸‹<code>_class_createInstanceFromZone</code>çš„æºç ï¼Œå…¶ä»–å·²çœç•¥ï¼Œåªç•™å…³é”®ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">id</span><br><span class="line">_class_createInstanceFromZone(Class cls, size_t extraBytes, void *zone, </span><br><span class="line">                              bool cxxConstruct &#x3D; true, </span><br><span class="line">                              size_t *outAllocatedSize &#x3D; nil)</span><br><span class="line">&#123;</span><br><span class="line">    if (!cls) return nil;</span><br><span class="line">**</span><br><span class="line">    size_t size &#x3D; cls-&gt;instanceSize(extraBytes);</span><br><span class="line">    if (outAllocatedSize) *outAllocatedSize &#x3D; size;</span><br><span class="line">    **</span><br><span class="line">    obj &#x3D; (id)calloc(1, size);</span><br><span class="line">   **</span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆæˆ‘ä»¬åœ¨çœ‹ä¸€ä¸‹<code>instanceSize</code>ä¸­çš„å®ç°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;å¯¹è±¡æŒ‡é’ˆçš„å¤§å°</span><br><span class="line">   uint32_t alignedInstanceSize() &#123;</span><br><span class="line">       return word_align(unalignedInstanceSize());</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   size_t instanceSize(size_t extraBytes) &#123;</span><br><span class="line">       size_t size &#x3D; alignedInstanceSize() + extraBytes;</span><br><span class="line">       &#x2F;&#x2F; CF requires all objects be at least 16 bytes.</span><br><span class="line">       if (size &lt; 16) size &#x3D; 16;</span><br><span class="line">       return size;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨çš„<code>obj = (id)calloc(1, size);</code>ä¼ è¿›å»çš„å€¼æ˜¯24ï¼Œä½†æ˜¯ç»“æœæ˜¯ç”³è¯·äº†32å­—èŠ‚çš„å†…å­˜ï¼Œè¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ<br>å› ä¸ºè¿™æ˜¯<code>c</code>å‡½æ•°ï¼Œæˆ‘ä»¬å»<span class="exturl" data-url="aHR0cHM6Ly9vcGVuc291cmNlLmFwcGxlLmNvbS90YXJiYWxscy9saWJtYWxsb2Mv" title="https://opensource.apple.com/tarballs/libmalloc/">è‹¹æœå¼€æºå®˜ç½‘ä¸‹è½½æºç çœ‹ä¸‹<i class="fa fa-external-link"></i></span>,å¯ä»¥æ‰¾åˆ°è¿™å¥ä»£ç ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">define NANO_MAX_SIZE256 &#x2F;* Buckets sized &#123;16, 32, 48, 64, 80, 96, 112, ...&#125; *&#x2F;</span><br></pre></td></tr></table></figure><p>çœ‹æ¥<code>NANO_MAX_SIZE</code>åœ¨ç”³è¯·ç©ºé—´çš„æ—¶å€™åšå®Œä¼˜åŒ–å°±æ˜¯16çš„å€æ•°,å¹¶ä¸”æœ€å¤§æ˜¯256ã€‚æ‰€ä»¥<code>size = 24 ;obj = (id)calloc(1, size);</code>ç”³è¯·çš„ç»“æœæ˜¯32å­—èŠ‚ã€‚<br>ç„¶åå†çœ‹ä¸‹<code>Linux</code>ç©ºé—´ç”³è¯·çš„æœºåˆ¶æ˜¯ä»€ä¹ˆï¼Ÿ<br><span class="exturl" data-url="aHR0cDovL2Z0cC5nbnUub3JnL2dudS9nbGliYy8=" title="http://ftp.gnu.org/gnu/glibc/">ä¸‹è½½gnuèµ„æ–™<i class="fa fa-external-link"></i></span>ï¼Œ<br>å¾—åˆ°ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#ifndef _I386_MALLOC_ALIGNMENT_H</span><br><span class="line">#define _I386_MALLOC_ALIGNMENT_H</span><br><span class="line"></span><br><span class="line">#define MALLOC_ALIGNMENT 16</span><br><span class="line"></span><br><span class="line">#endif &#x2F;* !defined(_I386_MALLOC_ALIGNMENT_H) *&#x2F;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;* MALLOC_ALIGNMENT is the minimum alignment for malloc&#39;ed chunks.  It</span><br><span class="line">   must be a power of two at least 2 * SIZE_SZ, even on machines for</span><br><span class="line">   which smaller alignments would suffice. It may be defined as larger</span><br><span class="line">   than this though. Note however that code and data structures are</span><br><span class="line">   optimized for the case of 8-byte alignment.  *&#x2F;</span><br><span class="line">   &#x2F;&#x2F;æœ€å°‘æ˜¯2å€çš„SIZE_SZ æˆ–è€…æ˜¯__alignof__(long double)</span><br><span class="line">#define MALLOC_ALIGNMENT (2 * SIZE_SZ &lt; __alignof__ (long double) \</span><br><span class="line">  ? __alignof__ (long double) : 2 * SIZE_SZ)</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#x2F;* The corresponding word size.  *&#x2F;</span><br><span class="line">#define SIZE_SZ (sizeof (INTERNAL_SIZE_T))</span><br><span class="line"></span><br><span class="line">#ifndef INTERNAL_SIZE_T</span><br><span class="line"># define INTERNAL_SIZE_T size_t</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure><p>åœ¨i386ä¸­æ˜¯16ï¼Œåœ¨å…¶ä»–ç³»ç»Ÿä¸­æŒ‰ç…§å®å®šä¹‰è®¡ç®—ï¼Œ<br><code>__alignof__ (long double)</code>åœ¨iOSä¸­æ˜¯16,<code>size_t</code>æ˜¯8ï¼Œåˆ™ä¸Šé¢çš„ä»£ç ç®€å†™ä¸º<code>#define MALLOC_ALIGNMENT (2*8 &lt; 16 ? 16:2*8)</code>æœ€ç»ˆæ˜¯16å­—èŠ‚ã€‚</p><p>æ€»ç»“ï¼š</p><blockquote><p>å®ä¾‹å¯¹è±¡å…¶å®æ˜¯ç»“æ„ä½“ï¼Œå ç”¨çš„å†…å­˜æ˜¯16çš„å€æ•°ï¼Œæœ€å°‘æ˜¯16ï¼Œç”±äºå†…å­˜å¯¹é½ï¼Œå®é™…ä½¿ç”¨çš„å†…å­˜ä¸ºM,åˆ™å®é™…åˆ†é…å†…å­˜ä¸º(M%16+M/16)*16ã€‚å®ä¾‹å¯¹è±¡çš„å¤§å°ä¸å—æ–¹æ³•å½±å“ï¼Œå—å®ä¾‹å˜é‡å½±å“ã€‚</p></blockquote><ul><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvaU9TRGF0YUZhY3Rvcnk=" title="https://github.com/ifgyong/iOSDataFactory">å­¦ä¹ èµ„æ–™ä¸‹è½½<i class="fa fa-external-link"></i></span></li><li><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvZGVtby90cmVlL21hc3Rlci9PQw==" title="https://github.com/ifgyong/demo/tree/master/OC">demo æŸ¥çœ‹<i class="fa fa-external-link"></i></span></li></ul><hr><p>å¹¿å‘Šæ—¶é—´</p><p><img src="/images/0.png" alt></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h3 id=&quot;å¯¹è±¡çš„æœ¬è´¨&quot;&gt;&lt;a href=&quot;#å¯¹è±¡çš„æœ¬è´¨&quot; class=&quot;headerlink&quot; title=&quot;å¯¹è±¡çš„æœ¬è´¨&quot;&gt;&lt;/a&gt;å¯¹è±¡çš„æœ¬è´¨&lt;/h3&gt;&lt;p&gt;æ¢å¯»OCå¯¹è±¡çš„æœ¬è´¨ï¼Œæˆ‘ä»¬å¹³æ—¶ç¼–å†™çš„Objective-Cä»£ç ï¼Œåº•å±‚å®ç°å…¶å®éƒ½æ˜¯C\C++ä»£ç ã€‚&lt;br&gt;é‚£ä¹ˆä¸€ä¸ªOCå¯¹
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
  </entry>
  
  <entry>
    <title>iOS æ‰‹åŠ¨åšä¸€ä¸ªè‡ªåŠ¨æ‰“åŒ…éƒ¨ç½²ç¥å™¨</title>
    <link href="http://fgyong.cn/2019/06/25/iOS%20%E6%89%8B%E5%8A%A8%E5%81%9A%E4%B8%80%E4%B8%AA%E8%87%AA%E5%8A%A8%E6%89%93%E5%8C%85%E9%83%A8%E7%BD%B2%E7%A5%9E%E5%99%A8/"/>
    <id>http://fgyong.cn/2019/06/25/iOS%20%E6%89%8B%E5%8A%A8%E5%81%9A%E4%B8%80%E4%B8%AA%E8%87%AA%E5%8A%A8%E6%89%93%E5%8C%85%E9%83%A8%E7%BD%B2%E7%A5%9E%E5%99%A8/</id>
    <published>2019-06-25T08:39:24.000Z</published>
    <updated>2020-09-04T04:40:21.654Z</updated>
    
    <content type="html"><![CDATA[<p>ä¹‹å‰ä½¿ç”¨çš„fastlaneæ·»åŠ pgyerè‡ªåŠ¨æ‰“åŒ…çš„ï¼Œæœ€è¿‘å‘ç°æ›´æ–°æ€»æ˜¯æœ‰é—®é¢˜ï¼Œæ‰€ä»¥äº§ç”Ÿäº†è‡ªå·±shellåšä¸€ä¸ªçš„æƒ³æ³•ã€‚è™½ç„¶ä»£ç æ¯”è¾ƒå°‘ï¼Œä½†æ˜¯å¾ˆå®ç”¨ã€‚</p><ul><li>æ‰“åŒ…</li><li>å¯¼å‡ºipa</li><li>ä¸Šä¼ pgyer</li></ul><h4 id="æ‰“åŒ…è‡ªåŠ¨ä¸Šä¼ pgyer"><a href="#æ‰“åŒ…è‡ªåŠ¨ä¸Šä¼ pgyer" class="headerlink" title="æ‰“åŒ…è‡ªåŠ¨ä¸Šä¼ pgyer"></a>æ‰“åŒ…è‡ªåŠ¨ä¸Šä¼ pgyer</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line"></span><br><span class="line">#xcodebuild archive -project &#39;test.xcodeproj&#39; -configuration &#39;Debug&#39; -scheme &#39;BLTSZY&#39; -archivePath &#39;.&#x2F;app.xcarchive&#39; LIBRARY_SEARCH_PATHS&#x3D;&quot;.&#x2F;Pods&#x2F;..&#x2F;build&#x2F;** Â .&#x2F;BLTSZY&#x2F;**&quot;</span><br><span class="line">proName&#x3D;&#39;your project name&#39;</span><br><span class="line">proURL&#x3D;&quot;your project path&quot;#like &#x2F;Users&#x2F;Jerry&#x2F;Desktop&#x2F;ios_afu</span><br><span class="line">api_key&#x3D;&#39;&#39;#pgyer api_key</span><br><span class="line">configuration&#x3D;&#39;Debug&#39; #Release </span><br><span class="line">autoPlus()&#123;</span><br><span class="line">path&#x3D;$&#123;proURL&#125;&#x2F;$&#123;proName&#125;&#x2F;$&#123;proName&#125;&#x2F;Info.plist</span><br><span class="line">number&#x3D;$(&#x2F;usr&#x2F;libexec&#x2F;PlistBuddy -c &quot;Print CFBundleVersion&quot; &quot;$&#123;path&#125;&quot;)</span><br><span class="line">BundleVersion&#x3D;$(( $number + 1 ))</span><br><span class="line">&#x2F;usr&#x2F;libexec&#x2F;PlistBuddy -c &quot;Set CFBundleVersion $BundleVersion&quot; &quot;$&#123;path&#125;&quot;</span><br><span class="line">&#125;</span><br><span class="line">#æ‰“åŒ…</span><br><span class="line">arch()&#123;</span><br><span class="line">    echo &#39;å¼€å§‹ç¼–è¯‘Pods&#39;</span><br><span class="line">    xcodebuild -project Pods&#x2F;Pods.xcodeproj build</span><br><span class="line">    echo &#39;å¼€å§‹ç¼–è¯‘project&#39;</span><br><span class="line"></span><br><span class="line">xcodebuild -archivePath &quot;.&#x2F;build&#x2F;$&#123;proName&#125;.xcarchive&quot; -workspace $proName.xcworkspace -sdk iphoneos -scheme $proName -configuration $configuration archive</span><br><span class="line">autoPlus</span><br><span class="line">&#125;</span><br><span class="line">#å¯¼å‡ºipa</span><br><span class="line">exportIPA()&#123;</span><br><span class="line">    echo &#39;å¼€å§‹å¯¼å‡ºipa&#39;</span><br><span class="line">    xcodebuild -exportArchive -archivePath &quot;.&#x2F;build&#x2F;$&#123;proName&#125;.xcarchive&quot; -exportPath &#39;.&#x2F;app&#39; -exportOptionsPlist &#39;.&#x2F;ExportOptions.plist&#39;</span><br><span class="line">&#125;</span><br><span class="line">#ä¸Šä¼ ipaåˆ°è’²å…¬è‹±</span><br><span class="line">upload()&#123;</span><br><span class="line">if [ -e &quot;$&#123;proURL&#125;&#x2F;app&#x2F;$&#123;proName&#125;.ipa&quot; ]</span><br><span class="line">then</span><br><span class="line">    echo &#39;å¼€å§‹ä¸Šä¼ ipa&#x2F;apkåˆ°è’²å…¬è‹±&#39;</span><br><span class="line">    curl -F &quot;file&#x3D;@$&#123;proURL&#125;&#x2F;app&#x2F;$&#123;proName&#125;.ipa&quot; -F &quot;_api_key&#x3D;$&#123;api_key&#125;&quot; &#39;http:&#x2F;&#x2F;www.pgyer.com&#x2F;apiv2&#x2F;app&#x2F;upload&#39;</span><br><span class="line">else</span><br><span class="line">    echo &quot;åœ¨ç›®å½•ï¼š$&#123;proURL&#125;&#x2F;app&#x2F;$&#123;proName&#125;.ipa ä¸å­˜åœ¨&quot;</span><br><span class="line">fi</span><br><span class="line">&#125;</span><br><span class="line">startarch()&#123;</span><br><span class="line">    arch</span><br><span class="line">    if (($? &#x3D;&#x3D; 0))</span><br><span class="line">    then</span><br><span class="line">        echo &#39;archive successğŸº&#39;</span><br><span class="line">        startExportIPA</span><br><span class="line">    else</span><br><span class="line">        echo &#39;archive faildâŒ&#39;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">startExportIPA()&#123;</span><br><span class="line">    exportIPA</span><br><span class="line">    if(($? &#x3D;&#x3D; 0))</span><br><span class="line">    then</span><br><span class="line">        echo &#39;exportIPA successğŸºğŸº&#39;</span><br><span class="line">        startUPLoadIPA</span><br><span class="line">    else</span><br><span class="line">        echo &#39;exportIPA faild âŒ&#39;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line">startUPLoadIPA()&#123;</span><br><span class="line">    upload</span><br><span class="line">    if(($? &#x3D;&#x3D; 0))</span><br><span class="line">    then</span><br><span class="line">        echo &#39;uploadIPA success&#39;</span><br><span class="line">    else</span><br><span class="line">        echo &#39;uploadIPA faild âŒ&#39;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if (($# &#x3D;&#x3D; 0))</span><br><span class="line">#then</span><br><span class="line">#    startarch</span><br><span class="line">#elif (($# &#x3D;&#x3D; 1))</span><br><span class="line">then</span><br><span class="line">        while :</span><br><span class="line">        do</span><br><span class="line">        echo &#39;ğŸºğŸºğŸº***********************ğŸºğŸºğŸº&#39;</span><br><span class="line">        echo  &quot;è¾“å…¥ 1 åˆ° 4 ä¹‹é—´çš„æ•°å­—:&quot;</span><br><span class="line">        echo  &quot;è¾“å…¥ 1:ä»ç¼–è¯‘æ‰“åŒ…å¼€å§‹è‡³ç»“æŸ&quot;</span><br><span class="line">        echo  &quot;è¾“å…¥ 2:ä»å¯¼å‡ºIPAå¼€å§‹è‡³ç»“æŸ&quot;</span><br><span class="line">        echo  &quot;è¾“å…¥ 3:ä»ä¸Šä¼ ipaå¼€å§‹è‡³ç»“æŸ&quot;</span><br><span class="line">        echo  &quot;è¾“å…¥ 4:é€€å‡º&quot;</span><br><span class="line">        read a</span><br><span class="line">        case $a in</span><br><span class="line">            1)startarch</span><br><span class="line">            break;;</span><br><span class="line">            2)startExportIPA</span><br><span class="line">            break;;</span><br><span class="line">            3)startUPLoadIPA</span><br><span class="line">            break;;</span><br><span class="line">            4) break;;</span><br><span class="line">        esac</span><br><span class="line">        done</span><br><span class="line">fi</span><br></pre></td></tr></table></figure><p>å°†è¯¥æ–‡ä»¶å’Œplisæ‹–åˆ°projectç›®å½•ä¸‹ï¼Œç„¶åé…ç½®<br>plisæ–‡ä»¶ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version&#x3D;&quot;1.0&quot; encoding&#x3D;&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE plist PUBLIC &quot;-&#x2F;&#x2F;Apple&#x2F;&#x2F;DTD PLIST 1.0&#x2F;&#x2F;EN&quot; &quot;http:&#x2F;&#x2F;www.apple.com&#x2F;DTDs&#x2F;PropertyList-1.0.dtd&quot;&gt;</span><br><span class="line">&lt;plist version&#x3D;&quot;1.0&quot;&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">&lt;key&gt;compileBitcode&lt;&#x2F;key&gt;</span><br><span class="line">&lt;false&#x2F;&gt;</span><br><span class="line">&lt;key&gt;method&lt;&#x2F;key&gt;</span><br><span class="line">&lt;string&gt;ad-hoc&lt;&#x2F;string&gt;</span><br><span class="line">&lt;key&gt;provisioningProfiles&lt;&#x2F;key&gt;</span><br><span class="line">&lt;dict&gt;</span><br><span class="line">&lt;key&gt;your bundle id&lt;&#x2F;key&gt;</span><br><span class="line">&lt;string&gt;your .mobileprovsion&lt;&#x2F;string&gt;</span><br><span class="line">&lt;&#x2F;dict&gt;</span><br><span class="line">&lt;key&gt;signingCertificate&lt;&#x2F;key&gt;</span><br><span class="line">&lt;string&gt;iPhone Distribution&lt;&#x2F;string&gt;</span><br><span class="line">&lt;key&gt;signingStyle&lt;&#x2F;key&gt;</span><br><span class="line">&lt;string&gt;manual&lt;&#x2F;string&gt;</span><br><span class="line">&lt;key&gt;stripSwiftSymbols&lt;&#x2F;key&gt;</span><br><span class="line">&lt;true&#x2F;&gt;</span><br><span class="line">&lt;key&gt;teamID&lt;&#x2F;key&gt;</span><br><span class="line">&lt;string&gt;your_team_id&lt;&#x2F;string&gt;</span><br><span class="line">&lt;key&gt;thinning&lt;&#x2F;key&gt;</span><br><span class="line">&lt;string&gt;&lt;none&gt;&lt;&#x2F;string&gt;</span><br><span class="line">&lt;&#x2F;dict&gt;</span><br><span class="line">&lt;&#x2F;plist&gt;</span><br></pre></td></tr></table></figure><br>ä¸‹è½½<code>setup.sh</code>æ‹–åˆ°é¡¹ç›®æ–‡ä»¶å¤¹å†…ï¼Œç„¶å<br>è¿è¡Œ<code>./setup.sh</code>ï¼Œå³å¯å®Œæˆä¸Šä¼ åˆ°pgyerç½‘ç«™ã€‚<br>å…·ä½“çš„é…ç½®å±æ€§è§æºç ä¸‹è½½é¡µé¢ã€‚<br><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmcvYXV0b0FFVQ==" title="https://github.com/ifgyong/autoAEU">æŸ¥çœ‹æºç <i class="fa fa-external-link"></i></span></p><p>```</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;ä¹‹å‰ä½¿ç”¨çš„fastlaneæ·»åŠ pgyerè‡ªåŠ¨æ‰“åŒ…çš„ï¼Œæœ€è¿‘å‘ç°æ›´æ–°æ€»æ˜¯æœ‰é—®é¢˜ï¼Œæ‰€ä»¥äº§ç”Ÿäº†è‡ªå·±shellåšä¸€ä¸ªçš„æƒ³æ³•ã€‚è™½ç„¶ä»£ç æ¯”è¾ƒå°‘ï¼Œä½†æ˜¯å¾ˆå®ç”¨ã€‚&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;æ‰“åŒ…&lt;/li&gt;
&lt;li&gt;å¯¼å‡ºipa&lt;/li&gt;
&lt;li&gt;ä¸Šä¼ pgyer&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
      <category term="è‡ªåŠ¨æ‰“åŒ…" scheme="http://fgyong.cn/tags/%E8%87%AA%E5%8A%A8%E6%89%93%E5%8C%85/"/>
    
  </entry>
  
  <entry>
    <title>iOS æµ…ææŒ‡é’ˆã€å‡½æ•°ã€typedef</title>
    <link href="http://fgyong.cn/2019/06/24/iOS%20%E6%B5%85%E6%9E%90%E6%8C%87%E9%92%88%E3%80%81%E5%87%BD%E6%95%B0%E3%80%81typedef/"/>
    <id>http://fgyong.cn/2019/06/24/iOS%20%E6%B5%85%E6%9E%90%E6%8C%87%E9%92%88%E3%80%81%E5%87%BD%E6%95%B0%E3%80%81typedef/</id>
    <published>2019-06-24T08:39:24.000Z</published>
    <updated>2020-09-04T04:40:21.654Z</updated>
    
    <content type="html"><![CDATA[<h4 id="æŒ‡é’ˆå‡½æ•°å’Œå‡½æ•°æŒ‡é’ˆ"><a href="#æŒ‡é’ˆå‡½æ•°å’Œå‡½æ•°æŒ‡é’ˆ" class="headerlink" title="æŒ‡é’ˆå‡½æ•°å’Œå‡½æ•°æŒ‡é’ˆ"></a>æŒ‡é’ˆå‡½æ•°å’Œå‡½æ•°æŒ‡é’ˆ</h4><p>é¡¾åæ€ä¹‰ï¼ŒæŒ‡é’ˆå‡½æ•°å³è¿”å›æŒ‡é’ˆçš„å‡½æ•°ã€‚å…¶ä¸€èˆ¬å®šä¹‰å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ç±»å‹å *å‡½æ•°å(å‡½æ•°å‚æ•°è¡¨åˆ—);</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œåç¼€è¿ç®—ç¬¦æ‹¬å·<code>â€œ()â€</code>è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å‰ç¼€è¿ç®—ç¬¦æ˜Ÿå·<code>â€œ*â€</code>è¡¨ç¤ºæ­¤å‡½æ•°ä¸ºæŒ‡é’ˆå‹å‡½æ•°ï¼Œå…¶å‡½æ•°å€¼ä¸ºæŒ‡é’ˆï¼Œå³å®ƒå¸¦å›æ¥çš„å€¼çš„ç±»å‹ä¸ºæŒ‡é’ˆï¼Œå½“è°ƒç”¨è¿™ä¸ªå‡½æ•°åï¼Œå°†å¾—åˆ°ä¸€ä¸ªâ€œæŒ‡å‘è¿”å›å€¼ä¸ºâ€¦çš„æŒ‡é’ˆï¼ˆåœ°å€ï¼‰ï¼Œâ€œç±»å‹åâ€è¡¨ç¤ºå‡½æ•°è¿”å›çš„æŒ‡é’ˆæŒ‡å‘çš„ç±»å‹â€ã€‚</p><p><code>â€œ(å‡½æ•°å‚æ•°è¡¨åˆ—)â€</code>ä¸­çš„æ‹¬å·ä¸ºå‡½æ•°è°ƒç”¨è¿ç®—ç¬¦ï¼Œåœ¨è°ƒç”¨è¯­å¥ä¸­ï¼Œå³ä½¿å‡½æ•°ä¸å¸¦å‚æ•°ï¼Œå…¶å‚æ•°è¡¨çš„ä¸€å¯¹æ‹¬å·ä¹Ÿä¸èƒ½çœç•¥ã€‚å…¶ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int *pfun(int, int);</span><br></pre></td></tr></table></figure><p>ç”±äº<code>â€œ*â€</code>çš„ä¼˜å…ˆçº§ä½äº<code>â€œ()â€</code>çš„ä¼˜å…ˆçº§ï¼Œå› è€Œpfuné¦–å…ˆå’Œåé¢çš„<code>â€œ()â€</code>ç»“åˆï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œpfunæ˜¯ä¸€ä¸ªå‡½æ•°ã€‚å³ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int *(pfun(int, int));</span><br></pre></td></tr></table></figure><p>æ¥ç€å†å’Œå‰é¢çš„<code>â€œ*â€</code>ç»“åˆï¼Œè¯´æ˜è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚ç”±äºå‰é¢è¿˜æœ‰ä¸€ä¸ªintï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œpfunæ˜¯ä¸€ä¸ªè¿”å›å€¼ä¸ºæ•´å‹æŒ‡é’ˆçš„å‡½æ•°ã€‚<br>æˆ‘ä»¬ä¸å¦¨æ¥å†çœ‹ä¸€çœ‹ï¼ŒæŒ‡é’ˆå‡½æ•°ä¸å‡½æ•°æŒ‡é’ˆæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int (*pfun)(int, int);</span><br></pre></td></tr></table></figure><p>é€šè¿‡æ‹¬å·å¼ºè¡Œå°†pfuné¦–å…ˆä¸<code>â€œ*â€</code>ç»“åˆï¼Œä¹Ÿå°±æ„å‘³ç€ï¼Œpfunæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œæ¥ç€ä¸åé¢çš„<code>â€œ()â€</code>ç»“åˆï¼Œè¯´æ˜è¯¥æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œç„¶åå†ä¸å‰é¢çš„intç»“åˆï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥å‡½æ•°çš„è¿”å›å€¼æ˜¯intã€‚ç”±æ­¤å¯è§ï¼Œpfunæ˜¯ä¸€ä¸ªæŒ‡å‘è¿”å›å€¼ä¸ºintçš„å‡½æ•°çš„æŒ‡é’ˆã€‚</p><p>è™½ç„¶å®ƒä»¬åªæœ‰ä¸€ä¸ªæ‹¬å·çš„å·®åˆ«ï¼Œä½†æ˜¯è¡¨ç¤ºçš„æ„ä¹‰å´æˆªç„¶ä¸åŒã€‚å‡½æ•°æŒ‡é’ˆçš„æœ¬èº«æ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚æŒ‡é’ˆå‡½æ•°çš„æœ¬èº«æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå…¶å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚</p><p>ç”¨å‡½æ•°æŒ‡é’ˆä½œä¸ºæŒ‡é’ˆå‡½æ•°çš„è¿”å›å€¼<br>åœ¨ä¸Šé¢æåˆ°çš„æŒ‡é’ˆå‡½æ•°é‡Œé¢ï¼Œæœ‰è¿™æ ·ä¸€ç±»å‡½æ•°ï¼Œå®ƒä»¬ä¹Ÿè¿”å›æŒ‡é’ˆå‹æ•°æ®ï¼ˆåœ°å€ï¼‰ï¼Œä½†æ˜¯è¿™ä¸ªæŒ‡é’ˆä¸æ˜¯æŒ‡å‘intã€charä¹‹ç±»çš„åŸºæœ¬ç±»å‹ï¼Œè€Œæ˜¯æŒ‡å‘å‡½æ•°ã€‚å¯¹äºåˆå­¦è€…ï¼Œåˆ«è¯´å†™å‡ºè¿™æ ·çš„å‡½æ•°å£°æ˜ï¼Œå°±æ˜¯çœ‹åˆ°è¿™æ ·çš„å†™æ³•ä¹Ÿæ˜¯ä¸€å¤´é›¾æ°´ã€‚æ¯”å¦‚,ä¸‹é¢çš„è¯­å¥ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int (*ff(int))(int *, int);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç”¨ä¸Šé¢ä»‹ç»çš„æ–¹æ³•åˆ†æä¸€ä¸‹ï¼Œffé¦–å…ˆä¸åé¢çš„<code>â€œ()â€</code>ç»“åˆï¼Œå³ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int (*(ff(int)))(int *, int);</span><br></pre></td></tr></table></figure><p>ç”¨æ‹¬å·å°†<code>ff(int)</code>å†æ‹¬èµ·æ¥ä¹Ÿå°±æ„å‘³ç€ï¼Œ<code>ff</code>æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚<br>æ¥ç€ä¸å‰é¢çš„<code>â€œ*â€</code>ç»“åˆï¼Œè¯´æ˜<code>ff</code>å‡½æ•°çš„è¿”å›å€¼æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚ç„¶åå†ä¸åé¢çš„<code>â€œ()â€</code>ç»“åˆï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ä¸€ä¸ªå‡½æ•°ã€‚</p><p>è¿™ç§å†™æ³•ç¡®å®è®©äººéå¸¸éš¾æ‡‚ï¼Œä»¥è‡³äºä¸€äº›åˆå­¦è€…äº§ç”Ÿè¯¯è§£ï¼Œè®¤ä¸ºå†™å‡ºåˆ«äººçœ‹ä¸æ‡‚çš„ä»£ç æ‰èƒ½æ˜¾ç¤ºè‡ªå·±æ°´å¹³é«˜ã€‚è€Œäº‹å®ä¸Šæ°å¥½ç›¸åï¼Œèƒ½å¦å†™å‡ºé€šä¿—æ˜“æ‡‚çš„ä»£ç æ˜¯è¡¡é‡ç¨‹åºå‘˜æ˜¯å¦ä¼˜ç§€çš„æ ‡å‡†ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç”¨typedefå…³é”®å­—ä¼šä½¿è¯¥å£°æ˜æ›´ç®€å•æ˜“æ‡‚ã€‚åœ¨å‰é¢æˆ‘ä»¬å·²ç»è§è¿‡ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int (*PF)(int *, int);</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒPFæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆâ€œå˜é‡â€ã€‚å½“ä½¿ç”¨typedefå£°æ˜åï¼Œåˆ™PFå°±æˆä¸ºäº†ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ<code>â€œç±»å‹â€</code>ï¼Œå³ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">typedef int (*PF)(int *, int);</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±å®šä¹‰äº†è¿”å›å€¼çš„ç±»å‹ã€‚ç„¶åï¼Œå†ç”¨PFä½œä¸ºè¿”å›å€¼æ¥å£°æ˜å‡½æ•°:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PF ff(int);</span><br></pre></td></tr></table></figure><h4 id="æ·±å…¥ç†è§£-typedef"><a href="#æ·±å…¥ç†è§£-typedef" class="headerlink" title="æ·±å…¥ç†è§£ typedef"></a>æ·±å…¥ç†è§£ typedef</h4><p>å¹³æ—¶æˆ‘ä»¬åœ¨OCä¸­çš„ä½¿ç”¨å†™æ³•ï¼Œä½†æ˜¯å¯¹<code>typedef</code>å›°æƒ‘ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">typedef &lt;#returnType#&gt;(^&lt;#name#&gt;)(&lt;#arguments#&gt;);&#x2F;&#x2F;typedefBlock Code Snippets</span><br><span class="line"></span><br><span class="line">typedef void (^RWAlertViewCompletionBlock)(UIAlertView *alertView, NSInteger buttonIndex);</span><br></pre></td></tr></table></figure><br>ç„¶åå¯ä»¥é€šè¿‡<code>RWAlertViewCompletionBlock</code>å½“æˆblockç±»å‹ç›´æ¥ä½¿ç”¨äº†ã€‚<br>ç„¶åçœ‹ä¸‹<code>libffi</code>çš„ç”¨æ³•ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef enum &#123;</span><br><span class="line">  FFI_OK &#x3D; 0,</span><br><span class="line">  FFI_BAD_TYPEDEF,</span><br><span class="line">  FFI_BAD_ABI</span><br><span class="line">&#125; ffi_status;</span><br><span class="line">typedef int INT64;&#x2F;&#x2F;INT64 å…¶å®æ˜¯int</span><br></pre></td></tr></table></figure><br>ä½¿ç”¨èµ·æ¥çš„è¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffi_status status;&#x2F;&#x2F;å£°æ˜ä¸€ä¸ªç±»å‹æ˜¯ffi_statusçš„å‚æ•°</span><br><span class="line">INT64 age;&#x2F;&#x2F;å£°æ˜ä¸€ä¸ªage ç±»å‹æ˜¯INT64</span><br></pre></td></tr></table></figure><br>ç°åœ¨blockä¹Ÿå¯ä»¥æ˜¯å‡½æ•°æŒ‡é’ˆäº†<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">int (*PF)(int *, int);</span><br><span class="line">&#x2F;&#x2F;ä¹Ÿå°±æ˜¯è¯´ï¼ŒPFæ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆâ€œå˜é‡â€ã€‚å½“ä½¿ç”¨typedefå£°æ˜åï¼Œåˆ™PFå°±æˆä¸ºäº†ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆâ€œç±»å‹â€ï¼Œå³ï¼š</span><br><span class="line">typedef int (*PF)(int *, int);</span><br></pre></td></tr></table></figure><br><strong>typedefçš„è¯­æ³•è§„åˆ™å…¶å®å¾ˆç®€å•ï¼Œä¸€å¥è¯æ¥è¯´å°±æ˜¯å®šä¹‰å¯¹è±¡çš„è¯­æ³•å‰åŠ å…³é”®å­—typedefï¼Œå‰©ä¸‹çš„ä¸å˜ï¼ŒåŸæœ¬å®šä¹‰çš„å¯¹è±¡æ ‡è¯†ç¬¦æ¢æˆç±»å‹æ ‡è¯†ç¬¦ï¼Œå¯¹åº”è¯­ä¹‰ä»å®šä¹‰ä¸€ä¸ªå¯¹è±¡æ”¹æˆå®šä¹‰ä¸€ä¸ªç±»å‹åˆ«åã€‚typedefçœ‹èµ·æ¥å¤æ‚æ ¹æœ¬åŸå› æ˜¯å¯¹è±¡å®šä¹‰çš„è¯­æ³•æ¯”è¾ƒå¤æ‚ï¼Œä¾‹å¦‚åˆ†éš”ç¬¦*å’Œ[]çš„ç”¨æ³•ã€‚</strong><br>é’ˆå¯¹ç»å…¸çš„constæ¥ä¸ªä¾‹å­<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef char * pStr;</span><br><span class="line">char string[4] &#x3D; &quot;abc&quot;;</span><br><span class="line">const char *p1 &#x3D; string;</span><br><span class="line">const pStr p2 &#x3D; string;</span><br><span class="line">p1++;</span><br><span class="line">p2++;&#x2F;&#x2F;error</span><br></pre></td></tr></table></figure><br>é‚£ä¹ˆä¸ºä»€ä¹ˆ<code>p2++</code>ä¸ºä»€ä¹ˆä¼šæŠ¥é”™å‘¢ï¼Ÿ<br>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼Œ<code>const char *p1 = string;</code>æ˜¯å£°æ˜äº†ä¸€ä¸ª<code>const char</code>çš„æŒ‡é’ˆï¼Œä¸å¯å˜çš„æ˜¯<code>char</code>,ç›¸å½“äº<code>(const char)*p=string</code>,æ‰€ä»¥<code>p1++</code>ä¸ä¼šæŠ¥é”™ã€‚<code>p2++</code>æŠ¥é”™æ ¹æœ¬åŸå› æ˜¯<code>p2</code>æ˜¯ä¸å¯å˜çš„ï¼Œ<code>const pStr p2 = string</code>ç›¸å½“äº<code>const (char *) p2 = string</code>,<code>const</code>ä¿®é¥°çš„æ˜¯<code>char *</code>ï¼Œæ‰€ä»¥<code>p2</code>ä¸å¯æ”¹å˜ã€‚<code>p1</code>æ˜¯æ•°ç»„ï¼Œ<code>p2</code>æ˜¯å›ºå®šçš„å€¼ã€‚</p><h4 id="typedefå¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ"><a href="#typedefå¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ" class="headerlink" title="typedefå¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ"></a><code>typedef</code>å¦‚ä½•ä½¿ç”¨å‘¢ï¼Ÿ</h4><p>æˆ‘ä»¬å…·ä½“çœ‹å‡ ä¸ªæ¡ˆä¾‹åˆ†æä¸€ä¸‹ã€‚</p><p>æ¡ˆä¾‹1ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int (*b) (void (*)());</span><br></pre></td></tr></table></figure><br>ç®€åŒ–ä¸€ä¸‹æ˜¯ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">typedef  void (*func)()</span><br><span class="line">typedef  int (*ifunc)(func)</span><br></pre></td></tr></table></figure><br>æœ€ç»ˆç®€åŒ–æˆ<code>ifunc b;</code>ã€‚å¯ä»¥ç†è§£æˆ<code>(void (*)())</code>æ˜¯ä¸€ä¸ª<code>func</code>,ç„¶åæ›¿æ¢<code>func</code>æˆäº†æœ€ç»ˆçš„å½¢å‚æ˜¯<code>func</code>ï¼Œè¿”å›å€¼æ˜¯<code>int</code>ã€‚</p><p>æ¡ˆä¾‹2åˆ†æï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">int (*func)(int *p);</span><br></pre></td></tr></table></figure><br>é¦–å…ˆæ‰¾åˆ°<code>func</code>ï¼Œ<code>func</code>å·¦è¾¹æ˜¯<code>*</code>ï¼Œè¯´æ˜<code>func</code>æ˜¯ä¸ªæŒ‡é’ˆï¼Œç„¶åè·³å‡ºè¿™ä¸ªåœ†æ‹¬å·ï¼Œå…ˆçœ‹å³è¾¹ï¼Œåˆé‡åˆ°åœ†æ‹¬å·ï¼Œè¿™è¯´æ˜<code>(*func)</code>æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥<br>funcæ˜¯ä¸€ä¸ªæŒ‡å‘è¿™ç±»å‡½æ•°çš„æŒ‡é’ˆï¼Œå³å‡½æ•°æŒ‡é’ˆï¼Œè¿™ç±»å‡½æ•°å…·æœ‰<code>int*</code>ç±»å‹çš„å½¢å‚ï¼Œè¿”å›å€¼ç±»å‹æ˜¯<code>int</code>ã€‚</p><p>ç»¼åˆæ¡ˆä¾‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SEL didload &#x3D; @selector(viewDidLoad);</span><br><span class="line">Method md &#x3D; class_getInstanceMethod(aclass, didload);</span><br><span class="line">IMP load &#x3D; method_getImplementation(md);</span><br><span class="line">void(*loadFunc)(id,SEL) &#x3D; (void *)load;</span><br></pre></td></tr></table></figure><br>è¿™æ˜¯å°†SELè·å–äº†Methodä¹‹åå°†IMPè½¬åŒ–æˆ<code>void(*loadFunc)(id,SEL)</code>ï¼Œè°ƒç”¨çš„æ—¶å€™å¯ä»¥ç›´æ¥è°ƒç”¨ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;æ‰§è¡ŒViewDidLoad IMP</span><br><span class="line"> loadFunc(aclass,NULL);</span><br></pre></td></tr></table></figure><br>Methodå¯ä»¥è¿™æ ·ä½¿ç”¨ï¼ŒblockåŒæ ·ä¹Ÿå¯ä»¥è¿™æ ·ä½¿ç”¨:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">void (^block)(id _self) &#x3D; ^(id _self)&#123;</span><br><span class="line">    &#x2F;&#x2F;code here</span><br><span class="line">&#125;;</span><br><span class="line">void(*func)(id,SEL) &#x3D; (void*)imp_implementationWithBlock(block);</span><br><span class="line">class_replaceMethod(aclass, didload, (IMP)func, method_getTypeEncoding(md));</span><br></pre></td></tr></table></figure><br>è¿™å¯ä»¥ç›´æ¥ä½¿ç”¨<code>runtime/message.h</code>å‡½æ•°<code>imp_implementationWithBlock</code>å°†<code>block</code>è½¬åŒ–æˆ<code>IMP</code>,ä½¿ç”¨<code>class_replaceMethod</code>æ›¿æ¢æŸä¸ªå‡½æ•°çš„<code>IMP</code>ã€‚é‚£ä¹ˆå†è°ƒç”¨è¯¥å‡½æ•°çš„æ—¶å€™ï¼Œåˆ™æ˜¯è°ƒç”¨çš„<code>block</code>çš„<code>IMP</code>ã€‚è·å–<code>method</code>å’Œ<code>block</code>å‚æ•°åç»­å†åˆ†æã€‚</p><p>èµ„æ–™å‚è€ƒï¼š</p><p><span class="exturl" data-url="aHR0cDovL3l1bGluZ3RpYW54aWEuY29tL2Jsb2cvMjAxNC8wNC8xNy9oYW4tc2h1LXpoaS16aGVuLXl1LXpoaS16aGVuLWhhbi1zaHUv" title="http://yulingtianxia.com/blog/2014/04/17/han-shu-zhi-zhen-yu-zhi-zhen-han-shu/">ç‰ä»¤å¤©ä¸‹åšå®¢åœ°å€<i class="fa fa-external-link"></i></span></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h4 id=&quot;æŒ‡é’ˆå‡½æ•°å’Œå‡½æ•°æŒ‡é’ˆ&quot;&gt;&lt;a href=&quot;#æŒ‡é’ˆå‡½æ•°å’Œå‡½æ•°æŒ‡é’ˆ&quot; class=&quot;headerlink&quot; title=&quot;æŒ‡é’ˆå‡½æ•°å’Œå‡½æ•°æŒ‡é’ˆ&quot;&gt;&lt;/a&gt;æŒ‡é’ˆå‡½æ•°å’Œå‡½æ•°æŒ‡é’ˆ&lt;/h4&gt;&lt;p&gt;é¡¾åæ€ä¹‰ï¼ŒæŒ‡é’ˆå‡½æ•°å³è¿”å›æŒ‡é’ˆçš„å‡½æ•°ã€‚å…¶ä¸€èˆ¬å®šä¹‰å½¢å¼å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;figure c
      
    
    </summary>
    
    
      <category term="iOS" scheme="http://fgyong.cn/categories/iOS/"/>
    
    
      <category term="iOS" scheme="http://fgyong.cn/tags/iOS/"/>
    
      <category term="æŒ‡é’ˆ" scheme="http://fgyong.cn/tags/%E6%8C%87%E9%92%88/"/>
    
  </entry>
  
  <entry>
    <title>Python3 Flask bootstrapæ•™ç¨‹(2)</title>
    <link href="http://fgyong.cn/2018/05/28/Python3%20Flask%20bootstrap%E6%95%99%E7%A8%8B(2)/"/>
    <id>http://fgyong.cn/2018/05/28/Python3%20Flask%20bootstrap%E6%95%99%E7%A8%8B(2)/</id>
    <published>2018-05-28T04:02:22.000Z</published>
    <updated>2020-09-04T04:40:21.652Z</updated>
    
    <content type="html"><![CDATA[<p>1.è“å›¾<br>2.Navçš„ä½¿ç”¨<br>3.mysqlä½¿ç”¨<br>4.æ¨¡æ¿çš„ä½¿ç”¨</p><h3 id="è“å›¾ä½¿ç”¨"><a href="#è“å›¾ä½¿ç”¨" class="headerlink" title="è“å›¾ä½¿ç”¨"></a>è“å›¾ä½¿ç”¨</h3><p>æ–°å»ºuseræ–‡ä»¶å¤¹,åœ¨useræ–‡ä»¶å¤¹ä¸‹å˜æ–°å»ºtamplatesï¼Œè¿˜æœ‰<strong>init</strong>.pyå’Œviews.py<br><strong>init.py</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from flask import Blueprint</span><br><span class="line">&#x2F;&#x2F;å£°æ˜è“å›¾</span><br><span class="line">user &#x3D; Blueprint(&#39;user&#39;, __name__,template_folder&#x3D;&#39;templates&#39;)</span><br><span class="line"></span><br><span class="line">from api.v1.user import views</span><br></pre></td></tr></table></figure><br>ç„¶ååœ¨run.pyä¸­æ³¨å†Œè“å›¾<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">å…ˆå¯¼å…¥</span><br><span class="line">from api.v1.user import user</span><br><span class="line"></span><br><span class="line">app.register_blueprint(user,url_prefix&#x3D;&#39;&#x2F;user&#39;) åè¾¹çš„æ˜¯è·¯å¾„</span><br></pre></td></tr></table></figure><br>ç„¶ååœ¨userçš„viewsä¸­å°±å¯ä»¥å†™æ–¹æ³•äº†ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, request, jsonify,render_template</span><br><span class="line">from flask.json import tojson_filter</span><br><span class="line">from api.v1.user import user</span><br><span class="line">from api.v1 import first</span><br><span class="line">import pymysql</span><br><span class="line">import sys</span><br><span class="line">import json</span><br><span class="line">from flask_bootstrap import Bootstrap</span><br><span class="line">&#x2F;&#x2F;è·¯ç”±</span><br><span class="line">@user.route(&#39;&#x2F;&#39;,methods&#x3D;[&#39;GET&#39;,&#39;POST&#39;])</span><br><span class="line">&#x2F;&#x2F;æ–¹æ³•</span><br><span class="line">def my_index():</span><br><span class="line">    args &#x3D; request.args;</span><br><span class="line">    age &#x3D; &#39;&#39;</span><br><span class="line">    name &#x3D; &#39;&#39;</span><br><span class="line">    if args.__contains__(&#39;name&#39;):</span><br><span class="line">        name &#x3D; request.args.getlist(key&#x3D;&#39;name&#39;)</span><br><span class="line">    if args.__contains__(&#39;age&#39;):</span><br><span class="line">        age &#x3D; request.args.__getitem__(&#39;age&#39;)</span><br><span class="line">&#x2F;&#x2F;è¿”å›æ•°æ®æ˜¯json</span><br><span class="line">    return jsonify(&#123;&#39;method&#39;:sys._getframe().f_code.co_name,</span><br><span class="line">                    &#39;name&#39;:str(name),</span><br><span class="line">                    &#39;age&#39;:age&#125;)</span><br></pre></td></tr></table></figure><br>ç°åœ¨æˆ‘ä»¬æƒ³è¿”å›ä¸€ä¸ªhtmlï¼Œé‚£ä¹ˆå°±åœ¨tamplatesä¸­æ–°å»ºä¸€ä¸ªindex.html<br>ä»£ç å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;title&gt;ç»“æœ&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;helloword&lt;&#x2F;h1&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><br>ç„¶ååœ¨viewsä¸­å¢åŠ è·¯ç”±<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@user.route(&#39;&#x2F;helloword&#39;)</span><br><span class="line">def helloword():</span><br><span class="line">    return render_template(&#39;helloword.html&#39;)</span><br></pre></td></tr></table></figure><br>è¿è¡Œç¨‹åº,è¾“å…¥åœ°å€<code>127.0.0.1ï¼š5000/helloword</code>ï¼Œå‡ºç°hellowordï¼Œå°±ç®—æˆ‘ä»¬çš„ç¨‹åºè·‘èµ·æ¥äº†ã€‚</p><h3 id="Navçš„ä½¿ç”¨"><a href="#Navçš„ä½¿ç”¨" class="headerlink" title="Navçš„ä½¿ç”¨"></a>Navçš„ä½¿ç”¨</h3><p>navå°±æ˜¯htmlçš„å¤´éƒ¨æˆ–è€…bannerï¼Œæˆ‘ä»¬å†™ä¸€ä¸ªç®€å•çš„ä¾‹å­<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul class&#x3D;&quot;nav nav-tabs&quot;&gt;</span><br><span class="line">    &lt;li role&#x3D;&quot;presentation&quot; class&#x3D;&quot;dropdown&quot; id&#x3D;&quot;myDropdown&quot;&gt;</span><br><span class="line">        &lt;a class&#x3D;&quot;dropdown-toggle&quot; data-toggle&#x3D;&quot;dropdown&quot;  data-target&#x3D;&quot;#&quot; role&#x3D;&quot;button&quot; aria-haspopup&#x3D;&quot;true&quot;</span><br><span class="line">           aria-expanded&#x3D;&quot;false&quot;&gt;</span><br><span class="line">            ä¸»é¡µ &lt;span class&#x3D;&quot;caret&quot; id&#x3D;&quot;page1&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">        &lt;&#x2F;a&gt;</span><br><span class="line">        &lt;ul class&#x3D;&quot;dropdown-menu&quot; role&#x3D;&quot;menu&quot; aria-labelledby&#x3D;&quot;page1&quot;&gt;</span><br><span class="line">            &lt;li role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">                &lt;a role&#x3D;&quot;menuitem&quot; href&#x3D;&quot;add&quot;&gt;æ·»åŠ &lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">            &lt;li role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">                &lt;a role&#x3D;&quot;menuitem&quot; href&#x3D;&quot;list&quot;&gt;åˆ—è¡¨&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">            &lt;&#x2F;li&gt;</span><br><span class="line">        &lt;&#x2F;ul&gt;</span><br><span class="line">    &lt;&#x2F;li&gt;</span><br><span class="line">    &lt;li class&#x3D;&quot;dropdown&quot;  &gt;</span><br><span class="line">        &lt;a class&#x3D;&quot;dropdown-toggle&quot; id&#x3D;&quot;group2&quot; data-toggle&#x3D;&quot;dropdown&quot; href&#x3D;&quot;#&quot; role&#x3D;&quot;button&quot;&gt;</span><br><span class="line">            æ–‡ç«  &lt;span class&#x3D;&quot;caret&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">        &lt;&#x2F;a&gt;</span><br><span class="line">        &lt;ul class&#x3D;&quot;dropdown-menu&quot; role&#x3D;&quot;menu&quot; aria-labelledby&#x3D;&quot;group2&quot;&gt;</span><br><span class="line">            &lt;li role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">                 &lt;a role&#x3D;&quot;menuitem&quot; href&#x3D;&quot;add&quot;&gt;æ·»åŠ &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;&#x2F;li&gt;</span><br><span class="line">            &lt;li role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">                 &lt;a role&#x3D;&quot;menuitem&quot; href&#x3D;&quot;list&quot;&gt;åˆ—è¡¨&lt;&#x2F;a&gt;</span><br><span class="line">            &lt;&#x2F;li&gt;</span><br><span class="line">            &lt;li role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">                 &lt;a role&#x3D;&quot;menuitem&quot; href&#x3D;&quot;list&quot;&gt;åˆ—è¡¨&lt;&#x2F;a&gt;</span><br><span class="line">            &lt;&#x2F;li&gt;</span><br><span class="line">        &lt;&#x2F;ul&gt;</span><br><span class="line">    &lt;&#x2F;li&gt;</span><br><span class="line"></span><br><span class="line">    &lt;li class&#x3D;&quot;active&quot; role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">        &lt;a class&#x3D;&quot;dropdown-toggle&quot; data-toggle&#x3D;&quot;&quot; href&#x3D;&quot;#&quot; role&#x3D;&quot;button&quot; aria-haspopup&#x3D;&quot;true&quot; aria-expanded&#x3D;&quot;false&quot;&gt;</span><br><span class="line">            å…³äº</span><br><span class="line">        &lt;&#x2F;a&gt;</span><br><span class="line">    &lt;&#x2F;li&gt;</span><br><span class="line">&lt;&#x2F;ul&gt;</span><br></pre></td></tr></table></figure><br>è¿™é‡Œè¾¹æœ‰ä¸€ä¸ªul å¥—ç€ä¸€ä¸ªliï¼Œä¸€ä¸ªliå¥—ç€ä¸€ä¸ªulï¼Œç¬¬äºŒä¸ª ulå°±æ˜¯äºŒçº§èœå•ã€‚</p><h3 id="mysqlä½¿ç”¨"><a href="#mysqlä½¿ç”¨" class="headerlink" title="mysqlä½¿ç”¨"></a>mysqlä½¿ç”¨</h3><p>æœ¬åœ°éœ€è¦è£…ç¯å¢ƒmysqlï¼Œç”¨æˆ·æ˜¯rootï¼Œå¯†ç æ˜¯123456ï¼Œæ•°æ®åº“æ˜¯testï¼Œæ ¼å¼æ˜¯utf8ã€‚ä¸‹è¾¹æ˜¯æˆ‘ä»¬ä¸€ä¸ªå‡½æ•°è¿”å›æŸ¥è¯¢åˆ°çš„è¡¨ä¸­æ‰€æœ‰userçš„åå­—å’Œå¹´é¾„ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">def userList():</span><br><span class="line">    con &#x3D; pymysql.connect(&#39;127.0.0.1&#39;, &#39;root&#39;, &#39;123456&#39;, &#39;test&#39;, charset&#x3D;&#39;utf8&#39;)  # æ·»åŠ utf8 å¦åˆ™ä¸­æ–‡ä¹±ç </span><br><span class="line">    cur &#x3D; con.cursor()</span><br><span class="line">    cur.execute(&#39;select * from user&#39;)</span><br><span class="line">    nums &#x3D; cur.rownumber</span><br><span class="line">    all &#x3D; cur.fetchall()</span><br><span class="line">    data &#x3D; []</span><br><span class="line">    for i in range(len(all)):</span><br><span class="line">        one &#x3D; all[i]</span><br><span class="line">        data.append(&#123;&#39;name&#39;: str(one[1]),</span><br><span class="line">                     &#39;age&#39;: one[2]&#125;)</span><br><span class="line"></span><br><span class="line">    con.close()</span><br><span class="line">    return data</span><br></pre></td></tr></table></figure></p><h3 id="æ¨¡æ¿çš„ä½¿ç”¨"><a href="#æ¨¡æ¿çš„ä½¿ç”¨" class="headerlink" title="æ¨¡æ¿çš„ä½¿ç”¨"></a>æ¨¡æ¿çš„ä½¿ç”¨</h3><p>æ¨¡æ¿æ˜¯éœ€è¦æˆ‘ä»¬åœ¨æ¨¡æ¿ä¸­å…ˆå®šä¹‰ä¸€ä¸ªç©ºçš„blockï¼Œç„¶ååœ¨ç»§æ‰¿è¿™ä¸ªhtmlï¼ŒæŠŠè¿™ä¸ªblockç»™æ·»åŠ ä¸Šï¼Œç­‰äºæŠŠä¸€ä¸ªhtmlæ–‡ä»¶åˆ†æ‹†æˆå¤šä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥ç†è§£æˆç»„ä»¶åŒ–ã€‚æ·»åŠ ä¸€ä¸ªbase.html<br>ä»£ç ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang&#x3D;&quot;zh-CN&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset&#x3D;&quot;utf-8&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv&#x3D;&quot;X-UA-Compatible&quot; content&#x3D;&quot;IE&#x3D;edge&quot;&gt;</span><br><span class="line">    &lt;meta name&#x3D;&quot;viewport&quot; content&#x3D;&quot;width&#x3D;device-width, initial-scale&#x3D;1, maximum-scale&#x3D;1, user-scalable&#x3D;no&quot;&gt;</span><br><span class="line">    &lt;!-- ä¸Šè¿°3ä¸ªmetaæ ‡ç­¾*å¿…é¡»*æ”¾åœ¨æœ€å‰é¢ï¼Œä»»ä½•å…¶ä»–å†…å®¹éƒ½*å¿…é¡»*è·Ÿéšå…¶åï¼ --&gt;</span><br><span class="line">    &lt;title&gt;Bootstrap 101 Template&lt;&#x2F;title&gt;</span><br><span class="line">    &lt;!-- jQuery (Bootstrap çš„æ‰€æœ‰ JavaScript æ’ä»¶éƒ½ä¾èµ– jQueryï¼Œæ‰€ä»¥å¿…é¡»æ”¾åœ¨å‰è¾¹) --&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;jquery&#x2F;1.12.4&#x2F;jquery.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;!-- åŠ è½½ Bootstrap çš„æ‰€æœ‰ JavaScript æ’ä»¶ã€‚ä½ ä¹Ÿå¯ä»¥æ ¹æ®éœ€è¦åªåŠ è½½å•ä¸ªæ’ä»¶ã€‚ --&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;bootstrap&#x2F;3.3.7&#x2F;js&#x2F;bootstrap.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- Bootstrap --&gt;</span><br><span class="line">    &lt;link href&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;bootstrap&#x2F;3.3.7&#x2F;css&#x2F;bootstrap.min.css&quot; rel&#x3D;&quot;stylesheet&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;!-- HTML5 shim å’Œ Respond.js æ˜¯ä¸ºäº†è®© IE8 æ”¯æŒ HTML5 å…ƒç´ å’Œåª’ä½“æŸ¥è¯¢ï¼ˆmedia queriesï¼‰åŠŸèƒ½ --&gt;</span><br><span class="line">    &lt;!-- è­¦å‘Šï¼šé€šè¿‡ file:&#x2F;&#x2F; åè®®ï¼ˆå°±æ˜¯ç›´æ¥å°† html é¡µé¢æ‹–æ‹½åˆ°æµè§ˆå™¨ä¸­ï¼‰è®¿é—®é¡µé¢æ—¶ Respond.js ä¸èµ·ä½œç”¨ --&gt;</span><br><span class="line">    &lt;!--[if lt IE 9]&gt;</span><br><span class="line">      &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;html5shiv&#x2F;3.7.3&#x2F;html5shiv.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">      &lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.bootcss.com&#x2F;respond.js&#x2F;1.4.2&#x2F;respond.min.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">    &lt;![endif]--&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line">&lt;ul class&#x3D;&quot;nav nav-tabs&quot;&gt;</span><br><span class="line">    &lt;li role&#x3D;&quot;presentation&quot; class&#x3D;&quot;dropdown&quot; id&#x3D;&quot;myDropdown&quot;&gt;</span><br><span class="line">        &lt;a class&#x3D;&quot;dropdown-toggle&quot; data-toggle&#x3D;&quot;dropdown&quot;  data-target&#x3D;&quot;#&quot; role&#x3D;&quot;button&quot; aria-haspopup&#x3D;&quot;true&quot;</span><br><span class="line">           aria-expanded&#x3D;&quot;false&quot;&gt;</span><br><span class="line">            ä¸»é¡µ &lt;span class&#x3D;&quot;caret&quot; id&#x3D;&quot;page1&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">        &lt;&#x2F;a&gt;</span><br><span class="line">        &lt;ul class&#x3D;&quot;dropdown-menu&quot; role&#x3D;&quot;menu&quot; aria-labelledby&#x3D;&quot;page1&quot;&gt;</span><br><span class="line">            &lt;li role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">                &lt;a role&#x3D;&quot;menuitem&quot; href&#x3D;&quot;add&quot;&gt;æ·»åŠ &lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">            &lt;li role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">                &lt;a role&#x3D;&quot;menuitem&quot; href&#x3D;&quot;list&quot;&gt;åˆ—è¡¨&lt;&#x2F;a&gt;&lt;&#x2F;li&gt;</span><br><span class="line">            &lt;&#x2F;li&gt;</span><br><span class="line">        &lt;&#x2F;ul&gt;</span><br><span class="line">    &lt;&#x2F;li&gt;</span><br><span class="line">    &lt;li class&#x3D;&quot;dropdown&quot;  &gt;</span><br><span class="line">        &lt;a class&#x3D;&quot;dropdown-toggle&quot; id&#x3D;&quot;group2&quot; data-toggle&#x3D;&quot;dropdown&quot; href&#x3D;&quot;#&quot; role&#x3D;&quot;button&quot;&gt;</span><br><span class="line">            æ–‡ç«  &lt;span class&#x3D;&quot;caret&quot;&gt;&lt;&#x2F;span&gt;</span><br><span class="line">        &lt;&#x2F;a&gt;</span><br><span class="line">        &lt;ul class&#x3D;&quot;dropdown-menu&quot; role&#x3D;&quot;menu&quot; aria-labelledby&#x3D;&quot;group2&quot;&gt;</span><br><span class="line">            &lt;li role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">                 &lt;a role&#x3D;&quot;menuitem&quot; href&#x3D;&quot;add&quot;&gt;æ·»åŠ &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;&#x2F;li&gt;</span><br><span class="line">            &lt;li role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">                 &lt;a role&#x3D;&quot;menuitem&quot; href&#x3D;&quot;list&quot;&gt;åˆ—è¡¨&lt;&#x2F;a&gt;</span><br><span class="line">            &lt;&#x2F;li&gt;</span><br><span class="line">            &lt;li role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">                 &lt;a role&#x3D;&quot;menuitem&quot; href&#x3D;&quot;list&quot;&gt;åˆ—è¡¨&lt;&#x2F;a&gt;</span><br><span class="line">            &lt;&#x2F;li&gt;</span><br><span class="line">        &lt;&#x2F;ul&gt;</span><br><span class="line">    &lt;&#x2F;li&gt;</span><br><span class="line"></span><br><span class="line">    &lt;li class&#x3D;&quot;active&quot; role&#x3D;&quot;presentation&quot;&gt;</span><br><span class="line">        &lt;a class&#x3D;&quot;dropdown-toggle&quot; data-toggle&#x3D;&quot;&quot; href&#x3D;&quot;#&quot; role&#x3D;&quot;button&quot; aria-haspopup&#x3D;&quot;true&quot; aria-expanded&#x3D;&quot;false&quot;&gt;</span><br><span class="line">            å…³äº</span><br><span class="line">        &lt;&#x2F;a&gt;</span><br><span class="line">    &lt;&#x2F;li&gt;</span><br><span class="line">&lt;&#x2F;ul&gt;</span><br><span class="line">è¿™ä¸‹è¾¹å°±æ˜¯å®šä¹‰çš„ç¼ºå°‘çš„block</span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure><br>ç„¶åæˆ‘ä»¬åœ¨å­ç½‘é¡µä¸­ç»§æ‰¿è¿™ä¸ªæ¨¡æ¿å¹¶ä¸”æ·»åŠ ä¸Šå»block<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;ç»§æ‰¿åˆšæ‰çš„ç½‘é¡µ</span><br><span class="line">&#123;% extends &#39;base.html&#39; %&#125;</span><br><span class="line">&#x2F;&#x2F;ä¸‹è¾¹çš„blockçš„å¯¹åº”åˆšæ‰å®šä¹‰çš„ä»£ç å—ï¼Œå¯¹åº”ä¸ä¸Šçš„è¯ï¼Œä¼šå±•ç°ä¸å‡ºæ¥ä¸‹è¾¹çš„ä»£ç </span><br><span class="line">&#123;% block page_content %&#125;</span><br><span class="line">&lt;div class&#x3D;&quot;pager&quot;&gt;</span><br><span class="line">    &lt;h1 align&#x3D;&quot;center&quot;&gt;ç”¨æˆ·åˆ—è¡¨&lt;&#x2F;h1&gt;</span><br><span class="line"></span><br><span class="line">    &lt;table class&#x3D;&quot;table nav-tabs&quot;&gt;</span><br><span class="line">        &#123;% for i in data %&#125;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">                &lt;td&gt;åå­—ï¼š&#123;&#123; i.name &#125;&#125;&lt;&#x2F;td&gt;</span><br><span class="line">                &lt;td&gt;å¹´é¾„ï¼š&#123;&#123; i.age &#125;&#125;&lt;&#x2F;td&gt;</span><br><span class="line">            &lt;&#x2F;tr&gt;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">        &lt;tr&gt;</span><br><span class="line">            &lt;td align&#x3D;&quot;center&quot;&gt;</span><br><span class="line">                &lt;a href&#x3D;&quot;add&quot;&gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;button&quot; value&#x3D;&quot;æ·»åŠ ç”¨æˆ·&quot;  align&#x3D;&quot;center&quot; style&#x3D;&quot;width: 200px&quot;&gt;</span><br><span class="line">                &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;&#x2F;td&gt;</span><br><span class="line">            &lt;td align&#x3D;&quot;center&quot;&gt;</span><br><span class="line">                &lt;a href&#x3D;&quot;list&quot; &gt;</span><br><span class="line">                    &lt;input type&#x3D;&quot;button&quot;  value&#x3D;&quot;ç”¨æˆ·åˆ—è¡¨&quot; style&#x3D;&quot;width: 200px&quot;&gt;</span><br><span class="line">                &lt;&#x2F;a&gt;</span><br><span class="line">            &lt;&#x2F;td&gt;</span><br><span class="line">        &lt;&#x2F;tr&gt;</span><br><span class="line">    &lt;&#x2F;table&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;1.è“å›¾&lt;br&gt;2.Navçš„ä½¿ç”¨&lt;br&gt;3.mysqlä½¿ç”¨&lt;br&gt;4.æ¨¡æ¿çš„ä½¿ç”¨&lt;/p&gt;
&lt;h3 id=&quot;è“å›¾ä½¿ç”¨&quot;&gt;&lt;a href=&quot;#è“å›¾ä½¿ç”¨&quot; class=&quot;headerlink&quot; title=&quot;è“å›¾ä½¿ç”¨&quot;&gt;&lt;/a&gt;è“å›¾ä½¿ç”¨&lt;/h3&gt;&lt;p&gt;æ–°å»ºuseræ–‡ä»¶å¤¹,åœ¨use
      
    
    </summary>
    
    
      <category term="Python3" scheme="http://fgyong.cn/categories/Python3/"/>
    
    
      <category term="Flask" scheme="http://fgyong.cn/tags/Flask/"/>
    
      <category term="Python3" scheme="http://fgyong.cn/tags/Python3/"/>
    
  </entry>
  
  <entry>
    <title>Python3 Flask bootstrapæ•™ç¨‹(1)</title>
    <link href="http://fgyong.cn/2018/05/27/Python3%20Flask%20bootstrap%E6%95%99%E7%A8%8B(1)/"/>
    <id>http://fgyong.cn/2018/05/27/Python3%20Flask%20bootstrap%E6%95%99%E7%A8%8B(1)/</id>
    <published>2018-05-27T04:02:22.000Z</published>
    <updated>2020-09-04T04:40:21.652Z</updated>
    
    <content type="html"><![CDATA[<p>1.å®‰è£…Flask<br>2.å®‰è£…bootstrap<br>3.HelloWord</p><h3 id="å®‰è£…Flask"><a href="#å®‰è£…Flask" class="headerlink" title="å®‰è£…Flask"></a>å®‰è£…Flask</h3><p>æˆ‘ç”¨çš„py3ï¼Œæ‰€ä»¥å®‰è£…å‘½ä»¤æ˜¯ï¼š<br><code>pip3 install Flask</code>ï¼Œå®‰è£…ä¹‹åï¼Œåœ¨Pycharmé‡Œè¾¹çœ‹åˆ°æ˜¯è¿™æ ·å­çš„ï¼Œ<br><img src="https://upload-images.jianshu.io/upload_images/783986-a4a6c6ec9ceee10a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="py3ç¬¬ä¸‰æ–¹åº“åˆ—è¡¨"></p><h3 id="å®‰è£…bootstrap"><a href="#å®‰è£…bootstrap" class="headerlink" title="å®‰è£…bootstrap"></a>å®‰è£…bootstrap</h3><p>å®‰è£…bootstrapï¼Œçœ‹è¿™é‡Œ<span class="exturl" data-url="aHR0cHM6Ly92Mi5ib290Y3NzLmNvbS9pbmRleC5odG1s" title="https://v2.bootcss.com/index.html">å®˜æ–¹æ•™ç¨‹<i class="fa fa-external-link"></i></span>,<br>æˆ–è€…<span class="exturl" data-url="aHR0cDovL2dldGJvb3RzdHJhcC5jb20vMi4zLjIvYXNzZXRzL2Jvb3RzdHJhcC56aXA=" title="http://getbootstrap.com/2.3.2/assets/bootstrap.zip">ä¸‹è½½<i class="fa fa-external-link"></i></span>ï¼Œç„¶åè§£å‹ï¼Œæ”¾åˆ°Flaskçš„ç›®å½•ä¸‹è¾¹ã€‚æˆ‘çš„ç›®å½•æ˜¯è¿™æ ·å­çš„<br><img src="https://upload-images.jianshu.io/upload_images/783986-be66520f42984dda.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="ç›®å½•"></p><h3 id="HelloWord"><a href="#HelloWord" class="headerlink" title="HelloWord"></a>HelloWord</h3><p>åˆå§‹åŒ–Flaskï¼Œ<br>æ–°å»ºapp.py<br>ä»£ç å¦‚ä¸‹ï¼š<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from flask import Flask, request, jsonify</span><br><span class="line">import os</span><br><span class="line">from api.v1 import config</span><br><span class="line">from api.v1.user import user</span><br><span class="line">from flask_bootstrap import Bootstrap</span><br><span class="line"></span><br><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line">Bootstrap(app)</span><br><span class="line">app.config.from_object(config)</span><br><span class="line">app.register_blueprint(user,url_prefix&#x3D;&#39;&#x2F;user&#39;)</span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    app.run()</span><br></pre></td></tr></table></figure><br>é€‰ä¸­æ–‡ä»¶ï¼Œå³é”®-&gt;runã€‚è¿™æ ·å­å°±è·‘èµ·æ¥äº†ï¼Œå¥½åƒç°åœ¨æ²¡æ¥å£ï¼Œé‚£æˆ‘ä»¬æ·»åŠ ä¸€ä¸ªè·¯ç”±.<br>å®Œæ•´ä»£ç å¦‚ä¸‹:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">app &#x3D; Flask(__name__)</span><br><span class="line">Bootstrap(app)</span><br><span class="line">app.config.from_object(config)</span><br><span class="line">app.register_blueprint(user,url_prefix&#x3D;&#39;&#x2F;user&#39;)</span><br><span class="line">@app.route(&#39;&#x2F;index&#39;)&#x2F;&#x2F;æ·»åŠ è·¯ç”±</span><br><span class="line">def my_index():&#x2F;&#x2F;è·¯ç”±æ‰§è¡Œçš„å‡½æ•°</span><br><span class="line">    return jsonify(&#123;&quot;key&quot;:&#39;helloWord&#39;&#125;)&#x2F;&#x2F;è¿”å›æ•°æ®</span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    app.run()&#x2F;&#x2F;appè¿è¡Œ</span><br></pre></td></tr></table></figure><br><img src="https://upload-images.jianshu.io/upload_images/783986-435882bd99cf0aa0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="helloword"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;1.å®‰è£…Flask&lt;br&gt;2.å®‰è£…bootstrap&lt;br&gt;3.HelloWord&lt;/p&gt;
&lt;h3 id=&quot;å®‰è£…Flask&quot;&gt;&lt;a href=&quot;#å®‰è£…Flask&quot; class=&quot;headerlink&quot; title=&quot;å®‰è£…Flask&quot;&gt;&lt;/a&gt;å®‰è£…Flask&lt;/h3&gt;&lt;p&gt;æˆ‘
      
    
    </summary>
    
    
      <category term="Python3" scheme="http://fgyong.cn/categories/Python3/"/>
    
    
      <category term="Flask" scheme="http://fgyong.cn/tags/Flask/"/>
    
      <category term="Python3" scheme="http://fgyong.cn/tags/Python3/"/>
    
  </entry>
  
</feed>
