<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222"/>
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"/>

<link rel="stylesheet" href="/css/main.css?v=7.1.0"/>


  <link rel="apple-touch-icon" sizes="180x180" href="/0.jpeg?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/0.jpeg?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/0.jpeg?v=7.1.0">


  <link rel="mask-icon" href="/0.jpeg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="前篇文章已经讲了GCD了，那么这两者有什么区别？ GCD VS   NSOperation “NSOperationQueue predates Grand Central Dispatch and on iOS it doesn’t use GCD to execute operations (this is different on Mac OS X). It uses regular bac">
<meta name="keywords" content="iOS,iOS高级">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS线程之NSOperation">
<meta property="og:url" content="http://fgyong.cn/2016/03/31/iOS线程之NSOperation/index.html">
<meta property="og:site_name" content="fgyong的技术博客">
<meta property="og:description" content="前篇文章已经讲了GCD了，那么这两者有什么区别？ GCD VS   NSOperation “NSOperationQueue predates Grand Central Dispatch and on iOS it doesn’t use GCD to execute operations (this is different on Mac OS X). It uses regular bac">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-12-03T04:48:00.974Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="iOS线程之NSOperation">
<meta name="twitter:description" content="前篇文章已经讲了GCD了，那么这两者有什么区别？ GCD VS   NSOperation “NSOperationQueue predates Grand Central Dispatch and on iOS it doesn’t use GCD to execute operations (this is different on Mac OS X). It uses regular bac">



  <link rel="alternate" href="/atom.xml" title="fgyong的技术博客" type="application/atom+xml"/>



  
  
  <link rel="canonical" href="http://fgyong.cn/2016/03/31/iOS线程之NSOperation/"/>



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>iOS线程之NSOperation | fgyong的技术博客</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fgyong的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">不忘初心 方得始终</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    

    
      
    

    <a href="/" rel="section">首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    

    
      
    

    <a href="/archives/" rel="section">归档<span class="badge">43</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    

    
      
    

    <a href="/tags/" rel="section">标签<span class="badge">23</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    

    
      
    

    <a href="/categories/" rel="section">分类<span class="badge">7</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    

    
      
    

    <a href="/about/" rel="section">关于</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    
  
  

  

  <a href="https://github.com/ifgyong" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>



    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2016/03/31/iOS线程之NSOperation/"/>

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong"/>
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终"/>
      <meta itemprop="image" content="/0.jpeg"/>
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyong的技术博客"/>
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">iOS线程之NSOperation

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-03-31 14:47:47" itemprop="dateCreated datePublished" datetime="2016-03-31T14:47:47+08:00">2016-03-31</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-12-03 12:48:00" itemprop="dateModified" datetime="2019-12-03T12:48:00+08:00">2019-12-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>前篇文章已经讲了GCD了，那么这两者有什么区别？</p>
<h3 id="GCD-VS-NSOperation"><a href="#GCD-VS-NSOperation" class="headerlink" title="GCD VS   NSOperation"></a>GCD VS   NSOperation</h3><blockquote>
<p>“NSOperationQueue predates Grand Central Dispatch and on iOS it doesn’t use GCD to execute operations (this is different on Mac OS X). It uses regular background threads which have a little more overhead than GCD dispatch queues.<br>On the other hand, NSOperationQueue gives you a lot more control over how your operations are executed. You can define dependencies between individual operations for example, which isn’t possible with plain GCD queues. It is also possible to cancel operations that have been enqueued in an NSOperationQueue (as far as the operations support it). When you enqueue a block in a GCD dispatch queue, it will definitely be executed at some point.<br>To sum it up, NSOperationQueue can be more suitable for long-running operations that may need to be cancelled or have complex dependencies. GCD dispatch queues are better for short tasks that should have minimum performance and memory overhead.”</p>
</blockquote>
<p>简单来说就是GCD偏底层点，性能好，依赖关系少，并发耗费资源少。<br>NSOperation可观察状态，性能也不错，处理事务更简单操作。</p>
<p>对于这两种都熟练运用的人来说，无所谓了，APP大多数事务这两者都能完美解决。至于代码用哪个这个取决于你的兴趣了。</p>
<p>下面详细说一下NSOperation</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">@interface NSOperation : NSObject &#123;</div><div class="line"></div><div class="line">- (void)start; //开始执行 默认是同步执行的</div><div class="line">- (void)main; //主任务的函数 </div><div class="line"></div><div class="line">@property (readonly, getter=isCancelled) BOOL cancelled; //是否取消</div><div class="line">- (void)cancel; //取消任务</div><div class="line"></div><div class="line">@property (readonly, getter=isExecuting) BOOL executing;//是否正在执行</div><div class="line">@property (readonly, getter=isFinished) BOOL finished; //是否完成</div><div class="line">@property (readonly, getter=isConcurrent) BOOL concurrent; // To be deprecated; use and override &apos;asynchronous&apos; below 是否并行</div><div class="line">@property (readonly, getter=isAsynchronous) BOOL asynchronous NS_AVAILABLE(10_8, 7_0); //是否异步</div><div class="line">@property (readonly, getter=isReady) BOOL ready; //是否正在等待</div><div class="line"></div><div class="line">- (void)addDependency:(NSOperation *)op; //添加依赖</div><div class="line">- (void)removeDependency:(NSOperation *)op; //删除依赖关系</div><div class="line"></div><div class="line">@property (readonly, copy) NSArray&lt;NSOperation *&gt; *dependencies; //所有依赖关系的数组</div><div class="line"></div><div class="line">typedef NS_ENUM(NSInteger, NSOperationQueuePriority) &#123;</div><div class="line">//队列优先级  优先级高的先执行 一般设置为0 即 NSOperationQueuePriorityNormal。</div><div class="line"> NSOperationQueuePriorityVeryLow = -8L,</div><div class="line"> NSOperationQueuePriorityLow = -4L,</div><div class="line"> NSOperationQueuePriorityNormal = 0,</div><div class="line"> NSOperationQueuePriorityHigh = 4,</div><div class="line"> NSOperationQueuePriorityVeryHigh = 8</div><div class="line">&#125;;</div><div class="line"></div><div class="line">@property NSOperationQueuePriority queuePriority;//队列优先级</div><div class="line"></div><div class="line">@property (nullable, copy) void (^completionBlock)(void)  NS_AVAILABLE(10_6, 4_0);//完成时候执行的代码块</div><div class="line">//等待直到完成</div><div class="line">- (void)waitUntilFinished NS_AVAILABLE(10_6, 4_0);</div><div class="line">//线程优先级</div><div class="line">@property double threadPriority NS_DEPRECATED(10_6, 10_10, 4_0, 8_0);</div><div class="line"></div><div class="line">@property NSQualityOfService qualityOfService NS_AVAILABLE(10_10, 8_0);</div><div class="line">NSQualityOfService 的几个枚举值：</div><div class="line">  NSQualityOfServiceUserInteractive：最高优先级，主要用于提供交互UI的操作，比如处理点击事件，绘制图像到屏幕上</div><div class="line">  NSQualityOfServiceUserInitiated：次高优先级，主要用于执行需要立即返回的任务</div><div class="line">  NSQualityOfServiceDefault：默认优先级，当没有设置优先级的时候，线程默认优先级</div><div class="line">  NSQualityOfServiceUtility：普通优先级，主要用于不需要立即返回的任务</div><div class="line">  NSQualityOfServiceBackground：后台优先级，用于完全不紧急的任务</div><div class="line"></div><div class="line"></div><div class="line">//名字</div><div class="line">@property (nullable, copy) NSString *name NS_AVAILABLE(10_10, 8_0);</div></pre></td></tr></table></figure>
<h3 id="NSBlockOperation"><a href="#NSBlockOperation" class="headerlink" title="NSBlockOperation"></a>NSBlockOperation</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">- (void)print&#123;</div><div class="line">    NSLog(@&quot;线程info : %@&quot;,[NSThread currentThread]);</div><div class="line">&#125;</div><div class="line">- (void)test4&#123;</div><div class="line">    NSBlockOperation * blop = [[NSBlockOperation alloc]init];</div><div class="line">    [blop addExecutionBlock:^&#123;//添加同时执行的task</div><div class="line">        NSLog(@&quot;1 start&quot;);</div><div class="line">        [self print];</div><div class="line">        sleep(2);</div><div class="line">        </div><div class="line">        NSLog(@&quot;1 end&quot;);</div><div class="line">    &#125;];</div><div class="line">    [blop addExecutionBlock:^&#123; //添加同时执行的task</div><div class="line">        NSLog(@&quot;2 start&quot;);</div><div class="line">        [self print];</div><div class="line">        sleep(4);</div><div class="line">        </div><div class="line">        NSLog(@&quot;2 end&quot;);</div><div class="line">    &#125;];</div><div class="line">    [blop addExecutionBlock:^&#123; //添加同时执行的task</div><div class="line">        NSLog(@&quot;3 start&quot;);</div><div class="line">        [self print];</div><div class="line">        sleep(1);</div><div class="line">        </div><div class="line">        NSLog(@&quot;3 end&quot;);</div><div class="line">    &#125;];</div><div class="line">    [blop setCompletionBlock:^&#123; //添加同时执行的task</div><div class="line">        NSLog(@&quot;blop end&quot;);</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    [blop start];</div><div class="line">&#125;</div><div class="line">输出：</div><div class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562249] 1 start**</div><div class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562287] 3 start**</div><div class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562288] 2 start**</div><div class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562249] ****线程****info : &lt;NSThread: 0x7fea68408b30&gt;&#123;number = 1, name = main&#125;**</div><div class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562288] ****线程****info : &lt;NSThread: 0x7fea6861fb30&gt;&#123;number = 3, name = (null)&#125;**</div><div class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562287] ****线程****info : &lt;NSThread: 0x7fea69300470&gt;&#123;number = 2, name = (null)&#125;**</div><div class="line">**2016-03-29 16:47:45.922 GCD_Demo[17555:562287] 3 end**</div><div class="line">**2016-03-29 16:47:46.858 GCD_Demo[17555:562249] 1 end**</div><div class="line">**2016-03-29 16:47:48.928 GCD_Demo[17555:562288] 2 end**</div><div class="line">**2016-03-29 16:47:48.929 GCD_Demo[17555:562288] blop end**</div></pre></td></tr></table></figure>
<p>可以看出来，NSBlockOperation当任务是1的时候在main线程中执行，任务大于1的时候，其他的个自独自开了线程，而且互不影响。</p>
<h3 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">- (void)print&#123;</div><div class="line">    NSLog(@&quot;线程info : %@&quot;,[NSThread currentThread]);</div><div class="line">&#125;</div><div class="line">- (void)test4&#123;</div><div class="line">    NSBlockOperation * blop = [[NSBlockOperation alloc]init];</div><div class="line">    [blop addExecutionBlock:^&#123;</div><div class="line">        NSLog(@&quot;blop1_1 start&quot;);</div><div class="line">        [self print];</div><div class="line">        sleep(2);</div><div class="line">        NSLog(@&quot;blop1_1 end&quot;);</div><div class="line">    &#125;];</div><div class="line">    [blop addExecutionBlock:^&#123;</div><div class="line">        NSLog(@&quot;blop1_2 start&quot;);</div><div class="line">        [self print];</div><div class="line">        sleep(4);</div><div class="line">        NSLog(@&quot;blop1_2 end&quot;);</div><div class="line">    &#125;];</div><div class="line">    NSLog(@&quot;blop will start&quot;);</div><div class="line">    [blop start];</div><div class="line">    NSLog(@&quot;blop did start&quot;);</div><div class="line">    </div><div class="line">    NSBlockOperation * blop2 =[NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">        NSLog(@&quot;blop2 start&quot;);</div><div class="line">        [self print];</div><div class="line">        sleep(2);</div><div class="line">        NSLog(@&quot;blop2 end&quot;);</div><div class="line">    &#125;];</div><div class="line">   // [blop2 addDependency:blop];//blop2 依赖blop 就是blopExecutionBlock 执行完之后再执行blop2的任务【blop2 执行task和blop 的CompletionBlock基本是同时执行的】</div><div class="line">    [blop2 start];</div><div class="line">输出：</div><div class="line">**2016-03-29 17:06:53.217 GCD_Demo[17806:574416] blop will start**</div><div class="line">**2016-03-29 17:06:53.217 GCD_Demo[17806:574416] blop1_1 start**</div><div class="line">**2016-03-29 17:06:53.217 GCD_Demo[17806:574455] blop1_2 start**</div><div class="line">**2016-03-29 17:06:53.217 GCD_Demo[17806:574416] ****线程****info : &lt;NSThread: 0x7f839a004ff0&gt;&#123;number = 1, name = main&#125;**</div><div class="line">**2016-03-29 17:06:53.218 GCD_Demo[17806:574455] ****线程****info : &lt;NSThread: 0x7f8398416d80&gt;&#123;number = 2, name = (null)&#125;**</div><div class="line">**2016-03-29 17:06:55.219 GCD_Demo[17806:574416] blop1_1 end**</div><div class="line">**2016-03-29 17:06:57.272 GCD_Demo[17806:574455] blop1_2 end**</div><div class="line">**2016-03-29 17:06:57.272 GCD_Demo[17806:574416] blop did start**</div><div class="line">**2016-03-29 17:06:57.273 GCD_Demo[17806:574416] blop2 start**</div><div class="line">**2016-03-29 17:06:57.273 GCD_Demo[17806:574416] ****线程****info : &lt;NSThread: 0x7f839a004ff0&gt;&#123;number = 1, name = main&#125;**</div><div class="line">**2016-03-29 17:06:59.274 GCD_Demo[17806:574416] blop2 end**</div></pre></td></tr></table></figure>
<p>从输出的信息可以看出来，block是同步执行的，虽然多任务是多线程，但是主线程还是在阻塞中，只有上一个所有 task 执行完的时候，才会执行下边的task。所以在这里依赖关系不那么重要了，注释掉运行结果也一样的。</p>
<h3 id="NSInvocationOperation"><a href="#NSInvocationOperation" class="headerlink" title="NSInvocationOperation"></a>NSInvocationOperation</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">NSInvocationOperation 是NSOperation的子类，负责实现operation的SEL方法。</div><div class="line">这样子operation就可以start的时候执行一些函数了。</div><div class="line">在swift中已经废弃</div><div class="line">看文档：</div><div class="line">NS_SWIFT_UNAVAILABLE(&quot;NSInvocation and related APIs not available&quot;)</div></pre></td></tr></table></figure>
<h3 id="NSOperationQueue"><a href="#NSOperationQueue" class="headerlink" title="NSOperationQueue"></a>NSOperationQueue</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line">//添加操作</div><div class="line">- (void)addOperation:(NSOperation *)op;</div><div class="line">//添加操作数组 在完成操作的时候</div><div class="line">- (void)addOperations:(NSArray&lt;NSOperation *&gt; *)ops waitUntilFinished:(BOOL)wait NS_AVAILABLE(10_6, 4_0);</div><div class="line">//添加携带代码块的operation</div><div class="line">- (void)addOperationWithBlock:(void (^)(void))block NS_AVAILABLE(10_6, 4_0);</div><div class="line">//所有的操作 组成的数组 可读属性</div><div class="line">@property (readonly, copy) NSArray&lt;__kindof NSOperation *&gt; *operations;</div><div class="line">//操作个数</div><div class="line">@property (readonly) NSUInteger operationCount NS_AVAILABLE(10_6, 4_0);</div><div class="line">//设置最大并行的任务数 ps:operation 其实 一个operation可以同时开启几个线程的。</div><div class="line">@property NSInteger maxConcurrentOperationCount;</div><div class="line">//挂起</div><div class="line">@property (getter=isSuspended) BOOL suspended;</div><div class="line">//队列的名字</div><div class="line">@property (nullable, copy) NSString *name NS_AVAILABLE(10_6, 4_0);</div><div class="line">//优先级</div><div class="line">@property NSQualityOfService qualityOfService NS_AVAILABLE(10_10, 8_0);</div><div class="line">队列</div><div class="line">@property (nullable, assign /* actually retain */) dispatch_queue_t underlyingQueue NS_AVAILABLE(10_10, 8_0);</div><div class="line">//取消所有的操作</div><div class="line">- (void)cancelAllOperations;</div><div class="line">//等到他们的操作结束</div><div class="line">- (void)waitUntilAllOperationsAreFinished;</div><div class="line">//当前的队列</div><div class="line">+ (nullable NSOperationQueue *)currentQueue NS_AVAILABLE(10_6, 4_0);</div><div class="line">//主队列</div><div class="line">+ (NSOperationQueue *)mainQueue NS_AVAILABLE(10_6, 4_0);</div><div class="line"></div><div class="line"> </div><div class="line"># 队列的例子</div><div class="line">#队列中添加的operation都是在子线程中执行的。</div><div class="line">- (void)print&#123;</div><div class="line">    NSLog(@&quot;线程info : %@&quot;,[NSThread currentThread]);</div><div class="line">&#125;</div><div class="line">- (void)op1&#123;</div><div class="line">     NSLog(@&quot;op1 开始运行了&quot;);</div><div class="line">     sleep(3);</div><div class="line">     NSLog(@&quot;op1 结束&quot;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)test5&#123;</div><div class="line">    NSInvocationOperation * op1 =[[NSInvocationOperation alloc]initWithTarget:self selector:@selector(op1) object:nil];</div><div class="line">    NSOperationQueue * queue =[[NSOperationQueue alloc]init];</div><div class="line">    [queue addOperation:op1]; //添加操作</div><div class="line">    queue.maxConcurrentOperationCount = 1;//同时允许一个operation运行</div><div class="line">    NSBlockOperation *block = [self test4];//任务块</div><div class="line">    [queue addOperation:block];//添加任务块并运行</div><div class="line"></div><div class="line">// sleep(2);  </div><div class="line">   // [queue cancelAllOperations];</div><div class="line">&#125;</div><div class="line">- (NSBlockOperation *)test4&#123;</div><div class="line">    NSBlockOperation * blop = [[NSBlockOperation alloc]init];</div><div class="line">    [blop addExecutionBlock:^&#123;</div><div class="line">        NSLog(@&quot;blop1_1 start&quot;);</div><div class="line">        [self print];</div><div class="line">        sleep(2);</div><div class="line">        NSLog(@&quot;blop1_1 end&quot;);</div><div class="line">    &#125;];</div><div class="line">    [blop addExecutionBlock:^&#123;</div><div class="line">        NSLog(@&quot;blop1_2 start&quot;);</div><div class="line">        [self print];</div><div class="line">        sleep(4);</div><div class="line">        NSLog(@&quot;blop1_2 end&quot;);</div><div class="line">    &#125;];</div><div class="line">    return blop;</div><div class="line">&#125;</div><div class="line">输出：</div><div class="line">**2016-03-31 11:22:16.663 GCD_Demo[26038:889212] op1 ****开始运行了**</div><div class="line">**2016-03-31 11:22:19.737 GCD_Demo[26038:889212] op1 ****结束**</div><div class="line">**2016-03-31 11:22:19.738 GCD_Demo[26038:889213] blop1_1 start**</div><div class="line">**2016-03-31 11:22:19.738 GCD_Demo[26038:889226] blop1_2 start**</div><div class="line">**2016-03-31 11:22:19.738 GCD_Demo[26038:889213] ****线程****info : &lt;NSThread: 0x7fea3061d110&gt;&#123;number = 2, name = (null)&#125;**</div><div class="line">**2016-03-31 11:22:19.738 GCD_Demo[26038:889226] ****线程****info : &lt;NSThread: 0x7fea31800140&gt;&#123;number = 3, name = (null)&#125;**</div><div class="line">**2016-03-31 11:22:21.808 GCD_Demo[26038:889213] blop1_1 end**</div><div class="line">**2016-03-31 11:22:23.784 GCD_Demo[26038:889226] blop1_2 end**</div><div class="line"># 从输出的信息可以看出来，当设置最大的operation为1的时候，相当于这个队列同步运行了，不过这个同步的单位不是线程，而是operation。</div><div class="line"></div><div class="line">当把这两句代码加到 test5最后边输出结果是：</div><div class="line">**2016-03-31 11:28:59.267 GCD_Demo[26113:892737] op1 ****开始运行了**</div><div class="line">**2016-03-31 11:29:02.341 GCD_Demo[26113:892737] op1 ****结束**</div><div class="line">从输出结果得出：正在执行的Operation无法stop，正在ready的operation直接跳过start，执行complateBlock.状态由ready改为canceld。ps：注意看官方文档</div><div class="line">`Canceling the operations does not automatically remove them from the queue or stop those that are currently executing.`</div><div class="line">正在执行的不会从队列中删除也不会stop。</div><div class="line">`For operations that are queued and waiting execution, the queue must still attempt to execute the operation before recognizing that it is canceled and moving it to the finished state. </div><div class="line">For operations that are already executing, the operation object itself must check for cancellation and stop what it is doing so that it can move to the finished state. </div><div class="line">In both cases, a finished (or canceled) operation is still given a chance to execute its completion block before it is removed from the queue.` </div><div class="line">正在队列中等待的operation执行的时候会检测是否被cancenld，如果状态是canceld，那么直接执行completion block 在它被队列删除的时候。</div></pre></td></tr></table></figure>
<h3 id="在子线程中耗时的操作完成了，那么该在主线程中更新UI"><a href="#在子线程中耗时的操作完成了，那么该在主线程中更新UI" class="headerlink" title="在子线程中耗时的操作完成了，那么该在主线程中更新UI"></a>在子线程中耗时的操作完成了，那么该在主线程中更新UI</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">#将上面的test5 改成下面的代码</div><div class="line">- (void)test5&#123;</div><div class="line">    NSInvocationOperation * op1 =[[NSInvocationOperation alloc]initWithTarget:self selector:@selector(op1) object:nil];</div><div class="line">    NSOperationQueue * queue =[[NSOperationQueue alloc]init];</div><div class="line">    [queue addOperation:op1];</div><div class="line">    queue.maxConcurrentOperationCount = 3;//根据需要设置数量</div><div class="line">    NSBlockOperation *block = [self test4];</div><div class="line">    [queue addOperation:block];</div><div class="line">//这句话一定要添加，这句话的意思等到所有的operation都完成了在执行后面的代码，</div><div class="line">其实就是上面的操作执行到这里要等待他们直到他们都完成了。</div><div class="line">#     [queue waitUntilAllOperationsAreFinished]; </div><div class="line">    NSBlockOperation * blockUpdateMainUI=[NSBlockOperation blockOperationWithBlock:^&#123;</div><div class="line">        NSLog(@&quot;update UI&quot;);</div><div class="line">    &#125;];</div><div class="line">    [[NSOperationQueue mainQueue] addOperation:blockUpdateMainUI];//在主队列中执行更新UI的操作</div><div class="line">&#125;</div><div class="line">上面的代码 和GCD中的分组有些类似，但是 这个OperationQueue基本单位是operation而不是线程，一定要理解。</div><div class="line">operation和线程的关系是 一个operation可能对应多个线程，也可能对应一个线程。</div></pre></td></tr></table></figure>
<p>关于NSOperationQueue的了解和使用我想到的基本就这么多场景，后期有其他的场景再补充。<br>预告：下期节目是NSThread的介绍和使用。<br>ps:广告时间</p>
<hr>
<p>有问题可以发我邮箱讨论共同交流技术。<br>fgyong@yeah.net</p>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/iOS高级/" rel="tag"># iOS高级</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/03/28/iOS线程之GCD初探/" rel="next" title="iOS线程之GCD初探">
                <i class="fa fa-chevron-left"></i> iOS线程之GCD初探
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/04/13/iOS线程之NSThread/" rel="prev" title="iOS线程之NSThread">
                iOS线程之NSThread <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/0.jpeg"
                alt="fgyong"/>
            
              <p class="site-author-name" itemprop="name">fgyong</p>
              <div class="site-description motion-element" itemprop="description">在学习的路上，不忘初心 方得始终</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">43</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">7</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                  <a href="https://github.com/ifgyong" title="GitHub &rarr; https://github.com/ifgyong" rel="noopener" target="_blank">GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                  <a href="https://juejin.im/user/5693a77b60b2c2974cdd7f7f/posts" title="掘金 &rarr; https://juejin.im/user/5693a77b60b2c2974cdd7f7f/posts" rel="noopener" target="_blank">掘金</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#GCD-VS-NSOperation"><span class="nav-number">1.</span> <span class="nav-text">GCD VS   NSOperation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSBlockOperation"><span class="nav-number">2.</span> <span class="nav-text">NSBlockOperation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖关系"><span class="nav-number">3.</span> <span class="nav-text">依赖关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSInvocationOperation"><span class="nav-number">4.</span> <span class="nav-text">NSInvocationOperation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSOperationQueue"><span class="nav-number">5.</span> <span class="nav-text">NSOperationQueue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在子线程中耗时的操作完成了，那么该在主线程中更新UI"><span class="nav-number">6.</span> <span class="nav-text">在子线程中耗时的操作完成了，那么该在主线程中更新UI</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">  <a href="http://www.miitbeian.gov.cn" rel="noopener" target="_blank">豫ICP备17045226号-1 </a>&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fgyong</span>

  

  
</div>


  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.4.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a></div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>




  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  
  <script src="/js/js.cookie.js?v=7.1.0"></script>
  <script src="/js/scroll-cookie.js?v=7.1.0"></script>


  

  

  


  
    

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css"/>



<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: 'a7800c37057fc3ce83df',
    clientSecret: '0de240e28197f071e10fcb67d4337fd8afe8a9c3',
    repo: 'ifgyong.github.io',
    owner: 'ifgyong',
    admin: ['ifgyong'],
    id: md5(location.pathname),
    
      language: 'zh-CN',
    
    distractionFreeMode: 'false'
  });
  gitalk.render('gitalk-container');
</script>

  


  




  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
