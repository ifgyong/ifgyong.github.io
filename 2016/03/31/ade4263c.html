<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.ico?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.ico?v=6.6.0">


  <link rel="mask-icon" href="/images/favicon.ico?v=6.6.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="前篇文章已经讲了GCD了，那么这两者有什么区别？ GCD VS   NSOperation “NSOperationQueue predates Grand Central Dispatch and on iOS it doesn’t use GCD to execute operations (this is different on Mac OS X). It uses regular bac">
<meta property="og:type" content="article">
<meta property="og:title" content="iOS线程之NSOperation">
<meta property="og:url" content="http://fgyong.cn/2016/03/31/ade4263c.html">
<meta property="og:site_name" content="fgyong的技术博客">
<meta property="og:description" content="前篇文章已经讲了GCD了，那么这两者有什么区别？ GCD VS   NSOperation “NSOperationQueue predates Grand Central Dispatch and on iOS it doesn’t use GCD to execute operations (this is different on Mac OS X). It uses regular bac">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2016-03-31T06:47:47.000Z">
<meta property="article:modified_time" content="2020-09-09T00:59:35.140Z">
<meta property="article:author" content="fgyong">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="iOS高级">
<meta name="twitter:card" content="summary">


  


  <link rel="alternate" href="/atom.xml" title="fgyong的技术博客" type="application/atom+xml" />




  <link rel="canonical" href="http://fgyong.cn/2016/03/31/ade4263c.html"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>iOS线程之NSOperation | fgyong的技术博客</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta custom-logo">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fgyong的技术博客</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">不忘初心 方得始终</h1>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档<span class="badge">44</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类<span class="badge">8</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签<span class="badge">24</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br />关于</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2016/03/31/ade4263c.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="在学习的路上，不忘初心 方得始终">
      <meta itemprop="image" content="/images/favicon.ico">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyong的技术博客">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">iOS线程之NSOperation
              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2016-03-31 14:47:47" itemprop="dateCreated datePublished" datetime="2016-03-31T14:47:47+08:00">2016-03-31</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2020-09-09 08:59:35" itemprop="dateModified" datetime="2020-09-09T08:59:35+08:00">2020-09-09</time>
              
            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>前篇文章已经讲了GCD了，那么这两者有什么区别？</p>
<h3 id="GCD-VS-NSOperation"><a href="#GCD-VS-NSOperation" class="headerlink" title="GCD VS   NSOperation"></a>GCD VS   NSOperation</h3><blockquote>
<p>“NSOperationQueue predates Grand Central Dispatch and on iOS it doesn’t use GCD to execute operations (this is different on Mac OS X). It uses regular background threads which have a little more overhead than GCD dispatch queues.<br>On the other hand, NSOperationQueue gives you a lot more control over how your operations are executed. You can define dependencies between individual operations for example, which isn’t possible with plain GCD queues. It is also possible to cancel operations that have been enqueued in an NSOperationQueue (as far as the operations support it). When you enqueue a block in a GCD dispatch queue, it will definitely be executed at some point.<br>To sum it up, NSOperationQueue can be more suitable for long-running operations that may need to be cancelled or have complex dependencies. GCD dispatch queues are better for short tasks that should have minimum performance and memory overhead.”</p>
</blockquote>
<p>简单来说就是GCD偏底层点，性能好，依赖关系少，并发耗费资源少。<br>NSOperation可观察状态，性能也不错，处理事务更简单操作。</p>
<p>对于这两种都熟练运用的人来说，无所谓了，APP大多数事务这两者都能完美解决。至于代码用哪个这个取决于你的兴趣了。</p>
<p>下面详细说一下NSOperation</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">@interface NSOperation : NSObject &#123;</span><br><span class="line"></span><br><span class="line">- (void)start; &#x2F;&#x2F;开始执行 默认是同步执行的</span><br><span class="line">- (void)main; &#x2F;&#x2F;主任务的函数 </span><br><span class="line"></span><br><span class="line">@property (readonly, getter&#x3D;isCancelled) BOOL cancelled; &#x2F;&#x2F;是否取消</span><br><span class="line">- (void)cancel; &#x2F;&#x2F;取消任务</span><br><span class="line"></span><br><span class="line">@property (readonly, getter&#x3D;isExecuting) BOOL executing;&#x2F;&#x2F;是否正在执行</span><br><span class="line">@property (readonly, getter&#x3D;isFinished) BOOL finished; &#x2F;&#x2F;是否完成</span><br><span class="line">@property (readonly, getter&#x3D;isConcurrent) BOOL concurrent; &#x2F;&#x2F; To be deprecated; use and override &#39;asynchronous&#39; below 是否并行</span><br><span class="line">@property (readonly, getter&#x3D;isAsynchronous) BOOL asynchronous NS_AVAILABLE(10_8, 7_0); &#x2F;&#x2F;是否异步</span><br><span class="line">@property (readonly, getter&#x3D;isReady) BOOL ready; &#x2F;&#x2F;是否正在等待</span><br><span class="line"></span><br><span class="line">- (void)addDependency:(NSOperation *)op; &#x2F;&#x2F;添加依赖</span><br><span class="line">- (void)removeDependency:(NSOperation *)op; &#x2F;&#x2F;删除依赖关系</span><br><span class="line"></span><br><span class="line">@property (readonly, copy) NSArray&lt;NSOperation *&gt; *dependencies; &#x2F;&#x2F;所有依赖关系的数组</span><br><span class="line"></span><br><span class="line">typedef NS_ENUM(NSInteger, NSOperationQueuePriority) &#123;</span><br><span class="line">&#x2F;&#x2F;队列优先级  优先级高的先执行 一般设置为0 即 NSOperationQueuePriorityNormal。</span><br><span class="line"> NSOperationQueuePriorityVeryLow &#x3D; -8L,</span><br><span class="line"> NSOperationQueuePriorityLow &#x3D; -4L,</span><br><span class="line"> NSOperationQueuePriorityNormal &#x3D; 0,</span><br><span class="line"> NSOperationQueuePriorityHigh &#x3D; 4,</span><br><span class="line"> NSOperationQueuePriorityVeryHigh &#x3D; 8</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">@property NSOperationQueuePriority queuePriority;&#x2F;&#x2F;队列优先级</span><br><span class="line"></span><br><span class="line">@property (nullable, copy) void (^completionBlock)(void)  NS_AVAILABLE(10_6, 4_0);&#x2F;&#x2F;完成时候执行的代码块</span><br><span class="line">&#x2F;&#x2F;等待直到完成</span><br><span class="line">- (void)waitUntilFinished NS_AVAILABLE(10_6, 4_0);</span><br><span class="line">&#x2F;&#x2F;线程优先级</span><br><span class="line">@property double threadPriority NS_DEPRECATED(10_6, 10_10, 4_0, 8_0);</span><br><span class="line"></span><br><span class="line">@property NSQualityOfService qualityOfService NS_AVAILABLE(10_10, 8_0);</span><br><span class="line">NSQualityOfService 的几个枚举值：</span><br><span class="line">  NSQualityOfServiceUserInteractive：最高优先级，主要用于提供交互UI的操作，比如处理点击事件，绘制图像到屏幕上</span><br><span class="line">  NSQualityOfServiceUserInitiated：次高优先级，主要用于执行需要立即返回的任务</span><br><span class="line">  NSQualityOfServiceDefault：默认优先级，当没有设置优先级的时候，线程默认优先级</span><br><span class="line">  NSQualityOfServiceUtility：普通优先级，主要用于不需要立即返回的任务</span><br><span class="line">  NSQualityOfServiceBackground：后台优先级，用于完全不紧急的任务</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F;名字</span><br><span class="line">@property (nullable, copy) NSString *name NS_AVAILABLE(10_10, 8_0);</span><br></pre></td></tr></table></figure>
<h3 id="NSBlockOperation"><a href="#NSBlockOperation" class="headerlink" title="NSBlockOperation"></a>NSBlockOperation</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">- (void)print&#123;</span><br><span class="line">    NSLog(@&quot;线程info : %@&quot;,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">- (void)test4&#123;</span><br><span class="line">    NSBlockOperation * blop &#x3D; [[NSBlockOperation alloc]init];</span><br><span class="line">    [blop addExecutionBlock:^&#123;&#x2F;&#x2F;添加同时执行的task</span><br><span class="line">        NSLog(@&quot;1 start&quot;);</span><br><span class="line">        [self print];</span><br><span class="line">        sleep(2);</span><br><span class="line">        </span><br><span class="line">        NSLog(@&quot;1 end&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    [blop addExecutionBlock:^&#123; &#x2F;&#x2F;添加同时执行的task</span><br><span class="line">        NSLog(@&quot;2 start&quot;);</span><br><span class="line">        [self print];</span><br><span class="line">        sleep(4);</span><br><span class="line">        </span><br><span class="line">        NSLog(@&quot;2 end&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    [blop addExecutionBlock:^&#123; &#x2F;&#x2F;添加同时执行的task</span><br><span class="line">        NSLog(@&quot;3 start&quot;);</span><br><span class="line">        [self print];</span><br><span class="line">        sleep(1);</span><br><span class="line">        </span><br><span class="line">        NSLog(@&quot;3 end&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    [blop setCompletionBlock:^&#123; &#x2F;&#x2F;添加同时执行的task</span><br><span class="line">        NSLog(@&quot;blop end&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    </span><br><span class="line">    [blop start];</span><br><span class="line">&#125;</span><br><span class="line">输出：</span><br><span class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562249] 1 start**</span><br><span class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562287] 3 start**</span><br><span class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562288] 2 start**</span><br><span class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562249] ****线程****info : &lt;NSThread: 0x7fea68408b30&gt;&#123;number &#x3D; 1, name &#x3D; main&#125;**</span><br><span class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562288] ****线程****info : &lt;NSThread: 0x7fea6861fb30&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125;**</span><br><span class="line">**2016-03-29 16:47:44.857 GCD_Demo[17555:562287] ****线程****info : &lt;NSThread: 0x7fea69300470&gt;&#123;number &#x3D; 2, name &#x3D; (null)&#125;**</span><br><span class="line">**2016-03-29 16:47:45.922 GCD_Demo[17555:562287] 3 end**</span><br><span class="line">**2016-03-29 16:47:46.858 GCD_Demo[17555:562249] 1 end**</span><br><span class="line">**2016-03-29 16:47:48.928 GCD_Demo[17555:562288] 2 end**</span><br><span class="line">**2016-03-29 16:47:48.929 GCD_Demo[17555:562288] blop end**</span><br></pre></td></tr></table></figure>
<p>可以看出来，NSBlockOperation当任务是1的时候在main线程中执行，任务大于1的时候，其他的个自独自开了线程，而且互不影响。</p>
<h3 id="依赖关系"><a href="#依赖关系" class="headerlink" title="依赖关系"></a>依赖关系</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">- (void)print&#123;</span><br><span class="line">    NSLog(@&quot;线程info : %@&quot;,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">- (void)test4&#123;</span><br><span class="line">    NSBlockOperation * blop &#x3D; [[NSBlockOperation alloc]init];</span><br><span class="line">    [blop addExecutionBlock:^&#123;</span><br><span class="line">        NSLog(@&quot;blop1_1 start&quot;);</span><br><span class="line">        [self print];</span><br><span class="line">        sleep(2);</span><br><span class="line">        NSLog(@&quot;blop1_1 end&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    [blop addExecutionBlock:^&#123;</span><br><span class="line">        NSLog(@&quot;blop1_2 start&quot;);</span><br><span class="line">        [self print];</span><br><span class="line">        sleep(4);</span><br><span class="line">        NSLog(@&quot;blop1_2 end&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    NSLog(@&quot;blop will start&quot;);</span><br><span class="line">    [blop start];</span><br><span class="line">    NSLog(@&quot;blop did start&quot;);</span><br><span class="line">    </span><br><span class="line">    NSBlockOperation * blop2 &#x3D;[NSBlockOperation blockOperationWithBlock:^&#123;</span><br><span class="line">        NSLog(@&quot;blop2 start&quot;);</span><br><span class="line">        [self print];</span><br><span class="line">        sleep(2);</span><br><span class="line">        NSLog(@&quot;blop2 end&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">   &#x2F;&#x2F; [blop2 addDependency:blop];&#x2F;&#x2F;blop2 依赖blop 就是blopExecutionBlock 执行完之后再执行blop2的任务【blop2 执行task和blop 的CompletionBlock基本是同时执行的】</span><br><span class="line">    [blop2 start];</span><br><span class="line">输出：</span><br><span class="line">**2016-03-29 17:06:53.217 GCD_Demo[17806:574416] blop will start**</span><br><span class="line">**2016-03-29 17:06:53.217 GCD_Demo[17806:574416] blop1_1 start**</span><br><span class="line">**2016-03-29 17:06:53.217 GCD_Demo[17806:574455] blop1_2 start**</span><br><span class="line">**2016-03-29 17:06:53.217 GCD_Demo[17806:574416] ****线程****info : &lt;NSThread: 0x7f839a004ff0&gt;&#123;number &#x3D; 1, name &#x3D; main&#125;**</span><br><span class="line">**2016-03-29 17:06:53.218 GCD_Demo[17806:574455] ****线程****info : &lt;NSThread: 0x7f8398416d80&gt;&#123;number &#x3D; 2, name &#x3D; (null)&#125;**</span><br><span class="line">**2016-03-29 17:06:55.219 GCD_Demo[17806:574416] blop1_1 end**</span><br><span class="line">**2016-03-29 17:06:57.272 GCD_Demo[17806:574455] blop1_2 end**</span><br><span class="line">**2016-03-29 17:06:57.272 GCD_Demo[17806:574416] blop did start**</span><br><span class="line">**2016-03-29 17:06:57.273 GCD_Demo[17806:574416] blop2 start**</span><br><span class="line">**2016-03-29 17:06:57.273 GCD_Demo[17806:574416] ****线程****info : &lt;NSThread: 0x7f839a004ff0&gt;&#123;number &#x3D; 1, name &#x3D; main&#125;**</span><br><span class="line">**2016-03-29 17:06:59.274 GCD_Demo[17806:574416] blop2 end**</span><br></pre></td></tr></table></figure>
<p>从输出的信息可以看出来，block是同步执行的，虽然多任务是多线程，但是主线程还是在阻塞中，只有上一个所有 task 执行完的时候，才会执行下边的task。所以在这里依赖关系不那么重要了，注释掉运行结果也一样的。</p>
<h3 id="NSInvocationOperation"><a href="#NSInvocationOperation" class="headerlink" title="NSInvocationOperation"></a>NSInvocationOperation</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NSInvocationOperation 是NSOperation的子类，负责实现operation的SEL方法。</span><br><span class="line">这样子operation就可以start的时候执行一些函数了。</span><br><span class="line">在swift中已经废弃</span><br><span class="line">看文档：</span><br><span class="line">NS_SWIFT_UNAVAILABLE(&quot;NSInvocation and related APIs not available&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="NSOperationQueue"><a href="#NSOperationQueue" class="headerlink" title="NSOperationQueue"></a>NSOperationQueue</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;添加操作</span><br><span class="line">- (void)addOperation:(NSOperation *)op;</span><br><span class="line">&#x2F;&#x2F;添加操作数组 在完成操作的时候</span><br><span class="line">- (void)addOperations:(NSArray&lt;NSOperation *&gt; *)ops waitUntilFinished:(BOOL)wait NS_AVAILABLE(10_6, 4_0);</span><br><span class="line">&#x2F;&#x2F;添加携带代码块的operation</span><br><span class="line">- (void)addOperationWithBlock:(void (^)(void))block NS_AVAILABLE(10_6, 4_0);</span><br><span class="line">&#x2F;&#x2F;所有的操作 组成的数组 可读属性</span><br><span class="line">@property (readonly, copy) NSArray&lt;__kindof NSOperation *&gt; *operations;</span><br><span class="line">&#x2F;&#x2F;操作个数</span><br><span class="line">@property (readonly) NSUInteger operationCount NS_AVAILABLE(10_6, 4_0);</span><br><span class="line">&#x2F;&#x2F;设置最大并行的任务数 ps:operation 其实 一个operation可以同时开启几个线程的。</span><br><span class="line">@property NSInteger maxConcurrentOperationCount;</span><br><span class="line">&#x2F;&#x2F;挂起</span><br><span class="line">@property (getter&#x3D;isSuspended) BOOL suspended;</span><br><span class="line">&#x2F;&#x2F;队列的名字</span><br><span class="line">@property (nullable, copy) NSString *name NS_AVAILABLE(10_6, 4_0);</span><br><span class="line">&#x2F;&#x2F;优先级</span><br><span class="line">@property NSQualityOfService qualityOfService NS_AVAILABLE(10_10, 8_0);</span><br><span class="line">队列</span><br><span class="line">@property (nullable, assign &#x2F;* actually retain *&#x2F;) dispatch_queue_t underlyingQueue NS_AVAILABLE(10_10, 8_0);</span><br><span class="line">&#x2F;&#x2F;取消所有的操作</span><br><span class="line">- (void)cancelAllOperations;</span><br><span class="line">&#x2F;&#x2F;等到他们的操作结束</span><br><span class="line">- (void)waitUntilAllOperationsAreFinished;</span><br><span class="line">&#x2F;&#x2F;当前的队列</span><br><span class="line">+ (nullable NSOperationQueue *)currentQueue NS_AVAILABLE(10_6, 4_0);</span><br><span class="line">&#x2F;&#x2F;主队列</span><br><span class="line">+ (NSOperationQueue *)mainQueue NS_AVAILABLE(10_6, 4_0);</span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"># 队列的例子</span><br><span class="line">#队列中添加的operation都是在子线程中执行的。</span><br><span class="line">- (void)print&#123;</span><br><span class="line">    NSLog(@&quot;线程info : %@&quot;,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">- (void)op1&#123;</span><br><span class="line">     NSLog(@&quot;op1 开始运行了&quot;);</span><br><span class="line">     sleep(3);</span><br><span class="line">     NSLog(@&quot;op1 结束&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)test5&#123;</span><br><span class="line">    NSInvocationOperation * op1 &#x3D;[[NSInvocationOperation alloc]initWithTarget:self selector:@selector(op1) object:nil];</span><br><span class="line">    NSOperationQueue * queue &#x3D;[[NSOperationQueue alloc]init];</span><br><span class="line">    [queue addOperation:op1]; &#x2F;&#x2F;添加操作</span><br><span class="line">    queue.maxConcurrentOperationCount &#x3D; 1;&#x2F;&#x2F;同时允许一个operation运行</span><br><span class="line">    NSBlockOperation *block &#x3D; [self test4];&#x2F;&#x2F;任务块</span><br><span class="line">    [queue addOperation:block];&#x2F;&#x2F;添加任务块并运行</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; sleep(2);  </span><br><span class="line">   &#x2F;&#x2F; [queue cancelAllOperations];</span><br><span class="line">&#125;</span><br><span class="line">- (NSBlockOperation *)test4&#123;</span><br><span class="line">    NSBlockOperation * blop &#x3D; [[NSBlockOperation alloc]init];</span><br><span class="line">    [blop addExecutionBlock:^&#123;</span><br><span class="line">        NSLog(@&quot;blop1_1 start&quot;);</span><br><span class="line">        [self print];</span><br><span class="line">        sleep(2);</span><br><span class="line">        NSLog(@&quot;blop1_1 end&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    [blop addExecutionBlock:^&#123;</span><br><span class="line">        NSLog(@&quot;blop1_2 start&quot;);</span><br><span class="line">        [self print];</span><br><span class="line">        sleep(4);</span><br><span class="line">        NSLog(@&quot;blop1_2 end&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    return blop;</span><br><span class="line">&#125;</span><br><span class="line">输出：</span><br><span class="line">**2016-03-31 11:22:16.663 GCD_Demo[26038:889212] op1 ****开始运行了**</span><br><span class="line">**2016-03-31 11:22:19.737 GCD_Demo[26038:889212] op1 ****结束**</span><br><span class="line">**2016-03-31 11:22:19.738 GCD_Demo[26038:889213] blop1_1 start**</span><br><span class="line">**2016-03-31 11:22:19.738 GCD_Demo[26038:889226] blop1_2 start**</span><br><span class="line">**2016-03-31 11:22:19.738 GCD_Demo[26038:889213] ****线程****info : &lt;NSThread: 0x7fea3061d110&gt;&#123;number &#x3D; 2, name &#x3D; (null)&#125;**</span><br><span class="line">**2016-03-31 11:22:19.738 GCD_Demo[26038:889226] ****线程****info : &lt;NSThread: 0x7fea31800140&gt;&#123;number &#x3D; 3, name &#x3D; (null)&#125;**</span><br><span class="line">**2016-03-31 11:22:21.808 GCD_Demo[26038:889213] blop1_1 end**</span><br><span class="line">**2016-03-31 11:22:23.784 GCD_Demo[26038:889226] blop1_2 end**</span><br><span class="line"># 从输出的信息可以看出来，当设置最大的operation为1的时候，相当于这个队列同步运行了，不过这个同步的单位不是线程，而是operation。</span><br><span class="line"></span><br><span class="line">当把这两句代码加到 test5最后边输出结果是：</span><br><span class="line">**2016-03-31 11:28:59.267 GCD_Demo[26113:892737] op1 ****开始运行了**</span><br><span class="line">**2016-03-31 11:29:02.341 GCD_Demo[26113:892737] op1 ****结束**</span><br><span class="line">从输出结果得出：正在执行的Operation无法stop，正在ready的operation直接跳过start，执行complateBlock.状态由ready改为canceld。ps：注意看官方文档</span><br><span class="line">&#96;Canceling the operations does not automatically remove them from the queue or stop those that are currently executing.&#96;</span><br><span class="line">正在执行的不会从队列中删除也不会stop。</span><br><span class="line">&#96;For operations that are queued and waiting execution, the queue must still attempt to execute the operation before recognizing that it is canceled and moving it to the finished state. </span><br><span class="line">For operations that are already executing, the operation object itself must check for cancellation and stop what it is doing so that it can move to the finished state. </span><br><span class="line">In both cases, a finished (or canceled) operation is still given a chance to execute its completion block before it is removed from the queue.&#96; </span><br><span class="line">正在队列中等待的operation执行的时候会检测是否被cancenld，如果状态是canceld，那么直接执行completion block 在它被队列删除的时候。</span><br></pre></td></tr></table></figure>
<h3 id="在子线程中耗时的操作完成了，那么该在主线程中更新UI"><a href="#在子线程中耗时的操作完成了，那么该在主线程中更新UI" class="headerlink" title="在子线程中耗时的操作完成了，那么该在主线程中更新UI"></a>在子线程中耗时的操作完成了，那么该在主线程中更新UI</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#将上面的test5 改成下面的代码</span><br><span class="line">- (void)test5&#123;</span><br><span class="line">    NSInvocationOperation * op1 &#x3D;[[NSInvocationOperation alloc]initWithTarget:self selector:@selector(op1) object:nil];</span><br><span class="line">    NSOperationQueue * queue &#x3D;[[NSOperationQueue alloc]init];</span><br><span class="line">    [queue addOperation:op1];</span><br><span class="line">    queue.maxConcurrentOperationCount &#x3D; 3;&#x2F;&#x2F;根据需要设置数量</span><br><span class="line">    NSBlockOperation *block &#x3D; [self test4];</span><br><span class="line">    [queue addOperation:block];</span><br><span class="line">&#x2F;&#x2F;这句话一定要添加，这句话的意思等到所有的operation都完成了在执行后面的代码，</span><br><span class="line">其实就是上面的操作执行到这里要等待他们直到他们都完成了。</span><br><span class="line">#     [queue waitUntilAllOperationsAreFinished]; </span><br><span class="line">    NSBlockOperation * blockUpdateMainUI&#x3D;[NSBlockOperation blockOperationWithBlock:^&#123;</span><br><span class="line">        NSLog(@&quot;update UI&quot;);</span><br><span class="line">    &#125;];</span><br><span class="line">    [[NSOperationQueue mainQueue] addOperation:blockUpdateMainUI];&#x2F;&#x2F;在主队列中执行更新UI的操作</span><br><span class="line">&#125;</span><br><span class="line">上面的代码 和GCD中的分组有些类似，但是 这个OperationQueue基本单位是operation而不是线程，一定要理解。</span><br><span class="line">operation和线程的关系是 一个operation可能对应多个线程，也可能对应一个线程。</span><br></pre></td></tr></table></figure>
<p>关于NSOperationQueue的了解和使用我想到的基本就这么多场景，后期有其他的场景再补充。<br>预告：下期节目是NSThread的介绍和使用。<br>ps:广告时间</p>
<hr>
<p>有问题可以发我邮箱讨论共同交流技术。<br><span class="exturl" data-url="bWFpbHRvOmZneW9uZ0B5ZWFoLm5ldA==" title="mailto:fgyong@yeah.net">fgyong@yeah.net<i class="fa fa-external-link"></i></span></p>

      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/iOS%E9%AB%98%E7%BA%A7/" rel="tag"># iOS高级</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/03/28/df6fb867.html" rel="next" title="iOS线程之GCD初探">
                <i class="fa fa-chevron-left"></i> iOS线程之GCD初探
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/04/13/541df434.html" rel="prev" title="iOS线程之NSThread">
                iOS线程之NSThread <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div id="gitalk-container">
    </div>
    
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/favicon.ico"
                alt="fgyong" />
            
              <p class="site-author-name" itemprop="name">fgyong</p>
              <p class="site-description motion-element" itemprop="description">在学习的路上，不忘初心 方得始终</p>
          </div>

          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2lmZ3lvbmc=" title="GitHub &rarr; https://github.com/ifgyong"><i class="fa fa-fw fa-github"></i>GitHub</span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uaW0vdXNlci8xNzUwMDc4MjM5MjkwOTA5" title="掘金 &rarr; https://juejin.im/user/1750078239290909"><i class="fa fa-fw fa-掘金"></i>掘金</span>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#GCD-VS-NSOperation"><span class="nav-number">1.</span> <span class="nav-text">GCD VS   NSOperation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSBlockOperation"><span class="nav-number">2.</span> <span class="nav-text">NSBlockOperation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#依赖关系"><span class="nav-number">3.</span> <span class="nav-text">依赖关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSInvocationOperation"><span class="nav-number">4.</span> <span class="nav-text">NSInvocationOperation</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#NSOperationQueue"><span class="nav-number">5.</span> <span class="nav-text">NSOperationQueue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#在子线程中耗时的操作完成了，那么该在主线程中更新UI"><span class="nav-number">6.</span> <span class="nav-text">在子线程中耗时的操作完成了，那么该在主线程中更新UI</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">  <span class="exturl" data-url="aHR0cDovL3d3dy5iZWlhbi5taWl0Lmdvdi5jbg==">豫ICP备17045226号-1 </span>&copy; 2015 – <span itemprop="copyrightYear">2021</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fgyong</span>

  

  
</div>


  <div class="powered-by">由 <span class="exturl theme-link" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> 强力驱动 v4.2.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 – <span class="exturl theme-link" data-url="aHR0cHM6Ly90aGVtZS1uZXh0Lm9yZw==">NexT.Mist</span> v6.6.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.6.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  











  
  
  <script type="text/javascript" src="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.min.js"></script>

  
  
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1.4.0/dist/gitalk.css">

  
  
  <script type="text/javascript" src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>
    
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: 'a7800c37057fc3ce83df',
          clientSecret: '0de240e28197f071e10fcb67d4337fd8afe8a9c3',
          repo: 'ifgyong.github.io',
          owner: 'ifgyong',
          admin: ['ifgyong'],
          id: md5(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')           
       </script>

  





  

  

  

  

  

  
  

  

  

  
  <script type="text/javascript" src="/js/src/exturl.js?v=6.6.0"></script>


  

  

  

</body>
</html>
