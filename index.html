<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
<meta property="og:type" content="website">
<meta property="og:title" content="fgyongçš„æŠ€æœ¯åšå®¢">
<meta property="og:url" content="http://fgyong.cn/index.html">
<meta property="og:site_name" content="fgyongçš„æŠ€æœ¯åšå®¢">
<meta property="og:description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="fgyongçš„æŠ€æœ¯åšå®¢">
<meta name="twitter:description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">



  <link rel="alternate" href="/atom.xml" title="fgyongçš„æŠ€æœ¯åšå®¢" type="application/atom+xml">




  <link rel="canonical" href="http://fgyong.cn/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>fgyongçš„æŠ€æœ¯åšå®¢</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">fgyongçš„æŠ€æœ¯åšå®¢</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">ä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>é¦–é¡µ</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>å½’æ¡£</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/24/macOS AUYä¸€æ¬¾ä¸ºå¼€å‘è€…æŸç¦åˆ©çš„APP/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyongçš„æŠ€æœ¯åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/24/macOS AUYä¸€æ¬¾ä¸ºå¼€å‘è€…æŸç¦åˆ©çš„APP/" class="post-title-link" itemprop="http://fgyong.cn/index.html">macOS ä¸€æ¬¾è‡ªåŠ¨ä¸Šä¼ å›¾åºŠçš„APP</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-24 11:15:58" itemprop="dateCreated datePublished" datetime="2019-12-24T11:15:58+08:00">2019-12-24</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-09-03 16:24:13" itemprop="dateModified" datetime="2020-09-03T16:24:13+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/macOS/" itemprop="url" rel="index"><span itemprop="name">macOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>macOSå¼€å‘å’ŒiOSæœ‰å¾ˆå¤šç›¸å…³ä¹‹å¤„ï¼Œä¹Ÿæœ‰å¾ˆå¤šä¸åŒä¹‹å¤„ï¼Œä»Šå¤©å¸¦ä½ ä½¿ç”¨æœ€ä¼˜é›…çš„<code>APP.dmg</code>,ä¸€æ¬¾åå«<code>AUY</code>çš„è‡ªåŠ¨ä¸Šä¼ å›¾åºŠçš„APPï¼Œæ²¡æœ‰æœåŠ¡å™¨ï¼Œä¸æ‹…å¿ƒæ•°æ®è¢«ç›—ï¼Œå¯ä»¥ä¸Šä¼ å‰ªåˆ‡æ¿ä¸­çš„å›¾ç‰‡ï¼Œå¯ä»¥æ‹–åŠ¨æ–‡ä»¶ä¸Šä¼ ã€æ™ºèƒ½çš„APPã€‚</p>
<h2 id="AUY-ä¼ é€é—¨"><a href="#AUY-ä¼ é€é—¨" class="headerlink" title="AUY ä¼ é€é—¨"></a><a href="https://github.com/ifgyong/AUY/releases" target="_blank" rel="noopener">AUY ä¼ é€é—¨</a></h2><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><ul>
<li>æ›´å°‘çš„æ“ä½œæ­¥éª¤å®Œæˆç›®æ ‡ã€‚</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/05/APPèµ„æºä¼˜åŒ–/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyongçš„æŠ€æœ¯åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/05/APPèµ„æºä¼˜åŒ–/" class="post-title-link" itemprop="http://fgyong.cn/index.html">APP èµ„æºç®¡ç†ä¼˜åŒ–</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-05 11:15:58" itemprop="dateCreated datePublished" datetime="2019-12-05T11:15:58+08:00">2019-12-05</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-09-03 16:24:13" itemprop="dateModified" datetime="2020-09-03T16:24:13+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>åœ¨APPä¸­ï¼Œä½¿ç”¨ X1ã€X2ã€X3å·²ç»æ˜¯å¸ç©ºè§æƒ¯çš„äº‹æƒ…äº†ï¼Œç½‘ä¸Šå‡ºäº†æ¸…ç©ºä¸å†ä½¿ç”¨çš„å›¾ç‰‡å’Œç±»ï¼Œæ˜¯ä¸æ˜¯åšå®Œè¿™äº›ä¸èƒ½å†è¿›ä¸€æ­¥ä¼˜åŒ–äº†ï¼Œç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå½“ç„¶å¯ä»¥çš„ï¼Œä»Šå¤©å†æ¢ç©¶ä¸€ä¸‹èµ„æºç®¡ç†ä¼˜åŒ–ã€‚</p>
<p>èµ„æºå¤§éƒ¨åˆ†æ˜¯å›¾ç‰‡ï¼Œè¯´åˆ°å›¾ç‰‡å¿…é¡»è®²ä¸€ä¸‹ä½å›¾å’ŒçŸ¢é‡å›¾</p>
<h3 id="ä½å›¾"><a href="#ä½å›¾" class="headerlink" title="ä½å›¾"></a>ä½å›¾</h3><blockquote>
<p>ä½å›¾å›¾åƒï¼ˆbitmapï¼‰ï¼Œäº¦ç§°ä¸ºç‚¹é˜µå›¾åƒæˆ–æ …æ ¼å›¾åƒï¼Œæ˜¯ç”±ç§°ä½œåƒç´ ï¼ˆå›¾ç‰‡å…ƒç´ ï¼‰çš„å•ä¸ªç‚¹ç»„æˆçš„ã€‚è¿™äº›ç‚¹å¯ä»¥è¿›è¡Œä¸åŒçš„æ’åˆ—å’ŒæŸ“è‰²ä»¥æ„æˆå›¾æ ·ã€‚å½“æ”¾å¤§ä½å›¾æ—¶ï¼Œå¯ä»¥çœ‹è§èµ–ä»¥æ„æˆæ•´ä¸ªå›¾åƒçš„æ— æ•°å•ä¸ªæ–¹å—ã€‚æ‰©å¤§ä½å›¾å°ºå¯¸çš„æ•ˆæœæ˜¯å¢å¤§å•ä¸ªåƒç´ ï¼Œä»è€Œä½¿çº¿æ¡å’Œå½¢çŠ¶æ˜¾å¾—å‚å·®ä¸é½ã€‚</p>
</blockquote>
<h3 id="çŸ¢é‡å›¾"><a href="#çŸ¢é‡å›¾" class="headerlink" title="çŸ¢é‡å›¾"></a>çŸ¢é‡å›¾</h3><blockquote>
<p>çŸ¢é‡å›¾ï¼Œä¹Ÿç§°ä¸ºé¢å‘å¯¹è±¡çš„å›¾åƒæˆ–ç»˜å›¾å›¾åƒï¼Œåœ¨æ•°å­¦ä¸Šå®šä¹‰ä¸ºä¸€ç³»åˆ—ç”±çº¿è¿æ¥çš„ç‚¹ã€‚çŸ¢é‡æ–‡ä»¶ä¸­çš„å›¾å½¢å…ƒç´ ç§°ä¸ºå¯¹è±¡ã€‚æ¯ä¸ªå¯¹è±¡éƒ½æ˜¯ä¸€ä¸ªè‡ªæˆä¸€ä½“çš„å®ä½“ï¼Œå®ƒå…·æœ‰é¢œè‰²ã€å½¢çŠ¶ã€è½®å»“ã€å¤§å°å’Œå±å¹•ä½ç½®ç­‰å±æ€§ã€‚<br>çŸ¢é‡å›¾æ˜¯æ ¹æ®å‡ ä½•ç‰¹æ€§æ¥ç»˜åˆ¶å›¾å½¢ï¼ŒçŸ¢é‡å¯ä»¥æ˜¯ä¸€ä¸ªç‚¹æˆ–ä¸€æ¡çº¿ï¼ŒçŸ¢é‡å›¾åªèƒ½é è½¯ä»¶ç”Ÿæˆï¼Œæ–‡ä»¶å ç”¨å†…åœ¨ç©ºé—´è¾ƒå°ï¼Œå› ä¸ºè¿™ç§ç±»å‹çš„å›¾åƒæ–‡ä»¶åŒ…å«ç‹¬ç«‹çš„åˆ†ç¦»å›¾åƒï¼Œå¯ä»¥è‡ªç”±æ— é™åˆ¶çš„é‡æ–°ç»„åˆã€‚</p>
</blockquote>
<h3 id="è¯´äººè¯"><a href="#è¯´äººè¯" class="headerlink" title="è¯´äººè¯"></a>è¯´äººè¯</h3><blockquote>
<p>ä½å›¾å°±æ˜¯æ— æ•°ä¸ªç‚¹ç»„æˆçš„å›¾ç‰‡ï¼ŒåŸºæœ¬å…ƒç´ æ˜¯åƒç´ ï¼›çŸ¢é‡å›¾æœ‰å¤šä¸ªå›¾å½¢ç»„æˆçš„ï¼ŒåŸºæœ¬å…ƒç´ æ˜¯å›¾åƒã€‚å½“ç›¸åŒå°ºå¯¸çš„ä½å›¾å’ŒçŸ¢é‡å›¾ç»˜åˆ¶åœ¨å¤§å±å¹•ä¸Šï¼Œä½å›¾çš„å¼Šç«¯å‡ºç°äº†ï¼Œå›¾åƒçœ‹ç€åƒç´ é¢—ç²’å¾ˆå¤§ï¼Œè€ŒçŸ¢é‡å›¾åŸºæœ¬æ•ˆæœè¿˜æ˜¯å¾ˆå¥½çš„ã€‚</p>
</blockquote>
<p>çŸ¢é‡å›¾åœ¨ç»˜åˆ¶åˆ°ä¸åŒçš„å±å¹•ä¸Šæœ‰ç€å¤©ç„¶çš„ä¼˜åŠ¿ã€‚</p>
<h2 id="å¼€å§‹ä½¿ç”¨çŸ¢é‡å›¾"><a href="#å¼€å§‹ä½¿ç”¨çŸ¢é‡å›¾" class="headerlink" title="å¼€å§‹ä½¿ç”¨çŸ¢é‡å›¾"></a>å¼€å§‹ä½¿ç”¨çŸ¢é‡å›¾</h2><p>åœ¨Xcdoe 9ã€iOS11 ä¸­å·²ç»å¼€å§‹æ”¯æŒäº†çŸ¢é‡å›¾ï¼Œåªéœ€è¦è®¾ç½®æ‰“é’©<code>Preserve Cector Dadta</code>ã€‚<br><img src="http://blog.fgyong.cn/FhF6-GTsthDXMlsX9ezQ1PaXalIa.png-a" alt></p>
<p><strong>å‰æå›¾ç‰‡æ ¼å¼æ˜¯çŸ¢é‡å›¾å“¦</strong></p>
<p>çŸ¢é‡å›¾åœ¨èµ„æºå¤§å°ä¸­ç›¸æ¯”å’Œä¸€å€ã€ä¸¤å€ã€ä¸‰å€å›¾æ€»å’Œï¼Œå¤§å°ä¸‹é™<strong>60%</strong>ï¼Œè¿™ç®—æ˜¯ä¸é”™çš„æå‡äº†ã€‚</p>
<h2 id="Stretchable-Images"><a href="#Stretchable-Images" class="headerlink" title="Stretchable Images"></a>Stretchable Images</h2><p>ä»iOS11ã€Xcode 9å°±å¼€å§‹æ”¯æŒäº†è¯¥å·¥å…·ï¼Œè¯¥å·¥å…·å¯å®ç°åœ¨<code>building</code>ä¸­å°†å›¾ç‰‡å…ƒæ•°æ®æ ¼æ …åŒ–ï¼Œå„¿ä¸æ˜¯åœ¨è¿è¡Œæ—¶å¤„ç†ï¼Œé™ä½å›¾ç‰‡åœ¨æ˜¾ç¤ºæ—¶å€™çš„CPUå‹åŠ›ã€‚<br>å½“æ¸²æŸ“çš„å°ºå¯¸å¤§äºå½“å‰çš„å°ºå¯¸çš„æ—¶å€™æ‰ä¼šé‡æ–°æ¸²æŸ“ï¼Œå¦åˆ™ä½¿ç”¨ä¼˜åŒ–è¿‡çš„é¢„æ¸²æŸ“ä½å›¾ã€‚<br>æ•ˆæœæ˜¯è¿™æ ·å­çš„</p>
<p><img src="http://blog.fgyong.cn/FpZhgVvqS711QZZnYYptKr40Pc9U-a" alt></p>
<h4 id="Slicing"><a href="#Slicing" class="headerlink" title="Slicing"></a>Slicing</h4><h5 id="Slices"><a href="#Slices" class="headerlink" title="Slices"></a>Slices</h5><ul>
<li>None æ— </li>
<li>Horizontal æ°´å¹³</li>
<li>Vertical ç«–ç›´</li>
<li>Horizontal and Vertical æ°´å¹³å’Œç«–ç›´ </li>
</ul>
<h5 id="Center"><a href="#Center" class="headerlink" title="Center"></a>Center</h5><ul>
<li>Tiles å¹³é“º</li>
<li>Streches æ‹‰ä¼¸</li>
</ul>
<p>ä½¿ç”¨è¿™ä¸¤ç»„å‚æ•°å¯ä»¥è¾¾åˆ°ç»å¤§éƒ¨åˆ†éœ€æ±‚äº†</p>
<p><img src="http://blog.fgyong.cn/FrtLZrygVGyJAqlV6Q412foMQgRk-a" alt></p>
<p>å½“æˆ‘ä»¬ä½¿ç”¨ä¸‹å›¾è¿™ç§å›¾ç‰‡ï¼Œæå‰å’ŒUIè®²æ¸…æ¥šï¼Œä½œå‡ºä¸€ä¸ªå°å›¾ï¼Œåœ¨è®¾å¤‡ä¸Šä½¿ç”¨<code>Stretchable Images</code>åŠŸèƒ½ï¼Œå¯ä»¥è¾¾åˆ°å¤§å›¾çš„æ•ˆæœã€‚</p>
<p><img src="http://blog.fgyong.cn/FvHCZgiiwONF_5Y01HOVP_-d9d3_-a" alt><br>ç™½è‰²éƒ¨åˆ†è¡¨ç¤ºå¯æ‹‰ä¼¸å’Œèˆå¼ƒçš„<br><img src="http://blog.fgyong.cn/Fh6BK-44VNuB2PDdQUjaA-2iOF_J-a" alt></p>
<p>æœ€ç»ˆæ•ˆæœæ˜¯è¿™æ ·çš„</p>
<p><img src="http://blog.fgyong.cn/1.mp4" alt></p>
<p>ğŸ‘ğŸ‘ğŸ‘ğŸ‘</p>
<p>æ›´å¤šç”¨æ³•å¯ä»¥å‚è€ƒ<a href="https://developer.apple.com/videos/play/wwdc2018/227" target="_blank" rel="noopener">WWDC2018/227</a></p>
<h2 id="Bundle"><a href="#Bundle" class="headerlink" title="Bundle"></a>Bundle</h2><p>å¤§é¡¹ç›®å¯èƒ½ä¼šæœ‰å¾ˆå¤šæ¡†æ¶ï¼Œå½“å¤šä¸ªæ¡†æ¶ä½¿ç”¨çš„å›¾ç‰‡åå­—å‘ç”Ÿé‡å¤æ—¶ï¼Œä½¿ç”¨<code>Bundle</code>æ˜¯ä¸é”™çš„é€‰æ‹©ï¼Œ<code>Bundle</code>ç›¸å½“äºæ–‡ä»¶å¤¹ï¼Œç›¸åŒ<code>Bundle</code>ä¸‹è¾¹æ²¡æœ‰é‡å¤çš„æ–‡ä»¶å³å¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// Get the app&apos;s main bundle</span><br><span class="line">let mainBundle = Bundle.main</span><br><span class="line"></span><br><span class="line">//è·å–æœ¬åœ°Bundle å›¾ç‰‡</span><br><span class="line">let me = Bundle.init(identifier: &quot;me&quot;)</span><br><span class="line">let path = me?.path(forResource: &quot;fgyong.cn æŠ€æœ¯åšå®¢&quot;, ofType: &quot;png&quot;)</span><br></pre></td></tr></table></figure>
<h2 id="Namespace"><a href="#Namespace" class="headerlink" title="Namespace"></a>Namespace</h2><p>å½“APPæœ‰50ä¸ªç±»ä¼¼çš„åŠŸèƒ½ï¼Œä½†æ˜¯æ¯ä¸ªåŠŸèƒ½éƒ½ç”¨ç±»ä¼¼çš„å›¾ç‰‡ï¼Œé‚£ä¹ˆä»–ä»¬åå­—ä¹Ÿä¸€è‡´ï¼Œæˆ‘ä»¬ä½¿ç”¨<code>Namespace</code>æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚<br><img src="http://blog.fgyong.cn/FqvcOJHbjHBdE04jl78PlT3pAA4l-a" alt></p>
<p>ä½¿ç”¨èµ·æ¥ä¹Ÿæ˜¯å¾ˆç®€å•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">let image = UIImage(named: &quot;me/4.png&quot;)</span><br></pre></td></tr></table></figure>
<h2 id="APP-Thining"><a href="#APP-Thining" class="headerlink" title="APP Thining"></a>APP Thining</h2><h3 id="Memory-Classes-amp-amp-Graphics-Classes"><a href="#Memory-Classes-amp-amp-Graphics-Classes" class="headerlink" title="Memory Classes &amp;&amp; Graphics Classes"></a>Memory Classes &amp;&amp; Graphics Classes</h3><p>ä½¿ç”¨å†…å­˜å’ŒMetalæ¥é€‚é…ä¸åŒæœºå‹ï¼Œè¾¾åˆ°æœ€ä¼˜æ€§èƒ½ã€‚</p>
<p><img src="http://blog.fgyong.cn/FgJGgpqcA-K_kSKY6e9LDZapOiYT-a" alt></p>
<p>é¦–å…ˆæœºå‹å…ˆå»æ‰¾4GBçš„èµ„æºï¼Œ4GBæ²¡æ‰¾åˆ°ï¼Œåˆ™å‘ä¸‹å¯»æ‰¾3GBï¼Œä¸€ç›´å¯»æ‰¾åˆ°1GBå¯¹åº”çš„èµ„æºã€‚</p>
<p>å†…å­˜å’ŒGPUç›¸æ¯”ï¼Œå†…å­˜æœ‰ç€æ›´é«˜çš„ä¼˜å…ˆçº§ï¼Œæˆ‘ä»¬ç¡®å®šå†…å­˜æ˜¯è¡¨ç°è®¾å¤‡æ•´ä½“æ€§èƒ½çš„æ ‡å‡†ã€‚</p>
<h2 id="NSSData-set"><a href="#NSSData-set" class="headerlink" title="NSSData set"></a>NSSData set</h2><p><code>Data set</code>å®¹å™¨å¯ä»¥æ”¾ä»»ä½•ä¸œè¥¿ã€‚<br>å¯ä»¥æ˜¯<code>plist</code>æ–‡ä»¶ï¼Œå¯ä»¥æ˜¯<code>video</code>ã€å¯ä»¥æ˜¯<code>mp3</code>ï¼Œå¯ä»¥æ˜¯å…¶ä»–ä»»ä½•æ ¼å¼çš„æ–‡ä»¶ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">open class func preloadTextureAtlasesNamed(_ atlasNames: [String], withCompletionHandler completionHandler: @escaping (Error?, [SKTextureAtlas]) -&gt; Void)</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨è¯¥å‡½æ•°ç«‹åˆ»è°ƒç”¨å¤§é‡I/Oå’Œå†…å­˜æ¥è§£ç æˆ–è¯»å…¥æ•°æ®ï¼Œé¢„å…ˆæ”¾åœ¨å†…å­˜ä¸­ï¼Œä½ éœ€è¦åœ¨ç´§æ€¥éœ€è¦çš„æ—¶å€™è°ƒç”¨è¯¥å‡½æ•°ã€‚ä¸è¦éšæ„è°ƒç”¨è¯¥APIï¼Œä»¥ä¸ºå®ƒä¼šæŒ‰ç…§ä½ è¯´çš„<strong>ç«‹é©¬</strong>å»åšï¼âš ï¸âš ï¸âš ï¸å½“ä½ è°ƒç”¨è¯¥å‡½æ•°ï¼Œè¯·ç¡®ä¿ç«‹å³ä½¿ç”¨èµ„æºï¼Œå¦åˆ™APIä¼šæ¶ˆè€—å¤§é‡çš„I/Oå’Œå†…å­˜æ¥åŠ è½½æ‰€æœ‰è¿™äº›å›¾åƒã€‚</p>
<p><code>Sprite Atlases</code>å¼ºå¤§ä¹‹å¤„æ˜¯ä¼šæ ¹æ®ä¸åŒè®¾å¤‡å’Œå±å¹•æ¥æ¸²æŸ“ä¸åŒçš„å›¾åƒï¼Œå¹¶ä¼ é€åˆ°æ­£ç¡®çš„è®¾å¤‡ã€‚</p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><img src="http://blog.fgyong.cn/Fld0tbjb_RgbF9QWnzTXUYrZJzhG-a" alt></p>
<ul>
<li>åœ¨iOS12ä¸Šé‡‡ç”¨æœ€æ–°çš„ç®—æ³•ï¼Œè¿™äº›å›¾åƒèµ„æºä¼šå‡å°‘10%-20%çš„ç©ºé—´ï¼Œ</li>
<li>ä½¿ç”¨Xcodeçš„èµ„æºç›®å½•æ˜¯ä¸é”™çš„é€‰æ‹©</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/03/iOSå›¾ç‰‡ä¼˜åŒ– /">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyongçš„æŠ€æœ¯åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/03/iOSå›¾ç‰‡ä¼˜åŒ– /" class="post-title-link" itemprop="http://fgyong.cn/index.html">iOSå›¾ç‰‡ä¼˜åŒ–</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-03 11:15:58" itemprop="dateCreated datePublished" datetime="2019-12-03T11:15:58+08:00">2019-12-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-09-03 16:24:13" itemprop="dateModified" datetime="2020-09-03T16:24:13+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>åŸºäºç°åœ¨iOS11æ–°ç”Ÿæˆçš„å›¾ç‰‡éƒ½æ˜¯<code>HEIF</code>ï¼Œè¯¥å›¾ç‰‡ä½¿ç”¨<code>[UIImage image:name]</code>å·²ä¸åœ¨é‚£ä¹ˆä¼˜é›…ï¼Œå›¾ç‰‡å¤§å°ä¸º1.8må¤§å°çš„ï¼Œè¯»è¿›æ‰‹æœºå†…å­˜ï¼Œç›´æ¥é£™å‡äº†45Mï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸æƒ³çœ‹åˆ°çš„ç»“æœï¼Œä¸€ä¸ªé¡µé¢æœ‰å¤šä¸ªè¿™æ ·å­çš„å›¾çš„è¯ï¼Œææ€•å°±æ˜¯ç¾éš¾äº†ã€‚</p>
<p>æ—¢ç„¶åŸå›¾ä¸èƒ½è¯»å…¥ï¼Œé‚£ä¹ˆå¦‚ä½•å¯ä»¥ç”¨æ›´å°‘çš„å†…å­˜å’ŒCPUæ¥è§£å†³å‘¢?</p>
<p>è¿™å°±è¦å…ˆäº†è§£è¯¥å›¾ç‰‡çš„ç¼–ç äº†ã€‚</p>
<h2 id="HEIC-HEIF"><a href="#HEIC-HEIF" class="headerlink" title="HEIC HEIF"></a>HEIC HEIF</h2><blockquote>
<p>å¸¦æœ‰å…ƒæ•°æ®çš„HEIFçš„å¦ä¸€ç§å½¢å¼ã€‚HEICæ–‡ä»¶åŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªä»¥â€œé«˜æ•ˆå›¾åƒæ ¼å¼â€ï¼ˆHEIFï¼‰ä¿å­˜çš„å›¾åƒï¼Œè¯¥æ ¼å¼é€šå¸¸ç”¨äºåœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå­˜å‚¨ç…§ç‰‡ã€‚å®ƒå¯èƒ½åŒ…å«å•ä¸ªå›¾åƒæˆ–å›¾åƒåºåˆ—ä»¥åŠæè¿°æ¯ä¸ªå›¾åƒçš„å…ƒæ•°æ®ã€‚æœ€å¸¸ä½¿ç”¨æ–‡ä»¶æ‰©å±•åâ€œ .heicâ€ï¼Œä½†HEICæ–‡ä»¶ä¹Ÿå¯èƒ½æ˜¾ç¤ºä¸º.HEIFæ–‡ä»¶</p>
</blockquote>
<p><code>heic</code>å’Œ<code>heif</code>æ˜¯å¹¿è‰²åŸŸå›¾ç‰‡çš„æ ¼å¼ï¼Œå¹¿è‰²åŸŸæ¯”<code>sRGB</code>è¡¨ç¤ºèŒƒå›´å¤§25%ï¼Œåœ¨å¹¿è‰²åŸŸè®¾å¤‡ä¸­èƒ½æ˜¾ç¤ºæ›´å¹¿çš„è‰²å½©ï¼Œ<code>sRGB 8bit/dept</code>ï¼Œå¹¿è‰²åŸŸè¾¾åˆ°<code>16bit/dept</code>ã€‚å¹¿è‰²åŸŸåªæ˜¯åœ¨ç¡¬ä»¶æ”¯æŒçš„æƒ…å†µä¸‹æ‰èƒ½æ˜¾ç¤ºçš„ã€‚<br>å…¶å®å°±æ˜¯è‹¹æœæçš„ä¸€ä¸ªæ›´é«˜æ•ˆä½“ç§¯æ›´å°æ•ˆç‡æ›´é«˜çš„å‹ç¼©æ–¹å¼ã€‚</p>
<h2 id="åŠ è½½"><a href="#åŠ è½½" class="headerlink" title="åŠ è½½"></a>åŠ è½½</h2><p>åŠ è½½<code>image</code>ï¼Œåªæ˜¯æŠŠ<strong>æ–‡ä»¶ä¿¡æ¯</strong>åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è§£ç ã€‚åœ¨ä»£ç ä¸­ä½“ç°å°±æ˜¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let image = UIImage(contentsOfFile: url.path)</span><br><span class="line">æˆ– åŠ è½½å›¾ç‰‡åˆ°å†…å­˜ ä¼šå¸¸é©»å†…å­˜</span><br><span class="line">let image = UIImage(named: name)!</span><br></pre></td></tr></table></figure></p>
<h2 id="è§£ç "><a href="#è§£ç " class="headerlink" title="è§£ç "></a>è§£ç </h2><p>å…¶å®æ˜¯å‘ç”Ÿåœ¨æ·»åŠ åˆ°è¦æ˜¾ç¤ºçš„viewä¸Šé¢æ‰ä¼šè§£ç <br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">let imageV = UIImageView.init(image: image)</span><br><span class="line">imageV.frame = CGRect(x: 50, y: (250 * i) + 100, width: 200, height: 200)</span><br><span class="line">self.view.addSubview(imageV)</span><br></pre></td></tr></table></figure></p>
<p>æœ€åä¸€è¡Œä¸å†™ï¼Œåˆ™ä¸ä¼šè§£ç ã€‚</p>
<h2 id="æ¸²æŸ“"><a href="#æ¸²æŸ“" class="headerlink" title="æ¸²æŸ“"></a>æ¸²æŸ“</h2><p>å½“<code>view</code>æ˜¾ç¤ºå‡ºæ¥åˆ™æ˜¯æ¸²æŸ“ã€‚è¿‡ç¨‹æ˜¯è§£ç çš„<code>data buffer</code> å¤åˆ¶åˆ°<code>frame buffer</code>,ç¡¬ä»¶ä»å¸§ç¼“å†²åŒºè¯»å–æ•°æ®æ˜¾ç¤ºåˆ°å±å¹•ä¸Šã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">self.view.addSubview(imageV)</span><br></pre></td></tr></table></figure></p>
<h2 id="å†…å­˜æš´æ¶¨åŸå› "><a href="#å†…å­˜æš´æ¶¨åŸå› " class="headerlink" title="å†…å­˜æš´æ¶¨åŸå› "></a>å†…å­˜æš´æ¶¨åŸå› </h2><p>ä¸€éƒ¨åˆ†å›¾ç‰‡åŠ è½½åˆ°å†…å­˜ï¼Œåœ¨è§£ç è¿‡ç¨‹ä¸­å‡ºç°äº†å†…å­˜æš´æ¶¨é—®é¢˜ï¼Œä»Šå¤©æ¢ç©¶ä¸€ä¸‹åŸå› å’Œè§£å†³æ–¹æ¡ˆã€‚</p>
<p>é¦–å…ˆæœ‰è¯·æˆ‘ä»¬å‡†å¤‡çš„ç´ æå’Œè®¾å¤‡(6s 64gç‰ˆæœ¬)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">A:jpg</span><br><span class="line">20M 12000*12000</span><br><span class="line"></span><br><span class="line">B:jpg</span><br><span class="line">2.8M 3024*4032</span><br><span class="line"></span><br><span class="line">C:HEIC</span><br><span class="line">1.8M 3024*4032</span><br></pre></td></tr></table></figure></p>
<p>ç´ æA<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">APPè¿è¡Œå†…å­˜ï¼š13.8M</span><br><span class="line">åŠ è½½Image: 240.3Mä¹‹åç¨³å®šåˆ°220M</span><br><span class="line">CPUï¼šå³°å€¼5%ï¼Œéšåé™ä½åˆ°0%</span><br><span class="line">imageå å†…å­˜ï¼š226.5M</span><br></pre></td></tr></table></figure></p>
<p>ç´ æB<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">APPè¿è¡Œå†…å­˜ï¼š13.7M</span><br><span class="line">åŠ è½½Image: 31.5</span><br><span class="line">CPUï¼šå³°å€¼5%ï¼Œéšåé™ä½åˆ°0%</span><br><span class="line">imageå å†…å­˜ï¼š17.8M</span><br></pre></td></tr></table></figure></p>
<p>ç´ æC<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">APPè¿è¡Œå†…å­˜ï¼š13.8M</span><br><span class="line">åŠ è½½Image: 32.3</span><br><span class="line">CPUï¼šå³°å€¼4%ï¼Œéšåé™ä½åˆ°0%</span><br><span class="line">imageå å†…å­˜ï¼š18.5M</span><br></pre></td></tr></table></figure></p>
<p>æˆ‘ä»¬çŒœæµ‹æ˜¯å¦æ˜¯<code>imageView</code>çš„å¤§å°å½±å“å†…å­˜çš„å‘¢ï¼Ÿ<br><code>size</code>æ”¹ä¸ºåŸæ¥çš„1/10ç»“æœè¿è¡Œå†…å­˜è¿˜æ˜¯å’Œä»¥å‰ä¸€æ ·ã€‚</p>
<p>ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ</p>
<blockquote>
<p>å†…å­˜å¤§å°ä¸æ˜¯å–å†³äº<code>view</code>çš„<code>size</code>ï¼Œè€Œæ˜¯åŸå§‹æ–‡ä»¶<strong>image size</strong>ã€‚</p>
</blockquote>
<p><img src="/images/14-1.png" alt></p>
<h3 id="æ¸²æŸ“æ ¼å¼"><a href="#æ¸²æŸ“æ ¼å¼" class="headerlink" title="æ¸²æŸ“æ ¼å¼"></a>æ¸²æŸ“æ ¼å¼</h3><h4 id="SRGB"><a href="#SRGB" class="headerlink" title="SRGB"></a>SRGB</h4><p>æ¯ä¸ªåƒç´ 4å­—èŠ‚ï¼ŒåŒ…å«çº¢é»„è“å’Œé€æ˜åº¦ï¼Œæ¯ä¸ªé€šé“æ˜¯1å­—èŠ‚8ä½ã€‚</p>
<h4 id="display-p3-å®½è‰²åŸŸ"><a href="#display-p3-å®½è‰²åŸŸ" class="headerlink" title="display p3 å®½è‰²åŸŸ"></a>display p3 å®½è‰²åŸŸ</h4><p>æ¯ä¸ªåƒç´ 8å­—èŠ‚ï¼ŒåŒ…å«çº¢é»„è“å’Œé€æ˜åº¦ï¼Œæ¯ä¸ªé€šé“æ˜¯2å­—èŠ‚16ä½ã€‚ä½¿ç”¨æœºå‹iphone7 ã€iphone8ã€iphone XåŠä»¥åçš„è®¾å¤‡ï¼Œä¸æ”¯æŒè¯¥æ ¼å¼çš„æœºå‹æ— æ³•æ˜¾ç¤ºè¯¥æ•ˆæœã€‚</p>
<h4 id="äº®åº¦å’Œé€æ˜åº¦"><a href="#äº®åº¦å’Œé€æ˜åº¦" class="headerlink" title="äº®åº¦å’Œé€æ˜åº¦"></a>äº®åº¦å’Œé€æ˜åº¦</h4><p>æ¯ä¸ªåƒç´ 2å­—èŠ‚ï¼Œå•ä¸€çš„è‰²è°ƒå’Œé€æ˜åº¦ï¼Œåªèƒ½æ¥æ˜¾ç¤ºç™½è‰²å’Œé»‘è‰²ä¹‹é—´çš„è‰²å€¼ï¼Œæ²¡æœ‰å…¶ä»–é¢œè‰²ã€‚</p>
<h4 id="Alpha-8-Format"><a href="#Alpha-8-Format" class="headerlink" title="Alpha 8 Format"></a>Alpha 8 Format</h4><p>æ¯ä¸ªåƒç´ 1å­—èŠ‚ï¼Œç”¨æ¥è¡¨ç¤ºé€æ˜åº¦ï¼Œä¸€èˆ¬ç”¨ä½œè’™ç‰ˆå’Œæ–‡å­—ã€‚<br>ç›¸æ¯”sRGBå®¹é‡å°äº†75%ï¼Œè¯¦ç»† å®½è‰²åŸŸ å®¹é‡å°äº†87.5%</p>
<h3 id="æ¸²æŸ“å›¾ç‰‡å¤§å°è®¡ç®—"><a href="#æ¸²æŸ“å›¾ç‰‡å¤§å°è®¡ç®—" class="headerlink" title="æ¸²æŸ“å›¾ç‰‡å¤§å°è®¡ç®—"></a>æ¸²æŸ“å›¾ç‰‡å¤§å°è®¡ç®—</h3><p>å›¾ç‰‡å¤§å° = å›¾ç‰‡æ ¼å¼å®¹é‡ <em> åƒç´ ä¸ªæ•°<br>å½“æˆ‘ä»¬æŠŠå¤§å°æ˜¯20\</em>20ä½¿ç”¨<code>Alpha 8 format</code>æ¸²æŸ“åˆ°20*20çš„viewä¸Šé¢ï¼Œå’Œ40*40çš„imageä½¿ç”¨<code>p3</code>æ¸²æŸ“åˆ°20*20çš„viewä¸­ï¼Œåç€å ç”¨å†…å­˜æ˜¯å‰è€…çš„8å€ã€‚</p>
<p>ä½¿ç”¨sRGBè‰²åŸŸè¿›è¡Œæ¸²æŸ“æ‰€å ç”¨çš„å¤§å°ä¸º<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imageWidth*imageHeight*4 å­—èŠ‚</span><br></pre></td></tr></table></figure></p>
<p>æ¯ä¸ªåƒç´ å ç”¨äº†4å­—èŠ‚ï¼Œæ¯ä¸ªå­—èŠ‚8ä½ï¼Œ</p>
<p>ä½¿ç”¨<code>display p3</code>åˆ™æ¯ä¸ªé€šé“å ç”¨16ä½ï¼Œé‚£ä¹ˆå ç”¨å†…å­˜å¤§å°æ˜¯<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">imageWidth*imageHeight*8 å­—èŠ‚</span><br></pre></td></tr></table></figure></p>
<h3 id="å¦‚ä½•é€‰æ‹©æ­£ç¡®çš„å›¾ç‰‡æ ¼å¼"><a href="#å¦‚ä½•é€‰æ‹©æ­£ç¡®çš„å›¾ç‰‡æ ¼å¼" class="headerlink" title="å¦‚ä½•é€‰æ‹©æ­£ç¡®çš„å›¾ç‰‡æ ¼å¼"></a>å¦‚ä½•é€‰æ‹©æ­£ç¡®çš„å›¾ç‰‡æ ¼å¼</h3><blockquote>
<p>ä¸è¦ä¸»åŠ¨é€‰æ‹©å›¾ç‰‡æ ¼å¼ï¼Œè®©æ ¼å¼é€‰æ‹©ä½ ã€‚</p>
</blockquote>
<p>ä¸è¦å†ä½¿ç”¨<code>UIGraphicsBeginImageContextWithOptions</code>,è¯¥æ–¹æ³•æ€»æ˜¯ä½¿ç”¨sRGBæ ¼å¼ï¼Œä½ æƒ³èŠ‚çº¦å†…å­˜æ˜¯ä¸è¡Œçš„ï¼Œåœ¨æ”¯æŒ<code>p3</code>çš„è®¾å¤‡ä¸Šæƒ³ç»˜åˆ¶å‡ºæ¥<code>p3</code>è‰²åŸŸçš„å›¾ç‰‡ä¹Ÿæ˜¯ä¸è¡Œçš„ã€‚é‚£ä¹ˆä½¿ç”¨<code>UIGraphicsImageRenderer</code>ç³»ç»Ÿå¯ä»¥è‡ªåŠ¨ä¸ºä½ é€‰æ‹©æ ¼å¼ï¼Œå¦‚æœç»˜åˆ¶<code>image</code>ï¼Œè‡ªå·±å†æ·»åŠ å•è‰²è’™ç‰ˆï¼Œæ˜¯ä¸éœ€è¦å¦å¤–å•ç‹¬åˆ†é…å†…å­˜çš„ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">if let im = imageV &#123;</span><br><span class="line">//ç¬¬äºŒæ¬¡æ·»åŠ è’™ç‰ˆ</span><br><span class="line">	im.tintColor = UIColor.black</span><br><span class="line">&#125;else&#123;</span><br><span class="line">//ç»˜åˆ¶ä¸€ä¸ªçº¢è‰²çŸ©å½¢</span><br><span class="line">	let bounds = CGRect(x: 0, y: 0, width: width, height: height)</span><br><span class="line">	let renderer = UIGraphicsImageRenderer(bounds: bounds)</span><br><span class="line">	 let image = renderer.image &#123; (coxt) in</span><br><span class="line">		UIColor.red.setFill()</span><br><span class="line">		let path = UIBezierPath(roundedRect: bounds,</span><br><span class="line">								cornerRadius: 20)</span><br><span class="line">		path.addClip()</span><br><span class="line">		UIRectFill(bounds)</span><br><span class="line">	&#125;</span><br><span class="line">	imageV = UIImageView(image: image)</span><br><span class="line">	imageV?.frame = bounds</span><br><span class="line">	self.view.addSubview(imageV!)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><code>UIImage</code> ç›´æ¥è¯»å‡ºæ¥éœ€è¦å°†æ‰€æœ‰<code>UIImage</code>çš„<code>data</code>å…¨éƒ¨è§£ç åˆ°å†…å­˜ï¼Œå¾ˆè€—è´¹å†…å­˜å’Œæ€§èƒ½ã€‚ä¸ºäº†èŠ‚çœå†…å­˜å’Œé™ä½CPUä½¿ç”¨ç‡ï¼Œå¯ä»¥é‡‡ç”¨<strong>ä¸‹é‡‡æ ·</strong>ã€‚</p>
<h3 id="ä¸‹é‡‡æ ·"><a href="#ä¸‹é‡‡æ ·" class="headerlink" title="ä¸‹é‡‡æ ·"></a>ä¸‹é‡‡æ ·</h3><p>å½“<code>image</code>ç´ æå¤§å°æ˜¯<code>1000*1000</code>ï¼Œä½†æ˜¯åœ¨æ‰‹æœºä¸Šæ˜¾ç¤ºå‡ºæ¥åªæœ‰<code>200*200</code>ï¼Œæˆ‘ä»¬å…¶å®æ˜¯æ²¡å¿…è¦å°†<code>1000*1000</code>çš„æ•°æ®éƒ½è§£ç çš„ï¼Œåªéœ€è¦ç¼©å°æˆ<code>200*200</code>çš„å¤§å°å³å¯ï¼Œè¿™æ ·å­èŠ‚çœäº†å†…å­˜å’ŒCPUï¼Œç”¨æˆ·æ„Ÿå®˜ä¹Ÿæ²¡æœ‰ä»»ä½•å½±å“ã€‚<br>åœ¨<code>UIKit</code>ä¸­ä½¿ç”¨<code>UIGraphicsImageRenderer</code>ä¼šæœ‰ç¬é—´å¾ˆé«˜çš„å†…å­˜å’ŒCPUå³°å€¼ï¼Œé‚£ä¹ˆ</p>
<h4 id="1-UIKit-UIGraphicsImageRenderer"><a href="#1-UIKit-UIGraphicsImageRenderer" class="headerlink" title="1.UIKit  UIGraphicsImageRenderer"></a>1.UIKit  UIGraphicsImageRenderer</h4><p>ä½¿ç”¨ç´ æAä¸‹é‡‡æ ·æŠ€æœ¯ï¼Œä½¿ç”¨<code>UIKit</code>ä¸­çš„<code>UIGraphicsImageRenderer</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Memory </span><br><span class="line">High:16.4M</span><br><span class="line">normal:14.8M</span><br><span class="line">CPU:</span><br><span class="line">Hight:29%</span><br><span class="line">normal:0%</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">func resizedImage(at url: URL, for size: CGSize) -&gt; UIImage? &#123;</span><br><span class="line">	guard let image = UIImage(contentsOfFile: url.path) else &#123;</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br><span class="line">	if #available(iOS 10.0, *) &#123;</span><br><span class="line">		let renderer = UIGraphicsImageRenderer(size: size)</span><br><span class="line">	</span><br><span class="line">		return renderer.image &#123; (context) in</span><br><span class="line">			image.draw(in: CGRect(origin: .zero, size: size))</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		UIGraphicsBeginImageContext(size)</span><br><span class="line">		image.draw(in: CGRect(origin: .zero, size: size))</span><br><span class="line">		let image = UIGraphicsGetImageFromCurrentImageContext()</span><br><span class="line">		UIGraphicsEndImageContext()</span><br><span class="line">		return image</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨å­çº¿ç¨‹ç»˜åˆ¶ï¼Œä¼šå‡ºç°CPUç•¥å¾®å‡é«˜ï¼Œå½“<code>image size</code>å¤§å¾ˆå¤šçš„æ—¶å€™ä¼šå‡ºç°å†…å­˜é£™å‡ç„¶åæ…¢æ…¢æ¢å¤åˆ°<code>normal</code>ã€‚</p>
<h4 id="2-CoreGraphics-CGContextä¸Šä¸‹æ–‡ç»˜åˆ¶ç¼©ç•¥å›¾"><a href="#2-CoreGraphics-CGContextä¸Šä¸‹æ–‡ç»˜åˆ¶ç¼©ç•¥å›¾" class="headerlink" title="2.CoreGraphics CGContextä¸Šä¸‹æ–‡ç»˜åˆ¶ç¼©ç•¥å›¾"></a>2.CoreGraphics CGContextä¸Šä¸‹æ–‡ç»˜åˆ¶ç¼©ç•¥å›¾</h4><p>ä½¿ç”¨ä¸Šä¸‹æ–‡ç»˜åˆ¶ <code>cpu</code> å’Œå†…å­˜å˜åŒ–å¦‚ä¸‹,<code>CPU</code>å’Œå†…å­˜æ²¡æœ‰å¤§çš„å˜åŠ¨è§£å†³äº†è¯¥é—®é¢˜ï¼Œä¹Ÿåšåˆ°çœç”µã€é¡ºæ»‘ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Memory </span><br><span class="line">High:42.3M</span><br><span class="line">normal:14.1M</span><br><span class="line">CPU:</span><br><span class="line">Hight:6%</span><br><span class="line">normal:0%</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">func resizedImage2(at url: URL, for size: CGSize) -&gt; UIImage?&#123;</span><br><span class="line">	guard let imageSource = CGImageSourceCreateWithURL(url as NSURL, nil),</span><br><span class="line">		let image = CGImageSourceCreateImageAtIndex(imageSource, 0, nil)</span><br><span class="line">	else&#123;</span><br><span class="line">		return nil;</span><br><span class="line">	&#125;</span><br><span class="line">	let cxt = CGContext(data: nil,</span><br><span class="line">						width: Int(size.width),</span><br><span class="line">						height: Int(size.height),</span><br><span class="line">						bitsPerComponent: image.bitsPerComponent,</span><br><span class="line">						bytesPerRow: image.bytesPerRow,</span><br><span class="line">						space: image.colorSpace ?? CGColorSpace(name: CGColorSpace.sRGB)!</span><br><span class="line">		,</span><br><span class="line">						bitmapInfo: image.bitmapInfo.rawValue)</span><br><span class="line">	cxt?.interpolationQuality = .high</span><br><span class="line">	cxt?.draw(image, in: CGRect(origin: .zero, size: size))</span><br><span class="line">	guard let scaledImage = cxt?.makeImage() else &#123;</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br><span class="line">	let ima = UIImage(cgImage: scaledImage)</span><br><span class="line">	return ima</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="3-ImageIO-åˆ›å»ºç¼©ç•¥å›¾"><a href="#3-ImageIO-åˆ›å»ºç¼©ç•¥å›¾" class="headerlink" title="3.ImageIO åˆ›å»ºç¼©ç•¥å›¾"></a>3.ImageIO åˆ›å»ºç¼©ç•¥å›¾</h4><p>ä½¿ç”¨<code>ImageIO</code> ä¸­åˆ›å»ºå›¾åƒï¼ŒCPUå’Œå†…å­˜è®°å½•åè€Œæ›´é«˜äº†ï¼Œå†…å­˜ä¹Ÿå±…é«˜ä¸ä¸‹ï¼Œæ—¶é—´ä¸ŠåŸºæœ¬2sæ‰å°†å›¾åƒç»˜åˆ¶å‡ºæ¥ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Memory </span><br><span class="line">High:320M</span><br><span class="line">normal:221M</span><br><span class="line">CPU:</span><br><span class="line">Hight:73%</span><br><span class="line">normal:0%</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">func resizedImage3(at url: URL, for size: CGSize) -&gt; UIImage?&#123;</span><br><span class="line">	</span><br><span class="line">	let ops:[CFString:Any] = [kCGImageSourceCreateThumbnailFromImageIfAbsent:true,</span><br><span class="line">							  kCGImageSourceCreateThumbnailWithTransform:true,</span><br><span class="line">							  kCGImageSourceShouldCacheImmediately:true,</span><br><span class="line">							  kCGImageSourceThumbnailMaxPixelSize:max(size.width, size.height)]</span><br><span class="line">	guard let imageSource = CGImageSourceCreateWithURL(url as NSURL, nil),</span><br><span class="line">		let image = CGImageSourceCreateImageAtIndex(imageSource, 0, ops as CFDictionary) else &#123;</span><br><span class="line">			return nil;</span><br><span class="line">	&#125;</span><br><span class="line">	let ima = UIImage(cgImage: image)</span><br><span class="line">	printImageCost(image: ima)</span><br><span class="line">	return ima</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-CoreImage-æ»¤é•œ"><a href="#4-CoreImage-æ»¤é•œ" class="headerlink" title="4.CoreImage æ»¤é•œ"></a>4.CoreImage æ»¤é•œ</h4><p>ä½¿ç”¨æ»¤é•œå¤„ç†åè€Œæœ‰ç‚¹éº»çƒ¦ï¼Œåœ¨iOSä¸æ˜¯ä¸“ä¸šå¤„ç†å›¾åƒçš„APPä¸­ç•¥å¾®è‡ƒè‚¿ï¼Œè€Œä¸”æ€§èƒ½ä¸æ˜¯å¾ˆå¥½ã€‚åœ¨é‡å¤åˆ é™¤æ·»åŠ æ“ä½œï¼Œç¬¬äºŒæ¬¡å‡ºç°äº†APPé—ªé€€é—®é¢˜ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Memory </span><br><span class="line">High:1.04G</span><br><span class="line">normal:566M</span><br><span class="line">CPU:</span><br><span class="line">Hight:73%</span><br><span class="line">normal:0%</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func resizedImage4(at url: URL, for size: CGSize) -&gt; UIImage?&#123;</span><br><span class="line">	let shareContext = CIContext(options: [.useSoftwareRenderer:false])</span><br><span class="line">	</span><br><span class="line">	 guard let image = CIImage(contentsOf: url) else &#123; return nil &#125;</span><br><span class="line">	let fillter = CIFilter(name: &quot;CILanczosScaleTransform&quot;)</span><br><span class="line">	fillter?.setValue(image, forKey: kCIInputImageKey)</span><br><span class="line">	fillter?.setValue(1, forKey: kCIInputScaleKey)</span><br><span class="line">	guard let outPutCIImage = fillter?.outputImage,let outputCGImage = shareContext.createCGImage(outPutCIImage, from: outPutCIImage.extent) else &#123; return nil &#125;</span><br><span class="line">	</span><br><span class="line">	return UIImage(cgImage: outputCGImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="5-ä½¿ç”¨-vImage-ä¼˜åŒ–å›¾ç‰‡æ¸²æŸ“"><a href="#5-ä½¿ç”¨-vImage-ä¼˜åŒ–å›¾ç‰‡æ¸²æŸ“" class="headerlink" title="5.ä½¿ç”¨ vImage ä¼˜åŒ–å›¾ç‰‡æ¸²æŸ“"></a>5.ä½¿ç”¨ vImage ä¼˜åŒ–å›¾ç‰‡æ¸²æŸ“</h4><p>ä½¿ç”¨<code>vImage</code>åˆ›å»ºå›¾åƒæ€§èƒ½ç•¥ä½ï¼Œå†…å­˜ä½¿ç”¨è¾ƒå¤šï¼Œæ­¥éª¤éº»çƒ¦ï¼Œæ˜¯æˆ‘ä»¬è¯¥èˆå¼ƒçš„ã€‚åœ¨å†…å­˜åªæœ‰1Gçš„æ‰‹æœºä¸Šææ€•è¦<code>crash</code>äº†ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Memory </span><br><span class="line">High:998.7M</span><br><span class="line">normal:566M</span><br><span class="line">CPU:</span><br><span class="line">Hight:78%</span><br><span class="line">normal:0%</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">func resizedImage5(at url: URL, for size: CGSize) -&gt; UIImage? &#123;</span><br><span class="line">    // è§£ç æºå›¾åƒ</span><br><span class="line">    guard let imageSource = CGImageSourceCreateWithURL(url as NSURL, nil),</span><br><span class="line">        let image = CGImageSourceCreateImageAtIndex(imageSource, 0, nil),</span><br><span class="line">        let properties = CGImageSourceCopyPropertiesAtIndex(imageSource, 0, nil) as? [CFString: Any],</span><br><span class="line">        let imageWidth = properties[kCGImagePropertyPixelWidth] as? vImagePixelCount,</span><br><span class="line">        let imageHeight = properties[kCGImagePropertyPixelHeight] as? vImagePixelCount</span><br><span class="line">    else &#123;</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å®šä¹‰å›¾åƒæ ¼å¼</span><br><span class="line">    var format = vImage_CGImageFormat(bitsPerComponent: 8,</span><br><span class="line">                                      bitsPerPixel: 32,</span><br><span class="line">                                      colorSpace: nil,</span><br><span class="line">                                      bitmapInfo: CGBitmapInfo(rawValue: CGImageAlphaInfo.first.rawValue),</span><br><span class="line">                                      version: 0,</span><br><span class="line">                                      decode: nil,</span><br><span class="line">                                      renderingIntent: .defaultIntent)</span><br><span class="line"></span><br><span class="line">    var error: vImage_Error</span><br><span class="line"></span><br><span class="line">    // åˆ›å»ºå¹¶åˆå§‹åŒ–æºç¼“å†²åŒº</span><br><span class="line">    var sourceBuffer = vImage_Buffer()</span><br><span class="line">    defer &#123; sourceBuffer.data.deallocate() &#125;</span><br><span class="line">    error = vImageBuffer_InitWithCGImage(&amp;sourceBuffer,</span><br><span class="line">                                         &amp;format,</span><br><span class="line">                                         nil,</span><br><span class="line">                                         image,</span><br><span class="line">                                         vImage_Flags(kvImageNoFlags))</span><br><span class="line">    guard error == kvImageNoError else &#123; return nil &#125;</span><br><span class="line"></span><br><span class="line">    // åˆ›å»ºå¹¶åˆå§‹åŒ–ç›®æ ‡ç¼“å†²åŒº</span><br><span class="line">    var destinationBuffer = vImage_Buffer()</span><br><span class="line">    error = vImageBuffer_Init(&amp;destinationBuffer,</span><br><span class="line">                              vImagePixelCount(size.height),</span><br><span class="line">                              vImagePixelCount(size.width),</span><br><span class="line">                              format.bitsPerPixel,</span><br><span class="line">                              vImage_Flags(kvImageNoFlags))</span><br><span class="line">    guard error == kvImageNoError else &#123; return nil &#125;</span><br><span class="line"></span><br><span class="line">    // ä¼˜åŒ–ç¼©æ”¾å›¾åƒ</span><br><span class="line">    error = vImageScale_ARGB8888(&amp;sourceBuffer,</span><br><span class="line">                                 &amp;destinationBuffer,</span><br><span class="line">                                 nil,</span><br><span class="line">                                 vImage_Flags(kvImageHighQualityResampling))</span><br><span class="line">    guard error == kvImageNoError else &#123; return nil &#125;</span><br><span class="line"></span><br><span class="line">    // ä»ç›®æ ‡ç¼“å†²åŒºåˆ›å»ºä¸€ä¸ª CGImage å¯¹è±¡</span><br><span class="line">    guard let resizedImage =</span><br><span class="line">        vImageCreateCGImageFromBuffer(&amp;destinationBuffer,</span><br><span class="line">                                      &amp;format,</span><br><span class="line">                                      nil,</span><br><span class="line">                                      nil,</span><br><span class="line">                                      vImage_Flags(kvImageNoAllocate),</span><br><span class="line">                                      &amp;error)?.takeRetainedValue(),</span><br><span class="line">        error == kvImageNoError</span><br><span class="line">    else &#123;</span><br><span class="line">        return nil</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return UIImage(cgImage: resizedImage)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="å†…å­˜ä¼˜åŒ–"><a href="#å†…å­˜ä¼˜åŒ–" class="headerlink" title="å†…å­˜ä¼˜åŒ–"></a>å†…å­˜ä¼˜åŒ–</h3><p>å›¾ç‰‡è§£ç ååŠ è½½åœ¨å†…å­˜ä¸­çš„æ•°æ®éœ€è¦åœ¨æ°å½“çš„æ—¶æœºåˆ é™¤æ‰ï¼Œåœ¨åˆé€‚çš„æ—¶æœºæ·»åŠ ä¸Šï¼Œä¹Ÿæ˜¯ä¿æŒä½å†…å­˜ä½¿ç”¨ç‡çš„æ‰‹æ®µã€‚</p>
<p>åœ¨ç”¨æˆ·æ‹¨æ‰“ç”µè¯æˆ–è€…è¿›å…¥åˆ°å…¶ä»–APPä¸­å¯ä»¥å…ˆåˆ é™¤æ‰å¤§å›¾ç‰‡ï¼Œç­‰å›æ¥çš„æ—¶å€™å†æ¬¡æ·»åŠ ä¹Ÿæ˜¯ä¸é”™çš„é€‰æ‹©ã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 1</span><br><span class="line">NotificationCenter.default.addObserver(forName: UIApplication.didEnterBackgroundNotification,</span><br><span class="line">									   object: nil,</span><br><span class="line">									   queue: .main)</span><br><span class="line">&#123;[weak self] (note) in</span><br><span class="line">	self?.unloadImage()</span><br><span class="line">&#125;</span><br><span class="line">NotificationCenter.default.addObserver(forName: UIApplication.willEnterForegroundNotification,</span><br><span class="line">									   object: nil,</span><br><span class="line">									   queue: .main)</span><br><span class="line">&#123;[weak self] (note) in</span><br><span class="line">	self?.loadImage()</span><br><span class="line">&#125;</span><br><span class="line"># 2</span><br><span class="line"></span><br><span class="line">override func viewWillAppear(_ animated: Bool) &#123;</span><br><span class="line">	super.viewWillAppear(animated)</span><br><span class="line">	self.loadImage()</span><br><span class="line">&#125;</span><br><span class="line">override func viewWillDisappear(_ animated: Bool) &#123;</span><br><span class="line">	super.viewWillDisappear(animated)</span><br><span class="line">	self.unloadImage()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li>åŸºäºæ€§èƒ½ç»¼åˆè€ƒè™‘æ–¹æ³•1æ˜¯æœ€ç®€å•æœ€åˆé€‚çš„</li>
<li>ä½¿ç”¨æ»¤é•œå’Œ<code>vImage</code>ç•¥å¾®å¤æ‚ç‚¹ï¼Œå¹³æ—¶å¼€å‘è¿‡ç¨‹ä¸­å¯ä»¥ä¸ç”¨è€ƒè™‘äº†ã€‚</li>
<li>å›¾ç‰‡è§£ç ç¼“å­˜å’Œå›¾ç‰‡å¤§å°æœ‰å…³ï¼Œé€‚å½“çš„ä¸‹é‡‡æ ·æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</li>
</ul>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul>
<li><a href="https://developer.apple.com/videos/play/wwdc2018/416" target="_blank" rel="noopener">session 2018 416 iOS Memory Deep Dive</a></li>
<li><a href="https://developer.apple.com/videos/play/wwdc2018/219" target="_blank" rel="noopener">219_image_and_graphics_best_practices</a></li>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="noopener">WWDC ä¸­æ–‡å­—å¹•ä¸‹è½½</a></li>
<li><p><a href="https://juejin.im/post/5daaf8b3f265da5b6f074c98#heading-1" target="_blank" rel="noopener">swift gg å›¾åƒä¼˜åŒ–</a></p>
</li>
<li><p><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="noopener">å­¦ä¹ èµ„æ–™ä¸‹è½½git</a></p>
</li>
<li><a href="https://github.com/ifgyong/demo/tree/master" target="_blank" rel="noopener">demo code git</a></li>
</ul>
<h2 id="å”¯æœ‰å®è·µæ‰æ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†"><a href="#å”¯æœ‰å®è·µæ‰æ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†" class="headerlink" title="å”¯æœ‰å®è·µæ‰æ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†"></a><strong>å”¯æœ‰å®è·µæ‰æ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†</strong></h2><p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p>
<p>å¹¿å‘Šæ—¶é—´</p>
<p><img src="/images/0.png" alt></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOSåº•å±‚åŸç† MVCã€MVPã€MVVMã€åˆ†å±‚è®¾è®¡æµ…è°ˆ â€” (13)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyongçš„æŠ€æœ¯åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/01/iOSåº•å±‚åŸç† MVCã€MVPã€MVVMã€åˆ†å±‚è®¾è®¡æµ…è°ˆ â€” (13)/" class="post-title-link" itemprop="http://fgyong.cn/index.html">MVCã€MVPã€MVVMã€åˆ†å±‚è®¾è®¡æµ…è°ˆ â€” (13)</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-01 11:23:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:23:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-09-03 16:24:13" itemprop="dateModified" datetime="2020-09-03T16:24:13+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è§£å…³äºæ¶æ„çš„ä¸€äº›æ€è€ƒï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« ä½ å°†äº†è§£åˆ°</p>
<blockquote>
<ol>
<li>MVC</li>
<li>MVCå˜ç§</li>
<li>MVP</li>
<li>MVVM</li>
<li>åˆ†å±‚è®¾è®¡çš„ä¼˜ç¼ºç‚¹</li>
</ol>
</blockquote>
<p>æ²¡æœ‰æœ€å¥½çš„æ¶æ„ï¼Œåªæœ‰æœ€é€‚åˆä¸šåŠ¡çš„æ¶æ„ã€‚</p>
<h3 id="MVC"><a href="#MVC" class="headerlink" title="MVC"></a>MVC</h3><p>è‹¹æœç‰ˆæœ¬çš„<code>MVC</code>æ˜¯<code>Model</code>å’Œ<code>VC</code>å’Œäº¤äº’ï¼Œ<code>VC</code>å’Œ<code>View</code>äº¤äº’</p>
<ul>
<li><p>ä¼˜ç‚¹ï¼š<code>View</code>å’Œ<code>Model</code>å¯ä»¥é‡å¤åˆ©ç”¨ï¼Œå¯ä»¥ç‹¬ç«‹ä½¿ç”¨</p>
</li>
<li><p>ç¼ºç‚¹ï¼š<code>Controller</code>çš„ä»£ç è¿‡äºè‡ƒè‚¿</p>
</li>
</ul>
<p><img src="/images/13-1.png" alt></p>
<p>ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    [self loadData];</span><br><span class="line">&#125;</span><br><span class="line">- (void)loadData&#123;</span><br><span class="line">    self.data=[NSMutableArray array];</span><br><span class="line">    for (int i = 0; i &lt; 20; i ++) &#123;</span><br><span class="line">        FYNews *item=[FYNews new];</span><br><span class="line">        item.title =[NSString stringWithFormat:@&quot;title-%d&quot;,i];</span><br><span class="line">        item.name =[NSString stringWithFormat:@&quot;name-%d&quot;,i];</span><br><span class="line">        [self.data addObject:item];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (NSInteger)numberOfSectionsInTableView:(UITableView *)tableView &#123;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section &#123;</span><br><span class="line">    return self.data.count;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath &#123;</span><br><span class="line">    UITableViewCell *cell = [tableView dequeueReusableCellWithIdentifier:@&quot;cell&quot; forIndexPath:indexPath];</span><br><span class="line">    </span><br><span class="line">    // Configure the cell...</span><br><span class="line">    FYNews *item =[self.data objectAtIndex:indexPath.row];</span><br><span class="line">    cell.detailTextLabel.text =item.title;</span><br><span class="line">    cell.textLabel.text = item.name;</span><br><span class="line">    return cell;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//model</span><br><span class="line"></span><br><span class="line">@interface FYNews : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *title;</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæ˜¯<code>VC</code>ä¸­ç»„è£…äº†<code>tableview</code>ï¼Œ<code>model</code>çš„æ•°æ®åœ¨<code>VC</code>ä¸­åœ¨<code>view</code>ä¸­æ˜¾ç¤ºå‡ºæ¥ï¼Œå½“éœ€è¦å¦å¤–çš„æ•°æ®çš„æ—¶å€™ï¼Œåªéœ€è¦å°†<code>model</code>æ”¹æˆéœ€è¦çš„<code>model</code>è€Œæ— éœ€æ›´æ”¹<code>tableview</code>çš„ä»£ç å…¼å®¹æ€§è¾ƒå¥½ã€‚</p>
<h3 id="MVCå˜ç§"><a href="#MVCå˜ç§" class="headerlink" title="MVCå˜ç§"></a>MVCå˜ç§</h3><p><code>MVC</code>å˜ç§ï¼Œå…¶å®å°±æ˜¯å°†<code>model</code>å’Œ<code>view</code>å»ºç«‹äº†è”ç³»ï¼Œ<code>view</code>ä¾æ®<code>Model</code>æ¥å±•ç¤ºæ•°æ®ï¼Œ<code>VC</code>ç»„è£…<code>Model</code>ï¼Œç»„è£…å±•ç¤ºæ˜¯åœ¨<code>view</code>ä¸­å®ç°ã€‚</p>
<ul>
<li><p>ä¼˜ç‚¹ï¼šå¯¹Controllerè¿›è¡Œç˜¦èº«ï¼Œå°†Viewçš„å†…éƒ¨ç»†èŠ‚å°è£…èµ·æ¥äº†ï¼Œå¤–ç•Œä¸çŸ¥é“Viewå†…éƒ¨çš„å…·ä½“å®ç°</p>
</li>
<li><p>ç¼ºç‚¹ï¼šviewä¾èµ–äºModel</p>
</li>
</ul>
<p><img src="/images/13-2.png" alt></p>
<p>ä»£ç å®ç°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">//.h</span><br><span class="line">@class FYItemModel;</span><br><span class="line">@interface FYAppleView : UIView</span><br><span class="line">@property (nonatomic,strong) FYItemModel *model;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//.m</span><br><span class="line">@interface FYAppleView()</span><br><span class="line">@property (nonatomic,strong) UILabel *nameLabel;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYAppleView</span><br><span class="line">-(instancetype)initWithFrame:(CGRect)frame&#123;</span><br><span class="line">    if (self =[super initWithFrame:frame]) &#123;</span><br><span class="line">        _nameLabel=[[UILabel alloc]initWithFrame:CGRectMake(0, 0, 100, 30)];</span><br><span class="line">        [self addSubview:_nameLabel];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line">/*</span><br><span class="line">  mvcçš„å˜ç§</span><br><span class="line"> */</span><br><span class="line">- (void)setModel:(FYItemModel *)model&#123;</span><br><span class="line">    _model = model;</span><br><span class="line">    _nameLabel.textColor = model.bgColor;</span><br><span class="line">    _nameLabel.text = model.name;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//FYItemModel</span><br><span class="line">@interface FYItemModel : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@property (nonatomic,strong) UIColor *bgColor;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//ViewController</span><br><span class="line">@interface ViewController ()</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    [self loadViewOtherMVC];</span><br><span class="line">&#125;</span><br><span class="line">//å˜ç§MVC æŠŠViewå’ŒModelå»ºç«‹èµ·è¿æ¥</span><br><span class="line">//ç­‰ä»¥åæ›´æ–°viewæ•°æ®åªéœ€è¦ view.model = item;Controllrå°‘äº†è®¸å¤šä»£ç </span><br><span class="line">- (void)loadViewOtherMVC&#123;</span><br><span class="line">    FYAppleView * view =[[FYAppleView alloc]initWithFrame:CGRectMake(200, 200, 100, 30)];</span><br><span class="line">    FYItemModel *item=[[FYItemModel alloc]init];</span><br><span class="line">    item.name = @&quot;æ ¡é•¿æ¥äº†&quot;;</span><br><span class="line">    item.bgColor = [UIColor redColor];</span><br><span class="line">    view.model = item;</span><br><span class="line">    [self.view addSubview:view];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>model</code>ç»„è£…åˆ°<code>view</code>å±•ç¤ºå†…å®¹æ˜¯åœ¨<code>view</code>å®ç°çš„ï¼Œå¤–éƒ¨ä¸çŸ¥é“ç»†èŠ‚ï¼Œåªéœ€è¦å°†<code>model</code>ç»™<code>view</code>å³å¯ï¼Œä½†æ˜¯åªèƒ½ä¼ è¾“è¿‡æ¥<code>model</code>æˆ–è€…ä»–å­ç±»ï¼Œä¸šåŠ¡æ›´æ”¹çš„è¯ï¼Œéœ€è¦ä¿®æ”¹<code>view</code>çš„å†…éƒ¨<code>model</code>æ‰èƒ½å°†å˜æ›´è¿‡çš„æ•°æ®é‡æ–°å±•ç¤ºå‡ºæ¥ã€‚</p>
<p>æƒ³è¦ç›‘å¬viewçš„ç‚¹å‡»äº‹ä»¶æ¥åšä¸€äº›æ“ä½œï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä»£ç†å’Œ<code>block</code>,è¿™é‡Œ<code>id</code>æ˜¯å®ç°äº†<code>FYAppleViewProtocol</code>åè®®çš„ï¼Œ<code>weak</code>ä¿®é¥°é˜²æ­¢å¾ªç¯å¼•ç”¨ï¼Œä½¿ç”¨åè®®å®ç°äº†å’Œ<code>VC</code>çš„é€šä¿¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@class FYAppleView;</span><br><span class="line">@protocol FYAppleViewProtocol &lt;NSObject&gt;</span><br><span class="line">- (void)FYAppleViewDidClick:(FYAppleView*)view;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@class FYItemModel;</span><br><span class="line">@interface FYAppleView : UIView</span><br><span class="line">@property (nonatomic,strong,readonly) UILabel *nameLabel;</span><br><span class="line">@property (nonatomic,weak) id&lt;FYAppleViewProtocol&gt; delegate;</span><br><span class="line">@property (nonatomic,strong) FYItemModel *model;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ç¨ä½œæ›´æ”¹è¿˜æ˜¯<code>apple-MVC</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// .h</span><br><span class="line">@class FYItemModel;</span><br><span class="line">@interface FYAppleView : UIView</span><br><span class="line">@property (nonatomic,strong,readonly) UILabel *nameLabel;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>å°†<code>View</code>å±æ€§<code>nameLabel</code>æš´éœ²å‡ºæ¥ï¼Œä½†æ˜¯ä¸å…è®¸å¤–ç•Œè¿›è¡Œæ›´æ”¹ï¼Œå»æ‰<code>model</code>åˆ™æ˜¯<code>MVC</code>ã€‚</p>
<h3 id="MVP"><a href="#MVP" class="headerlink" title="MVP"></a>MVP</h3><p><code>MVP</code>å’Œ<code>MVC</code>å¾ˆåƒï¼Œåªæ˜¯å°†<code>VC</code>æ¢æˆäº†<code>Presenter</code>ï¼Œ<code>vc</code>å’Œ<code>Present</code>åšçš„äº‹æƒ…åŸºæœ¬ä¸€è‡´ï¼Œå°†<code>view</code>å’Œ<code>Model</code>é€šä¿¡æ”¹åˆ°äº†éƒ½å’Œ<code>Presenter</code>é€šä¿¡ã€‚</p>
<p><img src="/images/13-3.png" alt><br>ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">//MVP</span><br><span class="line">//.h</span><br><span class="line">@interface FYNewsPresenter : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic,weak) UIViewController *vc;</span><br><span class="line">//åˆå§‹åŒ–</span><br><span class="line">- (void)setup;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">.m</span><br><span class="line">#import &quot;FYNewsPresenter.h&quot;</span><br><span class="line">@interface FYNewsPresenter()&lt;FYAppleViewProtocol&gt;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYNewsPresenter</span><br><span class="line">- (void)setup&#123;</span><br><span class="line">	FYAppleView * view =[[FYAppleView alloc]initWithFrame:CGRectMake(200, 200, 100, 30)];</span><br><span class="line">	FYItemModel *item=[[FYItemModel alloc]init];</span><br><span class="line">	item.name = @&quot;æ ¡é•¿æ¥äº†&quot;;</span><br><span class="line">	item.bgColor = [UIColor redColor];</span><br><span class="line">	view.model = item;</span><br><span class="line">	[self.vc.view addSubview:view];</span><br><span class="line">&#125;</span><br><span class="line">- (void)FYAppleViewDidClick:(FYAppleView *)view&#123;</span><br><span class="line">	NSLog(@&quot;ç‚¹å‡»äº†æˆ‘&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//VCä¸­</span><br><span class="line">@interface ViewController ()</span><br><span class="line">@property (nonatomic,strong) FYNewsPresenter *presenter;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">	_presenter=[FYNewsPresenter new];</span><br><span class="line">	_presenter.vc = self;</span><br><span class="line">	[_presenter setup];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>å†æ¬¡å¯¹<code>VC</code>è¿›è¡Œäº†ç˜¦èº«ï¼Œå°†æ›´å¤šçš„ä¸šåŠ¡é€»è¾‘æ¬åˆ°äº†<code>FYNewsPresenter</code>å¤„ç†ï¼Œå…¶å®å…¨éƒ¨æ¬è¿‡å»ï¼Œæ„ä¹‰æ¯”ä¸å¤§ï¼Œ<code>FYNewsPresenter</code>ä¹Ÿä¼šè‡ƒè‚¿ï¼Œä¹Ÿä¼šå‡ºç°å’Œ<code>VC</code>ä¸€æ ·çš„å›°æƒ‘ã€‚</p>
<h3 id="MVVM"><a href="#MVVM" class="headerlink" title="MVVM"></a>MVVM</h3><p><code>MVVM</code>æ˜¯å°†<code>FYNewsPresenter</code>éƒ½æ¬åˆ°äº†<code>FYNewsViewModel</code>ä¸­ï¼Œç„¶åå¯¹<code>FYNewsViewModel</code>å’Œ<code>View</code>è¿›è¡Œäº†ä¸€ä¸ªåŒå‘ç»‘å®šï¼ŒåŒå‘ç»‘å®šå¯ä»¥ä½¿ç”¨ä»£ç†ï¼Œ<code>block</code>æˆ–è€…<code>KVO</code>å®ç°ã€‚<br><img src="/images/13-4.png" alt><br>ä»£ç å®ç°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">@interface FYNewsViewModel : NSObject</span><br><span class="line"></span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@property (nonatomic,strong) UIColor *bgColor;</span><br><span class="line"></span><br><span class="line">@property (nonatomic,weak) UIViewController *vc;</span><br><span class="line"></span><br><span class="line">- (instancetype)initWithController:(UIViewController *)vc;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#import &quot;FYNewsViewModel.h&quot;</span><br><span class="line">@interface FYNewsViewModel()&lt;FYAppleViewProtocol&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line">@implementation FYNewsViewModel</span><br><span class="line">- (instancetype)initWithController:(UIViewController *)vc&#123;</span><br><span class="line">    if (self =[super init]) &#123;</span><br><span class="line">        self.vc = vc;</span><br><span class="line">        </span><br><span class="line">        FYAppleView * view =[[FYAppleView alloc]initWithFrame:CGRectMake(100, 200, 100, 50)];</span><br><span class="line">        //    view.model = item;</span><br><span class="line">        view.delegate = self;</span><br><span class="line">        view.viewModel = self; //å»ºç«‹kvo</span><br><span class="line">        </span><br><span class="line">        view.backgroundColor = [UIColor lightGrayColor];</span><br><span class="line">        [vc.view addSubview:view];</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        FYItemModel *item=[[FYItemModel alloc]init];</span><br><span class="line">        item.name = @&quot;æ ¡é•¿æ¥äº†&quot;;</span><br><span class="line">        item.bgColor = [UIColor redColor];</span><br><span class="line">        </span><br><span class="line">        self.name = item.name;</span><br><span class="line">        self.bgColor = item.bgColor;</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)FYAppleViewDidClick:(FYAppleView *)view&#123;</span><br><span class="line">	NSLog(@&quot;ç‚¹å‡»äº†æˆ‘&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>view</code>å®ç°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">@class FYAppleView,FYNewsViewModel;</span><br><span class="line">@protocol FYAppleViewProtocol &lt;NSObject&gt;</span><br><span class="line"></span><br><span class="line">- (void)FYAppleViewDidClick:(FYAppleView*)view;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@class FYItemModel;</span><br><span class="line"></span><br><span class="line">@interface FYAppleView : UIView</span><br><span class="line">@property (nonatomic,strong,readonly) UILabel *nameLabel;</span><br><span class="line"></span><br><span class="line">@property (nonatomic,weak) id&lt;FYAppleViewProtocol&gt; delegate;</span><br><span class="line">@property (nonatomic,weak) FYNewsViewModel *viewModel;</span><br><span class="line"></span><br><span class="line">@property (nonatomic,strong) FYItemModel *model;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@interface FYAppleView()</span><br><span class="line">@property (nonatomic,strong) UILabel *nameLabel;</span><br><span class="line">@end</span><br><span class="line">@implementation FYAppleView</span><br><span class="line">-(instancetype)initWithFrame:(CGRect)frame&#123;</span><br><span class="line">    if (self =[super initWithFrame:frame]) &#123;</span><br><span class="line">        _nameLabel=[[UILabel alloc]initWithFrame:CGRectMake(0, 0, 100, 30)];</span><br><span class="line">        [self addSubview:_nameLabel];</span><br><span class="line">    &#125;</span><br><span class="line">    return self;</span><br><span class="line">&#125;</span><br><span class="line">/*</span><br><span class="line">  mvcçš„å˜ç§</span><br><span class="line"> */</span><br><span class="line">- (void)setModel:(FYItemModel *)model&#123;</span><br><span class="line">    _model = model;</span><br><span class="line">    _nameLabel.textColor = model.bgColor;</span><br><span class="line">    _nameLabel.text = model.name;</span><br><span class="line">	</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)setViewModel:(FYNewsViewModel *)viewModel&#123;</span><br><span class="line">    _viewModel = viewModel;</span><br><span class="line">   [_viewModel addObserver:self forKeyPath:@&quot;name&quot; options:NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld context:nil];</span><br><span class="line">   //ä½¿ç”¨FBKVOå®ç° æˆ–è€…è‡ªå·±ä½¿ç”¨KVOå®ç°</span><br><span class="line">//    __weak typeof(self) waekSelf = self;</span><br><span class="line">//    [self.KVOController observe:viewModel keyPath:@&quot;name&quot;</span><br><span class="line">//                        options:NSKeyValueObservingOptionNew</span><br><span class="line">//                          block:^(id  _Nullable observer, id  _Nonnull object, NSDictionary&lt;NSKeyValueChangeKey,id&gt; * _Nonnull change) &#123;</span><br><span class="line">//        waekSelf.nameLabel.text = change[NSKeyValueChangeNewKey];</span><br><span class="line">//    &#125;];</span><br><span class="line">&#125;</span><br><span class="line">- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary&lt;NSKeyValueChangeKey,id&gt; *)change context:(void *)context&#123;</span><br><span class="line">    if ([keyPath isEqualToString:@&quot;name&quot;]) &#123;</span><br><span class="line">        self.nameLabel.text = change[NSKeyValueChangeNewKey];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//æ·»åŠ ç‚¹å‡»äº‹ä»¶</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">	if ([self.delegate respondsToSelector:@selector(FYAppleViewDidClick:)]) &#123;</span><br><span class="line">		[self.delegate FYAppleViewDidClick:self];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">-(void)dealloc&#123;</span><br><span class="line">    [_viewModel removeObserver:self</span><br><span class="line">                    forKeyPath:@&quot;name&quot;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>KVO</code>æˆ–è€…<code>FBKVO</code>æˆ–è€…<code>RAC</code>éƒ½æ˜¯å¯ä»¥çš„ï¼Œæœ¬ç« èŠ‚ä¾‹å­ç»™å‡ºäº†<code>FBKVO</code>æˆ–è€…è‡ªå·±ä½¿ç”¨<code>KVO</code>çš„å®ç°ã€‚</p>
<h3 id="åˆ†å±‚è®¾è®¡"><a href="#åˆ†å±‚è®¾è®¡" class="headerlink" title="åˆ†å±‚è®¾è®¡"></a>åˆ†å±‚è®¾è®¡</h3><p>ä¸‰å±‚æ¶æ„ï¼š</p>
<blockquote>
<p>ä¸‰å±‚æ¶æ„(3-tier architecture) é€šå¸¸æ„ä¹‰ä¸Šçš„ä¸‰å±‚æ¶æ„å°±æ˜¯å°†æ•´ä¸ªä¸šåŠ¡åº”ç”¨åˆ’åˆ†ä¸ºï¼šç•Œé¢å±‚ï¼ˆUser Interface layerï¼‰ã€ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆBusiness Logic Layerï¼‰ã€æ•°æ®è®¿é—®å±‚ï¼ˆData access layerï¼‰ã€‚åŒºåˆ†å±‚æ¬¡çš„ç›®çš„å³ä¸ºäº†â€œé«˜å†…èšä½è€¦åˆâ€çš„æ€æƒ³ã€‚åœ¨è½¯ä»¶ä½“ç³»æ¶æ„è®¾è®¡ä¸­ï¼Œåˆ†å±‚å¼ç»“æ„æ˜¯æœ€å¸¸è§ï¼Œä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ç§ç»“æ„ã€‚å¾®è½¯æ¨èçš„åˆ†å±‚å¼ç»“æ„ä¸€èˆ¬åˆ†ä¸ºä¸‰å±‚ï¼Œä»ä¸‹è‡³ä¸Šåˆ†åˆ«ä¸ºï¼šæ•°æ®è®¿é—®å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆåˆæˆ–ç§°ä¸ºé¢†åŸŸå±‚ï¼‰ã€è¡¨ç¤ºå±‚</p>
</blockquote>
<ul>
<li><p>ç›®çš„: â€œé«˜å†…èšï¼Œä½è€¦åˆâ€çš„æ€æƒ³ </p>
</li>
<li><p>ä¼˜ç‚¹: é™ä½å±‚ä¸å±‚ä¹‹é—´çš„ä¾èµ– æ ‡å‡†åŒ– </p>
</li>
<li><p>ç¼ºç‚¹: ç³»ç»Ÿæ¶æ„å¤æ‚ï¼Œä¸é€‚åˆå°å‹é¡¹ç›®</p>
</li>
</ul>
<h4 id="ä¸‰å±‚åŸç†"><a href="#ä¸‰å±‚åŸç†" class="headerlink" title="ä¸‰å±‚åŸç†"></a>ä¸‰å±‚åŸç†</h4><blockquote>
<p>3ä¸ªå±‚æ¬¡ä¸­ï¼Œç³»ç»Ÿä¸»è¦åŠŸèƒ½å’Œä¸šåŠ¡é€»è¾‘éƒ½åœ¨ä¸šåŠ¡é€»è¾‘å±‚è¿›è¡Œå¤„ç†ã€‚<br>æ‰€è°“ä¸‰å±‚ä½“ç³»ç»“æ„ï¼Œæ˜¯åœ¨å®¢æˆ·ç«¯ä¸æ•°æ®åº“ä¹‹é—´åŠ å…¥äº†ä¸€ä¸ª<code>ä¸­é—´å±‚</code>ï¼Œä¹Ÿå«ç»„ä»¶å±‚ã€‚è¿™é‡Œæ‰€è¯´çš„ä¸‰å±‚ä½“ç³»ï¼Œä¸æ˜¯æŒ‡ç‰©ç†ä¸Šçš„ä¸‰å±‚ï¼Œä¸æ˜¯ç®€å•åœ°æ”¾ç½®ä¸‰å°æœºå™¨å°±æ˜¯ä¸‰å±‚ä½“ç³»ç»“æ„ï¼Œä¹Ÿä¸ä»…ä»…æœ‰<code>B/S</code>åº”ç”¨æ‰æ˜¯ä¸‰å±‚ä½“ç³»ç»“æ„ï¼Œä¸‰å±‚æ˜¯æŒ‡é€»è¾‘ä¸Šçš„ä¸‰å±‚ï¼Œå³æŠŠè¿™ä¸‰ä¸ªå±‚æ”¾ç½®åˆ°ä¸€å°æœºå™¨ä¸Šã€‚</p>
<p>ä¸‰å±‚ä½“ç³»çš„åº”ç”¨ç¨‹åºå°†ä¸šåŠ¡è§„åˆ™ã€æ•°æ®è®¿é—®ã€åˆæ³•æ€§æ ¡éªŒç­‰å·¥ä½œæ”¾åˆ°äº†ä¸­é—´å±‚è¿›è¡Œå¤„ç†ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯ä¸ç›´æ¥ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ï¼Œè€Œæ˜¯é€šè¿‡<code>COM/DCOM</code>é€šè®¯ä¸ä¸­é—´å±‚å»ºç«‹è¿æ¥ï¼Œå†ç»ç”±ä¸­é—´å±‚ä¸æ•°æ®åº“è¿›è¡Œäº¤äº’ã€‚</p>
<p>ä¸‰å±‚æ¶æ„ä¸­ä¸»è¦åŠŸèƒ½ä¸ä¸šåŠ¡é€»è¾‘ä¸€èˆ¬è¦åœ¨ä¸šåŠ¡é€»è¾‘å±‚è¿›è¡Œä¿¡æ¯å¤„ç†å’Œå®ç°ï¼Œå…¶ä¸­ä¸‰å±‚ä½“ç³»æ¶æ„ä¸­çš„å®¢æˆ·ç«¯å’Œæ•°æ®åº“è¦é¢„è®¾ä¸­é—´å±‚ï¼Œæˆä¸ºç»„å»ºå±‚ã€‚ä¸‰å±‚æ¶æ„ä¸­çš„ä¸‰å±‚å…·æœ‰ä¸€å®šçš„é€»è¾‘æ€§ï¼Œå³æ˜¯å°†ä¸‰å±‚è®¾ç½®åˆ°åŒä¸€ä¸ªè®¡ç®—æœºç³»ç»Ÿä¸­ï¼ŒæŠŠä¸šåŠ¡åè®®ã€åˆæ³•æ ¡éªŒä»¥åŠæ•°æ®è®¿é—®ç­‰ç¨‹åºå½’ç½®åˆ°ä¸­é—´å±‚è¿›è¡Œä¿¡æ¯å¤„ç†ï¼Œä¸€èˆ¬å®¢æˆ·ç«¯æ— æ³•å’Œæ•°æ®åº“è¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œä¸»è¦æ˜¯åˆ©ç”¨<code>COM/DCOM</code>é€šè®¯å’Œä¸­é—´å±‚æ„å»ºè¡”æ¥é€šé“ï¼Œå®ç°ä¸­é—´å±‚ä¸æ•°æ®åº“çš„æ•°æ®ä¼ è¾“ï¼Œè¿›è€Œå®ç°å®¢æˆ·ç«¯ä¸æ˜¯æ•°æ®åº“çš„äº¤äº’</p>
</blockquote>
<p><code>MVC</code>ã€<code>MVVM</code>ã€<code>MVP</code>å±äºç•Œé¢å±‚ï¼Œ<br>å½“ä¸šåŠ¡å¤æ‚ï¼Œç½‘ç»œè¯·æ±‚å’Œdbæ“ä½œè¾¾åˆ°äº†ä¸€ä¸ªæ–°çš„é«˜åº¦ï¼Œç•Œé¢å¤æ‚åˆ°éœ€è¦å¥½å¤šäººæ¥åšï¼Œé‚£ä¹ˆç•Œé¢ã€ä¸šåŠ¡ã€æ•°æ®éœ€è¦åˆ†å±‚äº†</p>
<p>åˆ†å±‚ä¹‹åï¼Œå¾—åˆ°äº†ä¸€ä¸ªä¸‰å±‚æ¶æ„æˆ–å››å±‚æ¶æ„</p>
<p><img src="/images/13-5.png" alt="ä¸‰å±‚æ¶æ„"></p>
<p>æ•°æ®å±‚ä¹Ÿå¯ä»¥åˆ†ä¸ºä¸¤å±‚ï¼Œåˆ†ä¸ºç½‘ç»œè¯·æ±‚å’Œdbå±‚ã€‚</p>
<p><img src="/images/13-6.png" alt="å››å±‚æ¶æ„"></p>
<p>å…·ä½“åœ¨å·¥ç¨‹ä¸­æˆ‘ä»¬é€šå¸¸è¿™æ ·ä½“ç°</p>
<p><img src="/images/13-7.png" alt></p>
<p>åœ¨<code>vc</code>ä¸­è·å–æ•°æ®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@interface ViewController ()</span><br><span class="line">@property (nonatomic,strong) FYDBPool *db;</span><br><span class="line">@property (nonatomic,strong) FYHttpPool *http;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation ViewController</span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">	[super viewDidLoad];</span><br><span class="line"></span><br><span class="line">	//å½“æœ‰ä¸šåŠ¡å±‚</span><br><span class="line">	[[FYNewsService new] loadNewsWithInfo:nil success:^(NSArray * _Nonnull) &#123;</span><br><span class="line">		</span><br><span class="line">	&#125; fail:^&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;];</span><br><span class="line">	//å½“æ²¡æœ‰æœ‰ä¸šåŠ¡å±‚</span><br><span class="line">	self.db=[FYDBPool new];</span><br><span class="line">	self.http=[FYHttpPool new];</span><br><span class="line">	[self.db loadNewsWithInfo:@&#123;&#125; success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">		if ([ret count]) &#123;</span><br><span class="line">			NSLog(@&quot;æ•°æ®è·å–æˆåŠŸ&quot;);</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			[self.http loadNewsWithInfo:@&#123;&#125; success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">				NSLog(@&quot;æ•°æ®è·å–æˆåŠŸ&quot;);</span><br><span class="line">			&#125; fail:^&#123;</span><br><span class="line">				NSLog(@&quot;æ•°æ®è·å–å¤±è´¥&quot;);</span><br><span class="line">			&#125;];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; fail:^&#123;</span><br><span class="line">		[self.http loadNewsWithInfo:@&#123;&#125; success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">			NSLog(@&quot;æ•°æ®è·å–æˆåŠŸ&quot;);</span><br><span class="line">		&#125; fail:^&#123;</span><br><span class="line">			NSLog(@&quot;æ•°æ®è·å–å¤±è´¥&quot;);</span><br><span class="line">		&#125;];</span><br><span class="line">	&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸šåŠ¡å±‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@interface FYNewsService ()</span><br><span class="line">@property (nonatomic,strong) FYDBPool *db;</span><br><span class="line">@property (nonatomic,strong) FYHttpPool *http;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line">@implementation FYNewsService</span><br><span class="line">-(instancetype)init&#123;</span><br><span class="line">	if (self = [super init]) &#123;</span><br><span class="line">		self.db=[FYDBPool new];</span><br><span class="line">		self.http=[FYHttpPool new];</span><br><span class="line">	&#125;</span><br><span class="line">	return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)loadNewsWithInfo:(NSDictionary *)info</span><br><span class="line">				 success:(succcessCallback )succblock</span><br><span class="line">					fail:(dispatch_block_t)failBlock&#123;</span><br><span class="line">	[self.db loadNewsWithInfo:info success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">		if ([ret count]) &#123;</span><br><span class="line">			succblock(ret);</span><br><span class="line">		&#125;else&#123;</span><br><span class="line">			[self.http loadNewsWithInfo:info success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">				succblock(ret);</span><br><span class="line">			&#125; fail:failBlock];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; fail:^&#123;</span><br><span class="line">		[self.http loadNewsWithInfo:info success:^(NSArray * _Nonnull ret) &#123;</span><br><span class="line">			succblock(ret);</span><br><span class="line">		&#125; fail:failBlock];</span><br><span class="line">	&#125;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>åœ¨dbå±‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef void(^succcessCallback)(NSArray *);</span><br><span class="line">@interface FYDBPool : NSObject</span><br><span class="line">- (void)loadNewsWithInfo:(NSDictionary *)info</span><br><span class="line">				 success:(succcessCallback )succblock</span><br><span class="line">					fail:(dispatch_block_t)failBlock;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>åœ¨ç½‘ç»œè¯·æ±‚å±‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">typedef void(^succcessCallback)(NSArray *);</span><br><span class="line">@interface FYHttpPool : NSObject</span><br><span class="line">- (void)loadNewsWithInfo:(NSDictionary *)info</span><br><span class="line">				 success:(succcessCallback )succblock</span><br><span class="line">					fail:(dispatch_block_t)failBlock;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>åˆ†å±‚ç›®çš„æ˜¯ç˜¦èº«ï¼Œé€»è¾‘æ¸…æ™°ï¼Œä¸šåŠ¡æ¸…æ™°ï¼Œé™ä½è€¦åˆï¼Œå½“æŸä¸€å—è¶³å¤Ÿå¤æ‚æ—¶å€™ï¼Œéƒ½å¯ä»¥è¿›è¡Œåˆ†å±‚ï¼Œä¸å±€é™äºç½‘ç»œæˆ–<code>db</code>ï¼Œå½“<code>db</code>è¶³å¤Ÿå¤æ‚ï¼Œä¹Ÿéœ€è¦è¿›è¡Œä¸€ä¸ªåˆ†å±‚æ¥è§£å†³å¤æ‚è°ƒç”¨å’Œå¤„ç†çš„é—®é¢˜ã€‚<br>ä¸åŒçš„äººæ¥å¤„ç†ä¸åŒçš„åˆ†å±‚ï¼Œç›¸äº’å½±å“ä¹Ÿæ¯”è¾ƒå°ï¼Œé™ä½è€¦åˆã€‚</p>
<p><strong>å½“é€»è¾‘å±‚è¶³å¤Ÿå®Œå–„ï¼Œåˆ™UIå±‚å¦‚ä½•å˜åŠ¨éƒ½ä¸éœ€è¦æ›´æ”¹é€»è¾‘å±‚ã€‚</strong></p>
<h3 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h3><p>ä¼˜é›…çš„ä»£ç æ€»æ˜¯ä¼´éšç€å„ç§ä¼ ç»Ÿè®¾è®¡æ¨¡å¼çš„æ­é…</p>
<h4 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h4><blockquote>
<p>è®¾è®¡æ¨¡å¼ï¼ˆDesign Patternï¼‰<br>æ˜¯ä¸€å¥—è¢«åå¤ä½¿ç”¨ã€ä»£ç è®¾è®¡ç»éªŒçš„æ€»ç»“<br>ä½¿ç”¨è®¾è®¡æ¨¡å¼çš„å¥½å¤„æ˜¯ï¼šå¯é‡ç”¨ä»£ç ã€è®©ä»£ç æ›´å®¹æ˜“è¢«ä»–äººç†è§£ã€ä¿è¯ä»£ç å¯é æ€§<br>ä¸€èˆ¬ä¸ç¼–ç¨‹è¯­è¨€æ— å…³ï¼Œæ˜¯ä¸€å¥—æ¯”è¾ƒæˆç†Ÿçš„ç¼–ç¨‹æ€æƒ³</p>
</blockquote>
<p>è®¾è®¡æ¨¡å¼å¯ä»¥åˆ†ä¸ºä¸‰å¤§ç±»</p>
<ol>
<li><p>åˆ›å»ºå‹æ¨¡å¼ï¼šå¯¹è±¡å®ä¾‹åŒ–çš„æ¨¡å¼ï¼Œç”¨äºè§£è€¦å¯¹è±¡çš„å®ä¾‹åŒ–è¿‡ç¨‹<br>å•ä¾‹æ¨¡å¼ã€å·¥å‚æ–¹æ³•æ¨¡å¼ï¼Œç­‰ç­‰</p>
</li>
<li><p>ç»“æ„å‹æ¨¡å¼ï¼šæŠŠç±»æˆ–å¯¹è±¡ç»“åˆåœ¨ä¸€èµ·å½¢æˆä¸€ä¸ªæ›´å¤§çš„ç»“æ„<br>ä»£ç†æ¨¡å¼ã€é€‚é…å™¨æ¨¡å¼ã€ç»„åˆæ¨¡å¼ã€è£…é¥°æ¨¡å¼ï¼Œç­‰ç­‰</p>
</li>
<li><p>è¡Œä¸ºå‹æ¨¡å¼ï¼šç±»æˆ–å¯¹è±¡ä¹‹é—´å¦‚ä½•äº¤äº’ï¼ŒåŠåˆ’åˆ†è´£ä»»å’Œç®—æ³•<br>è§‚å¯Ÿè€…æ¨¡å¼ã€å‘½ä»¤æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼ï¼Œç­‰ç­‰</p>
</li>
</ol>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li>é€‚åˆé¡¹ç›®çš„æ‰æ˜¯æœ€å¥½çš„æ¶æ„</li>
</ul>
<h3 id="èµ„æ–™å‚è€ƒ"><a href="#èµ„æ–™å‚è€ƒ" class="headerlink" title="èµ„æ–™å‚è€ƒ"></a>èµ„æ–™å‚è€ƒ</h3><ul>
<li><a href="https://baike.baidu.com/item/%E4%B8%89%E5%B1%82%E6%9E%B6%E6%9E%84" target="_blank" rel="noopener">ä¸‰å±‚æ¶æ„</a><h3 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h3></li>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="noopener">å­¦ä¹ èµ„æ–™ä¸‹è½½git</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="noopener">demo code git</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC/objc4-750" target="_blank" rel="noopener">runtimeå¯è¿è¡Œçš„æºç git</a></li>
</ul>
<hr>
<p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p>
<p>å¹¿å‘Šæ—¶é—´</p>
<p><img src="/images/0.png" alt></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOSåº•å±‚åŸç† å†…å­˜ç®¡ç† é‚£äº›ä½ ä¸çŸ¥é“çš„åŸç†æ±‡æ€» â€” (12)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyongçš„æŠ€æœ¯åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/01/iOSåº•å±‚åŸç† å†…å­˜ç®¡ç† é‚£äº›ä½ ä¸çŸ¥é“çš„åŸç†æ±‡æ€» â€” (12)/" class="post-title-link" itemprop="http://fgyong.cn/index.html">iOSåº•å±‚åŸç†  å†…å­˜ç®¡ç† é‚£äº›ä½ ä¸çŸ¥é“çš„åŸç†æ±‡æ€» --(12)</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-01 11:22:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:22:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-09-03 16:24:13" itemprop="dateModified" datetime="2020-09-03T16:24:13+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>çœ‹å®Œæœ¬æ–‡ç« ä½ å°†äº†è§£åˆ°</p>
<blockquote>
<ol>
<li>DisplayLinkå’Œtimerçš„ä½¿ç”¨å’ŒåŸç†</li>
<li>å†…å­˜åˆ†é…å’Œå†…å­˜ç®¡ç†</li>
<li>è‡ªåŠ¨é‡Šæ”¾æ± åŸç†</li>
<li>weakæŒ‡é’ˆåŸç†å’Œé‡Šæ”¾æ—¶æœº</li>
<li>å¼•ç”¨è®¡æ•°åŸç†</li>
</ol>
</blockquote>
<p>/</p>
<h3 id="DisplayLink"><a href="#DisplayLink" class="headerlink" title="DisplayLink"></a>DisplayLink</h3><p><code>CADisplayLink</code>æ˜¯å°†ä»»åŠ¡æ·»åŠ åˆ°<code>runloop</code>ä¸­ï¼Œ<code>loop</code>æ¯æ¬¡å¾ªç¯ä¾¿ä¼šè°ƒç”¨<code>target</code>çš„<code>selector</code>ï¼Œä½¿ç”¨è¿™ä¸ªä¹Ÿèƒ½ç›‘æµ‹å¡é¡¿é—®é¢˜ã€‚é¦–å…ˆä»‹ç»ä¸‹<code>API</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+ (CADisplayLink *)displayLinkWithTarget:(id)target selector:(SEL)sel;</span><br><span class="line">//runloopæ²¡å¾ªç¯ä¸€åœˆéƒ½ä¼šè°ƒç”¨</span><br><span class="line">- (void)addToRunLoop:(NSRunLoop *)runloop forMode:(NSRunLoopMode)mode;</span><br><span class="line">//ä»runloopä¸­åˆ é™¤</span><br><span class="line">- (void)removeFromRunLoop:(NSRunLoop *)runloop forMode:(NSRunLoopMode)mode;</span><br><span class="line">//å–æ¶ˆ</span><br><span class="line">- (void)invalidate;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬åœ¨ä¸€ä¸ªéœ€è¦<code>push</code>çš„<code>VC</code>ä¸­è¿è¡Œæ¥è§‚å¯Ÿå£°æ˜å‘¨æœŸ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic,strong) CADisplayLink *link;</span><br><span class="line"></span><br><span class="line">//åˆå§‹åŒ–</span><br><span class="line">self.link = [FYDisplayLink displayLinkWithTarget:self selector:@selector(test)];</span><br><span class="line">[self.link addToRunLoop:[NSRunLoop mainRunLoop] forMode:NSDefaultRunLoopMode];</span><br><span class="line">timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, dispatch_get_main_queue());</span><br><span class="line">dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC, 1 * NSEC_PER_SEC);</span><br><span class="line">dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">	@synchronized (self) &#123;</span><br><span class="line">		NSLog(@&quot;FPS:%d&quot;,fps);</span><br><span class="line">		fps = 0;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_resume(timer);</span><br><span class="line">//å…¨å±€å˜é‡</span><br><span class="line">dispatch_source_t timer;</span><br><span class="line">static int fps;</span><br><span class="line"></span><br><span class="line">- (void)test&#123;</span><br><span class="line">	</span><br><span class="line">	@synchronized (self) &#123;</span><br><span class="line">		fps += 1;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">	[self.link invalidate];</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">2019-07-30 17:44:37.217781+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:38.212477+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:39.706000+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:89</span><br><span class="line">2019-07-30 17:44:40.706064+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:41.705589+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:42.706268+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:43.705942+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br><span class="line">2019-07-30 17:44:44.705792+0800 day17-å®šæ—¶å™¨[29637:6504821] FPS:60</span><br></pre></td></tr></table></figure>
<p>åˆå§‹åŒ–ä¹‹åï¼Œå¯¹<code>fps</code>ä½¿ç”¨äº†ç®€å•ç‰ˆæœ¬çš„è¯»å†™é”ï¼Œå¯ä»¥çœ‹åˆ°<code>fps</code>åŸºæœ¬ç¨³å®šåœ¨60å·¦å³ï¼Œç‚¹å‡»æŒ‰é’®è¿”å›ä¹‹åï¼Œ<code>link</code>å’Œ<code>VC</code>å¹¶æ²¡æœ‰æ­£å¸¸é”€æ¯ã€‚æˆ‘ä»¬åˆ†æä¸€ä¸‹ï¼Œ<code>VCï¼ˆselfï¼‰</code>-&gt;<code>link</code>-&gt;<code>target(self)</code>,å¯¼è‡´äº†æ­»å¾ªç¯ï¼Œé‡Šæ”¾çš„æ—¶å€™ï¼Œæ— æ³•é‡Šæ”¾<code>self</code>å’Œ<code>link</code>,é‚£ä¹ˆæˆ‘ä»¬æ”¹åŠ¨ä¸€ä¸‹<code>link</code>-&gt;<code>target(self)</code>ä¸­çš„å¼ºå¼•ç”¨ï¼Œæ”¹æˆå¼±å¼•ç”¨ï¼Œä»£ç æ”¹æˆä¸‹é¢çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@interface FYTimerTarget : NSObject</span><br><span class="line">@property (nonatomic,weak) id target;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYTimerTarget</span><br><span class="line">-(id)forwardingTargetForSelector:(SEL)aSelector&#123;</span><br><span class="line">	return self.target;</span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FYProxy *proxy=[FYProxy proxyWithTarget:self];</span><br><span class="line">self.link = [FYDisplayLink displayLinkWithTarget:self selector:@selector(test)];</span><br><span class="line">[self.link addToRunLoop:[NSRunLoop mainRunLoop] forMode:NSDefaultRunLoopMode];</span><br><span class="line"></span><br><span class="line">- (void)test&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line">2019-07-30 17:59:04.339934 -[ViewController test]</span><br><span class="line">2019-07-30 17:59:04.356292 -[ViewController test]</span><br><span class="line">2019-07-30 17:59:04.371428 -[FYTimerTarget dealloc]</span><br><span class="line">2019-07-30 17:59:04.371634 -[ViewController dealloc]</span><br></pre></td></tr></table></figure>
<p><code>FYTimerTarget</code>å¯¹<code>target</code>è¿›è¡Œäº†å¼±å¼•ç”¨ï¼Œ<code>self</code>å¯¹<code>FYTimerTarget</code>è¿›è¡Œå¼ºå¼•ç”¨ï¼Œåœ¨é”€æ¯äº†çš„æ—¶å€™ï¼Œå…ˆé‡Šæ”¾<code>self</code>,ç„¶åæ£€æŸ¥<code>self</code>çš„<code>FYTimerTarget</code>,<code>FYTimerTarget</code>åªæœ‰ä¸€ä¸ªå‚æ•°<code>weak</code>å±æ€§ï¼Œå¯ä»¥ç›´æ¥é‡Šæ”¾ï¼Œé‡Šæ”¾å®Œ<code>FYTimerTarget</code>ï¼Œç„¶åé‡Šæ”¾<code>self(VC)</code>ï¼Œæœ€ç»ˆå¯ä»¥æ­£å¸¸ã€‚</p>
<h3 id="NSTimer"><a href="#NSTimer" class="headerlink" title="NSTimer"></a>NSTimer</h3><p>ä½¿ç”¨<code>NSTimer</code>çš„æ—¶å€™ï¼Œ<code>timerWithTimeInterval:(NSTimeInterval)ti target:(id)aTarget selector:(SEL)aSelector userInfo:(nullable id)userInfo repeats:(BOOL)yesOrNo</code>ä¼šå¯¹<code>aTarget</code>è¿›è¡Œå¼ºå¼•ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯¹è¿™ä¸ª<code>aTarget</code>è¿›è¡Œä¸€ä¸ªç®€å•çš„å°è£…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">@interface FYProxy : NSProxy</span><br><span class="line">@property (nonatomic,weak) id target;</span><br><span class="line"></span><br><span class="line">+(instancetype)proxyWithTarget:(id)target;</span><br><span class="line">@end</span><br><span class="line">@implementation FYProxy</span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">+ (instancetype)proxyWithTarget:(id)target&#123;</span><br><span class="line">	FYProxy *obj=[FYProxy alloc];</span><br><span class="line">	obj.target = target;</span><br><span class="line">	return obj;</span><br><span class="line">&#125;</span><br><span class="line">//è½¬å‘</span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)invocation&#123;</span><br><span class="line">	[invocation invokeWithTarget:self.target];</span><br><span class="line">&#125;</span><br><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel&#123;</span><br><span class="line">	return [self.target methodSignatureForSelector:sel];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p><code>FYProxy</code>æ˜¯ç»§æ‰¿<code>NSProxy</code>ï¼Œè€Œ<code>NSProxy</code>ä¸æ˜¯ç»§æ‰¿<code>NSObject</code>çš„,è€Œæ˜¯å¦å¤–ä¸€ç§åŸºç±»ï¼Œä¸ä¼šèµ°<code>objc_msgSend()</code>çš„ä¸‰å¤§æ­¥éª¤ï¼Œå½“æ‰¾ä¸åˆ°å‡½æ•°çš„æ—¶å€™ç›´æ¥æ‰§è¡Œ<code>- (void)forwardInvocation:(NSInvocation *)invocation</code>ï¼Œå’Œ<code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)sel</code>ç›´æ¥è¿›å…¥æ¶ˆæ¯è½¬å‘é˜¶æ®µã€‚æˆ–è€…å°†ç»§æ‰¿å…³ç³»æ”¹æˆ<code>FYTimerTarget : NSObject</code>,è¿™æ ·å­<code>target</code>æ‰¾ä¸åˆ°çš„å‡½æ•°è¿˜æ˜¯ä¼šèµ°æ¶ˆæ¯è½¬å‘çš„ä¸‰å¤§æ­¥éª¤ï¼Œæˆ‘ä»¬å†<code>FYTimerTarget</code>æ·»åŠ æ¶ˆæ¯åŠ¨æ€è§£æ<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-(id)forwardingTargetForSelector:(SEL)aSelector&#123;</span><br><span class="line">	return self.target;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>è¿™æ ·å­<code>target</code>çš„<code>aSelector</code>è½¬å‘ç»™äº†<code>self.target</code>å¤„ç†ï¼ŒæˆåŠŸå¼±å¼•ç”¨äº†<code>self</code>å’Œå‡½æ•°çš„è½¬å‘å¤„ç†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">FYTimerTarget *obj =[FYTimerTarget new];</span><br><span class="line">obj.target = self;</span><br><span class="line"></span><br><span class="line">self.timer = [NSTimer timerWithTimeInterval:1.0f</span><br><span class="line">									target:obj</span><br><span class="line">								   selector:@selector(test)</span><br><span class="line">								   userInfo:nil</span><br><span class="line">									repeats:YES];</span><br><span class="line">[[NSRunLoop mainRunLoop] addTimer:self.timer forMode:NSRunLoopCommonModes];</span><br><span class="line">[self.timer setFireDate:[NSDate distantPast]];</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line">2019-07-30 18:03:08.723433+0800 day17-å®šæ—¶å™¨[30877:6556631] -[ViewController test]</span><br><span class="line">2019-07-30 18:03:09.722611+0800 day17-å®šæ—¶å™¨[30877:6556631] -[ViewController test]</span><br><span class="line">2019-07-30 18:03:09.847540+0800 day17-å®šæ—¶å™¨[30877:6556631] -[FYTimerTarget dealloc]</span><br><span class="line">2019-07-30 18:03:09.847677+0800 day17-å®šæ—¶å™¨[30877:6556631] -[ViewController dealloc]</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ä½¿ç”¨<code>timerWithTimeInterval:(NSTimeInterval)interval repeats:(BOOL)repeats block:(void (^)(NSTimer *timer))block</code>ï¼Œç„¶åå¤–éƒ¨ä½¿ç”¨<code>__weak self</code>è°ƒç”¨å‡½æ•°ï¼Œä¹Ÿä¸ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨ã€‚<br>ä½¿ç”¨<code>block</code>çš„æƒ…å†µï¼Œé‡Šæ”¾æ­£å¸¸ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">self.timer=[NSTimer timerWithTimeInterval:1 repeats:YES block:^(NSTimer * _Nonnull timer) &#123;</span><br><span class="line">	NSLog(@&quot;123&quot;);</span><br><span class="line">&#125;];</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line">2019-07-30 18:08:24.678789+0800 day17-å®šæ—¶å™¨[31126:6566530] 123</span><br><span class="line">2019-07-30 18:08:25.659127+0800 day17-å®šæ—¶å™¨[31126:6566530] 123</span><br><span class="line">2019-07-30 18:08:26.107643+0800 day17-å®šæ—¶å™¨[31126:6566530] -[ViewController dealloc]</span><br></pre></td></tr></table></figure>
<p>ç”±äº<code>link</code>å’Œ<code>timer</code>æ˜¯æ·»åŠ åˆ°<code>runloop</code>ä¸­ä½¿ç”¨çš„ï¼Œæ¯æ¬¡ä¸€ä¸ªå¾ªç¯åˆ™è®¿é—®<code>timer</code>æˆ–è€…<code>link</code>ï¼Œç„¶åæ‰§è¡Œå¯¹åº”çš„å‡½æ•°ï¼Œåœ¨æ—¶é—´ä¸Šæœ‰ç›¸å¯¹å°‘è®¸è¯¯å·®çš„ï¼Œæ¯æ­¤å¾ªç¯ï¼Œè¦åˆ·æ–°UI(åœ¨ä¸»çº¿ç¨‹)ï¼Œè¦æ‰§è¡Œå…¶ä»–å‡½æ•°ï¼Œè¦å¤„ç†ç³»ç»Ÿç«¯å£äº‹ä»¶ï¼Œè¦å¤„ç†å…¶ä»–çš„è®¡ç®—ã€‚ã€‚ã€‚æ€»çš„æ¥è¯´ï¼Œè¯¯å·®è¿˜æ˜¯æœ‰çš„ã€‚</p>
<h3 id="GCDä¸­timer"><a href="#GCDä¸­timer" class="headerlink" title="GCDä¸­timer"></a>GCDä¸­timer</h3><p><code>GCD</code>ä¸­çš„<code>dispatch_source_t</code>çš„å®šæ—¶å™¨æ˜¯åŸºäºå†…æ ¸çš„ï¼Œæ—¶é—´è¯¯å·®ç›¸å¯¹è¾ƒå°‘ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//timer éœ€è¦å¼ºå¼•ç”¨ æˆ–è€…è®¾ç½®æˆå…¨å±€å˜é‡</span><br><span class="line">    timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, dispatch_get_main_queue());</span><br><span class="line">    dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC, 1 * NSEC_PER_SEC);</span><br><span class="line">    //è®¾ç½®</span><br><span class="line">    dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">  //code å®šæ—¶å™¨æ‰§è¡Œçš„ä»£ç </span><br><span class="line"> </span><br><span class="line">    &#125;);</span><br><span class="line">    //å¼€å§‹å®šæ—¶å™¨</span><br><span class="line">    dispatch_resume(timer);</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…ä½¿ç”¨å‡½æ•°<code>dispatch_source_set_event_handler_f(timer, function_t);</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dispatch_source_set_event_handler_f(timer, function_t);</span><br><span class="line">void function_t(void * p)&#123;</span><br><span class="line">    //code here    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸šåŠ¡ç»å¸¸ä½¿ç”¨å®šæ—¶å™¨çš„è¯ï¼Œè¿˜æ˜¯å°è£…ä¸€ä¸ªç®€å•çš„åŠŸèƒ½æ¯”è¾ƒå¥½ï¼Œå°è£…é¦–å…ˆä»éœ€æ±‚å¼€å§‹åˆ†æï¼Œæˆ‘ä»¬ä½¿ç”¨å®šæ—¶å™¨å¸¸ç”¨çš„å‚æ•°éƒ½å“ªäº›ï¼Ÿéœ€è¦å“ªäº›åŠŸèƒ½ï¼Ÿ</p>
<p>é¦–å…ˆéœ€è¦å¼€å§‹çš„æ—¶é—´ï¼Œç„¶åæ‰§è¡Œçš„é¢‘ç‡ï¼Œæ‰§è¡Œçš„ä»»åŠ¡(å‡½æ•°æˆ–block)ï¼Œæ˜¯å¦é‡å¤æ‰§è¡Œï¼Œè¿™äº›éƒ½æ˜¯éœ€è¦çš„ã€‚<br>å…ˆå®šä¹‰ä¸€ä¸ªå‡½æ•°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+ (NSString *)exeTask:(dispatch_block_t)block</span><br><span class="line">    	  start:(NSTimeInterval)time</span><br><span class="line">       interval:(NSTimeInterval)interval</span><br><span class="line">    	 repeat:(BOOL)repeat</span><br><span class="line">    	  async:(BOOL)async;</span><br><span class="line">+ (NSString *)exeTask:(id)target</span><br><span class="line">		  sel:(SEL)aciton</span><br><span class="line">		start:(NSTimeInterval)time</span><br><span class="line">	 interval:(NSTimeInterval)interval</span><br><span class="line">	   repeat:(BOOL)repeat</span><br><span class="line">		async:(BOOL)async;</span><br><span class="line">//å–æ¶ˆ</span><br><span class="line">+ (void)exeCancelTask:(NSString *)key;</span><br></pre></td></tr></table></figure>
<p>ç„¶åå°†åˆšæ‰å†™çš„æ‹¿è¿‡æ¥ï¼Œå¢åŠ äº†ä¸€äº›åˆ¤æ–­ã€‚æœ‰ä»»åŠ¡çš„æ—¶å€™æ‰ä¼šæ‰§è¡Œï¼Œå¦åˆ™ç›´æ¥è¿”å›<code>nil</code>ï¼Œå½“å¾ªç¯çš„æ—¶å€™ï¼Œéœ€è¦é—´éš”å¤§äº0ï¼Œå¦åˆ™è¿”å›ï¼ŒåŒæ­¥æˆ–å¼‚æ­¥ï¼Œå°±æˆ–è€…ä¸»é˜Ÿåˆ—æˆ–è€…å¼‚æ­¥é˜Ÿåˆ—ï¼Œç„¶åç”¨ç”Ÿæˆçš„<code>key</code>,<code>timer</code>ä¸º<code>value</code>å­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­ï¼Œåœ¨å–æ¶ˆçš„æ—¶å€™ç›´æ¥ç”¨<code>key</code>å–å‡º<code>timer</code>å–æ¶ˆï¼Œè¿™é‡Œä½¿ç”¨äº†ä¿¡å·é‡ï¼Œé™åˆ¶å•çº¿ç¨‹æ“ä½œã€‚åœ¨å­˜å‚¨å’Œå–å‡ºï¼ˆå–æ¶ˆtimerï¼‰çš„æ—¶å€™è¿›è¡Œé™åˆ¶ï¼Œæé«˜å…¶ä»–ä»£ç æ‰§è¡Œçš„æ•ˆç‡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">+ (NSString *)exeTask:(dispatch_block_t)block start:(NSTimeInterval)time interval:(NSTimeInterval)interval repeat:(BOOL)repeat async:(BOOL)async&#123;</span><br><span class="line">	if (block == nil) &#123;</span><br><span class="line">		return nil;</span><br><span class="line">	&#125;</span><br><span class="line">	if (repeat &amp;&amp; interval &lt;= 0) &#123;</span><br><span class="line">		return nil;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	NSString *name =[NSString stringWithFormat:@&quot;%d&quot;,i];</span><br><span class="line">	//ä¸»é˜Ÿåˆ—</span><br><span class="line">	dispatch_queue_t queue = dispatch_get_main_queue();</span><br><span class="line">	if (async) &#123;</span><br><span class="line">		queue = dispatch_queue_create(&quot;async.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">	&#125;</span><br><span class="line">	//åˆ›å»ºå®šæ—¶å™¨</span><br><span class="line">	dispatch_source_t _timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);</span><br><span class="line">	//è®¾ç½®å¯åŠ¨æ—¶é—´</span><br><span class="line">	dispatch_source_set_timer(_timer,</span><br><span class="line">							  dispatch_time(DISPATCH_TIME_NOW, time*NSEC_PER_SEC), interval*NSEC_PER_SEC, 0);</span><br><span class="line">	//è®¾å®šå›è°ƒ</span><br><span class="line">	dispatch_source_set_event_handler(_timer, ^&#123;</span><br><span class="line">		block();</span><br><span class="line">		if (repeat == NO) &#123;</span><br><span class="line">			dispatch_source_cancel(_timer);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	//å¯åŠ¨å®šæ—¶å™¨</span><br><span class="line">	dispatch_resume(_timer);</span><br><span class="line">	//å­˜æ”¾åˆ°å­—å…¸</span><br><span class="line">	if (name.length &amp;&amp; _timer) &#123;</span><br><span class="line">		dispatch_semaphore_wait(samephore, DISPATCH_TIME_FOREVER);</span><br><span class="line">		timers[name] = _timer;</span><br><span class="line">		dispatch_semaphore_signal(samephore);</span><br><span class="line">	&#125;</span><br><span class="line">	return name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">+ (NSString *)exeTask:(id)target</span><br><span class="line">				  sel:(SEL)aciton</span><br><span class="line">				start:(NSTimeInterval)time</span><br><span class="line">			 interval:(NSTimeInterval)interval</span><br><span class="line">			   repeat:(BOOL)repeat</span><br><span class="line">				async:(BOOL)async&#123;</span><br><span class="line">	if (target == nil || aciton == NULL) &#123;</span><br><span class="line">		return nil;</span><br><span class="line">	&#125;</span><br><span class="line">	if (repeat &amp;&amp; interval &lt;= 0) &#123;</span><br><span class="line">		return nil;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	NSString *name =[NSString stringWithFormat:@&quot;%d&quot;,i];</span><br><span class="line">	//ä¸»é˜Ÿåˆ—</span><br><span class="line">	dispatch_queue_t queue = dispatch_get_main_queue();</span><br><span class="line">	if (async) &#123;</span><br><span class="line">		queue = dispatch_queue_create(&quot;async.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">	&#125;</span><br><span class="line">	//åˆ›å»ºå®šæ—¶å™¨</span><br><span class="line">	dispatch_source_t _timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);</span><br><span class="line">	//è®¾ç½®å¯åŠ¨æ—¶é—´</span><br><span class="line">	dispatch_source_set_timer(_timer,</span><br><span class="line">							  dispatch_time(DISPATCH_TIME_NOW, time*NSEC_PER_SEC), interval*NSEC_PER_SEC, 0);</span><br><span class="line">	//è®¾å®šå›è°ƒ</span><br><span class="line">	dispatch_source_set_event_handler(_timer, ^&#123;</span><br><span class="line">#pragma clang diagnostic push</span><br><span class="line">#pragma clang diagnostic ignored&quot;-Warc-performSelector-leaks&quot;</span><br><span class="line">		//è¿™é‡Œæ˜¯ä¼šæŠ¥è­¦å‘Šçš„ä»£ç </span><br><span class="line">		if ([target respondsToSelector:aciton]) &#123;</span><br><span class="line">			[target performSelector:aciton];</span><br><span class="line">		&#125;</span><br><span class="line">#pragma clang diagnostic pop</span><br><span class="line"></span><br><span class="line">		if (repeat == NO) &#123;</span><br><span class="line">			dispatch_source_cancel(_timer);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	//å¯åŠ¨å®šæ—¶å™¨</span><br><span class="line">	dispatch_resume(_timer);</span><br><span class="line">	//å­˜æ”¾åˆ°å­—å…¸</span><br><span class="line">	if (name.length &amp;&amp; _timer) &#123;</span><br><span class="line">		dispatch_semaphore_wait(samephore, DISPATCH_TIME_FOREVER);</span><br><span class="line">		timers[name] = _timer;</span><br><span class="line">		dispatch_semaphore_signal(samephore);</span><br><span class="line">	&#125;</span><br><span class="line">	return name;</span><br><span class="line">&#125;</span><br><span class="line">+ (void)exeCancelTask:(NSString *)key&#123;</span><br><span class="line">	if (key.length == 0) &#123;</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line">	dispatch_semaphore_wait(samephore, DISPATCH_TIME_FOREVER);</span><br><span class="line">	if ([timers.allKeys containsObject:key]) &#123;</span><br><span class="line">		dispatch_source_cancel(timers[key]);</span><br><span class="line">		[timers removeObjectForKey:key];</span><br><span class="line">	&#125;</span><br><span class="line">	dispatch_semaphore_signal(samephore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨çš„æ—¶å€™å¾ˆç®€å•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">key = [FYTimer exeTask:^&#123;</span><br><span class="line">        NSLog(@&quot;123&quot;);</span><br><span class="line">    &#125; start:1</span><br><span class="line">    interval:1 </span><br><span class="line">    repeat:YES </span><br><span class="line">    async:NO];</span><br></pre></td></tr></table></figure>
<p>æˆ–è€…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">key = [FYTimer exeTask:self sel:@selector(test) start:0 interval:1 repeat:YES async:YES];</span><br></pre></td></tr></table></figure>
<p>å–æ¶ˆæ‰§è¡Œçš„æ—¶å€™</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[FYTimer exeCancelTask:key];</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•å°è£…çš„å®šæ—¶å™¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">	[super viewDidLoad];</span><br><span class="line">	key = [FYTimer exeTask:self sel:@selector(test) start:0 interval:1 repeat:YES async:YES];</span><br><span class="line">&#125;</span><br><span class="line">-(void)test&#123;</span><br><span class="line">	NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">	[FYTimer exeCancelTask:key];</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">2019-07-30 21:16:48.639486+0800 day17-å®šæ—¶å™¨2[48817:1300897] &lt;NSThread: 0x6000010ec000&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2019-07-30 21:16:49.640177+0800 day17-å®šæ—¶å™¨2[48817:1300897] &lt;NSThread: 0x6000010ec000&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2019-07-30 21:16:50.639668+0800 day17-å®šæ—¶å™¨2[48817:1300897] &lt;NSThread: 0x6000010ec000&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2019-07-30 21:16:51.639590+0800 day17-å®šæ—¶å™¨2[48817:1300897] &lt;NSThread: 0x6000010ec000&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2019-07-30 21:16:52.156004+0800 day17-å®šæ—¶å™¨2[48817:1300845] -[ViewController touchesBegan:withEvent:]</span><br></pre></td></tr></table></figure>
<p>åœ¨ç‚¹å‡»<code>VC</code>çš„æ—¶å€™è¿›è¡Œå–æ¶ˆæ“ä½œï¼Œ<code>timer</code>åœæ­¢ã€‚</p>
<h3 id="NSProxyå®æˆ˜"><a href="#NSProxyå®æˆ˜" class="headerlink" title="NSProxyå®æˆ˜"></a>NSProxyå®æˆ˜</h3><p><code>NSProxy</code>å…¶å®æ˜¯é™¤äº†<code>NSObject</code>çš„å¦å¤–ä¸€ä¸ªåŸºç±»ï¼Œæ–¹æ³•æ¯”è¾ƒå°‘ï¼Œå½“æ‰¾ä¸åˆ°æ–¹æ³•çš„æ—¶å€™æ‰§è¡Œæ¶ˆæ¯è½¬å‘é˜¶æ®µ(å› ä¸ºæ²¡æœ‰çˆ¶ç±»)ï¼Œè°ƒç”¨å‡½æ•°çš„æµç¨‹æ›´çŸ­ï¼Œæ€§èƒ½åˆ™æ›´å¥½ã€‚</p>
<p>é—®é¢˜ï¼š<code>ret1</code>å’Œ<code>ret2</code>åˆ†åˆ«æ˜¯å¤šå°‘ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ViewController *vc1 =[[ViewController alloc]init];</span><br><span class="line">FYProxy *pro1 =[FYProxy proxyWithTarget:vc1];</span><br><span class="line"></span><br><span class="line">FYTimerTarget *tar =[FYTimerTarget proxyWithTarget:vc1];</span><br><span class="line">BOOL ret1 = [pro1 isKindOfClass:ViewController.class];</span><br><span class="line">BOOL ret2 = [tar isKindOfClass:ViewController.class];</span><br><span class="line">NSLog(@&quot;%d %d&quot;,ret1,ret2);</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼Œ<code>-(bool)isKindOfClass:(cls)</code>å¯¹è±¡å‡½æ•°æ˜¯åˆ¤æ–­è¯¥å¯¹è±¡æ˜¯å¦çš„<code>cls</code>çš„å­ç±»æˆ–è€…è¯¥ç±»çš„å®ä¾‹ï¼Œè¿™ç‚¹ä¸å®¹ç½®ç–‘ï¼Œé‚£ä¹ˆ<code>ret1</code>åº”è¯¥æ˜¯<code>0</code>,<code>ret2</code>åº”è¯¥ä¹Ÿæ˜¯<code>0</code></p>
<p>é¦–å…ˆçœ‹<code>FYProxy</code>çš„å®ç°ï¼Œ<code>forwardInvocation</code>å’Œ<code>methodSignatureForSelector</code>ï¼Œåœ¨æ²¡æœ‰è¯¥å‡½æ•°çš„æ—¶å€™è¿›è¡Œæ¶ˆæ¯è½¬å‘ï¼Œè½¬å‘å¯¹è±¡æ˜¯<code>self.target</code>ï¼Œåœ¨è¯¥ä¾‹å­ä¸­<code>isKindOfClass</code>ä¸å­˜åœ¨ä¸<code>FYProxy</code>ï¼Œæ‰€ä»¥è®²è¯¥å‡½æ•°è½¬å‘ç»™äº†<code>VC</code>ï¼Œåˆ™<code>BOOL ret1 = [pro1 isKindOfClass:ViewController.class];</code>ç›¸å½“äº<code>BOOL ret1 = [ViewController.class isKindOfClass:ViewController.class];</code>ï¼Œæ‰€ä»¥ç­”æ¡ˆæ˜¯1</p>
<p>ç„¶å<code>ret2</code>æ˜¯0ï¼Œ<code>tar</code>æ˜¯ç»§æ‰¿äº<code>NSObject</code>çš„ï¼Œæœ¬èº«æœ‰<code>-(bool)isKindOfClass:(cls)</code>å‡½æ•°ï¼Œæ‰€ä»¥ç­”æ¡ˆæ˜¯0ã€‚</p>
<p>ç­”æ¡ˆæ˜¯ï¼š<code>ret1</code>æ˜¯<code>1</code>ï¼Œ<code>ret2</code>æ˜¯<code>0</code>ã€‚</p>
<h3 id="å†…å­˜åˆ†é…"><a href="#å†…å­˜åˆ†é…" class="headerlink" title="å†…å­˜åˆ†é…"></a>å†…å­˜åˆ†é…</h3><p>å†…å­˜åˆ†ä¸ºä¿ç•™æ®µã€æ•°æ®æ®µã€å †(â†“)ã€æ ˆ(â†‘)ã€å†…æ ¸åŒºã€‚</p>
<p>æ•°æ®æ®µåŒ…æ‹¬</p>
<ul>
<li>å­—ç¬¦ä¸²å¸¸é‡ï¼šæ¯”å¦‚NSString * str = @â€11â€</li>
<li>å·²åˆå§‹åŒ–æ•°æ®ï¼šå·²åˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡ç­‰</li>
<li>æœªåˆå§‹åŒ–æ•°æ®ï¼šæœªåˆå§‹åŒ–çš„å…¨å±€å˜é‡ã€é™æ€å˜é‡ç­‰</li>
</ul>
<p>æ ˆï¼šå‡½æ•°è°ƒç”¨å¼€é”€ã€æ¯”å¦‚å±€éƒ¨å˜é‡ï¼Œåˆ†é…çš„å†…å­˜ç©ºé—´åœ°å€è¶Šæ¥è¶Šå°ã€‚</p>
<p>å †ï¼šé€šè¿‡allocã€mallocã€callocç­‰åŠ¨æ€åˆ†é…çš„ç©ºé—´ï¼Œåˆ†é…çš„ç©ºé—´åœ°å€è¶Šæ¥è¶Šå¤§ã€‚</p>
<p>éªŒè¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">int a = 10;</span><br><span class="line">int b ;</span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        static int c = 20;</span><br><span class="line">        static int d;</span><br><span class="line">        int e = 10;</span><br><span class="line">        int f;</span><br><span class="line">        NSString * str = @&quot;123&quot;;</span><br><span class="line">        NSObject *obj =[[NSObject alloc]init];</span><br><span class="line">        NSLog(@&quot;\na:%p \nb:%p \nc:%p \nd:%p \ne:%p \nf:%p \nobj:%p\n str:%p&quot;,&amp;a,&amp;b,&amp;c,&amp;d,&amp;e,&amp;f,obj,str);</span><br><span class="line">        return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">a:0x1063e0d98 </span><br><span class="line">b:0x1063e0e64 </span><br><span class="line">c:0x1063e0d9c </span><br><span class="line">d:0x1063e0e60 </span><br><span class="line">e:0x7ffee9820efc </span><br><span class="line">f:0x7ffee9820ef8 </span><br><span class="line">obj:0x6000013541a0</span><br><span class="line">str:0x1063e0068</span><br></pre></td></tr></table></figure>
<h3 id="Tagged-Pointer"><a href="#Tagged-Pointer" class="headerlink" title="Tagged Pointer"></a>Tagged Pointer</h3><p>ä»64bitå¼€å§‹ï¼ŒiOSå¼•å…¥<code>Tagged Pointer</code>æŠ€æœ¯ï¼Œç”¨äºä¼˜åŒ–<code>NSNumberã€NSDateã€NSString</code>ç­‰å°å¯¹è±¡çš„å­˜å‚¨ï¼Œåœ¨æ²¡æœ‰ä½¿ç”¨ä¹‹å‰ï¼Œä»–ä»¬éœ€è¦åŠ¨æ€åˆ†é…å†…å­˜ï¼Œç»´æŠ¤è®¡æ•°ï¼Œä½¿ç”¨<code>Tagged Pointer</code>ä¹‹åï¼Œ<code>NSNumber</code>æŒ‡é’ˆé‡Œé¢çš„æ•°æ®å˜æˆäº†<code>Tag+Data</code>ï¼Œä¹Ÿå°±æ˜¯å°†æ•°å€¼ç›´æ¥å­˜å‚¨åœ¨äº†æŒ‡é’ˆä¸­ï¼Œåªæœ‰å½“æŒ‡é’ˆä¸å¤Ÿå­˜å‚¨æ•°æ®æ—¶ï¼Œæ‰ä¼šåŠ¨æ€åˆ†é…å†…å­˜çš„æ–¹å¼æ¥å­˜å‚¨æ•°æ®ï¼Œè€Œä¸”<code>objc_msgSend()</code>èƒ½å¤Ÿè¯†åˆ«å‡º<code>Tagged Pointer</code>ï¼Œæ¯”å¦‚<code>NSNumber</code>çš„<code>intValue</code>æ–¹æ³•ï¼Œç›´æ¥ä»æŒ‡é’ˆæå–æ•°æ®ï¼ŒèŠ‚çœäº†ä»¥å‰çš„è°ƒç”¨çš„å¼€é”€ã€‚<br>åœ¨iOSä¸­ï¼Œæœ€é«˜ä½æ˜¯1(ç¬¬64bit)ï¼Œåœ¨Macä¸­ï¼Œæœ€ä½æœ‰æ•ˆä½æ˜¯1ã€‚<br>åœ¨<code>runtime</code>æºç ä¸­<code>objc-internal.h 370è¡Œ</code>åˆ¤æ–­æ˜¯å¦ä½¿ç”¨äº†ä¼˜åŒ–æŠ€æœ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static inline void * _Nonnull</span><br><span class="line">_objc_encodeTaggedPointer(uintptr_t ptr)</span><br><span class="line">&#123;</span><br><span class="line">    return (void *)(objc_debug_taggedpointer_obfuscator ^ ptr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æ‹¿æ¥è¿™ä¸ªå¯ä»¥åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä½¿ç”¨äº†ä¼˜åŒ–æŠ€æœ¯ã€‚</p>
<h4 id="NSNumbe-Tagged-Pointer"><a href="#NSNumbe-Tagged-Pointer" class="headerlink" title="NSNumbe Tagged Pointer"></a>NSNumbe Tagged Pointer</h4><p>æˆ‘ä»¬ä½¿ç”¨å‡ ä¸ª<code>NSNumber</code>çš„å¤§å°æ•°å­—æ¥éªŒè¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">#if (TARGET_OS_OSX || TARGET_OS_IOSMAC) &amp;&amp; __x86_64__ //macå¼€å‘</span><br><span class="line">// 64-bit Mac - tag bit is LSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 0</span><br><span class="line">#else</span><br><span class="line">// Everything else - tag bit is MSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 1//iOSå¼€å‘</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if OBJC_MSB_TAGGED_POINTERS</span><br><span class="line">#   define _OBJC_TAG_MASK (1UL&lt;&lt;63)</span><br><span class="line">#else</span><br><span class="line">#   define _OBJC_TAG_MASK 1UL</span><br><span class="line">#endif</span><br><span class="line">bool objc_isTaggedPointer(const void * _Nullable ptr)</span><br><span class="line">&#123;</span><br><span class="line">    return ((uintptr_t)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        NSNumber *n1 = @2;</span><br><span class="line">        NSNumber *n2 = @3;</span><br><span class="line">        NSNumber *n3 = @(4);</span><br><span class="line">        NSNumber *n4 = @(0x4fffffffff);</span><br><span class="line">        NSLog(@&quot;\n%p \n%p \n%p \n%p&quot;,n1,n2,n3,n4);</span><br><span class="line">        BOOL n1_tag = objc_isTaggedPointer((__bridge const void * _Nullable)(n1));</span><br><span class="line">        BOOL n2_tag = objc_isTaggedPointer((__bridge const void * _Nullable)(n2));</span><br><span class="line">        BOOL n3_tag = objc_isTaggedPointer((__bridge const void * _Nullable)(n3));</span><br><span class="line">        BOOL n4_tag = objc_isTaggedPointer((__bridge const void * _Nullable)(n4));</span><br><span class="line"></span><br><span class="line">        NSLog(@&quot;\nn1:%d \nn2:%d \nn3:%d \nn4:%d &quot;,n1_tag,n2_tag,n3_tag,n4_tag);</span><br><span class="line">        return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">0xbf4071e2657ccb95 </span><br><span class="line">0xbf4071e2657ccb85 </span><br><span class="line">0xbf4071e2657ccbf5 </span><br><span class="line">0xbf40751d9a833444</span><br><span class="line">2019-07-30 21:55:52.626317+0800 day17-TaggedPointer[49770:1328036] </span><br><span class="line">n1:1 </span><br><span class="line">n2:1 </span><br><span class="line">n3:1 </span><br><span class="line">n4:0</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>n1 n2 n3</code>æ˜¯ç»è¿‡ä¼˜åŒ–çš„ï¼Œè€Œ<code>n4</code>æ˜¯å¤§æ•°å­—ï¼ŒæŒ‡é’ˆå®¹ä¸ä¸‹è¯¥æ•°å€¼ï¼Œä¸èƒ½ä¼˜åŒ–ã€‚</p>
<h4 id="NSString-Tagged-Pointer"><a href="#NSString-Tagged-Pointer" class="headerlink" title="NSString Tagged Pointer"></a>NSString Tagged Pointer</h4><p>çœ‹ä¸‹é¢ä¸€é“é¢˜,è¿è¡Œ<code>test1</code>å’Œ<code>test2</code>ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">- (void)test1&#123;</span><br><span class="line">	dispatch_queue_t queue = dispatch_get_global_queue(0, 0);</span><br><span class="line">	for (NSInteger i = 0; i &lt; 1000; i ++) &#123;</span><br><span class="line">		dispatch_async(queue, ^&#123;</span><br><span class="line">			self.name = [NSString stringWithFormat:@&quot;abc&quot;];</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)test2&#123;</span><br><span class="line">	dispatch_queue_t queue = dispatch_get_global_queue(0, 0);</span><br><span class="line">	for (NSInteger i = 0; i &lt; 1000; i ++) &#123;</span><br><span class="line">		dispatch_async(queue, ^&#123;</span><br><span class="line">			self.name = [NSString stringWithFormat:@&quot;abcsefafaefafafaefe&quot;];</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å…ˆä¸è¿è¡Œï¼Œå…ˆåˆ†æä¸€ä¸‹ã€‚</p>
<p>é¦–å…ˆå…¨å±€é˜Ÿåˆ—å¼‚æ­¥æ·»åŠ ä»»åŠ¡ä¼šå‡ºç°å¤šçº¿ç¨‹å¹¶å‘é—®é¢˜ï¼Œåœ¨å¹¶å‘çš„æ—¶å€™è¿›è¡Œå†™æ“ä½œä¼šå‡ºç°èµ„æºç«äº‰é—®é¢˜ï¼Œå¦å¤–ä¸€ä¸ªå°å­—ç¬¦ä¸²ä¼šå‡ºç°æŒ‡é’ˆä¼˜åŒ–é—®é¢˜ï¼Œå°å­—ç¬¦ä¸²å’Œå¤§å­—ç¬¦ä¸²åˆ‡æ¢å¯¼è‡´<code>_name</code>ç»“æ„å˜åŒ–ï¼Œå¤šçº¿ç¨‹åŒæ—¶å†™å…¥å’Œè¯»ä¼šå¯¼è‡´è®¿é—®åå†…å­˜é—®é¢˜ï¼Œæˆ‘ä»¬æ¥è¿è¡Œä¸€ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Thread: EXC_BAD_ACCESS(code = 1)</span><br></pre></td></tr></table></figure>
<p>ç›´æ¥åœ¨å­çº¿ç¨‹å´©æºƒäº†ï¼Œå´©æºƒå‡½æ•°æ˜¯<code>objc_release</code>ã€‚ç¬¦åˆæˆ‘ä»¬çš„çŒœæƒ³ã€‚</p>
<p>éªŒè¯<code>NSString Tagged Pointer</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (void)test&#123;</span><br><span class="line">	dispatch_queue_t queue = dispatch_get_global_queue(0, 0);</span><br><span class="line">	for (NSInteger i = 0; i &lt; 1; i ++) &#123;</span><br><span class="line">		dispatch_async(queue, ^&#123;</span><br><span class="line">			self.name = [NSString stringWithFormat:@&quot;abc&quot;];</span><br><span class="line">			NSLog(@&quot;test1 class:%@&quot;,self.name.class);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)test2&#123;</span><br><span class="line">	dispatch_queue_t queue = dispatch_get_global_queue(0, 0);</span><br><span class="line">	for (NSInteger i = 0; i &lt; 1; i ++) &#123;</span><br><span class="line">		dispatch_async(queue, ^&#123;</span><br><span class="line">			self.name = [NSString stringWithFormat:@&quot;abcsefafaefafafaefe&quot;];</span><br><span class="line">			NSLog(@&quot;test2 class:%@&quot;,self.name.class);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">test1 class:NSTaggedPointerString</span><br><span class="line">test2 class:__NSCFString</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>NSString Tagged Pointer</code>åœ¨å°å­—ç¬¦ä¸²çš„æ—¶å€™ç±»æ˜¯<code>NSTaggedPointerString</code>ï¼Œç»è¿‡ä¼˜åŒ–çš„ç±»ï¼Œå¤§å­—ç¬¦ä¸²çš„ç±»æ˜¯<code>__NSCFString</code>ï¼Œ</p>
<h3 id="copy"><a href="#copy" class="headerlink" title="copy"></a>copy</h3><p>æ‹·è´åˆ†ä¸ºæµ…æ‹·è´å’Œæ·±æ‹·è´ï¼Œæµ…æ‹·è´åªæ˜¯å¼•ç”¨è®¡æ•°+1ï¼Œæ·±æ‹·è´æ˜¯æ‹·è´äº†ä¸€ä¸ªå¯¹è±¡ï¼Œå’Œä¹‹å‰çš„ äº’ä¸å½±å“ï¼Œ å¼•ç”¨è®¡æ•°äº’ä¸å½±å“ã€‚</p>
<p>æ‹·è´ç›®çš„ï¼šäº§ç”Ÿä¸€ä¸ªå‰¯æœ¬å¯¹è±¡ï¼Œè·Ÿæºå¯¹è±¡äº’ä¸å½±å“<br> ä¿®æ”¹æºå¯¹è±¡ï¼Œä¸ä¼šå½±å“åˆ°å‰¯æœ¬å¯¹è±¡<br> ä¿®æ”¹å‰¯æœ¬å¯¹è±¡ï¼Œä¸ä¼šå½±å“æºå¯¹è±¡</p>
<p> iOSæä¾›äº†2ä¸­æ‹·è´æ–¹æ³•</p>
<ol>
<li>copy æ‹·è´å‡ºæ¥ä¸å¯å˜å¯¹è±¡</li>
<li>mutableCopy æ‹·è´å‡ºæ¥å¯å˜å¯¹è±¡</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void test1()&#123;</span><br><span class="line">	NSString *str = @&quot;strstrstrstr&quot;;</span><br><span class="line">	NSMutableString *mut1 =[str mutableCopy];</span><br><span class="line">	[mut1 appendFormat:@&quot;123&quot;];</span><br><span class="line">	NSString *str2 = [str copy];</span><br><span class="line">	NSLog(@&quot;%p %p %p&quot;,str,mut1,str2);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">str:0x100001040 </span><br><span class="line">mut1:0x1007385f0 </span><br><span class="line">str2:0x100001040</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°<code>str</code>å’Œ<code>str2</code>åœ°å€ä¸€æ ·ï¼Œæ²¡æœ‰é‡æ–°å¤åˆ¶å‡ºæ¥ä¸€ä»½ï¼Œ<code>mut1</code>åœ°å€å’Œ<code>str</code>ä¸ä¸€è‡´ï¼Œæ˜¯æ·±æ‹·è´ï¼Œé‡æ–°æ‹·è´äº†ä¸€ä»½ã€‚</p>
<p>æˆ‘ä»¬æŠŠå­—ç¬¦ä¸²æ¢æˆå…¶ä»–å¸¸ç”¨çš„æ•°ç»„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">void test2()&#123;</span><br><span class="line">	NSArray *array = @[@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;];</span><br><span class="line">	NSMutableArray *mut =[array mutableCopy];</span><br><span class="line">	NSString *array2 = [array copy];</span><br><span class="line">	NSLog(@&quot;\n%p \n%p\n%p&quot;,array,mut,array2);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">0x102840800 </span><br><span class="line">0x1028408a0</span><br><span class="line">0x102840800</span><br><span class="line"></span><br><span class="line">void test3()&#123;</span><br><span class="line">	NSArray *array = [@[@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;,@&quot;123&quot;] mutableCopy];</span><br><span class="line">	NSMutableArray *mut =[array mutableCopy];</span><br><span class="line">	NSString *array2 = [array copy];</span><br><span class="line">	NSLog(@&quot;\n%p \n%p\n%p&quot;,array,mut,array2);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">0x102808720 </span><br><span class="line">0x1028088a0</span><br><span class="line">0x1028089a0</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢å¯ä»¥æ€»ç»“çœ‹å‡ºæ¥ï¼Œä¸å˜æ•°ç»„æ‹·è´å‡ºæ¥ä¸å˜æ•°ç»„ï¼Œåœ°å€ä¸æ”¹å˜ï¼Œæ‹·è´å‡ºæ¥å¯å˜æ•°ç»„åœ°å€æ”¹å˜ï¼Œå¯å˜æ•°ç»„æ‹·è´å‡ºæ¥ä¸å¯å˜æ•°ç»„å’Œå¯å˜æ•°ç»„ï¼Œåœ°å€ä¼šæ”¹å˜ã€‚</p>
<p>æˆ‘ä»¬å†æ¢æˆå…¶ä»–çš„å¸¸ç”¨çš„å­—å…¸</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">void test4()&#123;</span><br><span class="line">	NSDictionary *item = @&#123;@&quot;key&quot;:@&quot;value&quot;&#125;;</span><br><span class="line">	NSMutableDictionary *mut =[item mutableCopy];</span><br><span class="line">	NSDictionary *item2 = [item copy];</span><br><span class="line">	NSLog(@&quot;\n%p \n%p\n%p&quot;,item,mut,item2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line">0x1007789c0 </span><br><span class="line">0x100779190</span><br><span class="line">0x1007789c0</span><br><span class="line"></span><br><span class="line">void test5()&#123;</span><br><span class="line">	NSDictionary *item = [@&#123;@&quot;key&quot;:@&quot;value&quot;&#125;mutableCopy];</span><br><span class="line">	NSMutableDictionary *mut =[item mutableCopy];</span><br><span class="line">	NSDictionary *item2 = [item copy];</span><br><span class="line">	NSLog(@&quot;\n%p \n%p\n%p&quot;,item,mut,item2);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">0x1007041d0 </span><br><span class="line">0x1007042b0</span><br><span class="line">0x1007043a0</span><br></pre></td></tr></table></figure>
<p>ä»ä¸Šé¢å¯ä»¥æ€»ç»“çœ‹å‡ºæ¥ï¼Œä¸å˜å­—å…¸æ‹·è´å‡ºæ¥ä¸å˜å­—å…¸ï¼Œåœ°å€ä¸æ”¹å˜ï¼Œæ‹·è´å‡ºæ¥å¯å˜å­—å…¸åœ°å€æ”¹å˜ï¼Œå¯å˜å­—å…¸æ‹·è´å‡ºæ¥ä¸å¯å˜å­—å…¸å’Œå¯å˜å­—å…¸ï¼Œåœ°å€ä¼šæ”¹å˜ã€‚</p>
<p>ç”±è¿™å‡ ä¸ªçœ‹å‡ºæ¥ï¼Œæ€»ç»“å‡ºæ¥ä¸‹è¡¨</p>
<table>
<thead>
<tr>
<th style="text-align:center">ç±»å‹</th>
<th style="text-align:center">copy</th>
<th style="text-align:center">mutableCopy</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">NSString</td>
<td style="text-align:center">æµ…æ‹·è´</td>
<td style="text-align:center">æ·±æ‹·è´</td>
</tr>
<tr>
<td style="text-align:center">NSMutableString</td>
<td style="text-align:center">æµ…æ‹·è´</td>
<td style="text-align:center">æ·±æ‹·è´</td>
</tr>
<tr>
<td style="text-align:center">NSArray</td>
<td style="text-align:center">æµ…æ‹·è´</td>
<td style="text-align:center">æ·±æ‹·è´</td>
</tr>
<tr>
<td style="text-align:center">NSMutableArray</td>
<td style="text-align:center">æ·±æ‹·è´</td>
<td style="text-align:center">æ·±æ‹·è´</td>
</tr>
<tr>
<td style="text-align:center">NSDictionary</td>
<td style="text-align:center">æµ…æ‹·è´</td>
<td style="text-align:center">æ·±æ‹·è´</td>
</tr>
<tr>
<td style="text-align:center">NSMutableDictionary</td>
<td style="text-align:center">æ·±æ‹·è´</td>
<td style="text-align:center">æ·±æ‹·è´</td>
</tr>
</tbody>
</table>
<h4 id="è‡ªå®šä¹‰å¯¹è±¡å®ç°åè®®NSCoping"><a href="#è‡ªå®šä¹‰å¯¹è±¡å®ç°åè®®NSCoping" class="headerlink" title="è‡ªå®šä¹‰å¯¹è±¡å®ç°åè®®NSCoping"></a>è‡ªå®šä¹‰å¯¹è±¡å®ç°åè®®NSCoping</h4><p>è‡ªå®šä¹‰çš„å¯¹è±¡ä½¿ç”¨copyå‘¢ï¼Ÿç³»ç»Ÿçš„å·²ç»å®ç°äº†ï¼Œæˆ‘ä»¬è‡ªå®šä¹‰çš„éœ€è¦è‡ªå·±å»å®ç°ï¼Œè‡ªå®šä¹‰çš„ç±»ç»§æ‰¿<code>NSCopying</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@protocol NSCopying</span><br><span class="line"></span><br><span class="line">- (id)copyWithZone:(nullable NSZone *)zone;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@protocol NSMutableCopying</span><br><span class="line"></span><br><span class="line">- (id)mutableCopyWithZone:(nullable NSZone *)zone;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>çœ‹åˆ°<code>NSCopying</code>å’Œ<code>NSMutableCopying</code>è¿™ä¸¤ä¸ªåè®®ï¼Œå¯¹äºè‡ªå®šä¹‰çš„å¯å˜å¯¹è±¡ï¼Œå…¶å®æ²¡ä»€ä¹ˆæ„ä¹‰ï¼Œæœ¬æ¥è‡ªå®šä¹‰çš„å¯¹è±¡çš„å±æ€§ï¼ŒåŸºæœ¬éƒ½æ˜¯å¯å˜çš„ï¼Œæ‰€ä»¥åªéœ€è¦å®ç°<code>NSCopying</code>åè®®å°±å¥½äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,assign) int age;</span><br><span class="line">@property (nonatomic,assign) int level;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface FYPerson()&lt;NSCopying&gt;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYPerson</span><br><span class="line">-(instancetype)copyWithZone:(NSZone *)zone&#123;</span><br><span class="line">	FYPerson *p=[[FYPerson alloc]init];</span><br><span class="line">	p.age = self.age;</span><br><span class="line">	p.level = self.level;</span><br><span class="line">	return p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">FYPerson *p =[[FYPerson alloc]init];</span><br><span class="line">p.age = 10;</span><br><span class="line">p.level = 11;</span><br><span class="line">FYPerson *p2 =[p copy];</span><br><span class="line">NSLog(@&quot;%d %d&quot;,p2.age,p2.level);</span><br><span class="line">//log</span><br><span class="line">10 11</span><br></pre></td></tr></table></figure>
<p>è‡ªå·±å®ç°äº†<code>NSCoping</code>åè®®å®Œæˆäº†å¯¹å¯¹è±¡çš„æ·±æ‹·è´ï¼ŒæˆåŠŸå°†å¯¹è±¡çš„å±æ€§å¤åˆ¶è¿‡å»äº†ï¼Œå½“å±æ€§å¤šäº†æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥åˆ©ç”¨<code>runtime</code>å®ç°ä¸€ä¸ªä¸€åŠ³æ°¸é€¸çš„æ–¹æ¡ˆã€‚</p>
<p>ç„¶åå°†<code>copyWithZone</code>åˆ©ç”¨<code>runtime</code>éå†æ‰€æœ‰çš„æˆå‘˜å˜é‡ï¼Œå°†æ‰€æœ‰çš„å˜é‡éƒ½èµ‹å€¼ï¼Œå½“å˜é‡å¤šçš„æ—¶å€™ï¼Œè¿™é‡Œä¹Ÿä¸ç”¨ä¿®æ”¹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@implementation NSObject (add)</span><br><span class="line">-(instancetype)copyWithZone:(NSZone *)zone&#123;</span><br><span class="line">    Class cls = [self class];</span><br><span class="line">    NSObject * p=[cls new];</span><br><span class="line">    //æˆå‘˜å˜é‡ä¸ªæ•°</span><br><span class="line">    unsigned int count;</span><br><span class="line">    //èµ‹å€¼æˆå‘˜å˜é‡æ•°ç»„</span><br><span class="line">    Ivar *ivars = class_copyIvarList(self.class, &amp;count);</span><br><span class="line">    //éå†æ•°ç»„</span><br><span class="line">    for (int i = 0; i &lt; count; i ++) &#123;</span><br><span class="line">        Ivar var = ivars[i];</span><br><span class="line">        //è·å–æˆå‘˜å˜é‡åå­—</span><br><span class="line">        const char * name = ivar_getName(var);</span><br><span class="line">        if (name != nil) &#123;</span><br><span class="line">            NSString *v = [NSString stringWithUTF8String:name];</span><br><span class="line">            id value = [self valueForKey:v];</span><br><span class="line">            //ç»™æ–°çš„å¯¹è±¡èµ‹å€¼</span><br><span class="line">            if (value != NULL) &#123;</span><br><span class="line">                [p setValue:value forKey:v];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    free(ivars);</span><br><span class="line">    return p;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">FYPerson *p =[[FYPerson alloc]init];</span><br><span class="line">p.age = 10;</span><br><span class="line">p.level = 11;</span><br><span class="line">p.name = @&quot;xiaowang&quot;;</span><br><span class="line">FYPerson *p2 =[p copy];</span><br><span class="line">NSLog(@&quot;%d %d %@&quot;,p2.age,p2.level,p2.name);</span><br><span class="line">		</span><br><span class="line">//log</span><br><span class="line">10 </span><br><span class="line">11 </span><br><span class="line">xiaowang</span><br></pre></td></tr></table></figure>
<p>æ ¹æ®å¯åŠ¨é¡ºåºï¼Œç±»åˆ«çš„æ–¹æ³•åœ¨ç±»çš„æ–¹æ³•åŠ è½½åè¾¹ï¼Œç±»åˆ«ä¸­çš„æ–¹æ³•ä¼šè¦†ç›–ç±»çš„æ–¹æ³•ï¼Œæ‰€ä»¥<br>åœ¨åŸºç±»<code>NSObject</code>åœ¨ç±»åˆ«ä¸­é‡å†™äº†<code>-(instancetype)copyWithZone:(NSZone *)zone</code>æ–¹æ³•ï¼Œå­ç±»å°±ä¸ç”¨é‡å†™äº†ã€‚è¾¾æˆäº†ä¸€åŠ³æ°¸é€¸çš„æ–¹æ¡ˆã€‚</p>
<h3 id="å¼•ç”¨è®¡æ•°åŸç†"><a href="#å¼•ç”¨è®¡æ•°åŸç†" class="headerlink" title="å¼•ç”¨è®¡æ•°åŸç†"></a>å¼•ç”¨è®¡æ•°åŸç†</h3><p>æ‘˜è‡ª<a href="https://baike.baidu.com/item/%E5%BC%95%E7%94%A8%E8%AE%A1%E6%95%B0/10205507?fr=aladdin" target="_blank" rel="noopener">ç™¾åº¦ç™¾ç§‘</a></p>
<blockquote>
<p>å¼•ç”¨è®¡æ•°æ˜¯è®¡ç®—æœºç¼–ç¨‹è¯­è¨€ä¸­çš„ä¸€ç§å†…å­˜ç®¡ç†æŠ€æœ¯ï¼Œæ˜¯æŒ‡å°†èµ„æºï¼ˆå¯ä»¥æ˜¯å¯¹è±¡ã€å†…å­˜æˆ–ç£ç›˜ç©ºé—´ç­‰ç­‰ï¼‰çš„è¢«å¼•ç”¨æ¬¡æ•°ä¿å­˜èµ·æ¥ï¼Œå½“è¢«å¼•ç”¨æ¬¡æ•°å˜ä¸ºé›¶æ—¶å°±å°†å…¶é‡Šæ”¾çš„è¿‡ç¨‹ã€‚ä½¿ç”¨å¼•ç”¨è®¡æ•°æŠ€æœ¯å¯ä»¥å®ç°è‡ªåŠ¨èµ„æºç®¡ç†çš„ç›®çš„ã€‚åŒæ—¶å¼•ç”¨è®¡æ•°è¿˜å¯ä»¥æŒ‡ä½¿ç”¨å¼•ç”¨è®¡æ•°æŠ€æœ¯å›æ”¶æœªä½¿ç”¨èµ„æºçš„åƒåœ¾å›æ”¶ç®—æ³•</p>
</blockquote>
<p>åœ¨iOSä¸­ï¼Œä½¿ç”¨å¼•ç”¨è®¡æ•°æ¥ç®¡ç†<code>OC</code>å¯¹è±¡å†…å­˜ï¼Œä¸€ä¸ªæ–°åˆ›å»ºçš„OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°é»˜è®¤æ˜¯1ï¼Œå½“å¼•ç”¨è®¡æ•°å‡ä¸º0ï¼Œ<code>OC</code>å¯¹è±¡å°±ä¼šé”€æ¯ï¼Œé‡Šæ”¾å…¶ä»–å†…å­˜ç©ºé—´ï¼Œè°ƒç”¨<code>retain</code>ä¼šè®©<code>OC</code>å¯¹è±¡çš„å¼•ç”¨è®¡æ•°+1ï¼Œè°ƒç”¨<code>release</code>ä¼šè®©<code>OC</code>å¯¹è±¡çš„å¼•ç”¨è®¡æ•°-1ã€‚<br>å½“è°ƒç”¨<code>allocã€newã€copyã€mutableCopy</code>æ–¹æ³•è¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨ä¸éœ€è¦è¿™ä¸ªå¯¹è±¡æ—¶ï¼Œè¦è°ƒç”¨<code>release</code>æˆ–è€…<code>autorelease</code>æ¥é‡Šæ”¾å®ƒï¼Œæƒ³æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼Œå°±è®©ä»–çš„å¼•ç”¨è®¡æ•°+1ï¼Œä¸å†æ‹¥æœ‰æŸä¸ªå¯¹è±¡ï¼Œå°±è®©ä»–å¼•ç”¨è®¡æ•°-1.</p>
<p>åœ¨MRCä¸­æˆ‘ä»¬ç»å¸¸éƒ½æ˜¯è¿™æ ·å­ä½¿ç”¨çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">FYPerson *p=[[FYPerson alloc]init];</span><br><span class="line">FYPerson *p2 =[p retain];</span><br><span class="line">//code here</span><br><span class="line">[p release];</span><br><span class="line">[p2 release];</span><br></pre></td></tr></table></figure>
<p>ä½†æ˜¯åœ¨ARCä¸­æ˜¯ç³»ç»Ÿå¸®æˆ‘ä»¬åšäº†è‡ªåŠ¨å¼•ç”¨è®¡æ•°ï¼Œä¸ç”¨å¼€å‘è€…åšå¾ˆå¤šç¹ççš„äº‹æƒ…äº†ï¼Œæˆ‘ä»¬å°±æ¢ç©¶ä¸‹å¼•ç”¨è®¡æ•°æ˜¯æ€ä¹ˆå®ç°çš„ã€‚</p>
<p>å¼•ç”¨è®¡æ•°å­˜å‚¨åœ¨<code>isa</code>æŒ‡é’ˆä¸­çš„<code>extra_rc</code>ï¼Œå­˜å‚¨å€¼å¤§äºè¿™ä¸ªèŒƒå›´çš„æ—¶å€™ï¼Œåˆ™<code>bits.has_sidetable_rc=1</code>ç„¶åå°†å‰©ä½™çš„<code>RetainCount</code>å­˜å‚¨åˆ°å…¨å±€çš„<code>table</code>ï¼Œ<code>key</code>æ˜¯<code>self</code>å¯¹åº”çš„å€¼ã€‚</p>
<p><code>Retain</code>çš„<code>runtime</code>æºç æŸ¥æ‰¾å‡½æ•°è·¯å¾„<code>objc_object::retain()</code>-&gt;<code>objc_object::rootRetain()</code>-&gt;<code>objc_object::rootRetain(bool, bool)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">//å¤§æ¦‚ç‡x==1 æé«˜è¯»å–æŒ‡ä»¤çš„æ•ˆç‡</span><br><span class="line">#define fastpath(x) (__builtin_expect(bool(x), 1))</span><br><span class="line">//å¤§æ¦‚ç‡x==0 æé«˜è¯»å–æŒ‡ä»¤çš„æ•ˆç‡</span><br><span class="line">#define slowpath(x) (__builtin_expect(bool(x), 0))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//å¼•ç”¨è®¡æ•°+1</span><br><span class="line">//tryRetain å°è¯•+1</span><br><span class="line">//handleOverflow æ˜¯å¦è¦†ç›–</span><br><span class="line">ALWAYS_INLINE id  objc_object::rootRetain(bool tryRetain, bool handleOverflow)</span><br><span class="line">&#123;</span><br><span class="line">	//ä¼˜åŒ–çš„æŒ‡é’ˆ è¿”å›this</span><br><span class="line">    if (isTaggedPointer()) return (id)this;</span><br><span class="line"></span><br><span class="line">    bool sideTableLocked = false;</span><br><span class="line">    bool transcribeToSideTable = false;</span><br><span class="line"></span><br><span class="line">    isa_t oldisa;</span><br><span class="line">    isa_t newisa;</span><br><span class="line"></span><br><span class="line">    do &#123;</span><br><span class="line">        transcribeToSideTable = false;</span><br><span class="line">		//old bits</span><br><span class="line">        oldisa = LoadExclusive(&amp;isa.bits);</span><br><span class="line">        newisa = oldisa;</span><br><span class="line">		//ä½¿ç”¨è”åˆä½“æŠ€æœ¯</span><br><span class="line">        if (slowpath(!newisa.nonpointer)) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);//nothing</span><br><span class="line">            if (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock();//è§£é”</span><br><span class="line">            if (tryRetain) return sidetable_tryRetain() ? (id)this : nil;</span><br><span class="line">			else return sidetable_retain();////sidetable å¼•ç”¨è®¡æ•°+1</span><br><span class="line">        &#125;</span><br><span class="line">        // don&apos;t check newisa.fast_rr; we already called any RR overrides</span><br><span class="line">		//ä¸å°è¯•retain å’Œ æ­£åœ¨é”€æ¯ ä»€ä¹ˆéƒ½ä¸åš è¿”å› nil</span><br><span class="line">        if (slowpath(tryRetain &amp;&amp; newisa.deallocating)) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            if (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock();</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">        uintptr_t carry;</span><br><span class="line">		//å¼•ç”¨è®¡æ•°+1 (bits.extra_rc++;)</span><br><span class="line">        newisa.bits = addc(newisa.bits, RC_ONE, 0, &amp;carry);  // extra_rc++</span><br><span class="line"></span><br><span class="line">        if (slowpath(carry)) &#123;</span><br><span class="line">            // newisa.extra_rc++ æº¢å‡ºå¤„ç†</span><br><span class="line">            if (!handleOverflow) &#123;</span><br><span class="line">                ClearExclusive(&amp;isa.bits);</span><br><span class="line">                return rootRetain_overflow(tryRetain);</span><br><span class="line">            &#125;</span><br><span class="line">			//ä¸ºæ‹·è´åˆ°side table åšå‡†å¤‡</span><br><span class="line">            if (!tryRetain &amp;&amp; !sideTableLocked) sidetable_lock();</span><br><span class="line">            sideTableLocked = true;</span><br><span class="line">            transcribeToSideTable = true;</span><br><span class="line">            newisa.extra_rc = RC_HALF;</span><br><span class="line">            newisa.has_sidetable_rc = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; while (slowpath(!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)));</span><br><span class="line"></span><br><span class="line">    if (slowpath(transcribeToSideTable)) &#123;</span><br><span class="line">		//æ‹·è´ å¹³å¤–ä¸€åŠçš„ å¼•ç”¨è®¡æ•°åˆ° side table</span><br><span class="line">        sidetable_addExtraRC_nolock(RC_HALF);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (slowpath(!tryRetain &amp;&amp; sideTableLocked)) sidetable_unlock();</span><br><span class="line">    return (id)this;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//sidetable å¼•ç”¨è®¡æ•°+1</span><br><span class="line">id objc_object::sidetable_retain()</span><br><span class="line">&#123;</span><br><span class="line">#if SUPPORT_NONPOINTER_ISA</span><br><span class="line">    assert(!isa.nonpointer);</span><br><span class="line">#endif</span><br><span class="line">	//å–å‡ºtable key=this</span><br><span class="line">    SideTable&amp; table = SideTables()[this];</span><br><span class="line">    </span><br><span class="line">    table.lock();</span><br><span class="line">    size_t&amp; refcntStorage = table.refcnts[this];</span><br><span class="line">    if (! (refcntStorage &amp; SIDE_TABLE_RC_PINNED)) &#123;</span><br><span class="line">        refcntStorage += SIDE_TABLE_RC_ONE;</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line"></span><br><span class="line">    return (id)this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¼•ç”¨è®¡æ•°+1ï¼Œåˆ¤æ–­äº†éœ€è¦æ˜¯æŒ‡é’ˆæ²¡æœ‰ä¼˜åŒ–å’Œ<code>isa</code>æœ‰æ²¡æœ‰ä½¿ç”¨çš„è”åˆä½“æŠ€æœ¯ï¼Œç„¶åå°†åˆ¤æ–­æ˜¯å¦æº¢å‡ºï¼Œæº¢å‡ºçš„è¯ï¼Œå°†<code>extra_rc</code>çš„å€¼å¤åˆ¶åˆ°<code>side table</code>ä¸­ï¼Œè®¾ç½®å‚æ•°<code>isa-&gt;has_sidetable_rc=true</code>ã€‚</p>
<p>å¼•ç”¨è®¡æ•°-1ï¼Œåœ¨<code>runtime</code>æºç ä¸­æŸ¥æ‰¾è·¯å¾„æ˜¯<code>objc_object::release()</code>-&gt;<code>objc_object::rootRelease()</code>-&gt;<code>objc_object::rootRelease(bool performDealloc, bool handleUnderflow)</code>,æˆ‘ä»¬è¿›å…¥åˆ°å‡½æ•°å†…éƒ¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">ALWAYS_INLINE bool  objc_object::rootRelease(bool performDealloc, bool handleUnderflow)</span><br><span class="line">&#123;</span><br><span class="line">    if (isTaggedPointer()) return false;//æŒ‡é’ˆä¼˜åŒ–çš„ä¸å­˜åœ¨è®¡æ•°å™¨</span><br><span class="line"></span><br><span class="line">    bool sideTableLocked = false;</span><br><span class="line"></span><br><span class="line">    isa_t oldisa;</span><br><span class="line">    isa_t newisa;</span><br><span class="line"></span><br><span class="line"> retry:</span><br><span class="line">    do &#123;//isa</span><br><span class="line">        oldisa = LoadExclusive(&amp;isa.bits);</span><br><span class="line">        newisa = oldisa;</span><br><span class="line">        if (slowpath(!newisa.nonpointer)) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            if (sideTableLocked) sidetable_unlock();</span><br><span class="line">			//side table -1</span><br><span class="line">            return sidetable_release(performDealloc);</span><br><span class="line">        &#125;</span><br><span class="line">        uintptr_t carry;</span><br><span class="line">        newisa.bits = subc(newisa.bits, RC_ONE, 0, &amp;carry);  // extra_rc--</span><br><span class="line">        if (slowpath(carry)) &#123;</span><br><span class="line">            // don&apos;t ClearExclusive()</span><br><span class="line">            goto underflow;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; while (slowpath(!StoreReleaseExclusive(&amp;isa.bits, </span><br><span class="line">                                             oldisa.bits, newisa.bits)));</span><br><span class="line"></span><br><span class="line">    if (slowpath(sideTableLocked)) sidetable_unlock();</span><br><span class="line">    return false;</span><br><span class="line"></span><br><span class="line"> underflow:</span><br><span class="line">    newisa = oldisa;</span><br><span class="line"></span><br><span class="line">    if (slowpath(newisa.has_sidetable_rc)) &#123;</span><br><span class="line">        if (!handleUnderflow) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            return rootRelease_underflow(performDealloc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        if (!sideTableLocked) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            sidetable_lock();</span><br><span class="line">            sideTableLocked = true;</span><br><span class="line">            goto retry;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		//side table å¼•ç”¨è®¡æ•°-1</span><br><span class="line">        size_t borrowed = sidetable_subExtraRC_nolock(RC_HALF);</span><br><span class="line"></span><br><span class="line">        if (borrowed &gt; 0) &#123;</span><br><span class="line">            newisa.extra_rc = borrowed - 1;  // redo the original decrement too</span><br><span class="line">            bool stored = StoreReleaseExclusive(&amp;isa.bits, </span><br><span class="line">                                                oldisa.bits, newisa.bits);</span><br><span class="line">            if (!stored) &#123;</span><br><span class="line">                isa_t oldisa2 = LoadExclusive(&amp;isa.bits);</span><br><span class="line">                isa_t newisa2 = oldisa2;</span><br><span class="line">                if (newisa2.nonpointer) &#123;</span><br><span class="line">                    uintptr_t overflow;</span><br><span class="line">                    newisa2.bits = </span><br><span class="line">                        addc(newisa2.bits, RC_ONE * (borrowed-1), 0, &amp;overflow);</span><br><span class="line">                    if (!overflow) &#123;</span><br><span class="line">                        stored = StoreReleaseExclusive(&amp;isa.bits, oldisa2.bits, </span><br><span class="line">                                                       newisa2.bits);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (!stored) &#123;</span><br><span class="line">                // Inline update failed.</span><br><span class="line">                // Put the retains back in the side table.</span><br><span class="line">                sidetable_addExtraRC_nolock(borrowed);</span><br><span class="line">                goto retry;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            sidetable_unlock();</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // Side table is empty after all. Fall-through to the dealloc path.</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	//çœŸæ­£çš„é”€æ¯</span><br><span class="line"></span><br><span class="line">    if (slowpath(newisa.deallocating)) &#123;</span><br><span class="line">        ClearExclusive(&amp;isa.bits);</span><br><span class="line">        if (sideTableLocked) sidetable_unlock();</span><br><span class="line">        return overrelease_error();</span><br><span class="line">        // does not actually return</span><br><span class="line">    &#125;</span><br><span class="line">	//è®¾ç½®æ­£åœ¨é”€æ¯</span><br><span class="line">    newisa.deallocating = true;</span><br><span class="line">    if (!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)) goto retry;</span><br><span class="line"></span><br><span class="line">    if (slowpath(sideTableLocked)) sidetable_unlock();</span><br><span class="line"></span><br><span class="line">    __sync_synchronize();</span><br><span class="line">    if (performDealloc) &#123;</span><br><span class="line">		//é”€æ¯</span><br><span class="line">        ((void(*)(objc_object *, SEL))objc_msgSend)(this, SEL_dealloc);</span><br><span class="line">    &#125;</span><br><span class="line">    return true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹äº†ä¸Šè¾¹äº†è§£åˆ°å¼•ç”¨è®¡æ•°åˆ†ä¸¤éƒ¨åˆ†ï¼Œ<code>extra_rc</code>å’Œ<code>side table</code>ï¼Œæ¢ç©¶ä¸€ä¸‹<br><code>rootRetainCount()</code>çš„å®ç°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">inline uintptr_t  objc_object::rootRetainCount()</span><br><span class="line">&#123;</span><br><span class="line">	//ä¼˜åŒ–æŒ‡é’ˆ ç›´æ¥è¿”å›</span><br><span class="line">    if (isTaggedPointer()) return (uintptr_t)this;</span><br><span class="line">//æ²¡ä¼˜åŒ–åˆ™ åˆ°SideTable è¯»å–</span><br><span class="line">    sidetable_lock();</span><br><span class="line">	//isaæŒ‡é’ˆ</span><br><span class="line">    isa_t bits = LoadExclusive(&amp;isa.bits);</span><br><span class="line">    ClearExclusive(&amp;isa.bits);//å•¥éƒ½æ²¡åš</span><br><span class="line">    if (bits.nonpointer) &#123;//ä½¿ç”¨è”åˆä½“å­˜å‚¨æ›´å¤šçš„æ•°æ® </span><br><span class="line">        uintptr_t rc = 1 + bits.extra_rc;//è®¡æ•°æ•°é‡</span><br><span class="line">        if (bits.has_sidetable_rc) &#123;//å½“å¤§è¿‡äº è”åˆä½“å­˜å‚¨çš„å€¼ åˆ™å¦å¤–åœ¨SideTableè¯»å–æ•°æ®</span><br><span class="line">	//è¯»å–tableçš„å€¼ ç›¸åŠ </span><br><span class="line">            rc += sidetable_getExtraRC_nolock();</span><br><span class="line">        &#125;</span><br><span class="line">        sidetable_unlock();</span><br><span class="line">        return rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sidetable_unlock();</span><br><span class="line">	//åœ¨sidetable ä¸­å­˜å‚¨çš„count</span><br><span class="line">    return sidetable_retainCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“æ˜¯å­˜å‚¨å°æ•°æ®çš„æ—¶å€™ï¼ŒæŒ‡é’ˆä¼˜åŒ–ï¼Œåˆ™ç›´æ¥è¿”å›<code>self</code>,å¤§æ•°æ®çš„è¯ï¼Œåˆ™<code>table</code>åŠ é”ï¼Œ<br><code>class</code>ä¼˜åŒ–çš„ä¹‹å<a href="https://juejin.im/post/5d2bcf3df265da1b67213d69" target="_blank" rel="noopener">ä½¿ç”¨è”åˆä½“å­˜å‚¨æ›´å¤šçš„æ•°æ®</a>,<code>class</code>æ²¡æœ‰ä¼˜åŒ–åˆ™ç›´æ¥å»<code>sizedable</code>è¯»å–æ•°æ®ã€‚<br>ä¼˜åŒ–äº†åˆ™åœ¨<code>sidetable_getExtraRC_nolock()</code>è¯»å–æ•°æ®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//ä½¿ç”¨è”åˆä½“</span><br><span class="line">size_t  objc_object::sidetable_getExtraRC_nolock()</span><br><span class="line">&#123;</span><br><span class="line">	//ä¸æ˜¯è”åˆä½“æŠ€æœ¯ åˆ™æŠ¥é”™</span><br><span class="line">    assert(isa.nonpointer);</span><br><span class="line">	//keyæ˜¯ thisï¼Œå­˜å‚¨äº†æ¯ä¸ªå¯¹è±¡çš„table</span><br><span class="line">    SideTable&amp; table = SideTables()[this];</span><br><span class="line">	//æ‰¾åˆ° it å¦åˆ™è¿”å›0</span><br><span class="line">    RefcountMap::iterator it = table.refcnts.find(this);</span><br><span class="line">    if (it == table.refcnts.end()) return 0;</span><br><span class="line">    else return it-&gt;second &gt;&gt; SIDE_TABLE_RC_SHIFT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ²¡æœ‰ä¼˜åŒ–çš„æ˜¯ç›´æ¥è¯»å–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">//æœªä½¿ç”¨è”åˆä½“çš„æƒ…å†µï¼Œ</span><br><span class="line">uintptr_t objc_object::sidetable_retainCount()</span><br><span class="line">&#123;//æ²¡æœ‰è”åˆä½“å­˜å‚¨çš„è®¡æ•°å™¨åˆ™ç›´æ¥åœ¨tableä¸­å–å‡ºæ¥</span><br><span class="line">    SideTable&amp; table = SideTables()[this];</span><br><span class="line">    size_t refcnt_result = 1;</span><br><span class="line">    table.lock();</span><br><span class="line">    RefcountMap::iterator it = table.refcnts.find(this);</span><br><span class="line">    if (it != table.refcnts.end()) &#123;</span><br><span class="line">        refcnt_result += it-&gt;second &gt;&gt; SIDE_TABLE_RC_SHIFT;</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">    return refcnt_result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="weakæŒ‡é’ˆåŸç†"><a href="#weakæŒ‡é’ˆåŸç†" class="headerlink" title="weakæŒ‡é’ˆåŸç†"></a>weakæŒ‡é’ˆåŸç†</h3><p>å½“ä¸€ä¸ªå¯¹è±¡è¦é”€æ¯çš„æ—¶å€™ä¼šè°ƒç”¨<code>dealloc</code>,è°ƒç”¨è½¨è¿¹æ˜¯<code>dealloc</code>-&gt;<code>_objc_rootDealloc</code>-&gt;<code>object_dispose</code>-&gt;<code>objc_destructInstance</code>-&gt;<code>free</code><br>æˆ‘ä»¬è¿›å…¥åˆ°<code>objc_destructInstance</code>å†…éƒ¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">void *objc_destructInstance(id obj) </span><br><span class="line">&#123;</span><br><span class="line">    if (obj) &#123;</span><br><span class="line">        // Read all of the flags at once for performance.</span><br><span class="line">		//c++ææ„å‡½æ•°</span><br><span class="line">        bool cxx = obj-&gt;hasCxxDtor();</span><br><span class="line">		//å…³è”å‡½æ•°</span><br><span class="line">        bool assoc = obj-&gt;hasAssociatedObjects();</span><br><span class="line"></span><br><span class="line">        // This order is important.</span><br><span class="line">        if (cxx) object_cxxDestruct(obj);</span><br><span class="line">        if (assoc) _object_remove_assocations(obj);</span><br><span class="line">        obj-&gt;clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é”€æ¯äº†c++ææ„å‡½æ•°å’Œå…³è”å‡½æ•°æœ€åè¿›å…¥åˆ°<code>clearDeallocating</code>ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°å‡½æ•°å†…éƒ¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//æ­£åœ¨æ¸…é™¤side table å’Œweakly referenced</span><br><span class="line">inline void </span><br><span class="line">objc_object::clearDeallocating()</span><br><span class="line">&#123;</span><br><span class="line">    if (slowpath(!isa.nonpointer)) &#123;</span><br><span class="line">        // Slow path for raw pointer isa.</span><br><span class="line">		//é‡Šæ”¾weak</span><br><span class="line">        sidetable_clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line">    else if (slowpath(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123;</span><br><span class="line">        // Slow path for non-pointer isa with weak refs and/or side table data.</span><br><span class="line">		//é‡Šæ”¾weak å’Œå¼•ç”¨è®¡æ•°</span><br><span class="line">        clearDeallocating_slow();</span><br><span class="line">    &#125;</span><br><span class="line">    assert(!sidetable_present());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆè°ƒç”¨äº†<code>sidetable_clearDeallocating</code>å’Œ<code>clearDeallocating_slow</code>å®ç°é”€æ¯<code>weak</code>å’Œå¼•ç”¨è®¡æ•°<code>side table</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">NEVER_INLINE void</span><br><span class="line">objc_object::clearDeallocating_slow()</span><br><span class="line">&#123;</span><br><span class="line">    assert(isa.nonpointer  &amp;&amp;  (isa.weakly_referenced || isa.has_sidetable_rc));</span><br><span class="line"></span><br><span class="line">    SideTable&amp; table = SideTables()[this];</span><br><span class="line">    table.lock();</span><br><span class="line">	//æ¸…é™¤weak</span><br><span class="line">    if (isa.weakly_referenced) &#123;</span><br><span class="line">		//table.weak_table å¼±å¼•ç”¨è¡¨</span><br><span class="line">        weak_clear_no_lock(&amp;table.weak_table, (id)this);</span><br><span class="line">    &#125;</span><br><span class="line">	//å¼•ç”¨è®¡æ•°</span><br><span class="line">    if (isa.has_sidetable_rc) &#123;</span><br><span class="line">		//æ“¦é™¤ this</span><br><span class="line">        table.refcnts.erase(this);</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®<code>weak</code>ä¿®é¥°çš„å¯¹è±¡ä¼šå­˜å‚¨åœ¨å…¨å±€çš„<code>SideTable</code>ï¼Œå½“å¯¹è±¡é”€æ¯çš„æ—¶å€™ä¼šåœ¨<code>SideTable</code>è¿›è¡ŒæŸ¥æ‰¾ï¼Œæ—¶å€™æœ‰<code>weak</code>å¯¹è±¡ï¼Œæœ‰çš„è¯åˆ™è¿›è¡Œé”€æ¯ã€‚</p>
<h3 id="Autoreleasepool-åŸç†"><a href="#Autoreleasepool-åŸç†" class="headerlink" title="Autoreleasepool åŸç†"></a>Autoreleasepool åŸç†</h3><p><code>Autoreleasepool</code>ä¸­æ–‡åè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œé‡Œè¾¹è£…ç€ä¸€äº›å˜é‡ï¼Œå½“æ± å­ä¸éœ€è¦ï¼ˆé”€æ¯ï¼‰çš„æ—¶å€™ï¼Œ<code>release</code>é‡Œè¾¹çš„å¯¹è±¡(å¼•ç”¨è®¡æ•°-1)ã€‚<br>æˆ‘ä»¬å°†ä¸‹è¾¹çš„ä»£ç è½¬åŒ–æˆc++</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">@autoreleasepool &#123;</span><br><span class="line">		FYPerson *p = [[FYPerson alloc]init];</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -f  main.m</code><br>è½¬æˆc++</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/* @autoreleasepool */ &#123;</span><br><span class="line"> __AtAutoreleasePool __autoreleasepool;</span><br><span class="line"> FYPerson *p = ((FYPerson *(*)(id, SEL))(void *)objc_msgSend)((id)((FYPerson *(*)(id, SEL))(void *)objc_msgSend)((id)objc_getClass(&quot;FYPerson&quot;), sel_registerName(&quot;alloc&quot;)), sel_registerName(&quot;init&quot;));</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>__AtAutoreleasePool</code>æ˜¯ä¸€ä¸ªç»“æ„ä½“</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">struct __AtAutoreleasePool &#123;</span><br><span class="line">	__AtAutoreleasePool() &#123;//æ„é€ å‡½æ•° ç”Ÿæˆç»“æ„ä½“å˜é‡çš„æ—¶å€™è°ƒç”¨</span><br><span class="line">		atautoreleasepoolobj = objc_autoreleasePoolPush();</span><br><span class="line">	&#125;</span><br><span class="line">	~__AtAutoreleasePool() &#123;//ææ„å‡½æ•° é”€æ¯çš„æ—¶å€™è°ƒç”¨</span><br><span class="line">		objc_autoreleasePoolPop(atautoreleasepoolobj);</span><br><span class="line">	&#125;</span><br><span class="line">	void * atautoreleasepoolobj;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç„¶åå°†ä¸Šè¾¹çš„ä»£ç å’Œc++æ•´åˆåˆ°ä¸€èµ·å°±æ˜¯è¿™æ ·å­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    __AtAutoreleasePool pool = objc_autoreleasePoolPush();</span><br><span class="line">    FYPerson *p = [[FYPerson alloc]init];</span><br><span class="line">    objc_autoreleasePoolPop(pool)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨è¿›å…¥å¤§æ‹¬å·ç”Ÿæˆä¸€ä¸ªé‡Šæ”¾æ± ï¼Œç¦»å¼€å¤§æ‹¬å·åˆ™é‡Šæ”¾é‡Šæ”¾æ± ï¼Œæˆ‘ä»¬å†çœ‹ä¸€ä¸‹é‡Šæ”¾å‡½æ•°æ˜¯æ€ä¹ˆå·¥ä½œçš„,åœ¨<code>runtime</code>æºç ä¸­<code>NSObject.mm 1848 è¡Œ</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">void objc_autoreleasePoolPop(void *ctxt)</span><br><span class="line">&#123;</span><br><span class="line">    AutoreleasePoolPage::pop(ctxt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>pop</code>å®ç°äº†<code>AutoreleasePoolPage</code>ä¸­çš„å¯¹è±¡çš„é‡Šæ”¾ï¼Œæƒ³äº†è§£æ€ä¹ˆé‡Šæ”¾çš„å¯ä»¥ç ”ç©¶ä¸‹æºç <code>runtime NSObject.mm 1063è¡Œ</code>ã€‚</p>
<p>å…¶å®<code>AutoreleasePool</code>æ˜¯<code>AutoreleasePoolPage</code>æ¥ç®¡ç†çš„ï¼Œ<code>AutoreleasePoolpage</code>ç»“æ„å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">class AutoreleasePoolPage &#123;</span><br><span class="line">    magic_t const magic;</span><br><span class="line">    id *next;//ä¸‹ä¸€ä¸ªå­˜æ”¾aotoreleasså¯¹è±¡çš„åœ°å€</span><br><span class="line">    pthread_t const thread;//çº¿ç¨‹</span><br><span class="line">    AutoreleasePoolPage * const parent; //çˆ¶èŠ‚ç‚¹</span><br><span class="line">    AutoreleasePoolPage *child;//å­èŠ‚ç‚¹</span><br><span class="line">    uint32_t const depth;//æ·±åº¦</span><br><span class="line">    uint32_t hiwat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>AutoreleasePoolPage</code>åœ¨åˆå§‹åŒ–åœ¨<code>autoreleaseNewPage</code>ç”³è¯·äº†<code>4096</code>å­—èŠ‚é™¤äº†è‡ªå·±å˜é‡çš„ç©ºé—´ï¼Œ<code>AutoreleasePoolPage</code>æ˜¯ä¸€ä¸ª<code>C++</code>å®ç°çš„ç±»</p>
<ul>
<li>å†…éƒ¨ä½¿ç”¨<code>id *next</code>æŒ‡å‘äº†æ ˆé¡¶æœ€æ–°<code>add</code>è¿›æ¥çš„<code>autorelease</code>å¯¹è±¡çš„ä¸‹ä¸€ä¸ªä½ç½®</li>
<li>ä¸€ä¸ª<code>AutoreleasePoolPage</code>çš„ç©ºé—´è¢«å æ»¡æ—¶ï¼Œä¼šæ–°å»ºä¸€ä¸ª<code>AutoreleasePoolPage</code>å¯¹è±¡ï¼Œè¿æ¥é“¾è¡¨ï¼Œåæ¥çš„<code>autorelease</code>å¯¹è±¡åœ¨æ–°çš„<code>page</code>åŠ å…¥</li>
<li><code>AutoreleasePoolPage</code>æ¯ä¸ªå¯¹è±¡ä¼šå¼€è¾Ÿ4096å­—èŠ‚å†…å­˜ï¼ˆä¹Ÿå°±æ˜¯è™šæ‹Ÿå†…å­˜ä¸€é¡µçš„å¤§å°ï¼‰ï¼Œé™¤äº†ä¸Šé¢çš„å®ä¾‹å˜é‡æ‰€å ç©ºé—´ï¼Œå‰©ä¸‹çš„ç©ºé—´å…¨éƒ¨ç”¨æ¥å‚¨å­˜<code>autorelease</code>å¯¹è±¡çš„åœ°å€</li>
<li><code>AutoreleasePool</code>æ˜¯æŒ‰çº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„ï¼ˆç»“æ„ä¸­çš„<code>thread</code>æŒ‡é’ˆæŒ‡å‘å½“å‰çº¿ç¨‹ï¼‰</li>
<li><code>AutoreleasePool</code>å¹¶æ²¡æœ‰å•ç‹¬çš„ç»“æ„ï¼Œè€Œæ˜¯ç”±è‹¥å¹²ä¸ª<code>AutoreleasePoolPage</code>ä»¥åŒå‘é“¾è¡¨çš„å½¢å¼ç»„åˆè€Œæˆï¼ˆåˆ†åˆ«å¯¹åº”ç»“æ„ä¸­çš„<code>parent</code>æŒ‡é’ˆå’Œ<code>child</code>æŒ‡é’ˆï¼‰</li>
</ul>
<p>å…¶ä»–çš„éƒ½æ˜¯è‡ªåŠ¨é‡Šæ”¾æ± çš„å…¶ä»–å¯¹è±¡çš„æŒ‡é’ˆï¼Œæˆ‘ä»¬ä½¿ç”¨<code>_objc_autoreleasePoolPrint()</code>å¯ä»¥æŸ¥çœ‹é‡Šæ”¾æ± çš„å­˜å‚¨å†…å®¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">extern void _objc_autoreleasePoolPrint(void);</span><br><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">	@autoreleasepool &#123;//r1 = push()</span><br><span class="line"></span><br><span class="line">		FYPerson *p = [[FYPerson alloc]init];</span><br><span class="line">		_objc_autoreleasePoolPrint();</span><br><span class="line">		printf(&quot;\n--------------\n&quot;);</span><br><span class="line">	&#125;//pop(r1)</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">objc[23958]: ##############</span><br><span class="line">objc[23958]: AUTORELEASE POOLS for thread 0x1000aa5c0</span><br><span class="line">objc[23958]: 3 releases pending.</span><br><span class="line">objc[23958]: [0x101000000]  ................  PAGE  (hot) (cold)</span><br><span class="line">objc[23958]: [0x101000038]  ################  POOL 0x101000038</span><br><span class="line">objc[23958]: [0x101000040]       0x10050cfa0  FYPerson</span><br><span class="line">objc[23958]: [0x101000048]       0x10050cdb0  FYPerson</span><br><span class="line">objc[23958]: ##############</span><br><span class="line"></span><br><span class="line">--------------</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°å­˜å‚¨äº†<code>3 releases pending</code>ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œä¸”å¤§å°éƒ½8å­—èŠ‚ã€‚å†çœ‹ä¸€ä¸ªå¤æ‚çš„,è‡ªåŠ¨é‡Šæ”¾æ± åµŒå¥—è‡ªåŠ¨é‡Šæ”¾æ± </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, const char * argv[]) &#123;</span><br><span class="line">	@autoreleasepool &#123;//r1 = push()</span><br><span class="line"></span><br><span class="line">		FYPerson *p = [[[FYPerson alloc]init] autorelease];</span><br><span class="line">		FYPerson *p2 = [[[FYPerson alloc]init] autorelease];</span><br><span class="line">		@autoreleasepool &#123;//r1 = push()</span><br><span class="line">			</span><br><span class="line">			FYPerson *p3 = [[[FYPerson alloc]init] autorelease];</span><br><span class="line">			FYPerson *p4 = [[[FYPerson alloc]init] autorelease];</span><br><span class="line">			</span><br><span class="line">			_objc_autoreleasePoolPrint();</span><br><span class="line">			printf(&quot;\n--------------\n&quot;);</span><br><span class="line">		&#125;//pop(r1)</span><br><span class="line">	&#125;//pop(r1)</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">objc[24025]: ##############</span><br><span class="line">objc[24025]: AUTORELEASE POOLS for thread 0x1000aa5c0</span><br><span class="line">objc[24025]: 6 releases pending.</span><br><span class="line">objc[24025]: [0x100803000]  ................  PAGE  (hot) (cold)</span><br><span class="line">objc[24025]: [0x100803038]  ################  POOL 0x100803038</span><br><span class="line">objc[24025]: [0x100803040]       0x100721580  FYPerson</span><br><span class="line">objc[24025]: [0x100803048]       0x100721b10  FYPerson</span><br><span class="line">objc[24025]: [0x100803050]  ################  POOL 0x100803050</span><br><span class="line">objc[24025]: [0x100803058]       0x100721390  FYPerson</span><br><span class="line">objc[24025]: [0x100803060]       0x100717620  FYPerson</span><br><span class="line">objc[24025]: ##############</span><br></pre></td></tr></table></figure>
<p>çœ‹åˆ°äº†2ä¸ª<code>POOL</code>å’Œå››ä¸ª<code>FYPerson</code>å¯¹è±¡ï¼Œä¸€å…±æ˜¯6ä¸ªå¯¹è±¡ï¼Œå½“å‡ºäº†é‡Šæ”¾æ± ä¼šæ‰§è¡Œ<code>release</code>ã€‚</p>
<p>å½“æ— ä¼˜åŒ–çš„æŒ‡é’ˆè°ƒç”¨<code>autorelease</code>å…¶å®æ˜¯è°ƒç”¨äº†<code>AutoreleasePoolPage::autorelease((id)this)</code>-&gt;<code>autoreleaseFast(obj)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">static inline id *autoreleaseFast(id obj)</span><br><span class="line"> &#123;</span><br><span class="line">     AutoreleasePoolPage *page = hotPage();</span><br><span class="line">     //å½“æœ‰åˆ†é¡µè€Œä¸”åˆ†é¡µæ²¡æœ‰æ»¡å°±æ·»åŠ </span><br><span class="line">     if (page &amp;&amp; !page-&gt;full()) &#123;</span><br><span class="line">         return page-&gt;add(obj);</span><br><span class="line">     &#125; else if (page) &#123;</span><br><span class="line">         //æ»¡åˆ™æ–°å»ºä¸€ä¸ªpageè¿›è¡Œæ·»åŠ objå’Œè®¾ç½®hotpage</span><br><span class="line">         return autoreleaseFullPage(obj, page);</span><br><span class="line">     &#125; else &#123;</span><br><span class="line">         //æ²¡æœ‰pageåˆ™æ–°å»ºpageè¿›è¡Œæ·»åŠ </span><br><span class="line">         return autoreleaseNoPage(obj);</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>MRC</code>ä¸­<br><code>autorealease</code>ä¿®é¥°çš„æ˜¯çš„å¯¹è±¡åœ¨æ²¡æœ‰å¤–éƒ¨æ·»åŠ åˆ°è‡ªåŠ¨é‡Šæ”¾æ± çš„æ—¶å€™ï¼Œåœ¨<code>runloop</code>å¾ªç¯çš„æ—¶å€™ä¼šé”€æ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;</span><br><span class="line">    kCFRunLoopEntry = (1UL &lt;&lt; 0),</span><br><span class="line">    kCFRunLoopBeforeTimers = (1UL &lt;&lt; 1),</span><br><span class="line">    kCFRunLoopBeforeSources = (1UL &lt;&lt; 2),</span><br><span class="line">    kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5),</span><br><span class="line">    kCFRunLoopAfterWaiting = (1UL &lt;&lt; 6),</span><br><span class="line">    kCFRunLoopExit = (1UL &lt;&lt; 7),</span><br><span class="line">    kCFRunLoopAllActivities = 0x0FFFFFFFU</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//activities = 0xa0è½¬åŒ–æˆäºŒè¿›åˆ¶ 0b101 0000</span><br><span class="line">ç³»ç»Ÿç›‘å¬äº†mainRunloop çš„ kCFRunLoopBeforeWaiting å’ŒkCFRunLoopExitä¸¤ç§çŠ¶æ€æ¥æ›´æ–°autoreleaseçš„æ•°æ®</span><br><span class="line">//å›è°ƒå‡½æ•°æ˜¯ _wrapRunLoopWithAutoreleasePoolHandler</span><br><span class="line"></span><br><span class="line">&quot;&lt;CFRunLoopObserver 0x600002538320 [0x10ce45ae8]&gt;&#123;valid = Yes, activities = 0xa0, </span><br><span class="line">repeats = Yes, order = 2147483647, </span><br><span class="line">callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10f94087d), </span><br><span class="line">context = &lt;CFArray 0x600001a373f0 [0x10ce45ae8]&gt;&#123;type = mutable-small, count = 1, </span><br><span class="line">values = (\n\t0 : &lt;0x7fb6dc004058&gt;\n)&#125;&#125;&quot;</span><br></pre></td></tr></table></figure>
<p><code>activities = 0xa0</code>è½¬åŒ–æˆäºŒè¿›åˆ¶ <code>0b101 0000</code><br>ç³»ç»Ÿç›‘å¬äº†<code>mainRunloop</code> çš„ <code>kCFRunLoopBeforeWaiting</code> å’Œ<code>kCFRunLoopExit</code>ä¸¤ç§çŠ¶æ€æ¥æ›´æ–°<code>autorelease</code>çš„æ•°æ®<br>å›è°ƒå‡½æ•°æ˜¯ <code>_wrapRunLoopWithAutoreleasePoolHandler</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">void test()&#123;</span><br><span class="line">    FYPerson *p =[[FYPerson alloc]init];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>p</code>å¯¹è±¡åœ¨æŸæ¬¡å¾ªç¯ä¸­<code>push</code>ï¼Œåœ¨å¾ªç¯åˆ°<code>kCFRunLoopBeforeWaiting</code>è¿›è¡Œä¸€æ¬¡<code>pop</code>ï¼Œåˆ™ä¸Šæ¬¡å¾ªç¯çš„<code>autolease</code>å¯¹è±¡æ²¡æœ‰å…¶ä»–å¯¹è±¡<code>retain</code>çš„è¿›è¡Œé‡Šæ”¾ã€‚å¹¶ä¸æ˜¯å‡ºäº†<code>test()</code>ç«‹é©¬é‡Šæ”¾ã€‚</p>
<p>åœ¨ARCä¸­åˆ™æ‰§è¡Œå®Œæ¯•<code>test()</code>ä¼šé©¬ä¸Šé‡Šæ”¾ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li>å½“é‡å¤åˆ›å»ºå¯¹è±¡æˆ–è€…ä»£ç æ®µä¸å®¹æ˜“ç®¡ç†ç”Ÿå‘½å‘¨æœŸä½¿ç”¨è‡ªåŠ¨é‡Šæ”¾æ± æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</li>
<li>å­˜åœ¨åœ¨å…¨å±€çš„<code>SideTable</code>ä¸­weakä¿®é¥°çš„å¯¹è±¡ä¼šåœ¨<code>dealloc</code>å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­æ£€æµ‹æˆ–é”€æ¯è¯¥å¯¹è±¡ã€‚</li>
<li>å¯å˜å¯¹è±¡æ‹·è´ä¸€å®šä¼šç”Ÿæˆå·²æ–°å¯¹è±¡ï¼Œä¸å¯å˜å¯¹è±¡æ‹·è´æˆä¸å¯å˜å¯¹è±¡åˆ™æ˜¯å¼•ç”¨è®¡æ•°+1ã€‚</li>
<li>ä¼˜åŒ–çš„æŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆï¼Œä¸ç”¨èµ°<code>objc_msgSend()</code>çš„æ¶ˆæ¯æµç¨‹ä»è€Œæé«˜æ€§èƒ½ã€‚</li>
<li><code>CADisplayLink</code>å’Œ<code>Timer</code>æœ¬è´¨æ˜¯åŠ åˆ°<code>loop</code>å¾ªç¯å½“ä¸­ï¼Œä¾é™„äºå¾ªç¯ï¼Œæ²¡æœ‰<code>runloop</code>ï¼Œåˆ™ä¸èƒ½æ­£ç¡®æ‰§è¡Œï¼Œä½¿ç”¨<code>runloop</code>éœ€è¦æ³¨æ„å¾ªç¯å¼•ç”¨å’Œ<code>runloop</code>æ‰€åœ¨çš„çº¿ç¨‹çš„é‡Šæ”¾é—®é¢˜ã€‚</li>
</ul>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ul>
<li><a href="http://blog.sunnyxx.com/2014/10/15/behind-autorelease/" target="_blank" rel="noopener">é»‘å¹•èƒŒåçš„Autorelease
</a></li>
<li>å°ç å“¥è§†é¢‘</li>
<li>iOSå’ŒOSå¤šçº¿ç¨‹ä¸å†…å­˜ç®¡ç†</li>
<li>iOSå’ŒmacOSæ€§èƒ½ä¼˜åŒ–<h3 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h3></li>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="noopener">å­¦ä¹ èµ„æ–™ä¸‹è½½git</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="noopener">demo code git</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC/objc4-750" target="_blank" rel="noopener">runtimeå¯è¿è¡Œçš„æºç git</a></li>
</ul>
<hr>
<p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p>
<p>å¹¿å‘Šæ—¶é—´</p>
<p><img src="/images/0.png" alt></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOSåº•å±‚åŸç† å¤šçº¿ç¨‹ä¹‹å®‰å…¨é”ä»¥åŠå¸¸ç”¨çš„è¯»å†™é” --(11)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyongçš„æŠ€æœ¯åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/01/iOSåº•å±‚åŸç† å¤šçº¿ç¨‹ä¹‹å®‰å…¨é”ä»¥åŠå¸¸ç”¨çš„è¯»å†™é” --(11)/" class="post-title-link" itemprop="http://fgyong.cn/index.html">iOSåº•å±‚åŸç†  å¤šçº¿ç¨‹ä¹‹å®‰å…¨é”ä»¥åŠå¸¸ç”¨çš„è¯»å†™é” --(11)</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-01 11:21:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:21:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-09-03 16:24:13" itemprop="dateModified" datetime="2020-09-03T16:24:13+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>åªè¦æåˆ°äº†å¤šçº¿ç¨‹å°±åº”è¯¥æƒ³åˆ°çº¿ç¨‹å®‰å…¨ï¼Œé‚£ä¹ˆæ€ä¹ˆåšæ‰èƒ½åšåˆ°åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ä¿è¯å®‰å…¨å‘¢ï¼Ÿ<br>è¿™ç¯‡æ–‡ç« ä¸»è¦è®²è§£çº¿ç¨‹å®‰å…¨ã€‚</p>
<h3 id="çº¿ç¨‹å®‰å…¨"><a href="#çº¿ç¨‹å®‰å…¨" class="headerlink" title="çº¿ç¨‹å®‰å…¨"></a>çº¿ç¨‹å®‰å…¨</h3><p>çº¿ç¨‹å®‰å…¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ‘˜æŠ„ä¸€æ®µ<a href="https://baike.baidu.com/item/%E7%BA%BF%E7%A8%8B%E5%AE%89%E5%85%A8/9747724?fr=aladdin" target="_blank" rel="noopener">ç™¾åº¦ç™¾ç§‘</a>çš„ä¸€æ®µè¯</p>
<blockquote>
<p>çº¿ç¨‹å®‰å…¨æ˜¯å¤šçº¿ç¨‹ç¼–ç¨‹æ—¶çš„è®¡ç®—æœºç¨‹åºä»£ç ä¸­çš„ä¸€ä¸ªæ¦‚å¿µã€‚åœ¨æ‹¥æœ‰å…±äº«æ•°æ®çš„å¤šæ¡çº¿ç¨‹å¹¶è¡Œæ‰§è¡Œçš„ç¨‹åºä¸­ï¼Œçº¿ç¨‹å®‰å…¨çš„ä»£ç ä¼šé€šè¿‡åŒæ­¥æœºåˆ¶ä¿è¯å„ä¸ªçº¿ç¨‹éƒ½å¯ä»¥æ­£å¸¸ä¸”æ­£ç¡®çš„æ‰§è¡Œï¼Œä¸ä¼šå‡ºç°æ•°æ®æ±¡æŸ“ç­‰æ„å¤–æƒ…å†µã€‚</p>
</blockquote>
<h4 id="ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹å®‰å…¨"><a href="#ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹å®‰å…¨" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹å®‰å…¨"></a>ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹å®‰å…¨</h4><p>ATMè‚¯å®šç”¨è¿‡ï¼Œä½ è¦æ˜¯è¾¹å–é’±ï¼Œè¾¹å­˜é’±ï¼Œä¼šå‡ºé—®é¢˜å—ï¼Ÿå½“ä½ å–é’±çš„æ—¶å€™ï¼Œæ­£åœ¨å–ï¼Œç»“æœæœ‰äººæ±‡æ¬¾æ­£å¥½åˆ°è´¦ï¼Œæœ¬æ¥1000å—å–äº†100å‰©ä¸‹900ï¼Œç»“æœåˆ°è´¦200ï¼Œ1000+200=1200ï¼Œå› ä¸ºä½ å–çš„æ—¶å€™ï¼Œè¿˜æ²¡å–å®Œï¼Œæ±‡æ¬¾åˆ°è´¦äº†ç»“æœæ•°å­—åˆåŠ ä¸Šå»äº†ã€‚ä½ å–çš„é’±è·‘å“ªé‡Œå»äº†ï¼Œè¿™é‡Œå°±éœ€è¦å–é’±çš„æ—¶å€™ä¸èƒ½å†™å…¥æ•°æ®ï¼Œå°±æ˜¯æ±‡æ¬¾éœ€è¦åœ¨ä½ å–é’±å®Œæˆä¹‹åå†æ±‡æ¬¾ï¼Œä¸èƒ½åŒæ—¶è¿›è¡Œã€‚</p>
<p>é‚£ä¹ˆåœ¨iOSä¸­ï¼Œé”æ˜¯å¦‚ä½•ä½¿ç”¨çš„å‘¢ï¼Ÿ</p>
<h3 id="è‡ªæ—‹é”-OS-SPINLOCK"><a href="#è‡ªæ—‹é”-OS-SPINLOCK" class="headerlink" title="è‡ªæ—‹é” OS_SPINLOCK"></a>è‡ªæ—‹é” OS_SPINLOCK</h3><h4 id="ä»€ä¹ˆæ˜¯ä¼˜å…ˆçº§åè½¬"><a href="#ä»€ä¹ˆæ˜¯ä¼˜å…ˆçº§åè½¬" class="headerlink" title="ä»€ä¹ˆæ˜¯ä¼˜å…ˆçº§åè½¬"></a>ä»€ä¹ˆæ˜¯ä¼˜å…ˆçº§åè½¬</h4><p>ç®€å•ä»å­—é¢ä¸Šæ¥è¯´ï¼Œå°±æ˜¯ä½ä¼˜å…ˆçº§çš„ä»»åŠ¡å…ˆäºé«˜ä¼˜å…ˆçº§çš„ä»»åŠ¡æ‰§è¡Œäº†ï¼Œä¼˜å…ˆçº§æåäº†ã€‚é‚£åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ä¼šç”Ÿè¿™ç§æƒ…å†µå‘¢ï¼Ÿ</p>
<p>å‡è®¾ä¸‰ä¸ªä»»åŠ¡å‡†å¤‡æ‰§è¡Œï¼ŒAï¼ŒBï¼ŒCï¼Œä¼˜å…ˆçº§ä¾æ¬¡æ˜¯A&gt;B&gt;Cï¼›</p>
<p>é¦–å…ˆï¼šCå¤„äºè¿è¡ŒçŠ¶æ€ï¼Œè·å¾—CPUæ­£åœ¨æ‰§è¡Œï¼ŒåŒæ—¶å æœ‰äº†æŸç§èµ„æºï¼›</p>
<p>å…¶æ¬¡ï¼šAè¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œå› ä¸ºä¼˜å…ˆçº§æ¯”Cé«˜ï¼Œæ‰€ä»¥è·å¾—CPUï¼ŒAè½¬ä¸ºè¿è¡ŒçŠ¶æ€ï¼›Cè¿›å…¥å°±ç»ªçŠ¶æ€ï¼›</p>
<p>ç¬¬ä¸‰ï¼šæ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦ä½¿ç”¨èµ„æºï¼Œè€Œè¿™ä¸ªèµ„æºåˆè¢«ç­‰å¾…ä¸­çš„Cå æœ‰çš„ï¼Œäºæ˜¯Aè¿›å…¥é˜»å¡çŠ¶æ€ï¼ŒCå›åˆ°è¿è¡ŒçŠ¶æ€ï¼›</p>
<p>ç¬¬å››ï¼šæ­¤æ—¶Bè¿›å…¥å°±ç»ªçŠ¶æ€ï¼Œå› ä¸ºä¼˜å…ˆçº§æ¯”Cé«˜ï¼ŒBè·å¾—CPUï¼Œè¿›å…¥è¿è¡ŒçŠ¶æ€ï¼›Cåˆå›åˆ°å°±ç»ªçŠ¶æ€ï¼›</p>
<p>ç¬¬äº”ï¼šå¦‚æœè¿™æ—¶åˆå‡ºç°B2ï¼ŒB3ç­‰ä»»åŠ¡ï¼Œä»–ä»¬çš„ä¼˜å…ˆçº§æ¯”Cé«˜ï¼Œä½†æ¯”Aä½ï¼Œé‚£ä¹ˆå°±ä¼šå‡ºç°é«˜ä¼˜å…ˆçº§ä»»åŠ¡çš„Aä¸èƒ½æ‰§è¡Œï¼Œåè€Œä½ä¼˜å…ˆçº§çš„Bï¼ŒB2ï¼ŒB3ç­‰ä»»åŠ¡å¯ä»¥æ‰§è¡Œçš„å¥‡æ€ªç°è±¡ï¼Œè€Œè¿™å°±æ˜¯ä¼˜å…ˆåè½¬ã€‚</p>
<p><code>OS_SPINLOCK</code>å«åš<code>è‡ªæ—‹é”</code>ï¼Œç­‰å¾…é”çš„è¿›ç¨‹ä¼šå¤„äºå¿™ç­‰(busy-wait)çŠ¶æ€ï¼Œä¸€ç›´å ç”¨ç€CPUèµ„æºï¼Œç›®å‰å·²ç»ä¸å®‰å…¨ï¼Œå¯èƒ½ä¼šå‡ºç°ä¼˜å…ˆçº§ç¿»è½¬é—®é¢˜ã€‚</p>
<p><code>OS_SPINLOCK</code>API</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//åˆå§‹åŒ– ä¸€èˆ¬æ˜¯0ï¼Œæˆ–è€…ç›´æ¥æ•°å­—0ä¹Ÿæ˜¯okçš„ã€‚</span><br><span class="line">#define	OS_SPINLOCK_INIT    0</span><br><span class="line">//é”çš„åˆå§‹åŒ–</span><br><span class="line">OSSpinLock lock = OS_SPINLOCK_INIT;</span><br><span class="line">//å°è¯•åŠ é”</span><br><span class="line">bool ret = OSSpinLockTry(&amp;lock);</span><br><span class="line">//åŠ é”</span><br><span class="line">OSSpinLockLock(&amp;lock);</span><br><span class="line">//è§£é”</span><br><span class="line">OSSpinLockUnlock(&amp;lock);</span><br></pre></td></tr></table></figure>
<p><code>OSSpinLock</code>ç®€å•å®ç°12306å¦‚ä½•å–ç¥¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">//åŸºç±»å®ç°çš„å–ç¥¨</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">    NSInteger oldCount = self.ticketsCount;</span><br><span class="line">	if (isLog) &#123;</span><br><span class="line">		sleep(sleepTime);</span><br><span class="line">	&#125;</span><br><span class="line">    oldCount --;</span><br><span class="line">    self.ticketsCount = oldCount;</span><br><span class="line">	if (isLog) &#123;</span><br><span class="line">	printf(&quot;è¿˜å‰©% 2ld å¼ ç¥¨ - %s \n&quot;,(long)oldCount,[NSThread currentThread].description.UTF8String);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)ticketTest&#123;</span><br><span class="line">    self.ticketsCount = 10000;</span><br><span class="line">	NSInteger count = self.ticketsCount/3;</span><br><span class="line">	dispatch_queue_t queue = dispatch_queue_create(&quot;tick.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">    dispatch_async(queue, ^&#123;</span><br><span class="line">		if (time1 == 0) &#123;</span><br><span class="line">			time1 = CFAbsoluteTimeGetCurrent();</span><br><span class="line">		&#125;</span><br><span class="line">        for (int i = 0; i &lt; count; i ++) &#123;</span><br><span class="line">            [self __saleTicket];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    dispatch_async(queue, ^&#123;</span><br><span class="line">		if (time1 == 0) &#123;</span><br><span class="line">			time1 = CFAbsoluteTimeGetCurrent();</span><br><span class="line">		&#125;</span><br><span class="line">        for (int i = 0; i &lt; count; i ++) &#123;</span><br><span class="line">            [self __saleTicket];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    dispatch_async(queue, ^&#123;</span><br><span class="line">		if (time1 == 0) &#123;</span><br><span class="line">			time1 = CFAbsoluteTimeGetCurrent();</span><br><span class="line">		&#125;</span><br><span class="line">        for (int i = 0; i &lt; count; i ++) &#123;</span><br><span class="line">            [self __saleTicket];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">	dispatch_barrier_async(queue, ^&#123;</span><br><span class="line">		CFAbsoluteTime time = CFAbsoluteTimeGetCurrent() - time1;</span><br><span class="line">		printf(&quot;tick cost time:%f&quot;,time);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__getMonery&#123;</span><br><span class="line">    OSSpinLockLock(&amp;_moneyLock);</span><br><span class="line">    [super __getMonery];</span><br><span class="line">    OSSpinLockUnlock(&amp;_moneyLock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">    OSSpinLockLock(&amp;_moneyLock);</span><br><span class="line">    [super __saleTicket];</span><br><span class="line">    OSSpinLockUnlock(&amp;_moneyLock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saveMonery&#123;</span><br><span class="line">    OSSpinLockLock(&amp;_moneyLock);</span><br><span class="line">    [super __saveMonery];</span><br><span class="line">    OSSpinLockUnlock(&amp;_moneyLock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">    NSInteger oldCount = self.ticketsCount;</span><br><span class="line">    oldCount --;</span><br><span class="line">    self.ticketsCount = oldCount;</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x600003dc6080&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x600003dc6080&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x600003dc6080&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x600003df3a00&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x600003df3a00&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x600003df3a00&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x600003dc0000&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x600003dc0000&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x600003dc0000&gt;&#123;number = 5, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ±‡ç¼–åˆ†æ"><a href="#æ±‡ç¼–åˆ†æ" class="headerlink" title="æ±‡ç¼–åˆ†æ"></a>æ±‡ç¼–åˆ†æ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">for (NSInteger i = 0; i &lt; 5; i ++) &#123;</span><br><span class="line">	[[[NSThread alloc]initWithTarget:self selector:@selector(__saleTicket) object:nil] start];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ç„¶åå°†ç¡çœ æ—¶é—´è®¾ç½®ä¸º600sï¼Œæ–¹ä¾¿æˆ‘ä»¬è°ƒè¯•ã€‚</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">    OSSpinLockLock(&amp;_moneyLock);//æ­¤è¡Œæ‰“æ–­ç‚¹</span><br><span class="line">    [super __saleTicket];</span><br><span class="line">    OSSpinLockUnlock(&amp;_moneyLock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åˆ°äº†æ–­ç‚¹è¿›å…¥<code>Debug-&gt;Debug WorkFlow -&gt;Always Show Disassembly</code>ï¼Œåˆ°äº†æ±‡ç¼–ç•Œé¢ï¼Œåœ¨<code>LLDB</code>è¾“å…¥<code>stepi</code>ï¼Œç„¶åä¸€ç›´æŒ‰<code>enter</code>ï¼Œä¸€ç›´é‡å¤æ‰§è¡Œä¸Šå¥å‘½ä»¤ï¼Œç›´åˆ°è¿›å…¥äº†å¾ªç¯ï¼Œå°±æ˜¯ç±»ä¼¼ä¸‹åˆ—çš„ä¸‰è¡Œï¼Œå‘ç°<code>ja</code>è·³è½¬åˆ°åœ°å€<code>0x103f3d0f9</code>ï¼Œæ¯æ¬¡æ‰§è¡Œåˆ°<code>ja</code>æ€»æ˜¯è·³è½¬åˆ°<code>0x103f3d0f9</code>ï¼Œç›´åˆ°çº¿ç¨‹ç¡çœ ç»“æŸã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-&gt;  0x103f3d0f9 &lt;+241&gt;: movq   %rcx, (%r8)</span><br><span class="line">0x103f3d0fc &lt;+244&gt;: addq   $0x8, %r8</span><br><span class="line">0x103f3d100 &lt;+248&gt;: cmpq   %r8, %r9</span><br><span class="line">0x103f3d103 &lt;+251&gt;: ja     0x103f3d0f9</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥é€šè¿‡æ±‡ç¼–åˆ†æäº†è§£åˆ°<code>è‡ªæ—‹é”</code>æ˜¯çœŸçš„<code>å¿™ç­‰</code>ï¼Œé—²ä¸ä½çš„é”ã€‚</p>
<h3 id="os-unfair-lock"><a href="#os-unfair-lock" class="headerlink" title="os_unfair_lock"></a>os_unfair_lock</h3><p><code>os_unfair_lock</code>è¢«ç³»ç»Ÿå®šä¹‰ä¸ºä½çº§é”ï¼Œä¸€èˆ¬ä½çº§é”éƒ½æ˜¯é—²çš„æ—¶å€™åœ¨ç¡çœ ï¼Œåœ¨ç­‰å¾…çš„æ—¶å€™è¢«å†…æ ¸å”¤é†’ï¼Œç›®çš„æ˜¯æ›¿æ¢å·²å¼ƒç”¨çš„<code>OSSpinLock</code>ï¼Œè€Œä¸”å¿…é¡»ä½¿ç”¨<code>OS_UNFAIR_LOCK_INIT</code>æ¥åˆå§‹åŒ–ï¼ŒåŠ é”å’Œè§£é”å¿…é¡»åœ¨ç›¸åŒçš„çº¿ç¨‹ï¼Œå¦åˆ™ä¼šä¸­æ–­è¿›ç¨‹ï¼Œä½¿ç”¨è¯¥é”éœ€è¦ç³»ç»Ÿåœ¨<code>__IOS_AVAILABLE(10.0)</code>ï¼Œé”çš„æ•°æ®ç»“æ„æ˜¯ä¸€ä¸ªç»“æ„ä½“</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">OS_UNFAIR_LOCK_AVAILABILITY</span><br><span class="line">typedef struct os_unfair_lock_s &#123;</span><br><span class="line">	uint32_t _os_unfair_lock_opaque;</span><br><span class="line">&#125; os_unfair_lock, *os_unfair_lock_t;</span><br></pre></td></tr></table></figure>
<p><code>os_unfair_lock</code>ä½¿ç”¨éå¸¸ç®€å•ï¼Œåªéœ€è¦åœ¨ä»»åŠ¡å‰åŠ é”ï¼Œä»»åŠ¡åè§£é”å³å¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">@interface FYOSUnfairLockDemo : FYBaseDemo</span><br><span class="line">@property (nonatomic,assign) os_unfair_lock lock;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYOSUnfairLockDemo</span><br><span class="line">- (instancetype)init&#123;</span><br><span class="line">	if (self = [super init]) &#123;</span><br><span class="line">		self.lock = OS_UNFAIR_LOCK_INIT;</span><br><span class="line">	&#125;</span><br><span class="line">	return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)__saveMonery&#123;</span><br><span class="line">	os_unfair_lock_lock(&amp;_unlock);</span><br><span class="line">	[super __saveMonery];</span><br><span class="line">	os_unfair_lock_unlock(&amp;_unlock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__getMonery&#123;</span><br><span class="line">	os_unfair_lock_lock(&amp;_unlock);</span><br><span class="line">	[super __getMonery];</span><br><span class="line">	os_unfair_lock_unlock(&amp;_unlock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">	os_unfair_lock_lock(&amp;_unlock);</span><br><span class="line">	[super __saleTicket];</span><br><span class="line">	os_unfair_lock_unlock(&amp;_unlock);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">//log</span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x600002eb4bc0&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x600002eb4bc0&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x600002eb4bc0&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x600002eb1500&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x600002eb1500&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x600002eb1500&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x600002ed4340&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x600002ed4340&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x600002ed4340&gt;&#123;number = 5, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ±‡ç¼–åˆ†æ-1"><a href="#æ±‡ç¼–åˆ†æ-1" class="headerlink" title="æ±‡ç¼–åˆ†æ"></a>æ±‡ç¼–åˆ†æ</h4><p><code>LLDB</code> ä¸­å‘½ä»¤<code>stepi</code>é‡åˆ°å‡½æ•°ä¼šè¿›å…¥åˆ°å‡½æ•°ï¼Œ<code>nexti</code>ä¼šè·³è¿‡å‡½æ•°ã€‚æˆ‘ä»¬å°†æ–­ç‚¹æ‰“åˆ°æ·»åŠ é”çš„ä½ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">- (void)__saleTicket&#123;</span><br><span class="line"> 	os_unfair_lock_lock(&amp;_unlock);//æ–­ç‚¹ä½ç½®</span><br><span class="line">	[super __saleTicket];</span><br><span class="line">	os_unfair_lock_unlock(&amp;_unlock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰§è¡Œ<code>si</code>,ä¸€ç›´<code>enter</code>ï¼Œæœ€ç»ˆæ˜¯åœæ­¢è¯¥ä½å­ï¼Œæ¨¡æ‹Ÿå™¨ç¼ºè·³å‡ºæ¥äº†ï¼Œå†<code>enter</code>ä¹Ÿæ²¡ç”¨äº†ï¼Œå› ä¸ºçº¿ç¨‹åœ¨ç¡çœ äº†ã€‚<code>syscall</code>æ˜¯è°ƒç”¨ç³»ç»Ÿå‡½æ•°çš„å‘½ä»¤ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">libsystem_kernel.dylib`__ulock_wait:</span><br><span class="line">    0x107a3b9d4 &lt;+0&gt;:  movl   $0x2000203, %eax          ; imm = 0x2000203 </span><br><span class="line">    0x107a3b9d9 &lt;+5&gt;:  movq   %rcx, %r10</span><br><span class="line">-&gt;  0x107a3b9dc &lt;+8&gt;:  syscall</span><br></pre></td></tr></table></figure>
<h3 id="äº’æ–¥é”-pthread-mutex-t"><a href="#äº’æ–¥é”-pthread-mutex-t" class="headerlink" title="äº’æ–¥é” pthread_mutex_t"></a>äº’æ–¥é” pthread_mutex_t</h3><p><code>mutex</code>å«äº’æ–¥é”ï¼Œç­‰å¾…é”çš„çº¿ç¨‹ä¼šå¤„äºä¼‘çœ çŠ¶æ€ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">-(void)dealloc&#123;</span><br><span class="line">	pthread_mutex_destroy(&amp;_plock);</span><br><span class="line">	pthread_mutexattr_destroy(&amp;t);</span><br><span class="line">&#125;</span><br><span class="line">-(instancetype)init&#123;</span><br><span class="line">	if (self =[super init]) &#123;</span><br><span class="line">		//åˆå§‹åŒ–é”çš„å±æ€§ </span><br><span class="line">//		pthread_mutexattr_init(&amp;t);</span><br><span class="line">//		pthread_mutexattr_settype(&amp;t, PTHREAD_MUTEX_NORMAL);</span><br><span class="line">//		//åˆå§‹åŒ–é”</span><br><span class="line">//		pthread_mutex_init(&amp;_plock, &amp;t);</span><br><span class="line">		</span><br><span class="line">		pthread_mutex_t plock = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line">		self.plock = plock;</span><br><span class="line">	&#125;</span><br><span class="line">	return self;</span><br><span class="line">&#125;</span><br><span class="line">-(void)__saleTicket&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;_plock);</span><br><span class="line">	[super __saleTicket];</span><br><span class="line">	pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__getMonery&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;_plock);</span><br><span class="line">	[super __getMonery];</span><br><span class="line">	pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saveMonery&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;_plock);</span><br><span class="line">	[super __saveMonery];</span><br><span class="line">	pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x6000014e3600&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8d80&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8f40&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8f40&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8f40&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8d80&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x6000014e3600&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x6000014c8d80&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x6000014e3600&gt;&#123;number = 3, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<p>äº’æ–¥é”æœ‰ä¸‰ä¸ªç±»å‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Mutex type attributes</span><br><span class="line"> */</span><br><span class="line"> æ™®é€šé”</span><br><span class="line">#define PTHREAD_MUTEX_NORMAL		0</span><br><span class="line">//æ£€æŸ¥é”™è¯¯</span><br><span class="line">#define PTHREAD_MUTEX_ERRORCHECK	1</span><br><span class="line">//é€’å½’é”</span><br><span class="line">#define PTHREAD_MUTEX_RECURSIVE		2</span><br><span class="line">//æ™®é€šé”</span><br><span class="line">#define PTHREAD_MUTEX_DEFAULT		PTHREAD_MUTEX_NORMAL</span><br></pre></td></tr></table></figure>
<p>å½“æˆ‘ä»¬è¿™æ ·å­å‡½æ•°è°ƒç”¨å‡½æ•°ä¼šå‡ºç°æ­»é”çš„é—®é¢˜ï¼Œè¿™æ˜¯æ€ä¹ˆå‡ºç°çš„å‘¢ï¼Ÿç¬¬ä¸€æŠŠé”æ˜¯é”ä½çŠ¶æ€ï¼Œç„¶åè¿›å…¥ç¬¬äºŒä¸ªå‡½æ•°ï¼Œé”åœ¨é”ä½çŠ¶æ€ï¼Œåœ¨ç­‰å¾…ï¼Œä½†æ˜¯è¿™æŠŠé”éœ€è¦å‘åæ‰§è¡Œæ‰ä¼šè§£é”ï¼Œåˆ°æ—¶æ— é™æœŸçš„ç­‰å¾…ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">- (void)otherTest&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;_plock);</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	[self otherTest2];</span><br><span class="line">	pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)otherTest2&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;_plock);</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line">-[FYPthread_mutex2 otherTest]</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™ä¸ªéœ€æ±‚éœ€è¦ä½¿ç”¨ä¸¤æŠŠé”ï¼Œæˆ–è€…ä½¿ç”¨é€’å½’é”æ¥è§£å†³é—®é¢˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (void)otherTest&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;_plock);</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	[self otherTest2];</span><br><span class="line">	pthread_mutex_unlock(&amp;_plock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)otherTest2&#123;</span><br><span class="line">	pthread_mutex_lock(&amp;_plock2);</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	pthread_mutex_unlock(&amp;_plock2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line">-[FYPthread_mutex2 otherTest]</span><br><span class="line">-[FYPthread_mutex2 otherTest2]</span><br></pre></td></tr></table></figure>
<p>ä»ä½¿ç”¨2æŠŠé”æ˜¯å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚<br>é€’å½’é”æ˜¯ä»€ä¹ˆé”å‘¢ï¼Ÿå…è®¸åŒä¸€ä¸ªçº¿ç¨‹å¯¹ä¸€æŠŠé”é‡å¤åŠ é”ã€‚</p>
<h3 id="NSLockã€NSRecursiveLosk"><a href="#NSLockã€NSRecursiveLosk" class="headerlink" title="NSLockã€NSRecursiveLosk"></a>NSLockã€NSRecursiveLosk</h3><p><code>NSLock</code>æ˜¯å¯¹<code>mutex</code>æ™®é€šé”çš„å°è£…</p>
<p>ä½¿ç”¨<code>(LLDB) si</code>å¯ä»¥è·Ÿè¸ª<code>[myLock lock];</code>çš„å†…éƒ¨å‡½æ•°æœ€ç»ˆæ˜¯<code>pthread_mutex_lock</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Foundation`-[NSLock lock]:</span><br><span class="line">    0x1090dfb5a &lt;+0&gt;:  pushq  %rbp</span><br><span class="line">    0x1090dfb5b &lt;+1&gt;:  movq   %rsp, %rbp</span><br><span class="line">    0x1090dfb5e &lt;+4&gt;:  callq  0x1092ca3fe               ; symbol stub for: object_getIndexedIvars</span><br><span class="line">    0x1090dfb63 &lt;+9&gt;:  movq   %rax, %rdi</span><br><span class="line">    0x1090dfb66 &lt;+12&gt;: popq   %rbp</span><br><span class="line">-&gt;  0x1090dfb67 &lt;+13&gt;: jmp    0x1092ca596   ;</span><br><span class="line">//  symbol stub for: pthread_mutex_lock</span><br></pre></td></tr></table></figure>
<p><code>NSLock API</code>å¤§å…¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//åè®®NSLocking</span><br><span class="line">@protocol NSLocking</span><br><span class="line"></span><br><span class="line">- (void)lock;</span><br><span class="line">- (void)unlock;</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@interface NSLock : NSObject &lt;NSLocking&gt; &#123;</span><br><span class="line">@private</span><br><span class="line">    void *_priv;</span><br><span class="line">&#125;</span><br><span class="line">- (BOOL)tryLock;//å°è¯•åŠ é”</span><br><span class="line">- (BOOL)lockBeforeDate:(NSDate *)limit;//åœ¨æŸä¸ªæ—¥æœŸå‰åŠ é”ï¼Œ</span><br><span class="line">@property (nullable, copy) NSString *name API_AVAILABLE(macos(10.5), ios(2.0), watchos(2.0), tvos(9.0));</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ç”¨æ³•ä¹Ÿå¾ˆç®€å•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">@interface FYNSLock()&#123;</span><br><span class="line">	NSLock *_lock;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYNSLock</span><br><span class="line">- (instancetype)init&#123;</span><br><span class="line">	if (self = [super init]) &#123;</span><br><span class="line">		//å°è£…äº†mutexçš„æ™®é€šé”</span><br><span class="line">		_lock=[[NSLock alloc]init];</span><br><span class="line">	&#125;</span><br><span class="line">	return self;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)__saveMonery&#123;</span><br><span class="line">	[_lock lock];</span><br><span class="line">	[super __saveMonery];</span><br><span class="line">	[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">	[_lock lock];</span><br><span class="line">	[super __saleTicket];</span><br><span class="line">	[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">- (void)__getMonery&#123;</span><br><span class="line">	[_lock lock];</span><br><span class="line">	[super __getMonery];</span><br><span class="line">	[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x600003d4dc40&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x600003d4dc40&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x600003d4dc40&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x600003d7bfc0&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x600003d7bfc0&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x600003d7bfc0&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x600003d66c00&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x600003d66c00&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x600003d66c00&gt;&#123;number = 5, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<p><code>NSRecursiveLock</code>ä¹Ÿæ˜¯å¯¹<code>mutexé€’å½’é”</code>çš„å°è£…ï¼Œ<code>API</code>è·Ÿ<code>NSLock</code>åŸºæœ¬ä¸€è‡´</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (BOOL)tryLock;//å°è¯•åŠ é”</span><br><span class="line">- (BOOL)lockBeforeDate:(NSDate *)limit;//æ—¥æœŸå‰åŠ é”</span><br></pre></td></tr></table></figure>
<p>é€’å½’é”å¯ä»¥å¯¹ç›¸åŒçš„çº¿ç¨‹è¿›è¡Œåå¤åŠ é”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@implementation FYRecursiveLockDemo</span><br><span class="line">- (instancetype)init&#123;</span><br><span class="line">	if (self = [super init]) &#123;</span><br><span class="line">		//å°è£…äº†mutexçš„é€’å½’é”</span><br><span class="line">		_lock=[[NSRecursiveLock alloc]init];</span><br><span class="line">	&#125;</span><br><span class="line">	return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)otherTest&#123;</span><br><span class="line">	static int count = 10;</span><br><span class="line">	[_lock lock];</span><br><span class="line">	while (count &gt; 0) &#123;</span><br><span class="line">		count -= 1;</span><br><span class="line">		printf(&quot;å¾ªç¯% 2dæ¬¡ - %s \n&quot;,count,[NSThread currentThread].description.UTF8String);</span><br><span class="line">		[self otherTest];</span><br><span class="line">	&#125;</span><br><span class="line">	[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line">å¾ªç¯ 9æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number = 1, name = main&#125; </span><br><span class="line">å¾ªç¯ 8æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number = 1, name = main&#125; </span><br><span class="line">å¾ªç¯ 7æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number = 1, name = main&#125; </span><br><span class="line">å¾ªç¯ 6æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number = 1, name = main&#125; </span><br><span class="line">å¾ªç¯ 5æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number = 1, name = main&#125; </span><br><span class="line">å¾ªç¯ 4æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number = 1, name = main&#125; </span><br><span class="line">å¾ªç¯ 3æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number = 1, name = main&#125; </span><br><span class="line">å¾ªç¯ 2æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number = 1, name = main&#125; </span><br><span class="line">å¾ªç¯ 1æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number = 1, name = main&#125; </span><br><span class="line">å¾ªç¯ 0æ¬¡ - &lt;NSThread: 0x60000274e900&gt;&#123;number = 1, name = main&#125;</span><br></pre></td></tr></table></figure>
<h3 id="NSCondition-æ¡ä»¶"><a href="#NSCondition-æ¡ä»¶" class="headerlink" title="NSCondition æ¡ä»¶"></a>NSCondition æ¡ä»¶</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (void)wait;//ç­‰å¾…</span><br><span class="line">- (BOOL)waitUntilDate:(NSDate *)limit;</span><br><span class="line">- (void)signal;//å”¤é†’ä¸€ä¸ªçº¿ç¨‹</span><br><span class="line">- (void)broadcast;//å”¤é†’å¤šä¸ªçº¿ç¨‹</span><br></pre></td></tr></table></figure>
<p><code>NSCondition</code>æ˜¯å¯¹<code>mutex</code>å’Œ<code>cond</code>çš„å°è£…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)init&#123;</span><br><span class="line">	if (self = [super init]) &#123;</span><br><span class="line">		//éµå®ˆçš„ lockåè®® çš„ æ¡ä»¶ğŸ”</span><br><span class="line">		_lock=[[NSCondition alloc]init];</span><br><span class="line">		self.array =[NSMutableArray array];</span><br><span class="line">	&#125;</span><br><span class="line">	return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)otherTest&#123;</span><br><span class="line">	[[[NSThread alloc]initWithTarget:self selector:@selector(__remove) object:nil] start];</span><br><span class="line">	[[[NSThread alloc]initWithTarget:self selector:@selector(__add) object:nil] start];</span><br><span class="line">&#125;</span><br><span class="line">- (void)__add&#123;</span><br><span class="line">	[_lock lock];</span><br><span class="line">	[self.array addObject:@&quot;Test&quot;];</span><br><span class="line">	NSLog(@&quot;æ·»åŠ æˆåŠŸ&quot;);</span><br><span class="line">	sleep(1);</span><br><span class="line">	[_lock signal];//å”¤é†’ä¸€ä¸ªçº¿ç¨‹</span><br><span class="line">	[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">- (void)__remove&#123;</span><br><span class="line">	[_lock lock];</span><br><span class="line">	if (self.array.count == 0) &#123;</span><br><span class="line">		[_lock wait];</span><br><span class="line">	&#125;</span><br><span class="line">	[self.array removeLastObject];</span><br><span class="line">	NSLog(@&quot;åˆ é™¤æˆåŠŸ&quot;);</span><br><span class="line"></span><br><span class="line">	[_lock unlock];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">//Log</span><br><span class="line"></span><br><span class="line">2019-07-29 10:06:48.904648+0800 day16--çº¿ç¨‹å®‰å…¨[43603:4402260] æ·»åŠ æˆåŠŸ</span><br><span class="line">2019-07-29 10:06:49.907641+0800 day16--çº¿ç¨‹å®‰å…¨[43603:4402259] åˆ é™¤æˆåŠŸ</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ—¶é—´ä¸Šå·®äº†1ç§’ï¼Œæ­£å¥½æ˜¯æˆ‘ä»¬è®¾å®šçš„<code>sleep(1);</code>ã€‚ä¼˜ç‚¹æ˜¯å¯ä»¥è®©çº¿ç¨‹ä¹‹é—´å½¢æˆä¾èµ–ï¼Œç¼ºç‚¹æ˜¯æ²¡æœ‰æ˜ç¡®çš„æ¡ä»¶ã€‚</p>
<h3 id="NSConditionLock-å¯ä»¥å®ç°çº¿ç¨‹ä¾èµ–çš„é”"><a href="#NSConditionLock-å¯ä»¥å®ç°çº¿ç¨‹ä¾èµ–çš„é”" class="headerlink" title="NSConditionLock å¯ä»¥å®ç°çº¿ç¨‹ä¾èµ–çš„é”"></a>NSConditionLock å¯ä»¥å®ç°çº¿ç¨‹ä¾èµ–çš„é”</h3><p><code>NSConditionLock</code>æ˜¯å¯ä»¥å®ç°å¤šä¸ªå­çº¿ç¨‹è¿›è¡Œçº¿ç¨‹é—´çš„ä¾èµ–ï¼ŒAä¾èµ–äºBæ‰§è¡Œå®Œæˆï¼ŒBä¾èµ–äºCæ‰§è¡Œå®Œæ¯•åˆ™å¯ä»¥ä½¿ç”¨<code>NSConditionLock</code>æ¥è§£å†³é—®é¢˜ã€‚<br>é¦–å…ˆçœ‹ä¸‹<code>API</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">@property (readonly) NSInteger condition;//æ¡ä»¶å€¼</span><br><span class="line">- (void)lockWhenCondition:(NSInteger)condition;//å½“conä¸ºconditionè¿›è¡Œé”ä½</span><br><span class="line">//å°è¯•åŠ é”</span><br><span class="line">- (BOOL)tryLock;</span><br><span class="line">//å½“conä¸ºconditionè¿›è¡Œå°è¯•é”ä½</span><br><span class="line">- (BOOL)tryLockWhenCondition:(NSInteger)condition;</span><br><span class="line">//å½“conä¸ºconditionè¿›è¡Œè§£é”</span><br><span class="line">- (void)unlockWithCondition:(NSInteger)condition;</span><br><span class="line">//NSDate å°ä½™ limitè¿›è¡Œ åŠ é”</span><br><span class="line">- (BOOL)lockBeforeDate:(NSDate *)limit;</span><br><span class="line">//æ¡ä»¶ä¸ºcondition åœ¨limitä¹‹å‰è¿›è¡ŒåŠ é”</span><br><span class="line">- (BOOL)lockWhenCondition:(NSInteger)condition beforeDate:(NSDate *)limit;</span><br></pre></td></tr></table></figure>
<p>æ¡ä»¶é”çš„ä½¿ç”¨ï¼Œåœ¨<code>lockWhenCondition:(NSInteger)condition</code>çš„æ¡ä»¶åˆ°è¾¾çš„æ—¶å€™æ‰èƒ½è¿›è¡Œæ­£å¸¸çš„åŠ é”å’Œ<code>unlockWithCondition:(NSInteger)condition</code>è§£é”ï¼Œå¦åˆ™ä¼šé˜»å¡çº¿ç¨‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">- (void)otherTest&#123;</span><br><span class="line">	[[[NSThread alloc]initWithTarget:self selector:@selector(__test2) object:nil] start];</span><br><span class="line">	[[[NSThread alloc]initWithTarget:self selector:@selector(__test1) object:nil] start];</span><br><span class="line">	[[[NSThread alloc]initWithTarget:self selector:@selector(__test3) object:nil] start];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">- (void)__test1&#123;</span><br><span class="line">	[_lock lockWhenCondition:1];</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	[_lock unlockWithCondition:2];//è§£é” å¹¶èµ‹å€¼2</span><br><span class="line">&#125;</span><br><span class="line">- (void)__test2&#123;</span><br><span class="line">	[_lock lockWhenCondition:2];</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	[_lock unlockWithCondition:3];//è§£é” å¹¶èµ‹å€¼3</span><br><span class="line">&#125;</span><br><span class="line">- (void)__test3&#123;</span><br><span class="line">	[_lock lockWhenCondition:3];</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	[_lock unlockWithCondition:4];//è§£é” å¹¶èµ‹å€¼4</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">//log</span><br><span class="line">-[FYCondLockDemo2 __test1]</span><br><span class="line">-[FYCondLockDemo2 __test2]</span><br><span class="line">-[FYCondLockDemo2 __test3]</span><br></pre></td></tr></table></figure>
<p>å½“<code>con = 1</code>è¿›è¡Œ<code>test1</code>åŠ é”å’Œæ‰§è¡Œä»»åŠ¡<code>A</code>ï¼Œä»»åŠ¡<code>A</code>æ‰§è¡Œå®Œæ¯•ï¼Œè¿›è¡Œè§£é”ï¼Œå¹¶æŠŠå€¼2èµ‹å€¼ç»™<code>lock</code>ï¼Œè¿™æ˜¯å½“<code>con = 2</code>çš„é”å¼€å§‹åŠ é”ï¼Œè¿›å…¥ä»»åŠ¡<code>B</code>ï¼Œå¼€å§‹æ‰§è¡Œä»»åŠ¡<code>B</code>ï¼Œå½“ä»»åŠ¡<code>B</code>æ‰§è¡Œå®Œæ¯•ï¼Œè¿›è¡Œè§£é”å¹¶èµ‹å€¼ä¸º3ï¼Œç„¶å<code>con=3</code>çš„é”è¿›è¡ŒåŠ é”ï¼Œè§£é”å¹¶èµ‹å€¼4æ¥è¿›è¡Œçº¿ç¨‹ä¹‹é—´çš„ä¾èµ–ã€‚</p>
<h3 id="dispatch-queue-ç‰¹æ®Šçš„é”"><a href="#dispatch-queue-ç‰¹æ®Šçš„é”" class="headerlink" title="dispatch_queue ç‰¹æ®Šçš„é”"></a>dispatch_queue ç‰¹æ®Šçš„é”</h3><p>å…¶å®ç›´æ¥ä½¿ç”¨GCDçš„ä¸²è¡Œé˜Ÿåˆ—ï¼Œä¹Ÿæ˜¯å¯ä»¥å®ç°çº¿ç¨‹åŒæ­¥çš„ã€‚ä¸²è¡Œé˜Ÿåˆ—å…¶å®å°±æ˜¯çº¿ç¨‹çš„ä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­æŒ‰ç…§é¡ºåºæ‰§è¡Œï¼Œè¾¾åˆ°äº†é”çš„ç›®çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">@interface FYSerialQueueDemo()&#123;</span><br><span class="line">	dispatch_queue_t _queue;</span><br><span class="line">&#125;@end</span><br><span class="line">@implementation FYSerialQueueDemo</span><br><span class="line">- (instancetype)init&#123;</span><br><span class="line">	if (self =[super init]) &#123;</span><br><span class="line">		_queue = dispatch_queue_create(&quot;fyserial.queue&quot;, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">	&#125;</span><br><span class="line">	return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">	dispatch_sync(_queue, ^&#123;</span><br><span class="line">		[super __saleTicket];</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__getMonery&#123;</span><br><span class="line">	dispatch_sync(_queue, ^&#123;</span><br><span class="line">		[super __getMonery];</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saveMonery&#123;</span><br><span class="line">	dispatch_sync(_queue, ^&#123;</span><br><span class="line">		[super __saveMonery];</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">//log</span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x600001211b40&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x600001243700&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x60000121dd80&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x600001211b40&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x600001243700&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x60000121dd80&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x600001211b40&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x600001243700&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x60000121dd80&gt;&#123;number = 5, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<h3 id="dispatch-semaphore-ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡"><a href="#dispatch-semaphore-ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡" class="headerlink" title="dispatch_semaphore ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡"></a>dispatch_semaphore ä¿¡å·é‡æ§åˆ¶å¹¶å‘æ•°é‡</h3><p>å½“æˆ‘ä»¬æœ‰å¤§é‡ä»»åŠ¡éœ€è¦å¹¶å‘æ‰§è¡Œï¼Œè€Œä¸”åŒæ—¶æœ€å¤§å¹¶å‘é‡ä¸º5ä¸ªçº¿ç¨‹ï¼Œè¿™æ ·å­åˆè¯¥å¦‚ä½•æ§åˆ¶å‘¢ï¼Ÿ<code>dispatch_semaphore</code>ä¿¡å·é‡æ­£å¥½å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„éœ€æ±‚ã€‚<br><code>dispatch_semaphore</code>å¯ä»¥æ§åˆ¶å¹¶å‘çº¿ç¨‹çš„æ•°é‡ï¼Œå½“è®¾ç½®ä¸º1æ—¶ï¼Œå¯ä»¥ä½œä¸ºåŒæ­¥é”æ¥ç”¨ï¼Œè®¾ç½®å¤šä¸ªçš„æ—¶å€™ï¼Œå°±æ˜¯å¼‚æ­¥å¹¶å‘é˜Ÿåˆ—ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">//åˆå§‹åŒ–ä¿¡å·é‡ å€¼ä¸º2ï¼Œå°±æ˜¯æœ€å¤šå…è®¸åŒæ—¶2ä¸ªçº¿ç¨‹æ‰§è¡Œ</span><br><span class="line">_semaphore = dispatch_semaphore_create(2);</span><br><span class="line">//ç”Ÿæˆå¤šä¸ªçº¿ç¨‹è¿›è¡Œå¹¶å‘è®¿é—®test</span><br><span class="line">- (void)otherTest&#123;</span><br><span class="line">	for (int i = 0; i &lt; 10; i ++) &#123;</span><br><span class="line">		[[[NSThread alloc]initWithTarget:self selector:@selector(test) object:nil]start];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (void)test&#123;</span><br><span class="line">//å¦‚æœä¿¡å·é‡&gt;0 ï¼Œè®©ä¿¡å·é‡-1ï¼Œç»§ç»­å‘ä¸‹æ‰§è¡Œã€‚</span><br><span class="line">//å¦‚æœä¿¡å·é‡ &lt;= 0;å°±ä¼šç­‰å¾…ï¼Œç­‰å¾…æ—¶é—´æ˜¯ DISPATCH_TIME_FOREVER</span><br><span class="line">	dispatch_semaphore_wait(_semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">	sleep(2);//ç¡çœ æ—¶é—´2s</span><br><span class="line">	NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">	//é‡Šæ”¾ä¸€ä¸ªä¿¡å·é‡</span><br><span class="line">	dispatch_semaphore_signal(_semaphore);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">2019-07-29 11:17:53.233318+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529610] &lt;NSThread: 0x600002c45240&gt;&#123;number = 4, name = (null)&#125;</span><br><span class="line">2019-07-29 11:17:53.233329+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529609] &lt;NSThread: 0x600002c45200&gt;&#123;number = 3, name = (null)&#125;</span><br><span class="line">2019-07-29 11:17:55.233879+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529616] &lt;NSThread: 0x600002c45540&gt;&#123;number = 10, name = (null)&#125;</span><br><span class="line">2019-07-29 11:17:55.233879+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529612] &lt;NSThread: 0x600002c45440&gt;&#123;number = 6, name = (null)&#125;</span><br><span class="line">2019-07-29 11:17:57.238860+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529613] &lt;NSThread: 0x600002c45480&gt;&#123;number = 7, name = (null)&#125;</span><br><span class="line">2019-07-29 11:17:57.238867+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529614] &lt;NSThread: 0x600002c454c0&gt;&#123;number = 8, name = (null)&#125;</span><br><span class="line">2019-07-29 11:17:59.241352+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529615] &lt;NSThread: 0x600002c45500&gt;&#123;number = 9, name = (null)&#125;</span><br><span class="line">2019-07-29 11:17:59.241324+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529611] &lt;NSThread: 0x600002c45400&gt;&#123;number = 5, name = (null)&#125;</span><br><span class="line">2019-07-29 11:18:01.245790+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529618] &lt;NSThread: 0x600002c455c0&gt;&#123;number = 12, name = (null)&#125;</span><br><span class="line">2019-07-29 11:18:01.245790+0800 day16--çº¿ç¨‹å®‰å…¨[47907:4529617] &lt;NSThread: 0x600002c45580&gt;&#123;number = 11, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€æ¬¡æœ€å¤š2ä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œä»»åŠ¡ï¼Œæš‚åœæ—¶é—´æ˜¯2sã€‚<br>ä½¿ç”¨ä¿¡å·é‡å®ç°çº¿ç¨‹æœ€å¤§å¹¶å‘é”ï¼Œ<br>åŒæ—¶åªæœ‰2ä¸ªçº¿ç¨‹æ‰§è¡Œçš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (instancetype)init&#123;</span><br><span class="line">	if (self =[super init]) &#123;</span><br><span class="line">		_semaphore = dispatch_semaphore_create(1);</span><br><span class="line">	&#125;</span><br><span class="line">	return self;</span><br><span class="line">&#125;</span><br><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">	dispatch_semaphore_wait(_semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">	[super __saleTicket];</span><br><span class="line">	dispatch_semaphore_signal(_semaphore);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0c00&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0dc0&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x6000022ce880&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0c00&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0dc0&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x6000022ce880&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0c00&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x6000022e0dc0&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x6000022ce880&gt;&#123;number = 5, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<h3 id="synchronized"><a href="#synchronized" class="headerlink" title="@synchronized"></a>@synchronized</h3><p><code>@synchronized(id obj){}</code>é”çš„æ˜¯å¯¹è±¡<code>obj</code>ï¼Œä½¿ç”¨è¯¥é”çš„æ—¶å€™ï¼Œåº•å±‚æ˜¯å¯¹è±¡è®¡ç®—å‡ºæ¥çš„å€¼ä½œä¸º<code>key</code>ï¼Œç”Ÿæˆä¸€æŠŠé”ï¼Œä¸åŒçš„èµ„æºçš„è¯»å†™å¯ä»¥ä½¿ç”¨ä¸åŒ<code>obj</code>ä½œä¸ºé”å¯¹è±¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- (void)__saleTicket&#123;</span><br><span class="line">	@synchronized (self) &#123;</span><br><span class="line">		[super __saleTicket];</span><br><span class="line">	&#125;</span><br><span class="line"> &#125;</span><br><span class="line"> //log</span><br><span class="line">è¿˜å‰© 9 å¼ ç¥¨ - &lt;NSThread: 0x60000057d5c0&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 8 å¼ ç¥¨ - &lt;NSThread: 0x60000056f340&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 7 å¼ ç¥¨ - &lt;NSThread: 0x60000057d500&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 6 å¼ ç¥¨ - &lt;NSThread: 0x60000057d5c0&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 5 å¼ ç¥¨ - &lt;NSThread: 0x60000056f340&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 4 å¼ ç¥¨ - &lt;NSThread: 0x60000057d500&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 3 å¼ ç¥¨ - &lt;NSThread: 0x60000057d5c0&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 2 å¼ ç¥¨ - &lt;NSThread: 0x60000056f340&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">è¿˜å‰© 1 å¼ ç¥¨ - &lt;NSThread: 0x60000057d500&gt;&#123;number = 5, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<h3 id="atmoic-åŸå­æ“ä½œ"><a href="#atmoic-åŸå­æ“ä½œ" class="headerlink" title="atmoic åŸå­æ“ä½œ"></a>atmoic åŸå­æ“ä½œ</h3><p>ç»™å±æ€§æ·»åŠ <code>atmoic</code>ä¿®é¥°ï¼Œå¯ä»¥ä¿è¯å±æ€§çš„<code>setter</code>å’Œ<code>getter</code>éƒ½æ˜¯åŸå­æ€§æ“ä½œï¼Œä¹Ÿå°±ä¿è¯äº†<code>setter</code>å’Œ<code>getter</code>çš„å†…éƒ¨æ˜¯çº¿ç¨‹åŒæ­¥çš„ã€‚<br>åŸå­æ“ä½œæ˜¯æœ€ç»ˆè°ƒç”¨äº†<code>static inline void reallySetProperty(id self, SEL _cmd, id newValue, ptrdiff_t offset, bool atomic, bool copy, bool mutableCopy) objc-accessors.mm 48è¡Œ</code>ï¼Œæˆ‘ä»¬è¿›å…¥åˆ°å‡½æ•°å†…éƒ¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">//è®¾ç½®å±æ€§åŸå­æ“ä½œ</span><br><span class="line">void objc_setProperty_atomic(id self, SEL _cmd, id newValue, ptrdiff_t offset)</span><br><span class="line">&#123;</span><br><span class="line">    reallySetProperty(self, _cmd, newValue, offset, true, false, false);</span><br><span class="line">&#125;</span><br><span class="line">//éåŸå­æ“ä½œè®¾ç½®å±æ€§</span><br><span class="line">void objc_setProperty_nonatomic(id self, SEL _cmd, id newValue, ptrdiff_t offset)</span><br><span class="line">&#123;</span><br><span class="line">    reallySetProperty(self, _cmd, newValue, offset, false, false, false);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">static inline void reallySetProperty(id self, SEL _cmd, id newValue, ptrdiff_t offset, bool atomic, bool copy, bool mutableCopy)</span><br><span class="line">&#123;//åç§»é‡ç­‰äº0åˆ™æ˜¯classæŒ‡é’ˆ</span><br><span class="line">    if (offset == 0) &#123;</span><br><span class="line">        object_setClass(self, newValue);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">//å…¶ä»–çš„value</span><br><span class="line">    id oldValue;</span><br><span class="line">    id *slot = (id*) ((char*)self + offset);</span><br><span class="line"></span><br><span class="line">    if (copy) &#123;</span><br><span class="line">    //å¦‚æœæ˜¯copy ç”¨copyWithZone:</span><br><span class="line">        newValue = [newValue copyWithZone:nil];</span><br><span class="line">    &#125; else if (mutableCopy) &#123;</span><br><span class="line">        //mutableCopyåˆ™è°ƒç”¨mutableCopyWithZone:</span><br><span class="line">        newValue = [newValue mutableCopyWithZone:nil];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    //å¦‚æœèµ‹å€¼å’ŒåŸæ¥çš„ç›¸ç­‰ åˆ™ä¸æ“ä½œ</span><br><span class="line">        if (*slot == newValue) return;</span><br><span class="line">        newValue = objc_retain(newValue);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (!atomic) &#123;//éåŸå­æ“ä½œ ç›´æ¥èµ‹å€¼</span><br><span class="line">        oldValue = *slot;</span><br><span class="line">        *slot = newValue;</span><br><span class="line">    &#125; else &#123;//åŸå­æ“ä½œ åŠ é”</span><br><span class="line">    //é”å’Œå±æ€§æ˜¯ä¸€ä¸€å¯¹åº”çš„-&gt;è‡ªæ—‹é”</span><br><span class="line">        spinlock_t&amp; slotlock = PropertyLocks[slot];</span><br><span class="line">        slotlock.lock();</span><br><span class="line">        oldValue = *slot;</span><br><span class="line">        *slot = newValue;//èµ‹å€¼</span><br><span class="line">        slotlock.unlock();//è§£é”</span><br><span class="line">    &#125;</span><br><span class="line">    objc_release(oldValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">id objc_getProperty(id self, SEL _cmd, ptrdiff_t offset, BOOL atomic) &#123;</span><br><span class="line">    if (offset == 0) &#123;</span><br><span class="line">        return object_getClass(self);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Retain release world</span><br><span class="line">    id *slot = (id*) ((char*)self + offset);</span><br><span class="line">    if (!atomic) return *slot;//éåŸå­æ“ä½œ ç›´æ¥è¿”å›å€¼</span><br><span class="line">        </span><br><span class="line">    // Atomic retain release world</span><br><span class="line">	//åŸå­æ“ä½œ åŠ é”-&gt;è‡ªæ—‹é”</span><br><span class="line">    spinlock_t&amp; slotlock = PropertyLocks[slot];</span><br><span class="line">    slotlock.lock();//åŠ é”</span><br><span class="line">    id value = objc_retain(*slot);</span><br><span class="line">    slotlock.unlock();//è§£é”</span><br><span class="line">    </span><br><span class="line">    // for performance, we (safely) issue the autorelease OUTSIDE of the spinlock.</span><br><span class="line">    return objc_autoreleaseReturnValue(value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//ä»¥å±æ€§çš„åœ°å€ä¸ºå‚æ•°è®¡ç®—å‡ºkey ï¼Œé”ä¸ºvalue</span><br><span class="line">StripedMap&lt;spinlock_t&gt; PropertyLocks;</span><br></pre></td></tr></table></figure>
<p>ä»æºç äº†è§£åˆ°è®¾ç½®å±æ€§è¯»å–æ˜¯<code>self</code>+å±æ€§çš„åç§»é‡ï¼Œå½“<code>copy</code>æˆ–<code>mutableCopy</code>ä¼šè°ƒç”¨åˆ°<code>[newValue copyWithZone:nil]</code>æˆ–<code>[newValue mutableCopyWithZone:nil]</code>ï¼Œå¦‚æœæ–°æ—§å€¼ç›¸ç­‰åˆ™ä¸è¿›è¡Œæ“ä½œï¼ŒéåŸå­æ“ä½œç›´æ¥èµ‹å€¼ï¼ŒåŸå­æ“ä½œåˆ™è·å–<code>spinlock_t&amp; slotlock = PropertyLocks[slot]</code>è¿›è¡ŒåŠ é”ã€èµ‹å€¼ã€è§£é”æ“ä½œã€‚è€Œä¸”<code>PropertyLocks</code>æ˜¯ä¸€ä¸ªç±»ï¼Œç±»æœ‰ä¸€ä¸ªæ•°ç»„å±æ€§ï¼Œä½¿ç”¨<code>*p</code>è®¡ç®—å‡ºæ¥çš„å€¼ä½œä¸º<code>key</code>ã€‚</p>
<p>æˆ‘ä»¬æå–å‡ºæ¥å…³é”®ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//åŸå­æ“ä½œ åŠ é”</span><br><span class="line">spinlock_t&amp; slotlock = PropertyLocks[slot];</span><br><span class="line">slotlock.lock();</span><br><span class="line">oldValue = *slot;</span><br><span class="line">*slot = newValue;//èµ‹å€¼</span><br><span class="line">slotlock.unlock();//è§£é”</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨è‡ªæ—‹é”å¯¹èµ‹å€¼æ“ä½œè¿›è¡ŒåŠ é”ï¼Œä¿è¯äº†<code>setter()</code>æ–¹æ³•çš„å®‰å…¨æ€§</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//åŸå­æ“ä½œ åŠ é” -&gt;è‡ªæ—‹é”</span><br><span class="line">spinlock_t&amp; slotlock = PropertyLocks[slot];</span><br><span class="line">slotlock.lock();//åŠ é”</span><br><span class="line">id value = objc_retain(*slot);</span><br><span class="line">slotlock.unlock();//è§£é”</span><br></pre></td></tr></table></figure>
<p>å–å€¼ä¹‹å‰è¿›è¡ŒåŠ é”ï¼Œå–å€¼ä¹‹åè¿›è¡Œè§£é”ï¼Œä¿è¯äº†<code>getter()</code>æ–¹æ³•çš„å®‰å…¨ã€‚</p>
<p>ç”±ä¸Šé¢å¾—çŸ¥<code>atmoic</code>ä»…ä»…æ˜¯å¯¹æ–¹æ³•<code>setter()</code>å’Œ<code>getter()</code>å®‰å…¨ï¼Œå¯¹æˆå‘˜å˜é‡ä¸ä¿è¯å®‰å…¨ï¼Œå¯¹äºå±æ€§çš„è¯»å†™ä¸€èˆ¬ä½¿ç”¨<code>nonatomic</code>ï¼Œæ€§èƒ½å¥½ï¼Œ<code>atomic</code>è¯»å–é¢‘ç‡é«˜çš„æ—¶å€™ä¼šå¯¼è‡´çº¿ç¨‹éƒ½åœ¨æ’é˜Ÿï¼Œæµªè´¹CPUæ—¶é—´ã€‚</p>
<p>å¤§æ¦‚ä½¿ç”¨è€…å‡ ç§é”åˆ†åˆ«å¯¹å–ç¥¨åŠŸèƒ½è¿›è¡Œäº†æ€§èƒ½æµ‹è¯•ï¼Œ<br>æ€§èƒ½åˆ†åˆ«1ä¸‡æ¬¡ã€100ä¸‡æ¬¡ã€1000ä¸‡æ¬¡é”èŠ±è´¹çš„æ—¶é—´å¯¹æ¯”ï¼Œå•ä½æ˜¯ç§’ã€‚(ä»…ä¾›å‚è€ƒï¼Œä¸åŒç¯å¢ƒæ—¶é—´ç•¥æœ‰å·®å¼‚)</p>
<table>
<thead>
<tr>
<th style="text-align:center">é”ç±»å‹</th>
<th style="text-align:center">1ä¸‡æ¬¡</th>
<th style="text-align:center">100ä¸‡æ¬¡</th>
<th style="text-align:center">1000ä¸‡æ¬¡</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">pthread_mutex_t</td>
<td style="text-align:center">0.000309</td>
<td style="text-align:center">0.027238</td>
<td style="text-align:center">0.284714</td>
</tr>
<tr>
<td style="text-align:center">os_unfair_lock</td>
<td style="text-align:center">0.000274</td>
<td style="text-align:center">0.028266</td>
<td style="text-align:center">0.285685</td>
</tr>
<tr>
<td style="text-align:center">OSSpinLock</td>
<td style="text-align:center">0.030688</td>
<td style="text-align:center">0.410067</td>
<td style="text-align:center">0.437702</td>
</tr>
<tr>
<td style="text-align:center">NSCondition</td>
<td style="text-align:center">0.005067</td>
<td style="text-align:center">0.323492</td>
<td style="text-align:center">1.078636</td>
</tr>
<tr>
<td style="text-align:center">NSLock</td>
<td style="text-align:center">0.038692</td>
<td style="text-align:center">0.151601</td>
<td style="text-align:center">1.322062</td>
</tr>
<tr>
<td style="text-align:center">NSRecursiveLock</td>
<td style="text-align:center">0.007973</td>
<td style="text-align:center">0.151601</td>
<td style="text-align:center">1.673409</td>
</tr>
<tr>
<td style="text-align:center">@synchronized</td>
<td style="text-align:center">0.008953</td>
<td style="text-align:center">0.640234</td>
<td style="text-align:center">2.790291</td>
</tr>
<tr>
<td style="text-align:center">NSConditionLock</td>
<td style="text-align:center">0.229148</td>
<td style="text-align:center">5.325272</td>
<td style="text-align:center">10.681123</td>
</tr>
<tr>
<td style="text-align:center">semaphore</td>
<td style="text-align:center">0.094267</td>
<td style="text-align:center">0.415351</td>
<td style="text-align:center">24.699100</td>
</tr>
<tr>
<td style="text-align:center">SerialQueue</td>
<td style="text-align:center">0.213386</td>
<td style="text-align:center">9.058581</td>
<td style="text-align:center">50.820202</td>
</tr>
</tbody>
</table>
<h3 id="å»ºè®®"><a href="#å»ºè®®" class="headerlink" title="å»ºè®®"></a>å»ºè®®</h3><p>å¹³æ—¶æˆ‘ä»¬ç®€å•ä½¿ç”¨çš„è¯æ²¡æœ‰å¾ˆå¤§çš„åŒºåˆ«ï¼Œè¿˜æ˜¯æ¨èä½¿ç”¨<code>NSLock</code>å’Œä¿¡å·é‡,æœ€ç®€å•çš„æ˜¯<code>@synchronized</code>ï¼Œä¸ç”¨å£°æ˜å’Œåˆå§‹åŒ–ï¼Œç›´æ¥æ‹¿æ¥å°±ç”¨ã€‚</p>
<h3 id="è‡ªæ—‹é”ã€äº’æ–¥é”æ¯”è¾ƒ"><a href="#è‡ªæ—‹é”ã€äº’æ–¥é”æ¯”è¾ƒ" class="headerlink" title="è‡ªæ—‹é”ã€äº’æ–¥é”æ¯”è¾ƒ"></a>è‡ªæ—‹é”ã€äº’æ–¥é”æ¯”è¾ƒ</h3><p>è‡ªæ—‹é”å’Œäº’æ–¥é”å„æœ‰ä¼˜åŠ£ï¼Œä»£ç æ‰§è¡Œé¢‘ç‡é«˜ï¼ŒCPUå……è¶³ï¼Œå¯ä»¥ä½¿ç”¨äº’æ–¥é”ï¼Œé¢‘ç‡ä½ï¼Œä»£ç å¤æ‚åˆ™éœ€è¦äº’æ–¥é”ã€‚</p>
<h4 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h4><ul>
<li>è‡ªæ—‹é”åœ¨ç­‰å¾…æ—¶é—´æ¯”è¾ƒçŸ­çš„æ—¶å€™æ¯”è¾ƒåˆé€‚</li>
<li>ä¸´ç•ŒåŒºä»£ç ç»å¸¸è¢«è°ƒç”¨ï¼Œä½†ç«äº‰å¾ˆå°‘å‘ç”Ÿ</li>
<li>CPUä¸ç´§å¼ </li>
<li>å¤šæ ¸å¤„ç†å™¨<h4 id="äº’æ–¥é”"><a href="#äº’æ–¥é”" class="headerlink" title="äº’æ–¥é”"></a>äº’æ–¥é”</h4></li>
<li>é¢„è®¡çº¿ç¨‹ç­‰å¾…æ—¶é—´æ¯”è¾ƒé•¿</li>
<li>å•æ ¸å¤„ç†å™¨</li>
<li>ä¸´ç•ŒåŒºIOæ“ä½œ</li>
<li>ä¸´ç•ŒåŒºä»£ç æ¯”è¾ƒå¤šã€å¤æ‚ï¼Œæˆ–è€…å¾ªç¯é‡å¤§</li>
<li>ä¸´ç•ŒåŒºç«äº‰éå¸¸æ¿€çƒˆ</li>
</ul>
<h2 id="é”çš„åº”ç”¨"><a href="#é”çš„åº”ç”¨" class="headerlink" title="é”çš„åº”ç”¨"></a>é”çš„åº”ç”¨</h2><h4 id="ç®€å•è¯»å†™é”"><a href="#ç®€å•è¯»å†™é”" class="headerlink" title="ç®€å•è¯»å†™é”"></a>ç®€å•è¯»å†™é”</h4><p>ä¸€ä¸ªç®€å•çš„è¯»å†™é”ï¼Œè¯»å†™äº’æ–¥å³å¯ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¿¡å·é‡ï¼Œå€¼è®¾å®šä¸º1.åŒæ—¶åªèƒ½ä¸€ä¸ªçº¿ç¨‹æ¥æ“ä½œæ–‡ä»¶,è¯»å†™äº’æ–¥ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">	[super viewDidLoad];</span><br><span class="line">	// Do any additional setup after loading the view.</span><br><span class="line">	self.semaphore = dispatch_semaphore_create(1);</span><br><span class="line">	</span><br><span class="line">	for (NSInteger i = 0; i &lt; 10; i ++) &#123;</span><br><span class="line">		[[[NSThread alloc]initWithTarget:self selector:@selector(read) object:nil]start];</span><br><span class="line">		[[[NSThread alloc]initWithTarget:self selector:@selector(write) object:nil]start];</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)read&#123;</span><br><span class="line">	dispatch_semaphore_wait(self.semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	dispatch_semaphore_signal(self.semaphore);</span><br><span class="line">&#125;</span><br><span class="line">- (void)write&#123;</span><br><span class="line">	dispatch_semaphore_wait(self.semaphore, DISPATCH_TIME_FOREVER);</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	dispatch_semaphore_signal(self.semaphore);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“è¯»å†™éƒ½æ˜¯ä¸€ä¸ªçº¿ç¨‹æ¥æ“ä½œï¼Œä¼šé™ä½æ€§èƒ½ï¼Œå½“å¤šä¸ªçº¿ç¨‹åœ¨è¯»èµ„æºçš„æ—¶å€™ï¼Œå…¶å®ä¸éœ€è¦åŒæ­¥æ“ä½œçš„ï¼Œæœ‰è¯»æ²¡å†™ï¼Œç†è®ºä¸Šè¯´ä¸ç”¨é™åˆ¶å¼‚æ­¥æ•°é‡ï¼Œå†™å…¥çš„æ—¶å€™ä¸èƒ½è¯»ï¼Œæ‰æ˜¯çœŸæ­£é™åˆ¶çº¿ç¨‹æ€§èƒ½çš„åœ°æ–¹ï¼Œè¯»å†™é”å…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹</p>
<ol>
<li>åŒä¸€æ—¶é—´ï¼Œåªèƒ½æœ‰1ä¸ªçº¿ç¨‹è¿›è¡Œå†™æ“ä½œ</li>
<li>åŒä¸€æ—¶é—´ï¼Œå…è®¸æœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œè¯»çš„æ“ä½œ</li>
<li>åŒä¸€æ—¶é—´ï¼Œä¸å…è®¸è¯»å†™æ“ä½œåŒæ—¶è¿›è¡Œ</li>
</ol>
<p>å…¸å‹çš„<code>å¤šè¯»å•å†™</code>ï¼Œç»å¸¸ç”¨äºæ–‡ä»¶ç­‰æ•°æ®çš„è¯»å†™æ“ä½œï¼Œæˆ‘ä»¬å®ç°2ç§</p>
<h4 id="è¯»å†™é”-pthread-rwlock"><a href="#è¯»å†™é”-pthread-rwlock" class="headerlink" title="è¯»å†™é” pthread_rwlock"></a>è¯»å†™é” pthread_rwlock</h4><p>è¿™æ˜¯æœ‰cè¯­è¨€å°è£…çš„è¯»å†™é”</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//åˆå§‹åŒ–è¯»å†™é”</span><br><span class="line">int pthread_rwlock_init(pthread_rwlock_t * __restrict,</span><br><span class="line">		const pthread_rwlockattr_t * _Nullable __restrict)</span><br><span class="line">//è¯»ä¸Šé”</span><br><span class="line">pthread_rwlock_rdlock(pthread_rwlock_t *)</span><br><span class="line">//å°è¯•åŠ é”è¯»</span><br><span class="line">pthread_rwlock_tryrdlock(pthread_rwlock_t *)</span><br><span class="line">//å°è¯•åŠ é”å†™</span><br><span class="line">int pthread_rwlock_trywrlock(pthread_rwlock_t *)</span><br><span class="line">//å†™å…¥åŠ é”</span><br><span class="line">pthread_rwlock_wrlock(pthread_rwlock_t *)</span><br><span class="line">//è§£é”</span><br><span class="line">pthread_rwlock_unlock(pthread_rwlock_t *)</span><br><span class="line">//é”€æ¯é”å±æ€§</span><br><span class="line">pthread_rwlockattr_destroy(pthread_rwlockattr_t *)</span><br><span class="line">//é”€æ¯é”</span><br><span class="line">pthread_rwlock_destroy(pthread_rwlock_t * )</span><br></pre></td></tr></table></figure>
<p><code>pthread_rwlock_t</code>ä½¿ç”¨å¾ˆç®€å•ï¼Œåªéœ€è¦åœ¨è¯»ä¹‹å‰ä½¿ç”¨<code>pthread_rwlock_rdlock</code>ï¼Œè¯»å®Œè§£é”<code>pthread_rwlock_unlock</code>,å†™å…¥å‰éœ€è¦åŠ é”<code>pthread_rwlock_wrlock</code>ï¼Œå†™å…¥å®Œæˆä¹‹åè§£é”<code>pthread_rwlock_unlock</code>ï¼Œä»»åŠ¡éƒ½æ‰§è¡Œå®Œäº†å¯ä»¥é€‰æ‹©é”€æ¯<code>pthread_rwlock_destroy</code>æˆ–è€…ç­‰å¾…ä¸‹æ¬¡ä½¿ç”¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic,assign) pthread_rwlock_t rwlock;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">	pthread_rwlock_destroy(&amp;_rwlock);//é”€æ¯é”</span><br><span class="line">&#125;</span><br><span class="line">//åˆå§‹åŒ–è¯»å†™é”</span><br><span class="line">pthread_rwlock_init(&amp;_rwlock, NULL);</span><br><span class="line">	</span><br><span class="line">dispatch_queue_t queue = dispatch_get_global_queue(0, 0);</span><br><span class="line">	for (NSInteger i = 0; i &lt; 5; i ++) &#123;</span><br><span class="line">		dispatch_async(queue, ^&#123;</span><br><span class="line">			[[[NSThread alloc]initWithTarget:self selector:@selector(readPthreadRWLock) object:nil]start];</span><br><span class="line">			[[[NSThread alloc]initWithTarget:self selector:@selector(writePthreadRWLock) object:nil]start];</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">- (void)readPthreadRWLock&#123;</span><br><span class="line">    pthread_rwlock_rdlock(&amp;_rwlock);</span><br><span class="line">    NSLog(@&quot;è¯»æ–‡ä»¶&quot;);</span><br><span class="line">    sleep(1);</span><br><span class="line">    pthread_rwlock_unlock(&amp;_rwlock);</span><br><span class="line">&#125;</span><br><span class="line">- (void)writePthreadRWLock&#123;</span><br><span class="line">    pthread_rwlock_wrlock(&amp;_rwlock);</span><br><span class="line">    NSLog(@&quot; å†™å…¥æ–‡ä»¶&quot;);</span><br><span class="line">    sleep(1);</span><br><span class="line">    pthread_rwlock_unlock(&amp;_rwlock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line">2019-07-30 10:47:16 è¯»æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:16 è¯»æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:17 å†™å…¥æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:18 å†™å…¥æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:19 è¯»æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:19 è¯»æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:19 è¯»æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:20 å†™å…¥æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:21 å†™å…¥æ–‡ä»¶</span><br><span class="line">2019-07-30 10:47:22 å†™å…¥æ–‡ä»¶</span><br></pre></td></tr></table></figure>
<p>è¯»æ–‡ä»¶ä¼šå‡ºç°åŒä¸€ç§’è¯»å¤šæ¬¡ï¼Œå†™æ–‡ä»¶åŒä¸€ç§’åªæœ‰ä¸€ä¸ªã€‚</p>
<h4 id="å¼‚æ­¥æ …æ è°ƒç”¨-dispatch-barrier-async"><a href="#å¼‚æ­¥æ …æ è°ƒç”¨-dispatch-barrier-async" class="headerlink" title="å¼‚æ­¥æ …æ è°ƒç”¨ dispatch_barrier_async"></a>å¼‚æ­¥æ …æ è°ƒç”¨ dispatch_barrier_async</h4><p>æ …æ å¤§å®¶éƒ½è§è¿‡ï¼Œä¸ºäº†åˆ†å¼€ä¸€ä¸ªåœ°åŒºè€Œä½¿ç”¨çš„ï¼Œçº¿ç¨‹çš„æ …æ å‡½æ•°æ˜¯åˆ†å¼€ä»»åŠ¡çš„æ‰§è¡Œé¡ºåº</p>
<table>
<thead>
<tr>
<th style="text-align:center">æ“ä½œ</th>
<th style="text-align:center">ä»»åŠ¡</th>
<th style="text-align:center">ä»»åŠ¡</th>
<th style="text-align:center">ä»»åŠ¡</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">è¯»</td>
<td style="text-align:center">A</td>
<td style="text-align:center">B</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">è¯»</td>
<td style="text-align:center">A</td>
<td style="text-align:center">B</td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">å†™</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">C</td>
</tr>
<tr>
<td style="text-align:center">å†™</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
<td style="text-align:center">C</td>
</tr>
<tr>
<td style="text-align:center">è¯»</td>
<td style="text-align:center">A</td>
<td style="text-align:center"></td>
<td style="text-align:center"></td>
</tr>
<tr>
<td style="text-align:center">è¯»</td>
<td style="text-align:center">A</td>
<td style="text-align:center">B</td>
</tr>
</tbody>
</table>
<p>è¿™ä¸ªå‡½æ•°ä¼ å…¥çš„å¹¶å‘é˜Ÿåˆ—å¿…é¡»æ˜¯é€šè¿‡<code>dispatch_queue_create</code>åˆ›å»ºï¼Œå¦‚æœä¼ å…¥çš„æ˜¯ä¸€ä¸ªä¸²è¡Œçš„æˆ–è€…å…¨å±€å¹¶å‘é˜Ÿåˆ—ï¼Œè¿™ä¸ªå‡½æ•°ä¾¿ç­‰åŒäº<code>dispatch_async</code>çš„æ•ˆæœã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">//åˆå§‹åŒ– å¼‚æ­¥é˜Ÿåˆ—</span><br><span class="line">self.rwqueue = dispatch_queue_create(&quot;rw.thread&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">dispatch_queue_t queue = dispatch_get_global_queue(0, 0);</span><br><span class="line">for (NSInteger i = 0; i &lt; 5; i ++) &#123;</span><br><span class="line">	dispatch_async(queue, ^&#123;</span><br><span class="line">		[self readBarryier];</span><br><span class="line">		[self readBarryier];</span><br><span class="line">		[self readBarryier];</span><br><span class="line">		[self writeBarrier];</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)readBarryier&#123;</span><br><span class="line">//æ·»åŠ ä»»åŠ¡åˆ°rwqueue</span><br><span class="line">	dispatch_async(self.rwqueue, ^&#123;</span><br><span class="line">		NSLog(@&quot;è¯»æ–‡ä»¶ %@&quot;,[NSThread currentThread]);</span><br><span class="line">		sleep(1);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)writeBarrier&#123;</span><br><span class="line">//barrier_asyncæ·»åŠ ä»»åŠ¡åˆ°self.rwqueueä¸­</span><br><span class="line">	dispatch_barrier_async(self.rwqueue, ^&#123;</span><br><span class="line">		NSLog(@&quot;å†™å…¥æ–‡ä»¶ %@&quot;,[NSThread currentThread]);</span><br><span class="line">		sleep(1);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">2019-07-30 11:16:53 è¯»æ–‡ä»¶ &lt;NSThread: 0x600001ae0740&gt;&#123;number = 9, name = (null)&#125;</span><br><span class="line">2019-07-30 11:16:53 è¯»æ–‡ä»¶ &lt;NSThread: 0x600001ae8500&gt;&#123;number = 10, name = (null)&#125;</span><br><span class="line">2019-07-30 11:16:53 è¯»æ–‡ä»¶ &lt;NSThread: 0x600001ae8040&gt;&#123;number = 8, name = (null)&#125;</span><br><span class="line">2019-07-30 11:16:53 è¯»æ–‡ä»¶ &lt;NSThread: 0x600001ac3a80&gt;&#123;number = 11, name = (null)&#125;</span><br><span class="line">2019-07-30 11:16:54 å†™å…¥æ–‡ä»¶&lt;NSThread: 0x600001ac3a80&gt;&#123;number = 11, name = (null)&#125;</span><br><span class="line">2019-07-30 11:16:55 å†™å…¥æ–‡ä»¶&lt;NSThread: 0x600001ac3a80&gt;&#123;number = 11, name = (null)&#125;</span><br><span class="line">2019-07-30 11:16:56 å†™å…¥æ–‡ä»¶&lt;NSThread: 0x600001ac3a80&gt;&#123;number = 11, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<p>è¯»æ–‡ä»¶ä¼šå‡ºç°åŒä¸€ç§’è¯»å¤šä¸ªï¼Œå†™æ–‡ä»¶åŒä¸€ç§’åªæœ‰ä¸€ä¸ªã€‚</p>
<p>è¯»å†™ä»»åŠ¡éƒ½æ·»åŠ åˆ°å¼‚æ­¥é˜Ÿåˆ—<code>rwqueue</code>ä¸­ï¼Œä½¿ç”¨æ …æ å‡½æ•°<code>dispatch_barrier_async</code>æ‹¦æˆªä¸€ä¸‹ï¼Œå®ç°è¯»å†™äº’æ–¥ï¼Œè¯»å¯ä»¥å¼‚æ­¥æ— é™è¯»ï¼Œå†™åªèƒ½ä¸€ä¸ªåŒæ­¥å†™çš„åŠŸèƒ½ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li>æ™®é€šçº¿ç¨‹é”æœ¬è´¨å°±æ˜¯åŒæ­¥æ‰§è¡Œ</li>
<li><code>atomic</code>åŸå­æ“ä½œåªé™åˆ¶<code>setter</code>å’Œ<code>getter</code>æ–¹æ³•ï¼Œä¸é™åˆ¶æˆå‘˜å˜é‡</li>
<li>è¯»å†™é”é«˜æ€§èƒ½å¯ä»¥ä½¿ç”¨<code>pthread_rwlock_t</code>å’Œ<code>dispatch_barrier_async</code><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3></li>
<li><a href="https://blog.csdn.net/Fly_as_tadpole/article/details/86436161" target="_blank" rel="noopener">ä¼˜å…ˆçº§åè½¬</a></li>
<li><a href="https://juejin.im/post/5a90de68f265da4e9b592b40#heading-16" target="_blank" rel="noopener">iOSå¤šçº¿ç¨‹ï¼šã€GCDã€è¯¦å°½æ€»ç»“</a></li>
<li><a href="http://www.520it.com/zt/ios_mj/" target="_blank" rel="noopener">å°ç å“¥è§†é¢‘</a></li>
<li><a href="http://awayqu.1024ul.com/ios/2018/05/02/gcd-3.html" target="_blank" rel="noopener">ä»»åŠ¡è°ƒåº¦</a></li>
<li><a href="https://opensource.apple.com/tarballs/libdispatch/" target="_blank" rel="noopener">libdispatch</a></li>
<li>iOSå’ŒOSå¤šçº¿ç¨‹ä¸å†…å­˜ç®¡ç†<h3 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h3></li>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="noopener">å­¦ä¹ èµ„æ–™ä¸‹è½½git</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="noopener">demo code git</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC/objc4-750" target="_blank" rel="noopener">runtimeå¯è¿è¡Œçš„æºç git</a></li>
</ul>
<hr>
<p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p>
<p>å¹¿å‘Šæ—¶é—´</p>
<p><img src="/images/0.png" alt></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOSåº•å±‚åŸç† å¤šçº¿ç¨‹ä¹‹GCD çœ‹æˆ‘å°±å¤Ÿäº† --(10)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyongçš„æŠ€æœ¯åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/01/iOSåº•å±‚åŸç† å¤šçº¿ç¨‹ä¹‹GCD çœ‹æˆ‘å°±å¤Ÿäº† --(10)/" class="post-title-link" itemprop="http://fgyong.cn/index.html">iOSåº•å±‚åŸç†  å¤šçº¿ç¨‹ä¹‹GCDçœ‹æˆ‘å°±å¤Ÿäº† --(10)</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-01 11:20:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:20:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-09-03 16:24:13" itemprop="dateModified" datetime="2020-09-03T16:24:13+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><code>RunLoop</code>å’Œçº¿ç¨‹çš„å…³ç³»ï¼Œä»¥åŠ<code>Thread</code>å¦‚ä½•ä¿æ´»å’Œæ§åˆ¶ç”Ÿå‘½å‘¨æœŸï¼Œä»Šå¤©æˆ‘ä»¬å†æ¢ç©¶ä¸‹å¦å¤–çš„ä¸€ä¸ªçº¿ç¨‹<code>GCD</code>ï¼Œæ­å¼€è’™å¨œä¸½èçš„é¢çº±ã€‚</p>
<h3 id="GCD-åŸºç¡€çŸ¥è¯†"><a href="#GCD-åŸºç¡€çŸ¥è¯†" class="headerlink" title="GCD åŸºç¡€çŸ¥è¯†"></a>GCD åŸºç¡€çŸ¥è¯†</h3><p>GCDæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæˆ‘ä»¬å¼•ç”¨<a href="https://baike.baidu.com/item/GCD" target="_blank" rel="noopener">ç™¾åº¦ç™¾ç§‘</a>çš„ä¸€æ®µè¯ã€‚</p>
<blockquote>
<p>Grand Central Dispatch (GCD)æ˜¯Appleå¼€å‘çš„ä¸€ä¸ªå¤šæ ¸ç¼–ç¨‹çš„è¾ƒæ–°çš„è§£å†³æ–¹æ³•ã€‚å®ƒä¸»è¦ç”¨äºä¼˜åŒ–åº”ç”¨ç¨‹åºä»¥æ”¯æŒå¤šæ ¸å¤„ç†å™¨ä»¥åŠå…¶ä»–å¯¹ç§°å¤šå¤„ç†ç³»ç»Ÿã€‚å®ƒæ˜¯ä¸€ä¸ªåœ¨çº¿ç¨‹æ± æ¨¡å¼çš„åŸºç¡€ä¸Šæ‰§è¡Œçš„å¹¶è¡Œä»»åŠ¡ã€‚åœ¨Mac OS X 10.6é›ªè±¹ä¸­é¦–æ¬¡æ¨å‡ºï¼Œä¹Ÿå¯åœ¨IOS 4åŠä»¥ä¸Šç‰ˆæœ¬ä½¿ç”¨ã€‚</p>
</blockquote>
<p>GCDæœ‰å“ªäº›ä¼˜ç‚¹</p>
<ul>
<li>GCDè‡ªåŠ¨ç®¡ç†çº¿ç¨‹</li>
<li>å¼€å‘è€…åªéœ€è¦å°†taskåŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œä¸ç”¨å…³æ³¨ç»†èŠ‚ï¼Œç„¶åå°†taskæ‰§è¡Œå®Œçš„blockä¼ å…¥å³å¯</li>
<li>GCD è‡ªåŠ¨ç®¡ç†çº¿ç¨‹ï¼Œçº¿ç¨‹åˆ›å»ºï¼ŒæŒ‚èµ·ï¼Œé”€æ¯ã€‚</li>
</ul>
<p>é‚£ä¹ˆæˆ‘ä»¬ç ”ç©¶ä¸‹å¦‚ä½•æ›´å¥½çš„ä½¿ç”¨GCDï¼Œé¦–å…ˆè¦äº†è§£åˆ°ä¸²è¡Œé˜Ÿåˆ—ã€å¹¶è¡Œé˜Ÿåˆ—ã€å¹¶å‘</p>
<h4 id="ä¸²è¡Œé˜Ÿåˆ—"><a href="#ä¸²è¡Œé˜Ÿåˆ—" class="headerlink" title="ä¸²è¡Œé˜Ÿåˆ—"></a>ä¸²è¡Œé˜Ÿåˆ—</h4><p>ä¸²è¡Œæ˜¯åŸºäºé˜Ÿåˆ—çš„ï¼Œé˜Ÿåˆ—ä¼šè‡ªå·±æ§åˆ¶çº¿ç¨‹ï¼Œåœ¨ä¸²è¡Œé˜Ÿåˆ—ä¸­ï¼Œä»»åŠ¡ä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªï¼Œæ‰§è¡Œå®Œå½“å‰ä»»åŠ¡æ‰èƒ½ç»§ç»­æ‰§è¡Œä¸‹ä¸ªä»»åŠ¡ã€‚</p>
<h4 id="å¹¶è¡Œé˜Ÿåˆ—"><a href="#å¹¶è¡Œé˜Ÿåˆ—" class="headerlink" title="å¹¶è¡Œé˜Ÿåˆ—"></a>å¹¶è¡Œé˜Ÿåˆ—</h4><p>å¹¶è¡Œæœ‰é€šè¿‡æ–°å»ºçº¿ç¨‹æ¥å®ç°å¹¶å‘æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶è¡Œé˜Ÿåˆ—ä¸­åŒæ—¶æ˜¯å¯èƒ½æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œå½“å¹¶è¡Œæ•°é‡æ²¡æœ‰é™åˆ¶çš„æ—¶å€™ï¼Œç†è®ºä¸Šæ‰€æœ‰ä»»åŠ¡å¯ä»¥åŒæ—¶æ‰§è¡Œã€‚</p>
<h4 id="å¹¶å‘"><a href="#å¹¶å‘" class="headerlink" title="å¹¶å‘"></a>å¹¶å‘</h4><p>å¹¶å‘æ˜¯åŸºäºçº¿ç¨‹çš„ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹åªèƒ½ä¸²è¡Œ(åŒä¸€æ—¶åˆ»)æ‰§è¡Œï¼Œè¦æƒ³å®ç°å¹¶å‘ï¼Œåªèƒ½å¤šä¸ªçº¿ç¨‹ä¸€èµ·å¹²æ´»</p>
<p><strong>ä¸²è¡Œé˜Ÿåˆ—</strong>ç›¸å½“äºå·¥å‚1æ¡æµæ°´çº¿4ä¸ªå·¥äººç”Ÿäº§è®¾å¤‡ï¼Œä»å¼€å§‹åˆ°ç»“æŸï¼Œä¸€ä¸ªäººåªèƒ½å¹²ä¸€ä»¶äº‹ï¼Œç”²åšAä¸åšBã€‚</p>
<p><strong>å¹¶è¡Œé˜Ÿåˆ—</strong>æ˜¯ä¸€æ¡æµæ°´çº¿4ä¸ªå·¥äººï¼Œå½“å·¥äººå¹²æ´»é€Ÿåº¦ä¸å¤Ÿçš„æ—¶å€™å¯ä»¥å†ç”³è¯·ä¸€æ¡æµæ°´çº¿ï¼Œå®ç°ä¸¤æ¡æµæ°´çº¿åŒæ—¶å¹²æ´»ï¼Œè¿™å°±å®ç°äº†å¹¶å‘ã€‚</p>
<p><strong>å¹¶å‘</strong>æ˜¯å¤šä¸ªæµæ°´çº¿åœ¨åŒæ—¶åŠ å·¥äº§å“ã€‚</p>
<h4 id="GCDä¸­çš„ä¸²è¡Œé˜Ÿåˆ—"><a href="#GCDä¸­çš„ä¸²è¡Œé˜Ÿåˆ—" class="headerlink" title="GCDä¸­çš„ä¸²è¡Œé˜Ÿåˆ—()"></a>GCDä¸­çš„ä¸²è¡Œé˜Ÿåˆ—()</h4><h5 id="ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial-Dispatch-Queueï¼‰ï¼š"><a href="#ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial-Dispatch-Queueï¼‰ï¼š" class="headerlink" title="ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial Dispatch Queueï¼‰ï¼š"></a>ä¸²è¡Œé˜Ÿåˆ—ï¼ˆSerial Dispatch Queueï¼‰ï¼š</h5><p>æŒ‰ç…§<strong>FIFO</strong>(First In First Outå…ˆè¿›å…ˆå‡º)åŸåˆ™ï¼Œå…ˆæ·»åŠ çš„ä»»åŠ¡åœ¨é˜Ÿé¦–ï¼Œåæ·»åŠ çš„ä»»åŠ¡åœ¨é˜Ÿå°¾ï¼Œæ‰§è¡Œä»»åŠ¡çš„æ—¶å€™æŒ‰ç…§é˜Ÿåˆ—çš„ä»é¦–åˆ°å°¾ä¸€ä¸ªæŒ¨ç€ä¸€ä¸ªæ‰§è¡Œï¼Œä¸€æ¬¡åªèƒ½æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼Œä¸å…·å¤‡å¼€è¾Ÿæ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚</p>
<p><img src="/images/10-1.png" alt></p>
<h5 id="å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent-Dispatch-Queueï¼‰ï¼š"><a href="#å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent-Dispatch-Queueï¼‰ï¼š" class="headerlink" title="å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent Dispatch Queueï¼‰ï¼š"></a>å¹¶å‘é˜Ÿåˆ—ï¼ˆConcurrent Dispatch Queueï¼‰ï¼š</h5><p>æŒ‰ç…§<strong>FIFO</strong>(First In First Outå…ˆè¿›å…ˆå‡º)åŸåˆ™ï¼Œå…ˆæ·»åŠ çš„ä»»åŠ¡åœ¨é˜Ÿé¦–ï¼Œåæ·»åŠ çš„ä»»åŠ¡åœ¨é˜Ÿå°¾ï¼Œæ‰§è¡Œä»»åŠ¡çš„æ—¶å€™æŒ‰ç…§é˜Ÿåˆ—çš„ä»é¦–åˆ°è‹¥å¹²ä¸ªï¼Œæ‰§è¡Œåˆ°é˜Ÿå°¾ï¼Œä¸€æ¬¡å¯ä»¥æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œå…·å¤‡å¼€è¾Ÿæ–°çº¿ç¨‹çš„èƒ½åŠ›ã€‚</p>
<p><img src="/images/10-2.png" alt></p>
<h3 id="GCDä½¿ç”¨æ­¥éª¤"><a href="#GCDä½¿ç”¨æ­¥éª¤" class="headerlink" title="GCDä½¿ç”¨æ­¥éª¤"></a>GCDä½¿ç”¨æ­¥éª¤</h3><p>GCDçš„ä½¿ç”¨éå¸¸ç®€å•ï¼Œåˆ›å»ºé˜Ÿåˆ—æˆ–è€…åœ¨å…¨å±€é˜Ÿåˆ—ä¸­æ–°åŠ ä»»åŠ¡å°±å¯ä»¥äº†ã€‚</p>
<p>ä¸‹è¾¹æ¥çœ‹çœ‹ <strong>é˜Ÿåˆ—çš„åˆ›å»ºæ–¹æ³•/è·å–æ–¹æ³•</strong>ï¼Œä»¥åŠ <strong>ä»»åŠ¡çš„åˆ›å»ºæ–¹æ³•</strong>ã€‚</p>
<h4 id="è·å–ä¸»é˜Ÿåˆ—"><a href="#è·å–ä¸»é˜Ÿåˆ—" class="headerlink" title="è·å–ä¸»é˜Ÿåˆ—"></a>è·å–ä¸»é˜Ÿåˆ—</h4><p>ä¸»é˜Ÿåˆ—æ˜¯ä¸€ç§ç‰¹æ®Šçš„é˜Ÿåˆ—ï¼Œä¹Ÿæ˜¯ä¸²è¡Œé˜Ÿåˆ—ï¼Œè´Ÿè´£UIçš„æ›´æ–°ï¼Œä¹Ÿå¯ä»¥åšå…¶ä»–äº‹æƒ…ï¼Œå¯ä»¥é€šè¿‡<code>dispatch_get_main_queue()</code>ï¼Œä¸€èˆ¬å†™çš„ä»£ç æ²¡æœ‰å£°æ˜å¤šçº¿ç¨‹æˆ–è€…æ·»åŠ åˆ°å…¶ä»–é˜Ÿåˆ—ä¸­çš„ä»£ç éƒ½æ˜¯åœ¨ä¸»é˜Ÿåˆ—ä¸­è¿è¡Œçš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//è·å–ä¸»é˜Ÿåˆ—</span><br><span class="line">dispatch_queue_t main_queue= dispatch_get_main_queue();</span><br></pre></td></tr></table></figure>
<h4 id="è·å–å…¨å±€é˜Ÿåˆ—"><a href="#è·å–å…¨å±€é˜Ÿåˆ—" class="headerlink" title="è·å–å…¨å±€é˜Ÿåˆ—"></a>è·å–å…¨å±€é˜Ÿåˆ—</h4><p>å…¨å±€é˜Ÿåˆ—æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¹¶è¡Œé˜Ÿåˆ—ï¼Œç³»ç»Ÿå·²ç»åˆ›å»ºå¥½äº†ï¼Œä½¿ç”¨çš„æ—¶å€™é€šè¿‡<code>dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0)</code>,ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>identifier</code>ï¼Œè¡¨ç¤ºé˜Ÿåˆ—çš„ä¼˜å…ˆçº§ï¼Œä¸€èˆ¬ä¼ å…¥<code>DISPATCH_QUEUE_PRIORITY_DEFAULT</code>ï¼Œç¬¬äºŒä¸ªå‚æ•°<code>flags</code>ï¼Œå®˜æ–¹è¯´æ³•æ˜¯å¿…é¡»æ˜¯0ï¼Œå¦åˆ™è¿”å›NULLã€‚æš‚ä¸”ä¼ å…¥0ã€‚ä¸‹è¾¹æ‘˜è‡ª<a href="https://opensource.apple.com/tarballs/libdispatch/" target="_blank" rel="noopener">libdispatch</a></p>
<blockquote>
<p>Use the<br>.Fn dispatch_get_global_queue<br>function to obtain the global queue of given priority. The<br>.Fa flags<br>argument is reserved for future use and must be zero. Passing any value other<br>than zero may result in a NULL return value.</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">//è·å–å…¨å±€é˜Ÿåˆ—</span><br><span class="line">dispatch_queue_t main_queue= dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br></pre></td></tr></table></figure>
<h4 id="ä»»åŠ¡çš„åˆ›å»º"><a href="#ä»»åŠ¡çš„åˆ›å»º" class="headerlink" title="ä»»åŠ¡çš„åˆ›å»º"></a>ä»»åŠ¡çš„åˆ›å»º</h4><p>GCD æä¾›äº†åŒæ­¥æ‰§è¡Œä»»åŠ¡çš„åˆ›å»ºæ–¹æ³•<code>dispatch_sync</code>å’Œå¼‚æ­¥æ‰§è¡Œä»»åŠ¡åˆ›å»ºæ–¹æ³•çš„<code>spatch_async</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">// åŒæ­¥æ‰§è¡Œä»»åŠ¡åˆ›å»ºæ–¹æ³•</span><br><span class="line">dispatch_sync(queue, ^&#123;</span><br><span class="line">    // è¿™é‡Œæ”¾åŒæ­¥æ‰§è¡Œä»»åŠ¡ä»£ç </span><br><span class="line">&#125;);</span><br><span class="line">// å¼‚æ­¥æ‰§è¡Œä»»åŠ¡åˆ›å»ºæ–¹æ³•</span><br><span class="line">dispatch_async(queue, ^&#123;</span><br><span class="line">    // è¿™é‡Œæ”¾å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ä»£ç </span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>è™½ç„¶æ˜¯åªæœ‰åŒæ­¥å¼‚æ­¥ä½†æ˜¯ä»–ä»¬ç»„åˆçš„å¤šå˜çš„</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">å¹¶å‘é˜Ÿåˆ—</th>
<th style="text-align:center">åˆ›å»ºçš„ä¸²è¡Œé˜Ÿåˆ—</th>
<th style="text-align:center">ä¸»é˜Ÿåˆ—</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">åŒæ­¥(sync)</td>
<td style="text-align:center">æ²¡å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œ</td>
<td style="text-align:center">æ²¡å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td>
<td style="text-align:center">æ²¡å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td>
</tr>
<tr>
<td style="text-align:center">å¼‚æ­¥(async)</td>
<td style="text-align:center">èƒ½å¼€å¯æ–°çº¿ç¨‹ï¼Œå¹¶å‘æ‰§è¡Œ</td>
<td style="text-align:center">èƒ½å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td>
<td style="text-align:center">æ²¡å¼€å¯æ–°çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡</td>
</tr>
</tbody>
</table>
<h3 id="GCDçš„ä½¿ç”¨"><a href="#GCDçš„ä½¿ç”¨" class="headerlink" title="GCDçš„ä½¿ç”¨"></a>GCDçš„ä½¿ç”¨</h3><h4 id="ä¸»é˜Ÿåˆ—-åŒæ­¥"><a href="#ä¸»é˜Ÿåˆ—-åŒæ­¥" class="headerlink" title="ä¸»é˜Ÿåˆ—+åŒæ­¥"></a>ä¸»é˜Ÿåˆ—+åŒæ­¥</h4><p>åœ¨ä¸»é˜Ÿåˆ—ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œå¹¶åŒæ­¥æ·»åŠ ä»»åŠ¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//ä¸»é˜Ÿåˆ—+åŒæ­¥</span><br><span class="line">-(void)syn_main&#123;</span><br><span class="line">	NSLog(@&quot;1&quot;);</span><br><span class="line">	dispatch_queue_t main_queue = dispatch_get_main_queue();</span><br><span class="line">	dispatch_sync(main_queue, ^&#123;</span><br><span class="line">		NSLog(@&quot;2&quot;);</span><br><span class="line">	&#125;);</span><br><span class="line">	NSLog(@&quot;3&quot;);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
<p>çœ‹åˆ°æ—¥å¿—åªè¾“å‡ºäº†1å°±å´©æºƒäº†æç¤º<code>exc_bad_instuction</code>,ä¸ºä»€ä¹ˆå‡ºé—®é¢˜å‘¢ï¼Ÿ<br>ä¸»é˜Ÿåˆ—æ˜¯åŒæ­¥çš„ï¼Œä»»åŠ¡å‰åæ‰§è¡Œçš„ä»»åŠ¡æ˜¯åœ¨ä¸»é˜Ÿåˆ—ä¸­ï¼Œæ·»åŠ çš„ä»»åŠ¡ä¹Ÿæ˜¯åœ¨ä¸»é˜Ÿåˆ—ä¸­ï¼Œè€Œä¸”æ·»åŠ æ˜¯åŒæ­¥æ·»åŠ ã€‚<br><strong>what</strong>???åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­æ·»åŠ åŒæ­¥ä»»åŠ¡ï¼Œåˆ°åº•æ˜¯æƒ³è®©é˜Ÿåˆ—æ‰§è¡Œä»»åŠ¡è¿˜æ˜¯æ·»åŠ ä»»åŠ¡ã€‚é˜Ÿåˆ—éµå¾ªFIFOåŸåˆ™ï¼Œå‡å¦‚è¦å¤§å®¶éƒ½åœ¨æ’é˜Ÿç­‰æ‰“é¥­ï¼Œæ–°æ¥çš„å‘˜å·¥å«çš„A,åè¾¹ä»£ç å«B,ç„¶åéƒ½åœ¨ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œçªç„¶æ¥äº†ä¸ªæ’é˜Ÿçš„ï¼Œä½ è¯´Bèƒ½åŒæ„å—ï¼Ÿæ˜æ˜¾å’ŒAå¹²èµ·æ¥äº†ï¼Œç»“æœç³»ç»Ÿè€å¸ˆè¿‡æ¥æ‹‰æ¶äº†è¯´äº†ä¸€å¥<code>exc_bad_instuction</code>ï¼Œæ„æ€æ˜¯ä½ ä¿©åµèµ·æ¥å¤§å®¶éƒ½åƒä¸ä¸Šé¥­äº†ï¼Œç»“æœä»–ä¿©è¿˜æ˜¯æ¥ç€åµï¼ŒæŠŠç³»ç»Ÿåµå´©æºƒäº†ã€‚<br>é‚£ä¹ˆæˆ‘ä»¬èƒ½åœ¨ä¸»é˜Ÿåˆ—ä¸­åŒæ­¥æ·»åŠ ä»»åŠ¡å—ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ã€‚çœ‹åˆ°ç­”æ¡ˆä¸è¦ç¬‘å“¦</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//ä¸»é˜Ÿåˆ—+åŒæ­¥</span><br><span class="line">-(void)syn_main2&#123;</span><br><span class="line">	NSLog(@&quot;1ä»»åŠ¡æ‰§è¡Œ&quot;);</span><br><span class="line">	sleep(1);</span><br><span class="line">	NSLog(@&quot;2ä»»åŠ¡æ‰§è¡Œ&quot;);</span><br><span class="line">	sleep(1);</span><br><span class="line">	NSLog(@&quot;3ä»»åŠ¡æ‰§è¡Œ&quot;);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">1ä»»åŠ¡æ‰§è¡Œ</span><br><span class="line">2ä»»åŠ¡æ‰§è¡Œ</span><br><span class="line">3ä»»åŠ¡æ‰§è¡Œ</span><br></pre></td></tr></table></figure>
<p>æ²¡çœ‹é”™ï¼Œä¿è¯åœ¨ä¸»é˜Ÿåˆ—ä¸­è°ƒç”¨è¯¥å‡½æ•°ï¼Œé‚£ä¹ˆä»–å°±æ˜¯ä¸»é˜Ÿåˆ—åŒæ­¥æ‰§è¡Œçš„,å¦‚æœåœ¨å…¶ä»–é˜Ÿåˆ—ä¸­è°ƒç”¨ï¼Œé‚£å®ƒåˆ™æ˜¯åœ¨è°ƒç”¨è€…é˜Ÿåˆ—ä¸­åŒæ­¥æ‰§è¡Œã€‚</p>
<h4 id="ä¸»é˜Ÿåˆ—-å¼‚æ­¥"><a href="#ä¸»é˜Ÿåˆ—-å¼‚æ­¥" class="headerlink" title="ä¸»é˜Ÿåˆ—+å¼‚æ­¥"></a>ä¸»é˜Ÿåˆ—+å¼‚æ­¥</h4><p>åœ¨ä¸»é˜Ÿåˆ—ä¸­å¼‚æ­¥æ·»åŠ ä»»åŠ¡å¹¶æ‰§è¡Œä»»åŠ¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">//ä¸»é˜Ÿåˆ—+å¼‚æ­¥</span><br><span class="line">	NSLog(@&quot;start&quot;);</span><br><span class="line">	dispatch_queue_t main_queue = dispatch_get_main_queue();</span><br><span class="line">	dispatch_async(main_queue, ^&#123;</span><br><span class="line">		for (int i = 0; i &lt; 3; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			NSLog(@&quot;%@ %d&quot;,[NSThread currentThread],i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_async(main_queue, ^&#123;</span><br><span class="line">		for (int i = 3; i &lt; 6; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			NSLog(@&quot;%@ %d&quot;,[NSThread currentThread],i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_async(main_queue, ^&#123;</span><br><span class="line">		for (int i = 7; i &lt; 10; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			NSLog(@&quot;%@ %d&quot;,[NSThread currentThread],i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	NSLog(@&quot;end&quot;);</span><br><span class="line">//log</span><br><span class="line">2019-07-24 15:12:24.73 start</span><br><span class="line">2019-07-24 15:12:24.73 end</span><br><span class="line"></span><br><span class="line">&lt;NSThread: 0x600002f9a940&gt;&#123;number = 1, name = main&#125; 0</span><br><span class="line">2019-07-24 15:18:14.971795+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number = 1, name = main&#125; 1</span><br><span class="line">2019-07-24 15:18:15.972421+0800 day15-GCDo[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number = 1, name = main&#125; 2</span><br><span class="line">2019-07-24 15:18:16.973529+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number = 1, name = main&#125; 3</span><br><span class="line">2019-07-24 15:18:17.974978+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number = 1, name = main&#125; 4</span><br><span class="line">2019-07-24 15:18:18.975800+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number = 1, name = main&#125; 5</span><br><span class="line">2019-07-24 15:18:19.977185+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number = 1, name = main&#125; 7</span><br><span class="line">2019-07-24 15:18:20.978615+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number = 1, name = main&#125; 8</span><br><span class="line">2019-07-24 15:18:21.979958+0800 day15-GCD[31837:35880409] &lt;NSThread: 0x600002f9a940&gt;&#123;number = 1, name = main&#125; 9</span><br></pre></td></tr></table></figure>
<p>åœ¨ä¸»é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œä»»åŠ¡ï¼Œä»æ—¥å¿—çœ‹å‡ºæ¥<code>end</code>æ—©äºä»»åŠ¡çš„æ‰§è¡Œï¼Œç¬¦åˆFIFOåŸåˆ™ï¼Œéƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œå¯ä»¥çœ‹åˆ°</p>
<ul>
<li>ä¸»çº¿ç¨‹å¤šä¸ªä»»åŠ¡å¼‚æ­¥ä¸èƒ½åˆ›å»ºæ–°çº¿ç¨‹</li>
<li>ä¸»çº¿ç¨‹å¼‚æ­¥ä¹Ÿæ˜¯ä¸²è¡Œæ‰§è¡Œ</li>
</ul>
<h4 id="å…¨å±€é˜Ÿåˆ—-åŒæ­¥"><a href="#å…¨å±€é˜Ÿåˆ—-åŒæ­¥" class="headerlink" title="å…¨å±€é˜Ÿåˆ—+åŒæ­¥"></a>å…¨å±€é˜Ÿåˆ—+åŒæ­¥</h4><p>å…¨å±€é˜Ÿåˆ—æ˜¯å¹¶è¡Œé˜Ÿåˆ—ï¼Œå’ŒåŒæ­¥é…åˆå°±æ˜¯ä¸²è¡Œæ‰§è¡Œäº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//å…¨å±€é˜Ÿåˆ—+åŒæ­¥</span><br><span class="line">-(void)sync_global&#123;</span><br><span class="line">	printf(&quot;\n start&quot;);</span><br><span class="line">	dispatch_queue_t global_queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">	dispatch_sync(global_queue, ^&#123;</span><br><span class="line">		for (int i = 0; i &lt; 3; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_sync(global_queue, ^&#123;</span><br><span class="line">		for (int i = 3; i &lt; 6; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_sync(global_queue, ^&#123;</span><br><span class="line">		NSThread *thread = [NSThread currentThread];</span><br><span class="line">		for (int i = 7; i &lt; 10; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,thread.description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	printf(&quot;\n end&quot;);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">start</span><br><span class="line"> 2019-07-24 15:35:36 &lt;NSThread: 0x600000592900&gt;&#123;number = 1, name = main&#125; 0</span><br><span class="line"> 2019-07-24 15:35:37 &lt;NSThread: 0x600000592900&gt;&#123;number = 1, name = main&#125; 1</span><br><span class="line"> 2019-07-24 15:35:38 &lt;NSThread: 0x600000592900&gt;&#123;number = 1, name = main&#125; 2</span><br><span class="line"> 2019-07-24 15:35:39 &lt;NSThread: 0x600000592900&gt;&#123;number = 1, name = main&#125; 3</span><br><span class="line"> 2019-07-24 15:35:40 &lt;NSThread: 0x600000592900&gt;&#123;number = 1, name = main&#125; 4</span><br><span class="line"> 2019-07-24 15:35:41 &lt;NSThread: 0x600000592900&gt;&#123;number = 1, name = main&#125; 5</span><br><span class="line"> 2019-07-24 15:35:42 &lt;NSThread: 0x600000592900&gt;&#123;number = 1, name = main&#125; 7</span><br><span class="line"> 2019-07-24 15:35:43 &lt;NSThread: 0x600000592900&gt;&#123;number = 1, name = main&#125; 8</span><br><span class="line"> 2019-07-24 15:35:44 &lt;NSThread: 0x600000592900&gt;&#123;number = 1, name = main&#125; 9</span><br><span class="line"> end</span><br></pre></td></tr></table></figure>
<p>åœ¨å…¨å±€é˜Ÿåˆ—ä¸­ä½¿ç”¨ä¸²è¡Œæ·»åŠ å¤šä¸ªä»»åŠ¡å¹¶æ²¡æœ‰æ–°å»ºå­çº¿ç¨‹æ¥è§£å†³é—®é¢˜ï¼ŒåŒæ­¥å…¶å®å°±æ˜¯ä¸²è¡Œï¼Œä½¿ç”¨FIFOåŸåˆ™ï¼Œä¸€ä¸ªä»»åŠ¡è§£å†³å®Œå†è§£å†³ä¸‹ä¸€ä¸ªä»»åŠ¡ã€‚</p>
<h4 id="å…¨å±€é˜Ÿåˆ—-å¼‚æ­¥"><a href="#å…¨å±€é˜Ÿåˆ—-å¼‚æ­¥" class="headerlink" title="å…¨å±€é˜Ÿåˆ—+å¼‚æ­¥"></a>å…¨å±€é˜Ÿåˆ—+å¼‚æ­¥</h4><p>å…¨å±€é˜Ÿåˆ—æœ‰åˆ›å»ºå­çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä½†æ˜¯éœ€è¦å¼‚æ­¥<code>async</code>å»æ‰§è¡Œã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">//å…¨å±€é˜Ÿåˆ—+å¼‚æ­¥</span><br><span class="line">-(void)async_global&#123;</span><br><span class="line">	printf(&quot;\n start&quot;);</span><br><span class="line">	dispatch_queue_t global_queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">	dispatch_async(global_queue, ^&#123;</span><br><span class="line">		for (int i = 0; i &lt; 3; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_async(global_queue, ^&#123;</span><br><span class="line">		for (int i = 3; i &lt; 6; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_async(global_queue, ^&#123;</span><br><span class="line">		NSThread *thread = [NSThread currentThread];</span><br><span class="line">		for (int i = 7; i &lt; 10; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,thread.description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	printf(&quot;\n end&quot;);</span><br><span class="line">&#125;</span><br><span class="line">-(NSString *)currentDateString&#123;</span><br><span class="line">	NSDate *date=[NSDate new];</span><br><span class="line">	NSDateFormatter *format = [[NSDateFormatter alloc]init];</span><br><span class="line">	[format setDateFormat:@&quot;yyyy-MM-dd HH:mm:ss&quot;];</span><br><span class="line">	return [format stringFromDate:date];</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line"> start</span><br><span class="line"> end</span><br><span class="line"> 2019-07-24 15:40:21 &lt;NSThread: 0x600003b43dc0&gt;&#123;number = 5, name = (null)&#125; 3</span><br><span class="line"> 2019-07-24 15:40:21 &lt;NSThread: 0x600003b44e80&gt;&#123;number = 4, name = (null)&#125; 0</span><br><span class="line"> 2019-07-24 15:40:21 &lt;NSThread: 0x600003b45880&gt;&#123;number = 3, name = (null)&#125; 7</span><br><span class="line"> 2019-07-24 15:40:22 &lt;NSThread: 0x600003b44e80&gt;&#123;number = 4, name = (null)&#125; 1</span><br><span class="line"> 2019-07-24 15:40:22 &lt;NSThread: 0x600003b45880&gt;&#123;number = 3, name = (null)&#125; 8</span><br><span class="line"> 2019-07-24 15:40:22 &lt;NSThread: 0x600003b43dc0&gt;&#123;number = 5, name = (null)&#125; 4</span><br><span class="line"> 2019-07-24 15:40:23 &lt;NSThread: 0x600003b45880&gt;&#123;number = 3, name = (null)&#125; 9</span><br><span class="line"> 2019-07-24 15:40:23 &lt;NSThread: 0x600003b44e80&gt;&#123;number = 4, name = (null)&#125; 2</span><br><span class="line"> 2019-07-24 15:40:23 &lt;NSThread: 0x600003b43dc0&gt;&#123;number = 5, name = (null)&#125; 5</span><br></pre></td></tr></table></figure>
<p>å…¨å±€é˜Ÿåˆ—å½“æ­é…<code>async</code>çš„æ—¶å€™ï¼Œè¿½åŠ å¤šä¸ªä»»åŠ¡ï¼Œè¿™æ¬¡æ˜¯ä½¿ç”¨3ä¸ªçº¿ç¨‹ï¼Œè€Œä¸”ä¸ç”¨æˆ‘ä»¬æ¥ç»´æŠ¤çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸï¼Œè€Œä¸”æ‰§è¡Œçš„é¡ºåºæ˜¯æ— åºçš„ã€‚</p>
<h4 id="åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—-åŒæ­¥"><a href="#åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—-åŒæ­¥" class="headerlink" title="åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+åŒæ­¥"></a>åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+åŒæ­¥</h4><p>å¼€å‘è€…è‡ªå·±åˆ›å»ºçš„ä¸²è¡Œé˜Ÿåˆ—åŒæ­¥è°ƒç”¨å’Œç³»ç»Ÿä¸»é˜Ÿåˆ—æœ‰ç±»ä¼¼çš„åœ°æ–¹ï¼Œä¹Ÿæœ‰åŒºåˆ«ã€‚ä¸€æ ·éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œï¼ŒåŒºåˆ«æ˜¯è¿½åŠ ä»»åŠ¡çš„æ—¶å€™ä¸€èˆ¬æ˜¯åœ¨ä¸»é˜Ÿåˆ—å‘ä¸²è¡Œé˜Ÿåˆ—æ·»åŠ ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">//åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+åŒæ­¥</span><br><span class="line">-(void)sync_cust_queue&#123;</span><br><span class="line">	printf(&quot;\n start&quot;);</span><br><span class="line">	dispatch_queue_t custQueue = dispatch_queue_create(&quot;cust-queue&quot;, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">	dispatch_sync(custQueue, ^&#123;</span><br><span class="line">		for (int i = 0; i &lt; 3; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_sync(custQueue, ^&#123;</span><br><span class="line">		for (int i = 3; i &lt; 6; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_sync(custQueue, ^&#123;</span><br><span class="line">		NSThread *thread = [NSThread currentThread];</span><br><span class="line">		for (int i = 7; i &lt; 10; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,thread.description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	printf(&quot;\n end&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">start</span><br><span class="line"> 2019-07-24 15:53:15 &lt;NSThread: 0x6000017ea940&gt;&#123;number = 1, name = main&#125; 0</span><br><span class="line"> 2019-07-24 15:53:16 &lt;NSThread: 0x6000017ea940&gt;&#123;number = 1, name = main&#125; 1</span><br><span class="line"> 2019-07-24 15:53:17 &lt;NSThread: 0x6000017ea940&gt;&#123;number = 1, name = main&#125; 2</span><br><span class="line"> 2019-07-24 15:53:18 &lt;NSThread: 0x6000017ea940&gt;&#123;number = 1, name = main&#125; 3</span><br><span class="line"> 2019-07-24 15:53:19 &lt;NSThread: 0x6000017ea940&gt;&#123;number = 1, name = main&#125; 4</span><br><span class="line"> 2019-07-24 15:53:20 &lt;NSThread: 0x6000017ea940&gt;&#123;number = 1, name = main&#125; 5</span><br><span class="line"> 2019-07-24 15:53:21 &lt;NSThread: 0x6000017ea940&gt;&#123;number = 1, name = main&#125; 7</span><br><span class="line"> 2019-07-24 15:53:22 &lt;NSThread: 0x6000017ea940&gt;&#123;number = 1, name = main&#125; 8</span><br><span class="line"> 2019-07-24 15:53:23 &lt;NSThread: 0x6000017ea940&gt;&#123;number = 1, name = main&#125; 9</span><br><span class="line"> end</span><br></pre></td></tr></table></figure>
<p>åŒæ­¥å‘ä¸²è¡Œé˜Ÿåˆ—æ·»åŠ ä»»åŠ¡å¹¶æ²¡æœ‰æ­»é”ï¼åŸå› æ˜¯æ·»åŠ ä»»åŠ¡æ˜¯åœ¨<code>main_queue</code>æ‰§è¡Œçš„ï¼Œæ·»åŠ çš„ä»»åŠ¡æ˜¯åœ¨<code>cust-queue</code>ä¸­æ‰§è¡Œï¼Œç¬¦åˆFIFOåŸåˆ™ï¼Œå…ˆæ·»åŠ çš„å…ˆæ‰§è¡Œï¼Œå…·ä½“æ‰§è¡Œçš„çº¿ç¨‹ç”±ä»–ä»¬è‡ªå·±åˆ†é…ã€‚æ‰§è¡Œçš„ä»»åŠ¡æ˜¯åœ¨<code>main</code>çº¿ç¨‹ä¸­ã€‚</p>
<h4 id="åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—-å¼‚æ­¥"><a href="#åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—-å¼‚æ­¥" class="headerlink" title="åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+å¼‚æ­¥"></a>åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+å¼‚æ­¥</h4><p>ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œä½†æ˜¯å› ä¸ºä»»åŠ¡æ˜¯ä¸²è¡Œçš„ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">//åˆ›å»ºä¸²è¡Œé˜Ÿåˆ—+å¼‚æ­¥</span><br><span class="line">-(void)async_cust_queue&#123;</span><br><span class="line">	printf(&quot;\n start&quot;);</span><br><span class="line">	dispatch_queue_t custQueue = dispatch_queue_create(&quot;cust-queue&quot;, DISPATCH_QUEUE_SERIAL);</span><br><span class="line">	dispatch_async(custQueue, ^&#123;</span><br><span class="line">		for (int i = 0; i &lt; 3; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_async(custQueue, ^&#123;</span><br><span class="line">		for (int i = 3; i &lt; 6; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_async(custQueue, ^&#123;</span><br><span class="line">		NSThread *thread = [NSThread currentThread];</span><br><span class="line">		for (int i = 7; i &lt; 10; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,thread.description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	printf(&quot;\n end&quot;);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line"> start</span><br><span class="line"> end</span><br><span class="line"> 2019-07-24 16:12:57 &lt;NSThread: 0x600002b346c0&gt;&#123;number = 3, name = (null)&#125; 0</span><br><span class="line"> 2019-07-24 16:12:58 &lt;NSThread: 0x600002b346c0&gt;&#123;number = 3, name = (null)&#125; 1</span><br><span class="line"> 2019-07-24 16:12:59 &lt;NSThread: 0x600002b346c0&gt;&#123;number = 3, name = (null)&#125; 2</span><br><span class="line"> 2019-07-24 16:13:00 &lt;NSThread: 0x600002b346c0&gt;&#123;number = 3, name = (null)&#125; 3</span><br><span class="line"> 2019-07-24 16:13:01 &lt;NSThread: 0x600002b346c0&gt;&#123;number = 3, name = (null)&#125; 4</span><br><span class="line"> 2019-07-24 16:13:02 &lt;NSThread: 0x600002b346c0&gt;&#123;number = 3, name = (null)&#125; 5</span><br><span class="line"> 2019-07-24 16:13:03 &lt;NSThread: 0x600002b346c0&gt;&#123;number = 3, name = (null)&#125; 7</span><br><span class="line"> 2019-07-24 16:13:04 &lt;NSThread: 0x600002b346c0&gt;&#123;number = 3, name = (null)&#125; 8</span><br><span class="line"> 2019-07-24 16:13:05 &lt;NSThread: 0x600002b346c0&gt;&#123;number = 3, name = (null)&#125; 9</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>å¼‚æ­¥ + ä¸²è¡Œé˜Ÿåˆ—</code>å¯ä»¥çœ‹åˆ°ï¼š</p>
<p>å¼€å¯äº†ä¸€æ¡æ–°çº¿ç¨‹ï¼ˆå¼‚æ­¥æ‰§è¡Œå…·å¤‡å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä¸²è¡Œé˜Ÿåˆ—åªå¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼‰ã€‚<br>æ‰€æœ‰ä»»åŠ¡æ˜¯åœ¨æ‰“å°çš„<code>end</code>ä¹‹åæ‰å¼€å§‹æ‰§è¡Œçš„ï¼ˆå¼‚æ­¥æ‰§è¡Œä¸ä¼šåšä»»ä½•ç­‰å¾…ï¼Œå¯ä»¥ç»§ç»­æ‰§è¡Œä»»åŠ¡ï¼‰ã€‚<br>ä»»åŠ¡æ˜¯æŒ‰é¡ºåºæ‰§è¡Œçš„ï¼ˆä¸²è¡Œé˜Ÿåˆ—æ¯æ¬¡åªæœ‰ä¸€ä¸ªä»»åŠ¡è¢«æ‰§è¡Œï¼Œä»»åŠ¡ä¸€ä¸ªæ¥ä¸€ä¸ªæŒ‰é¡ºåºæ‰§è¡Œï¼‰ã€‚</p>
<h4 id="åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—-åŒæ­¥"><a href="#åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—-åŒæ­¥" class="headerlink" title="åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—+åŒæ­¥"></a>åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—+åŒæ­¥</h4><p>åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¸ä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œæ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡ï¼Œå†æ‰§è¡Œä¸‹ä¸€ä¸ªä»»åŠ¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">start</span><br><span class="line">2019-07-24 16:21:24 &lt;NSThread: 0x6000031d1380&gt;&#123;number = 1, name = main&#125; 0</span><br><span class="line">2019-07-24 16:21:25 &lt;NSThread: 0x6000031d1380&gt;&#123;number = 1, name = main&#125; 1</span><br><span class="line">2019-07-24 16:21:26 &lt;NSThread: 0x6000031d1380&gt;&#123;number = 1, name = main&#125; 2</span><br><span class="line">2019-07-24 16:21:27 &lt;NSThread: 0x6000031d1380&gt;&#123;number = 1, name = main&#125; 3</span><br><span class="line">2019-07-24 16:21:28 &lt;NSThread: 0x6000031d1380&gt;&#123;number = 1, name = main&#125; 4</span><br><span class="line">2019-07-24 16:21:29 &lt;NSThread: 0x6000031d1380&gt;&#123;number = 1, name = main&#125; 5</span><br><span class="line">2019-07-24 16:21:30 &lt;NSThread: 0x6000031d1380&gt;&#123;number = 1, name = main&#125; 7</span><br><span class="line">2019-07-24 16:21:31 &lt;NSThread: 0x6000031d1380&gt;&#123;number = 1, name = main&#125; 8</span><br><span class="line">2019-07-24 16:21:32 &lt;NSThread: 0x6000031d1380&gt;&#123;number = 1, name = main&#125; 9</span><br><span class="line">end</span><br></pre></td></tr></table></figure>
<p>å…¨å±€é˜Ÿåˆ—å…¶å®å°±æ˜¯ç‰¹æ®Šçš„å¹¶è¡Œé˜Ÿåˆ—ï¼Œè¿™é‡Œç»“æœå’Œ<code>å…¨å±€é˜Ÿåˆ—+åŒæ­¥</code>ä¸€è‡´ã€‚</p>
<h4 id="åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—-å¼‚æ­¥"><a href="#åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—-å¼‚æ­¥" class="headerlink" title="åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—+å¼‚æ­¥"></a>åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—+å¼‚æ­¥</h4><p>åœ¨å½“å‰çº¿ç¨‹ä¸­æ‰§è¡Œä»»åŠ¡ï¼Œä¼šå¼€å¯æ–°çº¿ç¨‹ï¼Œå¯ä»¥åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">//åˆ›å»ºå¹¶è¡Œé˜Ÿåˆ—+å¼‚æ­¥</span><br><span class="line">-(void)async_queue&#123;</span><br><span class="line">	printf(&quot;\n start&quot;);</span><br><span class="line">	dispatch_queue_t custQueue = dispatch_queue_create(&quot;cust-queue&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">	dispatch_async(custQueue, ^&#123;</span><br><span class="line">		for (int i = 0; i &lt; 3; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_async(custQueue, ^&#123;</span><br><span class="line">		for (int i = 3; i &lt; 6; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_async(custQueue, ^&#123;</span><br><span class="line">		NSThread *thread = [NSThread currentThread];</span><br><span class="line">		for (int i = 7; i &lt; 10; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,thread.description.UTF8String,i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	printf(&quot;\n end&quot;);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">start</span><br><span class="line"> end</span><br><span class="line"> 2019-07-24 16:22:09 &lt;NSThread: 0x6000004280c0&gt;&#123;number = 3, name = (null)&#125; 7</span><br><span class="line"> 2019-07-24 16:22:09 &lt;NSThread: 0x6000004104c0&gt;&#123;number = 5, name = (null)&#125; 0</span><br><span class="line"> 2019-07-24 16:22:09 &lt;NSThread: 0x600000422300&gt;&#123;number = 4, name = (null)&#125; 3</span><br><span class="line"> 2019-07-24 16:22:10 &lt;NSThread: 0x6000004104c0&gt;&#123;number = 5, name = (null)&#125; 1</span><br><span class="line"> 2019-07-24 16:22:10 &lt;NSThread: 0x6000004280c0&gt;&#123;number = 3, name = (null)&#125; 8</span><br><span class="line"> 2019-07-24 16:22:10 &lt;NSThread: 0x600000422300&gt;&#123;number = 4, name = (null)&#125; 4</span><br><span class="line"> 2019-07-24 16:22:11 &lt;NSThread: 0x6000004280c0&gt;&#123;number = 3, name = (null)&#125; 9</span><br><span class="line"> 2019-07-24 16:22:11 &lt;NSThread: 0x6000004104c0&gt;&#123;number = 5, name = (null)&#125; 2</span><br><span class="line"> 2019-07-24 16:22:11 &lt;NSThread: 0x600000422300&gt;&#123;number = 4, name = (null)&#125; 5</span><br></pre></td></tr></table></figure>
<p><code>å¹¶è¡Œé˜Ÿåˆ—+å¼‚æ­¥</code>å’Œ<code>å…¨å±€é˜Ÿåˆ—+å¼‚æ­¥</code>ä¸€è‡´ï¼Œä¹Ÿä¼šæ–°å»ºçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œä¸”æ˜¯å¹¶å‘æ‰§è¡Œã€‚</p>
<h3 id="GCDå…¶ä»–é«˜çº§ç”¨æ³•"><a href="#GCDå…¶ä»–é«˜çº§ç”¨æ³•" class="headerlink" title="GCDå…¶ä»–é«˜çº§ç”¨æ³•"></a>GCDå…¶ä»–é«˜çº§ç”¨æ³•</h3><h4 id="å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡-ä¸»çº¿ç¨‹åˆ·æ–°UI"><a href="#å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡-ä¸»çº¿ç¨‹åˆ·æ–°UI" class="headerlink" title="å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ ä¸»çº¿ç¨‹åˆ·æ–°UI"></a>å­çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ ä¸»çº¿ç¨‹åˆ·æ–°UI</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">- (void)backToMain&#123;</span><br><span class="line">	dispatch_queue_t main = dispatch_get_main_queue();</span><br><span class="line">	dispatch_queue_t glo = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">	dispatch_async(glo, ^&#123;</span><br><span class="line">		for (int i = 0; i &lt; 3; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">		&#125;</span><br><span class="line">		dispatch_sync(main, ^&#123;</span><br><span class="line">			printf(&quot;\n %s %s æˆ‘åœ¨åˆ·æ–°UI&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;);	</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line"> 2019-07-24 16:45:07 &lt;NSThread: 0x600001e84380&gt;&#123;number = 3, name = (null)&#125; 0</span><br><span class="line"> 2019-07-24 16:45:08 &lt;NSThread: 0x600001e84380&gt;&#123;number = 3, name = (null)&#125; 1</span><br><span class="line"> 2019-07-24 16:45:09 &lt;NSThread: 0x600001e84380&gt;&#123;number = 3, name = (null)&#125; 2</span><br><span class="line"> 2019-07-24 16:45:09 &lt;NSThread: 0x600001ef2940&gt;&#123;number = 1, name = main&#125; æˆ‘åœ¨åˆ·æ–°UI</span><br></pre></td></tr></table></figure>
<h4 id="é˜Ÿåˆ—åˆ†ç»„-dispatch-group-t"><a href="#é˜Ÿåˆ—åˆ†ç»„-dispatch-group-t" class="headerlink" title="é˜Ÿåˆ—åˆ†ç»„ dispatch_group_t"></a>é˜Ÿåˆ—åˆ†ç»„ dispatch_group_t</h4><h5 id="dispatch-group-notify"><a href="#dispatch-group-notify" class="headerlink" title="dispatch_group_notify"></a>dispatch_group_notify</h5><p>GCDæœ‰æœ‰åˆ†ç»„çš„æ¦‚å¿µï¼Œå½“æ‰€æœ‰åŠ å…¥åˆ†ç»„çš„é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæˆçš„æ—¶å€™ï¼Œé€šè¿‡<code>dispatch_group_notify</code>å®Œæˆå›è°ƒï¼Œç¬¬ä¸€ä¸ªå‚æ•°<code>group</code>æ˜¯æŸä¸ªåˆ†ç»„çš„å›è°ƒã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">-(void)group&#123;</span><br><span class="line">	dispatch_group_t group = dispatch_group_create();</span><br><span class="line">	dispatch_queue_t queue= dispatch_queue_create(&quot;cust.queue.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">	dispatch_queue_t queue2= dispatch_queue_create(&quot;cust2.queue.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">	dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">		for (int i = 0; i &lt; 3; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_group_async(group, queue2, ^&#123;</span><br><span class="line">		for (int i = 4; i &lt; 6; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</span><br><span class="line">		printf(&quot;\n %s %s ---end1----&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">		for (int i = 6; i &lt; 8; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_group_async(group, queue2, ^&#123;</span><br><span class="line">		for (int i = 8; i &lt; 10; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="dispatch-group-wait-amp-amp-dispatch-group-enter-amp-amp-dispatch-group-leave"><a href="#dispatch-group-wait-amp-amp-dispatch-group-enter-amp-amp-dispatch-group-leave" class="headerlink" title="dispatch_group_wait &amp;&amp; dispatch_group_enter &amp;&amp; dispatch_group_leave"></a>dispatch_group_wait &amp;&amp; dispatch_group_enter &amp;&amp; dispatch_group_leave</h5><p><code>dispatch_group_enter</code>å’Œ<code>dispatch_group_leave</code>éœ€è¦æˆå¯¹ä½¿ç”¨ï¼Œå¦åˆ™<code>dispatch_group_wait</code>åœ¨ç¼ºå°‘<code>leave</code>çš„æƒ…å†µä¸‹ä¼šç­‰å¾…åˆ°æ­»ï¼Œé€ æˆçº¿ç¨‹é˜»å¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">static	dispatch_group_t group ;</span><br><span class="line">if (group == nil) &#123;</span><br><span class="line">	group = dispatch_group_create();</span><br><span class="line">&#125;</span><br><span class="line">dispatch_queue_t queue = dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">//	dispatch_group_enter(group);</span><br><span class="line">dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">	[self print];</span><br><span class="line">	[NSThread sleepForTimeInterval:2];</span><br><span class="line">//		dispatch_group_leave(group);//å½“æ³¨é‡Šæ‰  é˜»å¡åœ¨waitä¸ç»§ç»­å‘ä¸‹æ‰§è¡Œ</span><br><span class="line">&#125;);</span><br><span class="line">dispatch_group_wait(group, DISPATCH_TIME_FOREVER);</span><br><span class="line"></span><br><span class="line">dispatch_group_enter(group);</span><br><span class="line">dispatch_group_async(group, queue, ^&#123;</span><br><span class="line">	[self print];</span><br><span class="line">	[NSThread sleepForTimeInterval:2];</span><br><span class="line">	dispatch_group_leave(group);</span><br><span class="line">&#125;);</span><br><span class="line">//log</span><br><span class="line">2019-07-25 10:58:50 &lt;NSThread: 0x600002d84180&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">2019-07-25 10:58:52 &lt;NSThread: 0x600002d84180&gt;&#123;number = 3, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<h4 id="æ …æ å‡½æ•°-dispatch-barrier-sync"><a href="#æ …æ å‡½æ•°-dispatch-barrier-sync" class="headerlink" title="æ …æ å‡½æ•° dispatch_barrier_sync"></a>æ …æ å‡½æ•° dispatch_barrier_sync</h4><p>æ …æ å‡½æ•°å®ç°äº†å¼‚æ­¥çš„é˜Ÿåˆ—ä¸­åœ¨å¤šä¸ªä»»åŠ¡ç»“æŸçš„æ—¶å€™å®è¡Œå›è°ƒï¼Œå›è°ƒåˆ†å¼‚æ­¥å’ŒåŒæ­¥ï¼ŒåŒæ­¥å›è°ƒåœ¨ä¸»çº¿ç¨‹ï¼Œå¼‚æ­¥åœ¨å…¶ä»–çº¿ç¨‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">- (void)barry&#123;</span><br><span class="line">	dispatch_queue_t queue= dispatch_queue_create(&quot;cust.queue.com&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">	dispatch_async(queue, ^&#123;</span><br><span class="line">		for (int i = 0; i &lt; 3; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_barrier_sync(queue, ^&#123;</span><br><span class="line">		printf(&quot;\n %s %s ---ä¸­é—´æš‚åœä¸€ä¸‹----&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_async(queue, ^&#123;</span><br><span class="line">		for (int i = 3; i &lt; 6; i ++) &#123;</span><br><span class="line">			[NSThread sleepForTimeInterval:1];</span><br><span class="line">			printf(&quot;\n %s %s %d&quot;,[self dateUTF8],[self threadInfo],i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_barrier_async(queue, ^&#123;</span><br><span class="line">		printf(&quot;\n %s %s ---ä¸­é—´ç¬¬äºŒæ¬¡æš‚åœä¸€ä¸‹----&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line"> 2019-07-24 16:52:33 &lt;NSThread: 0x600003158440&gt;&#123;number = 3, name = (null)&#125; 0</span><br><span class="line"> 2019-07-24 16:52:34 &lt;NSThread: 0x600003158440&gt;&#123;number = 3, name = (null)&#125; 1</span><br><span class="line"> 2019-07-24 16:52:35 &lt;NSThread: 0x600003158440&gt;&#123;number = 3, name = (null)&#125; 2</span><br><span class="line"> 2019-07-24 16:52:35 &lt;NSThread: 0x6000031293c0&gt;&#123;number = 1, name = main&#125; ---ä¸­é—´æš‚åœä¸€ä¸‹----</span><br><span class="line"> 2019-07-24 16:52:36 &lt;NSThread: 0x600003158440&gt;&#123;number = 3, name = (null)&#125; 3</span><br><span class="line"> 2019-07-24 16:52:37 &lt;NSThread: 0x600003158440&gt;&#123;number = 3, name = (null)&#125; 4</span><br><span class="line"> 2019-07-24 16:52:38 &lt;NSThread: 0x600003158440&gt;&#123;number = 3, name = (null)&#125; 5</span><br><span class="line"> 2019-07-24 16:52:38 &lt;NSThread: 0x600003158440&gt;&#123;number = 3, name = (null)&#125; ---ä¸­é—´ç¬¬äºŒæ¬¡æš‚åœä¸€ä¸‹----</span><br></pre></td></tr></table></figure>
<h4 id="å•ä¾‹-æ‰§è¡Œä¸€æ¬¡çš„å‡½æ•°-dispatch-once-t"><a href="#å•ä¾‹-æ‰§è¡Œä¸€æ¬¡çš„å‡½æ•°-dispatch-once-t" class="headerlink" title="å•ä¾‹-æ‰§è¡Œä¸€æ¬¡çš„å‡½æ•° dispatch_once_t"></a>å•ä¾‹-æ‰§è¡Œä¸€æ¬¡çš„å‡½æ•° dispatch_once_t</h4><p>å•ä¾‹å¯ä»¥é€šè¿‡è¿™ä¸ªå‡½æ•°å®ç°ï¼Œåªæ‰§è¡Œä¸€æ¬¡çš„å‡½æ•°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//åªæ‰§è¡Œä¸€æ¬¡çš„dispatch_once</span><br><span class="line">-(void)exc_once&#123;</span><br><span class="line">	static dispatch_once_t onceToken;</span><br><span class="line">	static NSObject *obj;</span><br><span class="line">	dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">		obj=[NSObject new];</span><br><span class="line">		printf(&quot;\n just once %s %s&quot;,[self dateUTF8],obj.description.UTF8String);</span><br><span class="line">	&#125;);</span><br><span class="line">	printf(&quot;\n %s %s&quot;,[self dateUTF8],obj.description.UTF8String);</span><br><span class="line">&#125;</span><br><span class="line">è°ƒç”¨4æ¬¡</span><br><span class="line">dispatch_apply(4, dispatch_get_global_queue(0, 0), ^(size_t idx) &#123;</span><br><span class="line">		[self exc_once];</span><br><span class="line">	&#125;);</span><br><span class="line">	</span><br><span class="line">//log</span><br><span class="line">just once 2019-07-25 14:46:00 &lt;NSObject: 0x60000378b100&gt;</span><br><span class="line">2019-07-25 14:46:00 &lt;NSObject: 0x60000378b100&gt;</span><br><span class="line">2019-07-25 14:46:00 &lt;NSObject: 0x60000378b100&gt;</span><br><span class="line">2019-07-25 14:46:00 &lt;NSObject: 0x60000378b100&gt;</span><br></pre></td></tr></table></figure>
<p>å½“è°ƒç”¨4æ¬¡çš„æ—¶å€™ï¼Œæ—¥å¿—æ‰“å°çš„å››æ¬¡<code>obj</code>å‡ä¸ºåŒä¸€ä¸ªåœ°å€ï¼Œè¯æ˜<code>block</code>å›è°ƒå››æ¬¡ä½†æ˜¯åªæ‰§è¡Œäº†ä¸€æ¬¡ã€‚</p>
<h4 id="å»¶è¿Ÿæ‰§è¡Œ-dispatch-after"><a href="#å»¶è¿Ÿæ‰§è¡Œ-dispatch-after" class="headerlink" title="å»¶è¿Ÿæ‰§è¡Œ dispatch_after"></a>å»¶è¿Ÿæ‰§è¡Œ dispatch_after</h4><p>å½“è®°å½•æ—¥å¿—æˆ–è€…ç‚¹å‡»äº‹ä»¶çš„æ–¹æ³•æˆ‘ä»¬ä¸å¸Œæœ›ç«‹å³æ‰§è¡Œï¼Œåˆ™ä¼šç”¨åˆ°å»¶è¿Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">//å»¶è¿Ÿæ‰§è¡Œ</span><br><span class="line">-(void)delayTimeExc&#123;</span><br><span class="line">	printf(&quot;\n %s %s begin&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">	</span><br><span class="line">	dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</span><br><span class="line">	</span><br><span class="line">		printf(&quot;\n %s %s&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">		</span><br><span class="line">	&#125;);</span><br><span class="line">	printf(&quot;\n %s %s end&quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">2019-07-24 17:07:48 &lt;NSThread: 0x600003cc6940&gt;&#123;number = 1, name = main&#125; begin</span><br><span class="line">2019-07-24 17:07:48 &lt;NSThread: 0x600003cc6940&gt;&#123;number = 1, name = main&#125; end</span><br><span class="line">2019-07-24 17:07:50 &lt;NSThread: 0x600003cc6940&gt;&#123;number = 1, name = main&#125;</span><br></pre></td></tr></table></figure>
<h4 id="ä¿¡å·é‡-dispatch-semaphore-t"><a href="#ä¿¡å·é‡-dispatch-semaphore-t" class="headerlink" title="ä¿¡å·é‡  dispatch_semaphore_t"></a>ä¿¡å·é‡  dispatch_semaphore_t</h4><p>ä¿¡å·é‡ä¸º1å¯ä»¥ä½œä¸ºçº¿ç¨‹é”æ¥ç”¨ï¼Œå½“N&gt;1çš„æ—¶å€™ï¼ŒåŒæ—¶æ‰§è¡Œçš„æœ‰Nä¸ªä»»åŠ¡ã€‚<br><code>dispatch_apply</code>å¯ä»¥é€šçŸ¥åˆ›å»ºå¤šä¸ªçº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡ï¼Œç”¨å®ƒæ¥æµ‹è¯•ä¿¡å·é‡å†å¥½ä¸è¿‡äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">//ä¿¡å·é‡ å½“ä¿¡å·é‡ä¸º1 å¯ä»¥æœªåšé”æ¥ç”¨ï¼Œå½“N&gt;1ï¼Œté€šçŸ¥æ‰§è¡Œçš„æ•°é‡åˆ™æ˜¯æ•°å­—Nã€‚</span><br><span class="line">- (void)semaphore&#123;</span><br><span class="line">	static dispatch_semaphore_t sem;</span><br><span class="line">	if (sem == NULL) &#123;</span><br><span class="line">		sem = dispatch_semaphore_create(1);</span><br><span class="line">	&#125;</span><br><span class="line">	dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</span><br><span class="line">	static int i = 0;</span><br><span class="line">	int currentI = i +2;</span><br><span class="line">	for (; i &lt; currentI; i ++) &#123;</span><br><span class="line">		[NSThread sleepForTimeInterval:1];</span><br><span class="line">		printf(&quot;\n %s %s %d&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,i);</span><br><span class="line">	&#125;</span><br><span class="line">	dispatch_semaphore_signal(sem);</span><br><span class="line">&#125;</span><br><span class="line">-(void)asyn_semaphore&#123;</span><br><span class="line">	dispatch_apply(3, dispatch_get_global_queue(0, 0), ^(size_t idx) &#123;</span><br><span class="line">		[self semaphore];</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">2019-07-24 17:25:04 &lt;NSThread: 0x6000002a2940&gt;&#123;number = 1, name = main&#125; 0</span><br><span class="line">2019-07-24 17:25:05 &lt;NSThread: 0x6000002a2940&gt;&#123;number = 1, name = main&#125; 1</span><br><span class="line">2019-07-24 17:25:06 &lt;NSThread: 0x6000002e2b40&gt;&#123;number = 3, name = (null)&#125; 2</span><br><span class="line">2019-07-24 17:25:07 &lt;NSThread: 0x6000002e2b40&gt;&#123;number = 3, name = (null)&#125; 3</span><br><span class="line">2019-07-24 17:25:08 &lt;NSThread: 0x6000002d4740&gt;&#123;number = 4, name = (null)&#125; 4</span><br><span class="line">2019-07-24 17:25:09 &lt;NSThread: 0x6000002d4740&gt;&#123;number = 4, name = (null)&#125; 5</span><br></pre></td></tr></table></figure>
<p>è®¾è®¡ä¸€ä¸ªç»å…¸é—®é¢˜ï¼Œç«è½¦ç¥¨çª—å£ä¹°ç¥¨ï¼Œç«è½¦ç«™å–ç¥¨ä¸€èˆ¬æœ‰å¤šä¸ªçª—å£ï¼Œæ’é˜Ÿæ˜¯æ¯ä¸ªçª—å£æ’ä¸€ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªçª—å£åŒæ—¶åªèƒ½å–ä¸€å¼ ç¥¨ï¼Œé‚£æˆ‘ä»¬è®¾è®¡ä¸€ä¸‹å¦‚ä½•å®ç°å¤šé˜Ÿåˆ—åŒæ—¶è®¿é—®å¤šä¸ªçª—å£çš„çš„é—®é¢˜ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">-(void)muchQueueBuyTick&#123;</span><br><span class="line">	dispatch_queue_t queue= dispatch_queue_create(&quot;com.buy.tick&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">	dispatch_async(queue, ^&#123;</span><br><span class="line">		for (NSInteger i = 0; i &lt; 5; i ++) &#123;</span><br><span class="line">			[self semaphore_buy_ticks:4];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_queue_t queue2= dispatch_queue_create(&quot;com.buy2.tick&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">	dispatch_async(queue2, ^&#123;</span><br><span class="line">		for (NSInteger i = 0; i &lt; 5; i ++) &#123;</span><br><span class="line">			[self semaphore_buy_ticks:2];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)semaphore_buy_ticks:(NSInteger)windowsCount&#123;</span><br><span class="line">	static dispatch_semaphore_t sem;</span><br><span class="line">	if (sem == NULL) &#123;</span><br><span class="line">		sem = dispatch_semaphore_create(windowsCount);</span><br><span class="line">	&#125;</span><br><span class="line">	//ä¿¡å·é‡-1</span><br><span class="line">	dispatch_semaphore_wait(sem, DISPATCH_TIME_FOREVER);</span><br><span class="line">	self.count--;</span><br><span class="line">	if (self.count &gt; 0) &#123;</span><br><span class="line">		printf(&quot;\n %s %s ç¬¬%ldä¸ªäººä¹°åˆ°ç¥¨äº†&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,(long)self.count);</span><br><span class="line">		[NSThread sleepForTimeInterval:0.2];</span><br><span class="line">	&#125;</span><br><span class="line">	//ä¿¡å·é‡+1</span><br><span class="line">	dispatch_semaphore_signal(sem);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">2019-07-24 18:01:44 &lt;NSThread: 0x600003935e00&gt;&#123;number = 4, name = (null)&#125; ç¬¬8ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:44 &lt;NSThread: 0x600003904c40&gt;&#123;number = 3, name = (null)&#125; ç¬¬8ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003904c40&gt;&#123;number = 3, name = (null)&#125; ç¬¬6ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003935e00&gt;&#123;number = 4, name = (null)&#125; ç¬¬6ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003935e00&gt;&#123;number = 4, name = (null)&#125; ç¬¬4ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003904c40&gt;&#123;number = 3, name = (null)&#125; ç¬¬4ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003935e00&gt;&#123;number = 4, name = (null)&#125; ç¬¬2ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003904c40&gt;&#123;number = 3, name = (null)&#125; ç¬¬2ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:01:45 &lt;NSThread: 0x600003935e00&gt;&#123;number = 4, name = (null)&#125; ç¬¬0ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br></pre></td></tr></table></figure>
<p>ä¸¤ä¸ªçª—å£(ä¸¤ä¸ªé˜Ÿåˆ—)ï¼Œæ¯ä¸ªçª—å£æ’äº†5(å¾ªç¯5æ¬¡)ä¸ªäººï¼Œä¸€å…±10(count=10)å¼ ç¥¨ã€‚<br>å½“åŒæ—¶ä¸€å¼ ç¥¨å¯ä»¥åˆ†å‰²2æ¬¡ï¼Œå–ç¥¨çš„é”™ä¹±äº†ï¼Œæ˜æ˜¾é”™è¯¯äº†ï¼Œç°åœ¨æŠŠæ¯å¼ ç¥¨éƒ½é”èµ·æ¥ï¼ŒåŒæ—¶åªèƒ½å…è®¸åŒä¸€ä¸ªäººå–ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">-(void)muchQueueBuyTick&#123;</span><br><span class="line">	dispatch_queue_t queue= dispatch_queue_create(&quot;com.buy.tick&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">	dispatch_async(queue, ^&#123;</span><br><span class="line">		for (NSInteger i = 0; i &lt; 5; i ++) &#123;</span><br><span class="line">			[self semaphore_buy_ticks:1];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_queue_t queue2= dispatch_queue_create(&quot;com.buy2.tick&quot;, DISPATCH_QUEUE_CONCURRENT);</span><br><span class="line">	dispatch_async(queue2, ^&#123;</span><br><span class="line">		for (NSInteger i = 0; i &lt; 5; i ++) &#123;</span><br><span class="line">			[self semaphore_buy_ticks:1];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">2019-07-24 18:03:56 &lt;NSThread: 0x600000e1cac0&gt;&#123;number = 3, name = (null)&#125; ç¬¬9ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:57 &lt;NSThread: 0x600000e1e0c0&gt;&#123;number = 4, name = (null)&#125; ç¬¬8ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:57 &lt;NSThread: 0x600000e1cac0&gt;&#123;number = 3, name = (null)&#125; ç¬¬7ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:57 &lt;NSThread: 0x600000e1e0c0&gt;&#123;number = 4, name = (null)&#125; ç¬¬6ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:57 &lt;NSThread: 0x600000e1cac0&gt;&#123;number = 3, name = (null)&#125; ç¬¬5ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:57 &lt;NSThread: 0x600000e1e0c0&gt;&#123;number = 4, name = (null)&#125; ç¬¬4ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:58 &lt;NSThread: 0x600000e1cac0&gt;&#123;number = 3, name = (null)&#125; ç¬¬3ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:58 &lt;NSThread: 0x600000e1e0c0&gt;&#123;number = 4, name = (null)&#125; ç¬¬2ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-24 18:03:58 &lt;NSThread: 0x600000e1cac0&gt;&#123;number = 3, name = (null)&#125; ç¬¬1ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br></pre></td></tr></table></figure>
<p>é¡ºåºæ˜¯å¯¹äº†ï¼Œæ•°é‡ä¹Ÿå¯¹äº†ã€‚</p>
<p>å†æ¢ä¸€ç§æ€è·¯å®ç°é”ä½çª—å£ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">//ä½¿ç”¨åŒæ­¥é˜Ÿåˆ—å–ç¥¨</span><br><span class="line">- (void)sync_buy_tick&#123;</span><br><span class="line">	dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">		self.count--;</span><br><span class="line">		if (self.count &gt; 0) &#123;</span><br><span class="line">			printf(&quot;\n %s %s ç¬¬%ldä¸ªäººä¹°åˆ°ç¥¨äº†&quot;,[self currentDateString].UTF8String,[NSThread currentThread].description.UTF8String,(long)self.count);</span><br><span class="line">			[NSThread sleepForTimeInterval:0.2];</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">2019-07-25 09:31:56 &lt;NSThread: 0x6000034d2e40&gt;&#123;number = 1, name = main&#125; ç¬¬9ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:56 &lt;NSThread: 0x6000034d2e40&gt;&#123;number = 1, name = main&#125; ç¬¬8ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:56 &lt;NSThread: 0x6000034d2e40&gt;&#123;number = 1, name = main&#125; ç¬¬7ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:56 &lt;NSThread: 0x6000034d2e40&gt;&#123;number = 1, name = main&#125; ç¬¬6ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:57 &lt;NSThread: 0x6000034d2e40&gt;&#123;number = 1, name = main&#125; ç¬¬5ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:57 &lt;NSThread: 0x6000034d2e40&gt;&#123;number = 1, name = main&#125; ç¬¬4ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:57 &lt;NSThread: 0x6000034d2e40&gt;&#123;number = 1, name = main&#125; ç¬¬3ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:57 &lt;NSThread: 0x6000034d2e40&gt;&#123;number = 1, name = main&#125; ç¬¬2ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br><span class="line"> 2019-07-25 09:31:57 &lt;NSThread: 0x6000034d2e40&gt;&#123;number = 1, name = main&#125; ç¬¬1ä¸ªäººä¹°åˆ°ç¥¨äº†</span><br></pre></td></tr></table></figure>
<p>ä¸²è¡Œé˜Ÿåˆ—ä¸åˆ›å»ºå­çº¿ç¨‹ï¼Œæ‰€æœ‰ä»»åŠ¡éƒ½åœ¨åŒä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œé‚£ä¹ˆä»–ä»¬å°±ä¼šæ’é˜Ÿï¼Œå…¶å®ä¸ç®¡å¤šå°‘äººåŒæ—¶ç‚¹å‡»ä¹°ç¥¨ï¼Œç¥¨çš„åˆ†å‰²è¿˜æ˜¯ä¸²è¡Œçš„ï¼Œæ‰€ä»¥çº¿ç¨‹é”çš„å¯ä»¥ä½¿ç”¨ä¸²è¡Œé˜Ÿåˆ—æ¥è§£å†³ã€‚</p>
<h4 id="å¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch-apply"><a href="#å¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch-apply" class="headerlink" title="å¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch_apply"></a>å¿«é€Ÿè¿­ä»£æ–¹æ³•ï¼šdispatch_apply</h4><p>å¿«é€Ÿè¿­ä»£å°±æ˜¯åŒæ—¶åˆ›å»ºå¾ˆå¤šçº¿ç¨‹æ¥åœ¨åšäº‹æƒ…ï¼Œç°åœ¨å·¥å‚æ”¶åˆ°ä¸€ä¸ªäº¿çš„è®¢å•ï¼Œå·¥å‚æœ¬æ¥åªæœ‰2æ¡ç”Ÿäº§çº¿ï¼Œç°åœ¨ç´§æ€¥æ–°å»ºå¾ˆå¤šç”Ÿäº§çº¿æ¥ç”Ÿäº§äº§å“ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">åŒæ—¶æ–°å»ºäº†å¤šæ¡çº¿ç¨‹æ¥åšä»»åŠ¡</span><br><span class="line">*/</span><br><span class="line">	dispatch_apply(10, dispatch_get_global_queue(0, 0), ^(size_t idx) &#123;</span><br><span class="line">		printf(&quot;\n %s %s &quot;,[self dateUTF8],[self threadInfo]);</span><br><span class="line">	&#125;);</span><br><span class="line">	</span><br><span class="line">	//log</span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x600000966180&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x60000094a3c0&gt;&#123;number = 3, name = (null)&#125; </span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x600000979dc0&gt;&#123;number = 5, name = (null)&#125; </span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x60000090d3c0&gt;&#123;number = 1, name = main&#125; </span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x60000095cfc0&gt;&#123;number = 6, name = (null)&#125; </span><br><span class="line">2019-07-25 09:38:38 &lt;NSThread: 0x600000950140&gt;&#123;number = 8, name = (null)&#125; </span><br><span class="line"> 2019-07-25 09:38:38 &lt;NSThread: 0x60000095d0c0&gt;&#123;number = 9, name = (null)&#125; </span><br><span class="line"> 2019-07-25 09:38:38 &lt;NSThread: 0x60000094a400&gt;&#123;number = 7, name = (null)&#125; </span><br><span class="line"> 2019-07-25 09:38:38 &lt;NSThread: 0x600000966180&gt;&#123;number = 4, name = (null)&#125; </span><br><span class="line"> 2019-07-25 09:38:38 &lt;NSThread: 0x60000094a3c0&gt;&#123;number = 3, name = (null)&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ–°å»ºäº†<code>3</code>ã€<code>4</code>ã€<code>5</code>ã€<code>6</code>ã€<code>7</code>ã€<code>8</code>ã€<code>9</code>ã€<code>main</code>æ¥æ‰§è¡Œä»»åŠ¡ã€‚</p>
<h3 id="å¤šçº¿ç¨‹RunLoopå®æˆ˜"><a href="#å¤šçº¿ç¨‹RunLoopå®æˆ˜" class="headerlink" title="å¤šçº¿ç¨‹RunLoopå®æˆ˜"></a>å¤šçº¿ç¨‹RunLoopå®æˆ˜</h3><p>é—®é¢˜ä¸€ï¼šè¯·é—®ä¸‹è¾¹ä»£ç è¾“å‡ºä»€ä¹ˆï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-(void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">    dispatch_queue_t  que= dispatch_get_global_queue(0, 0);</span><br><span class="line">    dispatch_async(que, ^&#123;</span><br><span class="line">        NSLog(@&quot;1&quot;);</span><br><span class="line">        [self performSelector:@selector(test) withObject:nil afterDelay:.0];</span><br><span class="line">        NSLog(@&quot;3&quot;);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)test&#123;</span><br><span class="line">    NSLog(@&quot;2&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>çŒœæƒ³1ï¼šç»“æœæ˜¯<code>123</code></li>
<li>çŒœæƒ³2ï¼šç»“æœæ˜¯<code>132</code></li>
</ul>
<p>æœ‰æ²¡æœ‰ç¬¬ä¸‰ç§ç»“æœå‘¢ï¼Ÿ</p>
<p>çŒœæƒ³1åˆ†æï¼š<br>å› ä¸ºæ˜¯å»¶è¿Ÿ<code>0</code>sæ‰§è¡Œï¼Œå½“ç„¶æ˜¯å…ˆæ‰§è¡Œ<code>2</code>ï¼Œå†æ‰§è¡Œ<code>3</code>äº†ã€‚</p>
<p>çŒœæƒ³2åˆ†æï¼š</p>
<p>æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ï¼Œå¼‚æ­¥åŠ å…¥å…¨å±€é˜Ÿåˆ—ä¸­ï¼Œå•ä¸ªä»»åŠ¡çš„æ—¶å€™ä¼šåŠ å…¥åˆ°å­çº¿ç¨‹ä¸­ï¼Œé‚£ä¹ˆä¼šå…ˆè¾“å‡º<code>1</code>ï¼Œç„¶åè¾“å‡º<code>3</code>ï¼Œæœ€åè¾“å‡º<code>2</code>.</p>
<p>æœ€åéªŒè¯ä¸€ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line">3</span><br></pre></td></tr></table></figure>
<p>ä¸ºä»€ä¹ˆ2æ²¡æœ‰å‡ºæ¥å‘¢ï¼Ÿåœ¨çœ‹ä¸€ä¸‹ä»£ç ï¼Œå…¨å±€é˜Ÿåˆ—ï¼Œå»¶è¿Ÿæ‰§è¡Œï¼Œç‚¹è¿›å»å‡½æ•°æŸ¥çœ‹ï¼ŒåŸæ¥æ˜¯åœ¨<code>runloop.h</code>æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬çŒœæµ‹å»¶è¿Ÿæ‰§è¡Œæ˜¯<code>timer</code>æ·»åŠ åˆ°<code>runloop</code>ä¸­äº†ï¼Œæ·»åŠ è¿›å»ä¹Ÿåº”è¯¥è¾“å‡º<code>132</code>çš„ã€‚å› ä¸ºåœ¨å­çº¿ç¨‹ä¸­ï¼Œæ²¡æœ‰ä¸»åŠ¨è°ƒç”¨ä¸ä¼šæœ‰<code>runloop</code>çš„ï¼ŒåŠæ—¶è°ƒç”¨äº†ä¹Ÿéœ€è¦ä¿æ´»æŠ€æœ¯ï¼Œé‚£ä¹ˆä»£ç æ”¹è¿›ä¸€ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_queue_t  que= dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">    dispatch_async(que, ^&#123;</span><br><span class="line">        NSLog(@&quot;1&quot;);</span><br><span class="line">        // ç›¸å½“äº[self test];</span><br><span class="line">//       [self performSelector:@selector(test) withObject:nil];</span><br><span class="line">        [self performSelector:@selector(test) withObject:nil afterDelay:.0];</span><br><span class="line">        </span><br><span class="line">        [[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSRunLoopCommonModes];</span><br><span class="line">        [[NSRunLoop currentRunLoop] run];</span><br><span class="line">        NSLog(@&quot;3&quot;);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>ç»æµ‹è¯•è¾“å‡ºäº†<code>12</code>ï¼Œè¿™å’Œæˆ‘ä»¬çŒœæƒ³çš„è¿˜æ˜¯ä¸å¯¹ï¼ŒåŸæ¥è¾“å‡º<code>3</code>æ”¾åœ¨äº†æœ€åï¼Œå¯¼è‡´çš„é—®é¢˜ï¼Œ<code>RunLoop</code>è¿è¡Œèµ·æ¥ï¼Œè¿›å…¥äº†å¾ªç¯ï¼Œåˆ™åé¢çš„å°±ä¸ä¼šæ‰§è¡Œäº†ï¼Œé™¤éåœæ­¢å½“å‰<code>RunLoop</code>ï¼Œæˆ‘ä»¬å†æ”¹è¿›ä¸€ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    dispatch_queue_t  que= dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0);</span><br><span class="line">    dispatch_async(que, ^&#123;</span><br><span class="line">        NSLog(@&quot;1&quot;);</span><br><span class="line">        // ç›¸å½“äº[self test];</span><br><span class="line">//       [self performSelector:@selector(test) withObject:nil];</span><br><span class="line">        [self performSelector:@selector(test) withObject:nil afterDelay:.0];</span><br><span class="line">         NSLog(@&quot;3&quot;);</span><br><span class="line">        [[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSRunLoopCommonModes];</span><br><span class="line">        [[NSRunLoop currentRunLoop] run];</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>æœ€åç»ˆäºè¾“å‡ºäº†<code>132</code>ã€‚ç¼ºç‚¹æ˜¯å­çº¿ç¨‹æˆäº†<strong>æ­»å¾…</strong>ï¼Œä¸æ­»ä¹‹èº«ï¼Œå…³äºæ€ä¹ˆæ€æ­»<strong>æ­»å¾…</strong>è¯·çœ‹<a href="https://juejin.im/post/5d35b347f265da1b8608c49b" target="_blank" rel="noopener">ä¸Šç¯‡ä¼˜é›…æ§åˆ¶RunLoopç”Ÿå‘½å‘¨æœŸ</a>ã€‚<br>å…³äº<code>performSelector:(SEL)aSelector withObject:(nullable id)anArgument afterDelay:(NSTimeInterval)delay</code>ä¸­æœ‰å»¶è¿Ÿçš„ï¼Œéƒ½æ˜¯æ·»åŠ åˆ°å½“å‰ä½ çº¿ç¨‹çš„<code>RunLoop</code>ï¼Œå¦‚æœæ²¡æœ‰å¯åŠ¨<code>RunLoop</code>å’Œä¿æ´»ææ€•ä¹Ÿä¸èƒ½ä¸€ç›´æ‰§è¡Œã€‚<code>[self performSelector:@selector(test) withObject:nil]</code>æ˜¯åœ¨<code>Foudation</code>ä¸­ï¼Œæºç æ˜¯ç›´æ¥<code>objc_msgSend()</code>ï¼Œç›¸å½“äºç›´æ¥<code>[self test]</code>ï¼Œä¸ä¼šæœ‰å»¶è¿Ÿã€‚</p>
<p>é—®é¢˜2ï¼šè¯·é—®è¾“å‡ºä»€ä¹ˆï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NSThread *thread=[[NSThread alloc]initWithBlock:^&#123;</span><br><span class="line">    NSLog(@&quot;1&quot;);</span><br><span class="line">&#125;];</span><br><span class="line">[thread start];</span><br><span class="line">[self performSelector:@selector(test)</span><br><span class="line">             onThread:thread</span><br><span class="line">           withObject:nil</span><br><span class="line">        waitUntilDone:YES];</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå’Œä¸Šé¢çš„ç±»ä¼¼ï¼Œç»“æœæ˜¯æ‰“å°äº†<code>1</code>å°±å´©æºƒäº†ï¼ŒåŸå› æ˜¯<code>thread start</code>ä¹‹åæ‰§è¡Œå®Œ<code>block</code>å°±ç»“æŸäº†ï¼Œæ²¡æœ‰<code>runloop</code>çš„æ”¯æ’‘ã€‚å½“æ‰§è¡Œ<code>performSelector</code>çš„æ—¶å€™ï¼Œçº¿ç¨‹å·²ç»æ­»æ‰ã€‚è§£å†³è¿™ä¸ªé—®é¢˜åªéœ€è¦å‘å­çº¿ç¨‹ä¸­æ·»åŠ <code>RunLoop</code>ï¼Œè€Œä¸”ä¿è¯<code>RunLoop</code>ä¸åœæ­¢å°±è¡Œäº†ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li>GCDå¼‚æ­¥è´Ÿè´£æ‰§è¡Œè€—æ—¶ä»»åŠ¡(ä¾‹å¦‚ä¸‹è½½ï¼Œå¤æ‚è®¡ç®—)ï¼Œmainçº¿ç¨‹è´Ÿè´£æ›´æ–°UI</li>
<li>é˜Ÿåˆ—å¤šä»»åŠ¡å¼‚æ­¥æ‰§è¡Œæœ€åå…¨å±€æ‰§è¡Œå®Œæ¯•å¯ä»¥ä½¿ç”¨<code>group_notify</code>æ¥ç›‘å¬æ‰§è¡Œå®Œæ¯•æ—¶é—´</li>
<li>é˜Ÿåˆ—å¤šä»»åŠ¡å¼‚æ­¥æ‰§è¡Œç»“æŸæ—¶é—´ï¼Œä¸­é—´æ‹¦æˆªæ›´æ–°UIï¼Œç„¶åå†å¼‚æ­¥æ‰§è¡Œå¯ä»¥ä½¿ç”¨<code>dispatch_barrier_sync</code></li>
<li>å½“å¤šçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªèµ„æºï¼Œå¯ä»¥ä½¿ç”¨ä¿¡å·é‡æ¥é™åˆ¶åŒæ—¶è®¿é—®èµ„æºçš„çº¿ç¨‹æ•°é‡</li>
</ul>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><ul>
<li><a href="https://juejin.im/post/5a90de68f265da4e9b592b40#heading-16" target="_blank" rel="noopener">iOSå¤šçº¿ç¨‹ï¼šã€GCDã€è¯¦å°½æ€»ç»“</a></li>
<li><a href="http://www.520it.com/zt/ios_mj/" target="_blank" rel="noopener">å°ç å“¥è§†é¢‘</a></li>
<li><a href="http://awayqu.1024ul.com/ios/2018/05/02/gcd-3.html" target="_blank" rel="noopener">ä»»åŠ¡è°ƒåº¦</a></li>
<li><a href="https://opensource.apple.com/tarballs/libdispatch/" target="_blank" rel="noopener">libdispatch</a></li>
<li>iOSå’ŒOSå¤šçº¿ç¨‹ä¸å†…å­˜ç®¡ç†<h3 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h3></li>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="noopener">å­¦ä¹ èµ„æ–™ä¸‹è½½git</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="noopener">demo code git</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC/objc4-750" target="_blank" rel="noopener">runtimeå¯è¿è¡Œçš„æºç git</a></li>
</ul>
<hr>
<p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p>
<p>å¹¿å‘Šæ—¶é—´</p>
<p><img src="/images/0.png" alt></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOSåº•å±‚åŸç† RunLoopåŸºç¡€æ€»ç»“å’Œéšå¿ƒæ‰€æ¬²æŒæ¡å­çº¿ç¨‹RunLoopç”Ÿå‘½å‘¨æœŸ --(9)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyongçš„æŠ€æœ¯åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/01/iOSåº•å±‚åŸç† RunLoopåŸºç¡€æ€»ç»“å’Œéšå¿ƒæ‰€æ¬²æŒæ¡å­çº¿ç¨‹RunLoopç”Ÿå‘½å‘¨æœŸ --(9)/" class="post-title-link" itemprop="http://fgyong.cn/index.html">iOSåº•å±‚åŸç†  RunLoopåŸºç¡€æ€»ç»“å’Œéšå¿ƒæ‰€æ¬²æŒæ¡å­çº¿ç¨‹RunLoopç”Ÿå‘½å‘¨æœŸ --(9)</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-01 11:19:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:19:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-09-03 16:24:13" itemprop="dateModified" datetime="2020-09-03T16:24:13+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ä½¿ç”¨é’©å­å®ç°äº†å¯¹å­—å…¸å’Œæ•°ç»„çš„èµ‹å€¼çš„æ ¡éªŒï¼Œé¡ºä¾¿éšæ‰‹æ’¸äº†ä¸€ä¸ªç®€å•çš„<code>jsonToModel</code>,<code>iOS</code>é™¤äº†<code>runtime</code>è¿˜æœ‰ä¸€ä¸ªä¸œè¥¿çš„å«åš<code>runloop</code>ï¼Œå„ä½çœ‹å®˜è€çˆ·ä¸€å®šéƒ½æœ‰äº†è§£ï¼Œé‚£ä¹ˆä»Šå¤©è¿™ç¯‡æ–‡ç« åˆè¯†ä¸€ä¸‹<code>runloop</code>ã€‚</p>
<h3 id="ä»€ä¹ˆæ˜¯runloop"><a href="#ä»€ä¹ˆæ˜¯runloop" class="headerlink" title="ä»€ä¹ˆæ˜¯runloop"></a>ä»€ä¹ˆæ˜¯runloop</h3><p>ç®€å•æ¥è®²<code>runloop</code>å°±æ˜¯ä¸€ä¸ªå¾ªç¯ï¼Œæˆ‘ä»¬å†™çš„ç¨‹åºï¼Œä¸€èˆ¬æ²¡æœ‰å¾ªç¯çš„è¯ï¼Œæ‰§è¡Œå®Œå°±ç»“æŸäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ‰‹æœºä¸Šçš„APPæ˜¯å¦‚ä½•ä¸€ç›´è¿è¡Œä¸åœæ­¢çš„å‘¢ï¼ŸAPPå°±æ˜¯ç”¨åˆ°äº†<code>runloop</code>ï¼Œä¿è¯ç¨‹åºä¸€ç›´è¿è¡Œä¸é€€å‡ºï¼Œåœ¨éœ€è¦å¤„ç†äº‹ä»¶çš„æ—¶å€™å¤„ç†äº‹ä»¶ï¼Œä¸å¤„ç†äº‹ä»¶çš„æ—¶å€™è¿›è¡Œä¼‘çœ ï¼Œè·³å‡ºå¾ªç¯ç¨‹åºå°±ç»“æŸã€‚ç”¨ä¼ªä»£ç å®ç°ä¸€ä¸ª<code>runloop</code>å…¶å®æ˜¯è¿™æ ·å­çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">int ret = 0;</span><br><span class="line">do &#123;</span><br><span class="line">    //ç¡çœ ä¸­ç­‰å¾…æ¶ˆæ¯</span><br><span class="line">    int messgae = sleep_and_wait();</span><br><span class="line">    //å¤„ç†æ¶ˆæ¯</span><br><span class="line">    ret = process_message(messgae);</span><br><span class="line">&#125; while (ret == 0);</span><br></pre></td></tr></table></figure>
<h3 id="è·å–runloop"><a href="#è·å–runloop" class="headerlink" title="è·å–runloop"></a>è·å–runloop</h3><p>iOSä¸­æœ‰ä¸¤å¥—å¯ä»¥è·å–runloopä»£ç ï¼Œä¸€ä¸ªæ˜¯<code>Foundation</code>ã€ä¸€ä¸ªæ˜¯<code>Core Foundation</code>ã€‚<br><code>Foundation</code>å…¶å®æ˜¯å¯¹<code>Core Foundation</code>çš„ä¸€ä¸ªå°è£…ï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NSRunLoop * runloop1 = [NSRunLoop currentRunLoop];</span><br><span class="line">NSRunLoop *mainloop1 = [NSRunLoop mainRunLoop];</span><br><span class="line"></span><br><span class="line">CFRunLoopRef runloop2= CFRunLoopGetCurrent();</span><br><span class="line">CFRunLoopRef mainloop2 = CFRunLoopGetMain();</span><br><span class="line">NSLog(@&quot;%p %p %p %p&quot;,runloop1,mainloop1,runloop2,mainloop2);</span><br><span class="line">NSLog(@&quot;%@&quot;,runloop1);</span><br><span class="line">//æ‰“å°</span><br><span class="line">runlopp1:0x600001bc58c0 </span><br><span class="line">mainloop1:0x600001bc58c0 </span><br><span class="line">runloop2:0x6000003cc300 </span><br><span class="line">mainloop1:0x6000003cc300</span><br><span class="line"></span><br><span class="line">runloop1:&lt;CFRunLoop 0x6000003cc300 [0x10b2e9ae8]&gt;.....</span><br></pre></td></tr></table></figure>
<p><code>runloop1</code>å’Œ<code>mainloop1</code>åœ°å€ä¸€è‡´ï¼Œè¯´æ˜å½“å‰çš„<code>runloop</code>æ˜¯<code>mainrunloop</code>,<code>runloop1</code>ä½œä¸ºå¯¹è±¡è¾“å‡ºçš„ç»“æœå…¶å®ä¹Ÿæ˜¯<code>runloop2</code>çš„åœ°å€ï¼Œè¯æ˜<code>Foundation runloop</code>æ˜¯å¯¹<code>Core Foundation</code>çš„ä¸€ä¸ªå°è£…ã€‚</p>
<p><code>RunLoop</code>åº•å±‚æˆ‘ä»¬çŒœæµ‹åº”è¯¥æ˜¯ç»“æ„ä½“ï¼Œæˆ‘ä»¬éƒ½äº†è§£åˆ°å…¶å®<code>OC</code>å°±æ˜¯å°è£…äº†<code>c/c++</code>ï¼Œé‚£ä¹ˆcå‰å®³ä¹‹å¤„å°±æ˜¯æŒ‡é’ˆå’Œç»“æ„ä½“åŸºæœ¬è§£å†³å¸¸ç”¨çš„æ‰€æœ‰ä¸œè¥¿ã€‚æˆ‘ä»¬çª¥æ¢ä¸€ä¸‹<code>runloop</code>çš„çœŸæ˜¯æ¨¡æ ·ï¼Œé€šè¿‡<code>CFRunLoopRef *runloop = CFRunLoopGetMain();</code>æŸ¥çœ‹<code>CFRunloop</code>æ˜¯<code>typedef struct CF_BRIDGED_MUTABLE_TYPE(id) __CFRunLoop * CFRunLoopRef;</code>ï¼Œæˆ‘ä»¬å¸¸ç”¨çš„<code>CFRunLoopRef</code>æ˜¯<code>__CFRunLoop *</code>ç±»å‹çš„ï¼Œé‚£ä¹ˆå†åœ¨<a href="https://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener">æºç (å¯ä»¥ä¸‹è½½æœ€æ–°çš„æºç )</a>ä¸­æœç´¢ä¸€ä¸‹ <code>struct __CFRunLoop {</code>åœ¨<code>runloop.c 637è¡Œ</code>å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">struct __CFRunLoop &#123;</span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    pthread_mutex_t _lock;			/* model list é” */</span><br><span class="line">    __CFPort _wakeUpPort;			// æ¥å— CFRunLoopWakeUpçš„ç«¯å£</span><br><span class="line">    Boolean _unused;//æ˜¯å¦ä½¿ç”¨</span><br><span class="line">    volatile _per_run_data *_perRunData;              // reset for runs of the run loop</span><br><span class="line">    pthread_t _pthread; //çº¿ç¨‹</span><br><span class="line">    uint32_t _winthread;//winçº¿ç¨‹</span><br><span class="line">    CFMutableSetRef _commonModes; //modes</span><br><span class="line">    CFMutableSetRef _commonModeItems; //modeItems</span><br><span class="line">    CFRunLoopModeRef _currentMode; //å½“å‰çš„mode</span><br><span class="line">    CFMutableSetRef _modes; //æ‰€æœ‰çš„modes</span><br><span class="line">    struct _block_item *_blocks_head; //å¾…æ‰§è¡Œçš„blockåˆ—è¡¨å¤´éƒ¨</span><br><span class="line">    struct _block_item *_blocks_tail; //å¾…æ‰§è¡Œçš„block å°¾éƒ¨</span><br><span class="line">    CFAbsoluteTime _runTime; //runtime</span><br><span class="line">    CFAbsoluteTime _sleepTime; //sleeptime</span><br><span class="line">    CFTypeRef _counterpart; //</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡ç®€åŒ–ä¹‹åï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct __CFRunLoop &#123;</span><br><span class="line">    pthread_t _pthread; //çº¿ç¨‹</span><br><span class="line">    CFMutableSetRef _commonModes; //modes</span><br><span class="line">    CFMutableSetRef _commonModeItems; //modeItems</span><br><span class="line">    CFRunLoopModeRef _currentMode; //å½“å‰çš„mode</span><br><span class="line">    CFMutableSetRef _modes; //æ‰€æœ‰çš„modes</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li><code>runloop</code>ä¸­åŒ…å«ä¸€ä¸ªçº¿ç¨‹<code>_pthread</code>ï¼Œä¸€ä¸€å¯¹åº”çš„</li>
<li><code>CFMutableSetRef _modes</code>å¯ä»¥æœ‰å¤šä¸ª<code>mode</code></li>
<li><code>CFRunLoopModeRef _currentMode</code>å½“å‰<code>mode</code>åªèƒ½æœ‰ä¸€ä¸ª</li>
</ol>
<p>é‚£ä¹ˆmodeé‡Œè¾¹æœ‰ä»€ä¹ˆå†…å®¹å‘¢ï¼Ÿæˆ‘ä»¬çŒœæµ‹ä»–åº”è¯¥å’Œ<code>runloop</code>ç±»ä¼¼ï¼Œåœ¨æºç ä¸­æœç´¢<code>CFRuntimeBase _base</code>çœ‹åˆ°åœ¨<code>runloop.c  line 524</code>çœ‹åˆ°å…·ä½“çš„å†…å®¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">struct __CFRunLoopMode &#123;</span><br><span class="line">    CFRuntimeBase _base;</span><br><span class="line">    pthread_mutex_t _lock;	/* must have the run loop locked before locking this */</span><br><span class="line">    CFStringRef _name;</span><br><span class="line">    Boolean _stopped;</span><br><span class="line">    char _padding[3];</span><br><span class="line">    CFMutableSetRef _sources0;</span><br><span class="line">    CFMutableSetRef _sources1;</span><br><span class="line">    CFMutableArrayRef _observers;</span><br><span class="line">    CFMutableArrayRef _timers;</span><br><span class="line">    CFMutableDictionaryRef _portToV1SourceMap;</span><br><span class="line">    __CFPortSet _portSet;</span><br><span class="line">    CFIndex _observerMask;</span><br><span class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</span><br><span class="line">    dispatch_source_t _timerSource;</span><br><span class="line">    dispatch_queue_t _queue;</span><br><span class="line">    Boolean _timerFired; // set to true by the source when a timer has fired</span><br><span class="line">    Boolean _dispatchTimerArmed;</span><br><span class="line">#endif</span><br><span class="line">#if USE_MK_TIMER_TOO</span><br><span class="line">    mach_port_t _timerPort;</span><br><span class="line">    Boolean _mkTimerArmed;</span><br><span class="line">#endif</span><br><span class="line">#if DEPLOYMENT_TARGET_WINDOWS</span><br><span class="line">    DWORD _msgQMask;</span><br><span class="line">    void (*_msgPump)(void);</span><br><span class="line">#endif</span><br><span class="line">    uint64_t _timerSoftDeadline; /* TSR */</span><br><span class="line">    uint64_t _timerHardDeadline; /* TSR */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡ç®€åŒ–ä¹‹åæ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">struct __CFRunLoopMode &#123;</span><br><span class="line">    CFStringRef _name;//å½“å‰modeçš„åå­—</span><br><span class="line">    CFMutableSetRef _sources0;//souces0</span><br><span class="line">    CFMutableSetRef _sources1;//sources1</span><br><span class="line">    CFMutableArrayRef _observers;//observers</span><br><span class="line">    CFMutableArrayRef _timers;//timers</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸€ä¸ª<code>mode</code>å¯ä»¥æœ‰å¤šä¸ª<code>timer</code>ã€<code>souces0</code>ã€<code>souces1</code>ã€<code>observers</code>ã€<code>timers</code><br>é‚£ä¹ˆä½¿ç”¨å›¾æ›´ç›´è§‚çš„æ¥è¡¨ç¤ºï¼š</p>
<p><img src="/images/9-1.png" alt></p>
<p>ä¸€ä¸ª<code>runloop</code>åŒ…å«å¤šä¸ª<code>mode</code>ï¼Œä½†æ˜¯åŒæ—¶åªèƒ½è¿è¡Œä¸€ä¸ª<code>mode</code>ï¼Œè¿™ç‚¹å’Œå¤§å®¶å¼€è½¦çš„é©¾é©¶æ¨¡å¼ç±»ä¼¼ï¼Œè¿åŠ¨æ¨¡å¼å’Œç¯ä¿æ¨¡å¼åŒæ—¶åªèƒ½å¼€ä¸€ä¸ªæ¨¡å¼ï¼Œä¸èƒ½åˆè¿åŠ¨åˆç¯ä¿ï¼Œæ˜æ˜¾ç›¸æ‚–ã€‚å¤šä¸ª<code>mode</code>è¢«éš”ç¦»å¼€æœ‰ç‚¹æ˜¯å¤„ç†äº‹æƒ…æ›´ä¸“ä¸€ï¼Œä¸ä¼šå› ä¸ºå¤šä¸ªåŒæ—¶å¤„ç†äº‹æƒ…é€ æˆå¡é¡¿æˆ–è€…èµ„æºç«äº‰å¯¼è‡´çš„ä¸€ç³»åˆ—é—®é¢˜ã€‚</p>
<h4 id="souces0"><a href="#souces0" class="headerlink" title="souces0"></a>souces0</h4><ul>
<li>è§¦æ‘¸äº‹ä»¶</li>
<li>performSelector:onThread:</li>
</ul>
<p>æµ‹è¯•ä¸‹ç‚¹å‡»äº‹ä»¶å¤„ç†æº</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);//æ­¤å¤„æ–­ç‚¹</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(LLDB) bt //è¾“å‡ºå½“å‰è°ƒç”¨æ ˆ</span><br><span class="line">* thread #1, queue = &apos;com.apple.main-thread&apos;, stop reason = breakpoint 1.1</span><br><span class="line">  * frame #0: 0x000000010c5bb66d CFRunloop`::-[ViewController touchesBegan:withEvent:](self=0x00007fc69ec087e0, _cmd=&quot;touchesBegan:withEvent:&quot;, touches=1 element, event=0x00006000012a01b0) at ViewController.mm:22:2</span><br><span class="line">    frame #1: 0x0000000110685a09 UIKitCore`forwardTouchMethod + 353</span><br><span class="line">    frame #2: 0x0000000110685897 UIKitCore`-[UIResponder touchesBegan:withEvent:] + 49</span><br><span class="line">    frame #3: 0x0000000110694c48 UIKitCore`-[UIWindow _sendTouchesForEvent:] + 1869</span><br><span class="line">    frame #4: 0x00000001106965d2 UIKitCore`-[UIWindow sendEvent:] + 4079</span><br><span class="line">    frame #5: 0x0000000110674d16 UIKitCore`-[UIApplication sendEvent:] + 356</span><br><span class="line">    frame #6: 0x0000000110745293 UIKitCore`__dispatchPreprocessedEventFromEventQueue + 3232</span><br><span class="line">    frame #7: 0x0000000110747bb9 UIKitCore`__handleEventQueueInternal + 5911</span><br><span class="line">    frame #8: 0x000000010d8eabe1 CoreFoundation`__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + 17</span><br><span class="line">    frame #9: 0x000000010d8ea463 CoreFoundation`__CFRunLoopDoSources0 + 243</span><br><span class="line">    frame #10: 0x000000010d8e4b1f CoreFoundation`__CFRunLoopRun + 1231</span><br><span class="line">    frame #11: 0x000000010d8e4302 CoreFoundation`CFRunLoopRunSpecific + 626</span><br><span class="line">    frame #12: 0x0000000115ddc2fe GraphicsServices`GSEventRunModal + 65</span><br><span class="line">    frame #13: 0x000000011065aba2 UIKitCore`UIApplicationMain + 140</span><br><span class="line">    frame #14: 0x000000010c5bb760 CFRunloop`main(argc=1, argv=0x00007ffee3643f68) at main.m:14:13</span><br><span class="line">    frame #15: 0x000000010f1cb541 libdyld.dylib`start + 1</span><br><span class="line">    frame #16: 0x000000010f1cb541 libdyld.dylib`start + 1</span><br></pre></td></tr></table></figure>
<p><code>#1</code>çœ‹åˆ°ç°åœ¨æ˜¯åœ¨é˜Ÿåˆ—queue = â€˜com.apple.main-threadâ€™ä¸­ï¼Œ<code>#10</code> <code>Runloop</code>å¯åŠ¨ï¼Œ<code>#9</code>è¿›å…¥åˆ°<code>__CFRunLoopDoSources0</code>,æœ€ç»ˆ<code>__CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__</code>è°ƒç”¨äº†<code>__handleEventQueueInternal</code>-&gt;<code>[UIApplication sendEvent:]</code>-&gt;<code>[UIWindow sendEvent:]</code>-&gt;<code>[UIWindow _sendTouchesForEvent:]</code>-&gt;<code>[UIResponder touchesBegan:withEvent:]</code>-&gt;<code>-[ViewController touchesBegan:withEvent:](self=0x00007fc69ec087e0, _cmd=&quot;touchesBegan:withEvent:&quot;, touches=1 element, event=0x00006000012a01b0) at ViewController.mm:22:2</code>ï¼Œå¯ä»¥çœ‹åˆ°å¦å¤–ä¸€ä¸ªçŸ¥è¯†ç‚¹ï¼Œæ‰‹åŠ¿çš„ä¼ é€’æ˜¯ä»ä¸Šå¾€ä¸‹çš„ï¼Œé¡ºåºæ˜¯<code>UIApplication -&gt; UIWindow -&gt; UIResponder -&gt; ViewController</code>ã€‚</p>
<h4 id="Source1"><a href="#Source1" class="headerlink" title="Source1"></a>Source1</h4><ul>
<li>åŸºäºPortçš„çº¿ç¨‹é—´é€šä¿¡</li>
<li>ç³»ç»Ÿäº‹ä»¶æ•æ‰</li>
</ul>
<h4 id="Timers"><a href="#Timers" class="headerlink" title="Timers"></a>Timers</h4><ul>
<li>NSTimer</li>
<li>performSelector:withObject:afterDelay:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">	timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, dispatch_get_main_queue());</span><br><span class="line">	static int count = 5;</span><br><span class="line">	dispatch_source_set_timer(timer, DISPATCH_TIME_NOW, 1 * NSEC_PER_SEC, 0 * NSEC_PER_SEC);</span><br><span class="line">	dispatch_source_set_event_handler(timer, ^&#123;</span><br><span class="line">		NSLog(@&quot;-------ï¼š%d \n&quot;,count++);</span><br><span class="line">	&#125;);</span><br><span class="line">	dispatch_resume(timer);</span><br><span class="line">	//log</span><br><span class="line">	(lldb) bt</span><br><span class="line">* thread #1, queue = &apos;com.apple.main-thread&apos;, stop reason = breakpoint 1.1</span><br><span class="line">  * frame #0: 0x0000000101f26457 CFRunloop`::__29-[ViewController viewDidLoad]_block_invoke(.block_descriptor=0x0000000101f28100) at ViewController.mm:72:33</span><br><span class="line">    frame #1: 0x0000000104ac2db5 libdispatch.dylib`_dispatch_client_callout + 8</span><br><span class="line">    frame #2: 0x0000000104ac5c95 libdispatch.dylib`_dispatch_continuation_pop + 552</span><br><span class="line">    frame #3: 0x0000000104ad7e93 libdispatch.dylib`_dispatch_source_invoke + 2249</span><br><span class="line">    frame #4: 0x0000000104acfead libdispatch.dylib`_dispatch_main_queue_callback_4CF + 1073</span><br><span class="line">    frame #5: 0x00000001032568a9 CoreFoundation`__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__ + 9</span><br><span class="line">    frame #6: 0x0000000103250f56 CoreFoundation`__CFRunLoopRun + 2310</span><br><span class="line">    frame #7: 0x0000000103250302 CoreFoundation`CFRunLoopRunSpecific + 626</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆè¿›å…¥å‡½æ•°<code>__CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__</code>è°ƒç”¨äº†<a href="https://opensource.apple.com/tarballs/libdispatch/" target="_blank" rel="noopener">libdispatch</a>çš„<code>_dispatch_main_queue_callback_4CF</code>å‡½æ•°ï¼Œå…·ä½“å®ç°æœ‰å…´è¶£çš„å¤§ä½¬å¯ä»¥çœ‹ä¸‹æºç çš„å®ç°ã€‚</p>
<h4 id="Observers"><a href="#Observers" class="headerlink" title="Observers"></a>Observers</h4><ul>
<li>ç”¨äºç›‘å¬RunLoopçš„çŠ¶æ€</li>
<li>UIåˆ·æ–°ï¼ˆBeforeWaitingï¼‰</li>
<li>Autorelease poolï¼ˆBeforeWaitingï¼‰</li>
</ul>
<p><code>Mode</code>ç±»å‹éƒ½å¤šä¸ª,ç³»ç»Ÿæš´éœ²åœ¨å¤–çš„å°±ä¸¤ä¸ªï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CF_EXPORT const CFRunLoopMode kCFRunLoopDefaultMode;</span><br><span class="line">CF_EXPORT const CFRunLoopMode kCFRunLoopCommonModes;</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆè¿™ä¸¤ä¸ªModeéƒ½æ˜¯åœ¨ä»€ä¹ˆæƒ…å†µä¸‹è¿è¡Œçš„å‘¢ï¼Ÿ</p>
<ol>
<li><code>kCFRunLoopDefaultModeï¼ˆNSDefaultRunLoopModeï¼‰</code>ï¼š<code>App</code>çš„é»˜è®¤<code>Mode</code>ï¼Œé€šå¸¸ä¸»çº¿ç¨‹æ˜¯åœ¨è¿™ä¸ª<code>Mode</code>ä¸‹è¿è¡Œ</li>
<li><code>UITrackingRunLoopMode</code>ï¼šç•Œé¢è·Ÿè¸ª<code>Mode</code>ï¼Œç”¨äº<code>ScrollView</code> è¿½è¸ªè§¦æ‘¸æ»‘åŠ¨ï¼Œä¿è¯ç•Œé¢æ»‘åŠ¨æ—¶ä¸å—å…¶ä»–<code>Mode</code>å½±å“</li>
</ol>
<p>è¿›å…¥åˆ°æŸä¸ª<code>Mode</code>ï¼Œå¤„ç†äº‹æƒ…ä¹Ÿåº”è¯¥æœ‰å…ˆåé¡ºåºå’Œä¼‘æ¯çš„æ—¶é—´ï¼Œé‚£ä¹ˆç°åœ¨éœ€è¦ä¸€ä¸ªçŠ¶æ€æ¥è¡¨ç¤ºæ­¤æ—¶æ­¤åˆ»çš„<code>status</code>ï¼Œç³»ç»Ÿå·²ç»å‡†å¤‡äº†<code>CFRunLoopActivity</code>æ¥è¡¨ç¤ºå½“å‰çš„çŠ¶æ€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;</span><br><span class="line">    kCFRunLoopEntry = (1UL &lt;&lt; 0), //å³å°†è¿›å…¥loop</span><br><span class="line">    kCFRunLoopBeforeTimers = (1UL &lt;&lt; 1),//å³å°†å¤„ç†timers</span><br><span class="line">    kCFRunLoopBeforeSources = (1UL &lt;&lt; 2), //å³å°†å¤„ç†sourcs</span><br><span class="line">    kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5),//å³å°†è¿›å…¥ä¼‘çœ </span><br><span class="line">    kCFRunLoopAfterWaiting = (1UL &lt;&lt; 6),//å³å°†ä»ä¼‘çœ ä¸­å”¤é†’</span><br><span class="line">    kCFRunLoopExit = (1UL &lt;&lt; 7),//å³å°†é€€å‡º</span><br><span class="line">    kCFRunLoopAllActivities = 0x0FFFFFFFU//æ‰€æœ‰çŠ¶æ€</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>1UL</code>è¡¨ç¤ºæ— ç¬¦å·é•¿æ•´å½¢æ•°å­—<code>1</code>ï¼Œå†æ¬¡çœ‹åˆ°è¿™ä¸ª<code>(1UL &lt;&lt; 1)</code>æˆ‘ä¹ˆçŒœæµ‹ç”¨åˆ°äº†<a href="https://juejin.im/post/5d2bcf3df265da1b67213d69" target="_blank" rel="noopener">ä½åŸŸæˆ–è€…è”åˆä½“</a>ï¼Œè¾¾åˆ°çœç©ºé—´çš„ç›®çš„ã€‚<code>kCFRunLoopAllActivities = 0x0FFFFFFFU</code>è½¬æ¢æˆäºŒè¿›åˆ¶å°±æ˜¯28ä¸ª<code>1</code>ï¼Œå†è¿›è¡Œ<code>mask</code>çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„å€¼éƒ½èƒ½å–å‡ºæ¥ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬äº†è§£åˆ°ï¼š</p>
<ol>
<li><code>CFRunloopRef</code>ä»£è¡¨<code>RunLoop</code>çš„è¿è¡Œæ¨¡å¼</li>
<li>ä¸€ä¸ª<code>Runloop</code>åŒ…å«è‹¥å¹²ä¸ª<code>Mode</code>,æ¯ä¸ª<code>Mode</code>åŒ…å«è‹¥å¹²ä¸ª<code>Source0/Source1/Timer/Obser</code></li>
<li><code>Runloop</code>å¯åŠ¨åªèƒ½é€‰æ‹©ä¸€ä¸ª<code>Mode</code>ä½œä¸º<code>currentMode</code></li>
<li>å¦‚æœéœ€è¦åˆ‡æ¢<code>Mode</code>ï¼Œåªèƒ½é€€å‡ºå½“å‰<code>Loop</code>ï¼Œå†é‡æ–°é€‰æ‹©ä¸€ä¸ª<code>Mode</code>è¿›å…¥</li>
<li>ä¸åŒç»„çš„<code>Source0/Source1/Timer/Observer</code>èƒ½åˆ†éš”å¼€æ¥ï¼Œäº’ä¸å½±å“</li>
<li>å¦‚æœ<code>Mode</code>æ²¡æœ‰ä»»ä½•<code>Source0/Source1/Timer/Observer</code>ï¼Œ<code>Runloop</code>ç«‹é©¬é€€å‡ºã€‚</li>
</ol>
<h5 id="runloopåˆ‡æ¢Mode"><a href="#runloopåˆ‡æ¢Mode" class="headerlink" title="runloopåˆ‡æ¢Mode"></a>runloopåˆ‡æ¢Mode</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">CFRunLoopObserverRef obs= CFRunLoopObserverCreateWithHandler(kCFAllocatorDefault, kCFRunLoopAllActivities, YES, 0, ^(CFRunLoopObserverRef observer, CFRunLoopActivity activity) &#123;</span><br><span class="line">    switch (activity) &#123;</span><br><span class="line">    	case kCFRunLoopEntry:&#123;</span><br><span class="line">    		CFRunLoopMode m = CFRunLoopCopyCurrentMode(CFRunLoopGetCurrent());</span><br><span class="line">    		NSLog(@&quot;å³å°†è¿›å…¥ mode:%@&quot;,m);</span><br><span class="line">    		CFRelease(m);</span><br><span class="line">    		break;</span><br><span class="line">    	&#125;</span><br><span class="line">    		</span><br><span class="line">    	case kCFRunLoopExit:</span><br><span class="line">    	&#123;</span><br><span class="line">    		CFRunLoopMode m = CFRunLoopCopyCurrentMode(CFRunLoopGetCurrent());</span><br><span class="line">    		NSLog(@&quot;å³å°†é€€å‡º mode:%@&quot;,m);</span><br><span class="line">    		CFRelease(m);</span><br><span class="line">    		break;</span><br><span class="line">    	&#125;</span><br><span class="line">    	default:</span><br><span class="line">    		break;</span><br><span class="line">    &#125;</span><br><span class="line">	&#125;);</span><br><span class="line">	CFRunLoopAddObserver(CFRunLoopGetMain(), obs, kCFRunLoopCommonModes);</span><br><span class="line">	CFRelease(obs);</span><br><span class="line">	</span><br><span class="line">	//å½“æ»‘åŠ¨tbçš„æ—¶å€™log</span><br><span class="line">	</span><br><span class="line">å³å°†é€€å‡º mode:kCFRunLoopDefaultMode</span><br><span class="line">å³å°†è¿›å…¥ mode:UITrackingRunLoopMode</span><br><span class="line">å³å°†é€€å‡º mode:UITrackingRunLoopMode</span><br><span class="line">å³å°†è¿›å…¥ mode:kCFRunLoopDefaultMode</span><br></pre></td></tr></table></figure>
<p>å½“<code>runloop</code>åˆ‡æ¢<code>mode</code>çš„æ—¶å€™ï¼Œä¼šé€€å‡ºå½“å‰<code>kCFRunLoopDefaultMode</code>ï¼ŒåŠ å…¥åˆ°å…¶ä»–çš„<code>UITrackingRunLoopMode</code>ï¼Œå½“å‰<code>UITrackingRunLoopMode</code>å®Œæˆä¹‹åå†é€€å‡ºä¹‹åå†åŠ å…¥åˆ°<code>kCFRunLoopDefaultMode</code>ã€‚</p>
<p>æˆ‘ä»¬å†æ¢ç©¶ä¸‹<code>runloop</code>çš„å¾ªç¯çš„çŠ¶æ€åˆ°åº•æ˜¯æ€æ ·æ¥å˜æ›´çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">//	//è·å–loop</span><br><span class="line">	CFRunLoopRef ref = CFRunLoopGetMain();</span><br><span class="line">	//è·å–obs</span><br><span class="line">	CFRunLoopObserverRef obs = CFRunLoopObserverCreate(kCFAllocatorDefault,kCFRunLoopAllActivities, YES, 0, callback, NULL);</span><br><span class="line">	//æ·»åŠ ç›‘å¬</span><br><span class="line">	CFRunLoopAddObserver(ref, obs, CFRunLoopCopyCurrentMode(ref));</span><br><span class="line">	CFRelease(obs);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">int count = 0;//å®šä¹‰å…¨å±€å˜é‡æ¥è®¡ç®—ä¸€ä¸ªmodeä¸­çŠ¶æ€åˆ‡æ¢çš„ç»Ÿè®¡æ•°æ®</span><br><span class="line">void callback(CFRunLoopObserverRef observer, CFRunLoopActivity activity, void *info)&#123;</span><br><span class="line">	printf(&quot;- &quot;);</span><br><span class="line">	count ++;</span><br><span class="line">	printf(&quot;%d&quot;,count);</span><br><span class="line">	switch (activity) &#123;</span><br><span class="line">		case kCFRunLoopEntry:</span><br><span class="line">			printf(&quot;å³å°†è¿›å…¥ \n&quot;);</span><br><span class="line">			count = 0;</span><br><span class="line">			break;</span><br><span class="line">		case kCFRunLoopExit:</span><br><span class="line">			printf(&quot;å³å°†é€€å‡º \n&quot;);</span><br><span class="line">			break;</span><br><span class="line">		case kCFRunLoopAfterWaiting:</span><br><span class="line">			printf(&quot;å³å°†ä»ä¼‘çœ ä¸­å”¤é†’ \n&quot;);</span><br><span class="line">			break;</span><br><span class="line">		case kCFRunLoopBeforeTimers:</span><br><span class="line">			printf(&quot;å³å°†è¿›å…¥å¤„ç† timers \n&quot;);</span><br><span class="line">			break;</span><br><span class="line">		case kCFRunLoopBeforeSources:</span><br><span class="line">			printf(&quot;å³å°†è¿›å…¥ sources \n&quot;);</span><br><span class="line">			break;</span><br><span class="line">		case kCFRunLoopBeforeWaiting:</span><br><span class="line">			printf(&quot;å³å°†è¿›å…¥ ä¼‘çœ  \n&quot;);</span><br><span class="line">			count = 0;</span><br><span class="line">			break;</span><br><span class="line">		default:</span><br><span class="line">			break;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//ç‚¹å‡»çš„æ—¶å€™ ä¼šå‡ºå‘loopæ¥å¤„ç†è§¦æ‘¸äº‹ä»¶</span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">- 1å³å°†ä»ä¼‘çœ ä¸­å”¤é†’ </span><br><span class="line">- 2å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 3å³å°†è¿›å…¥ sources </span><br><span class="line">-[ViewController touchesBegan:withEvent:]</span><br><span class="line">- 4å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 5å³å°†è¿›å…¥ sources </span><br><span class="line">- 6å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 7å³å°†è¿›å…¥ sources </span><br><span class="line">- 8å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 9å³å°†è¿›å…¥ sources </span><br><span class="line">- 10å³å°†è¿›å…¥ ä¼‘çœ  </span><br><span class="line">- 1å³å°†ä»ä¼‘çœ ä¸­å”¤é†’ </span><br><span class="line">- 2å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 3å³å°†è¿›å…¥ sources </span><br><span class="line">- 4å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 5å³å°†è¿›å…¥ sources </span><br><span class="line">- 6å³å°†è¿›å…¥ ä¼‘çœ  </span><br><span class="line">- 1å³å°†ä»ä¼‘çœ ä¸­å”¤é†’ </span><br><span class="line">- 2å³å°†è¿›å…¥å¤„ç† timers </span><br><span class="line">- 3å³å°†è¿›å…¥ sources </span><br><span class="line">- 4å³å°†è¿›å…¥ ä¼‘çœ </span><br></pre></td></tr></table></figure>
<p><code>runloop</code>å”¤é†’ä¹‹åä¸æ˜¯ç«‹é©¬å¤„ç†äº‹ä»¶çš„ï¼Œè€Œæ˜¯çœ‹çœ‹<code>timer</code>æœ‰æ²¡æœ‰äº‹æƒ…ï¼Œç„¶åæ˜¯<code>sources</code>,å‘ç°æœ‰è§¦æ‘¸äº‹ä»¶å°±å¤„ç†äº†ï¼Œç„¶ååˆå¾ªç¯æŸ¥çœ‹<code>timer</code>å’Œ<code>sources</code>ä¸€èˆ¬å¾ªç¯2æ¬¡è¿›å…¥ä¼‘çœ çŠ¶æ€ï¼Œå¤„ç†<code>source</code>ä¹‹åæ˜¯å¾ªç¯ä¸‰æ¬¡ã€‚</p>
<h5 id="RunLoopåœ¨ä¸è·å–çš„æ—¶å€™ä¸å­˜åœ¨-è·å–æ‰ç”Ÿæˆ"><a href="#RunLoopåœ¨ä¸è·å–çš„æ—¶å€™ä¸å­˜åœ¨-è·å–æ‰ç”Ÿæˆ" class="headerlink" title="RunLoopåœ¨ä¸è·å–çš„æ—¶å€™ä¸å­˜åœ¨,è·å–æ‰ç”Ÿæˆ"></a>RunLoopåœ¨ä¸è·å–çš„æ—¶å€™ä¸å­˜åœ¨,è·å–æ‰ç”Ÿæˆ</h5><p><code>RunLoop</code>æ˜¯åœ¨ä¸»åŠ¨è·å–çš„æ—¶å€™æ‰ä¼šç”Ÿæˆä¸€ä¸ªï¼Œä¸»çº¿ç¨‹æ˜¯ç³»ç»Ÿè‡ªå·±è°ƒç”¨ç”Ÿæˆçš„ï¼Œå­çº¿ç¨‹å¼€å‘è€…è°ƒç”¨ï¼Œæˆ‘ä»¬çœ‹ä¸‹<code>CFRunLoopGetCurrent</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CFRunLoopRef CFRunLoopGetCurrent(void) &#123;</span><br><span class="line">    CHECK_FOR_FORK();</span><br><span class="line">    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</span><br><span class="line">    if (rl) return rl;</span><br><span class="line">    return _CFRunLoopGet0(pthread_self());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>çœ‹åˆ°åˆ°è¿™é‡Œç›¸ä¿¡å¤§å®¶å·²ç»å¯¹<code>runloop</code>æœ‰äº†åŸºæœ¬çš„è®¤è¯†ï¼Œé‚£ä¹ˆæˆ‘ä»¬å†æ¢ç©¶ä¸€ä¸‹åº•å±‚<code>runloop</code>æ˜¯æ€ä¹ˆè¿è½¬çš„ã€‚</p>
<p>é¦–å…ˆçœ‹å®˜æ–¹ç»™çš„å›¾ï¼š</p>
<p><img src="/images/9-2.png" alt><br>é‚£æˆ‘åˆæ•´ç†äº†ä¸€ä¸ªè¡¨æ ¼æ¥æ›´ç›´è§‚çš„äº†è§£çŠ¶æ€è¿è½¬</p>
<table>
<thead>
<tr>
<th style="text-align:center">æ­¥éª¤</th>
<th style="text-align:center">ä»»åŠ¡</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">1</td>
<td style="text-align:center">é€šçŸ¥Observers:è¿›å…¥Loop</td>
</tr>
<tr>
<td style="text-align:center">2</td>
<td style="text-align:center">é€šçŸ¥Observers:å³å°†å¤„ç†Timers</td>
</tr>
<tr>
<td style="text-align:center">3</td>
<td style="text-align:center">é€šçŸ¥Observers:å³å°†å¤„ç†Sources</td>
</tr>
<tr>
<td style="text-align:center">4</td>
<td style="text-align:center">å¤„ç†blocks</td>
</tr>
<tr>
<td style="text-align:center">5</td>
<td style="text-align:center">å¤„ç†Source0(å¯èƒ½å†å¤„ç†Blocks)</td>
</tr>
<tr>
<td style="text-align:center">6</td>
<td style="text-align:center">å¦‚æœå­˜åœ¨Source1ï¼Œè·³è½¬ç¬¬8æ­¥</td>
</tr>
<tr>
<td style="text-align:center">7</td>
<td style="text-align:center">é€šçŸ¥Observers:å¼€å§‹ä¼‘çœ </td>
</tr>
<tr>
<td style="text-align:center">8</td>
<td style="text-align:center">é€šçŸ¥Observers:ç»“æŸä¼‘çœ 1.å¤„ç†Timer2.å¤„ç†GCD Asyn To Main Queue 3.å¤„ç†Source1</td>
</tr>
<tr>
<td style="text-align:center">9</td>
<td style="text-align:center">å¤„ç†Blocks</td>
</tr>
<tr>
<td style="text-align:center">10</td>
<td style="text-align:center">æ ¹æ®å‰é¢çš„æ‰§è¡Œç»“æœï¼Œå†³å®šå¦‚ä½•æ“ä½œ1.è¿”å›ç¬¬2æ­¥ï¼Œ2é€€å‡ºloop</td>
</tr>
<tr>
<td style="text-align:center">11</td>
<td style="text-align:center">é€šçŸ¥Observers:é€€å‡ºLoop</td>
</tr>
</tbody>
</table>
<p>æŸ¥çœ‹<a href="https://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener">runloopæºç </a>ä¸­<code>runloop.c</code>2333è¡Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br></pre></td><td class="code"><pre><span class="line">//å…¥å£å‡½æ•°</span><br><span class="line">static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</span><br><span class="line">    uint64_t startTSR = mach_absolute_time();</span><br><span class="line"></span><br><span class="line">    if (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">        __CFRunLoopUnsetStopped(rl);</span><br><span class="line">	return kCFRunLoopRunStopped;</span><br><span class="line">    &#125; else if (rlm-&gt;_stopped) &#123;</span><br><span class="line">	rlm-&gt;_stopped = false;</span><br><span class="line">	return kCFRunLoopRunStopped;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    mach_port_name_t dispatchPort = MACH_PORT_NULL;</span><br><span class="line">    Boolean libdispatchQSafe = pthread_main_np() &amp;&amp; ((HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; NULL == previousMode) || (!HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; 0 == _CFGetTSD(__CFTSDKeyIsInGCDMainQ)));</span><br><span class="line">    if (libdispatchQSafe &amp;&amp; (CFRunLoopGetMain() == rl) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name)) dispatchPort = _dispatch_get_main_queue_port_4CF();</span><br><span class="line">    </span><br><span class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</span><br><span class="line">    mach_port_name_t modeQueuePort = MACH_PORT_NULL;</span><br><span class="line">    if (rlm-&gt;_queue) &#123;</span><br><span class="line">        modeQueuePort = _dispatch_runloop_root_queue_get_port_4CF(rlm-&gt;_queue);</span><br><span class="line">        if (!modeQueuePort) &#123;</span><br><span class="line">            CRASH(&quot;Unable to get port for run loop mode queue (%d)&quot;, -1);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">    </span><br><span class="line">    dispatch_source_t timeout_timer = NULL;</span><br><span class="line">    struct __timeout_context *timeout_context = (struct __timeout_context *)malloc(sizeof(*timeout_context));</span><br><span class="line">    if (seconds &lt;= 0.0) &#123; // instant timeout</span><br><span class="line">        seconds = 0.0;</span><br><span class="line">        timeout_context-&gt;termTSR = 0ULL;</span><br><span class="line">    &#125; else if (seconds &lt;= TIMER_INTERVAL_LIMIT) &#123;</span><br><span class="line">	dispatch_queue_t queue = pthread_main_np() ? __CFDispatchQueueGetGenericMatchingMain() : __CFDispatchQueueGetGenericBackground();</span><br><span class="line">	timeout_timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);</span><br><span class="line">        dispatch_retain(timeout_timer);</span><br><span class="line">	timeout_context-&gt;ds = timeout_timer;</span><br><span class="line">	timeout_context-&gt;rl = (CFRunLoopRef)CFRetain(rl);</span><br><span class="line">	timeout_context-&gt;termTSR = startTSR + __CFTimeIntervalToTSR(seconds);</span><br><span class="line">	dispatch_set_context(timeout_timer, timeout_context); // source gets ownership of context</span><br><span class="line">	dispatch_source_set_event_handler_f(timeout_timer, __CFRunLoopTimeout);</span><br><span class="line">        dispatch_source_set_cancel_handler_f(timeout_timer, __CFRunLoopTimeoutCancel);</span><br><span class="line">        uint64_t ns_at = (uint64_t)((__CFTSRToTimeInterval(startTSR) + seconds) * 1000000000ULL);</span><br><span class="line">        dispatch_source_set_timer(timeout_timer, dispatch_time(1, ns_at), DISPATCH_TIME_FOREVER, 1000ULL);</span><br><span class="line">        dispatch_resume(timeout_timer);</span><br><span class="line">    &#125; else &#123; // infinite timeout</span><br><span class="line">        seconds = 9999999999.0;</span><br><span class="line">        timeout_context-&gt;termTSR = UINT64_MAX;</span><br><span class="line">    &#125;</span><br><span class="line">    Boolean didDispatchPortLastTime = true;</span><br><span class="line">    int32_t retVal = 0;</span><br><span class="line">    do &#123;</span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">        voucher_mach_msg_state_t voucherState = VOUCHER_MACH_MSG_STATE_UNCHANGED;</span><br><span class="line">        voucher_t voucherCopy = NULL;</span><br><span class="line">#endif</span><br><span class="line">        uint8_t msg_buffer[3 * 1024];</span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">        mach_msg_header_t *msg = NULL;</span><br><span class="line">        mach_port_t livePort = MACH_PORT_NULL;</span><br><span class="line">#endif</span><br><span class="line">	__CFPortSet waitSet = rlm-&gt;_portSet;</span><br><span class="line"></span><br><span class="line">        __CFRunLoopUnsetIgnoreWakeUps(rl);</span><br><span class="line">//é€šçŸ¥å³å°†å¤„ç†Timers</span><br><span class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers)</span><br><span class="line">			__CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</span><br><span class="line">//é€šçŸ¥å³å°†å¤„ç†Sources</span><br><span class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources)</span><br><span class="line">			__CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</span><br><span class="line">//å¤„ç†Blocks</span><br><span class="line">	__CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">//å¤„ç†Source0</span><br><span class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</span><br><span class="line">        if (sourceHandledThisLoop) &#123;</span><br><span class="line">	//å¤„ç†Block</span><br><span class="line">            __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">	&#125;</span><br><span class="line">        Boolean poll = sourceHandledThisLoop || (0ULL == timeout_context-&gt;termTSR);</span><br><span class="line"></span><br><span class="line">        if (MACH_PORT_NULL != dispatchPort &amp;&amp; !didDispatchPortLastTime) &#123;</span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">            msg = (mach_msg_header_t *)msg_buffer;</span><br><span class="line">	//yåˆ¤æ–­æ˜¯å¦æœ‰Source1</span><br><span class="line">            if (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, sizeof(msg_buffer), &amp;livePort, 0, &amp;voucherState, NULL)) &#123;</span><br><span class="line">	//æœ‰åˆ™å» handle_msg</span><br><span class="line">                goto handle_msg;</span><br><span class="line">            &#125;</span><br><span class="line">#endif</span><br><span class="line">        &#125;</span><br><span class="line">        didDispatchPortLastTime = false;</span><br><span class="line">//å³å°†è¿›å…¥ä¼‘çœ </span><br><span class="line">	if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</span><br><span class="line">	//å¼€å§‹ä¼‘çœ </span><br><span class="line">	__CFRunLoopSetSleeping(rl);</span><br><span class="line"></span><br><span class="line">    __CFPortSetInsert(dispatchPort, waitSet);</span><br><span class="line">        </span><br><span class="line">	__CFRunLoopModeUnlock(rlm);</span><br><span class="line">	__CFRunLoopUnlock(rl);</span><br><span class="line"></span><br><span class="line">        CFAbsoluteTime sleepStart = poll ? 0.0 : CFAbsoluteTimeGetCurrent();</span><br><span class="line"></span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</span><br><span class="line">        do &#123;</span><br><span class="line">            if (kCFUseCollectableAllocator) &#123;</span><br><span class="line"></span><br><span class="line">                memset(msg_buffer, 0, sizeof(msg_buffer));</span><br><span class="line">            &#125;</span><br><span class="line">            msg = (mach_msg_header_t *)msg_buffer;</span><br><span class="line">            //ç­‰å¾…æ¶ˆæ¯æ¥å”¤é†’å½“å‰çº¿ç¨‹</span><br><span class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line">			</span><br><span class="line">            if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</span><br><span class="line">          (_dispatch_runloop_root_queue_perform_4CF(rlm-&gt;_queue));</span><br><span class="line">                if (rlm-&gt;_timerFired) &#123;</span><br><span class="line"></span><br><span class="line">                    rlm-&gt;_timerFired = false;</span><br><span class="line">                    break;</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    if (msg &amp;&amp; msg != (mach_msg_header_t *)msg_buffer) free(msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // Go ahead and leave the inner loop.</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; while (1);</span><br><span class="line">#else</span><br><span class="line">        if (kCFUseCollectableAllocator) &#123;</span><br><span class="line">            memset(msg_buffer, 0, sizeof(msg_buffer));</span><br><span class="line">        &#125;</span><br><span class="line">        msg = (mach_msg_header_t *)msg_buffer;</span><br><span class="line">        __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line">#endif</span><br><span class="line">        </span><br><span class="line">        __CFRunLoopLock(rl);</span><br><span class="line">        __CFRunLoopModeLock(rlm);</span><br><span class="line"></span><br><span class="line">        rl-&gt;_sleepTime += (poll ? 0.0 : (CFAbsoluteTimeGetCurrent() - sleepStart));</span><br><span class="line"></span><br><span class="line">        __CFPortSetRemove(dispatchPort, waitSet);</span><br><span class="line">        </span><br><span class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</span><br><span class="line"></span><br><span class="line">        // user callouts now OK again</span><br><span class="line">	__CFRunLoopUnsetSleeping(rl);</span><br><span class="line">	if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting))</span><br><span class="line">	//ç»“æŸä¼‘çœ </span><br><span class="line">		__CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</span><br><span class="line">//æ ‡ç­¾ handle_msg</span><br><span class="line">        handle_msg:;</span><br><span class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</span><br><span class="line">		</span><br><span class="line">        if (MACH_PORT_NULL == livePort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_NOTHING();</span><br><span class="line">            // handle nothing</span><br><span class="line">        &#125; else if (livePort == rl-&gt;_wakeUpPort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_WAKEUP();</span><br><span class="line">			</span><br><span class="line">        &#125;</span><br><span class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</span><br><span class="line">        else if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</span><br><span class="line">	//è¢«timerå”¤é†’</span><br><span class="line">			CFRUNLOOP_WAKEUP_FOR_TIMER();</span><br><span class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">#if USE_MK_TIMER_TOO</span><br><span class="line">        else if (rlm-&gt;_timerPort != MACH_PORT_NULL &amp;&amp; livePort == rlm-&gt;_timerPort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</span><br><span class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">	//è¢«GCDæ¢é†’</span><br><span class="line">        else if (livePort == dispatchPort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_DISPATCH();</span><br><span class="line">            __CFRunLoopModeUnlock(rlm);</span><br><span class="line">            __CFRunLoopUnlock(rl);</span><br><span class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)6, NULL);</span><br><span class="line">	//å¤„ç†GCD</span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)0, NULL);</span><br><span class="line">            __CFRunLoopLock(rl);</span><br><span class="line">            __CFRunLoopModeLock(rlm);</span><br><span class="line">            sourceHandledThisLoop = true;</span><br><span class="line">            didDispatchPortLastTime = true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">	//å¤„ç†Source1</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_SOURCE();</span><br><span class="line">			</span><br><span class="line">            voucher_t previousVoucher = _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, (void *)voucherCopy, os_release);</span><br><span class="line"></span><br><span class="line">            CFRunLoopSourceRef rls = __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort);</span><br><span class="line">            if (rls) &#123;</span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">		mach_msg_header_t *reply = NULL;</span><br><span class="line">		sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</span><br><span class="line">		if (NULL != reply) &#123;</span><br><span class="line">		    (void)mach_msg(reply, MACH_SEND_MSG, reply-&gt;msgh_size, 0, MACH_PORT_NULL, 0, MACH_PORT_NULL);</span><br><span class="line">		    CFAllocatorDeallocate(kCFAllocatorSystemDefault, reply);</span><br><span class="line">		&#125;</span><br><span class="line">#endif</span><br><span class="line">	    &#125;</span><br><span class="line">            </span><br><span class="line">            _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, previousVoucher, os_release);</span><br><span class="line">        &#125;</span><br><span class="line">        //å¤„ç†bBlock</span><br><span class="line">	__CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        </span><br><span class="line">//è®¾ç½®è¿”å›å€¼</span><br><span class="line">	if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">	    retVal = kCFRunLoopRunHandledSource;</span><br><span class="line">        &#125; else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunTimedOut;</span><br><span class="line">	&#125; else if (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">            __CFRunLoopUnsetStopped(rl);</span><br><span class="line">	    retVal = kCFRunLoopRunStopped;</span><br><span class="line">	&#125; else if (rlm-&gt;_stopped) &#123;</span><br><span class="line">	    rlm-&gt;_stopped = false;</span><br><span class="line">	    retVal = kCFRunLoopRunStopped;</span><br><span class="line">	&#125; else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</span><br><span class="line">	    retVal = kCFRunLoopRunFinished;</span><br><span class="line">	&#125;</span><br><span class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</span><br><span class="line">        voucher_mach_msg_revert(voucherState);</span><br><span class="line">        os_release(voucherCopy);</span><br><span class="line">#endif</span><br><span class="line">    &#125; while (0 == retVal);</span><br><span class="line">    if (timeout_timer) &#123;</span><br><span class="line">        dispatch_source_cancel(timeout_timer);</span><br><span class="line">        dispatch_release(timeout_timer);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        free(timeout_context);</span><br><span class="line">    &#125;</span><br><span class="line">    return retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡åŠè¿›ä¸€æ­¥ç²¾ç®€</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">//å…¥å£å‡½æ•°</span><br><span class="line">static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</span><br><span class="line">    uint64_t startTSR = mach_absolute_time();</span><br><span class="line"></span><br><span class="line">    if (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">        __CFRunLoopUnsetStopped(rl);</span><br><span class="line">	return kCFRunLoopRunStopped;</span><br><span class="line">    &#125; else if (rlm-&gt;_stopped) &#123;</span><br><span class="line">	rlm-&gt;_stopped = false;</span><br><span class="line">	return kCFRunLoopRunStopped;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Boolean didDispatchPortLastTime = true;</span><br><span class="line">    int32_t retVal = 0;</span><br><span class="line">    do &#123;</span><br><span class="line">        __CFRunLoopUnsetIgnoreWakeUps(rl);</span><br><span class="line">//é€šçŸ¥å³å°†å¤„ç†Timers</span><br><span class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers)</span><br><span class="line">			__CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</span><br><span class="line">//é€šçŸ¥å³å°†å¤„ç†Sources</span><br><span class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources)</span><br><span class="line">			__CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</span><br><span class="line">//å¤„ç†Blocks</span><br><span class="line">	__CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">//å¤„ç†Source0</span><br><span class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</span><br><span class="line">        if (sourceHandledThisLoop) &#123;</span><br><span class="line">	//å¤„ç†Block</span><br><span class="line">            __CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">	&#125;</span><br><span class="line">            msg = (mach_msg_header_t *)msg_buffer;</span><br><span class="line">	//yåˆ¤æ–­æ˜¯å¦æœ‰Source1</span><br><span class="line">            if (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, sizeof(msg_buffer), &amp;livePort, 0, &amp;voucherState, NULL)) &#123;</span><br><span class="line">	//æœ‰åˆ™å» handle_msg</span><br><span class="line">                goto handle_msg;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">//å³å°†è¿›å…¥ä¼‘çœ </span><br><span class="line">	if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</span><br><span class="line">	//å¼€å§‹ä¼‘çœ </span><br><span class="line">	__CFRunLoopSetSleeping(rl);</span><br><span class="line">        do &#123;</span><br><span class="line">    //ç­‰å¾…æ¶ˆæ¯æ¥å”¤é†’å½“å‰çº¿ç¨‹</span><br><span class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</span><br><span class="line">        &#125; while (1);</span><br><span class="line">#else</span><br><span class="line">	if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting))</span><br><span class="line">	//ç»“æŸä¼‘çœ </span><br><span class="line">		__CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</span><br><span class="line">//æ ‡ç­¾ handle_msg</span><br><span class="line">        handle_msg:;</span><br><span class="line">	//è¢«timerå”¤é†’</span><br><span class="line">			CFRUNLOOP_WAKEUP_FOR_TIMER();</span><br><span class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">#if USE_MK_TIMER_TOO</span><br><span class="line">        else if (rlm-&gt;_timerPort != MACH_PORT_NULL &amp;&amp; livePort == rlm-&gt;_timerPort) &#123;</span><br><span class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</span><br><span class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</span><br><span class="line">                __CFArmNextTimerInMode(rlm, rl);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">#endif</span><br><span class="line">	//è¢«GCDæ¢é†’</span><br><span class="line">        else if (livePort == dispatchPort) &#123;</span><br><span class="line">	//å¤„ç†GCD</span><br><span class="line">            __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            CFRunLoopSourceRef rls = __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort);</span><br><span class="line">	//å¤„ç†Source1</span><br><span class="line">		sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</span><br><span class="line">            // Restore the previous voucher</span><br><span class="line">            _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, previousVoucher, os_release);</span><br><span class="line">        &#125;</span><br><span class="line">        //å¤„ç†bBlock</span><br><span class="line">	__CFRunLoopDoBlocks(rl, rlm);</span><br><span class="line">        </span><br><span class="line">    //è®¾ç½®è¿”å›å€¼</span><br><span class="line">	if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</span><br><span class="line">	    retVal = kCFRunLoopRunHandledSource;</span><br><span class="line">        &#125; else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</span><br><span class="line">            retVal = kCFRunLoopRunTimedOut;</span><br><span class="line">	&#125; else if (__CFRunLoopIsStopped(rl)) &#123;</span><br><span class="line">            __CFRunLoopUnsetStopped(rl);</span><br><span class="line">	    retVal = kCFRunLoopRunStopped;</span><br><span class="line">	&#125; else if (rlm-&gt;_stopped) &#123;</span><br><span class="line">	    rlm-&gt;_stopped = false;</span><br><span class="line">	    retVal = kCFRunLoopRunStopped;</span><br><span class="line">	&#125; else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</span><br><span class="line">	    retVal = kCFRunLoopRunFinished;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125; while (0 == retVal);</span><br><span class="line">    return retVal;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç²¾ç®€åˆ°è¿™é‡ŒåŸºæœ¬éƒ½èƒ½çœ‹æ‡‚äº†ï¼Œè¿˜å†™äº†å¾ˆå¤šæ³¨é‡Šï¼ŒåŸºæœ¬å’Œä¸Šé¢æ•´ç†çš„è¡¨æ ¼ä¸€è‡´ã€‚<br>è¿™é‡Œçš„çº¿ç¨‹ä¼‘çœ <code>__CFRunLoopServiceMachPort</code>æ˜¯è°ƒç”¨å†…æ ¸å‡½æ•°<a href="http://web.mit.edu/darwin/src/modules/xnu/osfmk/man/mach_msg.html" target="_blank" rel="noopener">mach_msg()</a>è¿›è¡Œä¼‘çœ ï¼Œå’Œæˆ‘ä»¬å¹³æ—¶<code>while(1)</code>å¤§ä¸åŒï¼Œ<code>while(1)</code>å«æ­»å¾ªç¯ï¼Œå…¶å®ç³»ç»Ÿæ¯æ—¶æ¯åˆ»éƒ½åœ¨åˆ¤æ–­æ˜¯å¦ç¬¦åˆæ¡ä»¶ï¼Œè€—è´¹å¾ˆé«˜çš„CPUï¼Œå†…æ ¸åˆ™ä¸åŒï¼ŒMachå†…æ ¸æä¾›é¢å‘æ¶ˆæ¯ï¼ŒåŸºäºåŸºç¡€çš„è¿›ç¨‹é—´é€šä¿¡ã€‚</p>
<h4 id="ä¿æ´»æœºåˆ¶"><a href="#ä¿æ´»æœºåˆ¶" class="headerlink" title="ä¿æ´»æœºåˆ¶"></a>ä¿æ´»æœºåˆ¶</h4><p>ä¸€ä¸ªç¨‹åºè¿è¡Œå®Œæ¯•ç»“æŸäº†å°±æ­»æ‰äº†ï¼Œ<code>timer</code>å’Œå˜é‡ä¹Ÿä¸€æ ·ï¼Œè¿è¡Œå®Œæ¯•å°±ç»“æŸäº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆå¯ä»¥ä¿è¯<code>timer</code>ä¸€ç›´æ´»è·ƒå’Œçº¿ç¨‹ä¸ç»“æŸå‘¢ï¼Ÿ</p>
<h5 id="timerä¿æ´»å’Œå¤šmodeè¿è¡Œ"><a href="#timerä¿æ´»å’Œå¤šmodeè¿è¡Œ" class="headerlink" title="timerä¿æ´»å’Œå¤šmodeè¿è¡Œ"></a>timerä¿æ´»å’Œå¤šmodeè¿è¡Œ</h5><p><code>timer</code>å¯ä»¥æ·»åŠ åˆ°<code>self</code>çš„å±æ€§ä¿è¯ä¸€ç›´æ´»ç€ï¼Œåªè¦<code>self</code>ä¸æ­»ï¼Œ<code>timer</code>å°±ä¸æ­»ã€‚<code>timer</code>é»˜è®¤æ˜¯æ·»åŠ åˆ°<code>NSDefaultRunLoopMode</code>æ¨¡å¼ä¸­ï¼Œå› ä¸º<code>RunLoop</code>åŒæ—¶è¿è¡Œåªèƒ½æœ‰ä¸€ä¸ªæ¨¡å¼ï¼Œé‚£ä¹ˆåœ¨æ»‘åŠ¨<code>scroller</code>çš„æ—¶å€™æ€<code>Timer</code>ä¼šå¡é¡¿åœæ­¢ç›´åˆ°å†æ¬¡åˆ‡æ¢å›æ¥ï¼Œé‚£ä¹ˆå¦‚ä½•ä¿è¯åŒæ—¶ä¸¤ä¸ªæ¨¡å¼éƒ½å¯ä»¥è¿è¡Œå‘¢ï¼Ÿ<br><code>Foundation</code>æä¾›äº†ä¸€ä¸ªAPI<code>(void)addTimer:(NSTimer *)timer forMode:(NSRunLoopMode)mode</code>æ·»åŠ ä¸Šï¼Œ<code>mode</code>å€¼ä¸º<code>NSRunLoopCommonModes</code>å¯ä»¥ä¿è¯åŒæ—¶å…¼é¡¾2ç§æ¨¡å¼ã€‚</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static int i = 0;</span><br><span class="line">NSTimer *timer=[NSTimer timerWithTimeInterval:1 repeats:YES block:^(NSTimer * _Nonnull timer) &#123;</span><br><span class="line">	NSLog(@&quot;%d&quot;,++i);</span><br><span class="line">&#125;];</span><br><span class="line">//NSRunLoopCommonModes å¹¶ä¸æ˜¯ä¸€ä¸ªçœŸæ­£çš„æ¨¡å¼ï¼Œå®ƒè¿™è¿˜æ˜¯ä¸€ä¸ªæ ‡è®°</span><br><span class="line">//timeråœ¨è®¾ç½®ä¸ºcommonæ¨¡å¼ä¸‹èƒ½è¿è¡Œ</span><br><span class="line">//NSRunLoopCommonModes èƒ½åœ¨ _commentModesä¸­æ•°ç»„ä¸­çš„æ¨¡å¼éƒ½å¯ä»¥è¿è¡Œ</span><br><span class="line">//[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSDefaultRunLoopMode];//é»˜è®¤çš„æ¨¡å¼</span><br><span class="line">[[NSRunLoop currentRunLoop] addTimer:timer forMode:NSRunLoopCommonModes];</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line">	</span><br><span class="line">2019-07-23 15:14:31 CFRunloop[62358:34093079] 1</span><br><span class="line">2019-07-23 15:14:32 CFRunloop[62358:34093079] 2</span><br><span class="line">2019-07-23 15:14:33 CFRunloop[62358:34093079] 3</span><br><span class="line">2019-07-23 15:14:34 CFRunloop[62358:34093079] 4</span><br><span class="line">2019-07-23 15:14:35 CFRunloop[62358:34093079] 5</span><br><span class="line">2019-07-23 15:14:36 CFRunloop[62358:34093079] 6</span><br><span class="line">2019-07-23 15:14:37 CFRunloop[62358:34093079] 7</span><br><span class="line">2019-07-23 15:14:38 CFRunloop[62358:34093079] 8</span><br></pre></td></tr></table></figure>
<p>å½“æ»‘åŠ¨çš„æ—¶å€™<code>timer</code>çš„æ—¶å€™ï¼Œ<code>timer</code>è¿˜æ˜¯å¦‚æ­¤ä¸æ»‘ï¼Œæ²¡æœ‰ä¸€ç‚¹åœé¡¿ã€‚<br>æ²¡æœ‰å¡é¡¿ä¹‹åæˆ‘ä»¬<code>VC -&gt; dealloc</code>ä¸­<code>timer</code>è¿˜æ˜¯åœ¨æ‰§è¡Œï¼Œé‚£ä¹ˆéœ€è¦åœ¨<code>dealloc</code>ä¸­å»ä¸‹å’Œåˆ é™¤è§‚å¯Ÿè€…</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-(void)dealloc&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	CFRunLoopRemoveObserver(CFRunLoopGetMain(), obs, m);</span><br><span class="line">	dispatch_source_cancel(timer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é€€å‡º<code>vc</code>ä¹‹å<code>dealloc</code>ç…§å¸¸æ‰§è¡Œï¼Œæ—¥å¿—åªæœ‰<code>-[ViewController dealloc]</code>ï¼Œè€Œä¸”æ•°å­—æ²¡æœ‰ç»§ç»­è¾“å‡ºï¼Œè¯´æ˜åˆ é™¤è§‚å¯Ÿè€…å’Œå–æ¶ˆ<code>source</code>éƒ½æˆåŠŸäº†ã€‚</p>
<p>é‚£ä¹ˆ<code>NSRunLoopCommonModes</code>æ˜¯å¦å¤–ä¸€ç§æ¨¡å¼å—ï¼Ÿ</p>
<p>é€šè¿‡æºç æŸ¥çœ‹å¾—çŸ¥ï¼Œåœ¨<code>runloop.c line:1632  line:2608</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if (CFStringGetTypeID() == CFGetTypeID(curr-&gt;_mode)) &#123;</span><br><span class="line">    doit = CFEqual(curr-&gt;_mode, curMode) || (CFEqual(curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    doit = CFSetContainsValue((CFSetRef)curr-&gt;_mode, curMode) || (CFSetContainsValue((CFSetRef)curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>è¿˜æœ‰å¾ˆå¤šåœ°æ–¹å‡å¯ä»¥çœ‹å‡ºï¼Œå½“æ˜¯<code>currentMode</code>éœ€è¦å’Œ<code>_mode</code>ç›¸ç­‰æ‰å»æ‰§è¡Œï¼Œå½“æ˜¯<code>kCFRunLoopCommonModes</code>çš„æ—¶å€™ï¼Œåªéœ€è¦åŒ…å«<code>curMode</code>å³å¯æ‰§è¡Œã€‚å¯è§<code>kCFRunLoopCommonModes</code>å…¶å®æ˜¯ä¸€ä¸ªé›†åˆï¼Œä¸æ˜¯æŸä¸ªç‰¹å®šçš„<code>mode</code>ã€‚</p>
<h5 id="çº¿ç¨‹ä¿æ´»"><a href="#çº¿ç¨‹ä¿æ´»" class="headerlink" title="çº¿ç¨‹ä¿æ´»"></a>çº¿ç¨‹ä¿æ´»</h5><p>çº¿ç¨‹ä¸ºä»€ä¹ˆéœ€è¦ä¿æ´»ï¼Ÿæ€§èƒ½å…¶å®å¾ˆå¤§çš„ç“¶é¢ˆæ˜¯åœ¨äºç©ºé—´çš„ç”³è¯·å’Œé‡Šæ”¾ï¼Œå½“æˆ‘ä»¬æ‰§è¡Œä¸€ä¸ªä»»åŠ¡çš„æ—¶å€™åˆ›å»ºäº†ä¸€ä¸ªçº¿ç¨‹ï¼Œä»»åŠ¡ç»“æŸå°±é‡Šæ”¾æ‰è¯¥çº¿ç¨‹ï¼Œå¦‚æœä»»åŠ¡é¢‘ç‡æ¯”è¾ƒé«˜ï¼Œé‚£ä¹ˆä¸€ä¸ªä¸€ç›´æ´»è·ƒçš„çº¿ç¨‹æ¥æ‰§è¡Œæˆ‘ä»¬çš„ä»»åŠ¡å°±çœå»ç”³è¯·å’Œé‡Šæ”¾ç©ºé—´çš„æ—¶é—´å’Œæ€§èƒ½ã€‚ä¸Šè¾¹å·²ç»è®²è¿‡äº†<br><code>runloop</code>éœ€è¦æœ‰ä»»åŠ¡æ‰èƒ½ä¸é€€å‡ºï¼Œæ€»ä¸å¯èƒ½ç›´æ¥è®©ä»–æ‰§è¡Œ<code>while(1)</code>å§ï¼Œè¿™ç§æ–¹æ³•æ˜æ˜¾ä¸å¯¹çš„ï¼Œç”±æºç å¾—çŸ¥ï¼Œå½“æœ‰ç›‘æµ‹ç«¯å£çš„æ—¶å€™ï¼Œä¹Ÿä¸ä¼šé€€å‡ºï¼Œä¹Ÿä¸ä¼šå½±å“åº”èƒ½ã€‚æ‰€ä»¥åœ¨çº¿ç¨‹åˆå§‹åŒ–çš„æ—¶å€™ä½¿ç”¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[[NSRunLoop currentRunLoop] addPort:[NSPort port] </span><br><span class="line">                            forMode:NSRunLoopCommonModes];</span><br></pre></td></tr></table></figure>
<p>æ¥ä¿æ´»ã€‚<br>åœ¨ä¸»çº¿ç¨‹ä½¿ç”¨æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œç³»ç»Ÿå·²ç»åœ¨APPå¯åŠ¨çš„æ—¶å€™è¿›è¡Œäº†è°ƒç”¨ï¼Œåˆ™å·²ç»åŠ å…¥åˆ°å…¨å±€çš„å­—å…¸ä¸­äº†ã€‚</p>
<p>éªŒè¯çº¿ç¨‹ä¿æ´»</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">@property (nonatomic,strong) FYThread *thread;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">	[super viewDidLoad];</span><br><span class="line">	self.thread=[[FYThread alloc]initWithTarget:self selector:@selector(test) object:nil];</span><br><span class="line">	_thread.name = @&quot;test thread&quot;;</span><br><span class="line">	[_thread start];</span><br><span class="line">&#125;</span><br><span class="line">- (void)test &#123;</span><br><span class="line">//æ·»åŠ ç«¯å£</span><br><span class="line">	[[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSDefaultRunLoopMode];</span><br><span class="line">	</span><br><span class="line">	NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">	NSLog(@&quot;--start--&quot;);</span><br><span class="line">	[[NSRunLoop currentRunLoop] run];</span><br><span class="line">	NSLog(@&quot;--end--&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	[self performSelector:@selector(alive) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">	NSLog(@&quot;æ‰§è¡Œå®Œæ¯•äº†å­çº¿ç¨‹&quot;);//ä¸æ‰§è¡Œ å› ä¸ºå­çº¿ç¨‹ä¿æ´»äº† ä¸ä¼šæ‰§è¡Œå®Œæ¯•</span><br><span class="line">&#125;</span><br><span class="line">//æµ‹è¯•å­çº¿ç¨‹æ˜¯å¦è¿˜æ´»ç€</span><br><span class="line">- (void)alive&#123;</span><br><span class="line">	NSLog(@&quot;æˆ‘è¿˜æ´»ç€å‘¢-&gt;%@&quot;,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">//log</span><br><span class="line">//æ³¨é‡Šæ‰æ·»åŠ ç«¯å£ä»£ç </span><br><span class="line">&lt;FYThread: 0x6000013a9540&gt;&#123;number = 3, name = test thread&#125;</span><br><span class="line">--start--</span><br><span class="line">--end--</span><br><span class="line">-[ViewController touchesBegan:withEvent:]</span><br><span class="line">æ‰§è¡Œå®Œæ¯•äº†å­çº¿ç¨‹</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//æ³¨é‡Šæ”¾å¼€çš„æ—¶å€™ç‚¹å‡»è§¦å‘log</span><br><span class="line">&lt;FYThread: 0x6000013a9540&gt;&#123;number = 3, name = test thread&#125;</span><br><span class="line">--start--</span><br><span class="line"></span><br><span class="line">-[ViewController touchesBegan:withEvent:]</span><br><span class="line">æ‰§è¡Œå®Œæ¯•äº†å­çº¿ç¨‹</span><br><span class="line">æˆ‘è¿˜æ´»ç€å‘¢-&gt;&lt;FYThread: 0x6000017e5c80&gt;&#123;number = 3, name = test thread&#125;</span><br></pre></td></tr></table></figure>
<p><code>[[NSRunLoop currentRunLoop] addPort:[NSPort port]forMode:NSDefaultRunLoopMode]</code>æ·»åŠ ç«¯å£æ³¨é‡Šæ‰ï¼Œç›´æ¥æ‰§è¡Œäº†<code>--end--</code>ï¼Œçº¿ç¨‹è™½ç„¶<code>strong</code>å¼ºå¼•ç”¨ï¼Œä½†æ˜¯<code>runloop</code>å·²ç»é€€å‡ºäº†ï¼Œæ‰€ä»¥å‡½æ•°<code>alive</code>æ²¡æœ‰æ‰§è¡Œï¼Œä¸æ³¨é‡Šçš„è¯ï¼Œ<code>alive</code>è¿˜ä¼šæ‰§è¡Œï¼Œ<code>end</code>ä¸€ç›´ä¸ä¼šæ‰§è¡Œï¼Œå› ä¸ºè¿›å…¥äº†<code>runloop</code>ï¼Œè€Œä¸”æ²¡æœ‰é€€å‡ºï¼Œä»£ç å°±ä¸ä¼šå‘ä¸‹æ‰§è¡Œã€‚</p>
<p>é‚£æˆ‘ä»¬æµ‹è¯•ä¸‹è¯¥çº¿ç¨‹å£°æ˜å‘¨æœŸå¤šé•¿ï¼Ÿ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">	[super viewDidLoad];</span><br><span class="line">	self.thread=[[FYThread alloc]initWithTarget:self selector:@selector(test) object:nil];</span><br><span class="line">	_thread.name = @&quot;test thread&quot;;</span><br><span class="line">	[_thread start];</span><br><span class="line">&#125;</span><br><span class="line">- (void)test &#123;</span><br><span class="line">	[[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSDefaultRunLoopMode];</span><br><span class="line">	//è·å–obs</span><br><span class="line">	NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">	NSLog(@&quot;--start--&quot;);</span><br><span class="line">	/*</span><br><span class="line">	 If no input sources or timers are attached to the run loop, this method exits immediately; otherwise, it runs the receiver in the NSDefaultRunLoopMode by repeatedly invoking runMode:beforeDate:. In other words, this method effectively begins an infinite loop that processes data from the run loopâ€™s input sources and timers.</span><br><span class="line">	 */</span><br><span class="line">	[[NSRunLoop currentRunLoop] run];</span><br><span class="line">	NSLog(@&quot;--end--&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	[self performSelector:@selector(alive) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">	NSLog(@&quot;æ‰§è¡Œå®Œæ¯•äº†å­çº¿ç¨‹&quot;);//ä¸æ‰§è¡Œ å› ä¸ºå­çº¿ç¨‹ä¿æ´»äº† ä¸ä¼šæ‰§è¡Œå®Œæ¯•</span><br><span class="line">&#125;</span><br><span class="line">//è¿”å›ä¸Šé¡µ</span><br><span class="line">- (IBAction)popVC:(id)sender &#123;</span><br><span class="line">	[self performSelector:@selector(stop) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">&#125;</span><br><span class="line">//æµ‹è¯•å­çº¿ç¨‹æ˜¯å¦è¿˜æ´»ç€</span><br><span class="line">- (void)alive&#123;</span><br><span class="line">	NSLog(@&quot;æˆ‘è¿˜æ´»ç€å‘¢-&gt;%@&quot;,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">//åœæ­¢å­çº¿ç¨‹çº¿ç¨‹</span><br><span class="line">- (void)stop&#123;</span><br><span class="line">	CFRunLoopStop(CFRunLoopGetCurrent());</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">&lt;FYThread: 0x600003394780&gt;&#123;number = 3, name = test thread&#125;</span><br><span class="line">--start--</span><br><span class="line">-[ViewController stop]</span><br><span class="line">-[ViewController stop]</span><br></pre></td></tr></table></figure>
<p>æ‹¥æœ‰è¯¥çº¿ç¨‹çš„æ˜¯<code>VC</code>ï¼Œç‚¹å‡»<code>pop</code>çš„æ—¶å€™ï¼Œä½†æ˜¯<code>VC</code>å’Œ<code>thread</code>æ²¡é‡Šæ”¾æ‰,å¥½åƒ<code>thread</code>å’Œ<code>VC</code>å»ºç«‹çš„å¾ªç¯å¼•ç”¨ï¼Œå½“<code>self.thread=[[FYThread alloc]initWithTarget:self selector:@selector(test) object:nil];</code>æ³¨é‡Šäº†ï¼Œåˆ™<code>VC</code>å¯ä»¥è¿›è¡Œæ­£å¸¸é‡Šæ”¾ã€‚</p>
<p>é€šè¿‡æµ‹è¯•äº†è§£åˆ°<br>è¿™ä¸ªçº¿ç¨‹è¾¾åˆ°äº†<strong>æ°¸ç”Ÿ</strong>ï¼Œå°±æ˜¯ä½ æ€ä¸æ­»ä»–ï¼Œç®€ç›´äº†<strong>æ­»å¾…</strong>ã€‚æŸ¥æ‰¾äº†ä¸å°‘èµ„æ–™æ‰å‘ç°å®˜æ–¹æ–‡æ¡£æ‰æ˜¯æœ€ç¨³çš„ã€‚æœ‰å¯¹è¿™å¥<code>[[NSRunLoop currentRunLoop] run]</code>çš„è§£é‡Š</p>
<blockquote>
<p>If no input sources or timers are attached to the run loop, this method exits immediately; otherwise, it runs the receiver in the NSDefaultRunLoopMode by repeatedly invoking runMode:beforeDate:. In other words, this method effectively begins an infinite loop that processes data from the run loopâ€™s input sources and timers.</p>
</blockquote>
<p>å°±æ˜¯ç³»ç»Ÿå†™äº†ä»¥ä¸€ä¸ªæ­»å¾ªç¯ä½†æ˜¯æ²¡æœ‰é˜»æ­¢ä»–çš„å‚æ•°ï¼Œç›¸å½“äºä¸€ç›´åœ¨å¾ªç¯è°ƒç”¨<br><code>runMode:beforeDate:</code>ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ<br>å®˜æ–¹æ–‡æ¡£ç»™å‡ºäº†è§£å†³æ–¹æ¡ˆ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">BOOL shouldKeepRunning = YES; // global</span><br><span class="line">NSRunLoop *theRL = [NSRunLoop currentRunLoop];</span><br><span class="line">while (shouldKeepRunning &amp;&amp; [theRL runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]]);</span><br></pre></td></tr></table></figure>
<p>å°†ä»£ç æ”¹æˆä¸‹é¢çš„æˆåŠŸå°†<strong>æ­»å¾…</strong>æ€æ­»äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">- (void)test &#123;</span><br><span class="line">	[[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSDefaultRunLoopMode];</span><br><span class="line">	//è·å–obs</span><br><span class="line">	NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">	NSLog(@&quot;--start--&quot;);</span><br><span class="line">	self.shouldKeepRunning = YES;//é»˜è®¤è¿è¡Œ</span><br><span class="line">	NSRunLoop *theRL = [NSRunLoop currentRunLoop];</span><br><span class="line">	while (_shouldKeepRunning &amp;&amp; [theRL runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]]);</span><br><span class="line">	NSLog(@&quot;--end--&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)touchesBegan:(NSSet&lt;UITouch *&gt; *)touches withEvent:(UIEvent *)event&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	[self performSelector:@selector(alive) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">	NSLog(@&quot;æ‰§è¡Œå®Œæ¯•äº†å­çº¿ç¨‹&quot;);//ä¸æ‰§è¡Œ å› ä¸ºå­çº¿ç¨‹ä¿æ´»äº† ä¸ä¼šæ‰§è¡Œå®Œæ¯•</span><br><span class="line">&#125;</span><br><span class="line">//è¿”å›ä¸Šé¡µ</span><br><span class="line">- (IBAction)popVC:(id)sender &#123;</span><br><span class="line">	self.shouldKeepRunning = NO;</span><br><span class="line">	[self performSelector:@selector(stop) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">&#125;</span><br><span class="line">//æµ‹è¯•å­çº¿ç¨‹æ˜¯å¦è¿˜æ´»ç€</span><br><span class="line">- (void)alive&#123;</span><br><span class="line">	NSLog(@&quot;æˆ‘è¿˜æ´»ç€å‘¢-&gt;%@&quot;,[NSThread currentThread]);</span><br><span class="line">&#125;</span><br><span class="line">//åœæ­¢å­çº¿ç¨‹çº¿ç¨‹</span><br><span class="line">- (void)stop&#123;</span><br><span class="line">	CFRunLoopStop(CFRunLoopGetCurrent());</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	[self performSelectorOnMainThread:@selector(pop) withObject:nil waitUntilDone:NO];</span><br><span class="line">&#125;</span><br><span class="line">- (void)pop&#123;</span><br><span class="line">	[self.navigationController popViewControllerAnimated:YES];</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line"></span><br><span class="line">&lt;FYThread: 0x600002699fc0&gt;&#123;number = 3, name = test thread&#125;</span><br><span class="line">--start--</span><br><span class="line">-[ViewController stop]</span><br><span class="line">--end--</span><br><span class="line">-[ViewController dealloc]</span><br><span class="line">-[FYThread dealloc]</span><br></pre></td></tr></table></figure>
<p>ç‚¹å‡»<code>popVC:</code>é¦–å…ˆå°†<code>self.shouldKeepRunning = NO</code>ï¼Œç„¶å<strong>å­çº¿ç¨‹</strong>æ‰§è¡Œ<code>CFRunLoopStop(CFRunLoopGetCurrent())</code>ï¼Œç„¶ååœ¨<strong>ä¸»çº¿ç¨‹</strong>æ‰§è¡Œ<code>pop</code>å‡½æ•°ï¼Œæœ€ç»ˆè¿”å›ä¸Šçº§é¡µé¢è€Œä¸”æˆåŠŸæ€æ­»<code>VC</code>å’Œ<strong>æ­»å¾…</strong>ã€‚<br>å½“ç„¶è¿™ä¸ª<strong>æ­»å¾…</strong>å…¶å®ä¹Ÿæ˜¯æœ‰ç”¨å¤„çš„ï¼Œå½“ä½¿ç”¨å•ä¾‹æ¨¡å¼ä½œä¸ºä¸‹è½½å™¨çš„æ—¶å€™ä½¿ç”¨<strong>æ­»å¾…</strong>ä¹Ÿæ²¡é—®é¢˜ã€‚è¿™æ ·å­å¤„ç†æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘ä»¬å¯ä»¥æ”¾åœ¨<code>VC</code>çš„<code>dealloc</code>çœ‹çœ‹æ˜¯å¦èƒ½æˆåŠŸã€‚<br>å…³é”®å‡½æ•°ç¨å¾®æ›´æ”¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//åœæ­¢å­çº¿ç¨‹çº¿ç¨‹</span><br><span class="line">- (void)stop&#123;</span><br><span class="line">    if (self.thread == nil) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">        [self performSelector:@selector(stopThread) onThread:self.thread withObject:nil waitUntilDone:NO];</span><br><span class="line">&#125;</span><br><span class="line">- (void)stopThread&#123;</span><br><span class="line">    self.shouldKeepRunning = NO;</span><br><span class="line">    CFRunLoopStop(CFRunLoopGetCurrent());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)dealloc&#123;</span><br><span class="line">    [self stop];</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç‚¹å‡»è¿”å›æŒ‰é’®<code>VC</code>å’Œçº¿ç¨‹éƒ½æ²¡æ­»ï¼ŒåŸæ¥ä»–ä»¬å½¢æˆäº†å¼ºå¼•ç”¨æ— æ³•é‡Šæ”¾,å°±æ˜¯<code>VC</code>å§‹ç»ˆæ— æ³•æ‰§è¡Œ<code>dealloc</code>ã€‚å°†å‡½æ•°æ”¹æˆ<code>block</code>å®ç°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">__weak typeof(self) __weakSelf = self;</span><br><span class="line">self.thread = [[FYThread alloc]initWithBlock:^&#123;</span><br><span class="line">    [[NSRunLoop currentRunLoop] addPort:[NSPort port] forMode:NSDefaultRunLoopMode];</span><br><span class="line">    NSLog(@&quot;%@&quot;,[NSThread currentThread]);</span><br><span class="line">    NSLog(@&quot;--start--&quot;);</span><br><span class="line">    __weakSelf.shouldKeepRunning = YES;//é»˜è®¤è¿è¡Œ</span><br><span class="line">    NSRunLoop *theRL = [NSRunLoop currentRunLoop];</span><br><span class="line">    while (__weakSelf &amp;&amp; __weakSelf.shouldKeepRunning  )&#123;</span><br><span class="line">        [theRL runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];</span><br><span class="line">    &#125;;</span><br><span class="line">    NSLog(@&quot;--end--&quot;);</span><br><span class="line">&#125;];</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•ä¸‹å´©æºƒäº†ï¼Œå´©æºƒåˆ°äº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">while (__weakSelf.shouldKeepRunning  )&#123;</span><br><span class="line">        [theRL runMode:NSDefaultRunLoopMode beforeDate:[NSDate distantFuture]];//å´©æºƒçš„åœ°æ–¹</span><br><span class="line">    &#125;;</span><br></pre></td></tr></table></figure>
<p>æ€ä¹ˆæƒ³æ„Ÿè§‰ä¸å¯¹åŠ²å•Šï¼Œæ€ä¹ˆä¼šä¸è¡Œå‘¢ï¼Ÿ<code>VC</code>é”€æ¯çš„æ—¶å€™è°ƒç”¨å­çº¿ç¨‹<code>stop</code>,æœ€åæ‰“æ–­ç‚¹å‘ç°åˆ°äº†å´©æºƒçš„åœ°æ–¹<code>self</code>å·²ç»ä¸å­˜åœ¨äº†ï¼Œè¯´æ˜æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œå¾€å‰æŸ¥æ‰¾ä½¿ç”¨å¼‚æ­¥çš„å‡½æ•°æœ€åå‡ºç°åœ¨äº†<code>[self performSelector:@selector(stopThread) onThread:self.thread withObject:nil waitUntilDone:NO];</code>ï¼Œè¡¨ç¤ºä¸ç”¨ç­‰å¾…<code>stopThread</code>å‡½æ•°æ‰§è¡Œæ—¶é—´ï¼Œç›´æ¥å‘å‰ç»§ç»­æ‰§è¡Œï¼Œæ‰€ä»¥<code>VC</code>é‡Šæ”¾æ‰äº†ï¼Œ<code>while (__weakSelf.shouldKeepRunning )</code>æ˜¯<code>true</code>ï¼Œè¿˜çœŸè¿›å»äº†ï¼Œè®¿é—®äº†<code>exe_bad_access</code>ï¼Œæ‰€ä»¥æ”¹æˆ<code>while (__weakSelf&amp;&amp;__weakSelf.shouldKeepRunning )</code>å†è·‘ä¸€ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//log</span><br><span class="line"></span><br><span class="line">--start--</span><br><span class="line">-[ViewController stop]</span><br><span class="line">-[ViewController dealloc]</span><br><span class="line">--end--</span><br><span class="line">-[FYThread dealloc]</span><br></pre></td></tr></table></figure>
<p>å¦‚ç‰›å¥¶èˆ¬ä¸æ»‘ï¼Œè§£å†³äº†é‡Šæ”¾é—®é¢˜ï¼Œä¹Ÿè§£å†³äº†å¤æ‚æ“ä½œã€‚æœ¬æ–‡ç« æ‰€æœ‰ä»£ç å‡åœ¨åº•éƒ¨é“¾æ¥å¯ä»¥ä¸‹è½½ã€‚<br>ä½¿ç”¨è¿™ä¸ªæ€è·¯è‡ªå·±å°è£…äº†ä¸€ä¸ªç®€å•çš„åŠŸèƒ½ï¼Œå¤§å®¶å¯ä»¥è‡ªå·±å°è£…ä¸€ä¸‹ç„¶åå¯¹æ¯”ä¸€ä¸‹æˆ‘çš„æ€è·¯ï¼Œè¯´ä¸å®šæœ‰æƒŠå–œï¼</p>
<h3 id="èµ„æ–™å‚è€ƒ"><a href="#èµ„æ–™å‚è€ƒ" class="headerlink" title="èµ„æ–™å‚è€ƒ"></a>èµ„æ–™å‚è€ƒ</h3><ul>
<li><a href="https://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener">runloopæºç </a></li>
<li><a href="http://www.520it.com/zt/ios_mj/" target="_blank" rel="noopener">å°ç å“¥è§†é¢‘</a></li>
<li><a href="http://awayqu.1024ul.com/ios/2018/05/02/gcd-3.html" target="_blank" rel="noopener">ä»»åŠ¡è°ƒåº¦</a></li>
<li><a href="https://opensource.apple.com/tarballs/libdispatch/" target="_blank" rel="noopener">libdispatch</a><h3 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h3></li>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="noopener">å­¦ä¹ èµ„æ–™ä¸‹è½½git</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="noopener">demo code git</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC/objc4-750" target="_blank" rel="noopener">runtimeå¯è¿è¡Œçš„æºç git</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC/OC%E6%9C%AC%E8%B4%A8/day14-CFRunloop%E7%BA%BF%E7%A8%8B%E4%BF%9D%E6%B4%BB%E5%B0%81%E8%A3%85%E7%9A%84c%E8%AF%AD%E8%A8%80" target="_blank" rel="noopener">threadä¿æ´»cè¯­è¨€ç‰ˆæœ¬</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC/OC%E6%9C%AC%E8%B4%A8/day14-CFRunloop%E7%BA%BF%E7%A8%8B%E4%BF%9D%E6%B4%BB%E5%B0%81%E8%A3%85" target="_blank" rel="noopener">thread ä¿æ´»</a></li>
</ul>
<hr>
<p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p>
<p>å¹¿å‘Šæ—¶é—´</p>
<p><img src="/images/0.png" alt></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOSåº•å±‚åŸç† runtime - superã€hookã€ä»¥åŠç®€å•åº”ç”¨--(8)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyongçš„æŠ€æœ¯åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/01/iOSåº•å±‚åŸç† runtime - superã€hookã€ä»¥åŠç®€å•åº”ç”¨--(8)/" class="post-title-link" itemprop="http://fgyong.cn/index.html">iOSåº•å±‚åŸç† runtime - superã€hookã€ä»¥åŠç®€å•åº”ç”¨--(8)</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-01 11:18:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:18:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-09-03 16:24:13" itemprop="dateModified" datetime="2020-09-03T16:24:13+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="å…³é”®å­—-super"><a href="#å…³é”®å­—-super" class="headerlink" title="å…³é”®å­— super"></a>å…³é”®å­— super</h3><p>å…³é”®å­—<code>super</code>,åœ¨è°ƒç”¨<code>[super init]</code>çš„æ—¶å€™ï¼Œ<code>super</code>ä¼šè½¬åŒ–æˆç»“æ„ä½“<code>__rw_objc_super</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">struct __rw_objc_super &#123; </span><br><span class="line">	struct objc_object *object; //æ¶ˆæ¯æ¥å—è€…</span><br><span class="line">	struct objc_object *superClass; //çˆ¶ç±»</span><br><span class="line">	__rw_objc_super(struct objc_object *o, struct objc_object *s) : object(o), superClass(s) &#123;&#125; </span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>[super init]</code>ä½¿ç”¨å‘½ä»¤<code>xcrun -sdk iphoneos clang -arch arm64 -rewrite-objc -fobjc-arc -fobjc-runtime=ios-8.0.0 Student.m</code>è½¬åŒ–æˆ<code>cpp</code><br>æ‰“å¼€<code>cpp</code>å¤§æ¦‚åœ¨åº•éƒ¨çš„ä½ç½®æ‰¾åˆ°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(Student *(*)(__rw_objc_super *, SEL))(void *)objc_msgSendSuper)((__rw_objc_super)&#123;(id)self, (id)class_getSuperclass(objc_getClass(&quot;Student&quot;))&#125;, sel_registerName(&quot;init&quot;))</span><br></pre></td></tr></table></figure>
<p>ç®€åŒ–ä¹‹åæ˜¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(void *)objc_msgSendSuper((__rw_objc_super)&#123;self, class_getSuperclass(objc_getClass(&quot;Student&quot;))&#125;, sel_registerName(&quot;init&quot;))</span><br></pre></td></tr></table></figure>
<p><code>void
objc_msgSendSuper(void /* struct objc_super *super, SEL op, ... */ )</code><br>    å…¶å®æ˜¯å‘çˆ¶ç±»å‘é€æ¶ˆæ¯ï¼Œå‚æ•°æ˜¯<code>struct objc_super *super, SEL op, ...</code>ï¼Œæˆ‘ä»¬æºç ä¸­æ‰¾åˆ°äº†è¯¥å‡½æ•°çš„å®ç°åœ¨<code>objc-msg-arm64.s</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ENTRY _objc_msgSendSuper</span><br><span class="line">UNWIND _objc_msgSendSuper, NoFrame</span><br><span class="line">//æ ¹æ®ç»“æ„ä½“struct __rw_objc_super </span><br><span class="line">&#123; </span><br><span class="line">	//struct objc_object *object; //æ¶ˆæ¯æ¥å—è€…</span><br><span class="line">	//struct objc_object *superClass; //çˆ¶ç±»</span><br><span class="line">&#125;å ç”¨ç©ºé—´16å­—èŠ‚ï¼Œobjc_msgSendSuperå‚æ•°æ˜¯__rw_objc_superï¼Œ</span><br><span class="line">//ä½¿x0åç§»16å­—èŠ‚ï¼Œå°±æ˜¯ä¸¤ä¸ªæŒ‡é’ˆçš„ç©ºé—´ï¼Œèµ‹å€¼ç»™p0 å’Œp16</span><br><span class="line">ldp	p0, p16, [x0]		// p0 = self , p16 = superclass</span><br><span class="line"></span><br><span class="line">CacheLookup NORMAL		// calls imp or objc_msgSend_uncached</span><br><span class="line"></span><br><span class="line">END_ENTRY _objc_msgSendSuper</span><br></pre></td></tr></table></figure>
<p>å°†<code>self</code>å’Œ<code>superclass</code>èµ‹å€¼ç»™ <code>p0, p16</code>è°ƒç”¨<code>CacheLookup NORMAL</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">.macro CacheLookup //.macro æ˜¯ä¸€ä¸ªå® ä½¿ç”¨ _cmd&amp;mask æŸ¥æ‰¾ç¼“å­˜ä¸­çš„æ–¹æ³•</span><br><span class="line">	// p1 = SEL, p16 = isa</span><br><span class="line">	ldp	p10, p11, [x16, #CACHE]	// p10 = buckets, p11 = occupied|mask</span><br><span class="line">#if !__LP64__</span><br><span class="line">	and	w11, w11, 0xffff	// p11 = mask</span><br><span class="line">#endif</span><br><span class="line">	and	w12, w1, w11		// x12 = _cmd &amp; mask</span><br><span class="line">	add	p12, p10, p12, LSL #(1+PTRSHIFT)</span><br><span class="line">		             // p12 = buckets + ((_cmd &amp; mask) &lt;&lt; (1+PTRSHIFT))</span><br><span class="line"></span><br><span class="line">	ldp	p17, p9, [x12]		// &#123;imp, sel&#125; = *bucket</span><br><span class="line">1:	cmp	p9, p1			// if (bucket-&gt;sel != _cmd)</span><br><span class="line">	b.ne	2f			//     scan more</span><br><span class="line">	CacheHit $0			// call or return imp å‘½ä¸­ è°ƒç”¨æˆ–è€…è¿”å›imp</span><br><span class="line">	</span><br><span class="line">2:	// not hit: p12 = not-hit bucket æ²¡æœ‰å‘½ä¸­</span><br><span class="line">	CheckMiss $0			// miss if bucket-&gt;sel == 0</span><br><span class="line">	cmp	p12, p10		// wrap if bucket == buckets</span><br><span class="line">	b.eq	3f</span><br><span class="line">	ldp	p17, p9, [x12, #-BUCKET_SIZE]!	// &#123;imp, sel&#125; = *--bucket</span><br><span class="line">	b	1b			// loop</span><br><span class="line"></span><br><span class="line">3:	// wrap: p12 = first bucket, w11 = mask</span><br><span class="line">	add	p12, p12, w11, UXTW #(1+PTRSHIFT)</span><br><span class="line">		                        // p12 = buckets + (mask &lt;&lt; 1+PTRSHIFT)</span><br><span class="line"></span><br><span class="line">	// Clone scanning loop to miss instead of hang when cache is corrupt.</span><br><span class="line">	// The slow path may detect any corruption and halt later.</span><br><span class="line"></span><br><span class="line">	ldp	p17, p9, [x12]		// &#123;imp, sel&#125; = *bucket</span><br><span class="line">1:	cmp	p9, p1			// if (bucket-&gt;sel != _cmd)</span><br><span class="line">	b.ne	2f			//     scan more</span><br><span class="line">	CacheHit $0			// call or return imp</span><br><span class="line">	</span><br><span class="line">2:	// not hit: p12 = not-hit bucket</span><br><span class="line">	CheckMiss $0			// miss if bucket-&gt;sel == 0</span><br><span class="line">	cmp	p12, p10		// wrap if bucket == buckets</span><br><span class="line">	b.eq	3f</span><br><span class="line">	ldp	p17, p9, [x12, #-BUCKET_SIZE]!	// &#123;imp, sel&#125; = *--bucket</span><br><span class="line">	b	1b			// loop</span><br><span class="line"></span><br><span class="line">3:	// double wrap</span><br><span class="line">	JumpMiss $0</span><br><span class="line">	</span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure>
<p>æ±‡ç¼–æ¯”è¾ƒå¤šï¼Œåªçœ‹åˆ°ç¬¬äºŒè¡Œ<code>p1 = SEL, p16 = isa</code>ï¼ŒæŸ¥æ‰¾ç¼“å­˜æ˜¯ä»<code>p16</code>,ä¹Ÿå°±æ˜¯<code>superclass</code>å¼€å§‹æŸ¥æ‰¾ï¼Œåè¾¹çš„éƒ½å’Œ<code>objc_msgSend</code>ä¸€æ ·ã€‚<br>å¤§è‡´ä¸Šæ¯”è¾ƒæ¸…æ¥šäº†ï¼Œ<code>super</code>æœ¬è´¨ä¸Šè°ƒç”¨äº†<code>objc_msgSendSuper</code>ï¼Œ<code>objc_msgSendSuper</code>æ˜¯æŸ¥æ‰¾ä»çˆ¶ç±»å¼€å§‹æŸ¥æ‰¾æ–¹æ³•ã€‚</p>
<p><code>[super init]</code>å°±æ˜¯<code>self</code>ç›´æ¥è°ƒç”¨çˆ¶ç±»<code>init</code>çš„æ–¹æ³•ï¼Œä½†æ˜¯<code>objc_msgSend</code>æ¥å—è€…æ˜¯<code>self</code>ï¼Œå‡å¦‚æ˜¯<code>[self init]</code>åˆ™ä¼šäº§ç”Ÿæ­»å¾ªç¯ã€‚<code>[super test]</code>åˆ™æ˜¯æ‰§è¡Œçˆ¶ç±»çš„<code>test</code>ã€‚<br>ä½¿ç”¨<code>Debug Workflow-&gt;Always Show Disassemdly</code>å‘ç°<code>super</code>å…¶å®è°ƒç”¨äº†æ±‡ç¼–çš„<code>objc_msgSendSuper2</code>ï¼Œè¿›å…¥<code>objc_msgSendSuper2 objc-msg-arm64.s 422 è¡Œ</code>å‘ç°å’Œ<code>objc_msgSendSuper</code>å…¶å®åŸºæœ¬ä¸€è‡´çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">//_objc_msgSendSuper å¼€å§‹</span><br><span class="line">	ENTRY _objc_msgSendSuper</span><br><span class="line">	UNWIND _objc_msgSendSuper, NoFrame</span><br><span class="line">//x0åç§»16å­—èŠ‚ï¼Œå°±æ˜¯ä¸¤ä¸ªæŒ‡é’ˆçš„ç©ºé—´ï¼Œèµ‹å€¼ç»™p0 å’Œp16</span><br><span class="line">	ldp	p0, p16, [x0]		// p0 = self , p16 = superclass</span><br><span class="line">	CacheLookup NORMAL		// calls imp or objc_msgSend_uncached</span><br><span class="line">	END_ENTRY _objc_msgSendSuper  //_objc_msgSendSuper ç»“æŸ</span><br><span class="line">	</span><br><span class="line">//objc_msgLookupSuper2 å¼€å§‹</span><br><span class="line">	ENTRY _objc_msgSendSuper2 </span><br><span class="line">	UNWIND _objc_msgSendSuper2, NoFrame</span><br><span class="line"></span><br><span class="line">	ldp	p0, p16, [x0]		// p0 = real receiver, p16 = class</span><br><span class="line">	//å°†å­˜å‚¨å™¨åœ°å€ä¸ºx16+8çš„å­—æ•°æ®è¯»å…¥å¯„å­˜å™¨p16ã€‚</span><br><span class="line">	ldr	p16, [x16, #SUPERCLASS]	// p16 = class-&gt;superclass</span><br><span class="line">	CacheLookup NORMAL</span><br><span class="line">	END_ENTRY _objc_msgSendSuper2</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥ä½¿ç”¨<code>LLVM</code>è½¬åŒ–æˆä¸­é—´ä»£ç æ¥æŸ¥çœ‹ï¼Œ<code>clang -emit-llvm -S FYCat.m</code>æŸ¥çœ‹å…³é”®å‡½æ•°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">define internal void @&quot;\01-[FYCat forwardInvocation:]&quot;(%1*, i8*, %2*) #1 &#123;</span><br><span class="line">    call void bitcast (i8* (%struct._objc_super*, i8*, ...)* @objc_msgSendSuper2 to void (%struct._objc_super*, i8*, %2*)*)(%struct._objc_super* %7, i8* %18, %2* %12)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯<code>forwardInvocation</code>å‡½æ•°çš„è°ƒç”¨ä»£ç ï¼Œç®€åŒ–ä¹‹åæ˜¯<code>objc_msgSendSuper2(self,struct._objc_super i8*,%2*)</code>ï¼Œå°±æ˜¯<code>objc_msgSendSuper2(self,superclass,@selector(forwardInvocation),anInvocation)</code>ã€‚</p>
<p>éªŒè¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">- (int)age;</span><br><span class="line">-(void)test;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation FYPerson</span><br><span class="line">- (void)test&#123;</span><br><span class="line">    ;    NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">- (int)age&#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">    return 10;</span><br><span class="line">&#125;</span><br><span class="line">- (NSString *)name&#123;</span><br><span class="line">    return [_name stringByAppendingString:@&quot; eat apple&quot;];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@interface FYStudent : FYPerson</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line">@implementation FYStudent</span><br><span class="line">- (void)test&#123;</span><br><span class="line">    [super test]; //æ‰§è¡Œçˆ¶ç±»çš„test</span><br><span class="line">    int age = [super age]; //è·å–çˆ¶ç±»çš„æ–¹æ³• è¿”å›å€¼</span><br><span class="line">    NSLog(@&quot;age is %d&quot;,age);</span><br><span class="line">    NSString * name = [self name]; //ä»çˆ¶ç±»å¼€å§‹å¯»æ‰¾nameçš„å€¼ï¼Œä½†è¿”å›çš„æ˜¯self.nameçš„å€¼</span><br><span class="line">    NSLog(@&quot;%@&quot;,name);</span><br><span class="line">&#125;</span><br><span class="line">-(int)age&#123;</span><br><span class="line">    return 12;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">//è¾“å‡º</span><br><span class="line">-[FYPerson test]</span><br><span class="line">-[FYPerson age]</span><br><span class="line">age is 10</span><br><span class="line">å°æå­ eat apple</span><br></pre></td></tr></table></figure>
<p><code>test</code>æ˜¯æ‰§è¡Œçˆ¶ç±»çš„æ–¹æ³•ï¼Œ<code>[super age]</code>è·å–çˆ¶ç±»ä¸­å›ºå®šçš„<code>age</code>,<br><code>[self name]</code>ä»çˆ¶ç±»å¼€å§‹å¯»æ‰¾<code>name</code>çš„å€¼ï¼Œä½†è¿”å›çš„æ˜¯<code>self.name</code>çš„å€¼ã€‚</p>
<h3 id="isMemberOfClass-amp-isKindOfClass"><a href="#isMemberOfClass-amp-isKindOfClass" class="headerlink" title="isMemberOfClass &amp;  isKindOfClass"></a>isMemberOfClass &amp;  isKindOfClass</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">+ (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    return object_getClass((id)self) == cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isMemberOfClass:(Class)cls &#123;</span><br><span class="line">    return [self class] == cls;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls = object_getClass((id)self); tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        printf(&quot;%s %s\n&quot;,class_getName(tcls),class_getName(cls));</span><br><span class="line">        if (tcls == cls)</span><br><span class="line">        &#123;return YES;&#125;else&#123;</span><br><span class="line">            printf(&quot;%s&quot;,class_getName(tcls));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (BOOL)isKindOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls = [self class]; tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        </span><br><span class="line">        printf(&quot; %s %s\n&quot;,class_getName(tcls),class_getName(cls));</span><br><span class="line">        if (tcls == cls) return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (BOOL)isSubclassOfClass:(Class)cls &#123;</span><br><span class="line">    for (Class tcls = self; tcls; tcls = tcls-&gt;superclass) &#123;</span><br><span class="line">        if (tcls == cls) return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return NO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>- (BOOL)isMemberOfClass</code>å’Œ<code>- (BOOL)isKindOfClass:(Class)cls</code>æ¯”è¾ƒç®€å•ï¼Œéƒ½æ˜¯åˆ¤æ–­<code>self.class</code> å’Œ<code>cls</code>ï¼Œ<code>+ (BOOL)isMemberOfClass:(Class)cls</code>æ˜¯åˆ¤æ–­<code>self.class-&gt;isa</code>æ˜¯å¦å’Œ<code>cls</code>ç›¸ç­‰ï¼Œ<code>+ (BOOL)isKindOfClass:(Class)cls</code>åˆ¤æ–­<code>cls-&gt;isa</code>å’Œ<code>cls-&gt;isa-&gt;isa</code>æœ‰æ²¡æœ‰å¯èƒ½å’Œ<code>cls</code>ç›¸ç­‰ï¼Ÿåªæœ‰åŸºç±»æ˜¯ï¼Œå…¶ä»–çš„éƒ½ä¸æ˜¯ã€‚</p>
<h4 id="éªŒè¯-å®ä¾‹æ–¹æ³•"><a href="#éªŒè¯-å®ä¾‹æ–¹æ³•" class="headerlink" title="éªŒè¯ å®ä¾‹æ–¹æ³•"></a>éªŒè¯ å®ä¾‹æ–¹æ³•</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Class cls = NSObject.class;</span><br><span class="line">Class pcls = FYPerson.class;</span><br><span class="line">FYPerson *p=[FYPerson new];</span><br><span class="line">NSObject *obj=[NSObject new];</span><br><span class="line">BOOL res11 =[p isKindOfClass:pcls];</span><br><span class="line">BOOL res12 =[p isMemberOfClass:pcls];</span><br><span class="line">BOOL res13 =[obj isKindOfClass:cls];</span><br><span class="line">BOOL res14 =[obj isMemberOfClass:cls];</span><br><span class="line">NSLog(@&quot;instance:%d %d %d %d&quot;,res11,res12,res13,res14);</span><br><span class="line">//log</span><br><span class="line">//instance:1 1 1 1</span><br></pre></td></tr></table></figure>
<p><code>p</code>æ˜¯<code>pcls</code>çš„å­ç±»ï¼Œ<code>obj</code> æ˜¯<code>cls</code>çš„å­ç±»ï¼Œåœ¨æ˜æ˜¾ä¸è¿‡äº†ã€‚</p>
<h4 id="éªŒè¯-ç±»æ–¹æ³•"><a href="#éªŒè¯-ç±»æ–¹æ³•" class="headerlink" title="éªŒè¯ ç±»æ–¹æ³•"></a>éªŒè¯ ç±»æ–¹æ³•</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//isKindOfClass cls-&gt;isa å’Œcls/cls-&gt;superclassç›¸ç­‰å—?</span><br><span class="line">//å…ƒç±»å¯¹è±¡å’Œç±»å¯¹è±¡ä¸ç›¸ç­‰ï¼Œä½†æ˜¯æœ€åä¸€ä¸ªå…ƒç±»çš„isa-&gt;superclassæ˜¯æŒ‡å‘NSObjectçš„class æ‰€ä»¥res1 = YES;</span><br><span class="line">//cls-&gt;isa:å…ƒç±»å¯¹è±¡ cls-&gt;isa-&gt;superclass: NSObjectç±»å¯¹è±¡</span><br><span class="line">//cls:ç±»å¯¹è±¡</span><br><span class="line">BOOL res1 =[cls isKindOfClass:cls];</span><br><span class="line">//cls-&gt;isa å’Œclsç›¸ç­‰å—ï¼Ÿ ä¸ç›¸ç­‰ cls-&gt;isaæ˜¯å…ƒç±»å¯¹è±¡,clsæ˜¯ç±»å¯¹è±¡ï¼Œä¸å¯èƒ½ç›¸ç­‰ã€‚</span><br><span class="line">BOOL res2 =[cls isMemberOfClass:cls];</span><br><span class="line">//pcls-&gt;isa:personçš„å…ƒç±»å¯¹è±¡ cls-&gt;isa-&gt;superclass: NSObjectå…ƒç±»ç±»å¯¹è±¡ -&gt;superclass:NSObjectç±»å¯¹è±¡ -&gt;superclass:nil</span><br><span class="line">//pcls:personç±»å¯¹è±¡</span><br><span class="line">BOOL res3 =[pcls isKindOfClass:pcls];</span><br><span class="line">//pcls-&gt;isa:personçš„å…ƒç±»å¯¹è±¡</span><br><span class="line">//pcls:personç±»å¯¹è±¡</span><br><span class="line">BOOL res4 =[pcls isMemberOfClass:pcls];</span><br><span class="line">NSLog(@&quot;%d %d %d %d&quot;,res1,res2,res3,res4);</span><br><span class="line">ç»“æœï¼š</span><br><span class="line">1 0 0 0</span><br></pre></td></tr></table></figure>
<h3 id="å †æ ˆ-å¯¹è±¡æœ¬è´¨-classæœ¬è´¨å®æˆ˜"><a href="#å †æ ˆ-å¯¹è±¡æœ¬è´¨-classæœ¬è´¨å®æˆ˜" class="headerlink" title="å †æ ˆ å¯¹è±¡æœ¬è´¨ classæœ¬è´¨å®æˆ˜"></a>å †æ ˆ å¯¹è±¡æœ¬è´¨ classæœ¬è´¨å®æˆ˜</h3><p>ç½‘ä¸Šçœ‹åˆ°äº†ä¸€ä¸ªæ¯”è¾ƒæœ‰æ„æ€çš„é¢è¯•é¢˜ï¼Œä»Šå¤©æˆ‘ä»¬å°±å€Ÿæ­¤æœºä¼šåˆ†æä¸€ä¸‹,è™½ç„¶ç½‘ä¸Šå¾ˆå¤šåšæ–‡å·²ç»è®²äº†ï¼Œä½†æ˜¯å¥½åƒéƒ½ä¸å¾ˆå¯¹ï¼Œæˆ–è€…æ²¡æœ‰è®²åˆ°æ ¹æœ¬çš„ä¸œè¥¿ï¼Œæ‰€ä»¥ä»Šå¤©å†æ¥æ¢è®¨ä¸€ä¸‹ç©¶ç«Ÿã€‚<br>å…¶å®è¿™é“é¢˜è€ƒå¯Ÿäº†å¯¹è±¡åœ¨å†…å­˜ä¸­çš„å¸ƒå±€ï¼Œç±»å’Œå¯¹è±¡çš„å…³ç³»ï¼Œå’Œå †ä¸Šçš„å†…å­˜å¸ƒå±€ã€‚åŸºç¡€çŸ¥è¯†ä¸å¾ˆç‰¢å›ºçš„åŒå­¦å¯ä»¥çœ‹ä¸€ä¸‹æˆ‘å†å²çš„åšæ–‡<a href="https://juejin.im/post/5d2d200be51d4510a7328161" target="_blank" rel="noopener">obj_msgsendåŸºç¡€</a>ã€<a href="https://juejin.im/post/5d19c59e6fb9a07f04205f95" target="_blank" rel="noopener">ç±»çš„æœ¬è´¨</a>ã€<a href="https://juejin.im/post/5d15887ee51d45108126d28d" target="_blank" rel="noopener">å¯¹è±¡çš„æœ¬è´¨</a>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">- (void)print;</span><br><span class="line">@end</span><br><span class="line">@implementation FYPerson</span><br><span class="line">- (void)print&#123;</span><br><span class="line">    NSLog(@&quot;my name is %@&quot;,self.name);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">    NSObject *fix =[NSObject new]; // 16å­—èŠ‚ 0x60000219b030</span><br><span class="line">    id cls  = [FYPerson class];é’ˆ</span><br><span class="line">    void * obj = &amp;cls; </span><br><span class="line">    [(__bridge id)obj print];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="é—®é¢˜ä¸€-èƒ½å¦ç¼–è¯‘æˆåŠŸï¼Ÿ"><a href="#é—®é¢˜ä¸€-èƒ½å¦ç¼–è¯‘æˆåŠŸï¼Ÿ" class="headerlink" title="é—®é¢˜ä¸€ èƒ½å¦ç¼–è¯‘æˆåŠŸï¼Ÿ"></a>é—®é¢˜ä¸€ èƒ½å¦ç¼–è¯‘æˆåŠŸï¼Ÿ</h4><p>å½“å¤§å®¶çœ‹åˆ°ç¬¬äºŒä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œä¸å‚»çš„è¯éƒ½ä¼šå›ç­”èƒ½ç¼–è¯‘æˆåŠŸï¼Œå¦åˆ™è¿˜é—®ç»“æœå¹²å˜›ã€‚æˆ‘ä»¬ä»ä¹‹å‰å­¦çš„åªæ˜¯æ¥åˆ†æä¸€ä¸‹ï¼Œè°ƒç”¨æ–¹æ³•æˆåŠŸéœ€è¦æœ‰<code>id self</code>å’Œ<code>SEL sel</code>ï¼Œç°åœ¨<code>cls</code>å’Œ<code>obj</code>éƒ½åœ¨æ ˆåŒºï¼Œ<code>obj</code> æŒ‡é’ˆæŒ‡å‘<code>cls</code>çš„å†…å­˜åœ°å€ï¼Œè®¿é—®<code>obj</code>ç›¸å½“äºç›´æ¥è®¿é—®<code>cls</code>å†…å­˜å­˜å‚¨çš„å€¼ï¼Œ<code>cls</code>å­˜å‚¨çš„æ˜¯<code>Person.class</code>,<code>[obj print]</code> ç›¸å½“äº<code>objc_msgSend(cls,@selector(print))</code>,<code>cls</code>æ˜¯æœ‰<code>print</code>æ–¹æ³•çš„ï¼Œæ‰€ä»¥ä¼šç¼–è¯‘æˆåŠŸã€‚</p>
<h4 id="è¾“å‡ºä»€ä¹ˆï¼Ÿ"><a href="#è¾“å‡ºä»€ä¹ˆï¼Ÿ" class="headerlink" title="è¾“å‡ºä»€ä¹ˆï¼Ÿ"></a>è¾“å‡ºä»€ä¹ˆï¼Ÿ</h4><p><code>fix/cls/obj</code>è¿™ä¸‰ä¸ªå¯¹è±¡éƒ½æ˜¯å­˜å‚¨åœ¨æ ˆä¸Šï¼Œ<code>fix/cls/obj</code>åœ°å€æ˜¯è¿ç»­ä»é«˜åˆ°ä½çš„ï¼Œè€Œä¸”ä»–ä»¬åœ°å€ç›¸å·®éƒ½æ˜¯<code>8</code>å­—èŠ‚ï¼Œä¸€ä¸ªæŒ‡é’ˆå¤§å°æ˜¯<code>8</code>å­—èŠ‚ã€‚ä»–ä»¬ä¸‰ä¸ªåœ°å€å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<p>ä½¿ç”¨å›¾æ¥è¡¨ç¤º<code>fix</code>å’Œ<code>obj</code>ï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å¯¹è±¡</th>
<th style="text-align:center">åœ°å€</th>
<th style="text-align:center">åœ°å€é«˜ä½</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">fix</td>
<td style="text-align:center">0x7ffeec3df920</td>
<td style="text-align:center">é«˜</td>
</tr>
<tr>
<td style="text-align:center">cls</td>
<td style="text-align:center">0x7ffeec3df918</td>
<td style="text-align:center">ä¸­</td>
</tr>
<tr>
<td style="text-align:center">obj</td>
<td style="text-align:center">0x7ffeec3df910</td>
<td style="text-align:center">ä½</td>
</tr>
</tbody>
</table>
<p>å¯»æ‰¾å±æ€§å…ˆæ˜¯å¯»æ‰¾<code>isa</code>ï¼Œç„¶åå†åœ¨<code>isa</code>åœ°å€ä¸Š+<code>8</code>åˆ™æ˜¯å±æ€§çš„å€¼ï¼Œæ‰€ä»¥æ ¹æ®<code>obj</code>å¯»æ‰¾<code>cls</code>åœ°å€æ˜¯<code>0x7ffeec3df918</code>,ç„¶å<code>cls</code>åœ°å€+8å­—èŠ‚åˆ™æ˜¯<code>_name</code>çš„åœ°å€ï¼Œ<code>cls</code>åœ°å€æ˜¯<code>0x7ffeec3df918</code>ï¼ŒåŠ ä¸Š<code>8</code>å­—èŠ‚æ­£å¥½æ˜¯<code>fix</code>çš„åœ°å€<code>0x7ffeec3df920</code>ï¼Œå› ä¸ºéƒ½æ˜¯æŒ‡é’ˆï¼Œæ‰€ä»¥éƒ½æ˜¯<code>8</code>å­—èŠ‚,æ‰€ä»¥æœ€åè¾“å‡ºæ˜¯ç»“æœæ˜¯<code>fix</code>å¯¹è±¡çš„åœ°å€çš„æ•°æ®ã€‚</p>
<p>æƒ…å†µå†å¤æ‚ä¸€ç‚¹ï¼Œ<code>FYPerson</code>ç»“æ„æ”¹åŠ¨ä¸€ä¸‹<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@property (nonatomic,copy) NSString *name2;</span><br><span class="line">@property (nonatomic,copy) NSString *name3;</span><br><span class="line">- (void)print;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure></p>
<p>åˆ™ä»–ä»¬çš„<code>_name</code>ã€<code>_name2</code>ã€<code>_name3</code>åˆ™åœ¨<code>cls</code>çš„åœ°å€åŸºç¡€ä¸Šå†å‘ä¸Šå¯»æ‰¾<code>8*1=8/8*2=16/8*3=24</code>å­—èŠ‚ï¼Œå°±æ˜¯å‘ä¸Šå¯»æ‰¾ç¬¬1ä¸ªï¼Œç¬¬2ä¸ªï¼Œç¬¬3ä¸ªæŒ‡å‘å¯¹è±¡çš„æŒ‡é’ˆã€‚</p>
<p>æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">@interface FYPerson : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString *name;</span><br><span class="line">@property (nonatomic,copy) NSString *name2;</span><br><span class="line">@property (nonatomic,copy) NSString *name3;</span><br><span class="line">- (void)print;</span><br><span class="line">@end</span><br><span class="line">@implementation FYPerson</span><br><span class="line">- (void)print&#123;</span><br><span class="line">    NSLog(@&quot;name1:%@ name2:%@ name3:%@&quot;,self.name1,self.name2,self.name3);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">//ä¸»å‡½æ•°</span><br><span class="line"></span><br><span class="line">NSObject *fix =[NSObject new];</span><br><span class="line">FYPerson *fix2 =[FYPerson new];</span><br><span class="line"></span><br><span class="line">id cls  = [FYPerson class];</span><br><span class="line">void * obj = &amp;cls; </span><br><span class="line">[(__bridge id)obj print];//objc_msgSend(self,sel);</span><br><span class="line">NSLog(@&quot;fix:%p fix2:%p cls:%p obj:%p&quot;,&amp;fix,&amp;fix2,&amp;cls,&amp;obj);</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line">name1:&lt;FYPerson: 0x6000033a38a0&gt; </span><br><span class="line">name2:&lt;NSObject: 0x6000031f5380&gt; </span><br><span class="line">name3:&lt;ViewController: 0x7f8307505580&gt;</span><br><span class="line"></span><br><span class="line">fix: 0x7ffeec3d f9 28 </span><br><span class="line">fix2:0x7ffeec3d f9 20 </span><br><span class="line">cls: 0x7ffeec3d f9 18 </span><br><span class="line">obj: 0x7ffeec3d f9 10</span><br></pre></td></tr></table></figure>
<p>å†å˜å½¢ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLoad &#123;</span><br><span class="line">    [super viewDidLoad];</span><br><span class="line">	/*</span><br><span class="line">	 objc_msgSuperSend(self,ViewController,sel)</span><br><span class="line">	 */</span><br><span class="line">NSLog(@&quot;self:%p ViewController.class:%p SEL:%p&quot;,self,ViewController.class,@selector(viewDidLoad));</span><br><span class="line">    id cls  = [FYPerson class];//cls æ˜¯ç±»æŒ‡é’ˆ</span><br><span class="line">    void * obj = &amp;cls; //obj </span><br><span class="line">    [(__bridge id)obj print];//objc_msgSend(self,sel);</span><br><span class="line">    </span><br><span class="line"> NSLog(@&quot;cls:%p obj:%p&quot;,&amp;cls,&amp;obj);</span><br><span class="line"> //log</span><br><span class="line"> </span><br><span class="line"> name1:&lt;ViewController: 0x7fad03e04ea0&gt; </span><br><span class="line"> name2:ViewController</span><br><span class="line"> </span><br><span class="line"> self:                  0x7fad03e04ea0 </span><br><span class="line"> ViewController.class:  0x10d0edf00 </span><br><span class="line"> SEL:                   0x1117d5687</span><br><span class="line"> </span><br><span class="line"> cls:0x7ffee2b11908 </span><br><span class="line"> obj:0x7ffee2b11900</span><br><span class="line"> </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>_name1</code>æ˜¯<code>cls</code>åœ°å€å‘ä¸Š+8å­—èŠ‚ï¼Œ<code>_name2</code>æ˜¯å‘ä¸Šç§»åŠ¨16å­—èŠ‚ï¼Œ<code>[super viewDidLoad]</code>æœ¬è´¨ä¸Šæ˜¯<code>objc_msgSuperSend(self,ViewController.class,sel)</code>ï¼Œ<code>self</code>ã€<code>ViewController.class</code>ã€<code>SEL</code>æ˜¯åŒä¸€å—è¿ç»­å†…å­˜ï¼Œå¸ƒå±€ç”±ä½åˆ°é«˜ï¼Œçœ‹äº†ä¸‹å›¾çš„å†…å­˜å¸ƒå±€å°±ä¼šé¡¿æ‚Ÿï¼Œ<br>ç»“æ„ä½“å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<table>
<thead>
<tr>
<th style="text-align:center">å¯¹è±¡</th>
<th style="text-align:center">åœ°å€é«˜ä½</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">self</td>
<td style="text-align:center">ä½</td>
</tr>
<tr>
<td style="text-align:center">ViewController.class</td>
<td style="text-align:center">ä¸­</td>
</tr>
<tr>
<td style="text-align:center">SEL</td>
<td style="text-align:center">é«˜</td>
</tr>
</tbody>
</table>
<h3 id="å¸¸ç”¨çš„runtimeAPI"><a href="#å¸¸ç”¨çš„runtimeAPI" class="headerlink" title="å¸¸ç”¨çš„runtimeAPI"></a>å¸¸ç”¨çš„runtimeAPI</h3><table>
<thead>
<tr>
<th style="text-align:center">method</th>
<th style="text-align:center">desc</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Class objc_allocateClassPair(Class superclass, const char *name, size_t extraBytes)</td>
<td style="text-align:center">åŠ¨æ€åˆ›å»ºä¸€ä¸ªç±»ï¼ˆå‚æ•°ï¼šçˆ¶ç±»ï¼Œç±»åï¼Œé¢å¤–çš„å†…å­˜ç©ºé—´</td>
</tr>
<tr>
<td style="text-align:center">void objc_registerClassPair(Class cls))</td>
<td style="text-align:center">æ³¨å†Œä¸€ä¸ªç±»</td>
</tr>
<tr>
<td style="text-align:center">void objc_disposeClassPair(Class cls)</td>
<td style="text-align:center">é”€æ¯ä¸€ä¸ªç±»</td>
</tr>
<tr>
<td style="text-align:center">Class objcect_getClass(id obj)</td>
<td style="text-align:center">è·å–isaæŒ‡å‘çš„class</td>
</tr>
<tr>
<td style="text-align:center">Class object_setClass (id obj,Class cls)</td>
<td style="text-align:center">è®¾ç½®isaæŒ‡å‘çš„class</td>
</tr>
<tr>
<td style="text-align:center">BOOL object_isClass(id class)</td>
<td style="text-align:center">åˆ¤æ–­ocå¯¹è±¡æ˜¯å¦ä¸ºClass</td>
</tr>
<tr>
<td style="text-align:center">BOOL class_isMetaClass(Class cls)</td>
<td style="text-align:center">æ˜¯å¦æ˜¯å…ƒç±»</td>
</tr>
<tr>
<td style="text-align:center">Class class_getSuperclass(Class cls)</td>
<td style="text-align:center">è·å–çˆ¶ç±»</td>
</tr>
<tr>
<td style="text-align:center">Ivar class_getInstanceVariable(Class cls ,const char * name</td>
<td style="text-align:center">è·å–ä¸€ä¸ªå®ä¾‹å˜é‡ä¿¡æ¯</td>
</tr>
<tr>
<td style="text-align:center">Ivar <em> class_copyIvarList(Class cls,unsigned int </em> outCount)</td>
<td style="text-align:center">æ‹·è´å®ä¾‹å˜é‡åˆ—è¡¨ï¼Œéœ€è¦free</td>
</tr>
<tr>
<td style="text-align:center">void object_setIvar(id obj,Ivar ivar,id value</td>
<td style="text-align:center">è®¾ç½®è·å–å®ä¾‹å˜é‡çš„å€¼</td>
</tr>
<tr>
<td style="text-align:center">id object_getIvar(id obj,Ivar ivar)</td>
<td style="text-align:center">è·å–å®ä¾‹å˜é‡çš„å€¼</td>
</tr>
<tr>
<td style="text-align:center">BOOL class_addIvar(Class cls,const cahr <em> name ,size_t size,uint_t alignment,const char </em> types)</td>
<td style="text-align:center">åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡ï¼ˆå·²æ³¨å†Œçš„ç±»ä¸èƒ½åŠ¨æ€æ·»åŠ æˆå‘˜å˜é‡ï¼‰</td>
</tr>
<tr>
<td style="text-align:center">const char * ivar_getNameï¼ˆIvar v)</td>
<td style="text-align:center">è·å–å˜é‡åå­—</td>
</tr>
<tr>
<td style="text-align:center">const char * ivar_getTypeEncoding(Ivar v)</td>
<td style="text-align:center">å˜é‡çš„encode</td>
</tr>
<tr>
<td style="text-align:center">objc_property_t class_getProperty(Class cls,const char* name)</td>
<td style="text-align:center">è·å–ä¸€ä¸ªå±æ€§</td>
</tr>
<tr>
<td style="text-align:center">objc_property_t _Nonnull <em> _Nullable class_copyPropertyList(Class _Nullable cls, unsigned int </em> _Nullable outCount)</td>
<td style="text-align:center">æ‹·è´å±æ€§åˆ—è¡¨</td>
</tr>
<tr>
<td style="text-align:center">objc_property_t _Nullable class_getProperty(Class _Nullable cls, const char * _Nonnull name)</td>
<td style="text-align:center">è·å–å±æ€§åˆ—è¡¨</td>
</tr>
<tr>
<td style="text-align:center">BOOL class_addProperty(Class _Nullable cls, const char <em> _Nonnull name,const objc_property_attribute_t </em> _Nullable attributes,unsigned int attributeCount)</td>
<td style="text-align:center">æ·»åŠ å±æ€§</td>
</tr>
<tr>
<td style="text-align:center">void class_replaceProperty(Class _Nullable cls, const char <em> _Nonnull name,const objc_property_attribute_t </em> _Nullable attributes, unsigned int attributeCount)</td>
<td style="text-align:center">æ›¿æ¢å±æ€§</td>
</tr>
<tr>
<td style="text-align:center">void class_replaceProperty(Class cls, const char <em>name, const objc_property_attribute_t </em>attributes,unsigned int attributeCount)</td>
<td style="text-align:center">åŠ¨æ€æ›¿æ¢å±æ€§</td>
</tr>
<tr>
<td style="text-align:center">const char * _Nonnull property_getName(objc_property_t _Nonnull property)</td>
<td style="text-align:center">è·å–name</td>
</tr>
<tr>
<td style="text-align:center">const char * _Nullable property_getAttributes(objc_property_t _Nonnull property)</td>
<td style="text-align:center">è·å–å±æ€§çš„å±æ€§</td>
</tr>
<tr>
<td style="text-align:center">IMP imp_implementationWithBlock(id block)</td>
<td style="text-align:center">è·å–blockçš„IMP</td>
</tr>
<tr>
<td style="text-align:center">id imp_getBlock(IMP anIMP)</td>
<td style="text-align:center">é€šè¿‡imp è·å–block</td>
</tr>
<tr>
<td style="text-align:center">BOOL imp_removeBlock(IMP anIMP)</td>
<td style="text-align:center">IMPæ˜¯å¦è¢«åˆ é™¤</td>
</tr>
<tr>
<td style="text-align:center">â€¦</td>
<td style="text-align:center">â€¦</td>
</tr>
</tbody>
</table>
<p>åœ¨ä¸šåŠ¡ä¸Šæœ‰äº›æ—¶å€™éœ€è¦ç»™ç³»ç»Ÿæ§ä»¶çš„æŸä¸ªå±æ€§èµ‹å€¼ï¼Œä½†æ˜¯ç³»ç»Ÿæ²¡æœ‰æä¾›æ–¹æ³•ï¼Œåªèƒ½é è‡ªå·±äº†ï¼Œé‚£ä¹ˆæˆ‘ä»¬<br>è·å–<code>class</code>çš„æ‰€æœ‰æˆå‘˜å˜é‡,å¯ä»¥è·å–<code>Ivar</code>æŸ¥çœ‹æ˜¯å¦æœ‰è¯¥å˜é‡ï¼Œç„¶åå¯ä»¥é€šè¿‡<code>KVC</code>æ¥èµ‹å€¼ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@interface FYCat : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString * name;</span><br><span class="line">@property (nonatomic,assign) int  age;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">FYCat *cat=[FYCat new];</span><br><span class="line">unsigned int count = 0;</span><br><span class="line">Ivar *vars= class_copyIvarList(cat.class, &amp;count);</span><br><span class="line">for (int i = 0; i &lt; count; i ++) &#123;</span><br><span class="line">	Ivar item = vars[i];</span><br><span class="line">	const char *name = ivar_getName(item);</span><br><span class="line">	NSLog(@&quot;%s&quot;,name);</span><br><span class="line">&#125;</span><br><span class="line">free(vars);</span><br><span class="line"></span><br><span class="line">Method *m1= class_copyMethodList(cat.class, &amp;count);</span><br><span class="line">for (int i = 0; i &lt; count; i ++) &#123;</span><br><span class="line">	Method item = m1[i];</span><br><span class="line">	SEL name = method_getName(item);</span><br><span class="line">	printf(&quot;method:%s \n&quot;,NSStringFromSelector(name).UTF8String);</span><br><span class="line">&#125;</span><br><span class="line">free(m1);</span><br><span class="line">		</span><br><span class="line">//log</span><br><span class="line">_age</span><br><span class="line">_name</span><br><span class="line"></span><br><span class="line">method:.cxx_destruct </span><br><span class="line">method:name </span><br><span class="line">method:setName: </span><br><span class="line">method:methodSignatureForSelector: </span><br><span class="line">method:forwardInvocation: </span><br><span class="line">method:age </span><br><span class="line">method:setAge:</span><br></pre></td></tr></table></figure>
<p>å¤§å®¶å¸¸ç”¨çš„ä¸€ä¸ªåŠŸèƒ½æ˜¯<code>JsonToModel</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬å·²ç»äº†è§£åˆ°äº†<code>runtime</code>çš„åŸºç¡€çŸ¥è¯†ï¼Œç°åœ¨å¯ä»¥è‡ªå·±æ’¸ä¸€ä¸ª<code>JsonToModel</code>äº†ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">@interface NSObject (Json)</span><br><span class="line">+ (instancetype)fy_objectWithJson:(NSDictionary *)json;</span><br><span class="line">@end</span><br><span class="line">@implementation NSObject (Json)</span><br><span class="line">+ (instancetype)fy_objectWithJson:(NSDictionary *)json&#123;</span><br><span class="line">	id obj = [[self alloc]init];</span><br><span class="line">	unsigned int count = 0;</span><br><span class="line">	Ivar *vars= class_copyIvarList(self, &amp;count);</span><br><span class="line">	for (int i = 0; i &lt; count; i ++) &#123;</span><br><span class="line">		Ivar item = vars[i];</span><br><span class="line">		const char *name = ivar_getName(item);</span><br><span class="line">		NSString * nameOC= [NSString stringWithUTF8String:name];</span><br><span class="line">		if (nameOC.length&gt;1) &#123;</span><br><span class="line">			nameOC = [nameOC substringFromIndex:1];</span><br><span class="line">			NSString * value = json[nameOC];</span><br><span class="line">			if ([value isKindOfClass:NSString.class] &amp;&amp; value.length) &#123;</span><br><span class="line">				[obj setValue:value forKey:nameOC];</span><br><span class="line">			&#125;else if ([value isKindOfClass:NSArray.class])&#123;</span><br><span class="line">				[obj setValue:value forKey:nameOC];</span><br><span class="line">			&#125;else if ([value isKindOfClass:NSDictionary.class])&#123;</span><br><span class="line">				[obj setValue:value forKey:nameOC];</span><br><span class="line">			&#125;else if ([value isKindOfClass:[NSNull class]] || [value isEqual:nil])</span><br><span class="line">			&#123;</span><br><span class="line">				printf(&quot;%s value is nil or null \n&quot;,name);</span><br><span class="line">			&#125;else if ([value integerValue] &gt; 0)&#123;</span><br><span class="line">				[obj setValue:value forKey:nameOC];</span><br><span class="line">			&#125;else&#123;</span><br><span class="line">				printf(&quot;æœªçŸ¥é”™è¯¯ \n&quot;);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	free(vars);</span><br><span class="line">	return obj;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>ç„¶åè‡ªå·±å®šä¹‰ä¸€ä¸ªå­—å…¸ï¼Œæ¥æµ‹è¯•ä¸€ä¸‹è¿™æ®µä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@interface FYCat : NSObject</span><br><span class="line">@property (nonatomic,copy) NSString * name;</span><br><span class="line">@property (nonatomic,assign) int  age;</span><br><span class="line"></span><br><span class="line">- (void)run;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">NSDictionary * info = @&#123;@&quot;age&quot;:@&quot;10&quot;,@&quot;value&quot;:@10,@&quot;name&quot;:@&quot;å°æ˜&quot;&#125;;</span><br><span class="line">		FYCat *cat=[FYCat fy_objectWithJson:info];</span><br><span class="line">//log</span><br><span class="line">age:10 name:å°æ˜</span><br></pre></td></tr></table></figure>
<h4 id="hooké’©å­-method-exchangeImplementations"><a href="#hooké’©å­-method-exchangeImplementations" class="headerlink" title="hooké’©å­(method_exchangeImplementations)"></a>hooké’©å­(method_exchangeImplementations)</h4><p>ç”±äºä¸šåŠ¡éœ€æ±‚éœ€è¦åœ¨æŸäº›æŒ‰é’®ç‚¹å‡»äº‹ä»¶è¿›è¡Œè®°å½•æ—¥å¿—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åˆ©ç”¨é’©å­æ¥å®ç°æ‹¦æˆªæ‰€æœ‰buttonçš„ç‚¹å‡»äº‹ä»¶ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@implementation UIButton (add)</span><br><span class="line">+ (void)load&#123;</span><br><span class="line">	Method m1= class_getInstanceMethod(self.class, @selector(sendAction:to:forEvent:));</span><br><span class="line">	Method m2= class_getInstanceMethod(self.class, @selector(fy_sendAction:to:forEvent:));</span><br><span class="line">	static dispatch_once_t onceToken;</span><br><span class="line">	dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">		method_exchangeImplementations(m1, m2);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)fy_sendAction:(SEL)action to:(id)target forEvent:(UIEvent *)event&#123;</span><br><span class="line">	NSLog(@&quot;%@ &quot;,NSStringFromSelector(action));</span><br><span class="line">	/*</span><br><span class="line">	 code here</span><br><span class="line">	 */</span><br><span class="line">	 //sel IMP å·²ç»äº¤æ¢è¿‡äº†ï¼Œæ‰€ä»¥ä¸ä¼šæ­»å¾ªç¯</span><br><span class="line">	[self fy_sendAction:action to:target forEvent:event];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥åœ¨<code>code here</code>æ·»åŠ éœ€è¦å¤„ç†çš„ä»£ç ï¼Œä¸€èˆ¬è®°å½•æ—¥å¿—å’Œå»¶è¿Ÿè§¦å‘éƒ½å¯ä»¥å¤„ç†ã€‚<code>[self fy_sendAction:action to:target forEvent:event];</code>ä¸ä¼šäº§ç”Ÿæ­»å¾ªç¯ï¼ŒåŸå› æ˜¯åœ¨<code>+load</code>ä¸­å·²ç»å°†<code>m1</code>å’Œ<code>m2</code>å·²ç»äº¤æ¢è¿‡äº†<code>IMP</code>ã€‚æˆ‘ä»¬è¿›å…¥åˆ°<code>method_exchangeImplementations</code>å†…éƒ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">void method_exchangeImplementations(Method m1, Method m2)</span><br><span class="line">&#123;</span><br><span class="line">    if (!m1  ||  !m2) return;</span><br><span class="line"></span><br><span class="line">    mutex_locker_t lock(runtimeLock);</span><br><span class="line"></span><br><span class="line">//äº¤æ¢IMP</span><br><span class="line">    IMP m1_imp = m1-&gt;imp;</span><br><span class="line">    m1-&gt;imp = m2-&gt;imp;</span><br><span class="line">    m2-&gt;imp = m1_imp;</span><br><span class="line"></span><br><span class="line">//åˆ·æ–°ç¼“å­˜</span><br><span class="line">    flushCaches(nil);</span><br><span class="line"></span><br><span class="line">    updateCustomRR_AWZ(nil, m1);</span><br><span class="line">    updateCustomRR_AWZ(nil, m2);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">struct method_t &#123;</span><br><span class="line">    SEL name;</span><br><span class="line">    const char *types;</span><br><span class="line">    MethodListIMP imp;</span><br><span class="line">&#125;;</span><br><span class="line">using MethodListIMP = IMP;</span><br></pre></td></tr></table></figure>
<p><code>m1</code>å’Œ<code>m2</code>äº¤æ¢äº†<code>IMP</code>ï¼Œäº¤æ¢çš„æ˜¯<code>method_t-&gt;imp</code>ï¼Œç„¶ååˆ·æ–°ç¼“å­˜(æ¸…ç©ºç¼“å­˜)ï¼Œç­‰ä¸‹æ¬¡è°ƒç”¨<code>IMP</code>åˆ™éœ€è¦åœ¨<code>cls-&gt;rw-&gt;data-&gt;method</code>ä¸­å»å¯»æ‰¾ã€‚</p>
<h4 id="æ•°ç»„è¶Šç•Œå’Œnilå¤„ç†"><a href="#æ•°ç»„è¶Šç•Œå’Œnilå¤„ç†" class="headerlink" title="æ•°ç»„è¶Šç•Œå’Œnilå¤„ç†"></a>æ•°ç»„è¶Šç•Œå’Œnilå¤„ç†</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">@implementation NSMutableArray (add)</span><br><span class="line">+ (void)load&#123;</span><br><span class="line">	Class cls= NSClassFromString(@&quot;__NSArrayM&quot;);</span><br><span class="line">	Method m1= class_getInstanceMethod(cls, @selector(insertObject:atIndex:));</span><br><span class="line">	SEL sel = @selector(fy_insertObject:atIndex:);</span><br><span class="line">	Method m2= class_getInstanceMethod(cls, sel);</span><br><span class="line">	</span><br><span class="line">	Method m3= class_getInstanceMethod(cls, @selector(objectAtIndexedSubscript:));</span><br><span class="line">	Method m4= class_getInstanceMethod(cls, @selector(fy_objectAtIndexedSubscript:));</span><br><span class="line"></span><br><span class="line">	static dispatch_once_t onceToken;</span><br><span class="line">	dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">		method_exchangeImplementations(m1, m2);</span><br><span class="line">		method_exchangeImplementations(m3, m4);</span><br><span class="line">	&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)fy_insertObject:(id)anObject atIndex:(NSUInteger)index&#123;</span><br><span class="line">	if (anObject != nil) &#123;</span><br><span class="line">		[self fy_insertObject:anObject atIndex:index];</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		printf(&quot; anObject is nil \n&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">- (id)fy_objectAtIndexedSubscript:(NSUInteger)idx&#123;</span><br><span class="line">	if (self.count &gt; idx) &#123;</span><br><span class="line">		return [self fy_objectAtIndexedSubscript:idx];</span><br><span class="line">	&#125;else&#123;</span><br><span class="line">		printf(&quot; %ld is outof rang \n&quot;,(long)idx);</span><br><span class="line">		return nil;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NSMutableArray *array=[NSMutableArray array];</span><br><span class="line">id obj = nil;</span><br><span class="line">[array addObject:obj];</span><br><span class="line">array[1];</span><br><span class="line"></span><br><span class="line">//log</span><br><span class="line"> anObject is nil </span><br><span class="line"> 1 is outof rang</span><br></pre></td></tr></table></figure>
<p><code>NSMutableArray</code>æ˜¯ç±»ç°‡ï¼Œä½¿ç”¨å·¥å‚æ¨¡å¼ï¼Œ<code>NSMutableArray</code>ä¸æ˜¯æ•°ç»„å®ä¾‹ï¼Œè€Œæ˜¯ç”Ÿäº§æ•°ç»„å¯¹è±¡çš„å·¥å‚ã€‚<br>çœŸå®çš„æ•°ç»„å¯¹è±¡æ˜¯<code>__NSArrayM</code>,ç„¶åç»™<code>__NSArrayM</code>é’©å­ï¼Œäº¤æ¢<code>objectAtIndexedSubscript:(NSUInteger)idx</code>å’Œ<code>insertObject:(id)anObject atIndex:(NSUInteger)index</code>æ–¹æ³•ï¼Œå®ç°å´©æºƒé¿å…ã€‚</p>
<h4 id="å­—å…¸nilå¤„ç†"><a href="#å­—å…¸nilå¤„ç†" class="headerlink" title="å­—å…¸nilå¤„ç†"></a>å­—å…¸nilå¤„ç†</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">@interface NSMutableDictionary (add)</span><br><span class="line"></span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation NSMutableDictionary (add)</span><br><span class="line">+ (void)load&#123;</span><br><span class="line">    Class cls= NSClassFromString(@&quot;__NSDictionaryM&quot;);</span><br><span class="line">    Method m1= class_getInstanceMethod(cls, @selector(setObject:forKey:));</span><br><span class="line">//    __NSDictionaryM</span><br><span class="line">    SEL sel = @selector(fy_setObject:forKey:);</span><br><span class="line">    Method m2= class_getInstanceMethod(cls, sel);</span><br><span class="line">    static dispatch_once_t onceToken;</span><br><span class="line">    dispatch_once(&amp;onceToken, ^&#123;</span><br><span class="line">        method_exchangeImplementations(m1, m2);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line">- (void)fy_setObject:(id)anObject forKey:(id&lt;NSCopying&gt;)aKey&#123;</span><br><span class="line">    if (anObject) &#123;</span><br><span class="line">        [self fy_setObject:anObject forKey:aKey];</span><br><span class="line">    &#125;else&#123;</span><br><span class="line">        NSString * key = (NSString *)aKey;</span><br><span class="line">        printf(&quot;key:%s anobj is nil \n&quot;,key.UTF8String);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<p>åˆ©ç”¨ç±»åˆ«<code>+load</code>ç»™<code>__NSDictionaryM</code>æ·»åŠ æ–¹æ³•ï¼Œç„¶åäº¤æ¢<code>IMP</code>ï¼Œå®ç°ç»™<code>NSMutableDictionary setObject:Key:</code>çš„æ—¶å€™è¿›è¡Œ<code>nil</code>æ ¡éªŒ,<code>+load</code>è™½ç„¶ç³»ç»Ÿå¯åŠ¨çš„è‡ªåŠ¨è°ƒç”¨ä¸€æ¬¡çš„ï¼Œä½†æ˜¯ä¸ºé˜²æ­¢å¼€å‘è€…å†æ¬¡è°ƒç”¨é€ æˆ<code>IMP</code>å’Œ<code>SEL</code>æ··ä¹±ï¼Œä½¿ç”¨<code>dispatch_once</code>è¿›è¡Œå•æ¬¡è¿è¡Œã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ol>
<li><code>super</code>æœ¬è´¨ä¸Šæ˜¯<code>self</code>è°ƒç”¨å‡½æ•°ï¼Œä¸è¿‡æŸ¥æ‰¾å‡½æ•°æ˜¯ä»<code>sueprclass</code>å¼€å§‹æŸ¥æ‰¾çš„</li>
<li><code>+isKandOfClass</code>æ˜¯åˆ¤æ–­<code>self</code>æ˜¯å¦æ˜¯<code>cls</code>çš„å­ç±»ï¼Œ<code>+isMemberOfClass:</code>æ˜¯åˆ¤æ–­<code>self</code>æ˜¯å¦å’Œ<code>cls</code>ç›¸åŒã€‚</li>
<li>äº†è§£<code>+load</code>åœ¨<code>Category</code>æ˜¯å¯åŠ¨çš„æ—¶å€™ä½¿ç”¨è¿è¡Œæ—¶ç¼–è¯‘çš„ï¼Œè€Œä¸”åªä¼šåŠ è½½ä¸€æ¬¡,ç„¶ååˆ©ç”¨<code>objc/runtime.h</code>ä¸­<code>method_exchangeImplementations</code>å®ç°äº¤æ¢ä¸¤ä¸ªå‡½æ•°çš„<code>IMP</code>ï¼Œå¯ä»¥å®ç°æ‹¦æˆª<code>nil</code>ï¼Œé™ä½å´©æºƒç‡ã€‚</li>
<li><code>NSMutableDictionary</code>ã€<code>NSMutableArray</code>æ˜¯ç±»ç°‡ï¼Œå…ˆæ‰¾åˆ°ä»–ä»¬çš„ç±»ç„¶åå†äº¤æ¢è¯¥ç±»çš„å‡½æ•°çš„<code>IMP</code>ã€‚</li>
</ol>
<h3 id="èµ„æ–™å‚è€ƒ"><a href="#èµ„æ–™å‚è€ƒ" class="headerlink" title="èµ„æ–™å‚è€ƒ"></a>èµ„æ–™å‚è€ƒ</h3><ul>
<li><a href="http://www.520it.com/zt/ios_mj/" target="_blank" rel="noopener">å°ç å“¥è§†é¢‘</a></li>
</ul>
<h4 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h4><ul>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="noopener">å­¦ä¹ èµ„æ–™ä¸‹è½½</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="noopener">demo code</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC/objc4-750" target="_blank" rel="noopener">runtimeå¯è¿è¡Œçš„æºç </a></li>
</ul>
<hr>
<p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p>
<p>å¹¿å‘Šæ—¶é—´</p>
<p><img src="/images/0.png" alt></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://fgyong.cn/2019/12/01/iOSåº•å±‚åŸç† runtime- objc_msgSendæ‹¾é—åŸºç¡€ç¯‡--(7)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="fgyong">
      <meta itemprop="description" content="åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="fgyongçš„æŠ€æœ¯åšå®¢">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/12/01/iOSåº•å±‚åŸç† runtime- objc_msgSendæ‹¾é—åŸºç¡€ç¯‡--(7)/" class="post-title-link" itemprop="http://fgyong.cn/index.html">iOSåº•å±‚åŸç† runtime- objc_msgSendæ‹¾é—åŸºç¡€ç¯‡--(7)</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              
                
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2019-12-01 11:17:58" itemprop="dateCreated datePublished" datetime="2019-12-01T11:17:58+08:00">2019-12-01</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">æ›´æ–°äº</span>
                
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-09-03 16:24:13" itemprop="dateModified" datetime="2020-09-03T16:24:13+08:00">2020-09-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">åˆ†ç±»äº</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/iOS/" itemprop="url" rel="index"><span itemprop="name">iOS</span></a></span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>arm64ä¹‹åisaæ˜¯ä½¿ç”¨è”åˆä½“ä½¿ç”¨æ›´å°‘çš„ç©ºé—´å­˜å‚¨æ›´å¤šçš„æ•°æ®ï¼Œä»¥åŠå¦‚ä½•è‡ªå®šä¹‰å’Œä½¿ç”¨è”åˆä½“ï¼Œ<code>objc_class-&gt;cache_t cache</code>æ˜¯ä¸€ä¸ªæ˜¯ç¼“å­˜æœ€è¿‘è°ƒç”¨<code>class</code>çš„æ–¹æ³•ï¼Œå½“ç¼“å­˜å‰©ä½™ç©ºé—´å°ä½™1/4åˆ™è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹ä¸ºåŸæ¥çš„ä¸¤å€ï¼Œæ‰©å®¹ä¹‹åï¼Œå·²å­˜å‚¨çš„<code>method_t</code>æ‰©å®¹ä¹‹åä¹‹åè¢«æ¸…ç©ºã€‚ä»Šå¤©æˆ‘ä»¬åœ¨äº†è§£runtimeçš„æ¶ˆæ¯è½¬å‘æœºåˆ¶ã€‚</p>
<h4 id="åŸºç¡€çŸ¥è¯†"><a href="#åŸºç¡€çŸ¥è¯†" class="headerlink" title="åŸºç¡€çŸ¥è¯†"></a>åŸºç¡€çŸ¥è¯†</h4><p>OCä¸­çš„æ–¹æ³•è°ƒç”¨ï¼Œå…¶å®éƒ½æ˜¯è½¬æ¢ä¸ºobjc_msgSendå‡½æ•°çš„è°ƒç”¨</p>
<p>objc_msgSendçš„æ‰§è¡Œæµç¨‹å¯ä»¥åˆ†ä¸º3å¤§é˜¶æ®µ</p>
<ol>
<li>æ¶ˆæ¯å‘é€</li>
<li>åŠ¨æ€æ–¹æ³•è§£æ</li>
<li>æ¶ˆæ¯è½¬å‘</li>
</ol>
<p>é‚£ä¹ˆæˆ‘ä»¬æ ¹æ®è¿™ä¸‰å—å†…å®¹è¿›è¡Œæºç è§£è¯»ã€‚æºç æ‰§è¡Œçš„é¡ºåºå¤§æ¦‚å¦‚ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">objc-msg-arm64.s</span><br><span class="line">ENTRY _objc_msgSend</span><br><span class="line">b.le	LNilOrTagged //&lt;0åˆ™è¿”å›</span><br><span class="line">CacheLookup NORMAL //ç¼“å­˜æŸ¥æ‰¾ æœªå‘½ä¸­åˆ™ç»§ç»­æŸ¥æ‰¾</span><br><span class="line">.macro CacheLookup// é€šè¿‡å® æŸ¥æ‰¾cacheï¼Œå‘½ä¸­ç›´æ¥call or return imp</span><br><span class="line">.macro CheckMiss //miss åˆ™è·³è½¬__objc_msgSend_uncached</span><br><span class="line">STATIC_ENTRY __objc_msgSend_uncached </span><br><span class="line">.macro MethodTableLookup//æ–¹æ³•ä¸­æŸ¥æ‰¾</span><br><span class="line">__class_lookupMethodAndLoadCache3//è·³è½¬-&gt;__class_lookupMethodAndLoadCache3 åœ¨runtime-class-new.mm 4856è¡Œ</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">objc-runtime-new.mm</span><br><span class="line">_class_lookupMethodAndLoadCache3</span><br><span class="line">lookUpImpOrForward</span><br><span class="line">getMethodNoSuper_nolockã€search_method_listã€log_and_fill_cache</span><br><span class="line">cache_getImpã€log_and_fill_cacheã€getMethodNoSuper_nolockã€log_and_fill_cache</span><br><span class="line">_class_resolveInstanceMethod</span><br><span class="line">_objc_msgForward_impcache</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">objc-msg-arm64.s</span><br><span class="line">STATIC_ENTRY __objc_msgForward_impcache</span><br><span class="line">ENTRY __objc_msgForward</span><br><span class="line"></span><br><span class="line">Core Foundation</span><br><span class="line">__forwarding__ï¼ˆä¸å¼€æºï¼‰</span><br></pre></td></tr></table></figure>
<h3 id="æ¶ˆæ¯å‘é€"><a href="#æ¶ˆæ¯å‘é€" class="headerlink" title="æ¶ˆæ¯å‘é€"></a>æ¶ˆæ¯å‘é€</h3><p><code>objc_msgSend</code>æ˜¯æ±‡ç¼–å†™çš„ï¼Œåœ¨æºç <code>objc-msg-arm64.s</code>304è¡Œï¼Œæ˜¯<code>objc_msgSend</code>çš„å¼€å§‹ï¼Œ<code>_objc_msgSend</code>ç»“æŸæ˜¯351è¡Œ,<br>è¿›å…¥åˆ°<code>objc_msgSend</code>å‡½æ•°å†…éƒ¨ä¸€æ¢ç©¶ç«Ÿï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">	ENTRY _objc_msgSend // _objc_msgSend å¼€å§‹</span><br><span class="line">	UNWIND _objc_msgSend, NoFrame</span><br><span class="line"></span><br><span class="line">	cmp	p0, #0			// æ£€æŸ¥p0å¯„å­˜å™¨æ˜¯å¦æ˜¯0  _objc_msgSend()ç¬¬ä¸€ä¸ªå‚æ•°:self</span><br><span class="line">#if SUPPORT_TAGGED_POINTERS</span><br><span class="line">	b.le	LNilOrTagged		// if le &lt; 0 -&gt;  è·³è½¬åˆ°æ ‡ç­¾  LNilOrTagged</span><br><span class="line">#else</span><br><span class="line">	b.eq	LReturnZero // if le == 0 -&gt;  è·³è½¬åˆ°æ ‡ç­¾  LReturnZero</span><br><span class="line">#endif</span><br><span class="line">	ldr	p13, [x0]		// p13 = isa</span><br><span class="line">	GetClassFromIsa_p16 p13		// p16 = class</span><br><span class="line">LGetIsaDone:</span><br><span class="line">	CacheLookup NORMAL		// calls imp or objc_msgSend_uncached</span><br><span class="line"></span><br><span class="line">#if SUPPORT_TAGGED_POINTERS</span><br><span class="line">LNilOrTagged:</span><br><span class="line">	b.eq	LReturnZero		// å¦‚æœ==0 -&gt; LReturnZero</span><br><span class="line"></span><br><span class="line">	// tagged</span><br><span class="line">	adrp	x10, _objc_debug_taggedpointer_classes@PAGE</span><br><span class="line">	add	x10, x10, _objc_debug_taggedpointer_classes@PAGEOFF</span><br><span class="line">	ubfx	x11, x0, #60, #4</span><br><span class="line">	ldr	x16, [x10, x11, LSL #3]</span><br><span class="line">	adrp	x10, _OBJC_CLASS_$___NSUnrecognizedTaggedPointer@PAGE</span><br><span class="line">	add	x10, x10, _OBJC_CLASS_$___NSUnrecognizedTaggedPointer@PAGEOFF</span><br><span class="line">	cmp	x10, x16</span><br><span class="line">	b.ne	LGetIsaDone</span><br><span class="line"></span><br><span class="line">	// ext tagged</span><br><span class="line">	adrp	x10, _objc_debug_taggedpointer_ext_classes@PAGE</span><br><span class="line">	add	x10, x10, _objc_debug_taggedpointer_ext_classes@PAGEOFF</span><br><span class="line">	ubfx	x11, x0, #52, #8</span><br><span class="line">	ldr	x16, [x10, x11, LSL #3]</span><br><span class="line">	b	LGetIsaDone</span><br><span class="line">// SUPPORT_TAGGED_POINTERS</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">LReturnZero:</span><br><span class="line">	// x0 is already zero</span><br><span class="line">	mov	x1, #0</span><br><span class="line">	movi	d0, #0</span><br><span class="line">	movi	d1, #0</span><br><span class="line">	movi	d2, #0</span><br><span class="line">	movi	d3, #0</span><br><span class="line">	ret //return è¿”å›ç»“æŸæ‰</span><br><span class="line"></span><br><span class="line">	END_ENTRY _objc_msgSend // _objc_msgSend ç»“æŸ</span><br></pre></td></tr></table></figure>
<p>å½“<code>objc_msgSend(id,SEL,arg)</code>çš„<code>id</code>ä¸ºç©ºçš„æ—¶å€™ï¼Œè·³è½¬æ ‡ç­¾<code>LNilOrTagged</code>,è¿›å…¥æ ‡ç­¾å†…ï¼Œå½“ç­‰äº0åˆ™è·³è½¬<code>LReturnZero</code>,è¿›å…¥åˆ°<code>LReturnZero</code>å†…ï¼Œæ¸…é™¤æ•°æ®å’Œreturnã€‚ä¸ç­‰äºé›¶ï¼Œè·å–isaå’Œclassï¼Œè°ƒç”¨<code>CacheLookup NORMAL</code>,è¿›å…¥åˆ°<code>CacheLookup</code>å†…éƒ¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">.macro CacheLookup //.macro æ˜¯ä¸€ä¸ªå® ä½¿ç”¨ _cmd&amp;mask æŸ¥æ‰¾ç¼“å­˜ä¸­çš„æ–¹æ³•</span><br><span class="line">	// p1 = SEL, p16 = isa</span><br><span class="line">	ldp	p10, p11, [x16, #CACHE]	// p10 = buckets, p11 = occupied|mask</span><br><span class="line">#if !__LP64__</span><br><span class="line">	and	w11, w11, 0xffff	// p11 = mask</span><br><span class="line">#endif</span><br><span class="line">	and	w12, w1, w11		// x12 = _cmd &amp; mask</span><br><span class="line">	add	p12, p10, p12, LSL #(1+PTRSHIFT)</span><br><span class="line">		             // p12 = buckets + ((_cmd &amp; mask) &lt;&lt; (1+PTRSHIFT))</span><br><span class="line"></span><br><span class="line">	ldp	p17, p9, [x12]		// &#123;imp, sel&#125; = *bucket</span><br><span class="line">1:	cmp	p9, p1			// if (bucket-&gt;sel != _cmd)</span><br><span class="line">	b.ne	2f			//     scan more</span><br><span class="line">	CacheHit $0			// call or return imp å‘½ä¸­ è°ƒç”¨æˆ–è€…è¿”å›imp</span><br><span class="line">	</span><br><span class="line">2:	// not hit: p12 = not-hit bucket æ²¡æœ‰å‘½ä¸­</span><br><span class="line">	CheckMiss $0			// miss if bucket-&gt;sel == 0</span><br><span class="line">	cmp	p12, p10		// wrap if bucket == buckets</span><br><span class="line">	b.eq	3f</span><br><span class="line">	ldp	p17, p9, [x12, #-BUCKET_SIZE]!	// &#123;imp, sel&#125; = *--bucket</span><br><span class="line">	b	1b			// loop</span><br><span class="line"></span><br><span class="line">3:	// wrap: p12 = first bucket, w11 = mask</span><br><span class="line">	add	p12, p12, w11, UXTW #(1+PTRSHIFT)</span><br><span class="line">		                        // p12 = buckets + (mask &lt;&lt; 1+PTRSHIFT)</span><br><span class="line"></span><br><span class="line">	// Clone scanning loop to miss instead of hang when cache is corrupt.</span><br><span class="line">	// The slow path may detect any corruption and halt later.</span><br><span class="line"></span><br><span class="line">	ldp	p17, p9, [x12]		// &#123;imp, sel&#125; = *bucket</span><br><span class="line">1:	cmp	p9, p1			// if (bucket-&gt;sel != _cmd)</span><br><span class="line">	b.ne	2f			//     scan more</span><br><span class="line">	CacheHit $0			// call or return imp</span><br><span class="line">	</span><br><span class="line">2:	// not hit: p12 = not-hit bucket</span><br><span class="line">	CheckMiss $0			// miss if bucket-&gt;sel == 0</span><br><span class="line">	cmp	p12, p10		// wrap if bucket == buckets</span><br><span class="line">	b.eq	3f</span><br><span class="line">	ldp	p17, p9, [x12, #-BUCKET_SIZE]!	// &#123;imp, sel&#125; = *--bucket</span><br><span class="line">	b	1b			// loop</span><br><span class="line"></span><br><span class="line">3:	// double wrap</span><br><span class="line">	JumpMiss $0</span><br><span class="line">	</span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure>
<p>æ±‡ç¼–ä»£ç å·¦è¾¹æ˜¯ä»£ç ï¼Œå³è¾¹æ˜¯æ³¨é‡Šï¼Œå¤§æ¦‚éƒ½å¯ä»¥çœ‹æ‡‚çš„ã€‚<br>å½“å‘½ä¸­åˆ™<code>return imp</code>,å¦åˆ™åˆ™è·³è½¬<code>CheckMiss</code>,è¿›å…¥åˆ°<code>CheckMiss</code>å†…éƒ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">.macro CheckMiss</span><br><span class="line">	// miss if bucket-&gt;sel == 0</span><br><span class="line">.if $0 == GETIMP</span><br><span class="line">	cbz	p9, LGetImpMiss</span><br><span class="line">.elseif $0 == NORMAL</span><br><span class="line">	cbz	p9, __objc_msgSend_uncached</span><br><span class="line">.elseif $0 == LOOKUP</span><br><span class="line">	cbz	p9, __objc_msgLookup_uncached</span><br><span class="line">.else</span><br><span class="line">.abort oops</span><br><span class="line">.endif</span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure>
<p>åˆšæ‰ä¼ çš„å€¼æ˜¯<code>NORMAL</code>ï¼Œåˆ™è·³è½¬<code>__objc_msgSend_uncached</code>ï¼Œè¿›å…¥åˆ°<code>__objc_msgSend_uncached</code>å†…éƒ¨(484è¡Œ)ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ENTRY __objc_msgSend_uncached</span><br><span class="line">UNWIND __objc_msgSend_uncached, FrameWithNoSaves</span><br><span class="line">MethodTableLookup</span><br><span class="line">TailCallFunctionPointer x17</span><br><span class="line">END_ENTRY __objc_msgSend_uncached</span><br></pre></td></tr></table></figure>
<p>è°ƒç”¨<code>MethodTableLookup</code>,æˆ‘ä»¬æŸ¥çœ‹<code>MethodTableLookup</code>å†…éƒ¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">.macro MethodTableLookup</span><br><span class="line">	// push frame</span><br><span class="line">	SignLR</span><br><span class="line">	stp	fp, lr, [sp, #-16]!</span><br><span class="line">	mov	fp, sp</span><br><span class="line"></span><br><span class="line">	// save parameter registers: x0..x8, q0..q7</span><br><span class="line">	sub	sp, sp, #(10*8 + 8*16)</span><br><span class="line">	stp	q0, q1, [sp, #(0*16)]</span><br><span class="line">	stp	q2, q3, [sp, #(2*16)]</span><br><span class="line">	stp	q4, q5, [sp, #(4*16)]</span><br><span class="line">	stp	q6, q7, [sp, #(6*16)]</span><br><span class="line">	stp	x0, x1, [sp, #(8*16+0*8)]</span><br><span class="line">	stp	x2, x3, [sp, #(8*16+2*8)]</span><br><span class="line">	stp	x4, x5, [sp, #(8*16+4*8)]</span><br><span class="line">	stp	x6, x7, [sp, #(8*16+6*8)]</span><br><span class="line">	str	x8,     [sp, #(8*16+8*8)]</span><br><span class="line"></span><br><span class="line">	// receiver and selector already in x0 and x1</span><br><span class="line">	mov	x2, x16</span><br><span class="line">	bl	__class_lookupMethodAndLoadCache3//è·³è½¬-&gt;__class_lookupMethodAndLoadCache3 åœ¨runtime-class-new.mm 4856è¡Œ</span><br><span class="line"></span><br><span class="line">	// IMP in x0</span><br><span class="line">	mov	x17, x0</span><br><span class="line">	</span><br><span class="line">	// restore registers and return</span><br><span class="line">	ldp	q0, q1, [sp, #(0*16)]</span><br><span class="line">	ldp	q2, q3, [sp, #(2*16)]</span><br><span class="line">	ldp	q4, q5, [sp, #(4*16)]</span><br><span class="line">	ldp	q6, q7, [sp, #(6*16)]</span><br><span class="line">	ldp	x0, x1, [sp, #(8*16+0*8)]</span><br><span class="line">	ldp	x2, x3, [sp, #(8*16+2*8)]</span><br><span class="line">	ldp	x4, x5, [sp, #(8*16+4*8)]</span><br><span class="line">	ldp	x6, x7, [sp, #(8*16+6*8)]</span><br><span class="line">	ldr	x8,     [sp, #(8*16+8*8)]</span><br><span class="line"></span><br><span class="line">	mov	sp, fp</span><br><span class="line">	ldp	fp, lr, [sp], #16</span><br><span class="line">	AuthenticateLR</span><br><span class="line">.endmacro</span><br></pre></td></tr></table></figure>
<p>æœ€ç»ˆè·³è½¬åˆ°<code>__class_lookupMethodAndLoadCache3</code>,å»æ‰ä¸€ä¸ªä¸‹åˆ’çº¿å°±æ˜¯cå‡½æ•°ï¼Œåœ¨<code>runtime-class-new.mm 4856è¡Œ</code>,<br>è°ƒç”¨äº†å‡½æ•°<code>lookUpImpOrForward(cls, sel, obj, 
                              YES/*initialize*/, NO/*cache*/, YES/*resolver*/);</code>,ç¬¬ä¸€æ¬¡ä¼šåˆå§‹åŒ–<code>cls</code>å’Œ<code>resolver</code>çš„å€¼ï¼Œ<br>ä¸­æœ€ç»ˆè·³è½¬åˆ°<code>c/c++</code>å‡½æ•°<code>lookUpImpOrForward</code>ï¼Œè¯¥å‡½æ•°æ˜¯æœ€ç»ˆèƒ½çœ‹åˆ°çš„<code>c/c++</code>,ç°åœ¨æˆ‘ä»¬è¿›å…¥åˆ°<code>lookUpImpOrForward</code>å†…éƒ¨æŸ¥çœ‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* lookUpImpOrForward.</span><br><span class="line">* initialize==NO å°½é‡é¿å…è°ƒç”¨ï¼Œæœ‰æ—¶å¯èƒ½ä¹Ÿä¼šè°ƒç”¨ã€‚</span><br><span class="line">* cache==NO è·³è¿‡ç¼“å­˜æŸ¥æ‰¾ï¼Œå…¶ä»–åœ°æ–¹å¯èƒ½ä¼šä¸è°ƒè¿‡</span><br><span class="line">* å¤§å¤šæ•°äººä¼šä¼ å€¼ initialize==YES and cache==YES</span><br><span class="line">*   å¦‚æœclsæ˜¯éåˆå§‹åŒ–çš„å…ƒç±»ï¼Œåˆ™éNon-nilä¼šå¿«ç‚¹</span><br><span class="line">* May return _objc_msgForward_impcache. IMPs destined for external use </span><br><span class="line">*   must be converted to _objc_msgForward or _objc_msgForward_stret.</span><br><span class="line">* å¦‚æœä½ ä¸æƒ³ç”¨forwardingï¼Œåˆ™è°ƒç”¨lookUpImpOrNil()ä»£æ›¿</span><br><span class="line">**********************************************************************/</span><br><span class="line">IMP lookUpImpOrForward(Class cls, SEL sel, id inst, </span><br><span class="line">                       bool initialize, bool cache, bool resolver)</span><br><span class="line">&#123;</span><br><span class="line">    IMP imp = nil;</span><br><span class="line">    bool triedResolver = NO;</span><br><span class="line"></span><br><span class="line">    runtimeLock.assertUnlocked();</span><br><span class="line">    // Optimistic cache lookup</span><br><span class="line">    if (cache) &#123; //ä»æ±‡ç¼–è¿‡æ¥æ˜¯NO</span><br><span class="line">        imp = cache_getImp(cls, sel);</span><br><span class="line">        if (imp) return imp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    runtimeLock.lock();</span><br><span class="line">    checkIsKnownClass(cls);</span><br><span class="line"></span><br><span class="line">    if (!cls-&gt;isRealized()) &#123;</span><br><span class="line">        realizeClass(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (initialize  &amp;&amp;  !cls-&gt;isInitialized()) &#123;</span><br><span class="line">		//å½“clséœ€è¦åˆå§‹åŒ–å’Œæ²¡æœ‰åˆå§‹åŒ–çš„æ—¶å€™ è¿›è¡Œclsåˆå§‹åŒ–ï¼Œ</span><br><span class="line">		//åˆå§‹åŒ–ä¼šåŠ å…¥åˆ°ä¸€ä¸ªçº¿ç¨‹ï¼ŒåŒæ­¥æ‰§è¡Œï¼Œå…ˆåˆå§‹åŒ–çˆ¶ç±»ï¼Œå†åˆå§‹åŒ–å­ç±»</span><br><span class="line">		//æ•°æ®çš„å¤§å°æœ€å°æ˜¯4ï¼Œæ‰©å®¹è§„åˆ™æ˜¯ï¼šn*2+1;</span><br><span class="line">        runtimeLock.unlock();</span><br><span class="line">        _class_initialize (_class_getNonMetaClass(cls, inst));</span><br><span class="line">        runtimeLock.lock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"> retry:    </span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">//å†æ¬¡è·å–imp</span><br><span class="line">    imp = cache_getImp(cls, sel);</span><br><span class="line">    if (imp) goto done;</span><br><span class="line"></span><br><span class="line">    //å°è¯•åœ¨æœ¬ç±»ä¸­æŸ¥æ‰¾method</span><br><span class="line">    &#123;//ä»cls-&gt;data()-&gt;methodsæŸ¥æ‰¾method</span><br><span class="line">        Method meth = getMethodNoSuper_nolock(cls, sel);</span><br><span class="line">        if (meth) &#123;//æ‰¾åˆ°æ·»åŠ åˆ°cacheä¸­</span><br><span class="line">            log_and_fill_cache(cls, meth-&gt;imp, sel, inst, cls);</span><br><span class="line">            imp = meth-&gt;imp;</span><br><span class="line">            goto done;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Try superclass caches and method lists.</span><br><span class="line">	//ä»cls-&gt;superclass-&gt;data()-&gt;methodsæŸ¥æ‰¾methdï¼Œsuperclsæ²¡æœ‰æŸ¥æ‰¾å‡ºæ¥ï¼Œå†æŸ¥æ‰¾çˆ¶ç±»çš„çˆ¶ç±»ã€‚</span><br><span class="line">    &#123;</span><br><span class="line">        unsigned attempts = unreasonableClassCount();</span><br><span class="line">        for (Class curClass = cls-&gt;superclass;</span><br><span class="line">             curClass != nil;</span><br><span class="line">             curClass = curClass-&gt;superclass)</span><br><span class="line">        &#123;</span><br><span class="line">            // Halt if there is a cycle in the superclass chain.</span><br><span class="line">            if (--attempts == 0) &#123;</span><br><span class="line">                _objc_fatal(&quot;Memory corruption in class list.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // Superclass cache.</span><br><span class="line">            imp = cache_getImp(curClass, sel);</span><br><span class="line">            if (imp) &#123;</span><br><span class="line">                if (imp != (IMP)_objc_msgForward_impcache) &#123;</span><br><span class="line">                    // Found the method in a superclass. Cache it in this class.</span><br><span class="line">					//å°†çˆ¶ç±»æ·»åŠ åˆ° å­ç±»çš„ç¼“å­˜ä¸­</span><br><span class="line">                    log_and_fill_cache(cls, imp, sel, inst, curClass);</span><br><span class="line">                    goto done;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    // Found a forward:: entry in a superclass.</span><br><span class="line">                    // Stop searching, but don&apos;t cache yet; call method </span><br><span class="line">                    // resolver for this class first.</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            // Superclass method list.</span><br><span class="line">            Method meth = getMethodNoSuper_nolock(curClass, sel);</span><br><span class="line">            if (meth) &#123;</span><br><span class="line">                log_and_fill_cache(cls, meth-&gt;imp, sel, inst, curClass);</span><br><span class="line">                imp = meth-&gt;imp;</span><br><span class="line">                goto done;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	//å¦‚æœè¿˜æ²¡æœ‰æ‰¾åˆ°impï¼Œè¿›å…¥åŠ¨æ€æ–¹æ³•è§£æé˜¶æ®µ</span><br><span class="line">    if (resolver  &amp;&amp;  !triedResolver) &#123;</span><br><span class="line">        runtimeLock.unlock();</span><br><span class="line">        _class_resolveMethod(cls, sel, inst);</span><br><span class="line">        runtimeLock.lock();</span><br><span class="line">        triedResolver = YES;</span><br><span class="line">        goto retry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //å¦‚æœæ²¡æ‰¾åˆ°resolveInstanceMethod å’ŒresolveClassMethodï¼Œ</span><br><span class="line">//	è¿›è¡Œæ¶ˆæ¯è½¬å‘ é˜¶æ®µ</span><br><span class="line">    imp = (IMP)_objc_msgForward_impcache;</span><br><span class="line">	//å¡«å…… cache</span><br><span class="line">    cache_fill(cls, sel, imp, inst);</span><br><span class="line"> done:</span><br><span class="line">    runtimeLock.unlock();</span><br><span class="line">    return imp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>SUPPORT_INDEXED_ISA</code>æ˜¯åœ¨<code>arm64</code>å’Œ<code>LP64</code> è¿˜æœ‰<code>arm_arch_7k&gt;2</code>ä¸º1ï¼Œ<code>iphone</code>å±äº<code>arm64</code>ã€<code>mac os</code>å±äº<code>LP64</code>,æ‰€ä»¥<code>SUPPORT_INDEXED_ISA = 1</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// Define SUPPORT_INDEXED_ISA=1 on platforms that store the class in the isa </span><br><span class="line">// field as an index into a class table.</span><br><span class="line">// Note, keep this in sync with any .s files which also define it.</span><br><span class="line">// Be sure to edit objc-abi.h as well.</span><br><span class="line">// __ARM_ARCH_7K__ å¤„ç†å™¨æ¶æ„æŒ‡ä»¤é›†ç‰ˆæœ¬</span><br><span class="line">//__arm64__ æ¶æ„</span><br><span class="line">//__LP64__ uinx å’Œuinx  mac os</span><br><span class="line">#if __ARM_ARCH_7K__ &gt;= 2  ||  (__arm64__ &amp;&amp; !__LP64__)</span><br><span class="line">#   define SUPPORT_INDEXED_ISA 1</span><br><span class="line">#else</span><br><span class="line">#   define SUPPORT_INDEXED_ISA 0</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>
<p><code>lookUpImpOrForward</code>å‡½æ•°çš„ å¤§æ¦‚æ€è·¯å¦‚ä¸‹ï¼š</p>
<p>é¦–æ¬¡å·²ç»ä»ç¼“å­˜ä¸­æŸ¥è¿‡æ²¡æœ‰å‘½ä¸­æ‰€ä»¥ä¸å†å»ç¼“å­˜ä¸­æŸ¥äº†ï¼Œç„¶ååˆ¤æ–­<code>cls</code>æ˜¯å¦å·²ç»å®ç°ï¼Œ<code>cls-&gt;isRealized()</code>ï¼Œæ²¡æœ‰å®ç°çš„è¯è¿›è¡Œå®ç°<code>realizeClass(cls)</code>ï¼Œä¸»è¦æ˜¯å°†åˆå§‹åŒ–<code>read-write data</code>å’Œå…¶ä»–çš„ä¸€äº›æ•°æ®ï¼Œåç»­ä¼šç»†è®²ã€‚ç„¶åè¿›è¡Œ<code>cls</code>çš„åˆå§‹åŒ–<code>_class_initialize()</code>ï¼Œå½“<code>cls</code>éœ€è¦åˆå§‹åŒ–å’Œæ²¡æœ‰åˆå§‹åŒ–çš„æ—¶å€™è¿›è¡Œclsåˆå§‹åŒ–ï¼Œåˆå§‹åŒ–ä¼šåŠ å…¥åˆ°ä¸€ä¸ªçº¿ç¨‹ï¼ŒåŒæ­¥æ‰§è¡Œï¼Œå…ˆåˆå§‹åŒ–çˆ¶ç±»ï¼Œå†åˆå§‹åŒ–å­ç±»,æ•°æ®çš„å¤§å°æœ€å°æ˜¯4ï¼Œæ‰©å®¹è§„åˆ™æ˜¯ï¼š<code>n*2+1</code>;ç„¶åå†æ¬¡è·å–imp<code>cache_getImp</code>,ç„¶ååœ¨<code>cls</code>æ–¹æ³•ä¸­æŸ¥æ‰¾è¯¥<code>method</code>ï¼Œç„¶åå°±æ˜¯åœ¨<code>superclass</code>ä¸­æŸ¥æ‰¾æ–¹æ³•ï¼Œç›´åˆ°çˆ¶ç±»æ˜¯nilï¼Œæ‰¾åˆ°çš„è¯ï¼Œè·å–<code>imp</code>å¹¶å°†<code>cls</code>å’Œ<code>sel</code>åŠ å…¥åˆ°<code>cache</code>ä¸­ï¼Œå¦åˆ™è¿›å…¥åˆ°æ¶ˆæ¯è§£æé˜¶æ®µ<code>_class_resolveMethod</code>ï¼Œåœ¨è½¬å‘é˜¶æ®µï¼Œä¸æ˜¯å…ƒç±»çš„è¯ï¼Œè¿›å…¥åˆ°<code>_class_resolveInstanceMethod</code>æ˜¯å…ƒç±»çš„è¯è°ƒç”¨<code>_class_resolveClassMethod</code>,è¿™ä¸¤ç§åˆ†åˆ«éƒ½ä¼šè¿›å…¥åˆ°<code>lookUpImpOrNil</code>ï¼Œå†æ¬¡æŸ¥æ‰¾<code>IMP</code>ï¼Œå½“æ²¡æ‰¾åˆ°çš„è¯å°±è¿”å›ï¼Œæ‰¾åˆ°çš„è¯ç”¨<code>objc_msgSend</code>å‘é€æ¶ˆæ¯å®ç°è°ƒç”¨<code>SEL_resolveInstanceMethod</code>å¹¶æ ‡è®°<code>triedResolver</code>ä¸ºå·²åŠ¨æ€è§£ææ ‡å¿—ã€‚ç„¶åè¿›å…¥åˆ°æ¶ˆæ¯åŠ¨æ€è½¬å‘é˜¶æ®µ<code>_objc_msgForward_impcache</code>,è‡³æ­¤<code>runtime</code>å‘é€æ¶ˆæ¯ç»“æŸã€‚</p>
<p>å€Ÿç”¨ç½‘ä¸Šæ‰¾ä¸€ä¸ªå›¾ï¼Œ å¯ä»¥æ›´ç›´è§‚çš„çœ‹å‡ºæµç¨‹è¿è½¬ã€‚</p>
<p><img src="/images/7-1.png" alt></p>
<h4 id="realizeClass-è§£æ"><a href="#realizeClass-è§£æ" class="headerlink" title="realizeClass()è§£æ"></a>realizeClass()è§£æ</h4><p><code>realizeClass</code>æ˜¯åˆå§‹åŒ–äº†å¾ˆå¤šæ•°æ®ï¼ŒåŒ…æ‹¬<code>cls-&gt;ro</code>èµ‹å€¼ç»™<code>cls-&gt;rw</code>ï¼Œæ·»åŠ å…ƒç±»<code>version</code>ä¸º7,<code>cls-&gt;chooseClassArrayIndex()</code>è®¾ç½®<code>cls</code>çš„ç´¢å¼•ï¼Œ<code>supercls = realizeClass(remapClass(cls-&gt;superclass));
    metacls = realizeClass(remapClass(cls-&gt;ISA()))</code>åˆå§‹åŒ–<code>superclass</code>å’Œ<code>cls-&gt;isa</code>,åè¾¹é’ˆå¯¹æ²¡æœ‰ä¼˜åŒ–çš„ç»“æ„è¿›è¡Œèµ‹å€¼è¿™é‡Œä¸å¤šè®²ï¼Œç„¶ååè°ƒå®ä¾‹å˜é‡åç§»å¸ƒå±€ï¼Œè®¾ç½®<code>cls-&gt;setInstanceSize</code>,æ‹·è´<code>flags</code>ä»<code>ro</code>åˆ°<code>rw</code>ä¸­ï¼Œç„¶åæ·»åŠ <code>subclass</code>å’Œ<code>rootclass</code>ï¼Œæœ€åæ·»åŠ ç±»åˆ«çš„æ–¹æ³•ï¼Œåè®®ï¼Œå’Œå±æ€§ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* realizeClass</span><br><span class="line"> clsç¬¬ä¸€æ¬¡åˆå§‹åŒ–ä¼šæ‰§è¡Œï¼ŒåŒ…æ‹¬cls-&gt;rw-&gt;data(),è¿”å›çœŸå®çš„cls ç»“æ„ä½“</span><br><span class="line"> runtimelock å¿…é¡»æœ‰è°ƒç”¨è€…æŠŠå†™å…¥é”é”èµ·æ¥</span><br><span class="line">**********************************************************************/</span><br><span class="line">static Class realizeClass(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    const class_ro_t *ro;</span><br><span class="line">    class_rw_t *rw;</span><br><span class="line">    Class supercls;</span><br><span class="line">    Class metacls;</span><br><span class="line">    bool isMeta;</span><br><span class="line"></span><br><span class="line">    if (!cls) return nil;</span><br><span class="line">    if (cls-&gt;isRealized()) return cls;</span><br><span class="line">    assert(cls == remapClass(cls));</span><br><span class="line"></span><br><span class="line">    // fixme verify class is not in an un-dlopened part of the shared cache?</span><br><span class="line">//é¦–å…ˆå°†twèµ‹å€¼ç»™toï¼Œå› ä¸ºæ•°æ®ç»“æ„ä¸€æ ·å¯ä»¥ç›´æ¥å¼ºåˆ¶è½¬åŒ–</span><br><span class="line">    ro = (const class_ro_t *)cls-&gt;data();</span><br><span class="line">    if (ro-&gt;flags &amp; RO_FUTURE) &#123;//æ˜¯å¦å·²ç»åˆå§‹åŒ–è¿‡ï¼Œåˆå§‹åŒ–è¿‡çš„å“ˆ åˆ™ cls-&gt;rw å·²ç»åˆå§‹åŒ–è¿‡</span><br><span class="line">        rw = cls-&gt;data();</span><br><span class="line">        ro = cls-&gt;data()-&gt;ro;</span><br><span class="line">        cls-&gt;changeInfo(RW_REALIZED|RW_REALIZING, RW_FUTURE);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // æ­£å¸¸æƒ…å†µä¸‹ ç”³è¯·class_rw_tç©ºé—´</span><br><span class="line">        rw = (class_rw_t *)calloc(sizeof(class_rw_t), 1);</span><br><span class="line">        rw-&gt;ro = ro;//cls-&gt;rw-&gt;ro æŒ‡å‘ç°åœ¨çš„ro</span><br><span class="line">        rw-&gt;flags = RW_REALIZED|RW_REALIZING;//realized = 1 and  realizing = 1</span><br><span class="line">        cls-&gt;setData(rw);//èµ‹å€¼</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    isMeta = ro-&gt;flags &amp; RO_META;//æ˜¯å¦æ˜¯å…ƒç±»</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">    rw-&gt;version = isMeta ? 7 : 0;  // å…ƒç±»ç‰ˆæœ¬æ˜¯7ï¼Œæ—§ç‰ˆçš„6ï¼Œå¦å°±æ˜¯0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    // Choose an index for this class.</span><br><span class="line">//è®¾ç½®clsçš„ç´¢å¼•</span><br><span class="line">	cls-&gt;chooseClassArrayIndex();</span><br><span class="line"></span><br><span class="line">    if (PrintConnecting) &#123;</span><br><span class="line">        _objc_inform(&quot;CLASS: realizing class &apos;%s&apos;%s %p %p #%u&quot;, </span><br><span class="line">                     cls-&gt;nameForLogging(), isMeta ? &quot; (meta)&quot; : &quot;&quot;, </span><br><span class="line">                     (void*)cls, ro, cls-&gt;classArrayIndex());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å¦‚æœçˆ¶ç±»æ²¡æœ‰åˆå§‹åŒ–åˆ™è¿›è¡Œåˆå§‹åŒ–</span><br><span class="line">    // root_class åšå®Œéœ€è¦è®¾ç½®RW_REALIZED=1ï¼Œ</span><br><span class="line">    // root metaclasses éœ€è¦æ‰§è¡Œå®Œ.</span><br><span class="line">	//ä»NXMapTable è·å–cls ï¼Œç„¶åè¿›è¡Œåˆå§‹åŒ–</span><br><span class="line">	//ä»NXMapTable è·å–cls-&gt;isa ï¼Œç„¶åè¿›è¡Œåˆå§‹åŒ–</span><br><span class="line">    supercls = realizeClass(remapClass(cls-&gt;superclass));</span><br><span class="line">    metacls = realizeClass(remapClass(cls-&gt;ISA()));</span><br><span class="line">//æ²¡æœ‰ç»è¿‡ä¼˜åŒ–çš„isaæ‰§è¡Œçš„ï¼Œç°åœ¨å·²ç»æ˜¯version=7ï¼Œåœ¨arm64ä¸Šæ˜¯ä¼˜åŒ–è¿‡çš„ï¼Œè¿™ä¸ªå…ˆä¸çœ‹äº†ã€‚</span><br><span class="line">#if SUPPORT_NONPOINTER_ISA</span><br><span class="line">    // Disable non-pointer isa for some classes and/or platforms.</span><br><span class="line">    // Set instancesRequireRawIsa.</span><br><span class="line">    bool instancesRequireRawIsa = cls-&gt;instancesRequireRawIsa();</span><br><span class="line">    bool rawIsaIsInherited = false;</span><br><span class="line">    static bool hackedDispatch = false;</span><br><span class="line"></span><br><span class="line">    if (DisableNonpointerIsa) &#123;</span><br><span class="line">        // Non-pointer isa disabled by environment or app SDK version</span><br><span class="line">        instancesRequireRawIsa = true;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (!hackedDispatch  &amp;&amp;  !(ro-&gt;flags &amp; RO_META)  &amp;&amp;  </span><br><span class="line">             0 == strcmp(ro-&gt;name, &quot;OS_object&quot;)) </span><br><span class="line">    &#123;</span><br><span class="line">        // hack for libdispatch et al - isa also acts as vtable pointer</span><br><span class="line">        hackedDispatch = true;</span><br><span class="line">        instancesRequireRawIsa = true;</span><br><span class="line">    &#125;</span><br><span class="line">    else if (supercls  &amp;&amp;  supercls-&gt;superclass  &amp;&amp;  </span><br><span class="line">             supercls-&gt;instancesRequireRawIsa()) </span><br><span class="line">    &#123;</span><br><span class="line">        // This is also propagated by addSubclass() </span><br><span class="line">        // but nonpointer isa setup needs it earlier.</span><br><span class="line">        // Special case: instancesRequireRawIsa does not propagate </span><br><span class="line">        // from root class to root metaclass</span><br><span class="line">        instancesRequireRawIsa = true;</span><br><span class="line">        rawIsaIsInherited = true;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (instancesRequireRawIsa) &#123;</span><br><span class="line">        cls-&gt;setInstancesRequireRawIsa(rawIsaIsInherited);</span><br><span class="line">    &#125;</span><br><span class="line">// SUPPORT_NONPOINTER_ISA</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    // Update superclass and metaclass in case of remapping</span><br><span class="line">    cls-&gt;superclass = supercls;</span><br><span class="line">    cls-&gt;initClassIsa(metacls);</span><br><span class="line"></span><br><span class="line">	// åè°ƒå®ä¾‹å˜é‡åç§»/å¸ƒå±€</span><br><span class="line">	//å¯èƒ½é‡æ–°ç”³è¯·ç©ºé—´ class_ro_t,æ›´æ–°æˆ‘ä»¬çš„class_ro_t</span><br><span class="line">    if (supercls  &amp;&amp;  !isMeta) reconcileInstanceVariables(cls, supercls, ro);</span><br><span class="line"></span><br><span class="line">    // è®¾ç½®setInstanceSize ä»ro-&gt;instanceSize</span><br><span class="line">    cls-&gt;setInstanceSize(ro-&gt;instanceSize);</span><br><span class="line"></span><br><span class="line">	//æ‹·è´flags ä»roåˆ°rwä¸­</span><br><span class="line">    if (ro-&gt;flags &amp; RO_HAS_CXX_STRUCTORS) &#123;</span><br><span class="line">        cls-&gt;setHasCxxDtor();</span><br><span class="line">        if (! (ro-&gt;flags &amp; RO_HAS_CXX_DTOR_ONLY)) &#123;</span><br><span class="line">            cls-&gt;setHasCxxCtor();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">//æ·»åŠ superclassæŒ‡é’ˆ</span><br><span class="line">    if (supercls) &#123;</span><br><span class="line">        addSubclass(supercls, cls);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        addRootClass(cls);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Attach categories</span><br><span class="line">	//ç±»åˆ«çš„æ–¹æ³• åœ¨ç¼–è¯‘çš„æ—¶å€™æ²¡æœ‰æ·»åŠ åˆ°äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ï¼Œåœ¨è¿è¡Œçš„æ—¶å€™æ·»åŠ è¿›å»çš„</span><br><span class="line">    methodizeClass(cls);</span><br><span class="line"></span><br><span class="line">    return cls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæœ€åæ·»åŠ ç±»åˆ«çš„æ•°æ®æ˜¯è°ƒç”¨äº†<code>methodizeClass</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°é¦–å…ˆæ·»åŠ <code>method_list_t *list = ro-&gt;baseMethods()</code>åˆ°<code>rw-&gt;methods.attachLists(&amp;list, 1)</code>ï¼Œç„¶åå°†å±æ€§<code>property_list_t *proplist=ro-&gt;baseProperties</code>æ·»åŠ åˆ°<code>rw-&gt;properties.attachLists(&amp;proplist, 1)</code>,æœ€åå°†åè®®åˆ—è¡¨<code>protocol_list_t *protolist = ro-&gt;baseProtocols</code>è¿½åŠ åˆ°<code>rw-&gt;protocols.attachLists(&amp;protolist, 1)</code>ï¼Œå¦‚æœæ˜¯<code>metaclass</code>åˆ™æ·»åŠ <code>SEL_initialize</code>,ç„¶åä»å…¨å±€<code>NXMapTable *category_map</code>åˆ é™¤å·²ç»åŠ è½½çš„<code>category_list</code>,æœ€åè°ƒç”¨<code>attachCategories(cls, cats, false /*don&#39;t flush caches*/)</code>å°†å·²ç»åŠ è½½çš„<code>cats</code>çš„æ–¹æ³•æ·»åŠ åˆ°<code>cls-&gt;rw</code>ä¸Šé¢å¹¶ä¸”ä¸åˆ·æ–°<code>caches</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* methodizeClass</span><br><span class="line"> ä¿®å¤clsæ–¹æ³•åˆ—è¡¨æƒ³ï¼Œåè®®åˆ—è¡¨å’Œå±æ€§åˆ—è¡¨</span><br><span class="line">* åŠ é”</span><br><span class="line">**********************************************************************/</span><br><span class="line">static void methodizeClass(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    runtimeLock.assertLocked();</span><br><span class="line"></span><br><span class="line">    bool isMeta = cls-&gt;isMetaClass();</span><br><span class="line">    auto rw = cls-&gt;data();</span><br><span class="line">    auto ro = rw-&gt;ro;</span><br><span class="line"></span><br><span class="line">    // Methodizing for the first time</span><br><span class="line">    if (PrintConnecting) &#123;</span><br><span class="line">        _objc_inform(&quot;CLASS: methodizing class &apos;%s&apos; %s&quot;, </span><br><span class="line">                     cls-&gt;nameForLogging(), isMeta ? &quot;(meta)&quot; : &quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	//æ–¹æ³•åˆ—è¡¨</span><br><span class="line">    method_list_t *list = ro-&gt;baseMethods();</span><br><span class="line">    if (list) &#123;</span><br><span class="line">        prepareMethodLists(cls, &amp;list, 1, YES, isBundleClass(cls));</span><br><span class="line">	//å°†å¯¹è±¡çš„æ–¹æ³•è¿½åŠ åˆ°cls-&gt;rw-&gt;methodsåé¢</span><br><span class="line">        rw-&gt;methods.attachLists(&amp;list, 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    property_list_t *proplist = ro-&gt;baseProperties;</span><br><span class="line">    if (proplist) &#123;</span><br><span class="line">	//å°†å¯¹è±¡çš„å±æ€§è¿½åŠ åˆ°rw-&gt;propertiesåé¢</span><br><span class="line">        rw-&gt;properties.attachLists(&amp;proplist, 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protocol_list_t *protolist = ro-&gt;baseProtocols;</span><br><span class="line">    if (protolist) &#123;</span><br><span class="line">	//å°†å¯¹è±¡çš„åè®®è¿½åŠ åˆ°rw-&gt;protocolsåé¢</span><br><span class="line">        rw-&gt;protocols.attachLists(&amp;protolist, 1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Root classes get bonus method implementations if they don&apos;t have </span><br><span class="line">    // them already. These apply before category replacements.</span><br><span class="line">    if (cls-&gt;isRootMetaclass()) &#123;</span><br><span class="line">        // root metaclass</span><br><span class="line">        addMethod(cls, SEL_initialize, (IMP)&amp;objc_noop_imp, &quot;&quot;, NO);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // Attach categories.</span><br><span class="line">	//ç±»åˆ« ä»å…¨å±€NXMapTable *category_map å·²ç»åŠ è½½è¿‡äº†ã€‚</span><br><span class="line">    category_list *cats = unattachedCategoriesForClass(cls, true /*realizing*/);</span><br><span class="line">	//æ”¶é›†æ‰€æœ‰çš„catsåˆ°cls -&gt; rwä¸­</span><br><span class="line">    attachCategories(cls, cats, false /*don&apos;t flush caches*/);</span><br><span class="line"></span><br><span class="line">    if (PrintConnecting) &#123;</span><br><span class="line">        if (cats) &#123;</span><br><span class="line">            for (uint32_t i = 0; i &lt; cats-&gt;count; i++) &#123;</span><br><span class="line">                _objc_inform(&quot;CLASS: attached category %c%s(%s)&quot;, </span><br><span class="line">                             isMeta ? &apos;+&apos; : &apos;-&apos;, </span><br><span class="line">                             cls-&gt;nameForLogging(), cats-&gt;list[i].cat-&gt;name);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    if (cats) free(cats);//é‡Šæ”¾cats</span><br><span class="line"></span><br><span class="line">#if DEBUG</span><br><span class="line">    // Debug: sanity-check all SELs; log method list contents</span><br><span class="line">    for (const auto&amp; meth : rw-&gt;methods) &#123;</span><br><span class="line">        if (PrintConnecting) &#123;</span><br><span class="line">            _objc_inform(&quot;METHOD %c[%s %s]&quot;, isMeta ? &apos;+&apos; : &apos;-&apos;, </span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(meth.name));</span><br><span class="line">        &#125;</span><br><span class="line">        assert(sel_registerName(sel_getName(meth.name)) == meth.name); </span><br><span class="line">    &#125;</span><br><span class="line">#endif</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="attachCategories-è§£æ"><a href="#attachCategories-è§£æ" class="headerlink" title="attachCategories()è§£æ"></a>attachCategories()è§£æ</h4><p><code>methodizeClass</code>ä¹‹å‰<code>rw</code>åˆå§‹åŒ–çš„æ—¶å€™å¹¶æ²¡æœ‰å°†å…¶ä»–æ•°æ®éƒ½éƒ½å¤åˆ¶ç»™<code>rw</code>,ç°åœ¨<code>methodizeClass</code>å®ç°äº†å°†æœ¬æ¥çš„<code>ro</code>æ•°æ®æ‹·è´ç»™<code>rw</code>,ç„¶å<code>attachCategories</code>å°†<br>åˆ†ç±»çš„æ–¹æ³•ï¼Œå±æ€§ï¼Œåè®®è¿½åŠ åˆ°<code>cls-&gt;data-&gt;rw</code>ï¼Œæˆ‘ä»¬è¿›å…¥<code>attachCategories</code>å†…éƒ¨</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">static void attachCategories(Class cls, category_list *cats, bool flush_caches)</span><br><span class="line">&#123;</span><br><span class="line">    if (!cats) return;</span><br><span class="line">    if (PrintReplacedMethods) printReplacements(cls, cats);</span><br><span class="line"></span><br><span class="line">    bool isMeta = cls-&gt;isMetaClass();</span><br><span class="line"></span><br><span class="line">    // fixme rearrange to remove these intermediate allocations</span><br><span class="line">	//æ–¹æ³•æ•°ç»„[[1,2,3],[4,5,6],[7,8,9]]</span><br><span class="line">    method_list_t **mlists = (method_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*mlists));</span><br><span class="line">	//å±æ€§æ•°ç»„</span><br><span class="line">    property_list_t **proplists = (property_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*proplists));</span><br><span class="line">	//åè®®æ•°ç»„</span><br><span class="line">    protocol_list_t **protolists = (protocol_list_t **)</span><br><span class="line">        malloc(cats-&gt;count * sizeof(*protolists));</span><br><span class="line"></span><br><span class="line">    // Count backwards through cats to get newest categories first</span><br><span class="line">    int mcount = 0;</span><br><span class="line">    int propcount = 0;</span><br><span class="line">    int protocount = 0;</span><br><span class="line">    int i = cats-&gt;count;</span><br><span class="line">    bool fromBundle = NO;</span><br><span class="line">    while (i--) &#123;</span><br><span class="line">		//å–å‡ºæŸä¸ªåˆ†ç±»</span><br><span class="line">        auto&amp; entry = cats-&gt;list[i];</span><br><span class="line">//å–å‡ºåˆ†ç±» çš„ instanceæ–¹æ³•æˆ–è€…classæ–¹æ³•</span><br><span class="line">        method_list_t *mlist = entry.cat-&gt;methodsForMeta(isMeta);</span><br><span class="line">        if (mlist) &#123;</span><br><span class="line">            mlists[mcount++] = mlist; //mlists æ¥å—æ‰€æœ‰åˆ†ç±»æ–¹æ³•</span><br><span class="line">            fromBundle |= entry.hi-&gt;isBundle();</span><br><span class="line">        &#125;</span><br><span class="line">//proplist æ¥å—æ‰€æœ‰åˆ†ç±»å±æ€§</span><br><span class="line">        property_list_t *proplist = </span><br><span class="line">            entry.cat-&gt;propertiesForMeta(isMeta, entry.hi);</span><br><span class="line">        if (proplist) &#123;</span><br><span class="line">            proplists[propcount++] = proplist;</span><br><span class="line">        &#125;</span><br><span class="line">//proplist æ¥å—æ‰€æœ‰åè®®æ–¹æ³•</span><br><span class="line">        protocol_list_t *protolist = entry.cat-&gt;protocols;</span><br><span class="line">        if (protolist) &#123;</span><br><span class="line">            protolists[protocount++] = protolist;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">//æ”¶é›†äº†æ‰€æœ‰åè®® åˆ†ç±»æ–¹æ³•</span><br><span class="line">    auto rw = cls-&gt;data();</span><br><span class="line"></span><br><span class="line">    prepareMethodLists(cls, mlists, mcount, NO, fromBundle);</span><br><span class="line">	//è¿½åŠ æ‰€æœ‰åˆ†ç±»æ–¹æ³•</span><br><span class="line">    rw-&gt;methods.attachLists(mlists, mcount);</span><br><span class="line">	//é‡Šæ”¾æ•°ç»„</span><br><span class="line">    free(mlists);</span><br><span class="line">	//åˆ·æ–°è¯¥ç±»çš„ç¼“å­˜</span><br><span class="line">    if (flush_caches  &amp;&amp;  mcount &gt; 0) flushCaches(cls);</span><br><span class="line">//è¿½åŠ æ‰€æœ‰åˆ†ç±»å±æ€§</span><br><span class="line">    rw-&gt;properties.attachLists(proplists, propcount);</span><br><span class="line">    free(proplists);//é‡Šæ”¾æ•°ç»„</span><br><span class="line">//è¿½åŠ æ‰€æœ‰åˆ†ç±»åè®®</span><br><span class="line">    rw-&gt;protocols.attachLists(protolists, protocount);</span><br><span class="line">    free(protolists);//é‡Šæ”¾æ•°ç»„</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="rw-gt-list-gt-attachLists-è§£æ"><a href="#rw-gt-list-gt-attachLists-è§£æ" class="headerlink" title="rw-&gt;list-&gt;attachLists()è§£æ"></a>rw-&gt;list-&gt;attachLists()è§£æ</h4><p>æ·»åŠ <code>attachLists</code>å‡½æ•°è§„åˆ™æ˜¯åæ¥çš„å´æ·»åŠ åˆ°å†…å­˜çš„å‰éƒ¨åˆ†ï¼Œè¿™é‡Œå°±æ¸…æ¥šä¸ºä»€ä¹ˆåç¼–è¯‘ç±»åˆ«èƒ½åè¾¹çš„ç±»åˆ«è¦†ç›–å‰è¾¹çš„ç±»åˆ«çš„ç›¸åŒåå­—çš„æ–¹æ³•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">void attachLists(List* const * addedLists, uint32_t addedCount) &#123;</span><br><span class="line">       if (addedCount == 0) return;</span><br><span class="line"></span><br><span class="line">       if (hasArray()) &#123;</span><br><span class="line">           // many lists -&gt; many lists</span><br><span class="line">           uint32_t oldCount = array()-&gt;count;</span><br><span class="line">		//ä¸€å…±éœ€è¦çš„æ•°é‡</span><br><span class="line">           uint32_t newCount = oldCount + addedCount;</span><br><span class="line">		//åˆ†é…å†…å­˜ å†…å­˜ä¸å¤Ÿç”¨äº†ï¼Œéœ€è¦æ‰©å®¹</span><br><span class="line">           setArray((array_t *)realloc(array(), array_t::byteSize(newCount)));</span><br><span class="line">		//èµ‹å€¼count</span><br><span class="line">           array()-&gt;count = newCount;</span><br><span class="line">		// array()-&gt;listsï¼šåŸæ¥çš„æ–¹æ³•åˆ—è¡¨å‘åç§»åŠ¨ oldCount * sizeof(array()-&gt;lists[0]ä¸ªé•¿åº¦</span><br><span class="line">           memmove(array()-&gt;lists + addedCount/*æ•°ç»„æœ«å°¾*/, array()-&gt;lists/*æ•°ç»„*/,</span><br><span class="line">                   oldCount * sizeof(array()-&gt;lists[0])/*ç§»åŠ¨çš„å¤§å°*/);</span><br><span class="line">		//ç©ºå‡ºæ¥çš„ å†…å­˜ä½¿ç”¨addedListsæ‹·è´è¿‡å» å¤§å°æ˜¯:addedCount * sizeof(array()-&gt;lists[0])</span><br><span class="line">           memcpy(array()-&gt;lists, addedLists, </span><br><span class="line">                  addedCount * sizeof(array()-&gt;lists[0]));</span><br><span class="line">		/*</span><br><span class="line">		å›¾ç¤ºè®²è§£ï¼š</span><br><span class="line">		array()-&gt;lists:A-&gt;B-&gt;C-&gt;D-&gt;E</span><br><span class="line">	addedCount:3</span><br><span class="line">	addedLists:P-&gt;L-&gt;V</span><br><span class="line">		memmoveä¹‹åï¼šnil-&gt;nil-&gt;nil-&gt;A-&gt;B-&gt;C-&gt;D-&gt;E</span><br><span class="line">		ç„¶åå†è®²addedListsæ’å…¥åˆ°æ•°ç»„å‰è¾¹,æœ€ç»ˆarray()-&gt;listsçš„å€¼æ˜¯ï¼š</span><br><span class="line">		P-&gt;L-&gt;V-&gt;A-&gt;B-&gt;C-&gt;D-&gt;E</span><br><span class="line">		 */</span><br><span class="line">       &#125;</span><br><span class="line">       else if (!list  &amp;&amp;  addedCount == 1) &#123;</span><br><span class="line">           // 0 lists -&gt; 1 list</span><br><span class="line">           list = addedLists[0];</span><br><span class="line">       &#125; </span><br><span class="line">       else &#123;</span><br><span class="line">           // 1 list -&gt; many lists</span><br><span class="line">           List* oldList = list;</span><br><span class="line">           uint32_t oldCount = oldList ? 1 : 0;</span><br><span class="line">           uint32_t newCount = oldCount + addedCount;</span><br><span class="line">           setArray((array_t *)malloc(array_t::byteSize(newCount)));</span><br><span class="line">           array()-&gt;count = newCount;</span><br><span class="line">           if (oldList) array()-&gt;lists[addedCount] = oldList;</span><br><span class="line">           memcpy(array()-&gt;lists, addedLists, </span><br><span class="line">                  addedCount * sizeof(array()-&gt;lists[0]));</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p><code>class</code>åˆå§‹åŒ–å®Œæˆäº†ï¼Œç„¶åå†æ¬¡å°è¯•è·å–<code>imp = cache_getImp</code>,ç”±äºç¼“å­˜æ²¡æœ‰ä¸­é—´ä¹Ÿæ²¡æ·»åŠ è¿›å»ï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿæ˜¯ç©ºçš„ï¼Œç„¶åä»<code>getMethodNoSuper_nolock</code>è·å–è¯¥<code>cls</code>çš„æ–¹æ³•åˆ—è¡¨ä¸­æŸ¥æ‰¾ï¼Œæ²¡æœ‰çš„è¯å†ä»<code>superclass</code>æŸ¥æ‰¾<code>cache</code>å’Œ<code>method</code>,æ‰¾åˆ°çš„è¯ï¼Œè¿›è¡Œ<code>log_and_fill_cache</code>è‡³æ­¤æ¶ˆæ¯å‘é€å®Œæˆã€‚</p>
<h3 id="æ¶ˆæ¯åŠ¨æ€è§£æ"><a href="#æ¶ˆæ¯åŠ¨æ€è§£æ" class="headerlink" title="æ¶ˆæ¯åŠ¨æ€è§£æ"></a>æ¶ˆæ¯åŠ¨æ€è§£æ</h3><p>åŠ¨æ€è§£æå‡½æ•°<code>_class_resolveMethod(cls, sel, inst)</code>ï¼Œå¦‚æœä¸æ˜¯å…ƒç±»è°ƒç”¨<code>_class_resolveInstanceMethod</code>,å¦‚æœæ˜¯çš„è¯è°ƒç”¨<code>_class_resolveClassMethod</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* _class_resolveMethod</span><br><span class="line">* è°ƒç”¨ +resolveClassMethod æˆ–è€… +resolveInstanceMethod</span><br><span class="line">* å¦‚æœå­˜åœ¨äº†åˆ™ä¸æ£€æŸ¥</span><br><span class="line">**********************************************************************/</span><br><span class="line">void _class_resolveMethod(Class cls, SEL sel, id inst)</span><br><span class="line">&#123;</span><br><span class="line">    if (! cls-&gt;isMetaClass()) &#123;//ä¸æ˜¯å…ƒç±»åˆ™è°ƒç”¨ å®ä¾‹çš„</span><br><span class="line">	//é¦–å…ˆè°ƒç”¨</span><br><span class="line">		_class_resolveInstanceMethod(cls, sel, inst);</span><br><span class="line">    &#125; </span><br><span class="line">    else &#123;</span><br><span class="line">        // try [nonMetaClass resolveClassMethod:sel]</span><br><span class="line">        // and [cls resolveInstanceMethod:sel]</span><br><span class="line">		//å¯»æ‰¾classMethod</span><br><span class="line">        _class_resolveClassMethod(cls, sel, inst);</span><br><span class="line">        if (!lookUpImpOrNil(cls, sel, inst, </span><br><span class="line">                            NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) </span><br><span class="line">        &#123;</span><br><span class="line">            _class_resolveInstanceMethod(cls, sel, inst);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>resolveInstanceMethod</code>ï¼ŒæŸ¥æ‰¾<code>SEL_resolveInstanceMethod</code>ï¼Œä¼ å€¼ä¸ç”¨åˆå§‹åŒ–ï¼Œä¸ç”¨æ¶ˆæ¯è§£æï¼Œä½†æ˜¯<code>cache</code>è¦æŸ¥æ‰¾ã€‚æ²¡æœ‰æ‰¾åˆ°çš„ç›´æ¥è¿”å›ï¼Œæ‰¾åˆ°çš„è¯ä½¿ç”¨<code>objc_msgSend</code>å‘é€æ¶ˆæ¯è°ƒç”¨<code>SEL_resolveInstanceMethod</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/***********************************************************************</span><br><span class="line">* _class_resolveInstanceMethod</span><br><span class="line">* è°ƒç”¨ classæ·»åŠ çš„å‡½æ•° +resolveInstanceMethod</span><br><span class="line">* æœ‰å¯èƒ½æ˜¯å…ƒç±»</span><br><span class="line">* å¦‚æœæ–¹æ³•å­˜åœ¨åˆ™ä¸æ£€æŸ¥</span><br><span class="line">**********************************************************************/</span><br><span class="line">static void _class_resolveInstanceMethod(Class cls, SEL sel, id inst)</span><br><span class="line">&#123;</span><br><span class="line">    if (! lookUpImpOrNil(cls-&gt;ISA(), SEL_resolveInstanceMethod, cls, </span><br><span class="line">                         NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) </span><br><span class="line">    &#123;</span><br><span class="line">        // Resolver not implemented.</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">//å¦‚æœæ‰¾åˆ°SEL_resolveInstanceMethod åˆ™ä½¿ç”¨objc_msgSendå‡½æ•°</span><br><span class="line">    BOOL (*msg)(Class, SEL, SEL) = (typeof(msg))objc_msgSend;</span><br><span class="line">    bool resolved = msg(cls, SEL_resolveInstanceMethod, sel);</span><br><span class="line"></span><br><span class="line">    // Cache the result (good or bad) so the resolver doesn&apos;t fire next time.</span><br><span class="line">    // +resolveInstanceMethod adds to self a.k.a. cls</span><br><span class="line">    IMP imp = lookUpImpOrNil(cls, sel, inst, </span><br><span class="line">                             NO/*initialize*/, YES/*cache*/, NO/*resolver*/);</span><br><span class="line"></span><br><span class="line">    if (resolved  &amp;&amp;  PrintResolving) &#123;</span><br><span class="line">        if (imp) &#123;</span><br><span class="line">            _objc_inform(&quot;RESOLVE: method %c[%s %s] &quot;</span><br><span class="line">                         &quot;dynamically resolved to %p&quot;, </span><br><span class="line">                         cls-&gt;isMetaClass() ? &apos;+&apos; : &apos;-&apos;, </span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel), imp);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // Method resolver didn&apos;t add anything?</span><br><span class="line">            _objc_inform(&quot;RESOLVE: +[%s resolveInstanceMethod:%s] returned YES&quot;</span><br><span class="line">                         &quot;, but no new implementation of %c[%s %s] was found&quot;,</span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel), </span><br><span class="line">                         cls-&gt;isMetaClass() ? &apos;+&apos; : &apos;-&apos;, </span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>_class_resolveClassMethod</code>ä¸­ï¼Œç¬¬ä¸€æ­¥å…ˆå»<code>lookUpImpOrNil</code>æŸ¥æ‰¾<code>+SEL_resolveClassMethod</code>æ–¹æ³•ï¼Œæ²¡æ‰¾åˆ°çš„å°±ç»“æŸï¼Œæ‰¾åˆ°åˆ™è°ƒç”¨<code>objc_msgsend(id,sel)</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">static void _class_resolveClassMethod(Class cls, SEL sel, id inst)</span><br><span class="line">&#123;</span><br><span class="line">    assert(cls-&gt;isMetaClass());</span><br><span class="line"></span><br><span class="line">    if (! lookUpImpOrNil(cls, SEL_resolveClassMethod, inst, </span><br><span class="line">                         NO/*initialize*/, YES/*cache*/, NO/*resolver*/)) </span><br><span class="line">    &#123;</span><br><span class="line">        // Resolver not implemented.</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    BOOL (*msg)(Class, SEL, SEL) = (typeof(msg))objc_msgSend;</span><br><span class="line">    bool resolved = msg(_class_getNonMetaClass(cls, inst), </span><br><span class="line">                        SEL_resolveClassMethod, sel);</span><br><span class="line"></span><br><span class="line">    // Cache the result (good or bad) so the resolver doesn&apos;t fire next time.</span><br><span class="line">    // +resolveClassMethod adds to self-&gt;ISA() a.k.a. cls</span><br><span class="line">    IMP imp = lookUpImpOrNil(cls, sel, inst, </span><br><span class="line">                             NO/*initialize*/, YES/*cache*/, NO/*resolver*/);</span><br><span class="line"></span><br><span class="line">    if (resolved  &amp;&amp;  PrintResolving) &#123;</span><br><span class="line">        if (imp) &#123;</span><br><span class="line">            _objc_inform(&quot;RESOLVE: method %c[%s %s] &quot;</span><br><span class="line">                         &quot;dynamically resolved to %p&quot;, </span><br><span class="line">                         cls-&gt;isMetaClass() ? &apos;+&apos; : &apos;-&apos;, </span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel), imp);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            // Method resolver didn&apos;t add anything?</span><br><span class="line">            _objc_inform(&quot;RESOLVE: +[%s resolveClassMethod:%s] returned YES&quot;</span><br><span class="line">                         &quot;, but no new implementation of %c[%s %s] was found&quot;,</span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel), </span><br><span class="line">                         cls-&gt;isMetaClass() ? &apos;+&apos; : &apos;-&apos;, </span><br><span class="line">                         cls-&gt;nameForLogging(), sel_getName(sel));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åŠ¨æ€è§£æè‡³æ­¤å®Œæˆã€‚</p>
<h3 id="æ¶ˆæ¯è½¬å‘"><a href="#æ¶ˆæ¯è½¬å‘" class="headerlink" title="æ¶ˆæ¯è½¬å‘"></a>æ¶ˆæ¯è½¬å‘</h3><p><code>_objc_msgForward_impcache</code>æ˜¯è½¬å‘çš„å‡½æ•°åœ°å€ï¼Œåœ¨æœç´¢æ¡†æœç´¢å‘ç°ï¼Œè¿™ä¸ªå‡½æ•°é™¤äº†<code>.s</code>æ–‡ä»¶ä¸­æœ‰ï¼Œå…¶ä»–åœ°æ–¹å‡åªæ˜¯è°ƒç”¨ï¼Œè¯´æ˜è¿™ä¸ªå‡½æ•°æ˜¯æ±‡ç¼–å®ç°ï¼Œåœ¨<code>objc-msg-arm64.s 531 è¡Œ</code>å‘ç°ä¸€ç‚¹è¸ªè¿¹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ENTRY __objc_msgForward_impcache //å¼€å§‹__objc_msgForward_impcache</span><br><span class="line">	// No stret specialization.</span><br><span class="line">	b	__objc_msgForward//è·³è½¬-&gt;__objc_msgForward</span><br><span class="line">	END_ENTRY __objc_msgForward_impcache // ç»“æŸ__objc_msgForward_impcache</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	ENTRY __objc_msgForward // å¼€å§‹ __objc_msgForward</span><br><span class="line"></span><br><span class="line">	adrp	x17, __objc_forward_handler@PAGE</span><br><span class="line">	ldr	p17, [x17, __objc_forward_handler@PAGEOFF]//p17= x17 å’Œ __objc_forward_handler@PAGEOFFçš„å’Œ</span><br><span class="line">	TailCallFunctionPointer x17 //è·³è½¬-&gt; TailCallFunctionPointer</span><br><span class="line"></span><br><span class="line">	END_ENTRY __objc_msgForward//ç»“æŸ __objc_msgForward</span><br></pre></td></tr></table></figure>
<p>å½“è·³è½¬åˆ°<code>adrp    x17, __objc_forward_handler@PAGE</code>è¿™ä¸€è¡Œï¼Œæœæœç´¢å‡½æ•°<code>_objc_forward_handler</code>ï¼Œçœ‹åˆ°åªæ˜¯ä¸ªæ‰“å°å‡½æ•°ï¼Œå¹¶æ²¡æœ‰å…¶ä»–å‡½æ•°æ¥æ›¿ä»£è¿™ä¸ªæŒ‡é’ˆï¼Œé‚£ä¹ˆæˆ‘ä»¬ç”¨å…¶ä»–æ–¹æ³•æ¥æ¢ç©¶ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((noreturn)) void </span><br><span class="line">objc_defaultForwardHandler(id self, SEL sel)</span><br><span class="line">&#123;</span><br><span class="line">    _objc_fatal(&quot;%c[%s %s]: unrecognized selector sent to instance %p &quot;</span><br><span class="line">                &quot;(no message forward handler is installed)&quot;, </span><br><span class="line">                class_isMetaClass(object_getClass(self)) ? &apos;+&apos; : &apos;-&apos;, </span><br><span class="line">                object_getClassName(self), sel_getName(sel), self);</span><br><span class="line">&#125;</span><br><span class="line">void *_objc_forward_handler = (void*)objc_defaultForwardHandler;</span><br></pre></td></tr></table></figure>
<p>ç½‘ä¸Šæœ‰å¤§ç¥æ€»ç»“çš„ç‚¹æˆ‘ä»¬å…ˆå‚è€ƒä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">// ä¼ªä»£ç </span><br><span class="line">int __forwarding__(void *frameStackPointer, int isStret) &#123;</span><br><span class="line">    id receiver = *(id *)frameStackPointer;</span><br><span class="line">    SEL sel = *(SEL *)(frameStackPointer + 8);</span><br><span class="line">    const char *selName = sel_getName(sel);</span><br><span class="line">    Class receiverClass = object_getClass(receiver);</span><br><span class="line"></span><br><span class="line">    // è°ƒç”¨ forwardingTargetForSelector:</span><br><span class="line">    if (class_respondsToSelector(receiverClass, @selector(forwardingTargetForSelector:))) &#123;</span><br><span class="line">        id forwardingTarget = [receiver forwardingTargetForSelector:sel];</span><br><span class="line">        if (forwardingTarget &amp;&amp; forwardingTarget != receiver) &#123;</span><br><span class="line">            if (isStret == 1) &#123;</span><br><span class="line">                int ret;</span><br><span class="line">                objc_msgSend_stret(&amp;ret,forwardingTarget, sel, ...);</span><br><span class="line">                return ret;</span><br><span class="line">            &#125;</span><br><span class="line">            return objc_msgSend(forwardingTarget, sel, ...);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // åƒµå°¸å¯¹è±¡</span><br><span class="line">    const char *className = class_getName(receiverClass);</span><br><span class="line">    const char *zombiePrefix = &quot;_NSZombie_&quot;;</span><br><span class="line">    size_t prefixLen = strlen(zombiePrefix); // 0xa</span><br><span class="line">    if (strncmp(className, zombiePrefix, prefixLen) == 0) &#123;</span><br><span class="line">        CFLog(kCFLogLevelError,</span><br><span class="line">              @&quot;*** -[%s %s]: message sent to deallocated instance %p&quot;,</span><br><span class="line">              className + prefixLen,</span><br><span class="line">              selName,</span><br><span class="line">              receiver);</span><br><span class="line">        &lt;breakpoint-interrupt&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // è°ƒç”¨ methodSignatureForSelector è·å–æ–¹æ³•ç­¾ååå†è°ƒç”¨ forwardInvocation</span><br><span class="line">    if (class_respondsToSelector(receiverClass, @selector(methodSignatureForSelector:))) &#123;</span><br><span class="line">        NSMethodSignature *methodSignature = [receiver methodSignatureForSelector:sel];</span><br><span class="line">        if (methodSignature) &#123;</span><br><span class="line">            BOOL signatureIsStret = [methodSignature _frameDescriptor]-&gt;returnArgInfo.flags.isStruct;</span><br><span class="line">            if (signatureIsStret != isStret) &#123;</span><br><span class="line">                CFLog(kCFLogLevelWarning ,</span><br><span class="line">                      @&quot;*** NSForwarding: warning: method signature and compiler disagree on struct-return-edness of &apos;%s&apos;.  Signature thinks it does%s return a struct, and compiler thinks it does%s.&quot;,</span><br><span class="line">                      selName,</span><br><span class="line">                      signatureIsStret ? &quot;&quot; : not,</span><br><span class="line">                      isStret ? &quot;&quot; : not);</span><br><span class="line">            &#125;</span><br><span class="line">            if (class_respondsToSelector(receiverClass, @selector(forwardInvocation:))) &#123;</span><br><span class="line">                NSInvocation *invocation = [NSInvocation _invocationWithMethodSignature:methodSignature frame:frameStackPointer];</span><br><span class="line"></span><br><span class="line">                [receiver forwardInvocation:invocation];</span><br><span class="line"></span><br><span class="line">                void *returnValue = NULL;</span><br><span class="line">                [invocation getReturnValue:&amp;value];</span><br><span class="line">                return returnValue;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                CFLog(kCFLogLevelWarning ,</span><br><span class="line">                      @&quot;*** NSForwarding: warning: object %p of class &apos;%s&apos; does not implement forwardInvocation: -- dropping message&quot;,</span><br><span class="line">                      receiver,</span><br><span class="line">                      className);</span><br><span class="line">                return 0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    SEL *registeredSel = sel_getUid(selName);</span><br><span class="line"></span><br><span class="line">    // selector æ˜¯å¦å·²ç»åœ¨ Runtime æ³¨å†Œè¿‡</span><br><span class="line">    if (sel != registeredSel) &#123;</span><br><span class="line">        CFLog(kCFLogLevelWarning ,</span><br><span class="line">              @&quot;*** NSForwarding: warning: selector (%p) for message &apos;%s&apos; does not match selector known to Objective C runtime (%p)-- abort&quot;,</span><br><span class="line">              sel,</span><br><span class="line">              selName,</span><br><span class="line">              registeredSel);</span><br><span class="line">    &#125; // doesNotRecognizeSelector</span><br><span class="line">    else if (class_respondsToSelector(receiverClass,@selector(doesNotRecognizeSelector:))) &#123;</span><br><span class="line">        [receiver doesNotRecognizeSelector:sel];</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        CFLog(kCFLogLevelWarning ,</span><br><span class="line">              @&quot;*** NSForwarding: warning: object %p of class &apos;%s&apos; does not implement doesNotRecognizeSelector: -- abort&quot;,</span><br><span class="line">              receiver,</span><br><span class="line">              className);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // The point of no return.</span><br><span class="line">    kill(getpid(), 9);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="éªŒè¯åŠ¨æ€è§£æ"><a href="#éªŒè¯åŠ¨æ€è§£æ" class="headerlink" title="éªŒè¯åŠ¨æ€è§£æ"></a>éªŒè¯åŠ¨æ€è§£æ</h3><p>æˆ‘ä»¬ç®€å•å®šä¹‰ä¸€ä¸ª<code>test</code>å‡½æ•°ï¼Œç„¶åå¹¶æ‰§è¡Œè¿™ä¸ªå‡½æ•°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">@interface Person : NSObject</span><br><span class="line">- (void)test;</span><br><span class="line">@end</span><br><span class="line">@implementation Person</span><br><span class="line">+(BOOL)resolveInstanceMethod:(SEL)sel&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	if (sel == @selector(test)) &#123;</span><br><span class="line">		Method me = class_getInstanceMethod(self, @selector(test2));</span><br><span class="line">		class_addMethod(self, sel,</span><br><span class="line">						method_getImplementation(me),</span><br><span class="line">						method_getTypeEncoding(me));</span><br><span class="line">		return YES;</span><br><span class="line">	&#125;</span><br><span class="line">	return [super resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line">-(void)test2&#123;</span><br><span class="line">	NSLog(@&quot;æ¥äº†ï¼Œè€å¼Ÿ&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">Person *p = [[Person alloc]init];</span><br><span class="line">[p test];</span><br><span class="line">[p test];</span><br><span class="line"> //è¾“å‡º</span><br><span class="line">+[FYPerson resolveInstanceMethod:]</span><br><span class="line"> -[FYPerson test3]</span><br><span class="line"> -[FYPerson test3]</span><br></pre></td></tr></table></figure>
<p><code>[p test]</code>åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ä¼šèµ°åˆ°æ¶ˆæ¯åŠ¨æ€è§£æçš„è¿™ä¸€æ­¥,ç„¶åé€šè¿‡<code>objc_msgsend</code>è°ƒç”¨äº†<code>test</code>ï¼Œå¹¶ä¸”æŠŠ<code>test</code>æ·»åŠ åˆ°äº†ç¼“å­˜ä¸­ï¼Œæ‰€ä»¥è¾“å‡ºäº†<code>+[FYPerson resolveInstanceMethod:]</code>ï¼Œåœ¨ç¬¬äºŒæ¬¡è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šä»ç¼“å­˜ä¸­æŸ¥åˆ°<code>imp</code>ï¼Œæ‰€ä»¥ç›´æ¥è¾“å‡ºäº†<code>-[FYPerson test3]</code>ã€‚</p>
<p>åœ¨<code>+resolveInstanceMethod</code>å¯ä»¥æ‹¦æˆªæ‰å®ä¾‹æ–¹æ³•çš„åŠ¨æ€è§£æï¼Œåœ¨<code>+resolveClassMethod</code>å¯ä»¥æ‹¦æˆªç±»æ–¹æ³•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">@interface Person : NSObject</span><br><span class="line">+ (void)test;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">+ (void)test3&#123;</span><br><span class="line">	NSLog(@&quot;æ¥äº†ï¼Œè€å¼Ÿ&quot;);</span><br><span class="line">&#125;</span><br><span class="line">+ (BOOL)resolveClassMethod:(SEL)sel&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">	if (sel == @selector(test)) &#123;</span><br><span class="line">		Method me = class_getClassMethod(self, @selector(test3));//è·å–method</span><br><span class="line">		//ç»™sel æ·»åŠ æ–¹æ³•å®ç° @selecter(test3)</span><br><span class="line">		class_addMethod(object_getClass(self), sel,</span><br><span class="line">						method_getImplementation(me),</span><br><span class="line">						method_getTypeEncoding(me));</span><br><span class="line">		return YES;</span><br><span class="line">	&#125;</span><br><span class="line">	return [super resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[Person test];</span><br><span class="line"></span><br><span class="line">//è¾“å‡º</span><br><span class="line">+[Person resolveClassMethod:]</span><br><span class="line">æ¥äº†ï¼Œè€å¼Ÿ</span><br></pre></td></tr></table></figure>
<p>æ‹¦æˆª<code>+resolveClassMethod</code>,åœ¨æ¡ä»¶ä¸º<code>sel==@selector(test)</code>çš„æ—¶å€™ï¼Œå°†å‡½æ•°å®ç°<code>+test3()</code>çš„<code>IMP</code>ä½¿ç”¨<code>class_addMethod</code>æ·»åŠ åˆ°<code>Person</code>ä¸Šï¼Œå¾…ä¸‹æ¬¡è°ƒç”¨<code>test</code>çš„æ—¶å€™ç›´æ¥é€šè¿‡<code>imp = cache_getImp(cls, sel);</code>è·å–åˆ°<code>imp</code>å‡½æ•°æŒ‡é’ˆå¹¶ä¸”æ‰§è¡Œã€‚<br>æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡æ·»åŠ cå‡½æ•°çš„impæ¥å®ç°ç»™classæ·»åŠ å‡½æ•°å®ç°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">+(BOOL)resolveInstanceMethod:(SEL)sel&#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">    if (sel == @selector(test)) &#123;</span><br><span class="line">//        Method me = class_getInstanceMethod(self, @selector(test3));</span><br><span class="line">//        class_addMethod(self.class, sel, method_getImplementation(me), method_getTypeEncoding(me));</span><br><span class="line">        class_addMethod(self.class, sel, (IMP)test3, &quot;v16@0:8&quot;);</span><br><span class="line">        return YES;</span><br><span class="line">    &#125;</span><br><span class="line">    return [super resolveInstanceMethod:sel];</span><br><span class="line">&#125;</span><br><span class="line">void test3(id self,SEL sel)&#123;</span><br><span class="line">    NSLog(@&quot;test3:%s&quot;,NSStringFromSelector(sel).UTF8String);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//è¾“å‡º</span><br><span class="line">+[FYPerson resolveInstanceMethod:]</span><br><span class="line">test3:test</span><br><span class="line">test3:test</span><br></pre></td></tr></table></figure>
<p><code>v16@0:8</code>æ˜¯è¿”å›å€¼ä¸º<code>void</code>å‚æ•°å ç”¨16å­—èŠ‚å¤§å°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ä»0å¼€å§‹ï¼Œç¬¬äºŒä¸ªä»8å­—èŠ‚å¼€å§‹ã€‚<br>è¿™æ®µä»£ç å’Œä¸Šé¢çš„å…¶å®æœ¬è´¨ä¸Šæ˜¯ä¸€æ ·çš„ï¼Œä¸€ä¸ªæ˜¯ç»™<code>class</code>æ·»åŠ å‡½æ•°å®ç°ï¼Œä½¿<code>sel</code>å’Œ<code>imp</code>å¯¹åº”èµ·æ¥ï¼Œè¿™ä¸ªæ˜¯å°†<code>c</code>å‡½æ•°çš„<code>imp</code>å’Œ<code>sel</code>è¿›è¡Œå…³è”ï¼Œæ·»åŠ ç¼“å­˜ä¹‹åï¼Œä½¿ç”¨<code>objc_msgsend()</code>æ•ˆæœæ˜¯ä¸€æ ·çš„ã€‚</p>
<h3 id="éªŒè¯æ¶ˆæ¯è½¬å‘"><a href="#éªŒè¯æ¶ˆæ¯è½¬å‘" class="headerlink" title="éªŒè¯æ¶ˆæ¯è½¬å‘"></a>éªŒè¯æ¶ˆæ¯è½¬å‘</h3><p>æ¶ˆæ¯è½¬å‘å¯åˆ†ä¸º3æ­¥ï¼Œç¬¬ä¸€æ­¥æ ¹æ®<code>- (id)forwardingTargetForSelector:(SEL)aSelector</code>è¿”å›çš„ç±»å¯¹è±¡æˆ–è€…å…ƒç±»å¯¹è±¡ï¼Œå°†æ–¹æ³•è½¬å‘ç»™è¯¥å¯¹è±¡ã€‚å‡å¦‚ç¬¬ä¸€æ­¥æ²¡å®ç°ï¼Œåˆ™ç¬¬äºŒæ­¥æ ¹æ®è¿”å›çš„<code>-(NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>æˆ–<code>+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>å‡½æ•°ç­¾åï¼Œåœ¨ç¬¬ä¸‰æ­¥<code>(void)forwardInvocation:(NSInvocation *)anInvocation</code>è°ƒç”¨å‡½æ•°<code>[anInvocation invoke]</code>è¿›è¡Œæ ¡éªŒæˆåŠŸä¹‹åè¿›è¡Œè°ƒç”¨å‡½æ•°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">@interface Person : NSObject</span><br><span class="line">- (void)test;</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">#import &quot;Person.h&quot;</span><br><span class="line">#import &quot;Student.h&quot;</span><br><span class="line"></span><br><span class="line">@implementation Person</span><br><span class="line">- (id)forwardingTargetForSelector:(SEL)aSelector&#123;</span><br><span class="line">	if (aSelector == @selector(test)) &#123;</span><br><span class="line">		//objc_msgSend([[Struent alloc]init],test)</span><br><span class="line">		return [[Struent alloc]init];</span><br><span class="line">	&#125;</span><br><span class="line">	return [super forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">//è¾“å‡º</span><br><span class="line">-[Student test]</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ª<code>Person</code>åªå£°æ˜äº†<code>test</code>æ²¡æœ‰å®ç°ï¼Œç„¶ååœ¨æ¶ˆæ¯è½¬å‘ç¬¬ä¸€æ­¥<code>forwardingTargetForSelector</code>å°†è¦å¤„ç†çš„å¯¹è±¡è¿”å›ï¼ŒæˆåŠŸè°ƒç”¨äº†<code>Student</code>çš„<code>test</code>æ–¹æ³•ã€‚</p>
<p>ç¬¬ä¸€æ­¥æ²¡æ‹¦æˆªï¼Œå¯ä»¥åœ¨ç¬¬äºŒæ­¥æ‹¦æˆªã€‚<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">//æ¶ˆæ¯è½¬å‘ç¬¬äºŒæ­¥ æ²¡æœ‰å¯¹è±¡æ¥å¤„ç†æ–¹æ³•ï¼Œé‚£å°†å‡½æ•°ç­¾åæ¥å®ç°</span><br><span class="line">- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">	if (aSelector == @selector(test)) &#123;</span><br><span class="line">		NSMethodSignature *sign = [NSMethodSignature signatureWithObjCTypes:&quot;v16@0:8&quot;];</span><br><span class="line">		return sign;</span><br><span class="line">	&#125;</span><br><span class="line">	return [super methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line">// å‡½æ•°ç­¾åå·²è¿”å›ï¼Œåˆ°äº†å‡½æ•°è°ƒç”¨çš„åœ°æ–¹</span><br><span class="line">//selector å‡½æ•°çš„sel</span><br><span class="line">//target   å‡½æ•°è°ƒç”¨è€…</span><br><span class="line">//methodSignature å‡½æ•°ç­¾å</span><br><span class="line">//NSInvocation  å°è£…æ•°æ®çš„å¯¹è±¡</span><br><span class="line">- (void)forwardInvocation:(NSInvocation *)anInvocation&#123;</span><br><span class="line">    NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">//è¾“å‡º</span><br><span class="line">-[Person forwardInvocation:]</span><br></pre></td></tr></table></figure></p>
<p>æ‰“å°å‡ºäº†<code>-[Person forwardInvocation:]</code>è€Œä¸”æ²¡æœ‰å´©æºƒï¼Œåœ¨<code>forwardInvocation:(NSInvocation *)anInvocation</code>æ€ä¹ˆæ“ä½œçœ‹å¼€å‘è€…æ€ä¹ˆå¤„ç†äº†ï¼Œæ¢ç©¶ä¸‹éƒ½å¯ä»¥åšä»€ä¹ˆäº‹æƒ…ã€‚<br>çœ‹åˆ°<code>NSInvocation</code>çš„å±æ€§å’Œå‡½æ•°,<code>sel</code>å’Œ<code>target</code>æ˜¯è¯»å†™ï¼Œå‡½æ•°ç­¾åæ˜¯å¿…é¡»çš„ï¼Œæ‰€ä»¥<code>(NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>å¿…é¡»å°†å‡½æ•°ç­¾åè¿”å›ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">@property (readonly, retain) NSMethodSignature *methodSignature;//åªè¯»</span><br><span class="line">- (void)retainArguments;</span><br><span class="line">@property (readonly) BOOL argumentsRetained;</span><br><span class="line">@property (nullable, assign) id target;//è¯»å†™</span><br><span class="line">@property SEL selector;//è¯»å†™</span><br></pre></td></tr></table></figure>
<p>å½“æ‹¦æˆªæ–¹æ³•æ˜¯ç±»æ–¹æ³•çš„æ—¶å€™ï¼Œå¯ä»¥ç”¨<code>+ (id)forwardingTargetForSelector:(SEL)aSelecto</code>æ‹¦æˆªï¼Œ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">//class è½¬å‘</span><br><span class="line">// æ¶ˆæ¯è½¬å‘ç¬¬ä¸€æ­¥ æ‹¦æˆªæ˜¯å¦æœ‰è½¬å‘çš„classå¯¹è±¡å¤„ç†æ–¹æ³•</span><br><span class="line">+ (id)forwardingTargetForSelector:(SEL)aSelector&#123;</span><br><span class="line">	if (aSelector == @selector(test3)) &#123;</span><br><span class="line">		//objc_msgSend([[Struent alloc]init],test)</span><br><span class="line">		return [Student class];</span><br><span class="line">	&#125;</span><br><span class="line">	return [super forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (void)test3&#123;</span><br><span class="line">//	NSLog(@&quot;+[Student test3]&quot;);</span><br><span class="line">//å½“[Person test3]ä¸Šä¸€è¡Œå†™è¿™ä¹ˆä¸€è¡Œï¼ŒPerson *p = [[Person alloc]init] è¿™å¥æŠ¥é”™</span><br><span class="line">//æš‚æ—¶ä¸æ‡‚ä¸ºä»€ä¹ˆä¸èƒ½è°ƒç”¨NSLogï¼Œä½†æ˜¯å·²ç»è¿›æ¥äº†æ‰€ä»¥è°ƒç”¨äº†test2ã€‚</span><br><span class="line">//æ³¨é‡Šæ‰ [[Person alloc]init]ï¼Œä¸€åˆ‡æ­£å¸¸ã€‚ æœ‰å¤§ä½¬äº†è§£å—</span><br><span class="line">&#125;</span><br><span class="line">- (void)test2&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// è¾“å‡º</span><br><span class="line">-[Student test2]</span><br></pre></td></tr></table></figure>
<p>ä¹Ÿå¯ä»¥ç”¨è¿”å›<code>return [[Student alloc]init];</code>å°†<code>class</code>ç±»æ–¹æ³•è½¬åŒ–æˆå®ä¾‹æ–¹æ³•,æœ€åè°ƒç”¨äº†<code>Student</code>çš„å¯¹è±¡æ–¹æ³•<code>test3</code>ã€‚å…¶å®æœ¬è´¨ä¸Šéƒ½æ˜¯<code>objc_msgSend(id,SEL,...)</code>ï¼Œæˆ‘ä»¬ä¿®æ”¹çš„åªæ˜¯<code>id</code>çš„å€¼ï¼Œ<code>id</code>ç±»å‹åœ¨è¿™æ®µä»£ç ä¸­æœ¬è´¨æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥<code>return instance</code>ä¹Ÿå¯ä»¥<code>reurn class</code>ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">+ (id)forwardingTargetForSelector:(SEL)aSelector&#123;</span><br><span class="line">	if (aSelector == @selector(test3)) &#123;</span><br><span class="line">		//objc_msgSend([[Struent alloc]init],test)</span><br><span class="line">		return [[Student alloc]init];</span><br><span class="line">	&#125;</span><br><span class="line">	return [super forwardingTargetForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)test3&#123;</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line">//è¾“å‡º</span><br><span class="line">-[Student test3]</span><br></pre></td></tr></table></figure>
<p>å°†åˆšæ‰å†™çš„<code>methodSignatureForSelector</code>å’Œ<code>forwardInvocation</code>æ”¹æˆç±»æ–¹æ³•ï¼Œä¹Ÿæ˜¯åŒæ ·å¯ä»¥æ‹¦æˆªç±»æ–¹æ³•çš„ã€‚æˆ‘ä»¬çœ‹ä¸‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//æ¶ˆæ¯è½¬å‘ç¬¬äºŒæ­¥ æ²¡æœ‰classæ¥å¤„ç†æ–¹æ³•ï¼Œé‚£å°†å‡½æ•°ç­¾åæ¥å®ç°</span><br><span class="line">+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</span><br><span class="line">&#123;</span><br><span class="line">	if (aSelector == @selector(test3)) &#123;</span><br><span class="line">		NSMethodSignature *sign = [NSMethodSignature signatureWithObjCTypes:&quot;v16@0:8&quot;];</span><br><span class="line">		return sign;</span><br><span class="line">	&#125;</span><br><span class="line">	return [super methodSignatureForSelector:aSelector];</span><br><span class="line">&#125;</span><br><span class="line">// å‡½æ•°ç­¾åå·²è¿”å›ï¼Œåˆ°äº†å‡½æ•°è°ƒç”¨çš„åœ°æ–¹</span><br><span class="line">//selector å‡½æ•°çš„sel</span><br><span class="line">//target   å‡½æ•°è°ƒç”¨è€…</span><br><span class="line">//methodSignature å‡½æ•°ç­¾å</span><br><span class="line">//NSInvocation  å°è£…æ•°æ®çš„å¯¹è±¡</span><br><span class="line">+ (void)forwardInvocation:(NSInvocation *)anInvocation&#123;</span><br><span class="line">//	anInvocation.selector = @selector(test2);</span><br><span class="line">//æ­¤å¤„æ¢æˆ[Student class]åŒæ ·å¯ä»¥</span><br><span class="line">//	anInvocation.target = (id)[[Student alloc]init];</span><br><span class="line"></span><br><span class="line">//	[anInvocation invoke];</span><br><span class="line">	NSLog(@&quot;%s&quot;,__func__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//è¾“å‡º</span><br><span class="line">+[Person forwardInvocation:]</span><br></pre></td></tr></table></figure>
<p>æµ‹è¿‡å…¶å®å¯¹è±¡æ–¹æ³•å’Œç±»æ–¹æ³•éƒ½æ˜¯ç”¨åŒæ ·çš„æµç¨‹æ‹¦æˆªçš„ï¼Œå¯¹è±¡æ–¹æ³•æ˜¯ç”¨<code>-</code>æ–¹æ³•,ç±»æ–¹æ³•æ˜¯ç”¨<code>+</code>æ–¹æ³•ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li>objc_msgSendå‘é€æ¶ˆæ¯ï¼Œä¼šé¦–å…ˆåœ¨cacheä¸­æŸ¥æ‰¾ï¼ŒæŸ¥æ‰¾ä¸åˆ°åˆ™å»æ–¹æ³•åˆ—è¡¨(é¡ºåºæ˜¯<code>cache-&gt;class_rw_t-&gt;supclass cache -&gt;superclass class_rw_t -&gt;åŠ¨æ€è§£æ</code>)</li>
<li>ç¬¬äºŒæ­¥æ˜¯åŠ¨æ€è§£æï¼Œèƒ½åœ¨resolveInstanceMethodæˆ–+ (BOOL)resolveClassMethod:(SEL)selæ¥æ¥æ‹¦æˆªï¼Œå¯ä»¥ç»™classæ–°å¢å®ç°å‡½æ•°ï¼Œè¾¾åˆ°ä¸å´©æºƒç›®çš„</li>
<li>ç¬¬ä¸‰æ­¥æ˜¯æ¶ˆæ¯è½¬å‘ï¼Œè½¬å‘ç¬¬ä¸€æ­¥å¯ä»¥åœ¨<code>+ (id)forwardingTargetForSelector:(SEL)aSelector</code>æˆ–<code>- (id)forwardingTargetForSelector:(SEL)aSelector</code>æ‹¦æˆªç±»æˆ–å®ä¾‹æ–¹æ³•ï¼Œèƒ½å°†å¯¹è±¡æ–¹æ³•è½¬å‘ç»™å…¶ä»–å¯¹è±¡ï¼Œä¹Ÿèƒ½å°†å¯¹è±¡æ–¹æ³•è½¬å‘ç»™ç±»æ–¹æ³•ï¼Œä¹Ÿå¯ä»¥å°†ç±»æ–¹æ³•è½¬å‘ç»™å®ä¾‹æ–¹æ³•</li>
<li>ç¬¬ä¸‰æ­¥æ¶ˆæ¯è½¬å‘çš„ç¬¬äºŒæ­¥å¯ä»¥åœ¨<code>+ (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>æˆ–<code>- (NSMethodSignature *)methodSignatureForSelector:(SEL)aSelector</code>å®ç°æ‹¦æˆªç±»å’Œå®ä¾‹æ–¹æ³•å¹¶è¿”å›å‡½æ•°ç­¾å</li>
<li>ç¬¬ä¸‰æ­¥æ¶ˆæ¯è½¬å‘çš„ç¬¬ä¸‰æ­¥å¯ä»¥<code>+ (void)forwardInvocation:(NSInvocation *)anInvocation</code>æˆ–<code>- (void)forwardInvocation:(NSInvocation *)anInvocation</code>å®ç°ç±»æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•çš„è°ƒç”¨å’Œè·å–è¿”å›å€¼</li>
</ul>
<h4 id="èµ„æ–™ä¸‹è½½"><a href="#èµ„æ–™ä¸‹è½½" class="headerlink" title="èµ„æ–™ä¸‹è½½"></a>èµ„æ–™ä¸‹è½½</h4><ul>
<li><a href="https://github.com/ifgyong/iOSDataFactory" target="_blank" rel="noopener">å­¦ä¹ èµ„æ–™ä¸‹è½½</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC" target="_blank" rel="noopener">demo code</a></li>
<li><a href="https://github.com/ifgyong/demo/tree/master/OC/objc4-750" target="_blank" rel="noopener">runtimeå¯è¿è¡Œçš„æºç </a></li>
</ul>
<p>æœ¬æ–‡ç« ä¹‹æ‰€ä»¥å›¾ç‰‡æ¯”è¾ƒå°‘ï¼Œæˆ‘è§‰å¾—è¿˜æ˜¯è·Ÿç€ä»£ç æ•²ä¸€éï¼Œå°è±¡æ¯”è¾ƒæ·±åˆ»ã€‚</p>
<hr>
<p>æœ€æ€•ä¸€ç”Ÿç¢Œç¢Œæ— ä¸ºï¼Œè¿˜å®‰æ…°è‡ªå·±å¹³å‡¡å¯è´µã€‚</p>
<p>å¹¿å‘Šæ—¶é—´</p>
<p><img src="/images/0.png" alt></p>

          
        
      
    </div>

    

    
    
    

    

    
       
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">fgyong</p>
              <p class="site-description motion-element" itemprop="description">åœ¨å­¦ä¹ çš„è·¯ä¸Šï¼Œä¸å¿˜åˆå¿ƒ æ–¹å¾—å§‹ç»ˆ</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">44</span>
                    <span class="site-state-item-name">æ—¥å¿—</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">åˆ†ç±»</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">æ ‡ç­¾</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">fgyong</span>

  

  
</div>


  <div class="powered-by">ç”± <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨ v3.9.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">ä¸»é¢˜ â€“ <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v6.6.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  










  





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>
